/*
* This file contains both original and merged/adapted code.
* Except where indicated, all code is
* Copyright (c) 2006-2017, Experian Cheetahmail All Rights Reserved.
* Not to be reused without permission.
*/
(function(){Ext.override(Ext.list.Column,{init:function(){var b=Ext.data.Types,a=this.sortType;if(this.type){if(Ext.isString(this.type)){this.type=Ext.data.Types[this.type.toUpperCase()]||b.AUTO;}}else{this.type=b.AUTO;}if(Ext.isString(a)){this.sortType=Ext.data.SortTypes[a];}else{if(Ext.isEmpty(a)){this.sortType=this.type.sortType;}}}});Ext.tree.Column=Ext.extend(Ext.list.Column,{});Ext.tree.NumberColumn=Ext.extend(Ext.list.NumberColumn,{});Ext.tree.DateColumn=Ext.extend(Ext.list.DateColumn,{});Ext.tree.BooleanColumn=Ext.extend(Ext.list.BooleanColumn,{});Ext.reg("tgcolumn",Ext.tree.Column);Ext.reg("tgnumbercolumn",Ext.tree.NumberColumn);Ext.reg("tgdatecolumn",Ext.tree.DateColumn);Ext.reg("tgbooleancolumn",Ext.tree.BooleanColumn);})();Ext.ns("Ext.ux.tree");Ext.ux.tree.TreeGridSorter=Ext.extend(Ext.tree.TreeSorter,{sortClasses:["sort-asc","sort-desc"],sortAscText:"Sort Ascending",sortDescText:"Sort Descending",constructor:function(a,b){if(!Ext.isObject(b)){b={property:a.columns[0].dataIndex||"text",folderSort:true};}Ext.ux.tree.TreeGridSorter.superclass.constructor.apply(this,arguments);this.tree=a;a.on("headerclick",this.onHeaderClick,this);a.ddAppendOnly=true;var c=this;this.defaultSortFn=function(m,l){var k=c.dir&&c.dir.toLowerCase()=="desc",d=c.property||"text",g=c.sortType,o=c.caseSensitive===true,f=c.leafAttr||"leaf",p=m.attributes,n=l.attributes;if(c.folderSort){if(p[f]&&!n[f]){return 1;}if(!p[f]&&n[f]){return -1;}}var j=p[d],h=n[d],q=g?g(j):(o?j:j.toUpperCase());v2=g?g(h):(o?h:h.toUpperCase());if(q<v2){return k?+1:-1;}else{if(q>v2){return k?-1:+1;}else{return 0;}}};a.on("afterrender",this.onAfterTreeRender,this,{single:true});a.on("headermenuclick",this.onHeaderMenuClick,this);},onAfterTreeRender:function(){if(this.tree.hmenu){this.tree.hmenu.insert(0,{itemId:"asc",text:this.sortAscText,cls:"xg-hmenu-sort-asc"},{itemId:"desc",text:this.sortDescText,cls:"xg-hmenu-sort-desc"});}this.updateSortIcon(0,"asc");},onHeaderMenuClick:function(d,b,a){if(b==="asc"||b==="desc"){this.onHeaderClick(d,null,a);return false;}},onHeaderClick:function(f,b,a){if(f&&!this.tree.headersDisabled){var d=this;d.property=f.dataIndex;d.dir=f.dir=(f.dir==="desc"?"asc":"desc");d.sortType=f.sortType;d.caseSensitive===Ext.isBoolean(f.caseSensitive)?f.caseSensitive:this.caseSensitive;d.sortFn=f.sortFn||this.defaultSortFn;this.tree.root.cascade(function(c){if(!c.isLeaf()){d.updateSort(d.tree,c);}});this.updateSortIcon(a,f.dir);}},updateSortIcon:function(b,a){var d=this.sortClasses,c=this.tree.innerHd.select("td").removeClass(d);c.item(b).addClass(d[a=="desc"?1:0]);}});Ext.ux.tree.TreeGridLoader=Ext.extend(Ext.tree.TreeLoader,{createNode:function(a){if(!a.uiProvider){a.uiProvider=Ext.ux.tree.TreeGridNodeUI;}return Ext.tree.TreeLoader.prototype.createNode.call(this,a);}});Ext.ux.tree.TreeGrid=Ext.extend(Ext.tree.TreePanel,{rootVisible:false,useArrows:true,lines:false,borderWidth:Ext.isBorderBox?0:2,cls:"x-treegrid",columnResize:true,enableSort:true,reserveScrollOffset:true,enableHdMenu:true,columnsText:"Columns",initComponent:function(){if(!this.root){this.root=new Ext.tree.AsyncTreeNode({text:"Root"});}var a=this.loader;if(!a){a=new Ext.ux.tree.TreeGridLoader({dataUrl:this.dataUrl,requestMethod:this.requestMethod,store:this.store});}else{if(Ext.isObject(a)&&!a.load){a=new Ext.ux.tree.TreeGridLoader(a);}}this.loader=a;Ext.ux.tree.TreeGrid.superclass.initComponent.call(this);this.initColumns();if(this.enableSort){this.treeGridSorter=new Ext.ux.tree.TreeGridSorter(this,this.enableSort);}if(this.columnResize){this.colResizer=new Ext.tree.ColumnResizer(this.columnResize);this.colResizer.init(this);}var b=this.columns;if(!this.internalTpl){this.internalTpl=new Ext.XTemplate('<div class="x-grid3-header">','<div class="x-treegrid-header-inner">','<div class="x-grid3-header-offset">','<table style="table-layout: fixed;" cellspacing="0" cellpadding="0" border="0"><colgroup><tpl for="columns"><col /></tpl></colgroup>','<thead><tr class="x-grid3-hd-row">','<tpl for="columns">','<td class="x-grid3-hd x-grid3-cell x-treegrid-hd" style="text-align: {align};" id="',this.id,'-xlhd-{#}">','<div class="x-grid3-hd-inner x-treegrid-hd-inner" unselectable="on">',this.enableHdMenu?'<a class="x-grid3-hd-btn" href="#"></a>':"",'{header}<img class="x-grid3-sort-icon" src="',Ext.BLANK_IMAGE_URL,'" />',"</div>","</td></tpl>","</tr></thead>","</table>","</div></div>","</div>",'<div class="x-treegrid-root-node">','<table class="x-treegrid-root-table" cellpadding="0" cellspacing="0" style="table-layout: fixed;"></table>',"</div>");}if(!this.colgroupTpl){this.colgroupTpl=new Ext.XTemplate('<colgroup><tpl for="columns"><col style="width: {width}px"/></tpl></colgroup>');}},initColumns:function(){var f=this.columns,a=f.length,d=[],b,g;for(b=0;b<a;b++){g=f[b];if(!g.isColumn){g.xtype=g.xtype?(/^tg/.test(g.xtype)?g.xtype:"tg"+g.xtype):"tgcolumn";g=Ext.create(g);}g.init(this);d.push(g);if(this.enableSort!==false&&g.sortable!==false){g.sortable=true;this.enableSort=true;}}this.columns=d;},onRender:function(){Ext.tree.TreePanel.superclass.onRender.apply(this,arguments);this.el.addClass("x-treegrid");this.outerCt=this.body.createChild({cls:"x-tree-root-ct x-treegrid-ct "+(this.useArrows?"x-tree-arrows":this.lines?"x-tree-lines":"x-tree-no-lines")});this.internalTpl.overwrite(this.outerCt,{columns:this.columns});this.mainHd=Ext.get(this.outerCt.dom.firstChild);this.innerHd=Ext.get(this.mainHd.dom.firstChild);this.innerBody=Ext.get(this.outerCt.dom.lastChild);this.innerCt=Ext.get(this.innerBody.dom.firstChild);this.colgroupTpl.insertFirst(this.innerCt,{columns:this.columns});if(this.hideHeaders){this.el.child(".x-grid3-header").setDisplayed("none");}else{if(this.enableHdMenu!==false){this.hmenu=new Ext.menu.Menu({id:this.id+"-hctx"});if(this.enableColumnHide!==false){this.colMenu=new Ext.menu.Menu({id:this.id+"-hcols-menu"});this.colMenu.on({scope:this,beforeshow:this.beforeColMenuShow,itemclick:this.handleHdMenuClick});this.hmenu.add({itemId:"columns",hideOnClick:false,text:this.columnsText,menu:this.colMenu,iconCls:"x-cols-icon"});}this.hmenu.on("itemclick",this.handleHdMenuClick,this);}}},setRootNode:function(a){a.attributes.uiProvider=Ext.ux.tree.TreeGridRootNodeUI;a=Ext.ux.tree.TreeGrid.superclass.setRootNode.call(this,a);if(this.innerCt){this.colgroupTpl.insertFirst(this.innerCt,{columns:this.columns});}return a;},clearInnerCt:function(){if(Ext.isIE){var a=this.innerCt.dom;while(a.firstChild){a.removeChild(a.firstChild);}}else{Ext.ux.tree.TreeGrid.superclass.clearInnerCt.call(this);}},initEvents:function(){Ext.ux.tree.TreeGrid.superclass.initEvents.apply(this,arguments);this.mon(this.innerBody,"scroll",this.syncScroll,this);this.mon(this.innerHd,"click",this.handleHdDown,this);this.mon(this.mainHd,{scope:this,mouseover:this.handleHdOver,mouseout:this.handleHdOut});},onResize:function(b,c){Ext.ux.tree.TreeGrid.superclass.onResize.apply(this,arguments);var f=this.innerBody.dom;var g=this.innerHd.dom;if(!f){return;}if(Ext.isNumber(c)){f.style.height=this.body.getHeight(true)-g.offsetHeight+"px";}if(Ext.isNumber(b)){var a=Ext.num(this.scrollOffset,Ext.getScrollBarWidth());if(this.reserveScrollOffset||((f.offsetWidth-f.clientWidth)>10)){this.setScrollOffset(a);}else{var d=this;setTimeout(function(){d.setScrollOffset(f.offsetWidth-f.clientWidth>10?a:0);},10);}}},updateColumnWidths:function(){var l=this.columns,n=l.length,a=this.outerCt.query("colgroup"),m=a.length,k,f,d,b;for(d=0;d<n;d++){k=l[d];for(b=0;b<m;b++){f=a[b];f.childNodes[d].style.width=(k.hidden?0:k.width)+"px";}}for(d=0,a=this.innerHd.query("td"),len=a.length;d<len;d++){k=Ext.fly(a[d]);if(l[d]&&l[d].hidden){k.addClass("x-treegrid-hd-hidden");}else{k.removeClass("x-treegrid-hd-hidden");}}var h=this.getTotalColumnWidth();Ext.fly(this.innerHd.dom.firstChild).setWidth(h+(this.scrollOffset||0));
this.outerCt.select("table").setWidth(h);this.syncHeaderScroll();},getVisibleColumns:function(){var c=[],d=this.columns,a=d.length,b;for(b=0;b<a;b++){if(!d[b].hidden){c.push(d[b]);}}return c;},getTotalColumnWidth:function(){var d=0;for(var b=0,c=this.getVisibleColumns(),a=c.length;b<a;b++){d+=c[b].width;}return d;},setScrollOffset:function(a){this.scrollOffset=a;this.updateColumnWidths();},handleHdDown:function(j,f){var h=j.getTarget(".x-treegrid-hd");if(h&&Ext.fly(f).hasClass("x-grid3-hd-btn")){var b=this.hmenu.items,g=this.columns,a=this.findHeaderIndex(h),k=g[a],d=k.sortable;j.stopEvent();Ext.fly(h).addClass("x-grid3-hd-menu-open");this.hdCtxIndex=a;this.fireEvent("headerbuttonclick",b,k,h,a);this.hmenu.on("hide",function(){Ext.fly(h).removeClass("x-grid3-hd-menu-open");},this,{single:true});this.hmenu.show(f,"tl-bl?");}else{if(h){var a=this.findHeaderIndex(h);this.fireEvent("headerclick",this.columns[a],h,a);}}},handleHdOver:function(d,a){var c=d.getTarget(".x-treegrid-hd");if(c&&!this.headersDisabled){index=this.findHeaderIndex(c);this.activeHdRef=a;this.activeHdIndex=index;var b=Ext.get(c);this.activeHdRegion=b.getRegion();b.addClass("x-grid3-hd-over");this.activeHdBtn=b.child(".x-grid3-hd-btn");if(this.activeHdBtn){this.activeHdBtn.dom.style.height=(c.firstChild.offsetHeight-1)+"px";}}},handleHdOut:function(c,a){var b=c.getTarget(".x-treegrid-hd");if(b&&(!Ext.isIE||!c.within(b,true))){this.activeHdRef=null;Ext.fly(b).removeClass("x-grid3-hd-over");b.style.cursor="";}},findHeaderIndex:function(d){d=d.dom||d;var b=d.parentNode.childNodes;for(var a=0,f;f=b[a];a++){if(f==d){return a;}}return -1;},beforeColMenuShow:function(){var d=this.columns,b=d.length,a,f;this.colMenu.removeAll();for(a=1;a<b;a++){f=d[a];if(f.hideable!==false){this.colMenu.add(new Ext.menu.CheckItem({itemId:"col-"+a,text:f.header,checked:!f.hidden,hideOnClick:false,disabled:f.hideable===false}));}}},handleHdMenuClick:function(b){var a=this.hdCtxIndex,c=b.getItemId();if(this.fireEvent("headermenuclick",this.columns[a],c,a)!==false){a=c.substr(4);if(a>0&&this.columns[a]){this.setColumnVisible(a,!b.checked);}}return true;},setColumnVisible:function(a,b){this.columns[a].hidden=!b;this.updateColumnWidths();},scrollToTop:function(){this.innerBody.dom.scrollTop=0;this.innerBody.dom.scrollLeft=0;},syncScroll:function(){this.syncHeaderScroll();var a=this.innerBody.dom;this.fireEvent("bodyscroll",a.scrollLeft,a.scrollTop);},syncHeaderScroll:function(){var a=this.innerBody.dom;this.innerHd.dom.scrollLeft=a.scrollLeft;this.innerHd.dom.scrollLeft=a.scrollLeft;},registerNode:function(a){Ext.ux.tree.TreeGrid.superclass.registerNode.call(this,a);if(!a.uiProvider&&!a.isRoot&&!a.ui.isTreeGridNodeUI){a.ui=new Ext.ux.tree.TreeGridNodeUI(a);}}});Ext.reg("treegrid",Ext.ux.tree.TreeGrid);
/*
* All the code that follows is
* Copyright (c) 2006-2017, Experian CheetahMail All Rights Reserved.
* Not to be reused without permission.
*/
if(window.Ext){Ext.BLANK_IMAGE_URL="/images/blank.gif";Ext.SSL_SECURE_URL="about:blank";}window.ECM=window.ECM||{};if(ECM.Stash&&ECM.Stash.desired_aid){Ext.Ajax.extraParams={desired_aid:ECM.Stash.desired_aid};}(function(){ECM.global=this;var __constants__={COMPLETE:"complete",DOMCONTENTLOADED:"DOMContentLoaded",IEDEFERED:"ie-deferred-loader",LOADED:2,LOCKED:1,READY:4,XMLHTTP:["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"]};var __flags__={base:{css:"/css/",js:"/js/"},head:null,inflight:0,modules:{},notify:[],ready:{evt:null,id:null},state:0,styles:[],urls:[]};ECM.modifyFlags=function(obj){Ext.apply(__flags__,obj);};var observer=new Ext.util.Observable();var __libraries__={"Ext.version":"3.4.1.1"};ECM.provide=function(module){module=String(module);return(__flags__.modules[module]=ECM.Adapter.namespace(module));};ECM.require=function(resource,type,options){resource=String(resource);options=options||{};var resourceObject=null;if(type==="css"){if(options.mediaTypes){options.mediaTypes=options.mediaTypes.replace(/\s+/g,"").replace(/^,|,$/g,"");}options.mediaTypes=options.mediaTypes||"all";if(!resource||__flags__.styles[resource+"|"+options.mediaTypes]){return null;}var css_path=getPath(type,resource,options);if(__flags__.styles.indexOf(css_path)<0){__flags__.styles.push(css_path);__flags__.styles.loader=__flags__.styles.loader||{};__flags__.styles.loader[css_path]={mediaTypes:options.mediaTypes,resource:resource};}if(!__flags__.styles.listened){__flags__.styles.listened=true;Ext.onReady(loadStyle);}}else{resourceObject=__flags__.modules[resource];if(!resourceObject){var path=getPath(type,resource,options);var found=ECM.loadModule(path,options.omitCheck?resource:null);if(!options.omitCheck){var message;if(found instanceof Error){alert('[ERROR] Could not load "'+resource+'" from "'+path+'": '+found.message+"\n\n");}else{if(!found){alert('[ERROR] Could not load "'+resource+'" from "'+path+'"\n\n');}}resourceObject=__flags__.modules[resource];if(!resourceObject&&!__flags__.notify[resource+"|"+path]){alert('[ERROR] Module "'+resource+'" is not defined after loading "'+path+'"\n\n');__flags__.notify[resource+"|"+path]=true;}}}}return resourceObject;};function getConnection(){var http;var err="";if(!ECM.Adapter.isIE){try{http=new XMLHttpRequest();}catch(e){err+=e.message;}}if(!http){for(var i=0,j=__constants__.XMLHTTP.length;i<j;i++){var id=__constants__.XMLHTTP[i];try{http=new ActiveXObject(id);}catch(e){err+=e.message;}if(http){__constants__.XMLHTTP=[id];break;}}}if(!http){alert("[ERROR] XMLHTTP not available: "+err+"\n\n");}return http;}function isValidStatus(http){var valid={protocol:"|file:|chrome:|app:|",status:"|304|1223|"};var response={protocol:location.protocol,status:http.status||0};if(response.status>=200&&response.status<300){return true;}else{if(valid.status.indexOf("|"+response.status+"|")>=0){return true;}else{if(!response.status&&valid.protocol.indexOf("|"+response.protocol+"|")>=0){return true;}else{return false;}}}}function getContent(uri){var http=getConnection();if(!http){return null;}try{http.open("GET",uri,false);http.send(null);if(!isValidStatus(http)){alert("[ERROR] Unable to load: "+uri+" status:"+http.status+"\n\n");}return http.responseText;}catch(e){return null;}}function getPath(type,resource,options){type=type||"js";resource=resource||"";options=options||{};var base=options.baseDir||__flags__.base[type];var escapedName=(options.specialName||"").replace(/./g,"|");var isSpecialName=ECM.Adapter.isEffective(options.specialName);var path=resource;if(isSpecialName){path=path.replace(options.specialName,escapedName);}path=path.split(".").join("/")+"."+type;if(isSpecialName){path=path.replace(escapedName,options.specialName);}if(ECM.Adapter.isEffective(options.relativePath)){path=(path.match("^"+base))?path.replace(base,options.relativePath):(options.relativePath+path);}else{path=(path.match("^"+base))?path:(base+path);}return path;}function loadStyle(){__flags__.styles.listened=false;__flags__.head=__flags__.head||document.getElementsByTagName("head")[0];var loader=__flags__.styles.loader;for(var i=0,j=__flags__.styles.length;i<j;i++){var style={path:__flags__.styles[i]};style.mediaTypes=loader[style.path].mediaTypes;style.resource=loader[style.path].resource;try{var link=document.createElement("link");link.setAttribute("rel","stylesheet");link.setAttribute("type","text/css");link.setAttribute("media",style.mediaTypes);link.setAttribute("href",style.path);if(__flags__.head&&__flags__.head.appendChild(link)){__flags__.styles[style.resource+"|"+style.mediaTypes]=true;}}catch(err){document.write('<link rel="stylesheet" type="text/css" media="'+style.mediaTypes+'" href="'+style.path+'">');__flags__.styles[style.resource+"|"+style.mediaTypes]=true;}}__flags__.styles.length=0;__flags__.styles.loader={};}ECM.hitch=function(scope,method){if(!method){method=scope;scope=null;}if(ECM.Adapter.isString(method)){scope=scope||window;if(!scope[method]){alert('[ERROR] ECM.hitch: scope["'+method+'"] is null (scope="'+scope+'")\n\n');}return function(){return scope[method].apply(scope,arguments||[]);
};}return !scope?method:function(){return method.apply(scope,arguments||[]);};};ECM.loadUri=function(uri,callback){if(__flags__.urls[uri]){return true;}__flags__.state|=__constants__.LOCKED;__flags__.inflight++;var contents=getContent(uri);if(contents){__flags__.urls[uri]=true;__flags__.urls.push(uri);contents=callback?"("+contents+")":""+contents+"";if(!ECM.Adapter.isIE){contents+="\r\n//@ sourceURL="+uri;}var value;try{value=(function(module){return eval(module);})(contents);}catch(err){}if(callback&&value){callback(value);}}if(--__flags__.inflight===0&&(__flags__.state&__constants__.LOADED)){window.setTimeout(function(){if(__flags__.inflight===0){__flags__.state&=~__constants__.LOCKED;fireReady();}},0);}else{__flags__.state&=~__constants__.LOCKED;}return !!contents;};ECM.loadUriAndCheck=function(uri,module,callback){var found=false;try{found=ECM.loadUri(uri,callback);}catch(err){found=false;}return !!(found&&__flags__.modules[module]);};ECM.loadModule=function(path,module,callback){try{return !module?ECM.loadUri(path,callback):ECM.loadUriAndCheck(path,module,callback);}catch(err){return err;}};ECM.getObject=function(name,context,create){var parts=name.split(".");var obj=context||ECM.global;for(var i=0,p;obj&&(p=parts[i]);i++){if(obj!==ECM.global&&!ECM.Adapter.isObject(obj)){if(create){throw new Error("A non-object value exists in the given context.");}obj=undefined;}else{obj=(p in obj?obj[p]:(create?obj[p]={}:undefined));}}return obj;};ECM.reload=function(resource){resource=String(resource);var sym=resource.split(".");if(sym.length>1){var pname=sym.slice(0,-1).join(".");var prop=sym[sym.length-1];var parent=ECM.getObject(pname,ECM.global);if(parent){delete parent[prop];}}var resourceObject=__flags__.modules[resource];if(resourceObject){delete __flags__.modules[resource];}var path=getPath(undefined,resource,{});delete __flags__.urls[path];ECM.require(resource);};ECM.subscribe=function(eventName,fn,scope,o){observer.addEvents(eventName);observer.on(eventName,fn,scope,o);return[eventName,fn,scope];};ECM.publish=function(){if(observer.eventsSuspended===true){return true;}if(!observer.events){return false;}var args=Array.prototype.slice.call(arguments,0),eventName=args[0],fn;var glob=observer.events["*"];if(glob&&glob.fire.apply(glob,args.slice(1))===false){return false;}if(eventName.substr(0,1)=="/"&&eventName.length>1){var chans=eventName.substr(1).split("/");for(var i=0,len=chans.length;i<=len;i++){fn=observer.events["/"+chans.slice(0,i).join("/").toLowerCase()];if(fn&&fn.fire.apply(fn,args.slice(1))===false){return false;}}}else{fn=observer.events[eventName.toLowerCase()];if(fn){var ret=fn.fire.apply(fn,args.slice(1));return ret;}}return true;};ECM.unsubscribe=function(handle){var eventName=handle[0],fn=handle[1],scope=handle[2];if(!eventName){return false;}var event=observer.events[eventName.toLowerCase()];if(ECM.Adapter.isDefined(event)){return event.removeListener(fn,scope);}return false;};ECM.bytesInString=function(str){return typeof str==="string"?unescape(encodeURIComponent(str)).length:0;};ECM.Adapter={apply:Ext.apply,applyIf:Ext.applyIf,BLANK_IMAGE_URL:Ext.BLANK_IMAGE_URL||"/images/blank.gif",decode:Ext.decode,destroy:Ext.destroy,each:Ext.each,encode:Ext.encode,escapeRe:Ext.escapeRe,extend:Ext.extend,fly:Ext.fly,get:Ext.get,getBody:Ext.getBody,getEl:Ext.getDom,getScrollBarWidth:Ext.getScrollBarWidth,History:Ext.History,isArray:Ext.isArray,isChrome:Ext.isChrome,isDefined:Ext.isDefined,isEffective:function(value){return Ext.isDefined(value)&&value!==null;},isFunction:Ext.isFunction,isGecko:Ext.isGecko,isGecko3:Ext.isGecko3,isIE:Ext.isIE,isIE6:Ext.isIE6,isNumber:Ext.isNumber,isObject:Ext.isObject,isOpera:Ext.isOpera,isString:Ext.isString,isWebKit:Ext.isWebKit,isWindows:Ext.isWindows,iterate:Ext.iterate,namespace:Ext.namespace,number:Ext.num,onUnload:function(fn,scope,options){Ext.EventManager.on.call(this,window,"unload",fn,scope,options);},override:Ext.override,pluck:Ext.pluck,register:Ext.reg,select:Ext.select,SSL_SECURE_URL:Ext.SSL_SECURE_URL||"about:blank",urlDecode:Ext.urlDecode,useDefined:function(value,defVal){return(Ext.isDefined(value))?value:defVal;},useEffective:function(value,defVal){return(ECM.Adapter.isEffective(value))?value:defVal;}};for(var library in __libraries__){if(ECM.Adapter.namespace(library)!==__libraries__[library]){var m=["[FATAL ERROR] Missing Dependency: ",library," != ",__libraries__[library],"\n\nApplication Halted. Bye!\n\n"].join("");alert(m);return false;}}ECM.Adapter.onUnload(function(){__constants__=__flags__=__libraries__=null;});if(ECM.Adapter.isGecko){new Ext.KeyMap(Ext.getDoc(),{key:[Ext.EventObject.DOWN,Ext.EventObject.UP,Ext.EventObject.LEFT,Ext.EventObject.RIGHT],fn:function(key,e){if(((e.target.tagName!=="INPUT")&&(e.target.tagName!=="TEXTAREA"))&&(Ext.getBody().hasClass("x-body-masked"))){e.stopEvent();}}});}Ext.grid.GridView.prototype.onDataChange=function(){this.refresh(false);this.updateHeaderSortState();this.syncFocusEl(0);};Ext.onReady(function(){Ext.MessageBox.getDialog().getEl().addClass("blue_button");});})();ECM.provide("ECM.treegrid.TreeGridNodeUI");ECM.treegrid.TreeGridNodeUI=ECM.Adapter.extend(Ext.tree.TreeNodeUI,{animExpand:function(a){this.ctNode.style.display="";ECM.treegrid.TreeGridNodeUI.superclass.animExpand.call(this,a);},getDDHandles:function(){return Ext.DomQuery.select(".x-drag-handle",this.elNode);},isTreeGridNodeUI:true,reserveScrollOffset:false,onCheckChange:function(c,b){if(!this.checkbox){return false;}var f=this.checkbox.checked;var d=this.node;this.checkbox.defaultChecked=d.attributes.checked=f;if(!b){var a=d.ownerTree;(f)?a.getSelectionModel().onNodeClick(d,c):d.unselect();}this.fireEvent("checkchange",d,f,c,b);},onSelectedChange:function(c,a){this[((c)?"add":"remove")+"Class"]("x-tree-selected");if(!a){var b=this.checkbox;if(b){b.checked=c;this.onCheckChange(null,1);}}},renderElements:function(u,t,c,y){var q=u.getOwnerTree();var r=ECM.Adapter.isEffective(t.checked);var s=-1;var o=q.columns;var f=o[0];(f.dataIndex==="checked")&&(r=true)&&(s=0);var x=u.attributes.isDefault;var b="",l=0,n=0;var p=q.root.id===u.parentNode.id;if(!u.previousSibling&&q.root.id===u.parentNode.id){}if(u.parentNode){this.indentMarkup=u.parentNode.ui.getChildIndent();n=u.parentNode.ui.getAncestorCnt();l=n>2?(n-2)*20:0;}if(q.stripeRows){b=(u.stripeIndex===-1)?"x-tree-node-name ":((!(u.stripeIndex&ECM.Rules.Constants.NUMBER.ODD))?"x-tree-node-regular ":"x-tree-node-alternative ");}var h="";if(u.parentNode.childNodes.length&&u.parentNode.childNodes[0].id==u.id){var B=mt.renderMode();h="ecm-rules-first-row ";if(window.ecmTargetingModeOn){if((B=="segment"&&u.stripeIndex==1)||(B=="standard"&&u.stripeIndex==0)){h+="ecm-targeting-subscription ";}}}var A=['<tbody class="x-tree-node">','<tr ext:tree-node-id="',u.id,'" class="x-tree-node-el ',b,h,(t.cls||""),(u.childNodes.length<=0&&q.root.id===u.parentNode.id?"ecm-rules-no-children":""),'">','<td class="x-treegrid-col x-drag-handle">','<div class="x-drag-handle ',("|draggable|standard|".indexOf("|"+f.dataIndex+"|")>-1&&!x)?" x-drag-icon":" x-drag-noicon",'"></div>','<img src="',this.emptyIcon,'" class="x-tree-ec-icon">','<span class="x-tree-node-indent x-drag-handle">',this.indentMarkup,"</span>",'<img src="',this.emptyIcon,'" class="',(q.root.id===u.parentNode.id)?"x-tree-no-elbow":"x-tree-elbow",'">','<img src="',(t.icon||this.emptyIcon),'" class="x-tree-node-icon x-drag-handle',((t.icon)?" x-tree-node-inline-icon":""),((t.iconCls)?" "+t.iconCls:""),'" unselectable="on">',(!x&&r)?('<input class="x-tree-node-cb x-drag-handle" type="checkbox"'+(t.checked?' checked="checked" />':"/>")):"",'<a hidefocus="on" class="x-tree-node-anchor x-drag-handle" href="',t.href||"#",'" tabIndex="1"',((t.hrefTarget)?' target="'+t.hrefTarget+'"':""),">",'<span class="x-drag-handle x-treegrid-text" unselectable="on">',(f.tpl?f.tpl.apply(t):(t[f.dataIndex]||f.text)),"</span></a>",(x?"&nbsp;":""),"</td>"];var z=['<col style="width:',(o[0].hidden?0:o[0].width),'px;" />'];for(var w=1,v=o.length;
w<v;w++){f=o[w];var k=t[f.dataIndex+"Qtip"];var a=f.align?"text-align:"+f.align+";":"";A.push('<td class="x-treegrid-col ',(f.cls||""),'">','<div unselectable="on" class="x-drag-handle x-treegrid-text" style="'+a+'"',((k)?' ext:qtip="'+k+'"':""),">",(f.tpl?f.tpl.apply(t):t[f.dataIndex]),"</div>","</td>");z.push('<col style="width:',(o[w].hidden?0:o[w].width),'px;" />');(f.dataIndex==="checked")&&(s=w);}A.push('</tr><tr class="x-tree-node-ct"><td colspan="',o.length,'">','<table class="x-treegrid-node-ct-table" cellpadding="0" cellspacing="0"',' style="table-layout:fixed; display:none; width:',q.innerCt.getWidth(),'px;"><colgroup>');A.push(z.join(""));A.push("</colgroup></table></td></tr></tbody>");if(!y&&u.nextSibling&&u.nextSibling.ui.getEl()){this.wrap=Ext.DomHelper.insertHtml("beforeBegin",u.nextSibling.ui.getEl(),A.join(""));}else{this.wrap=Ext.DomHelper.insertHtml("beforeEnd",c,A.join(""));}this.elNode=this.wrap.childNodes[0];this.ctNode=this.wrap.childNodes[1].firstChild.firstChild;var d=this.elNode.firstChild.childNodes;var g=0;this.dragNode=d[g++];this.ecNode=d[g++];this.indentNode=d[g++];this.elbowNode=d[g++];this.iconNode=d[g++];if(!x&&(r||s>-1)){this.checkbox=(r)?d[g++]:this.elNode.childNodes[s].firstChild.firstChild;(this.checkbox)&&(this.checkbox.defaultChecked=this.checkbox.checked);}this.anchor=d[g];this.textNode=d[g].firstChild;this.booleanNode=ECM.Adapter.get(Ext.DomQuery.select(".ecm-boolean-toggle",this.textNode)[0]);if(ECM.Adapter.isEffective(this.booleanNode)&&!!u.parentNode.isRoot){this.booleanNode.addClass("ecm-root-node-bool");}if(this.booleanNode){if(r){var m=gt.gettext("Click on the conjunction to toggle between and/or.");if(!u.ownerTree.allowTopLevelOr&&p){m="Your conditions must be part of a group in order to 'or' them. Once you create a group, you can drag your conditions into that group";}this.booleanNode.addClassOnOver("ecm-boolean-toggle-mo");u.ui.booleanNode.dom.setAttribute("ext:qtip",m);}q.mon(this.booleanNode,"click",function(j,D){q.fireEvent("booleanclick",this,j,D);},u);}this.conditionNode=ECM.Adapter.get(Ext.DomQuery.select(".ecm-condition",this.textNode)[0]);if(this.conditionNode){if(r){this.conditionNode.addClassOnOver("ecm-condition-mo");}q.mon(this.conditionNode,"click",function(j,D){q.fireEvent("conditionclick",this,j,D);},u);this.conditionNode.setWidth(500-l);}else{this.conditionNode=ECM.Adapter.get(Ext.DomQuery.select(".ecm-condition-disabled",this.textNode)[0]);}this.inclusionNode=ECM.Adapter.get(Ext.DomQuery.select(".ecm-inclusion-toggle",this.textNode)[0]);if(this.inclusionNode){if(r){u.ui.inclusionNode.dom.setAttribute("ext:qtip",gt.gettext("Click on action to toggle between include/exclude"));this.inclusionNode.addClassOnOver("ecm-inclusion-toggle-mo");}q.mon(this.inclusionNode,"click",function(j,D){q.fireEvent("inclusionclick",this,j,D);},u);}this.targetNode=ECM.Adapter.get(Ext.DomQuery.select(".ecm-target",this.elNode)[0]);if(this.targetNode){q.mon(this.targetNode,"click",function(j,D){q.fireEvent("targetclick",this,j,D);},u);}if(q.enableDD){Ext.dd.Registry.unregister(u.ui.elNode.id);Ext.dd.Registry.register(u.ui.elNode,{node:this.node,handles:this.getDDHandles(),isHandle:false});}}});ECM.provide("ECM.treegrid.TreeNode");ECM.treegrid.TreeNode=ECM.Adapter.extend(Ext.tree.TreeNode,{constructor:function(a){a=a||{};(ECM.Adapter.isString(a))&&(a={text:a});this.childrenRendered=this.rendered=false;ECM.treegrid.TreeNode.superclass.constructor.call(this,a);this.ui=new (this.attributes.uiProvider||this.defaultUI||Ext.tree.TreeNodeUI)(this);},defaultUI:ECM.treegrid.TreeGridNodeUI,fixStripe:function(a){this.stripeIndex=a;if(this.ui){this.ui.removeClass(["x-tree-node-regular","x-tree-node-alternative"]);this.ui.addClass((!(this.stripeIndex&ECM.Rules.Constants.NUMBER.ODD))?"x-tree-node-regular":"x-tree-node-alternative");}this.fixStripes();},fixStripes:function(f){f=f||0;var c=this.childNodes||[];for(var b=0,a=c.length;b<a;b++){var d=c[b];d.fixStripe.call(d,this.ownerTree.__data__.total++);}},indexInParent:function(){var a=this.parentNode;if(!a||!a.hasChildNodes()){return -1;}return a.indexOf(this);},indexPath:function(){var d=[];var a=this;var c=this.getOwnerTree().pathSeparator;while(a){var b=a.indexInParent();(b>-1)&&(d.unshift(b));a=a.parentNode;}return c+d.join(c);},select:function(a){a=a||{};a.selModel=a.selModel||(this.getOwnerTree()||{getSelectionModel:function(){return{select:function(){}};}}).getSelectionModel();if(a.internal){a.selModel.lastSelNode=this;if(a.selModel.isSelected(this)){return this;}a.selModel.selNodes.push(this);a.selModel.selMap[this.id]=this;this.ui.onSelectedChange(true,1);}else{return a.selModel.select(this);}},topLevelIndex:function(){var a=this.getOwnerTree().pathSeparator;this.rootSeparatorPattern=(this.rootSeparatorPattern||new RegExp("^"+a,"g"));var b=String.toInt(this.indexPath().replace(this.rootSeparatorPattern,"").split(a)[0]);return(ECM.Adapter.isEffective(b))?b:-1;},unselect:function(a,c){c=c||{};c.internal=(ECM.Adapter.isEffective(c.internal))?c.internal:1;if(!this.ownerTree){return false;}c.selModel=c.selModel||this.ownerTree.getSelectionModel();if(!c.selModel){return false;}if(c.selModel.selMap[this.id]){this.ui.onSelectedChange(false,c.internal);var d=c.selModel.selNodes;var b=d.indexOf(this);(b!==-1)&&(c.selModel.selNodes.splice(b,1));delete c.selModel.selMap[this.id];(!a)&&(c.selModel.fireEvent("selectionchange",c.selModel,c.selModel.selNodes));}}});ECM.provide("ECM.treegrid.AsyncTreeNode");ECM.treegrid.AsyncTreeNode=function(a){this.loaded=a&&a.loaded===true;this.loading=false;ECM.treegrid.AsyncTreeNode.superclass.constructor.apply(this,arguments);this.addEvents("beforeload","load");};Ext.extend(ECM.treegrid.AsyncTreeNode,ECM.treegrid.TreeNode,{expand:function(b,g,j,c){if(this.loading){var h;var d=function(){if(!this.loading){clearInterval(h);this.expand(b,g,j,c);}}.createDelegate(this);h=setInterval(d,200);return;}if(!this.loaded){if(this.fireEvent("beforeload",this)===false){return;}this.loading=true;this.ui.beforeLoad(this);var a=this.loader||this.attributes.loader||this.getOwnerTree().getLoader();if(a){a.load(this,this.loadComplete.createDelegate(this,[b,g,j,c]),this);return;}}ECM.treegrid.AsyncTreeNode.superclass.expand.call(this,b,g,j,c);},isLoading:function(){return this.loading;},loadComplete:function(a,c,d,b){this.loading=false;this.loaded=true;this.ui.afterLoad(this);this.fireEvent("load",this);this.expand(a,c,d,b);},isLoaded:function(){return this.loaded;},hasChildNodes:function(){if(!this.isLeaf()&&!this.loaded){return true;}else{return ECM.treegrid.AsyncTreeNode.superclass.hasChildNodes.call(this);}},reload:function(b,a){this.collapse(false,false);while(this.firstChild){this.removeChild(this.firstChild).destroy();}this.childrenRendered=false;this.loaded=false;if(this.isHiddenRoot()){this.expanded=false;}this.expand(false,false,b,a);}});ECM.provide("ECM.treegrid.TreeGridRootNodeUI");ECM.treegrid.TreeGridRootNodeUI=ECM.Adapter.extend(ECM.treegrid.TreeGridNodeUI,{collapse:Ext.emptyFn,destroy:function(){if(this.elNode){Ext.dd.Registry.unregister(this.elNode.id);}delete this.node;},expand:Ext.emptyFn,isTreeGridNodeUI:true,render:function(){if(!this.rendered){this.wrap=this.ctNode=this.node.ownerTree.innerCt.dom;this.node.expanded=true;}if(Ext.isWebKit){var a=this.ctNode;a.style.tableLayout=null;(function(){a.style.tableLayout="fixed";}).defer(1);}}});ECM.provide("ECM.treegrid.TreeGridSorter");ECM.treegrid.TreeGridSorter=Ext.extend(Ext.tree.TreeSorter,{sortClasses:["sort-asc","sort-desc"],sortAscText:"Sort Ascending",sortDescText:"Sort Descending",constructor:function(a,b){if(!Ext.isObject(b)){b={property:a.columns[0].dataIndex||"text",folderSort:true};}ECM.treegrid.TreeGridSorter.superclass.constructor.apply(this,arguments);this.tree=a;a.on("headerclick",this.onHeaderClick,this);a.ddAppendOnly=true;me=this;this.defaultSortFn=function(l,k){var g=me.dir&&me.dir.toLowerCase()=="desc";var c=me.property||"text";var f=me.sortType;var h=me.folderSort;var j=me.caseSensitive===true;
var d=me.leafAttr||"leaf";if(h){if(l.attributes[d]&&!k.attributes[d]){return 1;}if(!l.attributes[d]&&k.attributes[d]){return -1;}}var n=f?f(l):(j?l.attributes[c]:l.attributes[c].toUpperCase());var m=f?f(k):(j?k.attributes[c]:k.attributes[c].toUpperCase());if(n<m){return g?+1:-1;}else{if(n>m){return g?-1:+1;}else{return 0;}}};a.on("afterrender",this.onAfterTreeRender,this,{single:true});a.on("headermenuclick",this.onHeaderMenuClick,this);},onAfterTreeRender:function(){if(this.tree.hmenu){this.tree.hmenu.insert(0,{itemId:"asc",text:this.sortAscText,cls:"xg-hmenu-sort-asc"},{itemId:"desc",text:this.sortDescText,cls:"xg-hmenu-sort-desc"});}this.updateSortIcon(0,"asc");},onHeaderMenuClick:function(d,b,a){if(b==="asc"||b==="desc"){this.onHeaderClick(d,null,a);return false;}},onHeaderClick:function(f,b,a){if(f&&!this.tree.headersDisabled){var d=this;d.property=f.dataIndex;d.dir=f.dir=(f.dir==="desc"?"asc":"desc");d.sortType=f.sortType;d.caseSensitive===Ext.isBoolean(f.caseSensitive)?f.caseSensitive:this.caseSensitive;d.sortFn=f.sortFn||this.defaultSortFn;this.tree.root.cascade(function(c){if(!c.isLeaf()){d.updateSort(d.tree,c);}});this.updateSortIcon(a,f.dir);}},updateSortIcon:function(b,a){var d=this.sortClasses;var c=this.tree.innerHd.select("td").removeClass(d);c.item(b).addClass(d[a=="desc"?1:0]);}});ECM.provide("ECM.treegrid.TreeGridLoader");ECM.treegrid.TreeGridLoader=Ext.extend(Ext.tree.TreeLoader,{createNode:function(a){if(!a.uiProvider){a.uiProvider=ECM.treegrid.TreeGridNodeUI;}return Ext.tree.TreeLoader.prototype.createNode.call(this,a);}});ECM.provide("ECM.treegrid.TreeGridColumns");(function(){Ext.override(Ext.list.Column,{init:function(){var b=Ext.data.Types,a=this.sortType;if(this.type){if(Ext.isString(this.type)){this.type=Ext.data.Types[this.type.toUpperCase()]||b.AUTO;}}else{this.type=b.AUTO;}if(Ext.isString(a)){this.sortType=Ext.data.SortTypes[a];}else{if(Ext.isEmpty(a)){this.sortType=this.type.sortType;}}}});Ext.tree.Column=Ext.extend(Ext.list.Column,{});Ext.tree.NumberColumn=Ext.extend(Ext.list.NumberColumn,{});Ext.tree.DateColumn=Ext.extend(Ext.list.DateColumn,{});Ext.tree.BooleanColumn=Ext.extend(Ext.list.BooleanColumn,{});Ext.reg("tgcolumn",Ext.tree.Column);Ext.reg("tgnumbercolumn",Ext.tree.NumberColumn);Ext.reg("tgdatecolumn",Ext.tree.DateColumn);Ext.reg("tgbooleancolumn",Ext.tree.BooleanColumn);})();Ext.ns("ECM.ux");Ext.ns("ECM.ux.tree");Ext.ns("ECM.ux.treegrid");ECM.provide("ECM.treegrid.TreeGrid");ECM.treegrid.TreeGrid=Ext.extend(Ext.tree.TreePanel,{rootVisible:false,useArrows:true,lines:false,borderWidth:Ext.isBorderBox?0:2,cls:"x-treegrid",columnResize:true,enableSort:true,reserveScrollOffset:true,enableHdMenu:true,columnsText:"Columns",initComponent:function(){if(!this.root){this.root=new ECM.treegrid.AsyncTreeNode({text:"Root"});}var a=this.loader;if(!a){a=new ECM.treegrid.TreeGridLoader({dataUrl:this.dataUrl,requestMethod:this.requestMethod,store:this.store});}else{if(Ext.isObject(a)&&!a.load){a=new ECM.treegrid.TreeGridLoader(a);}else{if(a){a.createNode=function(c){if(!c.uiProvider){c.uiProvider=ECM.treegrid.TreeGridNodeUI;}return Ext.tree.TreeLoader.prototype.createNode.call(this,c);};}}}this.loader=a;ECM.treegrid.TreeGrid.superclass.initComponent.call(this);this.initColumns();if(this.enableSort){this.treeGridSorter=new ECM.treegrid.TreeGridSorter(this,this.enableSort);}if(this.columnResize){this.colResizer=new Ext.tree.ColumnResizer(this.columnResize);this.colResizer.init(this);}var b=this.columns;if(!this.internalTpl){this.internalTpl=new Ext.XTemplate('<div class="x-grid3-header">','<div class="x-treegrid-header-inner">','<div class="x-grid3-header-offset">','<table cellspacing="0" cellpadding="0" border="0"><colgroup><tpl for="columns"><col /></tpl></colgroup>','<thead><tr class="x-grid3-hd-row">','<tpl for="columns">','<td class="x-grid3-hd x-grid3-cell x-treegrid-hd" style="text-align: {align};" id="',this.id,'-xlhd-{#}">','<div class="x-grid3-hd-inner x-treegrid-hd-inner" unselectable="on">',this.enableHdMenu?'<a class="x-grid3-hd-btn" href="#"></a>':"",'{header}<img class="x-grid3-sort-icon" src="',Ext.BLANK_IMAGE_URL,'" />',"</div>","</td></tpl>","</tr></thead>","</div></table>","</div></div>","</div>",'<div class="x-treegrid-root-node">','<table class="x-treegrid-root-table" cellpadding="0" cellspacing="0" style="table-layout: fixed;"></table>',"</div>");}if(!this.colgroupTpl){this.colgroupTpl=new Ext.XTemplate('<colgroup><tpl for="columns"><col style="width: {width}px"/></tpl></colgroup>');}},initColumns:function(){var f=this.columns,a=f.length,d=[],b,g;for(b=0;b<a;b++){g=f[b];if(!g.isColumn){g.xtype=g.xtype?(/^tg/.test(g.xtype)?g.xtype:"tg"+g.xtype):"tgcolumn";g=Ext.create(g);}g.init(this);d.push(g);if(this.enableSort!==false&&g.sortable!==false){g.sortable=true;this.enableSort=true;}}this.columns=d;},onRender:function(){Ext.tree.TreePanel.superclass.onRender.apply(this,arguments);this.el.addClass("x-treegrid");this.outerCt=this.body.createChild({cls:"x-tree-root-ct x-treegrid-ct "+(this.useArrows?"x-tree-arrows":this.lines?"x-tree-lines":"x-tree-no-lines")});this.internalTpl.overwrite(this.outerCt,{columns:this.columns});this.mainHd=Ext.get(this.outerCt.dom.firstChild);this.innerHd=Ext.get(this.mainHd.dom.firstChild);this.innerBody=Ext.get(this.outerCt.dom.lastChild);this.innerCt=Ext.get(this.innerBody.dom.firstChild);this.colgroupTpl.insertFirst(this.innerCt,{columns:this.columns});if(this.hideHeaders){this.header.dom.style.display="none";}else{if(this.enableHdMenu!==false){this.hmenu=new Ext.menu.Menu({id:this.id+"-hctx"});if(this.enableColumnHide!==false){this.colMenu=new Ext.menu.Menu({id:this.id+"-hcols-menu"});this.colMenu.on({scope:this,beforeshow:this.beforeColMenuShow,itemclick:this.handleHdMenuClick});this.hmenu.add({itemId:"columns",hideOnClick:false,text:this.columnsText,menu:this.colMenu,iconCls:"x-cols-icon"});}this.hmenu.on("itemclick",this.handleHdMenuClick,this);}}},setRootNode:function(a){a.attributes.uiProvider=ECM.treegrid.TreeGridRootNodeUI;a=ECM.treegrid.TreeGrid.superclass.setRootNode.call(this,a);if(this.innerCt){this.colgroupTpl.insertFirst(this.innerCt,{columns:this.columns});}return a;},clearInnerCt:function(){if(Ext.isIE){var a=this.innerCt.dom;while(a.firstChild){a.removeChild(a.firstChild);}}else{ECM.treegrid.TreeGrid.superclass.clearInnerCt.call(this);}},initEvents:function(){ECM.treegrid.TreeGrid.superclass.initEvents.apply(this,arguments);this.mon(this.innerBody,"scroll",this.syncScroll,this);this.mon(this.innerHd,"click",this.handleHdDown,this);this.mon(this.mainHd,{scope:this,mouseover:this.handleHdOver,mouseout:this.handleHdOut});},onResize:function(b,c){ECM.treegrid.TreeGrid.superclass.onResize.apply(this,arguments);var f=this.innerBody.dom;var j=this.innerHd.dom;if(!f){return;}if(Ext.isNumber(c)){try{f.style.height=this.body.getHeight(true)-j.offsetHeight+"px";}catch(g){}}if(Ext.isNumber(b)){var a=Ext.num(this.scrollOffset,Ext.getScrollBarWidth());if(this.reserveScrollOffset||((f.offsetWidth-f.clientWidth)>10)){this.setScrollOffset(a);}else{var d=this;setTimeout(function(){d.setScrollOffset(f.offsetWidth-f.clientWidth>10?a:0);},10);}}},updateColumnWidths:function(){var l=this.columns,n=l.length,a=this.outerCt.query("colgroup"),m=a.length,k,f,d,b;for(d=0;d<n;d++){k=l[d];for(b=0;b<m;b++){f=a[b];f.childNodes[d].style.width=(k.hidden?0:k.width)+"px";}}for(d=0,a=this.innerHd.query("td"),len=a.length;d<len;d++){k=Ext.fly(a[d]);if(l[d]&&l[d].hidden){k.addClass("x-treegrid-hd-hidden");}else{k.removeClass("x-treegrid-hd-hidden");}}var h=this.getTotalColumnWidth();Ext.fly(this.innerHd.dom.firstChild).setWidth(h+(this.scrollOffset||0));this.outerCt.select("table").setWidth(h);this.syncHeaderScroll();},getVisibleColumns:function(){var c=[],d=this.columns,a=d.length,b;for(b=0;b<a;b++){if(!d[b].hidden){c.push(d[b]);}}return c;},getTotalColumnWidth:function(){var d=0;for(var b=0,c=this.getVisibleColumns(),a=c.length;b<a;b++){d+=c[b].width;}return d;},setScrollOffset:function(a){this.scrollOffset=a;
this.updateColumnWidths();},handleHdDown:function(j,f){var h=j.getTarget(".x-treegrid-hd");if(h&&Ext.fly(f).hasClass("x-grid3-hd-btn")){var b=this.hmenu.items,g=this.columns,a=this.findHeaderIndex(h),k=g[a],d=k.sortable;j.stopEvent();Ext.fly(h).addClass("x-grid3-hd-menu-open");this.hdCtxIndex=a;this.fireEvent("headerbuttonclick",b,k,h,a);this.hmenu.on("hide",function(){Ext.fly(h).removeClass("x-grid3-hd-menu-open");},this,{single:true});this.hmenu.show(f,"tl-bl?");}else{if(h){var a=this.findHeaderIndex(h);this.fireEvent("headerclick",this.columns[a],h,a);}}},handleHdOver:function(d,a){var c=d.getTarget(".x-treegrid-hd");if(c&&!this.headersDisabled){index=this.findHeaderIndex(c);this.activeHdRef=a;this.activeHdIndex=index;var b=Ext.get(c);this.activeHdRegion=b.getRegion();b.addClass("x-grid3-hd-over");this.activeHdBtn=b.child(".x-grid3-hd-btn");if(this.activeHdBtn){this.activeHdBtn.dom.style.height=(c.firstChild.offsetHeight-1)+"px";}}},handleHdOut:function(c,a){var b=c.getTarget(".x-treegrid-hd");if(b&&(!Ext.isIE||!c.within(b,true))){this.activeHdRef=null;Ext.fly(b).removeClass("x-grid3-hd-over");b.style.cursor="";}},findHeaderIndex:function(d){d=d.dom||d;var b=d.parentNode.childNodes;for(var a=0,f;f=b[a];a++){if(f==d){return a;}}return -1;},beforeColMenuShow:function(){var d=this.columns,b=d.length,a,f;this.colMenu.removeAll();for(a=1;a<b;a++){f=d[a];if(f.hideable!==false){this.colMenu.add(new Ext.menu.CheckItem({itemId:"col-"+a,text:f.header,checked:!f.hidden,hideOnClick:false,disabled:f.hideable===false}));}}},handleHdMenuClick:function(b){var a=this.hdCtxIndex,c=b.getItemId();if(this.fireEvent("headermenuclick",this.columns[a],c,a)!==false){a=c.substr(4);if(a>0&&this.columns[a]){this.setColumnVisible(a,!b.checked);}}return true;},setColumnVisible:function(a,b){this.columns[a].hidden=!b;this.updateColumnWidths();},scrollToTop:function(){this.innerBody.dom.scrollTop=0;this.innerBody.dom.scrollLeft=0;},syncScroll:function(){this.syncHeaderScroll();var a=this.innerBody.dom;this.fireEvent("bodyscroll",a.scrollLeft,a.scrollTop);},syncHeaderScroll:function(){var a=this.innerBody.dom;this.innerHd.dom.scrollLeft=a.scrollLeft;this.innerHd.dom.scrollLeft=a.scrollLeft;},registerNode:function(a){ECM.treegrid.TreeGrid.superclass.registerNode.call(this,a);if(!a.uiProvider&&!a.isRoot&&!a.ui.isTreeGridNodeUI){a.ui=new ECM.treegrid.TreeGridNodeUI(a);}}});ECM.treegrid.TreeGrid.nodeTypes={};ECM.treegrid.TreeGrid.nodeTypes.async=ECM.treegrid.AsyncTreeNode;Ext.reg("treegrid",ECM.treegrid.TreeGrid);ECM.provide("ECM.tree.TreeNodeUI");ECM.tree.TreeNodeUI=function(a){this.node=a;this.rendered=false;this.animating=false;this.wasLeaf=true;this.ecc="x-tree-ec-icon x-tree-elbow";this.emptyIcon=Ext.BLANK_IMAGE_URL;};ECM.tree.TreeNodeUI.prototype={removeChild:function(a){if(this.rendered){this.ctNode.removeChild(a.ui.getEl());}},beforeLoad:function(){this.addClass("x-tree-node-loading");},afterLoad:function(){this.removeClass("x-tree-node-loading");},onTextChange:function(b,c,a){if(this.rendered){this.textNode.innerHTML=c;}},onDisableChange:function(a,b){this.disabled=b;if(this.checkbox){this.checkbox.disabled=b;}if(b){this.addClass("x-tree-node-disabled");}else{this.removeClass("x-tree-node-disabled");}},onSelectedChange:function(a){if(a){this.focus();this.addClass("x-tree-selected");}else{this.removeClass("x-tree-selected");}},onMove:function(a,h,f,g,d,b){this.childIndent=null;if(this.rendered){var j=g.ui.getContainer();if(!j){this.holder=document.createElement("div");this.holder.appendChild(this.wrap);return;}var c=b?b.ui.getEl():null;if(c){j.insertBefore(this.wrap,c);}else{j.appendChild(this.wrap);}this.node.renderIndent(true,f!=g);}},addClass:function(a){if(this.elNode){Ext.fly(this.elNode).addClass(a);}},removeClass:function(a){if(this.elNode){Ext.fly(this.elNode).removeClass(a);}},remove:function(){if(this.rendered){this.holder=document.createElement("div");this.holder.appendChild(this.wrap);}},fireEvent:function(){return this.node.fireEvent.apply(this.node,arguments);},initEvents:function(){this.node.on("move",this.onMove,this);if(this.node.disabled){this.onDisableChange(this.node,true);}if(this.node.hidden){this.hide();}var b=this.node.getOwnerTree();var a=b.enableDD||b.enableDrag||b.enableDrop;if(a&&(!this.node.isRoot||b.rootVisible)){Ext.dd.Registry.register(this.elNode,{node:this.node,handles:this.getDDHandles(),isHandle:false});}},getDDHandles:function(){return[this.iconNode,this.textNode,this.elNode];},hide:function(){this.node.hidden=true;if(this.wrap){this.wrap.style.display="none";}},show:function(){this.node.hidden=false;if(this.wrap){this.wrap.style.display="";}},onContextMenu:function(a){if(this.node.hasListener("contextmenu")||this.node.getOwnerTree().hasListener("contextmenu")){a.preventDefault();this.focus();this.fireEvent("contextmenu",this.node,a);}},onClick:function(c){if(this.dropping){c.stopEvent();return;}if(this.fireEvent("beforeclick",this.node,c)!==false){var b=c.getTarget("a");if(!this.disabled&&this.node.attributes.href&&b){this.fireEvent("click",this.node,c);return;}else{if(b&&c.ctrlKey){c.stopEvent();}}c.preventDefault();if(this.disabled){return;}if(this.node.attributes.singleClickExpand&&!this.animating&&this.node.isExpandable()){this.node.toggle();}this.fireEvent("click",this.node,c);}else{c.stopEvent();}},onDblClick:function(a){a.preventDefault();if(this.disabled){return;}if(this.fireEvent("beforedblclick",this.node,a)!==false){if(this.checkbox){this.toggleCheck();}if(!this.animating&&this.node.isExpandable()){this.node.toggle();}this.fireEvent("dblclick",this.node,a);}},onOver:function(a){this.addClass("x-tree-node-over");},onOut:function(a){this.removeClass("x-tree-node-over");},onCheckChange:function(){var a=this.checkbox.checked;this.checkbox.defaultChecked=a;this.node.attributes.checked=a;this.fireEvent("checkchange",this.node,a);},ecClick:function(a){if(!this.animating&&this.node.isExpandable()){this.node.toggle();}},startDrop:function(){this.dropping=true;},endDrop:function(){setTimeout(function(){this.dropping=false;}.createDelegate(this),50);},expand:function(){this.updateExpandIcon();this.ctNode.style.display="";},focus:function(){if(!this.node.preventHScroll){try{this.anchor.focus();}catch(c){}}else{try{var b=this.node.getOwnerTree().getTreeEl().dom;var a=b.scrollLeft;this.anchor.focus();b.scrollLeft=a;}catch(c){}}},toggleCheck:function(b){var a=this.checkbox;if(a){a.checked=(b===undefined?!a.checked:b);this.onCheckChange();}},blur:function(){try{this.anchor.blur();}catch(a){}},animExpand:function(b){var a=Ext.get(this.ctNode);a.stopFx();if(!this.node.isExpandable()){this.updateExpandIcon();this.ctNode.style.display="";Ext.callback(b);return;}this.animating=true;this.updateExpandIcon();a.slideIn("t",{callback:function(){this.animating=false;Ext.callback(b);},scope:this,duration:this.node.ownerTree.duration||0.25});},highlight:function(){var a=this.node.getOwnerTree();Ext.fly(this.wrap).highlight(a.hlColor||"C3DAF9",{endColor:a.hlBaseColor});},collapse:function(){this.updateExpandIcon();this.ctNode.style.display="none";},animCollapse:function(b){var a=Ext.get(this.ctNode);a.enableDisplayMode("block");a.stopFx();this.animating=true;this.updateExpandIcon();a.slideOut("t",{callback:function(){this.animating=false;Ext.callback(b);},scope:this,duration:this.node.ownerTree.duration||0.25});},getContainer:function(){return this.ctNode;},getEl:function(){return this.wrap;},appendDDGhost:function(a){a.appendChild(this.elNode.cloneNode(true));},getDDRepairXY:function(){return Ext.lib.Dom.getXY(this.iconNode);},onRender:function(){this.render();},render:function(c){var f=this.node,b=f.attributes;var d=f.parentNode?f.parentNode.ui.getContainer():f.ownerTree.innerCt.dom;if(!this.rendered){this.rendered=true;this.renderElements(f,b,d,c);if(b.qtip){if(this.textNode.setAttributeNS){this.textNode.setAttributeNS("ext","qtip",b.qtip);if(b.qtipTitle){this.textNode.setAttributeNS("ext","qtitle",b.qtipTitle);}}else{this.textNode.setAttribute("ext:qtip",b.qtip);
if(b.qtipTitle){this.textNode.setAttribute("ext:qtitle",b.qtipTitle);}}}else{if(b.qtipCfg){b.qtipCfg.target=Ext.id(this.textNode);Ext.QuickTips.register(b.qtipCfg);}}this.initEvents();if(!this.node.expanded){this.updateExpandIcon(true);}}else{if(c===true){d.appendChild(this.wrap);}}},renderElements:function(f,l,k,m){this.indentMarkup=f.parentNode?f.parentNode.ui.getChildIndent():"";var g=Ext.isBoolean(l.checked),b,c=l.href?l.href:Ext.isGecko?"":"#",d=['<li class="x-tree-node"><div ext:tree-node-id="',f.id,'" class="x-tree-node-el x-tree-node-leaf x-unselectable ',l.cls,'" unselectable="on">','<span class="x-tree-node-indent">',this.indentMarkup,"</span>",'<img src="',this.emptyIcon,'" class="x-tree-ec-icon x-tree-elbow" />','<img src="',l.icon||this.emptyIcon,'" class="x-tree-node-icon',(l.icon?" x-tree-node-inline-icon":""),(l.iconCls?" "+l.iconCls:""),'" unselectable="on" />',g?('<input class="x-tree-node-cb" type="checkbox" '+(l.checked?'checked="checked" />':"/>")):"",'<a hidefocus="on" class="x-tree-node-anchor" href="',c,'" tabIndex="1" ',l.hrefTarget?' target="'+l.hrefTarget+'"':"",'><span unselectable="on">',f.text,"</span></a></div>",'<ul class="x-tree-node-ct" style="display:none;"></ul>',"</li>"].join("");if(m!==true&&f.nextSibling&&(b=f.nextSibling.ui.getEl())){this.wrap=Ext.DomHelper.insertHtml("beforeBegin",b,d);}else{this.wrap=Ext.DomHelper.insertHtml("beforeEnd",k,d);}this.elNode=this.wrap.childNodes[0];this.ctNode=this.wrap.childNodes[1];var j=this.elNode.childNodes;this.indentNode=j[0];this.ecNode=j[1];this.iconNode=j[2];var h=3;if(g){this.checkbox=j[3];this.checkbox.defaultChecked=this.checkbox.checked;h++;}this.anchor=j[h];this.textNode=j[h].firstChild;},getAnchor:function(){return this.anchor;},getTextEl:function(){return this.textNode;},getIconEl:function(){return this.iconNode;},isChecked:function(){return this.checkbox?this.checkbox.checked:false;},updateExpandIcon:function(){if(this.rendered){var g=this.node,d,c,a=g.isLast()?"x-tree-elbow-end":"x-tree-elbow",f=g.hasChildNodes();if(f||g.attributes.expandable){if(g.expanded){a+="-minus";d="x-tree-node-collapsed";c="x-tree-node-expanded";}else{a+="-plus";d="x-tree-node-expanded";c="x-tree-node-collapsed";}if(this.wasLeaf){this.removeClass("x-tree-node-leaf");this.wasLeaf=false;}if(this.c1!=d||this.c2!=c){Ext.fly(this.elNode).replaceClass(d,c);this.c1=d;this.c2=c;}}else{if(!this.wasLeaf){Ext.fly(this.elNode).replaceClass("x-tree-node-expanded","x-tree-node-collapsed");delete this.c1;delete this.c2;this.wasLeaf=true;}}var b="x-tree-ec-icon "+a;if(this.ecc!=b){this.ecNode.className=b;this.ecc=b;}}},onIdChange:function(a){if(this.rendered){this.elNode.setAttribute("ext:tree-node-id",a);}},getChildIndent:function(){if(!this.childIndent){var a=[],b=this.node;while(b){if(!b.isRoot||(b.isRoot&&b.ownerTree.rootVisible)){if(!b.isLast()){a.unshift('<img src="'+this.emptyIcon+'" class="x-tree-elbow-line" />');}else{a.unshift('<img src="'+this.emptyIcon+'" class="x-tree-icon" />');}}b=b.parentNode;}this.childIndent=a.join("");}return this.childIndent;},renderIndent:function(){if(this.rendered){var a="",b=this.node.parentNode;if(b){a=b.ui.getChildIndent();}if(this.indentMarkup!=a){this.indentNode.innerHTML=a;this.indentMarkup=a;}this.updateExpandIcon();}},destroy:function(){if(this.elNode){Ext.dd.Registry.unregister(this.elNode.id);}Ext.each(["textnode","anchor","checkbox","indentNode","ecNode","iconNode","elNode","ctNode","wrap","holder"],function(a){if(this[a]){Ext.fly(this[a]).remove();delete this[a];}},this);delete this.node;}};ECM.provide("ECM.tree.RootTreeNodeUI");ECM.tree.RootTreeNodeUI=Ext.extend(ECM.tree.TreeNodeUI,{render:function(){if(!this.rendered){var a=this.node.ownerTree.innerCt.dom;this.node.expanded=true;a.innerHTML='<div class="x-tree-root-node"></div>';this.wrap=this.ctNode=a.firstChild;}},collapse:Ext.emptyFn,expand:Ext.emptyFn});ECM.provide("ECM.Native.String");String.escapeInQuotes=function(b){return('"'+String((typeof(b)!=="undefined")?b:"").replace(/(["\\])/g,"\\$1")+'"').replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r");};String.toInt=function(g,d){d=(typeof(d)!=="undefined")?d:10;var h;try{h=parseInt(String(g),d);}catch(f){}h=(ECM.Adapter.isNumber(h))?h:0;return h;};String.toProperCase=function(a){return String.trim(a).toLowerCase().replace(/^(.)|\s(.)/g,function(b){return b.toUpperCase();});};String.trim=function(b){return String((typeof(b)!=="undefined")?b:"").replace(/(^\s*)|(\s*$)/g,"");};String.prototype.wordBreak=function(a){if(!a){a=10;}var b=this.toString();if(b.length>a){return b.substring(0,a)+"&#8203;"+b.substring(a).wordBreak(a);}else{return b;}};String.prototype.decodeEntities=function(){var a=document.createElement("textarea");return function(){var c=this.toString().split("\n");for(var b=0;b<c.length;b++){a.innerHTML=c[b].entitizeBrackets();c[b]=a.value;}return c.join("\n");};}();String.prototype.entitizeBrackets=function(){var a=this;return !a?a:String(a).replace(/[>]/g,"&gt;").replace(/[<]/g,"&lt;");};ECM.provide("ECM.Native.Array");Array.clone=function(f){if(ECM.Adapter.isArray(f)){var c=[];for(var d=0,a=f.length;d<a;d++){c[d]=arguments.callee(f[d]);}return c;}if(typeof(f)==="object"&&f!==null){var c={};for(var b in f){c[b]=arguments.callee(f[b]);}return c;}return f;};Array.insertAt=function(g,f,m){if(!ECM.Adapter.isArray(g)||!ECM.Adapter.isEffective(f)){return;}m=(ECM.Adapter.isEffective(m))?String.toInt(m):g.length;if(m<g.length){var l=g.splice(m,100000,f);for(var k=0,h=l.length;k<h;k++){g.push(l[k]);}}else{g[m]=f;}};Array.removeAt=function(d,c){return(ECM.Adapter.isArray(d))?d.splice((c||0),1):[];};if(!("map" in Array.prototype)){Array.prototype.map=function(d,c){var a=new Array(this.length);for(var b=0,f=this.length;b<f;b++){if(b in this){a[b]=d.call(c,this[b],b,this);}}return a;};}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(b){var a=this.length>>>0;var c=Number(arguments[1])||0;c=(c<0)?Math.ceil(c):Math.floor(c);if(c<0){c+=a;}for(;c<a;c++){if(c in this&&this[c]===b){return c;}}return -1;};}if(!Array.prototype.forEach){Array.prototype.forEach=function(b){if(this===void 0||this===null){throw new TypeError();}var f=Object(this);var a=f.length>>>0;if(typeof b!=="function"){throw new TypeError();}var d=arguments[1];for(var c=0;c<a;c++){if(c in f){b.call(d,f[c],c,f);}}};}Array.all=function(c,a){a=a||(function(d){return d;});var b=true;Ext.each(c,function(d){if(!a(d)){b=false;return false;}});return b;};Array.any=function(c,a){a=a||(function(d){return d;});var b=false;Ext.each(c,function(d){if(a(d)){b=true;return false;}});return b;};Array.intersection=function(b){var a=[];Ext.each(b.pop(),function(c){if(Array.all(b,function(d){return d.indexOf(c)>-1;})){a.push(c);}});return a;};ECM.provide("ECM.Native.Object");Object.extend=function(d,c){d=d||{};for(var f in c){d[f]=c[f];}return d;};Object.reset=function(a){if(a){switch(a.constructor){case Array:a=[];break;case Object:a={};break;case Number:a=0;break;case String:a="";break;}}return a;};Object.indexOf=function(d,c){if(d){for(var f in d){if(String.trim(d[f])===String.trim(c||d[f])){return f;}}}return undefined;};Object.hasValue=Object.indexOf;Object.hasKey=function(f,d){var j=false;if(f){try{j=!!(d in f);}catch(h){for(var g in f){if(typeof(d)!=="undefined"&&String.trim(d)===String.trim(g)){j=true;break;}}}}return j;};Object.firstKey=function(b){return Object.indexOf(b);};Object.isEmpty=function(b){return(typeof(Object.firstKey(b))==="undefined");};Object.hasMulti=function(b){var f=0;if(b){for(var d in b){f++;if(f>1){return true;}}}return false;};ECM.provide("ECM.Native");if(typeof(window.external)!=="undefined"){document.getElementsByName=function(c,a){a=a||"*";var f=document.getElementsByTagName(a);var g=[];for(var d=0,b=f.length;d<b;d++){(f[d].getAttribute("name")===c)&&(g.push(f[d]));}return g;};}window.Node=window.Node||{ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12};
ECM.provide("ECM.Error");(function(){var k=50;var h="mouseup";var g=function(m,l){return function(p){p=(typeof p==="string"?function(){var q={};q.message=p;return q;}():p||{});p.cls=m;p.clear=l?true:false;this.dispatch(p);var n=Ext.getBody();var o=function(r){var q=ECM.util.getMouseClickBtn(r);if(q==="left"){b(p);Ext.EventManager.removeListener(n,h,o,this);}};if(n&&!n.autoClear&&this.autoClearEnabled){n.autoClear=true;n.on(h,o,this);}};};var d=function(l){return function(o){o=o||{};var m=l?".system-notification":(this.selector?this.selector:o.selector);if(!Ext.isEmpty(m)){var n=Ext.query(m);n.forEach(function(p){this.resetElement(p);},this);}};};var f=function(l){return function(m){m=(typeof m==="string")?{message:m}:m||{};var n=this.selector?Ext.query(this.selector+"."+l+" div.text"):[];if(n.length>0){n.forEach(function(o){if(o.innerHTML===m.message){this.resetElement(o);}});}};};var a=function(){return function(m){var l=this;if(m&&m.redirectUrl){l.redirect(m.redirectUrl);}else{l.redirect("/cm/login");}};};var b=function(m){var l=Ext.getBody();if(!l||!l.autoClear){return;}l.autoClear=false;ECM.publish("/notify/clear",m);};var c=[["/notify/error/authentication",a()],["/notify/error",g("error")],["/notify/error/clear",g("error",true)],["/notify/info",g("info")],["/notify/info/clear",g("info",true)],["/notify/warn",g("warn")],["/notify/warn/clear",g("warn",true)],["/notify/clear",d()],["/notify/clear/all",d(true)],["/notify/single/error/clear",f("error")]];var j=function(p){var m=[],o=gt.gettext("Message"),l=gt.gettext("Error number"),n=gt.gettext("Description");m.push(o+": ("+p.name+") "+p.message);m.push(l+": "+(p.number&65535));m.push(n+": "+p.description);return m.join("\n");};ECM.Error=Ext.extend(Ext.util.Observable,{constructor:function(l){var m=this;l=l||{};this.handles=[];this.selector=l.selector;this.autoClearEnabled=l.autoClear||false;c.forEach(function(o,n){m.handles.push(ECM.subscribe(o[0],o[1],m));});},resetElement:function(l){if(this.toolTip){this.toolTip.destroy();}while(l.firstChild){if(l.onclick){l.onclick=null;}l.removeChild(l.firstChild);}l.className=l.className.replace(/ system-notification| error| warn| info/g,"");return l;},display:function(l){var t=this;var n={selector:this.selector,message:[]};if(Ext.isArray(l)){n.message=l;}else{if(Ext.isString(l)){if(l.length>0){n.message=[l];}}else{if(Ext.isString(l.message)){if(l.message.length>0){n.message=[l.message];}}else{n.message=[gt.gettext("An unknown error has occurred")];}}}n.selector=l.selector||this.select||"";if(n.message.length===0){return;}var p=n.selector||this.selector||"";var m=p?Ext.query(p):[];if(m.length>0){m.forEach(function(v){if(l.clear){t.resetElement(v);}Ext.each(n.message,function(z){var x=document.createElement("a"),w=document.createElement("div"),y=document.createElement("div");x.className="icon";x.onclick=function(){t.resetElement(v);};w.className="text";y.className="clear";v.className+=" system-notification "+l.cls;v.appendChild(x);v.appendChild(w);v.appendChild(y);w.innerHTML=t.toHTML(z,true,v,l.cls,l.width);});});}else{var r=l.title||"",u="ecm-window-error";switch(l.cls){case"info":r=gt.gettext("Notice");break;case"warn":r=gt.gettext("Warning");break;case"error":r=gt.gettext("An error has occurred");break;default:r=gt.gettext("An error has occurred");break;}var s=Ext.lib.Dom.getViewportWidth()-300;var o=Ext.select("."+u).elements.length;if(o>k){return;}var q=new Ext.Window({autoHeight:true,cls:u,animateTarget:Ext.getBody(),bodyStyle:{padding:5},height:150,html:n.message.map(this.toHTML).join("<br />"),modal:false,title:r,width:250,x:s-10*o,y:50+10*o});q.show();}},doToolTip:function(o,m,n){var l={tag:"div",children:[{tag:"div",cls:"error-tip-wrapper "+m,children:[{tag:"div",cls:"error-text",html:o}]}]};self.toolTip=new Ext.ToolTip({target:n,cls:"notify-tip",trackMouse:true,html:l});},toHTML:function(p,q,o,l,n){if(q){var m=ECM.DomHelper.ellipsis({width:n,text:p,cls:"ecm-notify-ellipsis"});if(m.truncated){this.doToolTip(p,l,o);p=m.text;}}return p.replace(/\n/g,"<br />").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;");},dispatch:function(l){l.message=l.message||"";l.selector=l.selector||"";l.cls=l.cls||"";l.width=l.width||300;if(l.error&&l.error instanceof Error){l.message+=j(l.error);}try{this.display(l);}catch(m){if("console" in window&&"error" in window.console){window.console.error(j(m));}return false;}return true;},redirect:function(l){window.location=l;},trace:function(n){var q=this;var o=(n&&n.e)?n.e:null;var s=n?!!n.guess:true;var m=function(){return{run:function(p){p=p||(function(){try{this.undef();return null;}catch(u){return u;}})();var t=this._mode||this.mode(p);if(t==="other"){return this.other(arguments.callee);}else{return this[t](p);}},mode:function(p){if(p["arguments"]){return(this._mode="chrome");}else{if(typeof window!=="undefined"&&window.opera&&p.stacktrace){return(this._mode="opera10");}else{if(p.stack){return(this._mode="firefox");}else{if(typeof window!=="undefined"&&window.opera&&!("stacktrace" in p)){return(this._mode="opera");}}}}return(this._mode="other");},instrumentFunction:function(p,t,u){p=p||window;p["_old"+t]=p[t];p[t]=function(){u.call(this,q.trace());return p["_old"+t].apply(this,arguments);};p[t]._instrumented=true;},deinstrumentFunction:function(p,t){if(p[t].constructor===Function&&p[t]._instrumented&&p["_old"+t].constructor===Function){p[t]=p["_old"+t];}},chrome:function(p){return p.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@").split("\n");},firefox:function(p){return p.stack.replace(/(?:\n@:0)?\s+$/m,"").replace(/^\(/gm,"{anonymous}(").split("\n");},opera10:function(x){var z=x.stacktrace;var B=z.split("\n"),p="{anonymous}",y=/.*line (\d+), column (\d+) in ((<anonymous function\:?\s*(\S+))|([^\(]+)\([^\)]*\))(?: in )?(.*)\s*$/i,v,u,w;for(v=2,u=0,w=B.length;v<w-2;v++){if(y.test(B[v])){var A=RegExp.$6+":"+RegExp.$1+":"+RegExp.$2;var t=RegExp.$3;t=t.replace(/<anonymous function\:?\s?(\S+)?>/g,p);B[u++]=t+"@"+A;}}B.splice(u,B.length-u);return B;},opera:function(y){var u=y.message.split("\n"),t="{anonymous}",x=/Line\s+(\d+).*script\s+(http\S+)(?:.*in\s+function\s+(\S+))?/i,w,v,p;for(w=4,v=0,p=u.length;w<p;w+=2){if(x.test(u[w])){u[v++]=(RegExp.$3?RegExp.$3+"()@"+RegExp.$2+RegExp.$1:t+"()@"+RegExp.$2+":"+RegExp.$1)+" -- "+u[w+1].replace(/^\s+/,"");}}u.splice(v,u.length-v);return u;},other:function(y){var t="{anonymous}",x=/function\s*([\w\-$]+)?\s*\(/i,p=[],v,u,w=10;while(y&&p.length<w){v=x.test(y.toString())?RegExp.$1||t:t;u=Array.prototype.slice.call(y["arguments"]);p[p.length]=v+"("+this.stringifyArguments(u)+")";y=y.caller;}return p;},stringifyArguments:function(t){for(var u=0;u<t.length;++u){var p=t[u];if(p===undefined){t[u]="undefined";}else{if(p===null){t[u]="null";}else{if(p.constructor){if(p.constructor===Array){if(p.length<3){t[u]="["+this.stringifyArguments(p)+"]";}else{t[u]="["+this.stringifyArguments(Array.prototype.slice.call(p,0,1))+"..."+this.stringifyArguments(Array.prototype.slice.call(p,-1))+"]";}}else{if(p.constructor===Object){t[u]="#object";}else{if(p.constructor===Function){t[u]="#function";}else{if(p.constructor===String){t[u]='"'+p+'"';}}}}}}}}return t.join(",");},sourceCache:{},ajax:function(p){var t=this.createXMLHTTPObject();if(!t){return;}t.open("GET",p,false);t.setRequestHeader("User-Agent","XMLHTTP/1.0");t.send("");return t.responseText;},createXMLHTTPObject:function(){var u,p=[function(){return new XMLHttpRequest();},function(){return new ActiveXObject("Msxml2.XMLHTTP");},function(){return new ActiveXObject("Msxml3.XMLHTTP");},function(){return new ActiveXObject("Microsoft.XMLHTTP");}];for(var t=0;t<p.length;t++){try{u=p[t]();this.createXMLHTTPObject=p[t];return u;}catch(v){}}},isSameDomain:function(p){return p.indexOf(location.hostname)!==-1;},getSource:function(p){if(!(p in this.sourceCache)){this.sourceCache[p]=this.ajax(p).split("\n");}return this.sourceCache[p];},guessFunctions:function(t){for(var v=0;v<t.length;++v){var z=/\{anonymous\}\(.*\)@(\w+:\/\/([\-\w\.]+)+(:\d+)?[^:]+):(\d+):?(\d+)?/;
var y=t[v],p=z.exec(y);if(p){var u=p[1],x=p[4];if(u&&this.isSameDomain(u)&&x){var w=this.guessFunctionName(u,x);t[v]=y.replace("{anonymous}",w);}}}return t;},guessFunctionName:function(t,v){var p;try{p=this.guessFunctionNameFromLines(v,this.getSource(t));}catch(u){p="getSource failed with url: "+t+", exception: "+u.toString();}return p;},guessFunctionNameFromLines:function(z,x){var u=/function ([^(]*)\(([^)]*)\)/;var y=/['"]?([0-9A-Za-z_]+)['"]?\s*[:=]\s*(function|eval|new Function)/;var t="",v=10;for(var w=0;w<v;++w){t=x[z-w]+t;if(t!==undefined){var p=y.exec(t);if(p&&p[1]){return p[1];}else{p=u.exec(t);if(p&&p[1]){return p[1];}}}}return"(?)";}};};var r=new m();var l=r.run(o);return(s)?r.guessFunctions(l):l;},destroy:function(){this.handles.forEach(function(l){ECM.unsubscribe(l);});}});})();ECM.provide("ECM.util.Misc");Ext.ns("ECM.util.Parser");ECM.util.Parser.decodeResponse=function(c,f,a){var j;var g;if(a===ECM.Rules.Constants.MSG_FORMAT.COMMA){j=", ";}else{if(a===ECM.Rules.Constants.MSG_FORMAT.LIST){g=new Ext.XTemplate("<ul class={cls}>",'<tpl for="msgs">',"<li>{.}</li>","</tpl>","<ul>");}else{j="<br />";}}var k={success:false,message:"",errors:[],data:{}};var h=function(l,m){if(Ext.isDefined(j)){return m.join(j);}else{if(Ext.isDefined(g)){return g.apply({cls:l,msgs:m});}}};var b="cm_error";var d=c.responseJSON;if(!Ext.isDefined(d)){k.message=gt.gettext("There was a system error. Please retry your request.");}else{if(Ext.isDefined(d.application_errors)&&d.application_errors.length>0){k.message=h(b,d.application_errors);}else{if(d.authentication_error){k.message='<p class="'+b+'">'+gt.gettext("An authentication error has occurred, please login to the system again.")+"</p>";}else{if(Ext.isDefined(d.error)&&d.error.length>0){k.errors=d.error;k.message='<p class="'+b+'">'+gt.gettext("An unknown error has occurred, please contact customer service team for assistance.")+"</p>";}else{if(Ext.isDefined(d.authorization_error)&&d.authorization_error.length>0){k.message=h(b,d.authorization_error);}else{if(Ext.isObject(d.data)){k.success=true;k.data=d.data;}else{k.message='<p class="'+b+'">'+gt.gettext("An unknown error has occurred,please contact customer service team for assistance.")+"</p>";}}}}}}return k;};ECM.util.getByteCount=function(d){var c,a=0;for(var b=0;b<d.length;b++){c=d.charCodeAt(b);if(c<=127){a+=1;}else{if(c<=2047){a+=2;}else{a+=3;}}}return a;};ECM.util.getMouseClickBtn=function(a){var b=a.browserEvent||a;if("which" in b){if(b.which===1){return"left";}else{if(b.which===2){return"middle";}else{if(b.which===3){return"right";}}}}else{if("button" in b){if(b.button&1){return"left";}else{if(b.button&2){return"right";}else{if(b.button&4){return"middle";}}}}}return"";};ECM.provide("ECM.Admin.Tags.Store");ECM.Admin.Tags.Store=Ext.extend(Ext.data.ArrayStore,{autoDestroy:true,autoSave:false,proxy:new Ext.data.HttpProxy({method:"GET",url:"/cm/r/tags/admin",api:{update:{url:"/cm/r/tag",method:"PUT"}},listeners:{beforewrite:function(b,c,a,d){d.batch=Ext.decode(d["data.data"]);if(!Ext.isArray(d.batch)){d.batch=[d.batch];}d.batch.forEach(function(f,g){delete f.affiliate_user_aff_user_name;delete f.date_created;delete f.used_in;f.also_objects=1;});d.batch=Ext.encode(d.batch);delete d["data.data"];},write:function(c,d,a){var b=ECM.Admin.Tags.Store.errorHandler;ECM.publish("/notify/info/clear",{selector:".error_display",message:gt.gettext("Tag List Saved")});}}}),writer:new Ext.data.JsonWriter({encode:true,writeAllFields:true}),constructor:function(a){a=a||{};a.records=a.records||{};var b=Ext.apply(a,{idIndex:0,root:"data.data",autoLoad:a.records.data?false:true,records:a.records,successProperty:"data.success",totalProperty:"data.rows",baseParams:{sort:"value",limit:ECM.Stash.rows_per_page||20},fields:[{name:"id",type:"number"},{name:"value",type:"string"},{name:"affiliate_user_aff_user_name",type:"string"},{name:"date_created",type:"string"},{name:"used_in",type:"string"}]});ECM.Admin.Tags.Store.superclass.constructor.call(this,b);(Ext.isObject(a.records.data))&&(Ext.isArray(a.records.data.data))&&(a.records.data.data.length)&&(this.loadData(a.records));},isUniqueTag:function(b){var a=true;this.each(function(c){if(c.get("value")==b){a=false;return false;}});return a;},getPageSize:function(){return this.baseParams.limit;},setPageSize:function(a){this.setBaseParam("limit",parseInt(a,10));}});ECM.provide("ECM.Admin.Tags.ColumnModel");ECM.Admin.Tags.ColumnModel=Ext.extend(Ext.grid.ColumnModel,{constructor:function(a){a=a||{};this.selModel=this.generateSelectionModel();this.defaults={width:100,sortable:true};a.columns=this.generateCols();ECM.Admin.Tags.ColumnModel.superclass.constructor.call(this,a);},generateSelectionModel:function(){var a=new Ext.grid.CheckboxSelectionModel();a.handleMouseDown=a.handleMouseDown.createSequence(function(){this.mouseHandled=false;});a.on("selectionchange",function(b){this.publish("/tags/selection/change",{selections:b});});return a;},generateCols:function(){var b=this,c=[],a=gt.gettext("Click to reorder");c.push(b.selModel);c.push({header:gt.gettext("Name"),dataIndex:"value",width:280,editor:{xtype:"textfield"},searchable:true});c.push({header:gt.gettext("Created By"),dataIndex:"affiliate_user_aff_user_name",editable:false});c.push({header:gt.gettext("Created Date"),dataIndex:"date_created",editable:false});c.push({header:gt.gettext("Usage"),dataIndex:"used_in",editable:false});return c;}});ECM.provide("ECM.Toolbar.PagingToolbar");ECM.Toolbar.PagingToolbar=Ext.extend(Ext.PagingToolbar,{cls:"ecm-paging-toolbar",initComponent:function(){ECM.Toolbar.PagingToolbar.superclass.initComponent.apply(this,arguments);this.refresh.hide();},bindStore:function(a,b){ECM.Toolbar.PagingToolbar.superclass.bindStore.apply(this,arguments);if(!Ext.isDefined(this.store.cachedBeforeLoad)){this.store.cachedBeforeLoad=true;this.store.fireEvent=this.store.fireEvent.createSequence(function(d,c,f){if(d.toLowerCase()!="beforeload"){return;}this.storeBeforeLoad(c,f);},this);}},storeBeforeLoad:function(a,b){var c=b.params||{};Ext.applyIf(c,a.baseParams);this.recordStart=c.start||0;this.pageSize=parseInt(c.limit||this.pageSize);this.sortedField=c.sort;this.sortedDirection=c.dir;this.dataFilter=c.filter;},getPageSize:function(){return this.pageSize;},getRecordStart:function(){return this.recordStart;},getSortedFieldName:function(){return this.sortedField;},getSortedDirection:function(){return this.sortedDirection;},getFilter:function(){return this.dataFilter;},getValue:function(){return this.getPageData().activePage;}});Ext.ns("ECM.Plugins.Grid");if(ECM&&ECM.provide){ECM.provide("ECM.Plugins.Grid.SearchColumn");}ECM.Plugins.Grid.SearchColumn=Ext.extend(Ext.util.Observable,{inputMinWidth:10,inputMaxWidth:200,searchString:' <input type="text" class="filter_input" id="{[this.assignIdToColumn(values.id)]}" ><img class="icon x-grid3-headerclearsearch" column="{id}" src="/images/clear_search.gif" /><img class="icon x-grid3-headersubmitsearch" column="{id}" src="'+Ext.BLANK_IMAGE_URL+'" />',init:function(b){this.grid=b;this.searchable={};this.columnIdToInputBox={};this.addEvents("headersubmitsearch");this.grid.getView().processEvent=this.grid.getView().processEvent.createInterceptor(this._interceptProcessEvent,this);this._bindKeys();this.grid.getView().templates={hcell:new Ext.XTemplate('<td class="x-grid3-hd x-grid3-cell x-grid3-td-{id} {css}" style="{style}','<tpl if="this.existsInGrid(id)">',"-moz-user-select:text; -webkit-user-select:text; user-select:text;","</tpl>",'">','<div {tooltip} {attr} class="x-grid3-hd-inner x-grid3-hd-{id}','<tpl if="this.existsInGrid(id) == false">',' " unselectable="on"',"</tpl>",'style="{istyle}">',this.grid.enableHdMenu?'<a class="x-grid3-hd-btn" href="#"></a>':"",'<span id="x-grid3-label-{id}">{value}</span><tpl if="this.existsInGrid(id)">',this.searchString,"</tpl>",' <img class="x-grid3-sort-icon" src="',Ext.BLANK_IMAGE_URL,'" />',"</div></td>",{isGridPanel:(function(c){return this.isSearchable(c)&&(this.grid.getXType()==="gridpanel");
}).createDelegate(this),existsInGrid:(function(c){return this.isSearchable(c);}).createDelegate(this),assignIdToColumn:(function(c){var d=Ext.id();this.columnIdToInputBox[c]=d;return d;}).createDelegate(this)})};var a;if(this.grid&&(a=this.grid.getColumnModel())){this.setSearchableFields(a.config);this.grid.on("columnresize",this._resizeColumns,this);this.grid.on("reconfigure",this._resizeColumns,this);}b.superclass().reconfigure=b.superclass().reconfigure.createInterceptor(function(c){this.setSearchableFields(c.columns);},this);this.grid.on("afterrender",this._resizeColumns,this);if(b.rendered){this.onRender();}else{b.on({scope:this,single:true,render:this.onRender});}},getValue:function(){var b={};var a={};Ext.iterate(this.columnIdToInputBox,function(c,f){b[c]=Ext.getDom(f).value;var d=this.eventDataFromId(c);if(!Ext.isEmpty(d.field)&&!Ext.isEmpty(d.value)){a[d.field]=d.value;}},this);return Ext.encode({columnIdToValue:b,filter:a});},setValue:function(a){Ext.iterate(a,function(b,c){Ext.getDom(this.columnIdToInputBox[b]).value=c;},this);},setFilter:function(b,a){this.grid.renderFilters(b,a);},addSearchToGridColumn:function(a){this.searchable[a.conf.id]=true;},setSearchableFields:function(a){this.searchable={};this.columnIdToInputBox={};var b=a.length;while(b--){if(a[b].searchable){this.addSearchToGridColumn({conf:a[b]});}}},_bindKeys:function(){var a=this;this.grid.getView().updateHeaders=this.grid.getView().updateHeaders.createSequence(function(b,d){for(var c in this.columnIdToInputBox){Ext.get(this.columnIdToInputBox[c]).addKeyListener({key:Ext.EventObject.ENTER},(function(){var f=c;return function(g,h){a.fireEvent("headersubmitsearch",a.eventDataFromId(f));h.stopPropagation();};})());}},this);},_interceptProcessEvent:function(b,c){if(c.target.tagName=="INPUT"){return false;}if(c.type=="click"&&c.target.tagName=="IMG"){if(c.target.getAttribute("column")&&this.isSearchable(c.target.getAttribute("column"))){var d=c.target.getAttribute("column");if(c.target.className&&(" "+c.target.className+" ").indexOf(" x-grid3-headerclearsearch ")!=-1){Ext.get(this.columnIdToInputBox[d]).dom.value="";this.fireEvent("headersubmitsearch",this.eventDataFromId(d));return false;}else{if(c.target.className&&(" "+c.target.className+" ").indexOf(" x-grid3-headersubmitsearch ")!=-1){this.fireEvent("headersubmitsearch",this.eventDataFromId(d));return false;}}}}},eventDataFromId:function(b){var a=this.grid.getColumnModel();return{field:a.getDataIndex(a.getIndexById(b)),value:Ext.getDom(this.columnIdToInputBox[b]).value};},isSearchable:function(b){return this.searchable[b]||false;},onRender:function(){this.grid.getView().updateHeaders();this.on({scope:this,headersubmitsearch:this.onHeaderSubmitSearch});},onHeaderSubmitSearch:function(a){var b={};Ext.iterate(this.columnIdToInputBox,function(d,g){var f=this.eventDataFromId(d);if(!Ext.isEmpty(f.value)){b[f.field]=f.value;}},this);var c=false;Ext.iterate(b,function(){c=true;return false;});this.grid.renderFilters(c?b:{name:""});if(this.grid.tbPager){this.grid.tbPager.changePage(1);}else{this.grid.store.reload();}},_resizeColumns:function(){var a=this.grid.getColumnModel();Ext.each(a.columns,function(d,c){if(d.searchable){var b=Ext.get(this.columnIdToInputBox[d.id]);if(Ext.isDefined(b)){var f=a.getColumnWidth(c);var h=Ext.get("x-grid3-label-"+d.id);var g=f-h.getWidth()-65;if(g<this.inputMinWidth){g=this.inputMinWidth;}else{if(g>this.inputMaxWidth){g=this.inputMaxWidth;}}b.setWidth(g);}}},this);}});Ext.preg("ecm.searchcolumn",ECM.Plugins.Grid.SearchColumn);ECM.provide("ECM.Plugins.Grid.Printer");ECM.Plugins.Grid.Printer={init:function(a){var b=this;if(!Ext.isObject(a)){throw new Ext.Error(gt.gettext("Grid is missing from arguments"));}b.grid=a;b.stylesheetPath="/css/ECM/Grid/Printer.css";b.headerTpl=new Ext.XTemplate("<tr>",'<tpl for=".">','<th width="{pwidth}">{header}</th>',"</tpl>","</tr>");b.bodyTpl=new Ext.XTemplate("<tr>",'<tpl for=".">',"<td>{{dataIndex}}</td>","</tpl>","</tr>");b.sltTpl=new Ext.XTemplate("<tr>",'<tpl for=".">','<td class="slt_no_border">{{dataIndex}}</td>',"</tpl>","</tr>");Ext.apply(a,{print:function(){b.totalWidth=0;var h=b.makePrintFriendly(),k=b.renderData(h),m=b.headerTpl.apply(h),f=b.bodyTpl.apply(h),n=b.sltTpl.apply(h);var d=new Ext.XTemplate('<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">',"<html>","<head>",'<meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />','<link href="'+b.stylesheetPath+'" rel="stylesheet" type="text/css" media="screen,print" />',"<title>"+document.title+"</title>","</head>","<body>","<table>",m,'<tpl for=".">',f,'<tpl for="slt">',n,"</tpl>","</tpl>","</table>","</body>","</html>").apply(k);var g=window.open("","printgrid","status=0");g.document.write(d);g.document.close();var l=100;var j=0;function c(){if(g.document.readyState==="complete"||j==5000){g.focus();g.print();g.close();}else{setTimeout(c,l);j+=l;}}c();}});},makePrintFriendly:function(){var d=[],b=this.grid.getColumnModel(),c=b.config,a=b.getTotalWidth();Ext.each(c,function(g){if(g.header.match(/expander|checker/)){if(Ext.isNumber(g.width)){a-=g.width;}}else{if(!(Ext.isDefined(g.hidden)&&g.hidden)){d.push(g);var f=d[d.length-1];f.pwidth=String(Math.floor(f.width/a*100))+"%";}}});this.totalWidth=a;return d;},renderData:function(b){var f=[];var a=this.getExpandRow();var d=0;var c=this;this.grid.store.data.each(function(j){var m=[];var h=0;for(var g in j.data){var k=Ext.isEmpty(j.data[g])?"":j.data[g];Ext.each(b,function(o){if(o.dataIndex==g){if(k==null){k=" ";}m[g]=o.renderer?o.renderer(k,{},j):k;if(a.indexOf(d)>-1){var n=(j.data.product_name)?"product_name":"name";if(g===n){var p=c.renderExpandName(j.data);m[n]=m[n]+p.html;h=p.slt;}}}});}m.slt=[];if(h){var l=c.renderExpandSLT(j.data,b,j.fields);if(!Ext.isEmpty(l)){m.slt=l;}}d++;f.push(m);});return f;},getExpandRow:function(){var b=[];var c=/^[a-zA-Z0-9]+-[a-zA-Z0-9]+-[a-zA-Z0-9]+-[a-zA-Z0-9]+$/;var a=/^\d+-\d+$/;Ext.each(Ext.query(".x-grid3-body .x-grid3-row"),function(f,d){if(c.test(f.id)||a.test(f.id)){return true;}if(f.className.match(/x-grid3-row-expanded/)){b.push(d);}});return b;},renderExpandName:function(b){var a={html:"",slt:0};if(!Ext.isEmpty(b.slt)){a.slt=1;}else{if(Ext.isDefined(b.subject)){a.html="<br/><b>Subject line: </b>"+(b.subject!=null?b.subject:"");}else{if(Ext.isDefined(b.product_subject)){a.html="<br/><b>Subject line: </b>"+(b.product_subject!=null?b.product_subject:"");}}}return a;},renderExpandSLT:function(c,b,a){var d=[];Ext.each(c.slt,function(g){var h=[];var f={name:"subject",list_num_sent:"list_num_sent",date_sent:"date_sent"};Ext.each(b,function(k){if(k.dataIndex=="name"||k.dataIndex=="list_num_sent"||k.dataIndex=="date_sent"){var j=f[k.dataIndex];var l=-1;l=a.findIndex("name",j);if(l>-1&&!Ext.isEmpty(g[l])){h[k.dataIndex]=g[l];}}});d.push(h);});return d;}};Ext.preg("ecm.gridprinter",ECM.Plugins.Grid.Printer);ECM.provide("ECM.Admin.Tags.Grid");ECM.Admin.Tags.Grid=Ext.extend(Ext.grid.EditorGridPanel,{PAGE_SIZE_DEFAULT:20,clicksToEdit:1,enableHdMenu:false,autoHeight:true,plugins:["ecm.searchcolumn","ecm.gridprinter"],constructor:function(b){this.appliedFilters={};this.buildToolbars(b.store,b.actionButtons);var a=new ECM.Admin.Tags.ColumnModel();b=Ext.apply({tbar:this.tbPager,bbar:this.tbBottom,colModel:a,selModel:a.selModel,viewConfig:{emptyText:gt.gettext("No tags available"),forceFit:true,scrollOffset:0},stripeRows:true,cls:"cm_list_grid gridPanelTableLayout",loadMask:{msg:gt.gettext("Loading tags...")}},b);this.addEvents("beforefilter","filtered");ECM.Admin.Tags.Grid.superclass.constructor.call(this,b);if(b.forceContainerHeight){this.getStore().on("load",this.setContainerHeight.createDelegate(this));}this.store.on("beforeload",this.applyFilter,this);this.store.on("exception",this._captureStoreErrors,this);this.store.on("load",this.clearStoreErrors,this);this.store.on("load",this._allowGridTextSelection,this);},getSelectedId:function(){var a=[];if(this.getSelectionModel().getCount()>0){this.getSelectionModel().each(function(b){a.push(b.get("id"));
},this);}return a;},writeSelected:function(k,g,l){var b=this,f=[],h=k==="copy"?"batch":"id",d={},j=ECM.Admin.Tags.Store.errorHandler,c="",a;l=l||{};g.forEach(function(m,n){if(k==="copy"){c="?action=copy";a="POST";m.data.also_objects=1;m.data.value_copy=m.data.value+"1";while(!b.store.isUniqueTag(m.data.value_copy)){m.data.value_copy+="1";}f.push(m.data);}else{if(k==="delete"){a="DELETE";f.push(m.data.id);}}});d[h]=Ext.encode(f);ECM.Ajax.request({url:"/cm/r/tag"+c,method:a,params:d,success:function(n,m){b.refresh();if(l.el&&Ext.isFunction(l.el.unmask)){l.el.unmask();l[l.closeAction?l.closeAction:"hide"]();}window.setTimeout(function(){ECM.publish("/notify/info",{selector:".error_display",message:gt.gettext(k.replace(/^\w/,function(o){return o.toUpperCase();})+" was successful")});},1500);},failure:function(n,m){if(Ext.isObject(l)&&l instanceof ECM.Window){l.notify.error(gt.gettext("Write failure on save"));}if(l.el&&Ext.isFunction(l.el.unmask)){l.el.unmask();}}});},deleteSelected:function(a,b){this.writeSelected("delete",a,b);},copySelected:function(a){this.writeSelected("copy",a);},addElementsToPager:function(a){Ext.each(a,function(c,b){this.tbPager.add(c);},this);},clearStoreErrors:function(){ECM.publish("/notify/clear/all",{selector:".error_display"});},_captureStoreErrors:function(j,f,g,d,a){var h={selector:".error_display",width:450},c="/notify/error/clear",b=a.responseJSON?a.responseJSON:Ext.decode(a.responseText);if(f==="response"){if(b&&b.error){Ext.apply(h,{message:b.error[0]});}else{if(a.status!==200){Ext.apply(h,{message:gt.gettext("Unable to communicate with the server. Please try again later.")});}}}else{if(f==="remote"){if(b&&b.error.length>0){Ext.apply(h,{message:b.error[0]});}}}ECM.publish(c,h);},reconfigure:function(a,b){ECM.publish("/notify/clear/all",{selector:".error_display"});this.store.un("exception",this._captureStoreErrors,this);this.store.un("load",this.clearStoreErrors,this);this.store.un("load",this._allowGridTextSelection,this);ECM.Admin.Tags.Grid.superclass.reconfigure.apply(this,arguments);this.store.on("exception",this._captureStoreErrors,this);this.store.on("load",this.clearStoreErrors,this);this.store.on("load",this._allowGridTextSelection,this);this.tbPager.bindStore(a);},refresh:function(){this.store.reload();},setContainerHeight:function(){this.ownerCt.setHeight(this.getHeight()+20);},setPageSize:function(a,b){b.pageSize=parseInt(a,10);this.store.setPageSize(a);b.changePage(1);},buildToolbars:function(a,b){this.tbPager=this.buildPagerToolbar(a,b);this.cbxRowControl=this.buildRowControlCombo(a,this.tbPager);this.cbxRowControl.on("select",function(d,c){this.setPageSize(c.get("limit"),this.tbPager);},this);this.tbBottom=this.buildBottomToolbar();},buildPagerToolbar:function(a,b){return new ECM.Toolbar.PagingToolbar({store:a,pageSize:a.getPageSize()?a.getPageSize():this.PAGE_SIZE_DEFAULT,items:b});},getPagingToolbar:function(){return this.tbPager;},buildBottomToolbar:function(){return new Ext.Toolbar({items:["->","-",gt.gettext("Rows per page:"),this.cbxRowControl]});},buildRowControlCombo:function(b,a){return new Ext.form.ComboBox({store:new Ext.data.ArrayStore({fields:["limit"],data:[[20],[50],[100],[250]]}),mode:"local",displayField:"limit",valueField:"limit",triggerAction:"all",value:(b.getPageSize())?b.getPageSize():this.PAGE_SIZE_DEFAULT,width:50,minListWidth:50,editable:false});},renderFilters:function(a){if(!Ext.isDefined(a)||!this.filterGrid){return;}this.filterGrid(a.name||a.value,false,"quicksearch");},filterGrid:function(f,a,d,c){c=c||this.store;if(!d){d="base";}this.fireEvent("beforefilter",this,f);a=(Ext.isEmpty(a))?true:a;if(Ext.isString(f)){f=["value","matches",String.escape(f)];}else{if(f=="showSelected"){if(this.getSelectionModel().getCount()>0){var b=[];this.getSelectionModel().each(function(g){b.push(g.get("id"));});f=["id","=",b];}}}this.appliedFilters[d]=Ext.decode(Ext.encode(f));if(a){c.on("load",function(h,g,j){if(h.getTotalCount()!==0){this.fireEvent("filtered",this,h,f);}else{if(!Ext.isEmpty(h.reader.jsonData.error)){this.getView().emptyText=h.reader.jsonData.error;}else{this.getView().emptyText=gt.gettext("No tags available");}}},this);this.tbPager.changePage(1);}return f;},listeners:{afterrender:function(){(this.view.columnDrag)&&(this.view.columnDrag.DDM.lock());}},applyFilter:function(a,b){var c=this.getFilter();if(b.params){if(Ext.isEmpty(c)){delete b.params.filter;}else{b.params.filter=Ext.encode(["and"].concat(c));}}},getFilter:function(){var a=[];Ext.iterate(this.appliedFilters,function(b,c){if(!Ext.isEmpty(c)){a.push(c);}});return a;},_allowGridTextSelection:function(){var a=Ext.DomQuery.select("div[unselectable=on]",this.getGridEl().dom);Ext.each(a,function(b){b.attributes.unselectable.value="off";Ext.fly(b).removeClass("x-unselectable");});}});ECM.provide("ECM.Notify");(function(){function d(j){if(j.autoTimeOut&&j.clearTimer){window.clearTimeout(j.clearTimer);}if(j.toolTip){j.toolTip.destroy();}j.container.dom.style.visibility="hidden";if(j.container.dom.childNodes[0]){if(Ext.isDefined(j.align)&&j.align==="right"){j.container.dom.childNodes[0].childNodes[0].innerHTML="";}else{j.container.dom.childNodes[0].childNodes[1].innerHTML="";}var k=j.container.dom.parentNode.parentNode.parentNode;if(k.className=="x-table-layout notify-layout"){k.className="x-table-layout";}}}function c(o,j,n){var m=document.createElement("div");var p=document.createElement("div");p.className="notify-tip-wrapper "+j;var l=document.createElement("div");l.className="notify-icon";p.appendChild(l);var k=document.createElement("div");k.className="notify-text";k.innerHTML=o;p.appendChild(k);m.appendChild(p);n.toolTip=new Ext.ToolTip({target:n.id,cls:"notify-tip",html:m.innerHTML});}function h(j,k){k.container.dom.className="ecm-notification-area "+j;var l=k.container.dom.parentNode.parentNode.parentNode;if(l.className=="x-table-layout"){l.className="x-table-layout notify-layout";}}function g(k,j){if(Ext.isDefined(j.align)&&j.align==="right"){j.container.dom.childNodes[0].childNodes[0].innerHTML=k;}else{j.container.dom.childNodes[0].childNodes[1].innerHTML=k;}}function b(j){if(j.container.dom.style.visibility!="visible"){j.container.fadeIn();}}function a(p,k,l){if(l.fireEvent("beforeupdate",l,p,k)===false){return false;}d(l);var n;var j=l.container.findParent(".x-table-layout-ct").offsetWidth;l.container.dom.style.width=j+"px";var m={};if(l.truncateMsg){var o=(l.maxWidth>0&&l.maxWidth<j)?l.maxWidth:j;m=ECM.DomHelper.ellipsis({width:(o-20),text:p,cls:"ecm-notify-ellispis"});}window.setTimeout(function(){if(l.truncateMsg&&m.truncated){c(p,k,l);p=m.text;}h(k,l);g(p,l);b(l);l.fireEvent("updated",l,p,k);},l.showDelay);if(l.autoTimeOut){l.clearTimer=window.setTimeout(function(){d(l);l.fireEvent("timeout",l);},l.clearDelay);}}function f(k,j){var m=document.createElement("div");var l=k;if(Ext.isDefined(j.align)&&j.align==="right"){l=l+" "+k+"-right";}if(!j.truncateMsg){l=l+" "+k+"-no_ellipsis";}m.className=l;j.container.dom.childNodes[0].appendChild(m);}ECM.Notify=function(j){j=j||{};ECM.Notify.superclass.constructor.call(this,j);};ECM.Adapter.extend(ECM.Notify,Ext.BoxComponent,{border:false,clearDelay:60000,maxWidth:300,showDelay:200,ellipsisOffset:20,truncateMsg:true,autoTimeOut:true,constructor:function(j){ECM.Notify.superclass.constructor.call(this,j);this.addEvents("beforeupdate","updated","cleared","timeout");},afterRender:function(){if(Ext.isDefined(this.align)&&this.align==="right"){f("notify-text",this);f("notify-icon",this);}else{f("notify-icon",this);f("notify-text",this);}},clear:function(){d(this);this.fireEvent("cleared",this);},error:function(j){if(j){a(j,"notify-error",this);}},info:function(j){if(j){a(j,"notify-info",this);}},warn:function(j){if(j){a(j,"notify-warn",this);}}});ECM.Adapter.register("ECM.Notify",ECM.Notify);})();ECM.provide("ECM.Flare");ECM.Flare={flare_csh_map:(ECM&&ECM.Stash)?ECM.Stash.flare_csh_map:{},help_flare_csh:(ECM&&ECM.Stash)?ECM.Stash.HELP_FLARE_CSH:"",target:"_MCWebHelpCSH",lookupAnchor:function(a){return this.flare_csh_map[a]||0;
},makeUrl:function(a){var b=this.lookupAnchor(a);return this.help_flare_csh+"?id="+b+"#"+b;},makeLink:function(a){return["<a ",'target="',this.target,'" ','href="',this.makeUrl(a),'" ','onclick="',"window.open(","this.href, ","this.target, ","'width=680, height=600'",").focus(); ","return false;",'"',">",gt.gettext("Help"),"</a>"].join("");},updateLink:function(a){var b=Ext.getDom("flare_help_link");if(b&&b.href&&this.lookupAnchor(a)){b.href=this.makeUrl(a);}},delayedUpdateLink:function(a,b){var c=this;setTimeout(function(){c.updateLink(a);},b);},onFocus:function(a){this.delayedUpdateLink(a,600);},onBlur:function(a){this.delayedUpdateLink(a,300);}};ECM.provide("ECM.Mailing.MailingList.FilterControlBase");ECM.Mailing.MailingList.FilterControlBase=Ext.extend(Ext.util.Observable,{textInputLimit:100,reloadFilter:function(a){var b=this;b.clearFilter();var c=a||b.getData(b.pageType)||{};b.filterByObject={};b.radioGroup.setValue(c.checkedRadio);Ext.each(c.option,function(d){b.createNewOption(d.target,d.text);});b.createNewOption();if(b.filterContainer.items.getCount()===1&&b.defaultFilterValue!==undefined){b.filterContainer.items.first().items.first().setValue(b.defaultFilterValue||"");}b.radioGroup.fireEvent("change",b.radioGroup,{itemId:c.checkedRadio});},runFilter:function(){var c=this.makeFilterObj(this),a="";delete c.selectedId;if(!this.validateFilter()){this.notify.error("Please enter a valid filter");return;}this.hide();this.fireEvent("beforefilter",c);if(c.checkedRadio==="filterRadio"&&Ext.isEmpty(c.option)){return;}else{if(c.checkedRadio==="selectedRadio"){if(Ext.isEmpty(c.selectedId)){a=gt.gettext("No item selected.");}}}var b=this.makeFilterKey(c);if(Ext.isEmpty(a)){this.setData(this.pageType,c);}this.fireEvent("filter",b,c,a);},getFilterKey:function(){return this.makeFilterKey(this.getData(this.pageType));},createPanel:function(){var a=this;a.addEvents("beforefilter","filter");a.radioGroup=new Ext.form.RadioGroup({cls:"filter_radio_group",columns:1,onSetValue:function(c,b){this.eachItem(function(d){d.setValue(d.itemId===c);});},listeners:{scope:this,change:function(d,b){var c=this;if(c.notify.rendered){c.notify.clear();}c.filterContainer.cascade(function(){if(this.id!=c.filterContainer.id){this.setDisabled((b.itemId!="filterRadio"));}});},afterrender:function(b){b.fireEvent("change",b,b.getValue());}},items:[{boxLabel:"Show All",name:"filter_radio",itemId:"allRadio"},{boxLabel:"Show Selected",name:"filter_radio",itemId:"selectedRadio"},{boxLabel:"Filter By",name:"filter_radio",checked:true,itemId:"filterRadio"}]});a.filterContainer=new Ext.Container({cls:"filter_container"});a.filterByObject={};a.listeners={afterrender:function(){a.reloadFilter();}};a.filterButton=new Ext.Button({id:"btnFilter",text:gt.gettext("Filter"),cls:"blue_button",disabled:true,handler:a.runFilter.createDelegate(a)});a.notify=new ECM.Notify();a.items=[{xtype:"panel",title:gt.gettext("Filter"),cls:"filter_inner_container",items:[{layout:"table",xtype:"container",cls:"ecm-notification-table-ct",height:Ext.isIE?30:20,items:[a.notify]},new Ext.form.Label({text:gt.gettext("View:")}),a.radioGroup,a.filterContainer],buttons:[a.filterButton,{text:gt.gettext("Cancel"),cls:"blue_button",handler:function(){a.notify.clear();a.hide();a.reloadFilter();}}]}];},clearFilter:function(){this.filterContainer.removeAll();this.filterByObject={};},createNewOption:function(b,h){var f=this,g="";var d=new Ext.form.ComboBox({ctCls:"filter_combo",store:f.filterByStore,mode:"local",allowBlank:false,valueField:"target",displayField:"display",triggerAction:"all",width:200,listeners:{valid:function(m){var j=this.findParentByType("container");a=this.nextSibling();var k=a.nextSibling();var l=m.getValue().split(" ").join("_");if(l!==g){if(Ext.isDefined(a.clearValue)){a.clearValue();}else{a.reset();}}if(l=="Sent_Date"&&l!==g){j.remove(a,true);a=f.getInputControl(k,"date");if(!Ext.isDefined(b)&&!Ext.isDefined(h)&&!j.nextSibling()){a.on("valid",function(){if(!j.nextSibling()){f.createNewOption();k.show();}},this);}j.insert(1,a);j.doLayout();}else{if(l!==g){j.remove(a,true);a=f.getInputControl(k);if(!Ext.isDefined(b)&&!Ext.isDefined(h)&&!j.nextSibling()){a.on("valid",function(){if(!j.nextSibling()){f.createNewOption();k.show();}},this);}j.insert(1,a);j.doLayout();if(f.optionStorePair.hasOwnProperty(l)){a.setHideTrigger(false);a.bindStore(f.optionStorePair[l]);}else{a.setHideTrigger(true);a.bindStore([]);}}}if(Ext.isIE10&&a.hideTrigger){a.el.setStyle("width",(a.el.parent().getWidth()-8)+"px");}f.filterByObject[k.id][1]=a;g=l;},expand:function(j){j.store.realData=j.store.data;f.filterUniqueSelection(j);},collapse:function(j){j.store.data=j.store.realData;j.store.snapshot=j.store.readData;},select:function(){f.notify.clear();},blur:function(j){if(!j.getRawValue()){j.clearInvalid();}}},getListParent:function(){return f.el;},editable:false});var c=new Ext.Button({cls:"filter_button",iconCls:"filter_delete_button",hidden:false,listeners:{click:function(j,k){f.notify.clear();delete f.filterByObject[j.id];j.ownerCt.destroy();if(f.filterContainer.items.items.length==0){f.createNewOption();}}}});var a=this.getInputControl(c);a.onTriggerClick=a.onTriggerClick.createInterceptor(function(){return !this.hideTrigger;});f.filterByObject[c.id]=[d,a];f.filterContainer.add({xtype:"container",layout:"toolbar",items:[d,a,c]});if(Ext.isDefined(b)){d.setEditable(true);d.setValue(b);d.setEditable(false);}if(Ext.isDefined(h)){a.setValue(h);}if(!Ext.isDefined(b)&&!Ext.isDefined(h)){a.on("valid",function(){f.createNewOption();c.show();},this,{single:true});if((a.getEl()!==undefined)&&Ext.isIE10&&a.hideTrigger){a.el.setStyle("width",(a.el.parent().getWidth()-8)+"px");}}else{c.setVisible(true);}},getInputControl:function(b,d){var c=this,a;if(d=="date"){a=new Ext.form.DateField({allowBlank:false,ctCls:"filter_combo",menu:new Ext.menu.DateMenu({allowOtherMenus:true,hideOnClick:true,focusOnSelect:false}),onTriggerClick:function(f){if(this.menu.isVisible()){this.menu.hide();}else{this.constructor.prototype.onTriggerClick.apply(this,arguments);}},width:200,getListParent:function(){return c.el;}});}else{a=new Ext.form.ComboBox({ctCls:"filter_combo",mode:"local",listeners:{render:function(f){f.bindStore([[]]);},expand:function(f){if(f.hideTrigger){f.collapse();}},select:function(){c.notify.clear();},keyup:function(f){if(f.getRawValue()){c.notify.clear();}}},displayField:"name",triggerAction:"all",width:200,hideTrigger:true,getListParent:function(){return c.el;},validator:function(f){if(!Ext.isEmpty(f)&&this.hideTrigger&&f.length>c.textInputLimit){return gt.strargs(gt.gettext("Text input limit is %1 characters."),c.textInputLimit);}return !this.previousSibling().getRawValue()||!Ext.isEmpty(f)&&(this.hideTrigger||Ext.isObject(this.findRecord(this.displayField,f)));}});}return a;},filterUniqueSelection:function(d){var c=this,b=[],a=d.getValue();Ext.iterate(c.filterByObject,function(g,h){var f=h[0].getValue();if((c.uniqueOpt.indexOf(f)>-1)&&(f!=a)){b.push(f);}});d.store.filterBy(function(f,g){return(b.indexOf(f.get("target"))===-1);});d.store.snapshot=d.store.data;},validateFilter:function(){var d=true;var b=this.radioGroup.getValue();if(b.itemId==="filterRadio"){var a;var c=0;Ext.iterate(this.filterByObject,function(f,g){a=g;c++;if(!Ext.isEmpty(g[0].getValue())&&(!g[0].isValid()||!g[1].isValid())){d=false;}});if(c===1&&!Ext.isEmpty(a)){d=a[0].isValid()&&a[1].isValid();}}return d;},makeFilterObj:function(b){var a=b.radioGroup.getValue(),d={},c=[];d.checkedRadio=a.itemId;if(a.itemId==="filterRadio"){Ext.iterate(b.filterByObject,function(f,g){if(g[0].isValid()&&g[1].isValid()){var h={target:g[0].getValue(),text:g[1].getValue()};if(!h.text){return;}if(h.target!="Text Search"&&h.target!="Mailing"&&h.target!="Sent Date"){h.query=g[1].findRecord(g[1].displayField,h.text).get("id");}c.push(h);}});}d.option=c;return d;},makeFilterKey:function(c){var d=this;var a=[],b=["cor"];if(Ext.isEmpty(c)||c.checkedRadio==="allRadio"){}else{if(c.checkedRadio==="selectedRadio"){a=["id","=",c.selectedId];
}else{if(Ext.isEmpty(c.option)){a="";}else{switch(d.pageType){case"standard":Ext.each(c.option,function(f){if(f.target==="Mailing Folder"){a.push(["fid","=",f.query]);}else{if(f.target==="Tag"){b.push(["tag","tag_id","=",f.query]);}else{a.push(["or",["name","matches",String.escape(f.text)],["list","name","matches",String.escape(f.text)]]);}}});break;case"standard_template":Ext.each(c.option,function(f){if(f.target==="Mailing Folder"){a.push(["fid","=",f.query]);}else{a.push(["or",["name","matches",String.escape(f.text)],["affiliate_user","aff_user_name","matches",String.escape(f.text)]]);}});break;case"triggered":Ext.each(c.option,function(f){if(f.target==="Event"){a.push(["event","event_id","=",f.query]);}else{if(f.target==="Tag"){b.push(["tag","tag_id","=",f.query]);}else{a.push(["or",["name","matches",String.escape(f.text)],["event","name","matches",String.escape(f.text)],["event","event_id","matches",String.escape(f.text)],["event","event_desc","matches",String.escape(f.text)]]);}}});break;case"triggered_template":Ext.each(c.option,function(f){a.push(["or",["name","matches",String.escape(f.text)],["affiliate_user","aff_user_name","matches",String.escape(f.text)]]);});break;case"library_link":Ext.each(c.option,function(f){if(f.target==="Tag"){a.push(["type","matches",f.query]);}else{a.push(["or",["name","matches",String.escape(f.text)],["url","matches",String.escape(f.text)],["affiliate_user","aff_user_name","matches",String.escape(f.text)]]);}});break;case"library_content":case"library_image":case"library_dynamic_content":Ext.each(c.option,function(f){if(f.target==="Tag"){a.push(["tag_object","tag_id","=",f.query]);}else{a.push(["name","matches",String.escape(f.text)]);}});break;case"segment":Ext.each(c.option,function(f){if(f.target==="Segment Folder"){a.push(["fid","=",f.query]);}else{if(f.target==="Tag"){a.push(["tag_object","tag_id","=",f.query]);}else{if(f.target==="Subscription List"||f.target==="Field Used In Segment"){a.push(["json","matches",f.query]);}else{if(f.target==="Mailing"){a.push(["product","name","matches",String.escape(f.text)]);}else{a.push(["name","matches",String.escape(f.text)]);}}}}});break;case"admin_tag":Ext.each(c.option,function(f){if(f.target==="Tag"){a.push(["id","=",f.query]);}else{a.push(["value","matches",String.escape(f.text)]);}});break;}if(b.length>1){a.push(b);}if(a.length>1){a.unshift("and");}else{a=a[0];}}}}return a;},getData:function(a){return ECM.Mailing.MailingList.FilterDataModel.readCookie(a);},setData:function(a,b){ECM.Mailing.MailingList.FilterDataModel.writeCookie(a,b);}});ECM.provide("ECM.Mailing.MailingList.FilterDataModel");ECM.Mailing.MailingList.FilterDataModel=(function(){var a=null;function b(){Ext.apply(this,new Ext.util.Observable());this.addEvents("change");this.clearFilterData=function(){Ext.util.Cookies.clear("filterData");this.createDefaultCookie();};this.createDefaultCookie=function(){var d={};d.aff=ECM.Stash.aid;d.standard={option:[{target:"Mailing Folder",text:"Default",query:0}],checkedRadio:"filterRadio"};d.triggered={option:[],checkedRadio:"filterRadio"};d.standard_template={option:[{target:"Mailing Folder",text:"Default",query:0}],checkedRadio:"filterRadio"};d.triggered_template={option:[],checkedRadio:"filterRadio"};d.library_link=d.library_content=d.library_dynamic_content=d.library_image=d.admin_tag={option:[],checkedRadio:"allRadio"};d.segment={option:[{target:"Segment Folder",text:"Default",query:0}],checkedRadio:"filterRadio"};var c=Ext.encode(d);Ext.util.Cookies.set("filterData",c,new Date().add(Date.HOUR,10));return d;};this.writeCookie=function(g,f){this.pageType=g;var c=Ext.util.Cookies.get("filterData");var d=Ext.decode(c);d[g]=f;c=Ext.encode(d);Ext.util.Cookies.clear("filterData");Ext.util.Cookies.set("filterData",c);this.fireEvent("change",g,d[g]);};this.readCookie=function(f){if(Ext.isDefined(f)){this.pageType=f;var c=Ext.util.Cookies.get("filterData"),d=Ext.decode(c);if(c==null||((d)&&d.aff!=ECM.Stash.aid)){d=this.createDefaultCookie();}return d[f];}else{throw new Ext.Error("readCookie method must pass pageType");}};this.getValue=function(c){return Ext.encode(this.readCookie(c||this.pageType));};this.setValue=function(d,c){this.writeCookie(c||this.pageType,d);};}return new b();})();ECM.provide("ECM.Deferred");ECM.Deferred=function(a){this.chain=[];this.id=this._nextId();this.fired=-1;this.paused=0;this.results=[null,null];this.canceller=a;this.silentlyCancelled=false;this.isFiring=false;};ECM.Adapter.override(ECM.Deferred,{_check:function(){if(this.fired!==-1){if(!this.silentlyCancelled){throw new Error("already called!");}this.silentlyCancelled=false;return;}},_fire:function(){this.isFiring=true;var d=this.chain;var k=this.fired;var c=this.results[k];var b=this;var a=null;while((d.length>0)&&(this.paused===0)){var j=d.shift()[k];if(!j){continue;}var h=function(){var f=j(c);(typeof f!=="undefined")&&(c=f);k=((c instanceof Error)?1:0);if(c instanceof ECM.Deferred){a=function(l){b._resback(l);b.paused--;((b.paused===0)&&(b.fired>=0))&&(b._fire());};this.paused++;}};try{h.call(this);}catch(g){k=1;c=g;}}this.fired=k;this.results[k]=c;this.isFiring=false;((a)&&(this.paused))&&(c.addBoth(a));},_nextId:(function(){var a=1;return function(){return a++;};})(),_resback:function(a){this.fired=((a instanceof Error)?1:0);this.results[this.fired]=a;this._fire();},cancel:function(){var b;if(this.fired===-1){(this.canceller)?(b=this.canceller(this)):(this.silentlyCancelled=true);if(this.fired===-1){if(!(b instanceof Error)){var a=b;var c="Deferred Cancelled";(b&&b.toString)&&(c+=": "+b.toString());b=new Error(c);b.ecmType="cancel";b.cancelResult=a;}this.errback(b);}}else{if((this.fired===0)&&(this.results[0] instanceof ECM.Deferred)){this.results[0].cancel();}}},callback:function(a){this._check();this._resback(a);},errback:function(a){this._check();this._resback(a);},addBoth:function(a,b){var c=ECM.hitch.apply(ECM,arguments);return this.addCallbacks(c,c);},addCallback:function(a,b){return this.addCallbacks(ECM.hitch.apply(ECM,arguments));},addErrback:function(a,b){return this.addCallbacks(null,ECM.hitch.apply(ECM,arguments));},addCallbacks:function(a,b){this.chain.push([a,b]);(this.fired>=0&&!this.isFiring)&&(this._fire());return this;}});if(!ECM.Adapter.namespace("ECM.DomHelper")._bogus){ECM.provide("ECM.DomHelper");(function(){var a=null;Ext.lib.Dom.getViewportWidth=function(){return Ext.isIE?(document.body?document.body.clientWidth:document.documentElement.clientWidth):self.innerWidth;};Ext.lib.Region.getRegion=function(g){if(g){var j=Ext.lib.Dom.getXY(g),f=j[1],h=j[0]+g.offsetWidth,c=j[1]+g.offsetHeight,d=j[0];return new Ext.lib.Region(f,h,c,d);}};ECM.Adapter.override(Ext.Element,{setWidth:function(c,b){var d=this;c=d.adjustWidth(c);if(Ext.isFunction(c)){return d;}!b||!d.anim?d.dom.style.width=d.addUnits(c):d.anim({width:{to:c}},d.preanim(arguments,1));return d;}});ECM.DomHelper=ECM.Adapter.apply({destroyEl:function(d,b){d=ECM.Adapter.getEl(d);b=b||{};try{(!a||a.ownerDocument!==d.ownerDocument)&&(a=d.ownerDocument.createElement("div"));if(!b.detachOnly&&window.Ext){(Ext.enableNestedListenerRemoval)?Ext.EventManager.purgeElement(d,true):Ext.EventManager.removeAll(d);delete Ext.elCache[d.id];}a.appendChild((d.parentNode)?d.parentNode.removeChild(d):d);a.innerHTML="";}catch(c){}},ellipsis:function(c){c=c||{};c.text=c.text||"";var b={text:c.text,truncated:false};var d=document.createElement("span");d.style.whiteSpace="nowrap";d.style.visibility="hidden";d.innerHTML=c.text;if(c.cls){d.className=c.cls;}if(c.element){Ext.get(c.element).appendChild(d);}else{document.body.appendChild(d);}if(c.text&&d.offsetWidth>c.width){var g=c.text.length;while(d.offsetWidth>c.width&&c.width>0){var f=g;g=parseInt((g+(g/2))/2);d.innerHTML=c.text.substr(0,g)+"...";if(d.offsetWidth<c.width){g=parseInt((f+g)/2);d.innerHTML=c.text.substr(0,g)+"...";}}b.text=d.innerHTML;b.truncated=true;}document.body.removeChild(d);d=null;return b;},emptyEl:function(c,b){while(c.firstChild){ECM.DomHelper.destroyEl(c.firstChild,b);
}},firstTextEl:function(b){while(b.nodeType!==window.Node.TEXT_NODE){b=b.firstChild;}return b;},getEl:ECM.Adapter.getEl,getScrollBarWidth:function(){var d=document.createElement("p");d.style.width="100%";d.style.height="200px";var f=document.createElement("div");f.style.position="absolute";f.style.top="0px";f.style.left="0px";f.style.visibility="hidden";f.style.width="200px";f.style.height="150px";f.style.overflow="hidden";f.appendChild(d);document.body.appendChild(f);var c=d.offsetWidth;f.style.overflow="scroll";var b=d.offsetWidth;if(c==b){b=f.clientWidth;}document.body.removeChild(f);return(c-b);},_bogus:true});ECM.Adapter.onUnload(function(){a=null;});})();}ECM.provide("ECM.Ajax");(function(){var a=Ext.lib.Ajax.request;Ext.lib.Ajax.request=function(h,f,b,g,d){if(h==="GET"&&f.length>2000){h="POST";var c=f.split("?");f=c[0];g=c[1]+"&method=GET";d.headers["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8";}if(h==="PUT"||h==="DELETE"){g+="&method="+h;h="POST";d.headers["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8";}a.call(this,h,f,b,g,d);};})();(function(){ECM.Ajax=ECM.Adapter.applyIf({timeout:90000},Ext.Ajax);ECM.Ajax.requestHandler=ECM.Ajax.request;ECM.Ajax.errorInterception=function(){if(!ECM.Ajax.eventsSuspended){if(arguments[1].isTimeout){arguments[1]=new Error("Server Timeout Error");ECM.publish("/notify/error","Server Timeout Error");}if(!(arguments[1] instanceof Error)&&typeof(arguments[1])!="string"){arguments[1]=new Error("An unknown server error has occurred");ECM.publish("/notify/error","An unknown server error has occurred.");}}this.errback.apply(this,arguments);};var b=ECM.Adapter.isEffective,d="/notify/error/{0}/ajax",h=String.format(d,"fatal"),g=String.format(d,"application"),f=String.format(d,"authorization"),a=String.format(d,"authentication"),c="/notify/alert/success/ajax";Ext.apply(ECM.Ajax,{request:function(j){var j=j||{};j.deferred=new ECM.Deferred();j.disableCaching=b(j.disableCaching)?j.disableCaching:true;j.headers=j.headers||{};j.method=(j.method||"GET").toUpperCase();(j.sessionVerify)&&(j.headers["X-Session-Verify"]=j.sessionVerify);var k={failure:j.failure||function(){},success:j.success||function(){}};var l=this;if((j.handleAs||"json")==="json"){if(j.method!=="POST"){j.headers["Content-Type"]="application/json";}j.deferred.addCallbacks(function(n,q){var o;try{n.responseJSON=o=ECM.Adapter.decode(n.responseText||"");}catch(p){k.failure.apply(l,arguments||[]);}var m=function(s){return b(s)&&ECM.Adapter.isArray(s)&&s.length>0;};var r=[];if(m(o.application_errors)){r.push({event:g,messages:o.application_errors});}if(m(o.authorization_errors)){r.push({event:f,messages:o.authorization_errors});}if(m(o.error)){r.push({event:h,messages:o.error});}if(b(o.authentication_error)&&parseInt(o.authentication_error,10)>0){r.push({event:a,messages:[]});}if(r.length>0){if(!ECM.Ajax.eventsSuspended){Ext.each(r,function(s){ECM.publish(s.event,s.messages,n,q);});}k.failure.call(l,n,q);}else{if(!ECM.Ajax.eventsSuspended){ECM.publish(c);}k.success.call(l,n,q);}return n;},ECM.hitch(l,k.failure));}else{j.deferred.addCallbacks(function(m,n){k.success.call(l,m,n);return m;},ECM.hitch(l,k.failure));}j.success=ECM.hitch(j.deferred,j.deferred.callback);j.failure=ECM.hitch(j.deferred,this.errorInterception);ECM.Ajax.requestHandler(j);return j.deferred;},doFormUpload:function(o,n,j){var q="multipart/form-data";var l=ECM.DomHelper.getEl(o.form);var r={action:l.action,encoding:l.enctype,enctype:l.enctype,method:l.method,target:l.target};var m=document.createElement("iframe");var p=[];var k=Ext.id();ECM.Adapter.fly(m).set({cls:"x-hidden",id:k,name:k,src:ECM.Adapter.SSL_SECURE_URL}).appendTo(document.body);(ECM.Adapter.isIE)&&(document.frames[k].name=k);ECM.Adapter.fly(l).set({action:(j||l.action),encoding:q,enctype:q,method:"POST",target:k});ECM.Adapter.iterate(ECM.Adapter.urlDecode(n,false),function(t,s){p.push(ECM.Adapter.fly(document.createElement("input")).set({name:t,type:"hidden",value:s}).appendTo(l).dom);});Ext.EventManager.on(m,"load",function(){var u=this;var s={argument:o.argument,responseJSON:"",responseText:"",responseXML:null};try{var x=m.contentDocument||m.contentWindow.document||window.frames[k].document;if(x){if(x.body){var w=x.body.firstChild||{};s.responseText=(/textarea/i.test(w.tagName))?w.value:ECM.DomHelper.firstTextEl(x.body).nodeValue;}((o.handleAs||"json")==="json")&&(s.responseJSON=ECM.Adapter.decode(s.responseText||""));s.responseXML=x.XMLDocument||x;}}catch(v){}Ext.EventManager.removeListener(m,"load",arguments.callee,u);u.fireEvent("requestcomplete",u,s,o);function t(A,z,y){(ECM.Adapter.isFunction(A))&&(A.apply(z,y));}t(o.success,o.scope,[s,o]);t(o.callback,o.scope,[o,true,s]);(window.setTimeout(function(){ECM.DomHelper.destroyEl(m);},100));},this);l.submit();ECM.Adapter.fly(l).set(r);ECM.Adapter.each(p,function(s){ECM.DomHelper.destroyEl(s);});},download:function(j){var l=document.createElement("iframe");l.src=j.url;l.className="x-hidden";document.body.appendChild(l);var k=l.contentWindow||l.contentDocument.parentWindow;k.onload=function(){this.document.body.innerHTML==""?j.success():j.failure();(function(){Ext.fly(this).remove();}).defer(200,l);};}});})();ECM.provide("ECM.Admin.Tags.FilterControl");ECM.Admin.Tags.FilterControl=Ext.extend(Ext.menu.Menu,{cls:"filter_flyout",defaultFilterValue:"Tag",constructor:function(a){Ext.apply(this,new ECM.Mailing.MailingList.FilterControlBase());Ext.apply(this,a);this.tagStore=new Ext.data.ArrayStore({fields:["id","name"],autoLoad:true,sortInfo:{field:"name",direction:"ASC"},proxy:new Ext.data.HttpProxy({url:"/cm/r/tags/admin",method:"GET"}),listeners:{scope:this,load:function(){this.filterButton.enable();}},root:"data.data"});var b=[["Tag",this.tagStore],["Text Search"]];this.uniqueOpt=["Tag"];this.filterByStore=new Ext.data.ArrayStore({fields:["target","display"]});this.optionStorePair={};Ext.each(b,function(c){if(!Ext.isEmpty(c[1])){this.optionStorePair[c[0].split(" ").join("_")]=c[1];}this.filterByStore.loadData([[c[0],gt.gettext(c[0])]],true);},this);this.createPanel();ECM.Mailing.MailingList.FilterDataModel.on("change",function(d,c){if(d===this.pageType){this.reloadFilter();}},this);ECM.Admin.Tags.FilterControl.superclass.constructor.apply(this,arguments);}});ECM.provide("ECM.util.Safari");ECM.util.Safari={fixScroll:function(){Ext.getBody().scroll("top",-1);Ext.getBody().scroll("top",1);}};if(Ext.isSafari4){Ext.Msg.originalShow=Ext.Msg.show;Ext.Msg.show=function(a){a.fn=ECM.util.Safari.fixScroll.createSequence(a.fn);Ext.Msg.originalShow(a);};}ECM.provide("ECM.GenericWindow");(function(){ECM.GenericWindow=ECM.Adapter.extend(Ext.Window,{height:250,modal:true,width:500,shadow:(Ext.isIE6?false:"sides"),xtype:"ECM.GenericWindow",constrainHeader:true,afterRender:function(){ECM.GenericWindow.superclass.afterRender.call(this);var a=Ext.lib.Dom.getViewportWidth();var b=Ext.lib.Dom.getViewportHeight();var c=[(a-this.width)/2,(b-this.height)/2];this.setPosition((a>this.width)?c[0]:0,(b>this.height)?c[1]:0);if(this.height>b&&Ext.isIE){window.scrollTo(0);}},createGhost:function(a,c,b){return ECM.GenericWindow.superclass.createGhost.call(this,a,c,b).addClass("ecm-generic-window-ghost");},onDestroy:function(){ECM.GenericWindow.superclass.onDestroy.call(this);Ext.getBody().removeClass("x-masked");this.body=this.bubbleEvents=this.bwrap=this.collapseDefaults=this.container=this.dd=this.el=this.expandDefaults=this.filterOptRe=this.focusEl=this.ft=this.header=this.initialConfig=this.items=this.keyMap=this.lastSize=this.layout=this.mask=this.mc=this.proxy=this.resizer=this.toolTemplate=this.tools=null;},onRender:function(b,a){ECM.GenericWindow.superclass.onRender.call(this,b,a);this.el.addClass("ecm-generic-window");this.proxy.addClass("ecm-generic-window-proxy");},toString:function(){return"["+this.xtype+(this.id?" "+this.id:"")+"]";},listeners:{add:function(a,c){var b=this;if(b.rendered&&b.isVisible()){c.on("afterlayout",function(){var h=Ext.lib.Dom.getViewportHeight();
var d=b.getHeight();if((d+b.y)>h){var f=d+b.y-h+50;var g=(b.y>f)?b.y-f:0;b.setPosition(b.x,g);}},c,{single:true});}}}});ECM.Adapter.register("ECM.GenericWindow",ECM.GenericWindow);ECM.Adapter.override(Ext.Window,{beforeShow:function(){delete this.el.lastXY;delete this.el.lastLT;if(this.x===undefined||this.y===undefined){var c=this.el.getAlignToXY(this.container,"c-c");var d=this.el.translatePoints(c[0],c[1]);this.x=this.x===undefined?d.left:this.x;this.y=this.y===undefined?d.top:this.y;}this.el.setLeftTop(this.x,this.y);if(this.expandOnShow){this.expand(false);}if(this.modal){Ext.getBody().addClass("x-body-masked");var a=Ext.lib.Dom.getViewHeight(true);var b=Ext.lib.Dom.getViewWidth(true);b=((a>Ext.lib.Dom.getViewportHeight(true))&&(!Ext.isIE))?b-ECM.DomHelper.getScrollBarWidth():b;this.mask.setSize(b,a);this.mask.show();}}});})();ECM.provide("ECM.Window");(function(){ECM.Window=Ext.extend(Ext.Window,{notifyMaxWidth:Ext.getBody().getWidth()+10,initComponent:function(){if(this.cls&&this.cls.split(" ").indexOf("ecm-generic-window")==-1){this.cls+=" ecm-window ecm-generic-window";}var d=this.windowButtons||[],b={};(this.content&&!this.items)&&(this.items=[this.content]);for(var a=this.items.length;a>=0;a--){this.items[a]=this.items[a-1];}this.notifyPanel=new Ext.Panel({layout:"table",cls:"ecm-notification-table-ct",collapsed:true,items:[{xtype:"ECM.Notify",maxWidth:this.notifyMaxWidth,cls:"ecm-object-notify-cell",listeners:{scope:this,beforeupdate:function(){this.notifyPanel.expand();},cleared:function(){this.notifyPanel.collapse();},timeout:function(){this.notifyPanel.collapse();}}}],listeners:{scope:this,collapse:this.syncShadow,expand:this.syncShadow}});this.items[0]=this.notifyPanel;if(d.length){b={layout:"toolbar",cls:"cm_button_group",items:[]};for(var c=0,a=d.length;c<a;c++){d[c].xtype="button";d[c].cls="blue_button";(c===d.length-1&&c>0)&&(d[c].cls+=" blue_button_last");if(c===0&&d.length>1){d[c].cls+=" blue_button_first";}else{(!d[c].style)&&(d[c].style={});d[c].cls+=" blue_button_spacing";}b.items.push(d[c]);}this.button_bar=new Ext.Panel(b);this.items.push(this.button_bar);}ECM.Window.superclass.initComponent.call(this);this.addListener("hide",function(){if(Ext.isSafari){ECM.util.Safari.fixScroll();}});},content:{},windowButtons:[],autoHeight:true,modal:true,resizable:false,scrollable:false,cls:"ecm-window ecm-generic-window",width:this.width||550,bodyStyle:{overflow:"auto"},shadow:(Ext.isIE6?false:"sides"),xtype:"ECM.Window",constrainHeader:true,afterRender:function(){ECM.Window.superclass.afterRender.call(this);var b=Ext.lib.Dom.getViewportWidth(),d=Ext.lib.Dom.getViewportHeight(),c=this.width||this.getWidth(),a=this.height||this.getHeight();var f=[(b-c)/2,(d-a)/2];this.setPosition((b>c)?f[0]:0,(d>a)?f[1]:0);this.notify=this.items.itemAt(0).items.itemAt(0);if(a>d&&Ext.isIE){window.scrollTo(0);}},createGhost:function(a,c,b){return ECM.Window.superclass.createGhost.call(this,a,c,b).addClass("ecm-window-ghost");},beforeShow:function(){delete this.el.lastXY;delete this.el.lastLT;if(this.x===undefined||this.y===undefined){var c=this.el.getAlignToXY(this.container,"c-c");var d=this.el.translatePoints(c[0],c[1]);this.x=this.x===undefined?d.left:this.x;this.y=this.y===undefined?d.top:this.y;}this.el.setLeftTop(this.x,this.y);if(this.expandOnShow){this.expand(false);}if(this.modal){if(this.scrollable===false){Ext.getBody().addClass("x-body-masked");}var a=Ext.lib.Dom.getViewHeight(true);var b=Ext.lib.Dom.getViewWidth(true);b=((a>Ext.lib.Dom.getViewportHeight(true))&&(!Ext.isIE))?b-ECM.DomHelper.getScrollBarWidth():b;this.mask.setSize(b,a);this.mask.show();}},onDestroy:function(){ECM.Window.superclass.onDestroy.call(this);this.body=this.bubbleEvents=this.bwrap=this.collapseDefaults=this.container=this.dd=this.el=this.expandDefaults=this.filterOptRe=this.focusEl=this.ft=this.header=this.initialConfig=this.items=this.keyMap=this.lastSize=this.layout=this.mask=this.mc=this.proxy=this.resizer=this.toolTemplate=this.tools=null;},onRender:function(b,a){ECM.Window.superclass.onRender.call(this,b,a);this.proxy.addClass("ecm-window-proxy");},toString:function(){return"["+this.xtype+(this.id?" "+this.id:"")+"]";},hideButtons:function(){var a=this.button_bar;if(a){a.hide();}},showButtons:function(){var a=this.button_bar;if(a){a.show();}}});ECM.Adapter.register("ECM.Window",ECM.Window);})();ECM.provide("ECM.Admin.Tags.ModalCreateTag");Ext.apply(Ext.form.VTypes,{uniqueTag:function(d){var b=d.split(",");var a=[];var c=true;Ext.each(b,function(f,g){f=f.trim();if(a[f]){c=false;}else{a[f]=1;}});return c;}});ECM.Admin.Tags.ModalCreateTag=Ext.extend(ECM.Window,{constructor:function(d){this.id=d.id?d.id:"admin_create_tag";this.title=d.title?d.title:gt.gettext("Create Tag");this.grid=d.grid?d.grid:{};this.closeAction="hide";var g=this;g.loadMask=new Ext.LoadMask(Ext.getBody(),{msg:gt.gettext("Saving new tags...")});var c=ECM.Admin.Tags.Store.errorHandler;var h=function(l,m){var j=l.responseJSON;var k=function(){if(Ext.isDefined(j.application_errors)&&j.application_errors.length>0){ECM.publish("/notify/error",{selector:".error_display",message:gt.gettext("Failed to save tag")+": "+j.application_errors[0]});}else{ECM.publish("/notify/info",{selector:".error_display",message:gt.gettext("Tag Values Saved")});}g.loadMask.hide();g[g.closeAction]();g.grid.store.un("load",k);};g.grid.store.on("load",k);g.grid.refresh();};var b=function(j,k){g.loadMask.hide();g.notify.error("An unknown error occurred! Some tags might not saved, please check the tag list.");g.grid.refresh();g.tags.setValue("");};var a=function(){var j=g.tags.getValue().split(",");var k=[];Ext.each(j,function(n){if(n.trim()){k.push(n.trim());}});var l="";Ext.each(k,function(n){if(g.availableTagsStore.findExact("tag_name",n)!==-1){l+=n+",";}});if(l.length>0){l=l.slice(0,-1);g.notify.error(gt.strargs(gt.gettext("Tag [%1] already exists. Please enter a different name."),[l]));return;}if(k.length===0){g.notify.error(gt.gettext("Please enter a valid tag."));return;}var m=(k.length>1)?'["'+k.join('","')+'"]':k[0];g.loadMask.show();g.createButton.disable();ECM.Ajax.request({url:"/cm/r/tag?value="+m,method:"POST",success:h,failure:b});};var f=function(){g[g.closeAction]();};this.createButton=new Ext.Button({id:"create_button",text:gt.gettext("Create"),disabled:true,cls:"blue_button",handler:a});this.cancelButton=new Ext.Button({id:"cancel_button",text:gt.gettext("Cancel"),disabled:false,cls:"blue_button",handler:f});this.items=[{xtype:"form",cls:"cm_text_align_left",items:[{xtype:"label",text:gt.gettext("Enter the new tag name. You can create multiple tags at once by entering the tags with commas separating them")},{xtype:"spacer",height:10},{xtype:"textfield",id:"tag_field",itemId:"tag_field",blankText:gt.gettext("Enter tag names separated by a comma. Duplicates are not allowed."),allowBlank:false,fieldLabel:gt.gettext("Tag name"),width:"95%",vtype:"uniqueTag",vtypeText:gt.gettext("Tags cannot be duplicated"),invalidText:gt.gettext("Tags cannot be duplicated"),listeners:{invalid:function(){g.createButton.disable();},valid:function(){g.createButton.enable();},afterRender:function(){g.tags=this;}}}]}];this.windowButtons=[this.createButton,this.cancelButton];ECM.Admin.Tags.ModalCreateTag.superclass.constructor.apply(this,arguments);},onShow:function(){var b=this.items.itemAt(1).items.get("tag_field");b.setValue("");this.el.mask(gt.gettext("Loading..."));var a=this;a.availableTagsStore=new Ext.data.ArrayStore({autoDestroy:true,proxy:new Ext.data.HttpProxy({url:"/cm/r/tags",method:"GET"}),root:"data.data",idIndex:0,fields:["id","tag_name","count"],listeners:{load:function(c){a.el.unmask();},exception:function(){a.el.unmask();a.notify.error(gt.gettext("Error loading tags."));}}});a.availableTagsStore.load();}});Ext.reg("ecm.admin.tags.createtagmodal",ECM.Admin.Tags.ModalCreateTag);ECM.provide("ECM.Admin.Tags.ModalDeleteTag");ECM.Admin.Tags.ModalDeleteTag=Ext.extend(ECM.Window,{title:gt.gettext("Delete Tags"),closeAction:"hide",constructor:function(a){if(!Ext.isObject(a)){throw new Ext.Error(gt.gettext("Grid missing from modal constructor"));
}this.grid=a.grid;var c=this;var b={xtype:"form",layout:"form",labelWidth:120,items:[{xtype:"label",text:"",style:"padding-bottom:6px;display:block"}]};c.content=b;c.windowButtons=[{text:gt.gettext("Delete"),handler:function(){var d=c.grid.getSelectionModel().getSelections();c.el.mask();c.grid.deleteSelected(d,c);}},{text:gt.gettext("Cancel"),handler:function(){c.hide();}}];ECM.Admin.Tags.ModalDeleteTag.superclass.constructor.call(this);},onShow:function(){var a=this.items.itemAt(1).items.itemAt(0),b=this.grid.getSelectionModel().getSelections(),c=(b.length>0?gt.strargs(gt.ngettext("You have selected 1 tag to delete.","You have selected %1 tags to delete.",b.length),b.length):gt.gettext("You must select at least 1 tag for deletion"));a.setText(c);this.items.itemAt(1).doLayout();}});Ext.reg("ecm.modal.deletetag",ECM.Admin.Tags.ModalDeleteTag);ECM.provide("ECM.Rules.Constants");(function(){var a={NONE:0,SIMPLE:1,ADVANCED:2};var b={};b[a.SIMPLE]={LABEL:0,TYPE:1,TABLE:2,ASSOCIATIVE:3};b[a.ADVANCED]={LABEL:0,TYPE:1,TABLE:2,ASSOCIATIVE:3};var c={};c[a.SIMPLE]={SPACER:0,CONDITION:2,DELETE:1,GROUP:0};c[a.ADVANCED]={SPACER:0,CONDITION:2,DELETE:1,GROUP:0};ECM.Rules.Constants={PROGRAM:{ACTIVE:0,ARCHIVED:1},SYSTEMOPTIONS:{AVERAGE:0,COUNT:1,MAX:2,MIN:4,SUM:8},CATALOG:{COLUMN:b,OPERATOR:{STANDARD:0,SEGMENT:1,ARITY:2,GROUP:3,ASSOC_TYPES:4,ASSOC_NULL_OPTION:5,NUM_VALUES:6}},COLUMN:{STANDARD:{PRIORITY:{DRAG_HANDLE:0,CHECKBOX:1,ORDER:2,DESCRIPTION:3,TARGETING:4},TARGETING:{WORKSPACE:0,TARGET_ICON:1}}},CONTENT:{TEXT:0,AOL:1,HTML:2},DATA:{DEFINITION:0,DESCRIPTION:1,FIRST:0,MEMBER:1,VALUE:0},DATE:{DAY:0,MONTH:1,UNIT:0,VALUE:1,YEAR:2},DESTROY:{REQUEST:1,FORCE:2},DIRTY:{NONE:0,NAME:1,DESCRIPTION:2,KEY:4,PRIORITY:8,TARGETING:16,CONTENT:32,LIBRARY_TAGS:64},HISTORY:{CREATE:{AMBIVALENT:"CA",BULK:"C",EBM:"CE",LIBRARY:"CL"},MODIFY:{AMBIVALENT:"MA",BULK:"M",EBM:"ME",LIBRARY:"ML"}},IDX:{LOGIC:0,SOURCE:1,TABLE:1,AGGREGATOR:2,COLUMN:2,OPERATOR:3,OPERANDS:4,MACRO:4,AGGREGATE:5,IDENTITY:6,ACTION:7},IMAGE_URL:{GRID_ICON_COLLAPSED:"/images/ECM/icon_grid_collapsed.png"},LAYOUT:{BUTTONS:1,CONTAINER:1,CONTENT:1,DESCRIPTION:1,EDITING:0,EDITOR:1,FORM:0,HEADER:0,NAME:0,NOTIFY:1,PRIORITY:0,SAVE_BUTTON:2,TABPANEL:1,TARGETING:0,VIEW_BUTTON:1,DELETE_BUTTON:0},LIBRARY:{TYPE:{CONTENT:1,DYNAMIC_CONTENT:2,IMAGES:3,LINKS:4},ITEM:{HTML:0,RTF:1,TEXT:2,IMAGE:3,LINK:4,DYNAMIC_CONTENT:5}},LOGIC:{NONE:0,LEAF:1,GROUP:2,AND:4,OR:8,INCLUDE:16,EXCLUDE:32,DEFAULT:64,AVERAGE:128,COUNT:256,MAX:512,MIN:1024,SUM:2048,UNIQUE:4096},LOGIC_AGGREGATORS:["AVERAGE","COUNT","MAX","MIN","SUM","UNIQUE"],MAILING:{BULK:1,EBM:2,STANDARD:1,TRIGGERED:2},EVENT_ACTION:{CREATE:0,UPDATE:1,REDEPLOY:2,DEACTIVATE:3},MODES:{ADD:0,EDIT:1},MODULE:{DYNAMIC_CONTENT:"ERD"},NO:0,NUMBER:{ODD:1},OPERANDS:{FIRST:0,SECOND:1,NOVALUE:2},PAGE:{ITEM_END:2,ITEM_START:1,NUMBER:0,RANGE_END:1,RANGE_START:0},SEGMENTS:{ACTIVE:1,ARCHIVED:2},SERVICES:{CONTENT:"content",DEFINITION:"data",FIELD:"fields",SAVE:"set_data",DELETE:"delete"},SHELVES:{NAME:0,DESCRIPTION:1,EDITING:2},TAG:a,TOOLBAR:{PRIORITY:{LABEL:0,TOTAL:1,PAGER:2,SPACER:3,COPY:0,ADD:5,DELETE:1,VIEW_DETAILS:7},TARGETING:c,TYPE:{MAILING_LIST:0,LIBRARY_LIST:1,TAG_LIST:2,LINK_EDITOR:3,SEGMENT_LIST:4,SEGMENT_DOWNLOAD:5},BUTTON:{CREATE:0,COPY:1,MORE_ACTION:2,MOVE:3,ARCHIVE:4,DELETE:5,SCHEDULE_FOLDER:6,SEND_SCREEN:7,PRINT_SCREEN:8,ASSIGN_TAG:9,CREATE_NEW:10,TRACK_LINKS:11,UNTRACK_LINKS:12,SUPPRESS_LINKS:13,CUSTOM_COMMAND:14,COUNT:15,COUNT_BY_DEMOGRAPHIC:16,STOP_COUNT:17,ACTIVATE:18,EXPORT:19,DOWNLOAD:20,COUNT_BY_FILE:21,SCHEDULE_EXPORT:22}},TOPIC:{BUTTONS:{VIEW_DETAILS:{HIDE:"/ecm/rules/buttons/view/details/hide",SHOW:"/ecm/rules/buttons/view/details/show"}},LOADING:{HIDE:"/ecm/rules/loading/hide",HIDE_ALL:"/ecm/rules/loading/hide/all",SHOW:"/ecm/rules/loading/show"},NOTIFY:{CLEAR:"/ecm/rules/notify/clear",ERROR:"/ecm/rules/notify/error",INFO:"/ecm/rules/notify/info",WARN:"/ecm/rules/notify/warn"},PRIORITY:{ADJUSTED:"/ecm/rules/priority/rule/adjusted",ADJUST_OPENED:"/ecm/rules/priority/rule/adjust/opened",DESCRIPTION:{CHANGE:"/ecm/rules/priority/description/change",CONSTRUCT:"/ecm/rules/priority/description/construct"},MOVED:"/ecm/rules/priority/moved",NAME:{CHANGE:"/ecm/rules/priority/name/change",CONSTRUCT:"/ecm/rules/priority/name/construct"},LIBRARY_TAGS:{CHANGE:"/ecm/rules/priority/library/tag/change",CONSTRUCT:"/ecm/rules/priority/library/tag/construct"}},TAG:{BEFORE_CLOSE:"/ecm/rules/tag/before_close",CHANGE:"/ecm/rules/tag/change",CONVERTED:"/ecm/rules/tag/converted",SAVE:"/ecm/rules/tag/save"},TARGETING:{ACTIVE:"/ecm/rules/targeting/active",KEY:{CHANGE:"/ecm/rules/targeting/key/change"},LABEL:{CHANGE:"/ecm/rules/targeting/label/change",CONSTRUCT:"/ecm/rules/targeting/label/construct"},RULE:{ADD:"/ecm/rules/targeting/rule/add",BEFORE_MOVE:"/ecm/rules/targeting/rule/before_move",CHANGE:"/ecm/rules/targeting/rule/change",DELETE:"/ecm/rules/targeting/rule/delete",MOVE:"/ecm/rules/targeting/rule/move"}}},TYPES:{ASSOCIATIVE:1,STRING:2,NUMERIC:3,DATE:4,VIRTUAL:6,BITMASK:7,NTHING:8,BEHAVIOR:9,SUBSCRIPTION:10,MAILING:11,URL:12,COUNT:13,DATETIME:14,ZIP:100,ZIP_STATE:101,ZIP_CSTATE:102,ZIP_MSA:103,ZIP_CMSA:104,ZIP_MA:105,PLATFORM:201,GEOLOCATION:202},URL:{DYNAMIC_CONTENT_GET:"/cm/r/dynamic_content",DYNAMIC_CONTENT_SET:"/cm/r/dynamic_content",DYNAMIC_CONTENT_LIBRARY_SET:"/cm/r/library/dynamic_content",MAILING_SETTINGS:"/cm/mailing/cms"},MSG_FORMAT:{COMMA:0,NEW_LINE:1,LIST:2},YES:1,TIMER:{FAST:15000,SLOW:900000,TIMEOUT:3600000}};})();ECM.provide("ECM.Toolbar.ActionButtons");ECM.Toolbar.ActionButtons=Ext.extend(Ext.Toolbar,{type:ECM.Rules.Constants.TOOLBAR.TYPE.MAILING_LIST,initComponent:function(){this.menuConfig={mailingList:{createButton:{xtype:"button",cls:"blue_button blue_button_spacing",text:gt.gettext("Create Mailing"),actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.CREATE},copyButton:{xtype:"button",cls:"blue_button blue_button_spacing",text:gt.gettext("Copy"),disabled:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.COPY},moreActionsButton:{xtype:"button",text:gt.gettext("More Actions"),cls:"blue_button blue_button_spacing",menuAlign:"tr-br",actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.MORE_ACTION,subMenu:{archiveButton:{text:gt.gettext("Delete"),cls:"blue_button",disabled:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.ARCHIVE},deleteEventButton:{text:gt.gettext("Delete Event"),disabled:true,hidden:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.DELETE},moveButton:{text:gt.gettext("Move"),disabled:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.MOVE},scheduleFolderButton:{text:gt.gettext("Schedule Folder"),actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.SCHEDULE_FOLDER},sendScreenButton:{text:gt.gettext("Send Screen"),actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.SEND_SCREEN},printScreenButton:{text:gt.gettext("Print"),actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.PRINT_SCREEN},processCustomCommandButton:{actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.CUSTOM_COMMAND,disabled:true,hidden:true,id:"customCommandButton",text:"Run Custom Process"}}}},libraryList:{createNewButton:{xtype:"button",text:gt.gettext("Create New"),cls:"blue_button blue_button_spacing",hidden:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.CREATE_NEW},assignTagButton:{xtype:"button",text:gt.gettext("Assign Tag"),cls:"blue_button blue_button_spacing",actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.ASSIGN_TAG},moreActionsButton:{xtype:"button",text:gt.gettext("More Actions"),cls:"blue_button blue_button_spacing",menuAlign:"tr-br",disabled:false,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.MORE_ACTION,subMenu:{deleteButton:{text:gt.gettext("Delete"),actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.DELETE},sendScreenButton:{text:gt.gettext("Send Screen"),actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.SEND_SCREEN},printScreenButton:{text:gt.gettext("Print"),actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.PRINT_SCREEN}}}},tagList:{createButton:{xtype:"button",text:gt.gettext("Create Tag"),cls:"blue_button blue_button_spacing",actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.CREATE},copyButton:{xtype:"button",text:gt.gettext("Copy"),cls:"blue_button blue_button_spacing",disabled:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.COPY},moreActionsButton:{xtype:"button",text:gt.gettext("More Actions"),cls:"blue_button blue_button_spacing",menuAlign:"tr-br",disabled:false,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.MORE_ACTION,subMenu:{deleteButton:{text:gt.gettext("Delete"),disabled:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.DELETE},printScreenButton:{text:gt.gettext("Print"),actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.PRINT_SCREEN},sendScreenButton:{text:gt.gettext("Send Screen"),actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.SEND_SCREEN}}}},linkEditor:{moreActionsButton:{xtype:"button",text:gt.gettext("Track Links"),cls:"blue_button",autoWidth:true,disabled:false,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.MORE_ACTION,subMenu:{trackLinksButton:{text:gt.gettext("Track Selected"),disabled:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.TRACK_LINKS},untrackLinksButton:{text:gt.gettext("Untrack Selected"),disabled:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.UNTRACK_LINKS},suppressLinksButton:{text:gt.gettext("Suppress Selected"),disabled:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.SUPPRESS_LINKS}}}},templateList:{createNewButton:{xtype:"button",text:gt.gettext("Create Template"),cls:"blue_button blue_button_spacing",actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.CREATE_NEW},copyButton:{xtype:"button",text:gt.gettext("Copy"),disabled:true,cls:"blue_button blue_button_spacing",actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.COPY},moreActionsButton:{xtype:"button",text:gt.gettext("More Actions"),cls:"blue_button blue_button_spacing",menuAlign:"tr-br",actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.MORE_ACTION,subMenu:{archiveButton:{text:gt.gettext("Delete"),disabled:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.DELETE_TEMPLATE},moveButton:{text:gt.gettext("Move"),disabled:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.MOVE},sendScreenButton:{text:gt.gettext("Send Screen"),actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.SEND_SCREEN},printScreenButton:{text:gt.gettext("Print"),actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.PRINT_SCREEN}}}},segmentList:{createButton:{xtype:"button",cls:"blue_button blue_button_spacing",text:gt.gettext("Create Segment"),actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.CREATE},copyButton:{xtype:"button",cls:"blue_button blue_button_spacing",text:gt.gettext("Copy"),disabled:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.COPY},moreActionsButton:{xtype:"button",text:gt.gettext("More Actions"),cls:"blue_button blue_button_spacing",menuAlign:"tr-br",actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.MORE_ACTION,subMenu:{activateButton:{text:gt.gettext("Activate"),cls:"blue_button",disabled:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.ACTIVATE},archiveButton:{text:gt.gettext("Archive"),cls:"blue_button",disabled:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.ARCHIVE},countButton:{text:gt.gettext("Count"),disabled:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.COUNT},countByDemographicButton:{text:gt.gettext("Count by Demographic"),disabled:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.COUNT_BY_DEMOGRAPHIC},countByFileButton:{actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.COUNT_BY_FILE,disabled:true,text:gt.gettext("Count by File")},deleteButton:{text:gt.gettext("Delete"),disabled:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.DELETE},exportButton:{text:gt.gettext("Export"),disabled:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.EXPORT},scheduleExportButton:{text:gt.gettext("Schedule Export"),disabled:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.SCHEDULE_EXPORT},moveButton:{text:gt.gettext("Move"),disabled:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.MOVE},printScreenButton:{text:gt.gettext("Print"),actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.PRINT_SCREEN},sendScreenButton:{text:gt.gettext("Send Targeting"),actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.SEND_SCREEN},stopCountButton:{text:gt.gettext("Stop Count"),disabled:true,actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.STOP_COUNT}}}},segmentDownload:{downloadButton:{xtype:"button",cls:"blue_button blue_button_spacing",text:gt.gettext("Download"),actionType:ECM.Rules.Constants.TOOLBAR.BUTTON.DOWNLOAD,disabled:true}}};
if(!ECM.Adapter.namespace("ECM.Stash.permissions").xdb){delete this.menuConfig.segmentList.moreActionsButton.subMenu.countByFileButton;}if(!ECM.Stash.seg_exp_auto_enabled){delete this.menuConfig.segmentList.moreActionsButton.subMenu.scheduleExportButton;}var d=ECM.Rules.Constants.TOOLBAR.TYPE;if(this.type==d.MAILING_LIST){var a=this;this.items=this._buildSubMenu(this.menuConfig.mailingList);if(Ext.isDefined(isBetaView)&&isBetaView==1){var b={text:"Process With...",menu:[]};b.menu.push({text:"removeMe"});var c=new Ext.data.JsonStore({autoLoad:false,fields:["custom_commands_available"],listeners:{load:function(g,f,h){b.menu.push({text:"this is a test"});var k=Ext.getCmp("customCommandButton");var j=g.reader.jsonData.data.custom_commands_available;if(Ext.isDefined(j)&&Ext.isDefined(j.length)&&j.length>0){k.show();}},loadexception:function(g,f,h){}},root:"data",url:"/cm/mailings/customcommand/list_commands_available"});c.load({actionToolbar:a});}}else{if(this.type==d.LIBRARY_LIST){this.items=this._buildSubMenu(this.menuConfig.libraryList);}else{if(this.type===d.TAG_LIST){this.items=this._buildSubMenu(this.menuConfig.tagList);}else{if(this.type===d.LINK_EDITOR){this.items=this._buildSubMenu(this.menuConfig.linkEditor);}else{if(this.type===d.TEMPLATE_LIST){this.items=this._buildSubMenu(this.menuConfig.templateList);}else{if(this.type===d.SEGMENT_LIST){this.items=this._buildSubMenu(this.menuConfig.segmentList);}else{if(this.type===d.SEGMENT_DOWNLOAD){this.items=this._buildSubMenu(this.menuConfig.segmentDownload);}}}}}}}ECM.Toolbar.ActionButtons.superclass.initComponent.apply(this,arguments);this.addEvents("actionbuttonclick");},_buildSubMenu:function(d){if(!Ext.isObject(d)){return null;}var b=[];var a;var c=this;Ext.iterate(d,function(g,h){a=null;if(Ext.isObject(h.subMenu)){a=h.subMenu;}var f=h.actionType;Ext.apply(h,{menu:c._buildSubMenu(a),listeners:{added:function(){c[g]=this;},click:c._buttonClicked.createDelegate(c,[f])}});b.push(h);});return b;},_buttonClicked:function(a){this.fireEvent("actionbuttonclick",a);}});Ext.reg("ecm.actionbuttons",ECM.Toolbar.ActionButtons);ECM.provide("ECM.ModalMgr");ECM.ModalMgr=(function(){return{registry:{},showModal:function(a){this.registry[a].show();},registerModal:function(a,b){this.registry[a]=b;},getModal:function(a){return this.registry[a];},exists:function(a){return this.registry.hasOwnProperty(a);},remove:function(a){if(this.exists(a)){this.registry[a].destroy();delete this.registry[a];return true;}else{return false;}}};})();ECM.provide("ECM.Admin.Tags.ModalCopyTag");ECM.Admin.Tags.ModalCopyTag=Ext.extend(ECM.Window,{refreshCallback:Ext.emptyFn,width:620,autoScroll:true,autoHeight:false,closable:true,cls:"cm_text_align_left",closeAction:"_cancelHandler",constructor:function(b){if(!b.grid||!Ext.isObject(b.grid)){throw new Ext.Error("Grid missing from modal constructor");}Ext.apply(this,b);var c=new Ext.Button({text:gt.gettext("Cancel"),handler:this._cancelHandler.createDelegate(this),cls:"blue_button cm_close_button"});var a=new Ext.Button({text:gt.gettext("Create"),handler:this._copyTags.createDelegate(this),cls:"blue_button"});this.copyContainer=new Ext.Container();this.items=[this.copyContainer];this.windowButtons=[a,c];ECM.Admin.Tags.ModalCopyTag.superclass.constructor.call(this);},listeners:{beforeshow:function(){this._selectedTags=this.grid.getSelectionModel().getSelections();this._numberOfTags=this._selectedTags.length;this.notify.clear();var f;f=gt.ngettext("Copy Tag","Copy Multiple Tags",this._numberOfTags);var c=(this._numberOfTags>5)?500:"auto";this.setTitle(f);this.setHeight(c);var g=this._getCopyPanel();this.copyContainer.removeAll();this.copyContainer.add(g);this.doLayout();var d=this.getHeight();var b=this.getWidth();var h=Ext.getBody().getHeight();var a=Ext.getBody().getWidth();if((h>d)&&(a>b)){this.setPosition((a-b)/2,(h-d)/2);}}},_cancelHandler:function(){this.refreshCallback();this.hide();},_getCopyPanel:function(){var c=this._selectedTags;var f=[];for(var b=0;b<this._numberOfTags;b++){var g=c[b].data.value;var d=c[b].data.id;c[b].data.also_objects=1;var a=(b>0)?"copy_multiple_separator":"";f.push({html:gt.gettext("Copying")+" ["+g+"]",cls:"copy_mailing "+a});f.push({xtype:"label",id:"error"+b,cls:"cm_error"});f.push({xtype:"textfield",fieldLabel:gt.gettext("New tag name"),id:"copy"+b,name:d,value:gt.gettext("Copy of")+" ["+g+"]",allowBlank:false,minLength:1,maxLength:1000,maxLengthText:gt.gettext("Tag name cannot exceed 1000 characters."),width:400,msgTarget:"side",bodyStyle:"padding:10px 0"});}return new Ext.form.FormPanel({ctCls:"mailing_window",itemCls:"copy_mailing_form",items:f,listeners:{afterrender:function(){this.body.dom.parentNode.parentNode.parentNode.style.position="relative";Ext.getCmp("copy0").focus(true,500);}}});},_copyTags:function(){var b=this.findByType("textfield");var d=[];var a=[];Ext.each(b,function(g){var f=g.getValue().trim();if(f){if(d.indexOf(f)!==-1){if(a.indexOf(f)===-1){a.push(f);}}else{var j=g.id;var h=parseInt(j.slice(4),10);this._selectedTags[h].data.value_copy=f;d.push(f);}}},this);if(a.length>0){this.notify.error(gt.gettext("Tags ")+"["+a.join(",")+"]"+gt.gettext(" duplicated. Please retry with different name"));return;}this.el.mask(gt.gettext("Checking tag name. Please wait..."));var c=this;ECM.Ajax.request({url:"/cm/r/tag/exists",method:"GET",params:{value:Ext.encode(d)},success:function(g){c.el.unmask();var h=g.responseJSON.data;if(h.data.length===0){c._copyHandler();}else{var f=[];Ext.each(h.data,function(j){f.push(j[0]);});c.notify.error(gt.gettext("Tag ")+"["+f.join(",")+"]"+gt.gettext(" existed. Please retry with different name"));c.copyContainer.container.scrollTo("top",0);}},failure:function(){c.el.unmask();c.notify.error(gt.gettext("Unable to copy as there was unexpected network errors. Please try again."));}});},_copyHandler:function(){var c;c=gt.ngettext("Copying tag. Please wait...","Copying tags. Please wait...",this._numberOfTags);var f=[];var d={};this._selectedTags.forEach(function(g){f.push(g.data);});this.notify.clear();var a=new Ext.LoadMask(this.el||Ext.getBody(),{msg:c});a.show();var b=this;ECM.Ajax.request({url:"/cm/r/tag?action=copy",method:"POST",params:{batch:Ext.encode(f)},success:function(g,j){a.hide();var h=g.responseJSON;b[b.closeAction]();ECM.publish("/notify/info/show",{selector:".error_display",message:gt.gettext("Copy was successful")});b.refreshCallback();},failure:function(g,h){b.notify.error("Unable to copy. Please try again.");a.hide();}});}});Ext.reg("ecm.admin.tags.modalcopytag",ECM.Admin.Tags.ModalCopyTag);Ext.ns("Ext.ux.form");Ext.ux.form.MultiSelect=Ext.extend(Ext.form.Field,{ddReorder:false,appendOnly:false,width:100,height:100,displayField:0,valueField:1,allowBlank:true,minSelections:0,maxSelections:Number.MAX_VALUE,blankText:Ext.form.TextField.prototype.blankText,minSelectionsText:"Minimum {0} item(s) required",maxSelectionsText:"Maximum {0} item(s) allowed",delimiter:",",cls:"ux-form-multiselect",defaultAutoCreate:{tag:"div"},initComponent:function(){Ext.ux.form.MultiSelect.superclass.initComponent.call(this);if(Ext.isArray(this.store)){if(Ext.isArray(this.store[0])){this.store=new Ext.data.ArrayStore({fields:["value","text"],data:this.store});this.valueField="value";}else{this.store=new Ext.data.ArrayStore({fields:["text"],data:this.store,expandData:true});this.valueField="text";}this.displayField="text";}else{this.store=Ext.StoreMgr.lookup(this.store);}this.addEvents({dblclick:true,click:true,change:true,drop:true});},onRender:function(c,b){Ext.ux.form.MultiSelect.superclass.onRender.call(this,c,b);var a=this.fs=new Ext.form.FieldSet({renderTo:this.el,title:this.legend,height:this.height,width:this.width,style:"padding:0;",tbar:this.tbar});a.body.addClass("ux-mselect");this.view=new Ext.ListView({selectedClass:"ux-mselect-selected",multiSelect:true,store:this.store,columns:[{header:"Value",width:1,dataIndex:this.displayField}],hideHeaders:true});a.add(this.view);this.view.on("click",this.onViewClick,this);this.view.on("beforeclick",this.onViewBeforeClick,this);
this.view.on("dblclick",this.onViewDblClick,this);this.hiddenName=this.name||Ext.id();var d={tag:"input",type:"hidden",value:"",name:this.hiddenName};this.hiddenField=this.el.createChild(d);this.hiddenField.dom.disabled=this.hiddenName!=this.name;a.doLayout();},afterRender:function(){Ext.ux.form.MultiSelect.superclass.afterRender.call(this);if(this.ddReorder&&!this.dragGroup&&!this.dropGroup){this.dragGroup=this.dropGroup="MultiselectDD-"+Ext.id();}if(this.draggable||this.dragGroup){this.dragZone=new Ext.ux.form.MultiSelect.DragZone(this,{ddGroup:this.dragGroup});}if(this.droppable||this.dropGroup){this.dropZone=new Ext.ux.form.MultiSelect.DropZone(this,{ddGroup:this.dropGroup});}},onViewClick:function(c,a,b,d){this.fireEvent("change",this,this.getValue(),this.hiddenField.dom.value);this.hiddenField.dom.value=this.getValue();this.fireEvent("click",this,d);this.validate();},onViewBeforeClick:function(c,a,b,d){if(this.disabled||this.readOnly){return false;}},onViewDblClick:function(c,a,b,d){return this.fireEvent("dblclick",c,a,b,d);},getValue:function(a){var d=[];var c=this.view.getSelectedIndexes();if(c.length==0){return"";}for(var b=0;b<c.length;b++){d.push(this.store.getAt(c[b]).get((a!=null)?a:this.valueField));}return d.join(this.delimiter);},setValue:function(a){var b;var d=[];this.view.clearSelections();this.hiddenField.dom.value="";if(!a||(a=="")){return;}if(!Ext.isArray(a)){a=a.split(this.delimiter);}for(var c=0;c<a.length;c++){b=this.view.store.indexOf(this.view.store.query(this.valueField,new RegExp("^"+a[c]+"$","i")).itemAt(0));d.push(b);}this.view.select(d);this.hiddenField.dom.value=this.getValue();this.validate();},reset:function(){this.setValue("");},getRawValue:function(a){var b=this.getValue(a);if(b.length){b=b.split(this.delimiter);}else{b=[];}return b;},setRawValue:function(a){setValue(a);},validateValue:function(a){if(a.length<1){if(this.allowBlank){this.clearInvalid();return true;}else{this.markInvalid(this.blankText);return false;}}if(a.length<this.minSelections){this.markInvalid(String.format(this.minSelectionsText,this.minSelections));return false;}if(a.length>this.maxSelections){this.markInvalid(String.format(this.maxSelectionsText,this.maxSelections));return false;}return true;},disable:function(){this.disabled=true;this.hiddenField.dom.disabled=true;this.fs.disable();},enable:function(){this.disabled=false;this.hiddenField.dom.disabled=false;this.fs.enable();},destroy:function(){Ext.destroy(this.fs,this.dragZone,this.dropZone);Ext.ux.form.MultiSelect.superclass.destroy.call(this);}});Ext.reg("multiselect",Ext.ux.form.MultiSelect);Ext.ux.Multiselect=Ext.ux.form.MultiSelect;Ext.ux.form.MultiSelect.DragZone=function(d,c){this.ms=d;this.view=d.view;var b=c.ddGroup||"MultiselectDD";var a;if(Ext.isArray(b)){a=b.shift();}else{a=b;b=null;}Ext.ux.form.MultiSelect.DragZone.superclass.constructor.call(this,this.ms.fs.body,{containerScroll:true,ddGroup:a});this.setDraggable(b);};Ext.extend(Ext.ux.form.MultiSelect.DragZone,Ext.dd.DragZone,{onInitDrag:function(a,c){var b=Ext.get(this.dragData.ddel.cloneNode(true));this.proxy.update(b.dom);b.setWidth(b.child("em").getWidth());this.onStartDrag(a,c);return true;},collectSelection:function(b){b.repairXY=Ext.fly(this.view.getSelectedNodes()[0]).getXY();var a=0;this.view.store.each(function(d){if(this.view.isSelected(a)){var f=this.view.getNode(a);var c=f.cloneNode(true);c.id=Ext.id();b.ddel.appendChild(c);b.records.push(this.view.store.getAt(a));b.viewNodes.push(f);}a++;},this);},onEndDrag:function(a,b){var c=Ext.get(this.dragData.ddel);if(c&&c.hasClass("multi-proxy")){c.remove();}},getDragData:function(d){var c=this.view.findItemFromChild(d.getTarget());if(c){if(!this.view.isSelected(c)&&!d.ctrlKey&&!d.shiftKey){this.view.select(c);this.ms.setValue(this.ms.getValue());}if(this.view.getSelectionCount()==0||d.ctrlKey||d.shiftKey){return false;}var b={sourceView:this.view,viewNodes:[],records:[]};if(this.view.getSelectionCount()==1){var a=this.view.getSelectedIndexes()[0];var f=this.view.getNode(a);b.viewNodes.push(b.ddel=f);b.records.push(this.view.store.getAt(a));b.repairXY=Ext.fly(f).getXY();}else{b.ddel=document.createElement("div");b.ddel.className="multi-proxy";this.collectSelection(b);}return b;}return false;},getRepairXY:function(a){return this.dragData.repairXY;},setDraggable:function(a){if(!a){return;}if(Ext.isArray(a)){Ext.each(a,this.setDraggable,this);return;}this.addToGroup(a);}});Ext.ux.form.MultiSelect.DropZone=function(d,c){this.ms=d;this.view=d.view;var b=c.ddGroup||"MultiselectDD";var a;if(Ext.isArray(b)){a=b.shift();}else{a=b;b=null;}Ext.ux.form.MultiSelect.DropZone.superclass.constructor.call(this,this.ms.fs.body,{containerScroll:true,ddGroup:a});this.setDroppable(b);};Ext.extend(Ext.ux.form.MultiSelect.DropZone,Ext.dd.DropZone,{getTargetFromEvent:function(b){var a=b.getTarget();return a;},getDropPoint:function(g,k,d){if(k==this.ms.fs.body.dom){return"below";}var f=Ext.lib.Dom.getY(k),a=f+k.offsetHeight;var j=f+(a-f)/2;var h=Ext.lib.Event.getPageY(g);if(h<=j){return"above";}else{return"below";}},isValidDropPoint:function(b,f,a){if(!a.viewNodes||(a.viewNodes.length!=1)){return true;}var c=a.viewNodes[0];if(c==f){return false;}if((b=="below")&&(f.nextSibling==c)){return false;}if((b=="above")&&(f.previousSibling==c)){return false;}return true;},onNodeEnter:function(d,a,c,b){return false;},onNodeOver:function(h,a,g,d){var b=this.dropNotAllowed;var f=this.getDropPoint(g,h,a);if(this.isValidDropPoint(f,h,d)){if(this.ms.appendOnly){return"x-tree-drop-ok-below";}if(f){var c;if(f=="above"){b=h.previousSibling?"x-tree-drop-ok-between":"x-tree-drop-ok-above";c="x-view-drag-insert-above";}else{b=h.nextSibling?"x-tree-drop-ok-between":"x-tree-drop-ok-below";c="x-view-drag-insert-below";}if(this.lastInsertClass!=c){Ext.fly(h).replaceClass(this.lastInsertClass,c);this.lastInsertClass=c;}}}return b;},onNodeOut:function(d,a,c,b){this.removeDropIndicators(d);},onNodeDrop:function(b,j,h,f){if(this.ms.fireEvent("drop",this,b,j,h,f)===false){return false;}var k=this.getDropPoint(h,b,j);if(b!=this.ms.fs.body.dom){b=this.view.findItemFromChild(b);}if(this.ms.appendOnly){insertAt=this.view.store.getCount();}else{insertAt=b==this.ms.fs.body.dom?this.view.store.getCount()-1:this.view.indexOf(b);if(k=="below"){insertAt++;}}var c=false;if(f.sourceView==this.view){if(k=="below"){if(f.viewNodes[0]==b){f.viewNodes.shift();}}else{if(f.viewNodes[f.viewNodes.length-1]==b){f.viewNodes.pop();}}if(!f.viewNodes.length){return false;}if(insertAt>this.view.store.indexOf(f.records[0])){c="down";insertAt--;}}for(var g=0;g<f.records.length;g++){var a=f.records[g];if(f.sourceView){f.sourceView.store.remove(a);}this.view.store.insert(c=="down"?insertAt:insertAt++,a);var d=this.view.store.sortInfo;if(d){this.view.store.sort(d.field,d.direction);}}return true;},removeDropIndicators:function(a){if(a){Ext.fly(a).removeClass(["x-view-drag-insert-above","x-view-drag-insert-left","x-view-drag-insert-right","x-view-drag-insert-below"]);this.lastInsertClass="_noclass";}},setDroppable:function(a){if(!a){return;}if(Ext.isArray(a)){Ext.each(a,this.setDroppable,this);return;}this.addToGroup(a);}});Ext.ux.form.ItemSelector=Ext.extend(Ext.form.Field,{hideNavIcons:false,imagePath:"",iconUp:"up2.gif",iconDown:"down2.gif",iconLeft:"left2.gif",iconRight:"right2.gif",iconTop:"top2.gif",iconBottom:"bottom2.gif",drawUpIcon:true,drawDownIcon:true,drawLeftIcon:true,drawRightIcon:true,drawTopIcon:true,drawBotIcon:true,delimiter:",",bodyStyle:null,border:false,defaultAutoCreate:{tag:"div"},multiselects:null,initComponent:function(){Ext.ux.form.ItemSelector.superclass.initComponent.call(this);this.addEvents({rowdblclick:true,change:true});},onRender:function(d,a){Ext.ux.form.ItemSelector.superclass.onRender.call(this,d,a);var j=[{legend:"Available",draggable:true,droppable:true,width:100,height:100},{legend:"Selected",droppable:true,draggable:true,width:100,height:100}];this.fromMultiselect=new Ext.ux.form.MultiSelect(Ext.applyIf(this.multiselects[0],j[0]));
this.fromMultiselect.on("dblclick",this.onRowDblClick,this);this.toMultiselect=new Ext.ux.form.MultiSelect(Ext.applyIf(this.multiselects[1],j[1]));this.toMultiselect.on("dblclick",this.onRowDblClick,this);var h=new Ext.Panel({bodyStyle:this.bodyStyle,border:this.border,layout:"table",layoutConfig:{columns:3}});h.add(this.fromMultiselect);var c=new Ext.Panel({header:false});h.add(c);h.add(this.toMultiselect);h.render(this.el);c.el.down("."+c.bwrapCls).remove();if(this.imagePath!=""&&this.imagePath.charAt(this.imagePath.length-1)!="/"){this.imagePath+="/";}this.iconUp=this.imagePath+(this.iconUp||"up2.gif");this.iconDown=this.imagePath+(this.iconDown||"down2.gif");this.iconLeft=this.imagePath+(this.iconLeft||"left2.gif");this.iconRight=this.imagePath+(this.iconRight||"right2.gif");this.iconTop=this.imagePath+(this.iconTop||"top2.gif");this.iconBottom=this.imagePath+(this.iconBottom||"bottom2.gif");var g=c.getEl();this.toTopIcon=g.createChild({tag:"img",src:this.iconTop,style:{cursor:"pointer",margin:"2px"}});g.createChild({tag:"br"});this.upIcon=g.createChild({tag:"img",src:this.iconUp,style:{cursor:"pointer",margin:"2px"}});g.createChild({tag:"br"});this.addIcon=g.createChild({tag:"img",src:this.iconRight,style:{cursor:"pointer",margin:"2px"}});g.createChild({tag:"br"});this.removeIcon=g.createChild({tag:"img",src:this.iconLeft,style:{cursor:"pointer",margin:"2px"}});g.createChild({tag:"br"});this.downIcon=g.createChild({tag:"img",src:this.iconDown,style:{cursor:"pointer",margin:"2px"}});g.createChild({tag:"br"});this.toBottomIcon=g.createChild({tag:"img",src:this.iconBottom,style:{cursor:"pointer",margin:"2px"}});this.toTopIcon.on("click",this.toTop,this);this.upIcon.on("click",this.up,this);this.downIcon.on("click",this.down,this);this.toBottomIcon.on("click",this.toBottom,this);this.addIcon.on("click",this.fromTo,this);this.removeIcon.on("click",this.toFrom,this);if(!this.drawUpIcon||this.hideNavIcons){this.upIcon.dom.style.display="none";}if(!this.drawDownIcon||this.hideNavIcons){this.downIcon.dom.style.display="none";}if(!this.drawLeftIcon||this.hideNavIcons){this.addIcon.dom.style.display="none";}if(!this.drawRightIcon||this.hideNavIcons){this.removeIcon.dom.style.display="none";}if(!this.drawTopIcon||this.hideNavIcons){this.toTopIcon.dom.style.display="none";}if(!this.drawBotIcon||this.hideNavIcons){this.toBottomIcon.dom.style.display="none";}var b=h.body.first();this.el.setWidth(h.body.first().getWidth());h.body.removeClass();this.hiddenName=this.name;var f={tag:"input",type:"hidden",value:"",name:this.name};this.hiddenField=this.el.createChild(f);},doLayout:function(){if(this.rendered){this.fromMultiselect.fs.doLayout();this.toMultiselect.fs.doLayout();}},afterRender:function(){Ext.ux.form.ItemSelector.superclass.afterRender.call(this);this.toStore=this.toMultiselect.store;this.toStore.on("add",this.valueChanged,this);this.toStore.on("remove",this.valueChanged,this);this.toStore.on("load",this.valueChanged,this);this.valueChanged(this.toStore);},toTop:function(){var c=this.toMultiselect.view.getSelectedIndexes();var a=[];if(c.length>0){c.sort();for(var b=0;b<c.length;b++){record=this.toMultiselect.view.store.getAt(c[b]);a.push(record);}c=[];for(var b=a.length-1;b>-1;b--){record=a[b];this.toMultiselect.view.store.remove(record);this.toMultiselect.view.store.insert(0,record);c.push(((a.length-1)-b));}}this.toMultiselect.view.refresh();this.toMultiselect.view.select(c);},toBottom:function(){var c=this.toMultiselect.view.getSelectedIndexes();var a=[];if(c.length>0){c.sort();for(var b=0;b<c.length;b++){record=this.toMultiselect.view.store.getAt(c[b]);a.push(record);}c=[];for(var b=0;b<a.length;b++){record=a[b];this.toMultiselect.view.store.remove(record);this.toMultiselect.view.store.add(record);c.push((this.toMultiselect.view.store.getCount())-(a.length-b));}}this.toMultiselect.view.refresh();this.toMultiselect.view.select(c);},up:function(){var a=null;var c=this.toMultiselect.view.getSelectedIndexes();c.sort();var d=[];if(c.length>0){for(var b=0;b<c.length;b++){a=this.toMultiselect.view.store.getAt(c[b]);if((c[b]-1)>=0){this.toMultiselect.view.store.remove(a);this.toMultiselect.view.store.insert(c[b]-1,a);d.push(c[b]-1);}}this.toMultiselect.view.refresh();this.toMultiselect.view.select(d);}},down:function(){var a=null;var c=this.toMultiselect.view.getSelectedIndexes();c.sort();c.reverse();var d=[];if(c.length>0){for(var b=0;b<c.length;b++){a=this.toMultiselect.view.store.getAt(c[b]);if((c[b]+1)<this.toMultiselect.view.store.getCount()){this.toMultiselect.view.store.remove(a);this.toMultiselect.view.store.insert(c[b]+1,a);d.push(c[b]+1);}}this.toMultiselect.view.refresh();this.toMultiselect.view.select(d);}},fromTo:function(){var f=this.fromMultiselect.view.getSelectedIndexes();var b=[];if(f.length>0){for(var d=0;d<f.length;d++){record=this.fromMultiselect.view.store.getAt(f[d]);b.push(record);}if(!this.allowDup){f=[];}for(var d=0;d<b.length;d++){record=b[d];if(this.allowDup){var a=new Ext.data.Record();record.id=a.id;delete a;this.toMultiselect.view.store.add(record);}else{this.fromMultiselect.view.store.remove(record);this.toMultiselect.view.store.add(record);f.push((this.toMultiselect.view.store.getCount()-1));}}}this.toMultiselect.view.refresh();this.fromMultiselect.view.refresh();var c=this.toMultiselect.store.sortInfo;if(c){this.toMultiselect.store.sort(c.field,c.direction);}this.toMultiselect.view.select(f);},toFrom:function(){var d=this.toMultiselect.view.getSelectedIndexes();var a=[];if(d.length>0){for(var c=0;c<d.length;c++){record=this.toMultiselect.view.store.getAt(d[c]);a.push(record);}d=[];for(var c=0;c<a.length;c++){record=a[c];this.toMultiselect.view.store.remove(record);if(!this.allowDup){this.fromMultiselect.view.store.add(record);d.push((this.fromMultiselect.view.store.getCount()-1));}}}this.fromMultiselect.view.refresh();this.toMultiselect.view.refresh();var b=this.fromMultiselect.store.sortInfo;if(b){this.fromMultiselect.store.sort(b.field,b.direction);}this.fromMultiselect.view.select(d);},valueChanged:function(c){var a=null;var b=[];for(var d=0;d<c.getCount();d++){a=c.getAt(d);b.push(a.get(this.toMultiselect.valueField));}this.hiddenField.dom.value=b.join(this.delimiter);this.fireEvent("change",this,this.getValue(),this.hiddenField.dom.value);},getValue:function(){return this.hiddenField.dom.value;},onRowDblClick:function(c,a,b,d){if(c==this.toMultiselect.view){this.toFrom();}else{if(c==this.fromMultiselect.view){this.fromTo();}}return this.fireEvent("rowdblclick",c,a,b,d);},reset:function(){range=this.toMultiselect.store.getRange();this.toMultiselect.store.removeAll();this.fromMultiselect.store.add(range);var a=this.fromMultiselect.store.sortInfo;if(a){this.fromMultiselect.store.sort(a.field,a.direction);}this.valueChanged(this.toMultiselect.store);}});Ext.reg("itemselector",Ext.ux.form.ItemSelector);Ext.ux.ItemSelector=Ext.ux.form.ItemSelector;Ext.ns("ECM.Plugins");ECM.provide("ECM.Plugins.MultiSelect.MultiSelectRow");ECM.Plugins.MultiSelectRow=Ext.extend(Ext.util.Observable,{constructor:function(a){Ext.apply(this,a);ECM.Plugins.MultiSelectRow.superclass.constructor.apply(this,arguments);},init:function(a){this.multiSelect=a;this.multiSelect.addListener("afterrender",function(){if(Ext.isDefined(this.simpleSelect)){this.multiSelect.view.simpleSelect=this.simpleSelect;}this.multiSelect.el.child("div.x-fieldset-body").applyStyles("overflow:auto");if(this.filterBy){this.multiSelect.store.each(this.filterRecords,this);}this.multiSelect.store.addListener("load",function(c,b){if(!this.filterBy){return;}this.multiSelect.store.each(this.filterRecords,this);},this);this.multiSelect.store.addListener("add",function(c,b){if(!this.filterBy){return;}this.multiSelect.store.each(this.filterRecords,this);},this);if(Ext.isArray(this.lockRows)){this.processRow(true);}this.modifyViewBehavior();},this);this.multiSelect.addListener("dblclick",function(d,b,c,f){if(this.isNodeDisabled(c)){return false;}},this);},modifyViewBehavior:function(){this.multiSelect.view.addListener("beforeselect",function(b,a,c){return !this.isNodeDisabled(a);
},this);Ext.apply(this.multiSelect.view,{refresh:this.multiSelect.view.refresh.createSequence(function(){this.processRow(true);},this)});},processRow:function(a){Ext.each(this.lockRows,function(f){var g=this.lockField?this.lockField:this.multiSelect.valueField;var c=this.multiSelect.store.findExact(g,f);if(c>=0){var b=this.multiSelect.store.getAt(c);if(a&&c>0){this.multiSelect.view.store.remove(b);this.multiSelect.view.store.insert(0,b);}var d=this.multiSelect.view.getNode(b);Ext.get(d).addClass("x-item-disabled");}},this);},filterRecords:function(a){var c=this.filterField?this.filterField:this.multiSelect.valueField;var b=this.filterBy.findExact(c,a.get(c));if(b>=0){this.multiSelect.view.store.remove(a);}},isNodeDisabled:function(b){var a=Ext.get(b);return a&&a.hasClass("x-item-disabled");}});Ext.preg("ecm.plugins.multiselectrow",ECM.Plugins.MultiSelectRow);Ext.ns("ECM.Form");ECM.provide("ECM.Form.ItemSelector");ECM.Form.ItemSelector=Ext.extend(Ext.ux.form.ItemSelector,{initComponent:function(){var b=this,a=b.multiselects[0],c=b.multiselects[1];if(Ext.isArray(this.stores)){if(this.stores[0]){a.store=this.stores[0];}if(this.stores[1]){c.store=this.stores[1];}}if(this.width){this.setWidth(this.width);}if(a.store){a.valueField=a.store.fields.keys[0];a.displayField=Ext.isDefined(a.store.fields.keys[1])?a.store.fields.keys[1]:a.store.fields.keys[0];}else{throw new Ext.Error("Missing store for multiselect["+a.id+"]");}if(c.store){c.valueField=c.store.fields.keys[0];c.displayField=Ext.isDefined(c.store.fields.keys[1])?c.store.fields.keys[1]:c.store.fields.keys[0];}else{throw new Ext.Error("Missing store for multiselect["+c.id+"]");}if(!a.plugins){a.plugins=new ECM.Plugins.MultiSelectRow({filterBy:(c.store||[]),filterField:c.valueField});}if(!c.plugins){c.plugins=new ECM.Plugins.MultiSelectRow({lockRows:(this.lock||[])});}if(this.selectionsRequired){this.invalidText=gt.strargs(gt.ngettext("This field requires at least %1 selection","This field requires at least %1 selections",this.selectionsRequired),this.selectionsRequired);}return ECM.Form.ItemSelector.superclass.initComponent.apply(this,arguments);},listeners:{change:function(){var a=this.getValue();if(a){if(this.selectionsRequired&&this.selectionsRequired<=a.split(this.delimiter).length){this.clearInvalid();}}}},selectionsRequired:0,lock:[],width:0,setWidth:function(a){var b=(a-40)/2;if(this.fromMultiselect){this.fromMultiselect.setWidth(b);}else{this.multiselects[0].width=b;}if(this.toMultiselect){this.toMultiselect.setWidth(b);}else{this.multiselects[1].width=b;}},cls:"ecm-form-itemselector",stores:[],fieldLabel:gt.gettext("Select"),imagePath:"/js/extjs/examples/ux/images/",xtype:"itemselector",drawBotIcon:false,drawDownIcon:false,drawTopIcon:false,drawUpIcon:false,multiselects:[{legend:"",width:150,height:150},{legend:"",width:150,height:150}],onRender:function(j,h){Ext.ux.form.ItemSelector.superclass.onRender.call(this,j,h);var a=[{legend:"Available",draggable:true,droppable:true,width:100,height:100},{legend:"Selected",droppable:true,draggable:true,width:100,height:100}];this.fromMultiselect=new Ext.ux.form.MultiSelect(Ext.applyIf(this.multiselects[0],a[0]));this.fromMultiselect.on("dblclick",this.onRowDblClick,this);this.toMultiselect=new Ext.ux.form.MultiSelect(Ext.applyIf(this.multiselects[1],a[1]));this.toMultiselect.on("dblclick",this.onRowDblClick,this);var b=new Ext.Panel({bodyStyle:this.bodyStyle,border:this.border,layout:"table",layoutConfig:{columns:4}});b.add(this.fromMultiselect);var l=new Ext.Panel({header:false});b.add(l);b.add(this.toMultiselect);var g=new Ext.Panel({header:false});b.add(g);b.render(this.el);l.el.down("."+l.bwrapCls).remove();if(this.imagePath!=""&&this.imagePath.charAt(this.imagePath.length-1)!="/"){this.imagePath+="/";}this.iconUp=this.imagePath+(this.iconUp||"up2.gif");this.iconDown=this.imagePath+(this.iconDown||"down2.gif");this.iconLeft=this.imagePath+(this.iconLeft||"left2.gif");this.iconRight=this.imagePath+(this.iconRight||"right2.gif");this.iconTop=this.imagePath+(this.iconTop||"top2.gif");this.iconBottom=this.imagePath+(this.iconBottom||"bottom2.gif");var c=l.getEl();this.toTopIcon=c.createChild({tag:"img",src:this.iconTop,style:{cursor:"pointer",margin:"2px"}});c.createChild({tag:"br"});this.addIcon=c.createChild({tag:"img",src:this.iconRight,style:{cursor:"pointer",margin:"2px"}});c.createChild({tag:"br"});this.removeIcon=c.createChild({tag:"img",src:this.iconLeft,style:{cursor:"pointer",margin:"2px"}});c.createChild({tag:"br"});var d=g.getEl();c.createChild({tag:"br"});this.upIcon=d.createChild({tag:"img",src:this.iconUp,style:{cursor:"pointer",margin:"2px"}});d.createChild({tag:"br"});this.downIcon=d.createChild({tag:"img",src:this.iconDown,style:{cursor:"pointer",margin:"2px"}});d.createChild({tag:"br"});this.toBottomIcon=c.createChild({tag:"img",src:this.iconBottom,style:{cursor:"pointer",margin:"2px"}});this.toTopIcon.on("click",this.toTop,this);this.upIcon.on("click",this.up,this);this.downIcon.on("click",this.down,this);this.toBottomIcon.on("click",this.toBottom,this);this.addIcon.on("click",this.fromTo,this);this.removeIcon.on("click",this.toFrom,this);if(!this.drawUpIcon||this.hideNavIcons){this.upIcon.dom.style.display="none";}if(!this.drawDownIcon||this.hideNavIcons){this.downIcon.dom.style.display="none";}if(!this.drawLeftIcon||this.hideNavIcons){this.addIcon.dom.style.display="none";}if(!this.drawRightIcon||this.hideNavIcons){this.removeIcon.dom.style.display="none";}if(!this.drawTopIcon||this.hideNavIcons){this.toTopIcon.dom.style.display="none";}if(!this.drawBotIcon||this.hideNavIcons){this.toBottomIcon.dom.style.display="none";}var f=b.body.first();this.el.setWidth(b.body.first().getWidth());b.body.removeClass();this.hiddenName=this.name;var k={tag:"input",type:"hidden",value:"",name:this.name};this.hiddenField=this.el.createChild(k);}});Ext.reg("ecm.itemselector",ECM.Form.ItemSelector);ECM.provide("ECM.Form.VTypes");Ext.apply(Ext.form.VTypes,{multipleEmailsText:gt.gettext('This field should be an e-mail address in the format "user@example.com". Please use commas to separate multiple addresses.'),multipleEmails:function(c){var a=c.split(",");for(var b=0;b<a.length;b++){if(!Ext.form.VTypes.email(a[b].trim())){return false;}}return true;},mailingNameFormat:function(b){var a=Ext.util.Format.trim(b);if(b.length>100||Ext.isEmpty(a)||(a.indexOf("::")>-1)){return false;}else{return true;}},twitterSearchTerm:function(d){var a=d.split(",");var c=[];if(a.length>10){return false;}for(var b=0;b<a.length;b++){if(c[a[b]]){return false;}else{c[a[b]]=1;}}return true;},linkPrefixFormat:function(a){if(a.match(/^[a-z]{1,4}$/)){return true;}else{return false;}},dcTagNameFormat:function(a){if(a.match(/^[a-zA-Z]\w*$/)){return true;}else{return false;}},fromAddress:function(a){if(this.email(a)||a.match(/^%%\w+%%$/)){return true;}return false;},fromAddressMask:/[a-z0-9_\.\-@\+%]/i,fromAddressText:gt.gettext("This field should be an e-mail address or personalization"),bccAddress:function(a){if(this.email(a)){return true;}return false;},bccAddressText:gt.gettext('This field should be an e-mail address in the format "user@example.com"'),cssText:function(a){if(a.match(/^[^"<>!@\^&+~`$*|\\]+$/)){return true;}else{return false;}},validNameText:gt.gettext("This field is required"),validName:function(a){return a.trim().length!==0;},validTriggeredMailingDescriptionText:gt.gettext("Enter description"),validTriggeredMailingDescription:function(a){return a.trim().length!==0;}});ECM.provide("ECM.Mailing.MailingList.ModalSendScreen");(function(){ECM.Mailing.MailingList.ModalSendScreen=function(d){var g=this;d=d||{};var n=["email"],h=new Ext.data.ArrayStore({fields:n}),f=new Ext.data.ArrayStore({fields:n}),j,k=function(p){var o=[];Ext.each(p,function(q){if(q&&q!=="null"){o.push([q,q]);}});return o;},b=function(){g.loading_addresses=true;ECM.Ajax.request({url:"/cm/r/report_address/report_addresses",method:"GET",failure:function(o,p){g.loading_addresses=false;},success:function(o,p){j.addresses=o.responseJSON.data.data;
h.loadData(k(j.addresses));Ext.select("#"+j.id+" dl>dt>em").each(function(){this.set({"ext:qtip":this.dom.innerHTML});});g.loading_address=false;}});};if(d.grid){g.grid=d.grid;}if(d.addresses&&d.addresses.length){h.loadData(k(d.addresses));}else{b();}g.type=d.type;var a=gt.gettext("List from Cheetahmail");if(g.type==="mailing"){a=gt.gettext("Mailing List from Cheetahmail");}else{if(g.type==="library"){a=gt.gettext("Library List from Cheetahmail");}else{if(g.type==="template"){a=gt.gettext("Template List from Cheetahmail");}else{if(g.type=="admintag"){a="Admin Tags from Cheetahmail";}}}}var m={xtype:"form",labelWidth:130,defaultType:"textfield",defaults:{width:350},items:[{xtype:"label",text:gt.gettext("Send this screen to the following recipients"),style:"ecm-form-label-text"},{xtype:"spacer",height:13},{xtype:"ecm.itemselector",fieldLabel:gt.gettext("Recipients"),allowBlank:false,selectionsRequired:1,name:"sendscreen-recipients",stores:[h,f]},{fieldLabel:gt.gettext("Additional Recipients"),name:"sendscreen-add-recipients",emptyText:gt.gettext("Enter any additional email addresses, separated by commas."),vtype:"multipleEmails"},{xtype:"combo",fieldLabel:gt.gettext("Format"),editable:false,name:"sendscreen-format",forceSelection:true,triggerAction:"all",allowBlank:false,store:[["html","HTML"],["csv","CSV"],["pdf","PDF"]],value:"html"},{fieldLabel:gt.gettext("Subject Line"),name:"sendscreen-subject",allowBlank:false,emptyText:gt.gettext("Please include a subject line"),value:a},{xtype:"textarea",name:"sendscreen-message",height:50,fieldLabel:gt.gettext("Message")}]};var l={text:gt.gettext("Send"),formBind:true,handler:function(v,A){var q=j.getComponent(1),H=q.findByType("ecm.itemselector")[0],x=H.getValue(),J=H.delimiter,G=H.selectionsRequired,t=q.getForm().findField("sendscreen-add-recipients");(t.el.getValue()==t.emptyText)&&(t.el.dom.value="");if(!q.getForm().isValid()){var D="";if(!t.isValid()){var y=t.getValue().split(",");var o=[];Ext.each(y,function(N){if(!Ext.form.VTypes.email(N.trim())){o.push(N.trim());}});D=gt.gettext("Invalid email address")+" "+o.join(", ");}var u=q.getForm().findField("sendscreen-subject");if(!u.isValid()){if(!Ext.isEmpty(D)){D=D+"<br />";}D=D+gt.gettext("Please include a subject line");}j.notify.error(D||gt.gettext("Form fields may not be submitted with invalid values"));return;}if(!t.getValue()&&G){if(x.length===0||x.split(J).length<parseInt(G,10)){H.markInvalid();j.notify.error(gt.gettext("Please select at least one recipient&lsquo;s email address."));return false;}}if(!g.grid){throw new Ext.Error("Mailing list grid unaccessible");}var p=[];var F=Ext.query(".x-grid-panel .x-grid3-header-offset>table")[0];var B=Ext.query("tr td",F);var M=[];Ext.each(Ext.query(".x-grid3-body .x-grid3-row"),function(O,N){if(O.className.match(/x-grid3-row-expanded/)){M.push(N);}});var E,z=0;if(g.type==="mailing"){z=2;E=(g.grid.getListingTypeId()===1)?"mailing":"triggered";}else{if(g.type==="template"){z=2;E=(g.grid.getListingTypeId()===1)?"template_standard":"template_triggered";}else{if(g.type==="library"){z=1;switch(g.grid.getListingTypeId()){case ECM.Rules.Constants.LIBRARY.TYPE.CONTENT:E="library_contents";break;case ECM.Rules.Constants.LIBRARY.TYPE.DYNAMIC_CONTENT:E="library_dynamic_contents";break;case ECM.Rules.Constants.LIBRARY.TYPE.IMAGES:E="library_images";break;case ECM.Rules.Constants.LIBRARY.TYPE.LINKS:E="library_links";break;default:throw new Ext.Error("Invalid library item ["+g.grid.getListingTypeId()+"]");}}else{if(g.type=="admintag"){z=1;E="admintag";}else{throw new Ext.Error("Invalid listing type item ["+g.type+"]");}}}}var s=g.grid.getPagingToolbar();var L=g.grid.getStore().sortInfo||{};var I={sort:s.getSortedFieldName()||L.field,dir:s.getSortedDirection()||L.direction,start:s.getRecordStart(),limit:s.getPageSize(),filter:s.getFilter()};var w=g.grid.getColumnModel();Ext.each(B,function(P,N){if(N<z){return true;}var Q=Ext.query("div.x-grid3-hd-inner",P);var O;if(Ext.isDefined(Q[0].innerText)){O=Q[0].innerText.trim();}else{O=Q[0].textContent.trim();}p.push({field:w.getDataIndex(N),value:O,width:P.style.width.replace("px","")});});var K={type:E,columnInfo:Ext.encode(p),expanded:M.length>0?Ext.encode(M):undefined};Ext.apply(K,I);Ext.apply(K,q.getForm().getValues());var r=new Ext.LoadMask(j.el,{msg:gt.gettext("Sending screen data...")});r.show();j.notify.clear();ECM.Ajax.request({method:"GET",url:"/cm/utils/sendscreen",params:K,success:function(P,O){r.hide();var N=ECM.util.Parser.decodeResponse(P,O,ECM.Rules.Constants.MSG_FORMAT.LIST);if(!N.success){j.notify.error(N.message);}else{ECM.publish("/notify/info/clear",{selector:".error_display",message:gt.gettext("E-mail sent successfully.")});j.hide();}},failure:function(P,O){r.hide();var N=ECM.util.Parser.decodeResponse(P,O,ECM.Rules.Constants.MSG_FORMAT.LIST);if(!N.success){j.notify.error(N.message);}else{j.notify.info(gt.gettext("E-mail sent successfully."));setTimeout(function(){j.hide();},2000);}}});}};var c={text:gt.gettext("Cancel"),handler:function(){j.hide();}};j=new ECM.Window({id:"ecm-window-sendscreen",closeAction:"hide",title:gt.gettext("Send Screen"),content:m,grid:g.grid,windowButtons:[l,c],onShow:function(){if(g.loading_addresses!==true&&h.getCount()===0){b();}}});return j;};})();ECM.provide("ECM.util.ExtHistory");ECM.util.ExtHistory=(function(){var f,c;var l=false;var d;function g(){var m=top.location.href,n=m.indexOf("#");return n>=0?m.substr(n+1):null;}function a(){c.value=d;}function h(m){d=m;ECM.util.ExtHistory.fireEvent("change",m);}function j(n){var m=['<html><body><div id="state">',Ext.util.Format.htmlEncode(n),"</div></body></html>"].join("");try{var p=f.contentWindow.document;p.open();p.write(m);p.close();return true;}catch(o){return false;}}function b(){if(!f.contentWindow||!f.contentWindow.document){setTimeout(b,10);return;}var p=f.contentWindow.document;var n=p.getElementById("state");var m=n?n.innerText:null;var o=g();setInterval(function(){p=f.contentWindow.document;n=p.getElementById("state");var r=n?n.innerText:null;var q=g();if(r!==m){m=r;h(m);top.location.hash=m;o=m;a();}else{if(q!==o){o=q;j(q);}}},50);l=true;Ext.History.fireEvent("ready",Ext.History);}function k(){d=c.value?c.value:g();var m=g();setInterval(function(){var n=g();if(n!==m){m=n;h(m);a();}},50);l=true;ECM.util.ExtHistory.fireEvent("ready",ECM.util.ExtHistory);}return{fieldId:"x-history-field",iframeId:"x-history-frame",events:{},init:function(n,m){if(l){Ext.callback(n,m,[this]);return;}if(!Ext.isReady){Ext.onReady(function(){ECM.util.ExtHistory.init(n,m);});return;}c=Ext.getDom(ECM.util.ExtHistory.fieldId);this.addEvents("ready","change");if(n){this.on("ready",n,m,{single:true});}k();},add:function(m,n){if(n!==false){if(this.getToken()==m){return true;}}top.location.hash=m;return true;},back:function(){history.go(-1);},forward:function(){history.go(1);},getToken:function(){return l?d:g();}};})();Ext.apply(ECM.util.ExtHistory,new Ext.util.Observable());ECM.provide("ECM.History");ECM.History=(function(){return Ext.apply(ECM.util.ExtHistory,{state:{},changeHandlers:{},suspended:false,typeHandlers:{setter:function(setTo){var stateName=this.handler.as||func;var newState={};newState[stateName]=setTo;if(this.handler.trackOnly){ECM.History.addState(newState);}else{ECM.History.go(newState);}}},defaults:{},addState:function(state){Ext.apply(this.state,state);},addChangeHandlers:function(changeHandlers){Ext.apply(this.changeHandlers,changeHandlers);},go:function(state){if(state){this.addState(state);}this.add(Ext.urlEncode(this.state));},getState:function(){return this.state;},setState:function(state){this.state=state;},suspendHistory:function(){this.suspended=true;},resumeHistory:function(){this.suspended=false;},addDefaults:function(defaults){Ext.apply(this.defaults,defaults);},watchEvent:function(scope,event,options){var opts=options?{handler:options}:{handler:{as:event}};scope.on(event,function(args){if(opts.handler.handler&&typeof opts.handler.handler==="function"){return opts.handler.handler();
}var mine={arguments:arguments},expect;if(expect=opts.handler.expect){for(var i=0;i<expect.length;i++){mine[expect[i]]=arguments[i];}}var setTo=opts.handler.property?eval("mine."+opts.handler.property):Ext.encode(args);if(opts.handler.unless!==setTo){ECM.History.typeHandlers.setter.createDelegate(opts,[setTo])();}});},watchFunctions:function(scope,functions){Ext.iterate(functions,function(func){var current=functions[func],handler;if(!(scope[func]&&typeof scope[func]==="function")){throw"Function "+func+" does not exist in scope";}if(typeof current.handler==="function"){handler=current.handler;}else{if(current.handler&&current.handler.type&&ECM.History.typeHandlers[current.handler.type]){handler=ECM.History.typeHandlers[current.handler.type].createDelegate(current);}else{throw ("Invalid type defined in attachStates call");}}scope[func]=scope[func].createSequence(handler.createDelegate(current.scope||scope));});}});})();ECM.History.add=ECM.History.add.createInterceptor(function(){return !this.suspended;},ECM.History);ECM.History.addEvents("changeDelta");ECM.History.on("change",function(d){var a=[],c=ECM.History.getState(),f=Ext.urlDecode(d),b={},g=false;Ext.iterate(f,function(h,j){if(c[h]!=f[h]){a.push(h);}});ECM.History.setState(Ext.decode(Ext.encode(f)));Ext.iterate(c,function(h,j){if(!f[h]){b[h]=undefined;g=true;}});if(!Ext.isEmpty(a)||g){ECM.History.fireEvent("changeDelta",d,Ext.copyTo(b,f,a));}});ECM.History.on("changeDelta",function(c){var a=this.changeHandlers;var b=this.defaults;if(a._before){a._before(this,c);}Ext.iterate(c,function(d,f){if(a[d]&&a[d]!=b[d]){a[d](f||b[d],c);}});if(a._after){a._after(c);}},ECM.History);ECM.provide("ECM.Admin.Tags.Panel");ECM.Admin.Tags.Panel=Ext.extend(Ext.Panel,{height:800,constructor:function(a){a=a||{};a.records=a.records||{};this.pageType="admin_tag";this.store=new ECM.Admin.Tags.Store({aid:a.aid,records:a.records});this.actionButtons=this.createActionButtons();this.grid=new ECM.Admin.Tags.Grid({store:this.store,actionButtons:["->",this.actionButtons],forceContainerHeight:true});ECM.Ajax.suspendEvents();this.errorHandler=new ECM.Error();this.filterHeader=this.buildFilterHeader();this.saveButton=this.buildSaveButton();this.items=[this.grid];ECM.Admin.Tags.Panel.superclass.constructor.call(this,a);this.grid.filterGrid(this.filterHeader.getFilterKey(),false);},buildSaveButton:function(){var a=this,b=Ext.query(".app_title")[0];Ext.DomHelper.insertHtml("beforeEnd",b,['<div id="saveButtonCt" style="width:60px;float:right;margin-top:3px;"></div>'].join("\n"));return new Ext.Button({text:gt.gettext("Save"),cls:"blue_button",handler:function(){ECM.publish("/notify/clear/all",{selector:".error_display"});var c=a.grid.store.getModifiedRecords();if(c.length>0){a.verifiedRecords(c);}},renderTo:Ext.get("saveButtonCt")});},verifiedRecords:function(b){var g=[];var a=[];var c=false;Ext.each(b,function(h){var j=h.data.value.trim();if(j){if(g.indexOf(j)!==-1){if(a.indexOf(j)===-1){a.push(j);}}else{g.push(j);}}else{ECM.publish("/notify/error/clear",{selector:".error_display",message:gt.gettext("Please enter a valid tag.")});c=true;return false;}},this);if(c){return;}if(a.length>0){var f=gt.gettext("Tags ")+"["+a.join(",")+"]"+gt.gettext(" duplicated. Please retry with different name");ECM.publish("/notify/error/clear",{selector:".error_display",message:f});return;}var d=this;d.el.mask(gt.gettext("Verifying tag..."));ECM.Ajax.request({url:"/cm/r/tag/exists",method:"GET",params:{value:Ext.encode(g)},success:function(j){d.el.unmask();var k=j.responseJSON.data;if(k.data.length===0){d.grid.store.save();d.grid.store.commitChanges();}else{var h=[];Ext.each(k.data,function(m){h.push(m[0]);});var l="["+h.join(",")+"]"+gt.gettext(" already exists. ")+gt.ngettext("Please enter a different name","Please enter different names",h.length);ECM.publish("/notify/error/clear",{selector:".error_display",message:l});}},failure:function(){d.el.unmask();d.notify.error(gt.gettext("Unable to save as there was an unexpected network error. Please try again."));}});},buildFilterHeader:function(){var d=this,c=new ECM.Mailing.MailingList.FilterHeader({pageType:"admin_tag",grid:d.grid}),b=new Ext.Button({cls:"filter_button",iconCls:"filter_button_icon"});c.on("filter",function(f){this.grid.filterGrid(f);},this);b.menu=new ECM.Admin.Tags.FilterControl({pageType:"admin_tag"});b.menu.on("filter",function(g,h,f){if(!Ext.isEmpty(f)){ECM.publish("/notify/error/clear",{selector:".error_display",message:f});}else{this.grid.filterGrid(g);}},this);b.menu.on("beforefilter",function(f){f.selectedId=this.grid.getSelectedId();},this);c.render(Ext.get("filterHeader").insertBefore("app_wrapper"));d.errorDisplay=new Ext.Element(Ext.DomHelper.createDom({tag:"div",cls:"error_display",id:"listing_error"}));d.errorDisplay.insertAfter("filterHeader");var a=new Ext.Toolbar({cls:"cm_liner",ctCls:"cm_box_hd cm_box_hd_grey",items:[{xtype:"label",cls:"cm_padding_5",text:"Filter"},b]});a.render(document.getElementById("cm_toolbar"));return c;},createActionButtons:function(){var b=this,c=new ECM.Toolbar.ActionButtons({type:ECM.Rules.Constants.TOOLBAR.TYPE.TAG_LIST});c.on("afterrender",function(){b.grid.getSelectionModel().on("selectionchange",function(g){var f=["copyButton","deleteButton"];for(var d=0;d<f.length;d++){if(Ext.isDefined(c[f[d]])){c[f[d]].setDisabled(!g.hasSelection());}}});});var a=ECM.Rules.Constants.TOOLBAR.BUTTON;c.addListener("actionbuttonclick",function(k){switch(k){case a.CREATE:if(!ECM.ModalMgr.exists("createTag")){var j=new ECM.Admin.Tags.ModalCreateTag({grid:this.grid});ECM.ModalMgr.registerModal("createTag",j);}ECM.ModalMgr.showModal("createTag");break;case a.COPY:var h=this;if(!ECM.ModalMgr.exists("copyTag")){var f=new ECM.Admin.Tags.ModalCopyTag({grid:h.grid,refreshCallback:function(){h.grid.getSelectionModel().clearSelections();h.grid.refresh();}});ECM.ModalMgr.registerModal("copyTag",f);}ECM.ModalMgr.showModal("copyTag");break;case a.DELETE:if(!ECM.ModalMgr.exists("deleteTag")){var g=new ECM.Admin.Tags.ModalDeleteTag({grid:this.grid});ECM.ModalMgr.registerModal("deleteTag",g);}ECM.ModalMgr.showModal("deleteTag");break;case a.PRINT_SCREEN:this.grid.print();break;case a.SEND_SCREEN:if(!ECM.ModalMgr.exists("sendScreen")){var d=new ECM.Mailing.MailingList.ModalSendScreen({grid:this.grid,type:"admintag"});ECM.ModalMgr.registerModal("sendScreen",d);}ECM.ModalMgr.showModal("sendScreen");break;}}.createDelegate(this));return c;},listeners:{afterrender:function(){Ext.EventManager.onWindowResize(function(){var a=Ext.select("#main_bd .cm_box").first();if(a){this.grid.setWidth(a.getWidth());this.grid.doLayout();}},this);}}});Ext.onReady(function(){Ext.QuickTips.init();});ECM.provide("ECM.Form.UploadDialog");ECM.Form.UploadDialog=Ext.extend(Ext.util.Observable,{uploadLineCount:0,textContentSelected:false,richTextContentSelected:false,htmlContentSelected:false,uploadRecordTemplate:Ext.data.Record.create([{name:"file"},{name:"type"},{name:"options"},{name:"remove"}]),mappingRecordTemplate:Ext.data.Record.create([{name:"tagname"},{name:"mapping"}]),fileTypeOptionsTemplate:Ext.data.Record.create([{name:"typename"}]),uploadWindow:false,confirmationWindow:false,uploadWindowWidth:770,uploadWindowHeight:360,mappingWindowWidth:430,mappingWindowHeight:306,windowingClass:ECM.GenericWindow,multiContent:false,allowImages:false,isPriv:false,allowEncodingConversion:false,title:gt.gettext("Upload Content"),constructor:function(b){var a={upload_url:"/m/service/content_upload"};if(ECM.Tablespace&&ECM.Tablespace.get){this.allowImages=ECM.Tablespace.get("img_upload")==="true";}this.addEvents({startUpload:true,serverResponse:true,serverError:true,closeConfirmation:true});this.mappingIndex=0;Ext.apply(this,Ext.apply(a,b));ECM.Form.UploadDialog.superclass.constructor.call(this);},init:function(){this.upload_template=' <form id="uploadForm" method="POST"><div class="upload_scrollContainer" id="uploadContainer"></div><div class="mapping_scrollContainer" id="mappingContainer" style="display:none;"></div></form>';
this.error_template='<div id="uploadErrorSection"><table id="upload_errorTable"><tr><td class="errorText ecm-error"  id="upload_errorCell">&nbsp;</td></tr></table></div><div id="mapping_instructions" style="margin-bottom:5px;display:none;">The uploaded content contains references to content that already exists in the mailing and/or the library. Please choose the desired mapping.</div>';this.help_link_template=['<div style="text-align: right; padding: 2px 10px 2px 2px;">',ECM.Flare.makeLink("FLARE_UPLOAD_MODAL"),"</div>"].join("");var b="";var a="";if(this.mode=="dc"){b='<td><div name="add_button" id="add_button" class="uploadButton" style="float:left;"></div></td>';}this.upload_button_template='<div class=\'cm_button_group\'><table id="upload_buttons" class="uploadButtonContainer"><tbody><tr>'+b+'<td><div name="upload_button" id="upload_button" class="uploadButton" style="float:left;"></div></td><td><div name="cancel_button" id="cancel_button" class="uploadButton" style="float:right;"></div></td></tr></tbody></table><table id="mapping_buttons" class="mappingButtonContainer" style="display:none;"><tbody><tr><td><div name="back_button" id="back_button" class="uploadButton" style="float:left;"></div></td><td><div name="done_button" id="done_button" class="uploadButton" style="float:right;"></div></td></tr></tbody></table></div>';this.lineNumberPlaceholder=0;this.uploadLineCount=0;this.textContentSelected=false;this.richTextContentSelected=false;this.htmlContentSelected=false;return this;},getBaseParams:function(){return{aid:ECM.Tablespace.get("aid"),desired_aid:ECM.Tablespace.get("aid"),tag_mid:ECM.Tablespace.get("mid"),tag_mtype:ECM.Tablespace.get("mtype")};},uploadContent:function(){ECM.publish("/notify/clear",{selector:".errorText"});this.uploadWindow.syncShadow();var m=0;var b=0;var f=0;var a;var n=new Ext.form.BasicForm("uploadForm"),d=new Ext.form.BasicForm("uploadForm").getValues(),j={},g,k;Ext.iterate(d,function(q){var p=q.split("_"),r=p.pop();if(!r){return true;}if(!j[r]){j[r]={file_param:"fileName_"+r};}j[r][p.join("_")]=d[q];});var c={invalid:false,reason:"missingType"};Ext.iterate(j,function(s,v){v.no_transaction=true;var p=["Dynamic Content"];if(this.allowImages){p.push("Image Files");}p=p.concat(["Text Content","HTML Content","Rich Text Content"]);var u={};Ext.iterate(p,function(w){u[gt.gettext(w)]=w;});var t=u[v.fileType]||"";var r=Ext.getDom(v.file_param);var q=r?r.value:undefined;if(g=t.match("^(.*?) Content$")){}else{if(g=t.match("Image Files")){if(q.match(/\s/)&&!q.match(/.zip$/)){c.invalid=true;c.reason="fileNameSpace";c.vars=q;return false;}}else{if(q&&q.length&&q.length>0){c.invalid=true;c.reason="missingType";return false;}else{return true;}}}},this);if(c.invalid){var h={fileNameSpace:gt.gettext('Illegal filename: "{0}"'),missingType:gt.gettext("Type is a required field.")};var l={selector:".errorText",width:450,message:String.format.apply(window,[h[c.reason]].concat(c.vars))};ECM.publish("/notify/error/clear",l);return;}if(this.mode==="content"){a=this.getDCEditorInstances();if(!a[0].isEmpty()){m=1;}if(!a[1].isEmpty()){b=1;}if(!a[2].isEmpty()){f=1;}}var o=this;o.fireEvent("startUpload");ECM.longAjax=ECM.Adapter.applyIf({timeout:Infinity},ECM.Ajax);ECM.longAjax.request({form:"uploadForm",method:"POST",url:o.upload_url,isUpload:true,handleAs:"json",params:Ext.apply(this.getBaseParams(),{hasText:m,hasRichText:b,hasHTML:f}),success:function(p){o.uploadWindow.enable();var r="";if(p.responseJSON&&p.responseJSON.data){r=p.responseJSON.data;o.fireEvent("serverResponse",r);}if(r&&r.error){o.displayError(r);}else{if(r.mapping){o.showMappingModal(r);}else{if(r.success){if(o.uploadWindow.title==gt.gettext("Map Content")){o.uploadWindow.title=gt.gettext("Map Content")+" ";}o.uploadWindow.close();o.showConfirmationModal(r);}else{var q={error:gt.gettext("Empty data returned from server.")};o.displayError(q);}}}},failure:function(p){o.uploadWindow.enable();o.fireEvent("serverError",p);var q={error:gt.gettext("Server Timeout. Dynamic Content will continue to process.")};o.displayError(q);}});this.uploadWindow.disable();},getDCEditorInstances:function(){return ECM.Form.DCEditor.instances;},confirmContent:function(){this.confirmationWindow.close();},displayError:function(b){ECM.publish("/notify/clear",{selector:".errorText"});var a=Ext.unique(b.error);Ext.each(a,function(c){if(Ext.isArray(c)){ECM.publish("/notify/error",{selector:".errorText",width:300,message:c.join("<br />")});}else{ECM.publish("/notify/error",{selector:".errorText",width:300,message:c});}});},onFileTypeFocus:function(j){this.textContentSelected=false;this.richTextContentSelected=false;this.htmlContentSelected=false;var c=Ext.getCmp("fileType_"+j);var k=c.value;var h=Ext.get("rownum_"+j).dom.value;var a=this.getUploadGrid();var d=a.store.getAt(h-1);for(var f=1;f<=this.lineNumberPlaceholder;f++){if(Ext.get("rownum_"+f)){var g=Ext.get("rownum_"+f).dom.value;if(h!=g){var l=Ext.getCmp("fileType_"+f).value;if(l==gt.gettext("Text Content")){this.textContentSelected=true;}else{if(l==gt.gettext("Rich Text Content")){this.richTextContentSelected=true;}else{if(l==gt.gettext("HTML Content")){this.htmlContentSelected=true;}}}}}}c.store.removeAll();var b=[];if(!this.textContentSelected||this.multiContent){c.store.add(new this.fileTypeOptionsTemplate({typeval:gt.gettext("Text Content")}));}if(!this.richTextContentSelected||this.multiContent){c.store.add(new this.fileTypeOptionsTemplate({typeval:gt.gettext("Rich Text Content")}));}if(!this.htmlContentSelected||this.multiContent){c.store.add(new this.fileTypeOptionsTemplate({typeval:gt.gettext("HTML Content")}));}if(this.allowImages){c.store.add(new this.fileTypeOptionsTemplate({typeval:gt.gettext("Image Files")}));}c.store.add(new this.fileTypeOptionsTemplate({typeval:gt.gettext("Dynamic Content")}));c.store.commitChanges();},onFileTypeChanged:function(a){var c=this.getUploadGrid();var h=Ext.get("rownum_"+a).dom.value;if(h==c.store.data.items.length&&this.mode!=="dc"){Ext.get("removeLink_"+a).dom.style.display="";this.addUploadLine();}var f=Ext.get("fileType_"+a).dom.value;var g=Ext.get("staticOptionsTable_"+a).dom;var d=Ext.get("dynamicOptionsTable_"+a).dom;var b=Ext.getCmp("encodingPanel_"+a);g.style.display="none";d.style.display="none";if(b){b.hide();}if(f==gt.gettext("Dynamic Content")){d.style.display="";}else{g.style.display="";Ext.get("textWrap_"+a).dom.style.display="none";if(f==gt.gettext("Text Content")){Ext.get("textWrap_"+a).dom.style.display="";}if(f==gt.gettext("Image Files")){if(b){b.show();}}if(f==gt.gettext("Text Content")){this.textContentSelected=true;}else{if(f==gt.gettext("Rich Text Content")){this.richTextContentSelected=true;}else{if(f==gt.gettext("HTML Content")){this.htmlContentSelected=true;}}}}},getUploadGrid:function(){return Ext.getCmp("uploadGrid");},getMappingGrid:function(){return Ext.getCmp("mappingGrid");},addMappingGrid:function(){var b=new Ext.data.ArrayStore({storeId:"mappingStore",fields:this.mappingRecordTemplate});var a=new Ext.grid.GridPanel({id:"mappingGrid",store:b,colModel:new Ext.grid.ColumnModel({columns:[{id:"tagname",header:gt.gettext("Tag Name"),dataIndex:"tagname",sortable:false,width:180},{id:"mapping",header:gt.gettext("Mapping"),dataIndex:"mapping",sortable:false,width:199}]}),enableHdMenu:false,enableColumnMove:false,enableColumnResize:false,autoHeight:true,columnLines:true,width:379,renderTo:"mappingContainer"});},addUploadGrid:function(){var c=new Ext.data.ArrayStore({storeId:"uploadStore",fields:this.uploadRecordTemplate});var a=new Ext.grid.GridPanel({id:"uploadGrid",store:c,width:"100%",layout:"fit",colModel:new Ext.grid.ColumnModel({columns:[{id:"file",header:gt.gettext("File"),dataIndex:"file",sortable:false,width:200},{id:"type",header:gt.gettext("Type"),dataIndex:"type",sortable:false,width:135},{id:"options",header:gt.gettext("Options"),dataIndex:"options",sortable:false,width:350},{id:"remove",header:"",dataIndex:"remove",sortable:false,align:"center","vertical-align":"middle",width:29}]}),stripeRows:true,autoExpandColumn:"options",viewConfig:{forceFit:true},enableHdMenu:false,enableColumnMove:false,enableColumnResize:false,height:300,autoWidth:true,columnLines:true,renderTo:"uploadContainer",trackMouseOver:false,cls:"upload-content-panel"});
var b=this;a.on("viewready",function(){b.addUploadLine();});},addMappingLines:function(a){var c=this.getMappingGrid();for(var b in a.mapping){this.mappingIndex++;var d="mapOption_"+(this.mappingIndex);var f="mapTag_"+(this.mappingIndex);if(a.mapping[b]=="L"){c.store.add(new this.mappingRecordTemplate({tagname:"<span>"+b+"<span>",mapping:'<input type="hidden" name="'+f+'" value="'+b+'"/><select name="'+d+'"  class="mapping_option"><option>'+gt.gettext("Library")+"</option><option>"+gt.gettext("New")+"</option></select>"}));c.store.getAt(c.store.getCount()-1).commit();}else{if(a.mapping[b]=="LM"){c.store.add(new this.mappingRecordTemplate({tagname:b,mapping:'<input type="hidden" name="'+f+'" value="'+b+'"/><select name="'+d+'" class="mapping_option"><option>'+gt.gettext("Library")+"</option><option>"+gt.gettext("Mailing")+"</select>"}));c.store.getAt(c.store.getCount()-1).commit();}}}},removeUploadLine:function(a){var d=this.getUploadGrid();var f=Ext.get("rownum_"+a).dom.value;var b=f;d.store.removeAt(f-1);for(var c=a;c<=this.lineNumberPlaceholder;c++){if(Ext.get("rownum_"+c)){Ext.get("rownum_"+c).dom.value=b;b++;}}this.uploadLineCount--;if(this.mode==="dc"){this.fixDcExes();}},addUploadLine:function(){this.uploadLineCount++;this.lineNumberPlaceholder++;var H=this.lineNumberPlaceholder;var q='<div id="fileNameObject_'+H+'" name="fileNameObject_'+H+'"></div>';var F='<div id="typeCombo_'+H+'"></div>';var l='<div id="encodingContainer_'+H+'"></div>';var m='<input type="hidden" id="rownum_'+H+'" name="rownum_'+H+'" value="'+this.uploadLineCount+'"><table id="staticOptionsTable_'+H+'" style="display:none;"><tbody><tr><td><input type="checkbox" id="overwrite_'+H+'" name="overwrite_'+H+'" style="vertical-align:middle;"/>&nbsp;'+gt.gettext("Overwrite")+'</td></tr><tr><td><span id="textWrap_'+H+'" style="display:none;"><input type="checkbox" id="wrapTextA_'+H+'" name="wrapTextA_'+H+'" style="vertical-align:middle;"/>&nbsp;'+gt.gettext("Wrap text at")+'&nbsp;<input type="text" class="wrapTextBox" id="wrapCharsA_'+H+'" name="wrapCharsA_'+H+'" />'+gt.gettext(" characters")+"</span></td></tr></tbody></table>"+l+'<table id="dynamicOptionsTable_'+H+'" style="display:none;"><tbody><tr><td style="width:100px">'+gt.gettext("Format:")+'</td><td><div id="formatCombo_'+H+'" class="dc_fieldset"></div></td></tr><tr><td>'+gt.gettext("Track URLs:")+'</td><td><div id="trackCombo_'+H+'" class="dc_fieldset"></div></td></tr><tr><td colspan=2><input type="checkbox" id="urlEncoded_'+H+'" name="urlEncoded_'+H+'" style="vertical-align:middle;"/>&nbsp;'+gt.gettext("URL Encoded")+'<br/><br/></td></tr><tr><td colspan=2><input type="checkbox" id="wrapTextB_'+H+'" name="wrapTextB_'+H+'" style="vertical-align:middle;"/>&nbsp;'+gt.gettext("Wrap text at")+'&nbsp;<input type="text" class="wrapTextBox" id="wrapCharsB_'+H+'" name="wrapCharsB_'+H+'" /> '+gt.gettext(" characters")+"</td></tr></tbody></table>";var s='<div id="removeLink_'+H+'" name="removeLink_'+H+'" class="removeLink" style="display:none" parenttype="flyout"><img class="icon" src="/images/remove_x.gif" parenttype="flyout"/></div>';var b=this.getUploadGrid();var k=new this.uploadRecordTemplate({file:q,type:F,options:m,remove:s});b.store.add([].concat(k));b.store.getAt(b.store.getCount()-1).commit();var g="fileNameObject_"+H;var x="typeCombo_"+H;var v="formatCombo_"+H;var G="trackCombo_"+H;var n="encodingContainer_"+H;var E="fileName_"+H;var d="fileType_"+H;var A="formatOption_"+H;var a="trackOption_"+H;var f="encode_to_"+H;var c="encode_from_"+H;var j=H;var y=new Ext.ux.form.FileUploadField({id:E,name:E,buttonText:gt.gettext("Browse"),renderTo:g});y.render(g);y.button.addClass("blue_button");if(Ext.isIE||Ext.isChrome){y.on("fileselected",function(I,J){var L=J.lastIndexOf("\\");var K=J.substring(L+1);I.setValue(K);});}if(this.mode==="content"){var u=this;var p=new Ext.form.ComboBox({renderTo:x,editable:false,store:new Ext.data.SimpleStore({fields:["typeval"],data:[]}),displayField:"typeval",emptyText:gt.gettext("Select..."),mode:"local",forceSelection:true,triggerAction:"all",width:120,id:d,name:d,lazyInit:false,getListParent:function(){return u.uploadWindow.getEl();}});p.on("select",function(){u.onFileTypeChanged(j);});p.on("focus",function(){u.onFileTypeFocus(j);});}else{new Ext.Panel({renderTo:x,items:[{xtype:"label",text:gt.gettext("Dynamic Content"),value:gt.gettext("Dynamic Content")},{xtype:"hidden",id:d,name:d,value:gt.gettext("Dynamic Content")}]});this.onFileTypeChanged(j);}var w=ECM.DCOptions(),u=this,o=w.items[0];o.autoWidth=true;o.name=A;o.setValue(gt.gettext("Comma, double quoted"));o.getListParent=function(){return u.uploadWindow.getEl();};o.render(v);var t=w.items[1];t.autoWidth=true;t.tpl='<tpl for="."><div class="x-combo-list-item" style="white-space: normal;">{'+t.displayField+"}</div></tpl>";t.width=200;t.name=a;t.setValue(gt.gettext("Select Link Tracking Option..."));t.getListParent=function(){return u.uploadWindow.getEl();};t.render(G);if(this.allowEncodingConversion){var B=["ISO-2022-JP","ISO-2022-KR","EUC-KR","SHIFT-JIS"];if(this.isPriv){B.push("GB2312","Big5","Big5-HKSCS");}var z={xtype:"combo",triggerAction:"all",editable:false,mode:"local",width:90};var r=new Ext.Panel({renderTo:n,id:"encodingPanel_"+H,hidden:true,width:280,layout:"fit",bodyStyle:{backgroundColor:"transparent"},items:[{xtype:"label",text:gt.gettext("Encoding options")},{xtype:"panel",bodyStyle:{marginTop:"5px",backgroundColor:"transparent"},items:[{layout:"column",bodyStyle:{backgroundColor:"transparent"},items:[{xtype:"spacer",html:gt.gettext("From "),style:{margin:"6px 6px 0 15px"}},Ext.apply({},z,{name:c,store:["UTF-8","UTF-16","SHIFT-JIS"],id:c}),{xtype:"spacer",html:gt.gettext(" to "),style:{margin:"6px 6px 0"}},Ext.apply({},z,{store:B,name:f,id:f})]}]}]});}var h=function(K){var I=K.getRawValue();var J=Ext.util.Format.htmlDecode(I);K.setRawValue(J);};t.on("select",function(){h(this);});t.on("blur",function(){h(this);});b.getSelectionModel().selectLastRow();var D=Ext.get("removeLink_"+H);if(D){D.on("click",(function(){var I=new Ext.util.DelayedTask(function(){u.removeUploadLine(H);});return function(){I.delay(250);};})());}return H;},confirmationWindowClosed:function(a){if(a.success.text){ECM.Form.DCEditor.instances[0].addContent(a.success.text,a.success.text_wrap,false);}if(a.success.richtext){ECM.Form.DCEditor.instances[1].addContent(a.success.richtext,"",false);}if(a.success.html){ECM.Form.DCEditor.instances[2].addContent(a.success.html,"",false);}},showConfirmationModal:function(g){var f=this;var b="";if(g&&g.success&&g.success.directory){b=g.success.directory;}var a='<div style="padding:10 0;">'+gt.gettext("Your content and images have been uploaded. ");if(b){a+=gt.strargs(gt.gettext('New images are publicly available in five minutes.<br/><br/><span style="font-weight:bold;">Image Public Location: </span> %1'),[b]);}if(this.mode==="dc"){if(g.success.dc_html){a+=g.success.dc_html;}}if(g.success.files_not_saved&&g.success.files_not_saved.length>0){a+='<br/><br/><span class="errorText ecm-error">'+gt.gettext("An error was encountered saving the following files:")+"<br/>";for(var c=0;c<g.success.files_not_saved.length;c++){a+=g.success.files_not_saved[c]+"<br/>";}a+="</span>";}this.confirmationWindow=new this.windowingClass({title:gt.gettext("Upload Complete"),items:[{region:"center",html:a,border:false},{region:"south",items:[{xtype:"button",cls:"blue_button",text:gt.gettext("Done"),style:"float:right;margin:5px;",listeners:{click:function(){f.confirmContent();}}}],border:false}],width:600,autoHeight:true,resizable:false});var d=this;this.confirmationWindow.on("close",function(){d.confirmationWindowClosed(g);});this.confirmationWindow.show();},showUploadModal:function(){Ext.getCmp("mappingGrid").store.removeAll();Ext.get("uploadContainer").dom.style.display="";Ext.get("upload_buttons").dom.style.display="";this.uploadWindow.setSize(this.uploadWindowWidth,"auto");this.uploadWindow.setTitle(gt.gettext(this.title));Ext.get("mapping_instructions").dom.style.display="none";
Ext.get("mappingContainer").dom.style.display="none";Ext.get("mapping_buttons").dom.style.display="none";this.uploadWindow.center();},showMappingModal:function(a){this.uploadWindow.serverData=a;Ext.getCmp("mappingGrid").store.removeAll();Ext.get("uploadContainer").dom.style.display="none";Ext.get("upload_buttons").dom.style.display="none";this.uploadWindow.setSize(this.mappingWindowWidth,this.mappingWindowHeight);this.uploadWindow.setTitle(gt.gettext("Map Content"));Ext.get("mapping_instructions").dom.style.display="";Ext.get("mappingContainer").dom.style.display="";Ext.get("mapping_buttons").dom.style.display="";this.addMappingLines(a);this.uploadWindow.center();},display:function(){var c=this;this.uploadWindow=new this.windowingClass({title:this.title,items:[{region:"north",html:this.help_link_template+this.error_template,border:false},{region:"center",html:this.upload_template,border:false},{region:"south",html:'<div style="float:right">'+this.upload_button_template+"</div>",border:false}],width:this.uploadWindowWidth,bodyStyle:this.bodyStyle,resizable:false,autoHeight:true});this.uploadWindow.on("beforeclose",function(g){if(this.title==gt.gettext("Map Content")){Ext.Msg.show({title:gt.gettext("Cancel Upload"),msg:gt.gettext("Are you sure you want to cancel the upload process?"),buttons:Ext.Msg.YESNOCANCEL,cls:"ecm-message-box",fn:function(h){if(h!="yes"){return false;}else{c.uploadWindow.title=gt.gettext("Map Content")+" ";c.uploadWindow.close();}},icon:Ext.MessageBox.QUESTION});return false;}});this.uploadWindow.on("afterlayout",function(g){c.uploadWindow.center();});if(this.hideCallback){this.uploadWindow.on("hide",this.hideCallback);}this.uploadWindow.show();var a=new Ext.Button({renderTo:"upload_button",text:"Upload",minWidth:60,layout:"toolbar",cls:"blue_button"});a.on("click",function(){c.uploadContent();});if(this.mode==="dc"){var a=new Ext.Button({renderTo:"add_button",text:gt.gettext("Add File"),minWidth:60,layout:"toolbar",cls:"blue_button"});a.on("click",function(){c.addUploadLine();c.fixDcExes();});}var d=new Ext.Button({renderTo:"cancel_button",text:gt.gettext("Cancel"),minWidth:60,layout:"toolbar",cls:"blue_button"});d.on("click",function(){c.uploadWindow.close();});var b=new Ext.Button({renderTo:"back_button",text:gt.gettext("Back to Upload"),minWidth:60,layout:"toolbar",cls:"blue_button"});b.on("click",function(){c.showUploadModal();});var f=new Ext.Button({renderTo:"done_button",text:gt.gettext("Done"),minWidth:60,layout:"toolbar",cls:"blue_button"});f.on("click",function(){c.uploadContent();});this.addUploadGrid();this.addMappingGrid();this.uploadWindow.center();},setMode:function(a){this.mode=a;},fixDcExes:function(){var a="";if(this.getUploadGrid().store.data.items.length==1){a="none";}for(var b=0;b<=this.lineNumberPlaceholder;b++){var c=Ext.get("removeLink_"+b);if(c&&c.dom){c.dom.style.display=a;}}}});ECM.Form.UploadDialog.instance=false;ECM.Form.UploadDialog.getInstance=function(b){if(!ECM.Form.UploadDialog.instance){ECM.Form.UploadDialog.instance=(new ECM.Form.UploadDialog());var d={mode:{func:"setMode",def:"content"}};for(var c in d){var a=d[c].def;if(b&&b[c]){a=b[c];}ECM.Form.UploadDialog.instance[d[c].func](a);}}return ECM.Form.UploadDialog.instance;};ECM.Form.UploadDialog.setOnReady=function(){Ext.onReady(function(){var a=Ext.get("openUploadButton");if(!a){return;}a.on("click",function(){var b=ECM.Form.UploadDialog.getInstance();b.init();b.display();if(!b.hasListener("serverResponse")){b.on("serverResponse",function(c){if(c.success){c=c.success;}var d=ECM.Form.DCEditor.data("DC");if(c.dc_newKeys){for(var g=0;g<c.dc_newKeys.length;g++){var f=c.dc_newKeys[g];f=f.replace(/^[Dd]_/,"");d[0]["D_"+f.toUpperCase()]=d[0]["D_"+f.toUpperCase()]||["d_"+f];}}if(c.library){for(var g=0;g<c.library.length;g++){var f=c.library[g];f=f.replace(/^[Dd]_/,"");if(d[0]["D_"+f.toUpperCase()]){d[0]["D_"+f.toUpperCase()][4]=false;}else{d[0]["D_"+f.toUpperCase()]=["d_"+f,""];}}}ECM.Form.DCEditor.markDCFormats(0);});}});});};ECM.provide("ECM.Data.DictionaryStore");ECM.Data.DictionaryReader=ECM.Adapter.extend(Ext.data.JsonReader,{constructor:function(a,b){a=a||{};a.idProperty="__key__";ECM.Data.DictionaryReader.superclass.constructor.call(this,a,b||a.fields);},readRecords:function(r){this.arrayData=r;var l=this.meta,d=l?ECM.Adapter.number(l.idIndex,l.id):null,b=this.recordType,q=b.prototype.fields,y=[],g;var u=this.getRoot(r);for(var A in u){var t=u[A],a={},p=A;for(var x=0,m=q.length;x<m;x++){var z=q.items[x],w=z.mapping||z.name;g=(w==="__key__")?A:(t||z.defaultValue);g=z.convert(g,t);a[z.name]=g;}var c=new b(a,p);c.json=t;y[y.length]=c;}var h=y.length;if(l.totalProperty){g=parseInt(this.getTotal(r),10);(!isNaN(g))&&(h=g);}return{records:y,totalRecords:h};}});ECM.Data.DictionaryStore=ECM.Adapter.extend(Ext.data.Store,{autoDestroy:true,constructor:function(a){ECM.Data.DictionaryStore.superclass.constructor.call(this,ECM.Adapter.apply(a,{reader:new ECM.Data.DictionaryReader(a)}));},destroy:function(){this.fields.purgeListeners();ECM.Data.DictionaryStore.superclass.destroy.call(this,arguments);this.baseParams=this.batches=this.defaultParamNames=this.events=this.fields=this.filterOptRe=this.items=this.keys=this.map=this.modified=this.paramNames=this.removed=this.sortToggle=null;this.totalLength=0;}});ECM.provide("ECM.Data.TandemStore");ECM.Data.TandemReader=ECM.Adapter.extend(Ext.data.JsonReader,{readRecords:function(r){this.arrayData=r;var l=this.meta,d=l?ECM.Adapter.number(l.idIndex,l.id):null,b=this.recordType,q=b.prototype.fields,z=[],g;var u=this.getRoot(r);for(var y=0,A=u.length;y<A;y=y+2){var t=u[y],a={},p=((d||d===0)&&t[d]!==undefined&&t[d]!==""?t[d]:null);for(var x=0,m=q.length;x<m;x++){var B=q.items[x],w=B.mapping||x;g=(w==="__index__")?(y-1):((w==="__key__")?t:(u[y+1]||B.defaultValue));g=B.convert(g,t);a[B.name]=g;}var c=new b(a,p);c.json=t;z[z.length]=c;}var h=z.length;if(l.totalProperty){g=parseInt(this.getTotal(r),10);(!isNaN(g))&&(h=g);}return{records:z,totalRecords:h};}});ECM.Data.TandemStore=ECM.Adapter.extend(Ext.data.Store,{autoDestroy:true,constructor:function(a){ECM.Data.TandemStore.superclass.constructor.call(this,ECM.Adapter.apply(a,{reader:new ECM.Data.TandemReader(a)}));},destroy:function(){this.fields.purgeListeners();ECM.Data.TandemStore.superclass.destroy.call(this,arguments);this.baseParams=this.batches=this.defaultParamNames=this.events=this.fields=this.filterOptRe=this.items=this.keys=this.map=this.modified=this.paramNames=this.removed=this.sortToggle=null;this.totalLength=0;},sortData:function(d,b){if(!b){b=0;}var f=this.data.items;var a=[];for(var c=0;c<f.length;c+=2){a[c/2]=[f[c],f[c+1]];}function g(m){var h=m.length;for(var o=0;o<h;o++){var k=m.shift(o);for(var n=0;n<k.length;n++){m.push(k[n]);}}return m;}return g(a.sort(function(j,h){return d?d(j[b],h[b]):j[b]>h[b];}));},sort:function(a){this.data.items=this.sortData(false,a);}});if(!ECM.Adapter.namespace("ECM.Locale")._bogus){ECM.provide("ECM.Locale");(function(){window.__strings__=window.__strings__||{};function a(c,d){d=d||{};var b=String(c||"");if(b.match(/\%\%\d+\%\%/)){b=b.replace(/\%\%(\d+)\%\%/g,function(f,g){g=(d&&d.constructor===Array)?d[parseInt(g)-1]:g;return(g||f||"");});}return b;}ECM.Locale=ECM.Adapter.apply({fetch:function(c){c=c||{};c.key=c.key||"";c.defVal=c.defVal||"("+c.key+")";var b=window.__strings__[c.key]||c.defVal;if(!c.params){return b;}return a(b,c.params);},_bogus:true});})();}if(!ECM.Adapter.namespace("ECM.Rules.Tablespace")._bogus){ECM.provide("ECM.Rules.Tablespace");ECM.modifyFlags({base:{js:"/js/",css:"/css/"}});(function(){var C=ECM.Rules.Constants;var L={AND:ECM.Locale.fetch({key:"AND"}),DEFAULT:ECM.Locale.fetch({key:"DEFAULT"}),EXCLUDE:ECM.Locale.fetch({key:"EXCLUDE"}),INCLUDE:ECM.Locale.fetch({key:"INCLUDE"}),NEW_CONDITION:ECM.Locale.fetch({key:"ADD_CONDITION"}),NEW_GROUP:ECM.Locale.fetch({key:"CREATE_GROUP"}),NEW_AGGREGATOR:gt.gettext("Create Aggregator"),OR:ECM.Locale.fetch({key:"OR"})};var logicRe=new RegExp("^("+L.AND+" "+L.INCLUDE+"|"+L.OR+" "+L.INCLUDE+"|"+L.OR+"|"+L.AND+")","ig");
var spanRe=new RegExp("<span[^>]*>(.*?)</span>","ig");var __ascendants__=__catalog__=__options__=__structs__=[];var __caches__={};var __flags__={associativeOperator:91,catalog:{},dateOperator:63,defaultAssociativeOperator:83,defaultBitmaskOperator:137,defaultOperator:29,inflight:0,nthingOperator:145,pageNum:1,pageSize:100,pageView:5,xdbExpired:{}};__options__.operators={0:["","False",1,1,"",-2,1],1:["","True",1,1,"",-2,1],2:["","(ignore)",1,2,"",-2,1],3:["","",1,3,"",-2,1],4:["","SEQUENCE of",1,4,"",-2,1],5:[L.OR.toUpperCase(),"ANY of",1,4,"",-2,1],6:[L.AND.toUpperCase(),"ALL of",1,4,"",-2,1],7:[L.EXCLUDE.toUpperCase(),"NOT",1,4,"",-2,1],8:[L.OR.toUpperCase()+" "+L.EXCLUDE.toUpperCase(),"NONE of",1,4,"",-2,1],9:[L.AND.toUpperCase()+" "+L.EXCLUDE.toUpperCase(),"NOT ALL of",1,4,"",-2,1],10:["","(pick a Boolean operator)",1,5,"",-2,1],11:["","(check or uncheck)",1,5,"|9|",-2,1],12:["","(check or uncheck)",1,5,"",-2,1],13:["","(pick a comparison operator)",1,5,"",-2,1],14:["","(pick a date-comparison operator)",1,5,"",-2,1],15:["","(pick a selection operator)",1,5,"",-2,1],16:["","(pick a ZIP-code operator)",1,5,"",-2,1],17:["Subscription","Subscription",1,6,"",-2,1],18:["","(pick a checkbox-group operator)",1,5,"",-2,1],19:["","(pick a bitmask operator)",1,5,"",-2,1],20:["","(field choice)",1,5,"",-2,1],21:["","(query exclusion)",1,5,"",-2,1],22:["","(choose an item)",1,5,"",-2,1],23:["is empty","is NULL",1,6,"|2|3|",-2,0],24:["is not empty","is NOT NULL",1,6,"|2|3|",-2,0],25:["is less than","<  (less than)",1,7,"|2|3|13|",26,1],26:["is less than","is NULL or <  (less than)",1,7,"|2|3|",-1,1],27:["is less than or equal to","<= (less than or equal to)",1,7,"|2|3|13|",28,1],28:["is less than or equal to","is NULL or <= (less than or equal to)",1,7,"|2|3|",-1,1],29:["is","=  (equals)",1,7,"|2|3|12|13|",30,1],30:["is","is NULL or =  (equals)",1,7,"|2|3|",-1,1],31:["is greater than or equal to",">= (greater than or equal to)",1,7,"|2|3|13|",32,1],32:["is greater than or equal to","is NULL or >= (greater than or equal to)",1,7,"|2|3|",-1,1],33:["is greater than",">  (greater than)",1,7,"|2|3|13|",34,1],34:["is greater than","is NULL or >  (greater than)",1,7,"|2|3|",-1,1],35:["is not","!= (not equal to)",1,7,"|2|3|13|",36,1],36:["is not","is NULL or != (not equal to)",1,7,"|2|3|",-1,1],37:["wildcard match (%) is","is LIKE",1,8,"|2|12|",38,1],38:["wildcard match (%) is","is NULL or LIKE",1,8,"|2|",-1,1],39:["wildcard match (%) is not","is NOT LIKE",1,8,"|2|",40,1],40:["wildcard match (%) is not","is NULL or NOT LIKE",1,8,"|2|",-1,1],41:["wildcard match (%) is one of","matches ANY LIKE",1,9,"|2|",42,1],42:["wildcard match (%) is one of","is NULL or matches ANY LIKE",1,9,"|2|",-1,1],43:["wildcard match (%) is none of","matches NONE LIKE",1,9,"|2|",44,1],44:["wildcard match (%) is none of","is NULL or matches NONE LIKE",1,9,"|2|",-1,1],45:["is between","is BETWEEN (inclusive)",2,10,"|2|3|13|",46,2],46:["is between","is NULL or BETWEEN (inclusive)",2,10,"|2|3|",-1,2],47:["is not between","is NOT BETWEEN (inclusive)",2,10,"|2|3|13|",48,2],48:["is not between","is NULL or NOT BETWEEN (inclusive)",2,10,"|2|3|",-1,2],49:["is one of","matches ANY of",1,11,"|2|3|13|",50,1],50:["is one of","is NULL or is ANY of",1,11,"|2|3|",-1,1],51:["is none of","matches NONE of",1,11,"|2|3|13|",52,1],52:["is none of","is NULL or matches NONE of",1,11,"|2|3|",-1,1],53:["is empty","is NULL",1,12,"|4|14|",-2,0],54:["is not empty","is NOT NULL",1,12,"|4|14|",-2,0],55:["anniversary is","has ANNIVERSARY",1,13,"|4|14|",56,1],56:["anniversary is","is NULL or has ANNIVERSARY",1,13,"|4|14|",-1,0],57:["anniversary is not","has ANNIVERSARY NOT",1,13,"|4|14|",58,1],58:["anniversary is not","is NULL or has ANNIVERSARY NOT",1,13,"|4|14|",-1,0],59:["is before","<  (before)",1,14,"|4|14|",60,1],60:["is before","is NULL or <  (before)",1,14,"|4|14|",-1,1],61:["is on or before","<= (on or before)",1,14,"|4|14|",62,1],62:["is on or before","is NULL or <= (on or before)",1,14,"|4|14|",-1,1],63:["is","=  (on)",1,14,"|4|14|",64,1],64:["is","is NULL or =  (on)",1,14,"|4|14|",-1,1],65:["is on or after",">= (on or after)",1,14,"|4|14|",66,1],66:["is on or after","is NULL or >= (on or after)",1,14,"|4|14|",-1,1],67:["is after",">  (after)",1,14,"|4|14|",68,1],68:["is after","is NULL or >  (after)",1,14,"|4|14|",-1,1],69:["is not","!= (not on)",1,14,"|4|14|",70,1],70:["is not","is NULL or != (not on)",1,14,"|4|14|",-1,1],71:["is between","is BETWEEN (inclusive)",2,15,"|4|14|",72,2],72:["is between","is NULL or BETWEEN (inclusive)",2,15,"|4|14|",-1,2],73:["is not between","is NOT BETWEEN (inclusive)",2,15,"|4|14|",74,2],74:["is not between","is NULL or NOT BETWEEN (inclusive)",2,15,"|4|14|",-1,2],75:["anniversary is between","has ANNIVERSARY BETWEEN (inclusive)",2,15,"|4|14|",76,2],76:["anniversary is between","is NULL or has ANNIVERSARY BETWEEN (inclusive)",2,15,"|4|14|",-1,2],77:["anniversary is not between","has ANNIVERSARY NOT BETWEEN (inclusive)",2,15,"|4|14|",78,2],78:["anniversary is not between","is NULL or has ANNIVERSARY NOT BETWEEN (inclusive)",2,15,"|4|14|",-1,2],79:["is on one of","is on ANY of",1,16,"",80,1],80:["is on one of","is NULL or on ANY of",1,16,"",-1,1],81:["is not on one of","is on NONE of",1,16,"",82,1],82:["is not on one of","is NULL or on NONE of",1,16,"",-1,1],83:["is one of","matches ANY of",1,16,"|1|10|11|",-2,1],84:["is none of","matches NONE of",1,16,"|1|10|11|",-2,1],85:["is empty","is NULL",1,17,"|100|",-2,0],86:["is not empty","is NOT NULL",1,17,"|100|",-2,0],87:["is less than","<  (less than)",1,18,"|100|",88,1],88:["is less than","is NULL or <  (less than)",1,18,"|100|",-1,1],89:["is less than or equal to","<= (less than or equal to)",1,18,"|100|",90,1],90:["is less than or equal to","is NULL or <= (less than or equal to)",1,18,"|100|",-1,1],91:["is","=  (equals)",1,18,"|100|",92,1],92:["is","is NULL or =  (equals)",1,18,"|100|",-1,1],93:["is greater than or equal to",">= (greater than or equal to)",1,18,"|100|",94,1],94:["is greater than or equal to","is NULL or >= (greater than or equal to)",1,18,"|100|",-1,1],95:["is greater than",">  (greater than)",1,18,"|100|",96,1],96:["is greater than","is NULL or >  (greater than)",1,18,"|100|",-1,1],97:["is not","!= (not equal to)",1,18,"|100|",98,1],98:["is not","is NULL or != (not equal to)",1,18,"|100|",-1,1],99:["wildcard match (%) is","is LIKE",1,19,"|100|",100,1],100:["wildcard match (%) is","is NULL or LIKE",1,19,"|100|",-1,1],101:["wildcard match (%) is not","is NOT LIKE",1,19,"|100|",102,1],102:["wildcard match (%) is not","is NULL or NOT LIKE",1,19,"|100|",-1,1],103:["wildcard match (%) is one of","matches ANY LIKE",1,19,"|100|",104,1],104:["wildcard match (%) is one of","is NULL or matches ANY LIKE",1,19,"|100|",-1,1],105:["wildcard match (%) is none of","matches NONE LIKE",1,19,"|100|",106,1],106:["wildcard match (%) is none of","is NULL or matches NONE LIKE",1,19,"|100|",-1,1],107:["is between","is BETWEEN (inclusive)",2,20,"|100|",108,2],108:["is between","is NULL or BETWEEN (inclusive)",2,20,"|100|",-1,2],109:["is not between","is NOT BETWEEN (inclusive)",2,20,"|100|",110,2],110:["is not between","is NULL or NOT BETWEEN (inclusive)",2,20,"|100|",-1,2],111:["is one of","matches ANY of",1,21,"|100|",112,1],112:["is one of","is NULL or is ANY of",1,21,"|100|",-1,1],113:["is not one of","matches NONE of",1,21,"|100|",114,1],114:["is not one of","is NULL or matches NONE of",1,21,"|100|",-1,1],115:["is one of","matches ANY Market Area of",1,22,"|105|",-2,1],116:["is none of","matches NO Market Area of",1,22,"|105|",-2,1],117:["is one of","matches ANY MSA of",1,23,"|103|",-2,1],118:["is none of","matches NO MSA of",1,23,"|103|",-2,1],119:["is one of","matches ANY CMSA of",1,24,"|104|",-2,1],120:["is none of","matches NO CMSA of",1,24,"|104|",-2,1],121:["is one of","matches ANY STATE of",1,25,"|101|",-2,1],122:["is none of","matches NO STATE of",1,25,"|101|",-2,1],123:["is one of","matches ANY city of ANY STATE of",1,26,"|102|",-2,1],124:["is none of","matches NO city of ANY STATE of",1,26,"|102|",-2,1],125:["is city of","matches ANY CITY of",1,27,"",-2,1],126:["is not city of","matches NO CITY of",1,27,"",-2,1],127:["is one of","matches ANY of",1,28,"|6|",-2,1],128:["is all of","matches ALL of",1,28,"|6|10|",-2,1],129:["is none of","matches NONE of",1,28,"|6|",-2,1],130:["is not all of","does NOT match ALL of",1,28,"|6|10|",-2,1],131:["is one of","matches ANY of",1,28,"",-2,1],132:["is all of","matches ALL of",1,28,"",-2,1],133:["is none of","matches NONE of",1,28,"",-2,1],134:["is not all of","does NOT match ALL of",1,28,"",-2,1],135:["is empty","is NULL",1,29,"|7|",-2,0],136:["is not empty","is NOT NULL",1,29,"|7|",-2,0],137:["is one of","matches ANY of",1,30,"|7|",138,1],138:["is one of","is NULL or is one of",1,30,"|7|",-1,1],139:["is all of","matches ALL of",1,30,"|7|",140,1],140:["is all of","is NULL or matches ALL of",1,30,"|7|",-1,1],141:["is none of","matches NONE of",1,30,"|7|",142,1],142:["is none of","is NULL or matches NONE of",1,30,"|7|",-1,1],143:["is not all of","does NOT match ALL of",1,30,"|7|",144,1],144:["is not all of","is NULL or does NOT match ALL of",1,30,"|7|",-1,1],145:["of","of",1,31,"|8|",-2,1],146:["starts with","starts with",1,32,"|12|",-2,1],147:["ends with","ends with",1,32,"|12|",-2,1],148:["contains","contains",1,32,"|12|",-2,1],149:["is one of","matches ANY of",1,33,"|201|",-2,1],150:["is none of","matches NONE of",1,33,"|201|",-2,1],151:["is one of","matches ANY state of ANY country",1,34,"|202|",-2,1],152:["is none of","matches NO state of ANY country",1,34,"|202|",-2,1],_bogus:true};
__options__.dateUnits={0:[ECM.Locale.fetch({key:"X_YEARS_FROM_NOW"}),ECM.Locale.fetch({key:"N_YEARS_FROM_NOW"}),1],1:[ECM.Locale.fetch({key:"ONE_YEAR_FROM_NOW"}),ECM.Locale.fetch({key:"ONE_YEAR_FROM_NOW"}),0],2:[ECM.Locale.fetch({key:"LAST_DAY_OF_THIS_YEAR"}),ECM.Locale.fetch({key:"DEC_THIRTY_FIRST_OF_THIS_YEAR"}),0],3:[ECM.Locale.fetch({key:"X_MONTHS_FROM_NOW"}),ECM.Locale.fetch({key:"N_MONTHS_FROM_NOW"}),1],4:[ECM.Locale.fetch({key:"ONE_MONTH_FROM_NOW"}),ECM.Locale.fetch({key:"ONE_MONTH_FROM_NOW"}),0],5:[ECM.Locale.fetch({key:"LAST_DAY_OF_THIS_MONTH"}),ECM.Locale.fetch({key:"LAST_DAY_OF_THIS_MONTH"}),0],6:[ECM.Locale.fetch({key:"X_WEEKS_FROM_NOW"}),ECM.Locale.fetch({key:"N_WEEKS_FROM_NOW"}),1],7:[ECM.Locale.fetch({key:"ONE_WEEK_FROM_NOW"}),ECM.Locale.fetch({key:"ONE_WEEK_FROM_NOW"}),0],8:[ECM.Locale.fetch({key:"X_DAYS_FROM_NOW"}),ECM.Locale.fetch({key:"N_DAYS_FROM_NOW"}),1],9:[ECM.Locale.fetch({key:"TOMORROW"}),ECM.Locale.fetch({key:"TOMORROW"}),0],10:[ECM.Locale.fetch({key:"TODAY"}),ECM.Locale.fetch({key:"TODAY"}),0],11:["%%1%%",ECM.Locale.fetch({key:"MONTH_DAY_YEAR"}),1],12:["%%1%%",ECM.Locale.fetch({key:"DAY_MONTH_YEAR"}),1],13:["%%1%%",ECM.Locale.fetch({key:"YEAR_MONTH_DAY"}),1],14:[ECM.Locale.fetch({key:"YESTERDAY"}),ECM.Locale.fetch({key:"YESTERDAY"}),0],15:[ECM.Locale.fetch({key:"THREE_DAYS_AGO"}),ECM.Locale.fetch({key:"THREE_DAYS_AGO"}),0],16:[ECM.Locale.fetch({key:"X_DAYS_AGO"}),ECM.Locale.fetch({key:"N_DAYS_AGO"}),1],17:[ECM.Locale.fetch({key:"SATURDAY_OF_THIS_WEEK"}),ECM.Locale.fetch({key:"SAT_OF_THIS_WEEK"}),0],18:[ECM.Locale.fetch({key:"FRIDAY_OF_THIS_WEEK"}),ECM.Locale.fetch({key:"FRI_OF_THIS_WEEK"}),0],19:[ECM.Locale.fetch({key:"THURSDAY_OF_THIS_WEEK"}),ECM.Locale.fetch({key:"THU_OF_THIS_WEEK"}),0],20:[ECM.Locale.fetch({key:"WEDNESDAY_OF_THIS_WEEK"}),ECM.Locale.fetch({key:"WED_OF_THIS_WEEK"}),0],21:[ECM.Locale.fetch({key:"TUESDAY_OF_THIS_WEEK"}),ECM.Locale.fetch({key:"TUE_OF_THIS_WEEK"}),0],22:[ECM.Locale.fetch({key:"MONDAY_OF_THIS_WEEK"}),ECM.Locale.fetch({key:"MON_OF_THIS_WEEK"}),0],23:[ECM.Locale.fetch({key:"SUNDAY_OF_THIS_WEEK"}),ECM.Locale.fetch({key:"SUN_OF_THIS_WEEK"}),0],24:[ECM.Locale.fetch({key:"DAY_X_OF_THIS_WEEK"}),ECM.Locale.fetch({key:"DAY_N_OF_THIS_WEEK"}),1],25:[ECM.Locale.fetch({key:"ONE_WEEK_AGO"}),ECM.Locale.fetch({key:"ONE_WEEK_AGO"}),0],26:[ECM.Locale.fetch({key:"X_WEEKS_AGO"}),ECM.Locale.fetch({key:"N_WEEKS_AGO"}),1],27:[ECM.Locale.fetch({key:"FIRST_DAY_OF_THIS_MONTH"}),ECM.Locale.fetch({key:"ONE_ST_DAY_OF_THIS_MONTH"}),0],28:[ECM.Locale.fetch({key:"DAY_X_OF_THIS_MONTH"}),ECM.Locale.fetch({key:"DAY_N_OF_THIS_MONTH"}),1],29:[ECM.Locale.fetch({key:"ONE_MONTH_AGO"}),ECM.Locale.fetch({key:"ONE_MONTH_AGO"}),0],30:[ECM.Locale.fetch({key:"X_MONTHS_AGO"}),ECM.Locale.fetch({key:"N_MONTHS_AGO"}),1],31:[ECM.Locale.fetch({key:"FIRST_DAY_OF_THIS_YEAR"}),ECM.Locale.fetch({key:"JAN_FIRST_OF_THIS_YEAR"}),0],32:[ECM.Locale.fetch({key:"DAY_X_OF_THIS_YEAR"}),ECM.Locale.fetch({key:"DAY_N_OF_THIS_YEAR"}),1],33:[ECM.Locale.fetch({key:"X_OF_THIS_YEAR"}),ECM.Locale.fetch({key:"MONTH_DAY_OF_THIS_YEAR"}),1],34:[ECM.Locale.fetch({key:"X_OF_THIS_YEAR"}),ECM.Locale.fetch({key:"DAY_MONTH_OF_THIS_YEAR"}),1],35:[ECM.Locale.fetch({key:"ONE_YEAR_AGO"}),ECM.Locale.fetch({key:"ONE_YEAR_AGO"}),0],36:[ECM.Locale.fetch({key:"X_YEARS_AGO"}),ECM.Locale.fetch({key:"N_YEARS_AGO"}),1],_bogus:true};__options__.tableAliases={EXT_DB:"E",_bogus:true};function aheadChanges(args){args=args||{};var struct=args.struct||__structs__[args.identity]||{};return ECM.Adapter.isEffective(struct.buffer.definitions.create[args.identifier]);}function assignCatalog(args){args=args||{};args.catalog=args.catalog||[];var struct=__structs__[args.id]||{};var columns=args.catalog.shift()||{};__catalog__.columns=__catalog__.columns||[];__catalog__.columns[args.tagType||struct.tagType]=columns;__catalog__.columns.all=Object.extend(__catalog__.columns.all||{},columns);if(ECM.Rules.Tablespace.isSimpleTag({struct:struct})){var key=ECM.Rules.Tablespace.findFieldByKey({key:struct.data.key,tagType:struct.tagType});var columnType=key?columns[key][C.CATALOG.COLUMN[C.TAG.SIMPLE].TYPE]:false;if(columnType==ECM.Rules.Constants.TYPES.DATE||columnType==ECM.Rules.Constants.TYPES.VIRTUAL){ECM.Subscribers.notify({bundle:[gt.gettext("Rule(s) contain invalid conditions.  Please update.")],topic:C.TOPIC.NOTIFY.ERROR});}if(ECM.Adapter.isEffective(args.key)){struct.data=struct.data||{};struct.data.key=args.key.replace(/[A-Z_][.]/,"");}}}function assignDefinition(args){args=args||{};args.bundle=args.bundle||{};args.pageNum=args.pageNum||__flags__.pageNum;var keywordId=encodeURIComponent(args.keyword||"__master__");var struct=__structs__[args.id]||{};if(!struct.data){struct.data={};}var data=struct.data;if((args.keyword||args.pageNum>1)&&(args.currentPage||0)>=args.pageNum&&(!ECM.Adapter.isArray(struct.data.values)||!struct.data.values.length)){struct.data.values=[];}if(args.keyword){var nValues=args.bundle.data.values.length;for(var identifier in struct.buffer.definitions.create){var description=struct.buffer.definitions.create[identifier][C.DATA.DEFINITION];var found=description.indexOf(args.keyword);if(found>-1){var order=0;for(var i=0;i<nValues;i++){var rowIndex=i*2;order=rowIndex;if(args.bundle.data.values[rowIndex+1]>description){break;}}Array.insertAt(args.bundle.data.values,description,order);Array.insertAt(args.bundle.data.values,identifier,order);if(args.pageNum>1){data.values.search[keywordId].count++;}else{args.bundle.data.count++;}}}for(var identifier in struct.buffer.definitions.modify){var description=struct.buffer.definitions.modify[identifier][C.DATA.DEFINITION];var position=args.bundle.data.values.indexOf(identifier);if(position>-1){args.bundle.data.values.splice(position,2);var order=0;for(var i=0;i<nValues-2;i++){var rowIndex=i*2;order=rowIndex;if(args.bundle.data.values[rowIndex+1]>description){break;}}Array.insertAt(args.bundle.data.values,description,order);Array.insertAt(args.bundle.data.values,identifier,order);}}for(var i=0,nRemoves=struct.buffer.definitions.remove.length;i<nRemoves;i++){var identifier=struct.buffer.definitions.remove[i];var position=args.bundle.data.values.indexOf(identifier);if(position>-1){args.bundle.data.values.splice(position,2);if(args.pageNum>1){data.values.search[keywordId].count--;}else{args.bundle.data.count--;}}}for(var i=0,nMoves=struct.buffer.definitions.move.length;i<nMoves;i++){var identifier=struct.buffer.definitions.move[i][C.DATA.FIRST];var newValue=struct.buffer.definitions.move[i][C.DATA.MEMBER];var position=args.bundle.data.values.indexOf(identifier);if(position>-1){args.bundle.data.values[position]=newValue;}}}if(args.pageNum>1){var remainder;var adjustments=[];var counts=0;var originals={};var search={};var packages={adjustment:0,start:((args.pageNum-1)*__flags__.pageSize)};if(args.keyword){adjustments=data.values.search[keywordId].adjustments||[];counts=data.values.search[keywordId].count||0;}else{adjustments=data.values.adjustments||[];originals=data.values.originals||{};search=data.values.search||{};}packages.adjustment=ECM.Rules.Tablespace.adjustment({identity:args.id,keyword:args.keyword,pageNum:(args.currentPage||args.pageNum),struct:struct});packages.start+=packages.adjustment;(packages.start<0)&&(packages.start=0);packages.start*=2;packages.end=packages.start+(__flags__.pageSize*2);var currentLen=(args.keyword)?data.values.search[keywordId].length:data.values.length;if(packages.start>Math.ceil(currentLen/2)){if(args.keyword){(!data.values.search[keywordId][packages.start-1])&&(data.values.search[keywordId][packages.start-1]=undefined);data.values.search[keywordId]=data.values.search[keywordId].concat(args.bundle.data.values);data.values.search[keywordId].adjustments=adjustments;data.values.search[keywordId].count=counts;}else{(!data.values[packages.start-1])&&(data.values[packages.start-1]=undefined);data.values=data.values.concat(args.bundle.data.values);data.values.adjustments=adjustments;data.values.originals=originals;data.values.search=search;
}}else{packages.merged=[];if(args.keyword){packages.sliced=data.values.search[keywordId].splice(packages.start,(__flags__.pageSize*2));}else{packages.sliced=data.values.splice(packages.start,(__flags__.pageSize*2));}packages.threshold=Math.max(packages.sliced.length,args.bundle.data.values.length);var A=0,B=0,D=0;while(A<packages.threshold&&B<packages.threshold){if(ECM.Adapter.isEffective(packages.sliced[B])&&(args.bundle.data.values[A]>=packages.sliced[B])){packages.merged[D++]=packages.sliced[B++];packages.merged[D++]=packages.sliced[B++];}else{packages.merged[D++]=args.bundle.data.values[A++];packages.merged[D++]=args.bundle.data.values[A++];}}if(args.keyword){remainder=data.values.search[keywordId].splice(packages.start,100000);data.values.search[keywordId]=data.values.search[keywordId].concat(packages.merged);data.values.search[keywordId]=data.values.search[keywordId].concat(remainder);data.values.search[keywordId].adjustments=adjustments;data.values.search[keywordId].count=counts;var delta=Math.ceil(packages.merged.length/2)-__flags__.pageSize;(delta)&&(data.values.search[keywordId].adjustments[args.pageNum]=delta);}else{remainder=data.values.splice(packages.start,100000);data.values=data.values.concat(packages.merged);data.values=data.values.concat(remainder);data.values.adjustments=adjustments;data.values.originals=originals;data.values.search=search;var delta=Math.ceil(packages.merged.length/2)-__flags__.pageSize;(delta)&&(data.values.adjustments[args.pageNum]=delta);}args.bundle.data.values=packages.merged.slice(0,__flags__.pageSize);}}else{if(args.keyword){struct.data=struct.data||{};struct.data.values=struct.data.values||[];struct.data.values.search=struct.data.values.search||{};struct.data.values.search[keywordId]=args.bundle.data.values.slice(0);struct.data.values.search[keywordId].count=args.bundle.data.count;data=struct.data;}else{data=struct.data=args.bundle.data;}}if(args.keyword){struct.pages.search[keywordId]=struct.pages.search[keywordId]||[];struct.pages.search[keywordId][args.pageNum]=C.YES;}else{struct.pages[args.pageNum]=C.YES;}struct.tagType=(struct.data.rules)?C.TAG.ADVANCED:C.TAG.SIMPLE;if(struct.tagType===C.TAG.SIMPLE){data.values.adjustments=data.values.adjustments||[];}else{for(var i=0,nRules=struct.data.rules.length;i<nRules;i++){struct.data.rules[i].original=i;}}}function associative(id,columnId,tagType,listSize){tagType=tagType||C.TAG.SIMPLE;var columns=__catalog__.columns||[];var columnList=columns.all||{};var associativeList=(columnList[columnId]||[])[C.CATALOG.COLUMN[tagType].ASSOCIATIVE]||[];var index=associativeList.indexOf(id);if(index<0){index=associativeList.indexOf(String(id));}if(table(columnId)===__options__.tableAliases.EXT_DB&&index<0){__flags__.xdbExpired[id]=ECM.Adapter.useEffective(__flags__.xdbExpired[id],0);if(__flags__.xdbExpired[id]++<1){ECM.Adapter.namespace("ECM.Targeting.Store.XDB");var name=ECM.Targeting.Store.XDB.getName?ECM.Targeting.Store.XDB.getName(id):"";name=name||"("+id+")";if(ECM.Stash&&ECM.Stash.xdbs&&Ext.isArray(ECM.Stash.xdbs)){Ext.each(ECM.Stash.xdbs,function(xdb){if(xdb[0]==id){name=xdb[2];return false;}});}ECM.publish("/notify/error",{message:gt.strargs(gt.gettext("The XDB file %1 has expired. Please select another XDB filename."),[name]),width:500});}}var retVal=(index>-1)?associativeList[(index+1)]:"("+id+")";if(retVal.match(/empty \(no value\)|NULL \(empty\, unspecified\)/i)){retVal=listSize?"and include empty (no value)":"empty (no value)";}return retVal;}function bitmask(values,columnId,tagType){tagType=tagType||C.TAG.SIMPLE;var columns=__catalog__.columns||[];var columnList=columns.all||{};var associativeList=(columnList[columnId]||[])[C.CATALOG.COLUMN[tagType].ASSOCIATIVE]||[];values=(ECM.Adapter.isArray(values))?values:[values];var value=values[C.OPERANDS.FIRST][C.DATA.VALUE]||0;var response=[];for(var i=0,nItems=associativeList.length/2;i<nItems;i++){var itemIndex=i*2;if(!!(value&Math.pow(2,associativeList[itemIndex]))){response.push(associativeList[itemIndex+1]);}}return response.join(", ");}function bucketAdjustments(args){args=args||{};if(args.struct&&ECM.Rules.Tablespace.isSimpleTag({struct:args.struct})){if(args.keyword){var keywordId=encodeURIComponent(args.keyword);args.struct.data.values.search=args.struct.data.values.search||{};args.struct.data.values.search[keywordId]=args.struct.data.values.search[keywordId]||[];args.struct.data.values.search[keywordId].adjustments=args.struct.data.values.search[keywordId].adjustments||[];var pageIndex=args.pageNum-1;(pageIndex<0)&&(pageIndex=0);args.struct.data.values.search[keywordId].adjustments[pageIndex]=args.struct.data.values.search[keywordId].adjustments[pageIndex]||0;switch(args.direction){case"addition":args.struct.data.values.search[keywordId].adjustments[pageIndex]++;break;case"reduction":args.struct.data.values.search[keywordId].adjustments[pageIndex]--;break;}}else{args.struct.data.values.adjustments=args.struct.data.values.adjustments||[];var pageIndex=args.pageNum-1;(pageIndex<0)&&(pageIndex=0);args.struct.data.values.adjustments[pageIndex]=args.struct.data.values.adjustments[pageIndex]||0;switch(args.direction){case"addition":args.struct.data.values.adjustments[pageIndex]++;break;case"reduction":args.struct.data.values.adjustments[pageIndex]--;break;}}}}function buffer(bufferType,args){if(window.ecmTargetingModeOn){return false;}args=args||{};ECM.Subscribers.notify({topic:C.TOPIC.NOTIFY.CLEAR});var struct=__structs__[args.identity||"__create__"]||{};var isSimpleTag=ECM.Rules.Tablespace.isSimpleTag({struct:struct});switch(bufferType){case"clear":var mover=struct.buffer.definitions.move;var originals=(isSimpleTag)?(struct.data.values.originals||{}):(struct.data.rules||{});for(var i=0,nMover=mover.length;i<nMover;i++){if(isSimpleTag){delete originals[mover[i][C.DATA.MEMBER]];}else{delete originals[mover[i][C.DATA.DEFINITION]].original;}}struct.buffer=bufferDefaults();break;case"create":if(aheadChanges({identifier:args.identifier,identity:args.identity,struct:struct})){if(args.data){struct.buffer.definitions.create[args.identifier][C.DATA.DEFINITION]=args.data;}if(args.content){struct.buffer.definitions.create[args.identifier][C.DATA.MEMBER]=args.content;}}else{var entry=[];entry[C.DATA.DEFINITION]=args.data||null;entry[C.DATA.MEMBER]=args.content||null;struct.buffer.definitions.create[args.identifier]=entry;}break;case"default":if(ECM.Adapter.isEffective(struct.buffer.definitions.defaults)){struct.buffer.definitions.defaults[C.DATA.VALUE]=args.data;}else{struct.buffer.definitions.defaults=[args.data,null];}break;case"defaultContent":if(ECM.Adapter.isEffective(struct.buffer.definitions.defaults)){struct.buffer.definitions.defaults[C.DATA.MEMBER]=args.data;}else{struct.buffer.definitions.defaults=[null,args.data];}break;case"description":case"key":case"tags":case"name":case"wrap_width":struct.buffer[bufferType]=args.data;break;case"modify":if(aheadChanges({identifier:args.identifier,identity:args.identity,struct:struct})){struct.buffer.definitions.create[args.identifier][C.DATA.DEFINITION]=args.data;}else{if(ECM.Adapter.isEffective(struct.buffer.definitions.modify[args.identifier])){struct.buffer.definitions.modify[args.identifier][C.DATA.DEFINITION]=args.data;}else{struct.buffer.definitions.modify[args.identifier]=[args.data,null];}}break;case"modifyContent":if(aheadChanges({identifier:args.identifier,identity:args.identity,struct:struct})){struct.buffer.definitions.create[args.identifier][C.DATA.MEMBER]=args.data;}else{if(ECM.Adapter.isEffective(struct.buffer.definitions.modify[args.identifier])){struct.buffer.definitions.modify[args.identifier][C.DATA.MEMBER]=args.data;}else{struct.buffer.definitions.modify[args.identifier]=[null,args.data];}}break;case"move":args.identifier=args.identifier||args.data[C.DATA.VALUE];var newValue=args.data[C.DATA.MEMBER];if(aheadChanges({identifier:args.identifier,identity:args.identity,struct:struct})){struct.buffer.definitions.create[newValue]=struct.buffer.definitions.create[args.identifier].slice(0);
delete struct.buffer.definitions.create[args.identifier];if(isSimpleTag){delete struct.data.values.originals[newValue];}}else{struct.buffer.definitions.move.push(args.data);}break;case"remove":args.identifier=args.identifier||args.data;if(aheadChanges({identifier:args.identifier,identity:args.identity,struct:struct})){delete struct.buffer.definitions.create[args.identifier];if(isSimpleTag){if(struct.data.values.length==0){delete struct.data.key;}delete struct.data.values.originals[args.identifier];}else{for(var k in struct.buffer.definitions.create){var keyNum=String.toInt(k);if(keyNum>args.identifier){struct.buffer.definitions.create[(keyNum-1)]=Array.clone(struct.buffer.definitions.create[k]);delete struct.buffer.definitions.create[k];}}}}else{struct.buffer.definitions.remove.push(args.data);}break;}if(ECM.Adapter.isEffective(args.dirty)){ECM.Rules.Tablespace.dirty({id:args.identity,value:args.dirty});}if(ECM.Adapter.isEffective(args.content)){ECM.Rules.Tablespace.dirty({id:args.identity,value:C.DIRTY.CONTENT});}}function bufferClear(args){return buffer("clear",args);}function bufferCreate(args){return buffer("create",args);}function bufferDefault(args){return buffer("default",args);}function bufferDefaultContent(args){return buffer("defaultContent",args);}function bufferDefaults(){return{definitions:{create:{},modify:{},move:[],remove:[]}};}function bufferDescription(args){return buffer("description",args);}function bufferLibraryTags(args){return buffer("tags",args);}function bufferKey(args){return buffer("key",args);}function bufferModify(args){return buffer("modify",args);}function bufferModifyContent(args){return buffer("modifyContent",args);}function bufferMove(args){return buffer("move",args);}function bufferName(args){return buffer("name",args);}function bufferRemove(args){return buffer("remove",args);}function bufferWrap(args){return buffer("wrap_width",args);}function column(id,tagType){tagType=tagType||C.TAG.SIMPLE;var columns=__catalog__.columns||[];var columnList=columns.all||{};return(columnList[id]||[])[C.CATALOG.COLUMN[tagType].LABEL]||"("+id+")";}function doPage(args){var value=C.NO;if(args&&ECM.Adapter.isEffective(args.identity)){args.value=(ECM.Adapter.isEffective(args.value))?args.value:(args.defaultValue||C.NO);var keywordId=encodeURIComponent(args.keyword||"__master__");var struct=__structs__[args.identity]||{};if(args.keyword){value=struct.pages.search[keywordId][args.pageNum];struct.pages.search[keywordId][args.pageNum]=args.value;}else{value=struct.pages[args.pageNum];struct.pages[args.pageNum]=args.value;}}return value;}function errorMessageFromJson(json){var errorMessage="";Ext.each(["error","authorization_errors","application_errors"],function(i){if(json[i]&&json[i][0]){errorMessage=json[i][0];return false;}});return errorMessage;}function failure(err){ECM.Subscribers.notify({topic:C.TOPIC.LOADING.HIDE_ALL});ECM.Subscribers.notify({bundle:[err.message||ECM.Locale.fetch({key:"THE_SYSTEM_ENCOUNTERED_PROBLEM"})],topic:C.TOPIC.NOTIFY.ERROR});}function firstIndexFromPath(args){args=args||{};return String.toInt(((args.path||"").split(args.separator)||[]).shift());}function aggregator(logic){var C=ECM.Rules.Constants;var aggregators=C.LOGIC_AGGREGATORS;for(var key in C.LOGIC){if((aggregators.indexOf(key)>-1)&&(logic&C.LOGIC[key])){return key.toLowerCase();}}return false;}function operator(id,typeId,renderMode){renderMode=renderMode||C.CATALOG.OPERATOR.STANDARD;(typeId===C.TYPES.BEHAVIOR)&&(id=__flags__.defaultOperator);var operatorLabel=((__options__.operators||[])[id]||[])[renderMode];return(ECM.Adapter.isEffective(operatorLabel))?operatorLabel:"("+id+")";}function operands(values,args){args=args||{};args.renderMode=args.renderMode||C.CATALOG.OPERATOR.STANDARD;args.tagType=args.tagType||C.TAG.SIMPLE;var isStandard=(args.renderMode===C.CATALOG.OPERATOR.STANDARD);var response=[[],[]];var hideNoValueStr=false;switch(args.typeId){case C.TYPES.ASSOCIATIVE:case C.TYPES.SUBSCRIPTION:case C.TYPES.VIRTUAL:case C.TYPES.ZIP_STATE:case C.TYPES.ZIP_CSTATE:case C.TYPES.ZIP_MSA:case C.TYPES.ZIP_CMSA:case C.TYPES.ZIP_MA:case C.TYPES.PLATFORM:case C.TYPES.GEOLOCATION:var rangesList=(args.typeId===C.TYPES.ASSOCIATIVE)?"|45|46|47|48|":"";var ranges=(rangesList.indexOf(args.operatorId)>-1);values=(ECM.Adapter.isArray(values))?values:[values];ECM.Adapter.each(values,function(value,index){var notDefined=((!index||(ranges&&index))&&!(value||[]).length);if(notDefined){response[index]="- "+ECM.Locale.fetch({key:"NOT_DEFINED"});}else{ECM.Adapter.each(value,function(val,idx){response[index].push(associative(val,args.columnId,args.tagType,response[index].length));});if(args.typeId!=C.TYPES.SUBSCRIPTION){response[index]=(ECM.Adapter.isArray(response[index]))?response[index].join(", "):response[index];}}});if(args.typeId==C.TYPES.SUBSCRIPTION){Ext.each(response,function(value,index){if(Ext.isArray(value)&&value.length>0){var tmpResponse=[],invalidCounter=0;Ext.each(value,function(val,i){if(val!="()"){var regexInvalidSub=new RegExp(/^\(\d+\)$/);if(regexInvalidSub.test(val)){invalidCounter++;}else{tmpResponse.push(val);}}});var txt=tmpResponse.length>0?tmpResponse.join(", "):"";if(txt==""){txt+=invalidCounter>0?invalidCounter+" Subscription List(s)":"";}else{txt+=invalidCounter>0?", or "+invalidCounter+" other Subscription List(s)":"";}response[index]=txt;}});}(ranges&&response.length>1)&&(Array.insertAt(response,L.AND.toLowerCase(),1));break;case C.TYPES.BEHAVIOR:hideNoValueStr=true;var columnInfo=__catalog__.columns[2][args.columnId];if(columnInfo[3]&&columnInfo[3].length>0){var boolValue=parseInt(values[C.OPERANDS.FIRST].join(""))||0;var display;for(var idx=0;idx<columnInfo[3].length;idx+=2){var enumValue=parseInt(columnInfo[3][idx])||0;if(enumValue==boolValue){display=columnInfo[3][idx+1];break;}}response[C.OPERANDS.FIRST].push(display);}else{response[C.OPERANDS.FIRST].push(ECM.Locale.fetch({key:((!!String.toInt(values[C.OPERANDS.FIRST]))?"SET":"NOT_SET")}));}break;case C.TYPES.BITMASK:response[C.OPERANDS.FIRST].push(bitmask(values,args.columnId,args.tagType));break;case C.TYPES.DATE:case C.TYPES.DATETIME:var ranges=("|71|72|73|74|75|76|77|78|".indexOf("|"+args.operatorId+"|")>-1);ECM.Adapter.each(values,function(value,index){if(Ext.isArray(value[0])){value=value[0];}if(ranges||(!ranges&&index<1)){var dateUnit=value[C.DATE.UNIT];if(ECM.Adapter.isEffective(dateUnit)&&dateUnit!==L.NEW_CONDITION&&dateUnit!==""){var bundle={defVal:__options__.dateUnits[dateUnit][args.renderMode]};var addSlashes=("|11|12|13|33|34|".indexOf("|"+dateUnit+"|")>-1);var hasValue=("|0|3|6|8|11|12|13|16|24|26|28|30|32|33|34|36|".indexOf("|"+dateUnit+"|")>-1);if(hasValue){var val=value[C.DATE.VALUE];val=(ECM.Adapter.isEffective(val))?val:"";if(addSlashes){val=String(val).replace(/ /g,"/");if(!isStandard){val=classicDate(val,dateUnit);}}bundle.params=[val];}response[index]=ECM.Locale.fetch(bundle);}if(args.typeId===C.TYPES.DATETIME&&String(value[value.length-1]).match(/^\d\d:\d\d$/)){response[index]=response[index]+gt.strargs(gt.gettext(" at %1"),String(value[value.length-1]));}}});(ranges&&response.length>1)&&(Array.insertAt(response,L.AND.toLowerCase(),1));break;case C.TYPES.NTHING:var result=[];result.push(values[C.OPERANDS.FIRST][C.DATA.VALUE]);result.push(operator(__flags__.nthingOperator,args.typeId,args.renderMode));result.push(values[C.OPERANDS.FIRST][C.DATA.MEMBER]);response[C.OPERANDS.FIRST].push(result.join(" "));break;case C.TYPES.ZIP:var ranges=("|107|108|109|110|".indexOf(args.operatorId)>-1);ECM.Adapter.each(values,function(value,index){response[index]=(ECM.Adapter.isArray(value))?value.join(", "):value;});(ranges&&response.length>1)&&(Array.insertAt(response,L.AND.toLowerCase(),1));break;case C.TYPES.MAILING:var bad=[];Ext.each(values[0],function(value,index){value=Ext.util.Format.trim(value);if(ECM.Stash.mailings_used[value]){response[0].push(ECM.Stash.mailings_used[value][0]);}else{bad.push(value);}});if(bad.length>0){response[0].push("("+bad.join(",")+")");}response[0]=response[0].join(", ");
break;default:var ranges=("|45|46|47|48|".indexOf(args.operatorId)>-1);ECM.Adapter.each(values,function(value,index){response[index]=(ECM.Adapter.isArray(value))?value.join(", "):value;});(ranges&&response.length>1)&&(Array.insertAt(response,L.AND.toLowerCase(),1));if("|"+C.TYPES.STRING+"|"+C.TYPES.EMAIL+"|".indexOf("|"+args.typeId+"|")>-1&&String.trim(((ECM.Adapter.isArray(response[C.OPERANDS.FIRST]))?response[C.OPERANDS.FIRST].join(""):response[C.OPERANDS.FIRST])||"")!==""){response[C.OPERANDS.FIRST]="'"+response[C.OPERANDS.FIRST]+"'";}break;}response=String.trim(response.join(" "));if(isStandard){var noValue="|26|28|30|32|34|36|38|40|42|44|46|48|50|52|56|58|60|62|64|66|68|70|72|74|76|78|80|82|88|90|92|94|96|98|100|102|104|106|108|110|112|114|138|140|142|144|146|147|201|202";if(!hideNoValueStr&&noValue.indexOf("|"+args.operatorId+"|")>-1){if(response.length>0){response+=", "+gt.gettext("and include empty (no value)");}else{response+=gt.gettext("empty (no value)");}}}return response;}function classicDate(val,dateUnit){var dateArray=val.split("/");var d;if(dateUnit=="11"){d=new Date(val);}else{if(dateUnit=="12"){d=new Date(dateArray[1]+"/"+dateArray[0]+"/"+dateArray[2]);}else{if(dateUnit=="13"){d=new Date(dateArray[1]+"/"+dateArray[2]+"/"+dateArray[0]);}else{if(dateUnit=="33"){d=new Date;d.setMonth(dateArray[0]-1);d.setDate(dateArray[1]);}else{if(dateUnit=="34"){d=new Date;d.setMonth(dateArray[1]-1);d.setDate(dateArray[0]);}}}}}if("|33|34|".indexOf("|"+dateUnit+"|")>-1){val=d.format("d-M");}else{val=d.format("d-M-Y");}return val;}function operandsAreEqual(operandsVal){operandsVal=operandsVal||[[],[]];var response=false;if(operandsVal[C.OPERANDS.FIRST][C.DATA.VALUE]===operandsVal[C.OPERANDS.SECOND][C.DATA.VALUE]){if(!ECM.Adapter.isEffective(operandsVal[C.OPERANDS.FIRST][C.DATA.MEMBER])&&!ECM.Adapter.isEffective(operandsVal[C.OPERANDS.SECOND][C.DATA.MEMBER])){response=true;}else{if(operandsVal[C.OPERANDS.FIRST][C.DATA.MEMBER]===operandsVal[C.OPERANDS.SECOND][C.DATA.MEMBER]){response=true;}}}return response;}function properties(args){args=args||{};(this.bundle)&&(Object.extend(args,this.bundle));args.callback=args.callback||function(){};if(!args.id){args.callback({});return false;}var keywordId=encodeURIComponent(args.keyword||"__master__");var struct=__structs__[args.id]=(__structs__[args.id]||structDefaults(args));if(args.id==="__create__"||struct.isAmbivalent||args.isAmbivalent){__catalog__.columns=__catalog__.columns||[];if(ECM.Adapter.isEffective(__catalog__.columns[C.TAG.SIMPLE])){struct.data=struct.data||{};struct.data.content=struct.data.content||[];struct.data.count=struct.data.count||0;struct.data.defaults=struct.data.defaults||[];struct.data.values=struct.data.values||[];if(struct.isAmbivalent||args.isAmbivalent){struct.data.key=struct.data.key||struct.key;struct.data.name=(args.id==="__create__")?"":args.id;}}else{ECM.Rules.Tablespace.fetchField({callback:ECM.hitch({bundle:args},arguments.callee),currentPage:args.currentPage,dcid:args.dcid,desiredAid:args.desiredAid,id:args.id,isAmbivalent:args.isAmbivalent,key:args.key,mfid:args.mfid,mid:args.mid,mailingType:args.mailingType,pageNum:__flags__.pageNum,useLibrary:args.useLibrary});return false;}}else{args=Object.extend(args,ECM.Rules.Tablespace.otherIdentities(args.id));if("|content|targetingAndContent|".indexOf("|"+args.handleAs+"|")>-1){struct.data=struct.data||{};struct.data.content=struct.data.content||[];if(!ECM.Adapter.isArray(struct.data.content[args.rowIndex])){ECM.Rules.Tablespace.fetchContent({callback:ECM.hitch({bundle:args},arguments.callee),currentPage:args.currentPage,dcid:args.dcid,desiredAid:args.desiredAid,id:args.id,isAmbivalent:args.isAmbivalent,key:args.key,mfid:args.mfid,mid:args.mid,mailingType:args.mailingType,rowIndex:args.rowIndex,useLibrary:args.useLibrary});return false;}}else{args.pageNum=args.pageNum||__flags__.pageNum;if(args.keyword){struct.pages.search[keywordId]=struct.pages.search[keywordId]||[];}if(Object.isEmpty(struct.data)||(args.keyword&&!struct.pages.search[keywordId][args.pageNum])||(!args.keyword&&!struct.pages[args.pageNum])){ECM.Rules.Tablespace.fetchDefinition({callback:ECM.hitch({bundle:args},arguments.callee),currentPage:args.currentPage,dcid:args.dcid,desiredAid:args.desiredAid,id:args.id,isAmbivalent:args.isAmbivalent,key:args.key,keyword:args.keyword,mfid:args.mfid,mid:args.mid,mailingType:args.mailingType,pageNum:args.pageNum,useLibrary:args.useLibrary});return false;}}}var parcel={tagType:struct.tagType};(args.bundle)&&(parcel.bundle=args.bundle);var isSimpleTag=ECM.Rules.Tablespace.isSimpleTag({struct:struct});var data=struct.data||{};data.content=data.content||[];args.rowIndex=String.toInt(args.rowIndex);switch(args.handleAs){case"content":parcel.content=(data.content[args.rowIndex]||[]).slice(0);break;case"targeting":if(isSimpleTag){var rowIndex=args.rowIndex*2;parcel.defaults=data.defaults||[];parcel.key=data.key||"";var values=(args.keyword)?data.values.search[keywordId]:data.values;parcel.rule=(rowIndex===values.length)?[[64],parcel.defaults[C.DATA.DESCRIPTION]||L.DEFAULT]:[values[rowIndex],values[rowIndex+1]];}else{parcel.rule=data.rules[args.rowIndex];}break;case"targetingAndContent":parcel.content=(data.content[args.rowIndex]||[]).slice(0);if(isSimpleTag){var rowIndex=args.rowIndex*2;parcel.defaults=data.defaults||[];parcel.key=data.key||"";var values=data.values||[];parcel.rule=(rowIndex===values.length)?[[64],parcel.defaults[C.DATA.DESCRIPTION]||L.DEFAULT]:[values[rowIndex],values[rowIndex+1]];}else{parcel.rule=data.rules[args.rowIndex];}break;default:parcel.description=data.description||"";parcel.name=data.name||"";parcel.tags=data.tags||[];if(isSimpleTag){parcel.key=data.key||"";(args.pageNum<1)&&(args.pageNum=1);var start=((args.pageNum-1)*__flags__.pageSize);(start<0)&&(start=0);var end=start+__flags__.pageSize;var values=(args.keyword)?data.values.search[keywordId]:data.values;parcel.rules=values.slice((start*2),(end*2));if(!args.keyword&&args.pageNum===ECM.Rules.Tablespace.totalPages({identity:args.id,keyword:args.keyword})){var defLabel=(data.defaults||[])[C.DATA.DESCRIPTION]||L.DEFAULT;parcel.rules=parcel.rules.concat([[64],defLabel]);}}else{parcel.rules=data.rules;}break;}args.callback(parcel);}function structDefaults(args){args=args||{};var buffer=ECM.Adapter.decode(unescape(args.buffer))||bufferDefaults();var pages=[];pages.search={};if(!ECM.Adapter.isArray(__catalog__.meta)){__catalog__.meta=[];__catalog__.meta.dcid=-1;if(ECM.Tablespace&&ECM.Tablespace.get){__catalog__.meta.desiredAid=ECM.Tablespace.get("aid")||-1;__catalog__.meta.mfid=ECM.Tablespace.get("mfid")||0;__catalog__.meta.mid=ECM.Tablespace.get("mid")||-1;__catalog__.meta.mailingType=ECM.Tablespace.get("mtype")||C.MAILING.BULK;}}return{data:{key:args.key},dcid:(ECM.Adapter.isEffective(args.dcid))?args.dcid:__catalog__.meta.dcid,desiredAid:args.desiredAid||__catalog__.meta.desiredAid,buffer:buffer,dirty:((!!args.isAmbivalent)?C.DIRTY.NAME:C.DIRTY.NONE),id:args.id,isAmbivalent:!!args.isAmbivalent,key:args.key,mfid:args.mfid||__catalog__.meta.mfid,mid:args.mid||__catalog__.meta.mid,mailingType:String.toInt(args.mailingType||__catalog__.meta.mailingType),onClose:args.onClose,onSave:args.onSave,pageNum:args.pageNum||__flags__.pageNum,pages:pages,saved:[],tagType:C.TAG.SIMPLE,totalPages:{},useLibrary:args.useLibrary||0};}function table(id){var columns=__catalog__.columns||[];var columnList=columns.all||{};return(columnList[id]||[])[C.CATALOG.COLUMN[C.TAG.ADVANCED].TABLE]||"("+id+")";}function truncate(args){args=args||{};(!args.structOnly)&&(__catalog__=[]);if(!args.catalogOnly){if(args.id){delete __ascendants__[args.id];delete __structs__[args.id];}else{__structs__=[];}}}truncate();function type(columnId,tagType){tagType=tagType||C.TAG.SIMPLE;var columns=__catalog__.columns||[];var columnList=columns.all||{};var typeId=Number((columnList[columnId]||[])[C.CATALOG.COLUMN[tagType].TYPE])||C.TYPES.STRING;return(ECM.Adapter.isEffective(typeId))?typeId:C.TYPES.STRING;}ECM.Rules.Tablespace=ECM.Adapter.apply({addRule:function(args){if(args){var rules=[ECM.Locale.fetch({key:"NEW_RULE"})];
var struct=__structs__[args.identity]||{};if(ECM.Rules.Tablespace.isSimpleTag({struct:struct})){rules.unshift(L.NEW_CONDITION);}return ECM.Rules.Tablespace.insertRule({data:{content:[],rules:rules},identity:args.identity,pageNum:args.pageNum});}return false;},addCondition:function(args){if(!window.ecmTargetingModeOn){return this.addConditionDC(args);}if(args){var newCondition=args.data||[[17,,null,null,[[]]]];var rule=__structs__[args.identity].data.rules[String.toInt(args.rowIndex)];rule[C.DATA.MEMBER]=rule[C.DATA.MEMBER]||[];if(!(newCondition[C.DATA.DEFINITION][C.IDX.LOGIC]&(C.LOGIC.OR+C.LOGIC.AND))){if(rule[C.DATA.MEMBER].length>0){var ruleIndex=C.DATA.FIRST;if(rule[C.DATA.MEMBER].length>1){ruleIndex=1;}var targetLogic=rule[C.DATA.MEMBER][ruleIndex][C.DATA.DEFINITION][C.IDX.LOGIC];newCondition[C.DATA.DEFINITION][C.IDX.LOGIC]|=(!!(targetLogic&C.LOGIC.OR))?C.LOGIC.OR:C.LOGIC.AND;}else{newCondition[C.DATA.DEFINITION][C.IDX.LOGIC]|=C.LOGIC.AND;}}rule[C.DATA.MEMBER].push(newCondition);return newCondition;}return false;},addConditionDC:function(args){if(args){var newCondition=[[17,,null,null,[[]]]];var rule=__structs__[args.identity].data.rules[String.toInt(args.rowIndex)];rule[C.DATA.MEMBER]=rule[C.DATA.MEMBER]||[];if(rule[C.DATA.MEMBER].length>0){var targetLogic=rule[C.DATA.MEMBER][C.DATA.FIRST][C.DATA.DEFINITION][C.IDX.LOGIC];newCondition[C.DATA.DEFINITION][C.IDX.LOGIC]|=(!!(targetLogic&C.LOGIC.OR))?C.LOGIC.OR:C.LOGIC.AND;}else{newCondition[C.DATA.DEFINITION][C.IDX.LOGIC]|=C.LOGIC.AND;}rule[C.DATA.MEMBER].push(newCondition);return newCondition;}return false;},addGroup:function(args){if(args){args.children=args.children||[];args.rowIndex=String.toInt(args.rowIndex);args.groupName=args.groupName||L.NEW_GROUP;if(args.isAggregator){args.groupName=args.aggName||L.NEW_AGGREGATOR;}var logic=(args.logic&&args.logic&C.LOGIC.EXCLUDE)?34:18;var aggTableFromColumn=(args.columnId&&__catalog__.columns[2][args.columnId])?__catalog__.columns[2][args.columnId][2]:"";var aggTable=args.tableId?args.tableId:aggTableFromColumn;if(args.aggCondition){logic=args.aggCondition[C.IDX.LOGIC];aggTable=args.aggCondition[C.IDX.TABLE];}else{if(args.isAggregator){logic=aggTable?278:22;}}var response={group:[[logic,args.groupName]]};var nChildren=args.children.length;var struct=__structs__[args.identity]||{};var data=struct.data.rules[args.rowIndex];data[C.DATA.MEMBER]=data[C.DATA.MEMBER]||[];if(args.isAggregator){response.group[C.DATA.DEFINITION].push(args.aggCondition||[logic,aggTable,"","",[]]);}if(nChildren){response.group[C.DATA.MEMBER]=[];for(var i=0;i<nChildren;i++){response.group[C.DATA.MEMBER].push(ECM.Rules.Tablespace.findRuleByPath({data:data[C.DATA.MEMBER],path:args.children[i],separator:args.separator,wholeRow:C.YES}).slice(0));response.last=args.children[i];}var targetRule=ECM.Rules.Tablespace.findRuleByPath({data:data[C.DATA.MEMBER],path:response.last,separator:args.separator});var targetLogic=args.useLogic?args.logic:targetRule[C.IDX.LOGIC];response.group[C.DATA.DEFINITION][C.IDX.LOGIC]|=(!!(targetLogic&C.LOGIC.OR))?C.LOGIC.OR:C.LOGIC.AND;var lastIndex=ECM.Rules.Tablespace.lastIndexFromPath({path:response.last,separator:args.separator});Array.insertAt(targetRule.parentNode,response.group,(lastIndex+1));response.removed=[];for(var i=nChildren-1;i>=0;i--){var rule=ECM.Rules.Tablespace.findRuleByPath({data:data[C.DATA.MEMBER],path:args.children[i],separator:args.separator});lastIndex=ECM.Rules.Tablespace.lastIndexFromPath({path:args.children[i],separator:args.separator});response.removed.push(rule.parentNode.splice(lastIndex,1));}}else{if(data[C.DATA.MEMBER].length>0){var ruleIndex=C.DATA.FIRST;if(data[C.DATA.MEMBER].length>1){ruleIndex=1;}var targetLogic=data[C.DATA.MEMBER][ruleIndex][C.DATA.DEFINITION][C.IDX.LOGIC];response.group[C.DATA.DEFINITION][C.IDX.LOGIC]|=(!!(targetLogic&C.LOGIC.OR))?C.LOGIC.OR:C.LOGIC.AND;}data[C.DATA.MEMBER].push(response.group);}var identifier=ECM.Rules.Tablespace.identifier({rowIndex:args.rowIndex,struct:struct});bufferModify({data:data,dirty:C.DIRTY.TARGETING,identifier:identifier,identity:args.identity});return response;}return false;},adjustment:function(args){var adjusted=0;args=args||{};if(!ECM.Adapter.isEffective(args.identity)){return adjusted;}var struct=args.struct||__structs__[args.identity]||{};if(!ECM.Rules.Tablespace.isSimpleTag({struct:struct})){return adjusted;}var adjustList=[];if(args.keyword){var keywordId=encodeURIComponent(args.keyword||"__master__");adjustList=struct.data.values.search[keywordId].adjustments||[];}else{adjustList=struct.data.values.adjustments||[];}var nAdjusted=adjustList.length;args.pageNum=String.toInt(args.pageNum)||nAdjusted;var stopIndex=args.pageNum-1;for(var i=0;i<nAdjusted;i++){adjusted+=adjustList[i]||0;if(i===stopIndex){break;}}return adjusted;},anyXDBExpired:function(args){args=args||{};var response="";if(table(args.columnId)===__options__.tableAliases.EXT_DB){args.ids=args.ids||[];args.tagType=args.tagType||C.TAG.ADVANCED;var columns=__catalog__.columns||[];var columnList=columns.all||{};var associativeList=(columnList[args.columnId]||[])[C.CATALOG.COLUMN[args.tagType].ASSOCIATIVE]||[];for(var i=0,j=args.ids.length;i<j;i++){var index=associativeList.indexOf(args.ids[i]);if(index<0){index=associativeList.indexOf(String(args.ids[i]));}if(index<0){ECM.Adapter.namespace("ECM.Targeting.Store.XDB");ECM.Targeting.Store.XDB.getName=ECM.Targeting.Store.XDB.getName||function(id){var name="("+id+")";if(ECM.Stash&&ECM.Stash.xdbs&&Ext.isArray(ECM.Stash.xdbs)){Ext.each(ECM.Stash.xdbs,function(xdb){if(xdb[0]==id){name=xdb[2];return false;}});}return name;};response=ECM.Targeting.Store.XDB.getName(args.ids[i]);break;}}}return response;},ascendants:function(args){args=args||{};if(args.oldIdentity&&args.newIdentity){if(args.isRename){if(ECM.Adapter.isArray(__ascendants__[args.oldIdentity])){__ascendants__[args.newIdentity]=__ascendants__[args.oldIdentity].slice(0);}}else{if(ECM.Adapter.isArray(__ascendants__[args.oldIdentity])){__ascendants__[args.newIdentity]=__ascendants__[args.oldIdentity].slice(0);var position=__ascendants__[args.oldIdentity].indexOf(args.newIdentity);if(position>-1){Array.removeAt(__ascendants__[args.newIdentity],position);}else{__ascendants__[args.newIdentity].push(args.oldIdentity);}}else{__ascendants__[args.newIdentity]=[args.oldIdentity];}}return(__ascendants__[args.newIdentity]||[]).slice(0);}return(__ascendants__[args.identity]||[]).slice(0);},closeParams:function(identity){var struct=__structs__[identity]||{};var data=struct.data||{};var response={description:data.description||"",identity:struct.saved[struct.saved.length-1],tagType:struct.tagType,deleted:false};if(response.identity==="DC_tag_deleted_by_clicking_in_modal_button"){response.deleted=true;response.identity=undefined;}return(response.identity||response.deleted)?response:null;},condition:function(args){args=args||{};args.rowIndex=String.toInt(args.rowIndex);var response={mode:C.MODES.EDIT};var struct=__structs__[args.identity]||{};response.mailingType=struct.mailingType||C.MAILING.BULK;response.rowIndex=args.rowIndex||0;response.tagType=struct.tagType||C.TAG.SIMPLE;if(response.tagType===C.TAG.SIMPLE){var rowIndex=args.rowIndex*2;var value=(rowIndex===struct.data.values.length)?[64]:[struct.data.values[rowIndex]];var conditionMatch=new RegExp("^"+L.NEW_CONDITION+"[0-9]*$");if(String(value[C.DATA.VALUE]||"").match(conditionMatch)){response.mode=C.MODES.ADD;}response.columnId=struct.data.key;response.operatorId=__flags__.defaultOperator;response.operands=value;return response;}var data=struct.data.rules[args.rowIndex];var rule=ECM.Rules.Tablespace.findRuleByPath({data:data[C.DATA.MEMBER],path:args.indexPath,separator:args.separator});var isAggregator=!!(rule[C.IDX.LOGIC]&C.LOGIC.GROUP)&&rule[C.IDX.AGGREGATOR]&&rule[C.IDX.AGGREGATOR].length>0;var isGroup=!!(rule[C.IDX.LOGIC]&C.LOGIC.GROUP)&&!isAggregator;if(isGroup){response.group=rule[C.IDX.SOURCE];if(response.group===L.NEW_GROUP){response.mode=C.MODES.ADD;}}else{if(isAggregator){response.aggregator=rule[C.IDX.SOURCE];
rule=rule[C.IDX.AGGREGATOR];response.columnId=rule[C.IDX.COLUMN];if(response.aggregator===L.NEW_AGGREGATOR){response.mode=C.MODES.ADD;}}else{response.columnId=rule[C.IDX.COLUMN];if(!ECM.Adapter.isEffective(response.columnId)){response.mode=C.MODES.ADD;}}response.operatorId=rule[C.IDX.OPERATOR];response.operands=rule[C.IDX.OPERANDS];}return response;},content:function(args){args=args||{};args.handleAs="content";properties(args);},convert:function(args){args=args||{};(this.bundle)&&(Object.extend(args,this.bundle));var struct=__structs__[args.identity]||{};if(!((__catalog__.columns||[])[C.TAG.ADVANCED])){ECM.Rules.Tablespace.fetchField({callback:ECM.hitch({bundle:args},arguments.callee),dcid:struct.dcid,desiredAid:struct.desiredAid,id:args.identity,mfid:struct.mfid,mid:struct.mid,mailingType:struct.mailingType,tagType:C.TAG.ADVANCED,useLibrary:struct.useLibrary});return false;}var response=ECM.Rules.Tablespace.convertRules({bundle:args.bundle,force:args.force,identity:args.identity,struct:struct});var valid=response.valid;if(response.dateFail===1){ECM.Subscribers.notify({topic:C.TOPIC.LOADING.HIDE_ALL});Ext.MessageBox.show({title:ECM.Locale.fetch({key:"CONFIRM_TITLE"}),msg:ECM.Locale.fetch({key:"DATE_RULE_ERROR",params:[response.row,response.val]}),cls:"ecm-message-box blue_button",buttons:Ext.Msg.OK,icon:Ext.MessageBox.WARNING});return false;}if(!valid){ECM.Subscribers.notify({topic:C.TOPIC.LOADING.HIDE_ALL});Ext.MessageBox.show({title:ECM.Locale.fetch({key:"CONFIRM_TITLE"}),msg:ECM.Locale.fetch({key:"ERROR_OCCURED_DURING_CONVERSION"}),buttons:Ext.Msg.YESNO,icon:Ext.MessageBox.WARNING,cls:"ecm-message-box blue_button",fn:function(button){if(button==="yes"){ECM.Subscribers.notify({topic:C.TOPIC.LOADING.SHOW});ECM.Rules.Tablespace.convert(ECM.Adapter.apply({force:C.YES},args));}}});return false;}struct.data.rules=response.rules.slice(0);var oldBuffer=Object.extend({},struct.buffer);bufferClear({identity:args.identity});ECM.Rules.Tablespace.dirty({id:args.identity,value:C.DIRTY.PRIORITY});for(var i=0,nContents=response.contents.length;i<nContents;i++){var rule=response.rules[i];var isDefault=!!(rule[C.DATA.MEMBER][C.IDX.LOGIC]&C.LOGIC.DEFAULT);bufferCreate({content:response.contents[i],data:rule,dirty:C.DIRTY.PRIORITY,identifier:((isDefault)?"":i),identity:args.identity});}if(oldBuffer.name){bufferName({data:oldBuffer.name,dirty:C.DIRTY.NAME,identity:args.identity});}if(oldBuffer.description){bufferDescription({data:oldBuffer.description,dirty:C.DIRTY.DESCRIPTION,identity:args.identity});}if(oldBuffer.wrap_width){bufferWrap({data:oldBuffer.wrap_width,dirty:C.DIRTY.CONTENT,identity:args.identity});}struct.tagType=struct.buffer.tag_type=C.TAG.ADVANCED;delete struct.data.count;delete struct.data.defaults;delete struct.data.key;delete struct.data.ranges;delete struct.data.values;delete struct.key;delete struct.totalPages;struct.totalPages={};ECM.Subscribers.notify({bundle:[args],topic:C.TOPIC.TAG.CONVERTED});},convertRules:function(args){var response={contents:[],rules:[],valid:C.NO};var structToTake={};if(args.struct.data){structToTake=args.struct;}else{structToTake=__structs__[__structs__.dcFormIdentity]||__structs__[args.identity];}var struct=structToTake;if(!struct.data.key&&!args.force){return response;}struct.data.defaults=struct.data.defaults||[];struct.data.values=struct.data.values||[];var bundle=args.bundle||{rowIndex:-1};var key=struct.data.key||Object.firstKey(__catalog__.columns[C.TAG.SIMPLE]||{})||"";var delimPos=key.indexOf(".");var field=key.substring(delimPos+1);var rules;var tableId=key.substring(0,delimPos)||table(field);var nRules=Math.min((struct.data.values.length/2),__flags__.pageSize);var lastRule=nRules-1;var fullHouse=(nRules===__flags__.pageSize);function addToDefault(){rules=[struct.data.defaults[C.DATA.DESCRIPTION]||L.DEFAULT,[[[84]]]];response.rules.push(rules);return true;}function addToRule(parcel){var columnId=field;var operatorId=__flags__.defaultOperator;var rowIndex=parcel.step*2;var operandVal=struct.data.values[rowIndex];(!ECM.Adapter.isEffective(operandVal))&&(operandVal="");var operands;var isMostRecentRow=(parcel.step===parcel.rowIndex);switch(type(columnId,C.TAG.ADVANCED)){case C.TYPES.ASSOCIATIVE:case C.TYPES.SUBSCRIPTION:case C.TYPES.ZIP:case C.TYPES.ZIP_STATE:case C.TYPES.ZIP_CSTATE:case C.TYPES.ZIP_MSA:case C.TYPES.ZIP_CMSA:case C.TYPES.ZIP_MA:case C.TYPES.PLATFORM:case C.TYPES.GEOLOCATION:operatorId=__flags__.defaultAssociativeOperator;var columns=__catalog__.columns||[];var columnList=columns.all||{};var associativeList=(columnList[columnId]||[])[C.CATALOG.COLUMN[C.TAG.ADVANCED].ASSOCIATIVE]||[];var enumer=operandVal.split(",");operands=[[]];for(var i=0,nEnum=enumer.length;i<nEnum;i++){var index=associativeList.indexOf(enumer[i]);if(index<0){index=associativeList.indexOf(String(enumer[i]));}if(index>=0){operands[C.OPERANDS.FIRST].push(enumer[i]);}else{if(!args.force&&!isMostRecentRow){return false;}}}break;case C.TYPES.BEHAVIOR:operands=[[Number(!!operandVal)]];break;case C.TYPES.BITMASK:operatorId=__flags__.defaultBitmaskOperator;var columns=__catalog__.columns||[];var columnList=columns.all||{};var associativeList=(columnList[columnId]||[])[C.CATALOG.COLUMN[C.TAG.ADVANCED].ASSOCIATIVE]||[];var values=[[operandVal]];var value=values[C.OPERANDS.FIRST][C.DATA.VALUE]||0;if(!args.force&&value>=Math.pow(2,associativeList.length)&&!isMostRecentRow){return false;}else{operands=[[value]];}break;case C.TYPES.DATE:var dateParts=String.trim(operandVal).split("/");var dateFail=false;if(parcel.step===parcel.rowIndex){break;}if(dateParts.length!==3||new Date(dateParts.join("/")).format("m d Y")==="NaN NaN NaN"){dateFail=true;if(!args.switchToAdvanced){return{dateFail:1,row:rowIndex,val:String.trim(operandVal),valid:false};}else{operands=[[""]];}}else{if(dateParts.length!==3){operandVal=new Date().format("m d Y");}operands=[[11,operandVal]];}break;case C.TYPES.NTHING:if(dcForm.changeAllFieldsRequested){isMostRecentRow=true;}if(!args.force&&!isMostRecentRow){return false;}else{operands=[[1,1]];}break;case C.TYPES.NUMERIC:if(!args.force&&isNaN(Number(operandVal))&&!isMostRecentRow){return false;}else{operands=[[((!isNaN(Number(operandVal)))?Number(operandVal):0)]];}break;default:operands=[[((ECM.Adapter.isEffective(operandVal))?operandVal:"")]];break;}if(parcel.step===parcel.rowIndex){rules=[struct.data.values[rowIndex+1],[[[21,(table(parcel.columnId)||tableId),(parcel.columnId||columnId),(parcel.operatorId||operatorId),(parcel.operands.slice(0)||operands)]]]];}else{rules=[struct.data.values[rowIndex+1],[[[21,tableId,columnId,operatorId,operands]]]];}response.rules.push(rules);return true;}for(var i=0;i<nRules;i++){if(fullHouse&&(i===lastRule)){addToDefault();response.contents.push(struct.data.content[lastRule]);}else{bundle.step=i;var atr=addToRule(bundle);if(!atr){return response;}if(atr.dateFail===1){return atr;}response.contents.push(struct.data.content[i]);}}if(!fullHouse){addToDefault();response.contents.push(struct.data.content[nRules]);}response.valid=C.YES;return response;},copyRule:function(args){if(args){args.rowIndex=String.toInt(args.rowIndex);var copyOfLabel=ECM.Locale.fetch({key:"COPY_OF"});var struct=__structs__[args.identity]||{};var data=struct.data;var rules=[];if(struct.tagType===C.TAG.SIMPLE){var rowIndex=args.rowIndex*2;data.values=data.values||[];rules.push(copyOfLabel+" "+data.values[rowIndex]);rules.push(copyOfLabel+" "+data.values[rowIndex+1]);}else{rules=Array.clone(data.rules[args.rowIndex]||[]);rules[C.DATA.DEFINITION]=copyOfLabel+" "+rules[C.DATA.DEFINITION];}var content=(data.content[args.rowIndex]||[]).slice(0);return ECM.Rules.Tablespace.insertRule({data:{content:content,rules:rules},identity:args.identity,pageNum:args.pageNum,pos:args.pos});}return false;},dataStore:function(args){args=args||{};(this.bundle)&&(Object.extend(args,this.bundle));args.rowIndex=String.toInt(args.rowIndex);args.switchToAdvanced=!!args.switchToAdvanced;args.types=(ECM.Adapter.isString(args.types))?[args.types]:((ECM.Adapter.isArray(args.types))?args.types:["column","operator","associative"]);
var columns=__catalog__.columns||[];var data,rule;var responses=[];var struct=__structs__[args.identity]||{};if(args.switchToAdvanced&&!columns[C.TAG.ADVANCED]){ECM.Rules.Tablespace.fetchField({callback:ECM.hitch({bundle:args},arguments.callee),dcid:struct.dcid,desiredAid:struct.desiredAid,id:args.identity,mfid:struct.mfid,mid:struct.mid,mailingType:struct.mailingType,tagType:C.TAG.ADVANCED,useLibrary:struct.useLibrary});return false;}var tagType=(args.switchToAdvanced)?C.TAG.ADVANCED:struct.tagType;var defaultColumnId=Object.firstKey(columns[tagType]||columns.all||{});var isSimpleTag=ECM.Rules.Tablespace.isSimpleTag({struct:struct});if(!ECM.Adapter.isEffective(args.columnId)){if(isSimpleTag){args.columnId=(args.switchToAdvanced)?defaultColumnId:(struct.data.key||defaultColumnId);}else{data=struct.data.rules[args.rowIndex];rule=ECM.Rules.Tablespace.findRuleByPath({data:data[C.DATA.MEMBER],path:args.indexPath,separator:args.separator});args.columnId=rule[C.IDX.COLUMN]||defaultColumnId;}}if(!ECM.Adapter.isEffective(args.operatorId)){if(isSimpleTag){args.operatorId=__flags__.defaultOperator;}else{data=data||struct.data.rules[args.rowIndex];rule=rule||ECM.Rules.Tablespace.findRuleByPath({data:data[C.DATA.MEMBER],path:args.indexPath,separator:args.separator});args.operatorId=rule[C.IDX.OPERATOR]||Object.firstKey(__options__.operators);}}switch(type(args.columnId,struct.tagType)){case C.TYPES.ASSOCIATIVE:case C.TYPES.BITMASK:case C.TYPES.MAILING:case C.TYPES.SUBSCRIPTION:case C.TYPES.VIRTUAL:case C.TYPES.ZIP:case C.TYPES.ZIP_STATE:case C.TYPES.ZIP_CSTATE:case C.TYPES.ZIP_MSA:case C.TYPES.ZIP_CMSA:case C.TYPES.ZIP_MA:case C.TYPES.PLATFORM:case C.TYPES.GEOLOCATION:break;default:var pos=args.types.indexOf("associative");(pos>-1)&&(Array.removeAt(args.types,pos));break;}for(var i=0,j=args.types.length;i<j;i++){switch(args.types[i]){case"column":responses.push(new ECM.Data.DictionaryStore({data:columns[tagType]||columns.all||{},fields:[{name:"value",mapping:"__key__"},{name:"text",convert:function(value){return(ECM.Adapter.isArray(value))?value[C.CATALOG.COLUMN[struct.tagType].LABEL]:"";}},{name:"type",convert:function(value){return(ECM.Adapter.isArray(value))?value[C.CATALOG.COLUMN[struct.tagType].TYPE]:"";}}]}));break;case"operator":var operators=ECM.Adapter.apply({},__options__.operators||{});delete operators._bogus;responses.push(new ECM.Data.DictionaryStore({data:operators,fields:[{name:"value",mapping:"__key__"},{name:"text",convert:function(value){return(ECM.Adapter.isArray(value))?value[C.CATALOG.OPERATOR.STANDARD]:"";}},{name:"arity",convert:function(value){return(ECM.Adapter.isArray(value))?value[C.CATALOG.OPERATOR.ARITY]:"";}},{name:"group",convert:function(value){return(ECM.Adapter.isArray(value))?value[C.CATALOG.OPERATOR.GROUP]:"";}},{name:"assocTypes",convert:function(value){return(ECM.Adapter.isArray(value))?value[C.CATALOG.OPERATOR.ASSOC_TYPES]:"";}},{name:"assocNullOption",convert:function(value){return(ECM.Adapter.isArray(value))?value[C.CATALOG.OPERATOR.ASSOC_NULL_OPTION]:"";}},{name:"numValues",convert:function(value){return(ECM.Adapter.isArray(value))?value[C.CATALOG.OPERATOR.NUM_VALUES]:"";}}]}));break;case"associative":var associatives=((columns.all[args.columnId]||[])[C.CATALOG.COLUMN[tagType].ASSOCIATIVE]||[]).slice(0);if(table(args.columnId)===__options__.tableAliases.EXT_DB){ECM.Adapter.namespace("ECM.Targeting.Store.XDB");var operands=rule[C.IDX.OPERANDS][C.DATA.FIRST];for(var k=0,operandsLength=operands.length;k<operandsLength;k++){var id=String(operands[k]);if(associatives.indexOf(id)<0){var name=ECM.Targeting.Store.XDB.getName?ECM.Targeting.Store.XDB.getName(id):"";name=name||"("+id+")";associatives.push(id);associatives.push(name);}}}responses.push(new ECM.Data.TandemStore({data:associatives,fields:[{name:"value",mapping:"__key__"},"text"]}));break;}}(args.callback)&&(args.callback(responses));return responses;},deleteCondition:function(args){args=args||{};args.rowIndex=String.toInt(args.rowIndex);if(args.rowIndex>-1){var struct=__structs__[args.identity]||{};var rules=[];var data,identifier;if(args.isSimpleTag){return ECM.Rules.Tablespace.deleteRule(ECM.Adapter.apply({lastRemoved:C.YES},args));}else{var response={};data=struct.data.rules[args.rowIndex];var rule=ECM.Rules.Tablespace.findRuleByPath({data:data[C.DATA.MEMBER],path:args.indexPath,separator:args.separator});var lastIndex=ECM.Rules.Tablespace.lastIndexFromPath({path:args.indexPath,separator:args.separator});response.isNew=(rule[C.IDX.TABLE]===L.NEW_GROUP||rule[C.IDX.TABLE]===L.NEW_AGGREGATOR);if(!!(rule[C.IDX.LOGIC]&C.LOGIC.GROUP)&&response.isNew){response.children=(rule.parentNode[lastIndex][C.DATA.MEMBER]||[]).slice(0);if(response.children.length>0){for(var i=0,nChildren=response.children.length;i<nChildren;i++){Array.insertAt(rule.parentNode,response.children[i],(lastIndex+i)+1);}}}response.removed=rule.parentNode.splice(lastIndex,1);if(ECM.Adapter.isArray(data[C.DATA.MEMBER])&&!data[C.DATA.MEMBER].length){response.rule=ECM.Rules.Tablespace.deleteRule(ECM.Adapter.apply({lastRemoved:C.YES},args));response.wholeRow=C.YES;return response;}identifier=ECM.Rules.Tablespace.identifier({rowIndex:args.rowIndex,struct:struct});bufferModify({data:data,dirty:C.DIRTY.TARGETING,identifier:identifier,identity:args.identity});return response;}}return false;},deleteRule:function(args){if(args&&args.rowIndex>-1){if(!__caches__.struct){__caches__.struct=__structs__[args.identity]||{};__caches__.data=__caches__.struct.data;__caches__.isSimpleTag=ECM.Rules.Tablespace.isSimpleTag({struct:__caches__.struct});if(__caches__.isSimpleTag){__caches__.data.count=__caches__.data.count||1;__caches__.data.values.originals=__caches__.data.values.originals||{};__caches__.data.values.search=__caches__.data.values.search||{};}}var identifier;var rowIndex=String.toInt(args.rowIndex);var rules=[];if(__caches__.isSimpleTag){for(var keywordId in __caches__.data.values.search){var keyword=decodeURIComponent(keywordId);var location=ECM.Rules.Tablespace.findRuleSearchLocation({identity:args.identity,keyword:keyword,rowIndex:rowIndex});if(location.rowIndex>-1){__caches__.data.values.search[keywordId].splice((location.rowIndex*2),2);__caches__.data.values.search[keywordId].count--;bucketAdjustments({direction:"reduction",keyword:keyword,pageNum:args.pageNum,struct:__caches__.struct});}}rules=__caches__.data.values.splice((rowIndex*2),2);bucketAdjustments({direction:"reduction",pageNum:args.pageNum,struct:__caches__.struct});__caches__.data.count--;identifier=ECM.Rules.Tablespace.identifier({struct:__caches__.struct,value:rules[C.DATA.VALUE]});}else{identifier=ECM.Rules.Tablespace.identifier({rowIndex:rowIndex,struct:__caches__.struct});rules=__caches__.data.rules.splice(rowIndex,1);}var content=__caches__.data.content.splice(rowIndex,1);bufferRemove({data:identifier,dirty:C.DIRTY.PRIORITY,identity:args.identity,pending:!args.lastRemoved});if(args.lastRemoved){delete __caches__.struct;delete __caches__.data;delete __caches__.isSimpleTag;}return rules;}return false;},deleteTag:function(args){args=args||{};if(!args.identity){return false;}var struct=__structs__[args.identity]||{};ECM.Subscribers.notify({bundle:[ECM.Locale.fetch({key:"DELETING"})+"..."],topic:C.TOPIC.LOADING.SHOW});if(struct.mid<0){var params={id:"["+args.id+"]"};}else{var params={mid:struct.mid,name:args.identity};}ECM.Ajax.request({url:ECM.Rules.Constants.URL.DYNAMIC_CONTENT_LIBRARY_SET+"?action="+C.SERVICES.DELETE+"",params:params,method:"POST",success:function(response){var responseJSON=response.responseJSON;ECM.Subscribers.notify({topic:C.TOPIC.LOADING.HIDE});if(responseJSON.success){struct.saved.push("DC_tag_deleted_by_clicking_in_modal_button");var identities=ECM.Rules.Tablespace.otherIdentities(args.identity);if(identities.onClose){identities.onClose(ECM.Rules.Tablespace.closeParams(args.identity));}var ascendants=ECM.Rules.Tablespace.ascendants({identity:args.identity});if(ECM.Adapter.isArray(ascendants)&&ascendants.length>0){var parentId=ascendants.pop();
var changeTagParams=ECM.Adapter.apply({newIdentity:parentId},identities);ECM.Rules.DynamicContent.changeTag(changeTagParams);return false;}var perspective=ECM.Rules.DynamicContent.layout({id:args.identity}).perspective;(perspective.hidden)?perspective.doClose():perspective.hide(null,perspective.doClose,perspective);}else{ECM.Subscribers.notify({bundle:[gt.gettext("Failed to delete tags. Please try again.")],topic:C.TOPIC.NOTIFY.ERROR});}},failure:function(response){ECM.Subscribers.notify({topic:C.TOPIC.LOADING.HIDE});ECM.Subscribers.notify({bundle:[gt.gettext("Failed to delete tags. Please try again.")],topic:C.TOPIC.NOTIFY.ERROR});}});},dirty:function(args){args=args||{};if(!args.id){return false;}(!__structs__[args.id])&&(__structs__[args.id]={});(ECM.Adapter.isEffective(args.value))&&(__structs__[args.id].dirty|=args.value);return !!__structs__[args.id].dirty;},fetch:function(args){args=args||{};args.pageNum=args.pageNum||__flags__.pageNum;(!__flags__.deferred)&&(__flags__.deferred=new ECM.Deferred());__flags__.deferred.addCallback(function(bundle){document.body.style.cursor="";__flags__.deferred=null;(args.callback)&&(args.callback(bundle));return bundle;});(!__flags__.inflight||args.failure)&&(__flags__.deferred.addErrback(function(err){document.body.style.cursor="";__flags__.deferred=null;(args.failure||failure)(err);return arguments;}));if(!args.id){window.setTimeout(__flags__.deferred.errback,10);return __flags__.deferred;}var struct=__structs__[args.id]=(__structs__[args.id]||structDefaults(args));var isNeverLoaded=true;var keywordId=encodeURIComponent(args.keyword||"__master__");var tagType=struct.tagType||C.TAG.SIMPLE;var isSimpleTag=ECM.Rules.Tablespace.isSimpleTag({struct:struct});if(args.runMode===C.SERVICES.CONTENT){isNeverLoaded=Object.isEmpty(struct.data.content[args.rowIndex]);}else{if(args.runMode===C.SERVICES.FIELD){__catalog__.columns=__catalog__.columns||[];isNeverLoaded=!ECM.Adapter.isEffective(__catalog__.columns[args.tagType||tagType]);}else{if(args.keyword){struct.pages.search[keywordId]=struct.pages.search[keywordId]||[];}isNeverLoaded=Object.isEmpty(struct.data)||(args.keyword&&!struct.pages.search[keywordId][args.pageNum||__flags__.pageNum])||(!args.keyword&&!struct.pages[args.pageNum||__flags__.pageNum]);}}if(!isNeverLoaded&&!args.disableCaching){window.setTimeout(function(){__flags__.deferred.callback({data:struct.data});},10);return __flags__.deferred;}if(__flags__.inflight){return __flags__.deferred;}__flags__.inflight++;args.runMode=args.runMode||C.SERVICES.DEFINITION;var isValidKeyword=false;var timestamp=new Date().valueOf();var last_modified=(isNeverLoaded)?timestamp:(struct.data.last_modified||timestamp);var params={last_modified:last_modified};(ECM.Adapter.isEffective(args.dcid||__catalog__.meta.dcid))&&(params.dc_id=args.dcid||__catalog__.meta.dcid);(ECM.Adapter.isEffective(args.desiredAid||__catalog__.meta.desiredAid))&&(params.desired_aid=args.desiredAid||__catalog__.meta.desiredAid);(ECM.Adapter.isEffective(args.mfid||__catalog__.meta.mfid))&&(params.mfid=args.mfid||__catalog__.meta.mfid);if(!args.useLibrary&&(!struct.useLibrary&&!ECM.Adapter.isEffective(args.useLibrary))){(ECM.Adapter.isEffective(args.mid||__catalog__.meta.mid))&&(params.mid=args.mid||__catalog__.meta.mid);}(ECM.Adapter.isEffective(args.mailingType))&&(params.mtype=args.mailingType);(args.id!=="__create__")&&(params.rs_id=args.id);switch(args.runMode){case C.SERVICES.CONTENT:if(isSimpleTag){var value=struct.data.values[args.rowIndex*2];var identifier=ECM.Rules.Tablespace.identifier({struct:struct,value:value});params.row_index=identifier;if(typeof(params.row_index)==="undefined"){delete params.row_index;}}else{var isDefault=ECM.Rules.Tablespace.isDefault({rowIndex:args.rowIndex,struct:struct});params.row_index=(isDefault)?"":ECM.Rules.Tablespace.identifier({struct:struct,rowIndex:args.rowIndex});}break;case C.SERVICES.FIELD:params.tag_type=args.tagType||tagType;break;default:__catalog__.columns=__catalog__.columns||[];(args.pageNum===1&&(!__catalog__.columns[C.TAG.SIMPLE]||!__catalog__.columns[C.TAG.ADVANCED]))&&(args.catalog=true);if(isSimpleTag){params.page_num=args.pageNum;params.page_size=args.pageSize||__flags__.pageSize;isValidKeyword=ECM.Adapter.isEffective(args.keyword)&&args.keyword.length;if(isValidKeyword){args.catalog=false;params.search=args.keyword;}((isNeverLoaded&&args.pageNum===1)||(isValidKeyword&&args.pageNum===1))&&(params.want_ranges=C.YES);}(args.catalog&&struct.mailingType!==C.MAILING.EBM)&&(params.want_fields=C.YES);break;}var processRequest=function(response,request){args.bundle=args.bundle||{};var json=response.responseJSON||{data:[]};var error_message=errorMessageFromJson(json);if(!error_message){var parcel=json.data.data||json.data||[];switch(args.runMode){case C.SERVICES.CONTENT:args.bundle.data=struct.data.content[args.rowIndex]=parcel.slice(0);break;case C.SERVICES.FIELD:assignCatalog({catalog:[parcel],id:args.id,key:args.key,tagType:args.tagType});break;default:args.bundle.data=parcel.shift();assignDefinition({bundle:args.bundle,currentPage:args.currentPage,id:args.id,keyword:args.keyword,pageNum:args.pageNum});if(args.catalog){assignCatalog({catalog:parcel.shift(),id:args.id,key:args.key,tagType:args.tagType});}break;}}__flags__.inflight--;error_message?__flags__.deferred.errback(error_message):__flags__.deferred.callback(args.bundle);(!__flags__.inflight)&&(__flags__.deferred=null);};if(window.ecmTargetingModeOn){(function(){processRequest({responseJSON:Ext.decode(Ext.encode(ECM.Targeting.Store.SegmentData.getResponse()))},params);}).defer(300);}else{ECM.Ajax.request({url:C.URL.DYNAMIC_CONTENT_GET+"/"+args.runMode+"",params:params,method:"GET",success:processRequest,failure:function(response,request){__flags__.inflight--;__flags__.deferred.errback(response,request);(!__flags__.inflight)&&(__flags__.deferred=null);}});}return __flags__.deferred;},fetchContent:function(args){return ECM.Rules.Tablespace.fetch(ECM.Adapter.apply({runMode:C.SERVICES.CONTENT},args));},fetchDefinition:function(args){return ECM.Rules.Tablespace.fetch(ECM.Adapter.apply({runMode:C.SERVICES.DEFINITION},args));},fetchField:function(args){return ECM.Rules.Tablespace.fetch(ECM.Adapter.apply({runMode:C.SERVICES.FIELD},args));},findFieldByKey:function(args){args=args||{};args.tagType=args.tagType||"all";var response=false;if(ECM.Adapter.isEffective(args.key)){var fields=(__catalog__.columns||[])[args.tagType]||{};for(var key in fields){key=String.trim(key);if(String.trim(args.key)===key.substring(key.indexOf(".")+1)){response=key;break;}}}return response;},findLogicByPath:function(args){if(args){args.rowIndex=String.toInt(args.rowIndex);var struct=__structs__[args.identity]||{};if(struct.tagType!==C.TAG.SIMPLE){var data=struct.data.rules[args.rowIndex];var rule=ECM.Rules.Tablespace.findRuleByPath({data:data[C.DATA.MEMBER],path:args.indexPath,separator:args.separator});return rule[C.IDX.LOGIC];}return C.LOGIC.NONE;}return C.LOGIC.NONE;},findRuleByPath:function(args){args=args||{};var indices=(args.path||"").split(args.separator);var parentNode=args.data||[];var grandParent;for(var i=1,j=indices.length,k=j-1;i<j;i++){grandParent=parentNode;if(args.create){if(i!==k){parentNode[indices[i]]=parentNode[indices[i]]||[];parentNode[indices[i]][C.DATA.MEMBER]=parentNode[indices[i]][C.DATA.MEMBER]||[];}}parentNode=(i===k)?(parentNode[indices[i]]||[[],[]]):((parentNode[indices[i]]||[])[C.DATA.MEMBER]||[]);parentNode.parentNode=grandParent;}if(args.wholeRow){return parentNode;}else{parentNode=parentNode[C.DATA.DEFINITION];parentNode.parentNode=grandParent;return parentNode;}},findRuleOriginalLocation:function(args){args=args||{};var struct=__structs__[args.identity]||{};if(!ECM.Rules.Tablespace.isSimpleTag({struct:struct})){return false;}var response={};var data=struct.data||{};var keywordId=encodeURIComponent(args.keyword||"__master__");var rowIndex=args.rowIndex*2;response.value=data.values.search[keywordId][rowIndex];var position=data.values.indexOf(response.value);
if(position>-1){var totalPages=ECM.Rules.Tablespace.totalPages({identity:args.identity,keyword:args.keyword});for(var i=0;i<totalPages;i++){var start=i*__flags__.pageSize;if(data.values[start]<response.value&&response.value<data.values[start+199]){response.pageNum=i+1;break;}}(!response.pageNum)&&(response.pageNum=__flags__.pageNum);response.rowIndex=Math.ceil(position/2);}else{var response_value="("+data.values.search[keywordId][rowIndex+1]+") "+response.value;for(var i=0,j=data.ranges.length;i<j;i++){if(data.ranges[i][C.DATA.VALUE]<=response_value&&response_value<=data.ranges[i][C.DATA.MEMBER]){response.pageNum=i+1;break;}}}return response;},findRuleSearchLocation:function(args){args=args||{};args.hideWarning=(ECM.Adapter.isEffective(args.hideWarning))?args.hideWarning:false;var struct=__structs__[args.identity]||{};if(!ECM.Rules.Tablespace.isSimpleTag({struct:struct})){return false;}var response={};var data=struct.data||{};var keywordId=encodeURIComponent(args.keyword||"__master__");var rowIndex=args.rowIndex*2;response.value=data.values[rowIndex];var position=data.values.search[keywordId].indexOf(response.value);if(position>-1){response.rowIndex=Math.ceil(position/2);}else{response.rowIndex=-1;if(!args.hideWarning){ECM.Subscribers.notify({bundle:[ECM.Locale.fetch({key:"OBJECT_X_NO_LONGER_REFERENCED",params:[response.value]})],topic:C.TOPIC.NOTIFY.WARN});}}return response;},getTableAlias:function(tableIdentifier){return __options__.tableAliases[tableIdentifier]||tableIdentifier;},identifier:function(args){args=args||{};var struct=args.struct||__structs__[args.identity]||{};var data,response;if(ECM.Rules.Tablespace.isSimpleTag({struct:struct})){data=struct.data;data.values.originals=data.values.originals||{};response=(ECM.Adapter.isEffective(data.values.originals[args.value]))?data.values.originals[args.value]:args.value;}else{data=struct.data.rules[args.rowIndex];response=(ECM.Adapter.isEffective(data.original))?data.original:args.rowIndex;}return response;},insertRule:function(args){if(args&&args.identity&&!Object.isEmpty(args.data)){var struct=__structs__[args.identity]||{};var data=struct.data;var identifier,rules,pos;if(ECM.Rules.Tablespace.isSimpleTag({struct:struct})){if(args.data.rules[C.DATA.VALUE]===L.NEW_CONDITION&&aheadChanges({identifier:L.NEW_CONDITION,identity:args.identity,struct:struct})){args.data.rules[C.DATA.VALUE]+=data.count;if(!data.key){ECM.Subscribers.notify({bundle:[ECM.Locale.fetch({key:"NO_FIELD_SELECTED"})],topic:C.TOPIC.NOTIFY.WARN});return false;}}args.data.key=data.key;data.count=data.count||0;if((data.count+1)>__flags__.pageSize){pos=ECM.Adapter.isEffective(args.pos)?args.pos:Math.min((args.pageNum*__flags__.pageSize)-1,data.count);}else{pos=data.count;(pos<0)&&(pos=0);}var totalPages=ECM.Rules.Tablespace.totalPages({force:C.YES,identity:args.identity,keyword:args.keyword});Array.insertAt(data.values,args.data.rules[C.DATA.DESCRIPTION],pos*2);Array.insertAt(data.values,args.data.rules[C.DATA.VALUE],pos*2);if(pos===((args.pageNum*__flags__.pageSize)-1)){struct.pages[totalPages+1]=C.YES;}bucketAdjustments({direction:"addition",pageNum:args.pageNum,struct:struct});data.count++;identifier=args.data.rules[C.DATA.VALUE];rules=args.data.rules[C.DATA.MEMBER];}else{pos=data.rules.length;var isDefault=ECM.Rules.Tablespace.isDefault({rowIndex:(pos-1),struct:struct});(isDefault)&&(pos--);Array.insertAt(data.rules,args.data.rules,pos);identifier=pos;rules=data.rules[pos];}Array.insertAt(data.content,args.data.content,pos);bufferCreate({content:args.data.content,data:rules,dirty:C.DIRTY.PRIORITY,identifier:identifier,identity:args.identity});return args.data;}return false;},isAggregator:function(logic){return Ext.isDefined(Ext.each(C.LOGIC_AGGREGATORS,function(item){return !(logic&C.LOGIC[item]);}));},isDefault:function(args){args=args||{};var response=false;var struct=args.struct||__structs__[args.identity]||{};if(ECM.Rules.Tablespace.isSimpleTag({struct:struct})){response=!ECM.Adapter.isEffective(struct.data.values[args.rowIndex]);}else{response=!!(((((struct.data.rules[args.rowIndex]||[])[C.DATA.MEMBER]||[])[C.DATA.FIRST]||[])[C.DATA.DEFINITION]||[])[C.IDX.LOGIC]&C.LOGIC.DEFAULT);}return response;},isDuplicate:function(args){if(args){var struct=__structs__[args.identity]||{};if(ECM.Rules.Tablespace.isSimpleTag({struct:struct})&&ECM.Adapter.isArray(args.operands)&&args.operands.length>0){args.rowIndex=String.toInt(args.rowIndex);var newValue=args.operands[C.OPERANDS.FIRST][C.DATA.VALUE]||"";var found=-1;for(var i=0,len=struct.data.values.length;i<len;i=i+2){if(newValue==struct.data.values[i]){found=i;break;}}return !!(found>-1&&found!==(args.rowIndex*2));}return false;}return false;},isSimpleTag:function(args){args=args||{};return((args.struct||__structs__[args.identity]||{}).tagType===C.TAG.SIMPLE);},isUserAMonkey:function(){return true;},key:function(args){args=args||{};args.identity=args.identity||"";return((__structs__[args.identity]||{}).data||{}).key||"";},lastIndexFromPath:function(args){args=args||{};return String.toInt(((args.path||"").split(args.separator)||[]).pop());},move:function(args){if(args){args.rowIndex=String.toInt(args.rowIndex);var isPriority=(args.rowIndex===-1);var struct=__structs__[args.identity]||{};var data=(isPriority)?[null,struct.data.rules]:struct.data.rules[args.rowIndex];var rule=ECM.Rules.Tablespace.findRuleByPath({data:data[C.DATA.MEMBER],path:args.oldIndexPath,separator:args.separator,wholeRow:1});if(!rule[C.DATA.DEFINITION][C.IDX.LOGIC]){return false;}var oldIndexInParent=ECM.Rules.Tablespace.lastIndexFromPath({path:args.oldIndexPath,separator:args.separator});var newIndexInParent=ECM.Rules.Tablespace.lastIndexFromPath({path:args.indexPath,separator:args.separator});rule.parentNode.splice(oldIndexInParent,1);var target=ECM.Rules.Tablespace.findRuleByPath({create:C.YES,data:data[C.DATA.MEMBER],path:args.indexPath,separator:args.separator,wholeRow:1});if(!isPriority){var indexPaths=args.indexPath.split(args.separator);indexPaths[indexPaths.length-1]=target.parentNode.length-1;var indexPath=indexPaths.join(args.separator);var targetLogic=ECM.Rules.Tablespace.findLogicByPath({identity:args.identity,indexPath:indexPath,rowIndex:args.rowIndex,separator:args.separator});rule[C.DATA.DEFINITION][C.IDX.LOGIC]&=~C.LOGIC.OR;rule[C.DATA.DEFINITION][C.IDX.LOGIC]&=~C.LOGIC.AND;rule[C.DATA.DEFINITION][C.IDX.LOGIC]|=(!!(targetLogic&C.LOGIC.OR))?C.LOGIC.OR:C.LOGIC.AND;}target.parentNode.splice(newIndexInParent,0,rule);if(isPriority){struct.data.content=struct.data.content||[];var content=struct.data.content.splice(oldIndexInParent,1)[C.DATA.FIRST];struct.data.content.splice(newIndexInParent,0,content);var identifier=(ECM.Adapter.isEffective(rule.original))?rule.original:oldIndexInParent;bufferMove({data:[identifier,newIndexInParent],dirty:C.DIRTY.PRIORITY,identity:args.identity});}else{var identifier=ECM.Rules.Tablespace.identifier({rowIndex:args.rowIndex,struct:struct});bufferModify({data:data,dirty:C.DIRTY.TARGETING,identifier:identifier,identity:args.identity});}return rule;}return false;},otherIdentities:function(identity){var struct=__structs__[identity]||{};return{dcid:struct.dcid,desiredAid:struct.desiredAid,identity:identity,isAmbivalent:!!struct.isAmbivalent,key:struct.key,mfid:struct.mfid,mid:struct.mid,mailingType:struct.mailingType,oldIdentity:identity,onClose:struct.onClose,onSave:struct.onSave};},pageSize:function(){return __flags__.pageSize;},paging:function(args){args=args||{};if(!ECM.Adapter.isEffective(args.identity)){return false;}args.pageNum=String.toInt(args.pageNum)||1;(args.pageNum<1)&&(args.pageNum=1);var struct=__structs__[args.identity]||{};if(!ECM.Rules.Tablespace.isSimpleTag({struct:struct})){return false;}var data=struct.data||{};var keywordId=encodeURIComponent(args.keyword||"__master__");var totalPages=ECM.Rules.Tablespace.totalPages({force:C.YES,identity:args.identity,keyword:args.keyword});(args.pageNum>totalPages)&&(args.pageNum=totalPages);var params={generated:0,halfView:Math.floor((__flags__.pageView-1)/2),lastGenerated:-1,lastPage:0,pages:[],ranges:[],startPage:0};
params.startPage=(args.pageNum-1)-params.halfView;(params.startPage<0)&&(params.startPage=0);params.lastPage=Math.min(totalPages,(args.pageNum+params.halfView));function distribute(where,pageStart){var recordStart=pageStart*__flags__.pageSize;var count=(args.keyword)?data.values.search[keywordId].count:data.count;var recordEnd=Math.min(count,(recordStart+__flags__.pageSize));var how=(where==="front")?"unshift":"push";(totalPages===(pageStart+1)&&recordStart===recordEnd)&&(C.YES===1);params.pages[how]([pageStart+1,recordStart+1,recordEnd]);params.ranges[how]((data.ranges||[])[pageStart]||["",""]);}function distributeOnTheFront(pageStart){distribute("front",pageStart);}function distributeOnTheBack(pageStart){distribute("back",pageStart);}for(var i=params.startPage;i<params.lastPage;i++){if(i<totalPages&&i>=0){distributeOnTheBack(i);params.generated++;params.lastGenerated=i;}}for(var i=1,pageLeft=(Math.min(__flags__.pageView,totalPages)-params.generated);i<=pageLeft;i++){if(params.lastGenerated<(totalPages-1)){distributeOnTheBack(++params.lastGenerated);}else{var delta=totalPages-__flags__.pageView;(delta<0)&&(delta=0);distributeOnTheFront((pageLeft-i)+delta);}}return{pages:params.pages,ranges:params.ranges,totalPages:totalPages};},pointer:function(args){args=args||{};args.identity=args.identity||"__create__";var response=C.MODULE.DYNAMIC_CONTENT;var struct=__structs__[args.identity]||{};if(args.identity==="__create__"){if(struct.isAmbivalent){response+="/"+C.HISTORY.CREATE.AMBIVALENT;if(struct.key){response+="["+struct.key+"]";}}else{if(struct.useLibrary){response+="/"+C.HISTORY.CREATE.LIBRARY;if(struct.key){response+="["+struct.key+"]";}}else{if(struct.mailingType===C.MAILING.EBM){response+="/"+C.HISTORY.CREATE.EBM;if(struct.key){response+="["+struct.key+"]";}}else{response+="/"+C.HISTORY.CREATE.BULK;}}}}else{if(struct.isAmbivalent){response+="/"+C.HISTORY.MODIFY.AMBIVALENT;}else{if(struct.useLibrary){response+="/"+C.HISTORY.MODIFY.LIBRARY;}else{if(struct.mailingType===C.MAILING.EBM){response+="/"+C.HISTORY.MODIFY.EBM;}else{response+="/"+C.HISTORY.MODIFY.BULK;}}}var ascendants=__ascendants__[args.identity]||[];var nAscendants=ascendants.length;if(nAscendants){for(var i=0;i<nAscendants;i++){response+="/"+ascendants[i];}}response+="/"+args.identity;if((struct.isAmbivalent||struct.mailingType===C.MAILING.EBM)&&struct.key){response+="["+struct.key+"]";}}var buffer=ECM.Adapter.encode(struct.buffer);if(buffer.length>63){response+="/+"+buffer;}return response;},priority:function(args){args=args||{};args.handleAs="priority";properties(args);},rename:function(args){args=args||{};if(args.oldIdentity&&args.newIdentity){args.isRename=C.YES;ECM.Rules.Tablespace.ascendants(args);var struct=__structs__[args.newIdentity]=Object.extend({},__structs__[args.oldIdentity]);struct.id=args.newIdentity;struct.pages[__flags__.pageNum]=1;ECM.Rules.Tablespace.truncate({id:args.oldIdentity,structOnly:true});}},rePage:function(args){return doPage(Object.extend(args,{defaultValue:C.YES}));},ruleInfoDC:function(args){args=args||{};args.data=args.data||[];if(!args.data.length){return"";}var isDefault=false;var isGroup=false;var response={segment:[],standard:[]};if(args.isSimpleTag){isDefault=!!(ECM.Adapter.isArray(args.data[C.DATA.DEFINITION])&&args.data[C.DATA.DEFINITION][C.IDX.LOGIC]&C.LOGIC.DEFAULT);if(isDefault){response.standard.push(L.DEFAULT);response.segment.push(L.DEFAULT);}else{if(args.data[C.DATA.VALUE]===L.NEW_CONDITION&&!args.key){response.standard.push('<span class="ecm-condition x-drag-handle">'+L.NEW_CONDITION+"</span>");response.segment.push(L.NEW_CONDITION);}else{var struct=__structs__[args.identity]||{};var columnLabel=(struct.mailingType===C.MAILING.EBM)?args.key:column(args.key);var operandLabel="'"+(args.data[C.DATA.VALUE].entitizeBrackets?args.data[C.DATA.VALUE].entitizeBrackets():args.data[C.DATA.VALUE])+"'";response.standard.push('<span class="ecm-condition x-drag-handle">'+columnLabel);response.segment.push(columnLabel);response.standard.push(operator(__flags__.defaultOperator,type(args.key),C.CATALOG.OPERATOR.STANDARD));response.segment.push(operator(__flags__.defaultOperator,type(args.key),C.CATALOG.OPERATOR.SEGMENT));response.standard.push(operandLabel+"</span>");response.segment.push(operandLabel);}}}else{var logic=args.data[C.IDX.LOGIC];var metaOr=!!(logic&C.LOGIC.OR);var metaId=(!!(logic&C.LOGIC.EXCLUDE))?((metaOr)?8:9):((metaOr)?5:6);var logicLabels=[__options__.operators[metaId][C.CATALOG.OPERATOR.STANDARD]];var andOrTooltip=gt.gettext("Click on the conjunction to toggle between and/or.");logicLabels.unshift('<span class="ecm-boolean-toggle x-drag-handle" title="'+andOrTooltip+'">');if(!!(logic&C.LOGIC.EXCLUDE)){logicLabels[C.DATA.MEMBER]=logicLabels[C.DATA.MEMBER].replace(" ",'</span> <span class="ecm-inclusion-toggle ecm-exclusion x-drag-handle">');}else{logicLabels.push("</span> ");logicLabels.push('<span class="ecm-inclusion-toggle x-drag-handle">');logicLabels.push(L.INCLUDE.toUpperCase());}logicLabels.push("</span>");response.standard.push(logicLabels.join(""));isGroup=!!(logic&C.LOGIC.GROUP);if(isGroup){response.standard.push('<span class="ecm-condition x-drag-handle">'+ECM.Locale.fetch({key:"GROUP"})+":");response.standard.push((args.data[C.IDX.SOURCE]||"").entitizeBrackets()+"</span>");var segmentLogic=(args.firstChild||[])[C.IDX.LOGIC]||C.LOGIC.NONE;var segmentOr=!!(segmentLogic&C.LOGIC.OR);var segmentMetaId=(!!(logic&C.LOGIC.EXCLUDE))?((segmentOr)?8:9):((segmentOr)?5:6);response.segment.push(__options__.operators[segmentMetaId][C.CATALOG.OPERATOR.SEGMENT]);}else{if(!!(logic&C.LOGIC.EXCLUDE)){response.segment.push(__options__.operators[7][C.CATALOG.OPERATOR.SEGMENT]);}isDefault=!!(logic&C.LOGIC.DEFAULT);if(isDefault){response.standard.push(L.DEFAULT);response.segment.push(L.DEFAULT);}else{if(!ECM.Adapter.isEffective(args.data[C.IDX.COLUMN])){response.standard.push('<span class="ecm-condition x-drag-handle">'+L.NEW_CONDITION+"</span>");response.segment.push(L.NEW_CONDITION);}else{var columnId=args.data[C.IDX.COLUMN];var operatorId=args.data[C.IDX.OPERATOR];if("|75|76|77|78|".indexOf("|"+operatorId+"|")>-1){if(operandsAreEqual(args.data[C.IDX.OPERANDS])){operatorId-=20;}}var typeId=type(columnId,C.TAG.ADVANCED);var columnLabel=column(columnId,C.TAG.ADVANCED);response.standard.push('<span class="ecm-condition x-drag-handle">'+columnLabel);response.segment.push(columnLabel);if(typeId!==C.TYPES.NTHING){response.standard.push(operator(operatorId,typeId,C.CATALOG.OPERATOR.STANDARD));response.segment.push(operator(operatorId,typeId,C.CATALOG.OPERATOR.SEGMENT));}response.standard.push(operands(args.data[C.IDX.OPERANDS],{columnId:columnId,operatorId:operatorId,renderMode:C.CATALOG.OPERATOR.STANDARD,tagType:C.TAG.ADVANCED,typeId:typeId}).toString().entitizeBrackets()+"</span>");response.segment.push(operands(args.data[C.IDX.OPERANDS],{columnId:columnId,operatorId:operatorId,renderMode:C.CATALOG.OPERATOR.SEGMENT,tagType:C.TAG.ADVANCED,typeId:typeId}).toString().entitizeBrackets());}}}}return{checked:0,isDefault:isDefault,isGroup:isGroup,segment:response.segment.join(" "),standard:response.standard.join(" ")};},ruleInfo:function(args){if(!window.ecmTargetingModeOn){return this.ruleInfoDC(args);}args=args||{};args.data=args.data||[];if(!args.data.length){return"";}var isDefault=false;var isGroup=false;var isAggregator=false;var editable=true;var response={segment:[],standard:[]};var conditionIcon;var logic=args.data[C.IDX.LOGIC];var metaOr=!!(logic&C.LOGIC.OR);var metaId=(!!(logic&C.LOGIC.EXCLUDE))?((metaOr)?8:9):((metaOr)?5:6);var logicLabels=[__options__.operators[metaId][C.CATALOG.OPERATOR.STANDARD]];var andOrTooltip=gt.gettext("Click on the conjunction to toggle between and/or.");logicLabels.unshift('<span class="ecm-boolean-toggle 3 x-drag-handle">');if(!!(logic&C.LOGIC.EXCLUDE)){logicLabels[C.DATA.MEMBER]=logicLabels[C.DATA.MEMBER].replace(" ",'</span> <span class="ecm-inclusion-toggle ecm-exclusion 4 x-drag-handle">');}else{logicLabels.push("</span> ");
logicLabels.push('<span class="ecm-inclusion-toggle 5 x-drag-handle">');logicLabels.push(L.INCLUDE.toUpperCase());}logicLabels.push("</span>");response.standard.push(logicLabels.join(""));isGroup=!!(logic&C.LOGIC.GROUP);var cls="ecm-condition";if(isGroup){if(!args.data[C.IDX.AGGREGATOR]){var groupText=ECM.Locale.fetch({key:"GROUP"})+": "+(args.data[C.IDX.SOURCE]||"").entitizeBrackets();response.standard.push('<img class="ecm-targeting-icon" src="/images/icon_group.png"/>');response.standard.push('<span class="'+cls+' 6 x-drag-handle" ext:qtip="'+Ext.util.Format.htmlEncode(groupText)+'">');response.standard.push(Ext.util.Format.htmlEncode(groupText)+"</span>");}else{var isCount=args.data[C.IDX.LOGIC]&C.LOGIC.COUNT;var aggregateText=[];var columnId=args.data[C.IDX.AGGREGATOR][C.IDX.COLUMN];var typeId=type(columnId,C.TAG.ADVANCED);var columnLabel;var tableId=args.data[C.IDX.AGGREGATOR][C.IDX.TABLE];var tableLabel="";if(tableId){tableLabel=ECM.Form.FormElements.Table.tblGroupIndex[args.data[C.IDX.AGGREGATOR][C.IDX.TABLE]].text;conditionIcon=tableLabel;}if(isCount&&tableId){columnLabel=tableLabel;}else{columnLabel=tableLabel+" - "+column(columnId,C.TAG.ADVANCED).replace(/^(&nbsp;)+/,"");}var aggLabel=aggregator(args.data[C.IDX.LOGIC]);var isDate=columnId&&[C.TYPES.DATE,C.TYPES.DATETIME].indexOf(__catalog__.columns[2][columnId][1]*1)>-1;var operatorId=args.data[C.IDX.AGGREGATOR][C.IDX.OPERATOR];var operatorVal=operator(operatorId,typeId,C.CATALOG.OPERATOR.STANDARD);var operandsVal=operands(args.data[C.IDX.AGGREGATOR][C.IDX.OPERANDS],{columnId:columnId,operatorId:operatorId,tagType:C.TAG.ADVANCED,typeId:(isDate&&(aggLabel==="min"||aggLabel==="max")?C.TYPES.DATETIME:C.TYPES.NUMERIC)}).toString().entitizeBrackets();aggregateText.push(gt.gettext("Aggregator")+":");if(isCount&&operatorId=="31"&&operandsVal=="1"){aggregateText.push(tableLabel);}else{if(!aggLabel){aggregateText.push(L.NEW_AGGREGATOR);}else{switch(aggLabel){case"unique":aggLabel="unique count";break;case"min":if(isDate){aggLabel="first";}break;case"max":if(isDate){aggLabel="last";}break;}var capitalize=function(val){return val.charAt(0).toUpperCase()+val.slice(1);};aggregateText.push(columnLabel.trim());aggregateText.push(" ("+capitalize(aggLabel));aggregateText.push(operatorVal);aggregateText.push(operandsVal+")");}}cls=ECM.Stash.show_activity_data?"ecm-condition":"ecm-condition-disabled";if(!conditionIcon){conditionIcon="aggregator";}response.standard.push('<img class="ecm-targeting-icon" src="/images/icon_'+conditionIcon.toLowerCase()+'.png"/>');response.standard.push('<span class="'+cls+' 6 x-drag-handle" ext:qtip="'+Ext.util.Format.htmlEncode(aggregateText.join(" "))+'">');response.standard.push(Ext.util.Format.htmlEncode(aggregateText.join(" "))+"</span>");}var segmentLogic=(args.firstChild||[])[C.IDX.LOGIC]||C.LOGIC.NONE;var segmentOr=!!(segmentLogic&C.LOGIC.OR);var segmentMetaId=(!!(logic&C.LOGIC.EXCLUDE))?((segmentOr)?8:9):((segmentOr)?5:6);response.segment.push(__options__.operators[segmentMetaId][C.CATALOG.OPERATOR.SEGMENT]);isAggregator=ECM.Rules.Tablespace.isAggregator(logic)||args.isAggregator;}else{if(!!(logic&C.LOGIC.EXCLUDE)){response.segment.push(__options__.operators[7][C.CATALOG.OPERATOR.SEGMENT]);}isDefault=!!(logic&C.LOGIC.DEFAULT);if(isDefault){response.standard.push(L.DEFAULT);response.segment.push(L.DEFAULT);}else{if(!ECM.Adapter.isEffective(args.data[C.IDX.COLUMN])){response.standard.push('<span class="ecm-condition 7 x-drag-handle">'+L.NEW_CONDITION+"</span>");response.segment.push(L.NEW_CONDITION);}else{var columnId=args.data[C.IDX.COLUMN];var operatorId=args.data[C.IDX.OPERATOR];var typeId=type(columnId,C.TAG.ADVANCED);var columnLabel=column(columnId,C.TAG.ADVANCED).replace(/^(&nbsp;)+/,"");if(columnId.indexOf("ZIP:")>=0){columnLabel=gt.gettext("Zip Code")+" - "+columnLabel;}var conditionText,spanText;var isSegment=columnId==="SEGMENT_ID"&&args.data[C.IDX.TABLE]==="_";if(isSegment){conditionIcon="segment";columnLabel=gt.gettext("Segment");var segName=ECM.Stash.segments_used[args.data[C.IDX.OPERANDS]];conditionText=[columnLabel];conditionText.push(gt.gettext("is"));conditionText.push(segName?segName:args.data[C.IDX.OPERANDS]);}else{conditionText=[];var tableId=args.data[C.IDX.TABLE];if(tableId=="(145)"){tableId="D";}if(tableId){var tblGroupIndex=ECM.Form.FormElements.Table.tblGroupIndex[tableId];conditionIcon=tblGroupIndex.text;if(tableId===__options__.tableAliases.EXT_DB){conditionText.push(tblGroupIndex.text);}}if("|75|76|77|78|".indexOf("|"+operatorId+"|")>-1){if(operandsAreEqual(args.data[C.IDX.OPERANDS])){operatorId-=20;}}conditionText.push(columnLabel);if(aggregator(args.data[C.IDX.LOGIC])){conditionText.push(String.toProperCase(aggregator(args.data[C.IDX.LOGIC])));}if(typeId!==C.TYPES.NTHING){var operatorText=operator(operatorId,typeId,C.CATALOG.OPERATOR.STANDARD);operatorText=operatorText=="is empty"?"is empty (no value)":operatorText;conditionText.push(operatorText);}conditionText.push(operands(args.data[C.IDX.OPERANDS],{columnId:columnId,operatorId:operatorId,renderMode:C.CATALOG.OPERATOR.STANDARD,tagType:C.TAG.ADVANCED,typeId:typeId}).toString().entitizeBrackets());}editable=!isSegment;var segData=ECM.Targeting.Store.SegmentData;if(editable&&segData.restrictAffiliate()){var assocAff=ECM.Targeting.Store.AffiliateAssociative;var isOwnAffiliate=function(values,column){var map=assocAff.getAssociativeAffiliateMap(["","MAILING",column]);var match=true;Ext.each(values,function(value){if(Ext.isEmpty(value)){return true;}if(!map||!map[value]||map[value]!=assocAff.getAffiliateNameById(ECM.Stash.aid)){match=false;return false;}});return match;};var tableName=args.data[C.IDX.TABLE];if(("BCORST".split("").indexOf(tableName)>-1&&!Ext.isEmpty(columnId)&&columnId.match(/AFFILIATE_ID$/))||((tableName=="L")&&!ECM.Stash.has_client_access&&!Ext.isEmpty(columnId)&&columnId.match(/AFFILIATE_ID$/))){editable=false;}else{if(columnId=="PRODUCT_ID"&&tableName=="L"){if(!ECM.Stash.has_client_access&&!Ext.isEmpty(args.data[C.IDX.OPERANDS])){Ext.each(args.data[C.IDX.OPERANDS][0],function(subscriptionID){if(subscriptionID.length===0){return true;}var subscriberListAff=ECM.Targeting.Store.SubscriberList.getSubscriberListAffiliateID(subscriptionID);if(subscriberListAff.indexOf(ECM.Stash.desired_aid)==-1){editable=false;return false;}});}}else{if("BCORSTL".split("").indexOf(tableName)>-1&&columnId.match(/_MAILING_ID$/)){if(!Ext.isEmpty(args.data[C.IDX.OPERANDS])){Ext.each(args.data[C.IDX.OPERANDS][0],function(mailingId){if(Ext.isEmpty(ECM.Stash.mailings_used[mailingId])){editable=false;return false;}if(ECM.Stash.mailings_used[mailingId][1]!=ECM.Stash.aid){editable=false;return false;}});}}else{if("BCORSTL".split("").indexOf(tableName)>-1&&columnId.match(/_MAILING_FOLDER$/)){var mfids=ECM.Targeting.Store.SegmentData.getMailingFolderIds();if(!Ext.isEmpty(args.data[C.IDX.OPERANDS])){Ext.each(args.data[C.IDX.OPERANDS][0],function(mf){if(mfids.indexOf(mf)<0){editable=false;return false;}});if(editable&&ECM.Stash.has_client_access&&!isOwnAffiliate(args.data[C.IDX.OPERANDS][0],"FOLDER")){editable=false;}}}else{if("BCORSTL".split("").indexOf(tableName)>-1&&columnId.match(/_MAILING_CAMPAIGN$/)){var ids=ECM.Targeting.Store.SegmentData.getCampaignIds();if(!Ext.isEmpty(args.data[C.IDX.OPERANDS])){Ext.each(args.data[C.IDX.OPERANDS][0],function(camp){if(ids.indexOf(camp)<0){editable=false;return false;}});if(editable&&ECM.Stash.has_client_access&&!isOwnAffiliate(args.data[C.IDX.OPERANDS][0],"CAMPAIGN")){editable=false;}}}}}}}}var isAggregator=ECM.Rules.Tablespace.isAggregator(args.data[C.IDX.LOGIC]);if(editable&&!ECM.Stash.show_activity_data&&(((["B","C","O","R","S","T"]).indexOf(args.data[C.IDX.TABLE])>-1)||isAggregator)){editable=false;}if(editable&&!ECM.Stash.show_access_location&&(args.data[C.IDX.AGGREGATOR]).search(/(CLICK|OPEN)_(GEOLOCATION|PLATFORM)/)>-1){editable=false;}if(conditionIcon){response.standard.push('<img class="ecm-targeting-icon" src="/images/icon_'+conditionIcon.toLowerCase()+'.png"/>');
}cls=editable?"ecm-condition":"ecm-condition-disabled";spanText='<span class="'+cls+' 8 x-drag-handle"';spanText+=' ext:qtip="'+Ext.util.Format.htmlEncode(conditionText.join(" "));spanText+='">';response.standard.push(spanText);response.segment.push(columnLabel);if(typeId!==C.TYPES.NTHING){response.segment.push(operator(operatorId,typeId,C.CATALOG.OPERATOR.SEGMENT));}response.standard.push(Ext.util.Format.htmlEncode(conditionText.join(" ")));response.standard.push("</span>");var vals=operands(args.data[C.IDX.OPERANDS],{columnId:columnId,operatorId:operatorId,renderMode:C.CATALOG.OPERATOR.SEGMENT,tagType:C.TAG.ADVANCED,typeId:typeId}).toString().entitizeBrackets();if(isSegment){response.segment.push(segName);}else{response.segment.push(vals);}}}}return{checked:0,isDefault:isDefault,isGroup:isGroup,isAggregator:isAggregator,editable:editable,segment:response.segment.join(" "),standard:response.standard.join(" ")};},rulesInfo:function(args){args=args||{};args.data=args.data||[];var attrs={};if(args.internal){var data=args.data.slice(0);var descendants=[];for(var i=0,j=data.length;i<j;i++){var member=data[i];if(!!member[C.DATA.DEFINITION]||!window.ecmTargetingModeOn){(!!!(member[C.DATA.DEFINITION][C.IDX.LOGIC]&C.LOGIC.GROUP))&&(descendants.push(ECM.Rules.Tablespace.ruleInfo(ECM.Adapter.apply(args,{data:member[C.DATA.DEFINITION]})).standard));}var children=ECM.Rules.Tablespace.rulesInfo({data:member[C.DATA.MEMBER],identity:args.identity,internal:C.YES}).rules;(children)&&(descendants.push(children));}attrs.rules=descendants.join(" ");return attrs;}if(!args.data.length){return"";}if(args.topLevel){if(args.isSimpleTag){var isDefault=!!(ECM.Adapter.isArray(args.data[C.DATA.DEFINITION])&&args.data[C.DATA.DEFINITION][C.IDX.LOGIC]&C.LOGIC.DEFAULT);if(args.renderMode==="standard"){attrs.description=args.data[C.DATA.DESCRIPTION];attrs.isDefault=isDefault;attrs.rulesQtip=attrs.rules=ECM.Rules.Tablespace.ruleInfo(ECM.Adapter.apply(args,{data:args.data,key:args.key})).standard.replace(spanRe,"$1");}else{attrs.all=args.data[C.DATA.DESCRIPTION];}}else{args.data[C.DATA.MEMBER]=args.data[C.DATA.MEMBER]||[];var isDefault=!!(args.data[C.DATA.MEMBER][C.IDX.LOGIC]&C.LOGIC.DEFAULT);if(args.renderMode==="standard"){attrs.description=args.data[C.DATA.DEFINITION]||((isDefault)?L.DEFAULT:"");attrs.isDefault=isDefault;attrs.priority=(isDefault)?"":args.pos;attrs.rulesQtip=attrs.rules=String.trim(ECM.Rules.Tablespace.rulesInfo({data:args.data[C.DATA.MEMBER],identity:args.identity,internal:C.YES}).rules.replace(spanRe,"$1").replace(logicRe,""));}else{attrs.all=((isDefault)?"":(args.pos+". "))+args.data[C.DATA.DEFINITION];}}}else{attrs.all=ECM.Rules.Tablespace.ruleInfo(ECM.Adapter.apply(args,{data:((args.isSimpleTag)?args.data:args.data[C.DATA.DEFINITION]),key:args.key})).standard;}if(attrs.description&&attrs.description.entitizeBrackets){attrs.description=attrs.description.entitizeBrackets();}return attrs;},save:function(args){args=args||{};if(!args.identity){return false;}if(!ECM.Rules.Tablespace.dirty({id:args.identity})){ECM.Subscribers.notify({bundle:[ECM.Locale.fetch({key:"NO_CHANGES_MADE"})],topic:C.TOPIC.NOTIFY.WARN});return false;}var struct=__structs__[args.identity]||{};var identity=(args.identity==="__create__")?(struct.buffer.name||""):args.identity;var cmp=Ext.getCmp("dcNameComponent");if(cmp.getValue().length==1){ECM.Subscribers.notify({bundle:[ECM.Locale.fetch({key:"NAME_IS_TOO_SHORT"})],topic:C.TOPIC.NOTIFY.WARN});return false;}if(!cmp.getValue()||!identity){if(cmp){cmp.markInvalid();}ECM.Subscribers.notify({bundle:[ECM.Locale.fetch({key:"NAME_IS_REQUIRED"})],topic:C.TOPIC.NOTIFY.WARN});return false;}if(!struct.data.description){ECM.Subscribers.notify({bundle:[ECM.Locale.fetch({key:"DESCRIPTION_IS_REQUIRED"})],topic:C.TOPIC.NOTIFY.WARN});var cmp=Ext.getCmp("dcDescriptionComponent");if(cmp){cmp.markInvalid();}return false;}ECM.Subscribers.notify({bundle:[ECM.Locale.fetch({key:"SAVING"})+"..."],topic:C.TOPIC.LOADING.SHOW});var params={dc_id:struct.dcid,desired_aid:struct.desiredAid,last_modified:struct.data.last_modified,mfid:struct.mfid,mid:struct.mid,mtype:struct.mailingType,rs_id:identity};if(struct.useLibrary){delete params.last_modified;}var leftNavPanel=Ext.getCmp("leftnav_panel");if(Ext.isDefined(leftNavPanel)&&!Ext.isEmpty(leftNavPanel.dcLibOverwrite)){var dcLibOverwrite=leftNavPanel.dcLibOverwrite;var dcTag="d_"+identity.toLowerCase();if(dcLibOverwrite.indexOf(dcTag)>=0){params.dclib_overwrite=ECM.Adapter.encode([dcTag]);}if(Ext.isDefined(leftNavPanel.libTags)){delete leftNavPanel.libTags[dcTag.toUpperCase()];}}params=Object.extend(params,struct.buffer);if(params.key){params.key="D."+params.key;}if(struct.mid<0){var libraryTags=struct.data.tags||[];params.tag_id="["+libraryTags.join(",")+"]";delete params.tags;}params.definitions=ECM.Adapter.encode(params.definitions);ECM.Ajax.request({url:ECM.Rules.Constants.URL.DYNAMIC_CONTENT_SET+"?action="+C.SERVICES.SAVE+"",params:params,method:"POST",success:function(response){document.body.style.cursor="";var newDescription=struct.data.description;var newIdentity=false;var newTagType=struct.tagType;var json=response.responseJSON||{data:{}};error_message=errorMessageFromJson(json);args.bundle=args.bundle||{};if(error_message||json.authentication_error){args.bundle.status=2;args.bundle.reason=error_message;ECM.Subscribers.notify({topic:C.TOPIC.LOADING.HIDE});ECM.Subscribers.notify({bundle:[args.bundle.reason],topic:C.TOPIC.NOTIFY.ERROR});}else{json=json.data;try{args.bundle.status=1;newIdentity=(struct.buffer.name&&args.identity!==struct.buffer.name)?struct.buffer.name:false;bufferClear({identity:args.identity});struct.dirty=C.DIRTY.NONE;struct.data.last_modified=json.data.last_modified;(struct.isAmbivalent)&&(struct.pages[C.DATA.MEMBER]=C.YES);struct.isAmbivalent=false;if(struct.data.rules){for(var i=0,nRules=struct.data.rules.length;i<nRules;i++){struct.data.rules[i].original=i;}}if(newIdentity&&newIdentity!==args.identity){var renameParams=ECM.Adapter.apply({isRename:true,newIdentity:newIdentity,onClose:struct.onClose,onSave:struct.onSave},ECM.Rules.Tablespace.otherIdentities(args.identity));ECM.Subscribers.notify({bundle:[renameParams],topic:C.TOPIC.TAG.CHANGE});struct.saved.push(newIdentity);}else{struct.saved.push(identity);}__structs__.dcFormIdentity=identity;if(!Ext.isEmpty(json.data.dclib_overwrite)&&Ext.isDefined(leftNavPanel)&&!Ext.isEmpty(leftNavPanel.dcLibOverwrite)){Ext.each(json.data.dclib_overwrite,function(dcLibTag){delete leftNavPanel.dcLibOverwrite[leftNavPanel.dcLibOverwrite.indexOf(dcLibTag)];});}if(struct.mid<0&&args.identity==="__create__"){Ext.getCmp("dcDeleteTagBtn").__data__.object_id=json.data.id;}ECM.Subscribers.notify({topic:C.TOPIC.LOADING.HIDE});if(json.data.mailing_unapproved){ECM.Subscribers.notify({bundle:[ECM.Locale.fetch({key:"MAILING_HAS_BEEN_UNAPPROVED_DUE_TO_THIS_CHANGE"})],topic:C.TOPIC.NOTIFY.ERROR});window.setTimeout(function(){ECM.Subscribers.notify({bundle:[ECM.Locale.fetch({key:"SAVED_AT",params:[new Date(json.data.last_modified*1000).format("M d, Y h:i a")]})],topic:C.TOPIC.NOTIFY.INFO});},3000);}else{ECM.Subscribers.notify({bundle:[ECM.Locale.fetch({key:"SAVED_AT",params:[new Date().format("M d, Y h:i a")]})],topic:C.TOPIC.NOTIFY.INFO});}Ext.getCmp("dcDeleteTagBtn").show();}catch(err){var message=ECM.Locale.fetch({key:"SAVED_AT",params:[new Date().format("M d, Y h:i a")]});message+=" "+L.AND+" "+ECM.Locale.fetch({key:"MODAL_ENCOUNTERED_PROBLEM"});failure({message:message});}if(struct.onSave){var saveParams={description:newDescription,identity:args.identity,tagType:newTagType};if(newIdentity){saveParams.name=newIdentity;}struct.onSave(saveParams);}(args.callback||function(){})(args.bundle);}},failure:function(response){document.body.style.cursor="";var json=response.responseJSON||{data:{}};var error_message=gt.gettext("There was a system error. Please retry your request.");if(json&&(json.error||json.authorization_errors||json.application_errors)){error_message=errorMessageFromJson(json);
}args.bundle=args.bundle||{};if(error_message||json.authentication_error){args.bundle.status=2;args.bundle.reason=error_message;ECM.Subscribers.notify({topic:C.TOPIC.LOADING.HIDE});ECM.Subscribers.notify({bundle:[args.bundle.reason],topic:C.TOPIC.NOTIFY.ERROR});}(args.failure||failure)({message:error_message});}});},targeting:function(args){args=args||{};args.handleAs="targeting";properties(args);},targetingAndContent:function(args){args=args||{};args.handleAs="targetingAndContent";properties(args);},totalPages:function(args){if(args&&ECM.Adapter.isEffective(args.identity)){var struct=__structs__[args.identity]||{};var keywordId=encodeURIComponent(args.keyword||"__master__");if(args.force||!struct.totalPages[keywordId]){var count=(args.keyword)?struct.data.values.search[keywordId].count:struct.data.count;struct.totalPages[keywordId]=Math.ceil(count/__flags__.pageSize);if(struct.totalPages[keywordId]<1){struct.totalPages[keywordId]=1;}}return struct.totalPages[keywordId];}return 0;},totalRules:function(args){var count=0;if(args&&ECM.Adapter.isEffective(args.identity)){var struct=__structs__[args.identity]||{};var data=struct.data||{};if(struct.tagType===C.TAG.ADVANCED){count=((data.rules||[]).length-1)||0;(count<0)&&(count=0);}else{if(args.keyword){count=(data.values.search[encodeURIComponent(args.keyword)]||{}).count||0;}else{count=data.count||0;}}}return count;},truncate:truncate,unPage:function(args){return doPage(Object.extend(args,{defaultValue:C.NO}));},updateContent:function(args){if(args){args.values=args.values||[];if(!args.values.length){return false;}args.rowIndex=String.toInt(args.rowIndex);var struct=__structs__[args.identity]||{};var isDefault=false;var identifier;if(ECM.Rules.Tablespace.isSimpleTag({struct:struct})){var rowIndex=args.rowIndex*2;isDefault=!ECM.Adapter.isEffective(struct.data.values[rowIndex]);if(isDefault){var defaultValue=L.DEFAULT.toLowerCase();struct.data.defaults=struct.data.defaults||[];identifier=struct.data.defaults[C.DATA.VALUE]||defaultValue;}else{struct.data.values.originals=struct.data.values.originals||{};var value=struct.data.values[rowIndex];identifier=ECM.Rules.Tablespace.identifier({struct:struct,value:value});}}else{var count=ECM.Rules.Tablespace.totalRules({identity:args.identity});if(args.rowIndex>count){args.rowIndex=count;}identifier=ECM.Rules.Tablespace.identifier({rowIndex:args.rowIndex,struct:struct});if(ECM.Rules.Tablespace.isDefault({rowIndex:args.rowIndex,struct:struct})){identifier="";}}var data=struct.data.content[args.rowIndex];if(!data){Array.insertAt(struct.data.content,[],args.rowIndex);data=struct.data.content[args.rowIndex];}for(var i=0,j=args.values.length;i<j;i++){data[i]=(ECM.Adapter.isEffective(args.values[i]))?args.values[i]:((ECM.Adapter.isEffective(data[i]))?data[i]:null);}eval((isDefault)?"bufferDefaultContent":"bufferModifyContent")({data:data,dirty:C.DIRTY.CONTENT,identifier:identifier,identity:args.identity});}},updateDescription:function(args){if(args){var struct=__structs__[args.identity]||{};struct.data.description=args.value;bufferDescription({data:struct.data.description,dirty:C.DIRTY.DESCRIPTION,identity:args.identity});}},updateLibraryTags:function(args){if(args){var struct=__structs__[args.identity]||{};struct.data.tags=args.value;bufferLibraryTags({data:struct.data.tags,dirty:C.DIRTY.LIBRARY_TAGS,identity:args.identity});}},updateKeyLabel:function(args){args=args||{};args.identity=args.identity||"";args.renderMode=args.renderMode||"standard";var renderMode=(args.renderMode==="standard")?C.CATALOG.OPERATOR.STANDARD:C.CATALOG.OPERATOR.SEGMENT;var key=((__structs__[args.identity]||{}).data||{}).key||"";var operatorId=__flags__.defaultOperator;return{keyLabel:column(key),operatorLabel:operator(operatorId,type(key),renderMode)};},updateLogic:function(args){if(args){args.rowIndex=String.toInt(args.rowIndex);var struct=__structs__[args.identity]||{};if(struct.tagType!==C.TAG.SIMPLE){var data=struct.data.rules[args.rowIndex];var rule=ECM.Rules.Tablespace.findRuleByPath({data:data[C.DATA.MEMBER],path:args.indexPath,separator:args.separator});if(args.value){args.value&=~(C.LOGIC.LEAF|C.LOGIC.GROUP);args.value|=(!!(rule[C.IDX.LOGIC]&C.LOGIC.GROUP))?C.LOGIC.GROUP:C.LOGIC.LEAF;if(args.clickTarget&&args.clickTarget=="boolean"){args.value&=~(C.LOGIC.INCLUDE|C.LOGIC.EXCLUDE);args.value|=(!!(rule[C.IDX.LOGIC]&C.LOGIC.EXCLUDE))?C.LOGIC.EXCLUDE:C.LOGIC.INCLUDE;}rule[C.IDX.LOGIC]=args.value;var identifier=ECM.Rules.Tablespace.identifier({rowIndex:args.rowIndex,struct:struct});bufferModify({data:data,dirty:C.DIRTY.TARGETING,identifier:identifier,identity:args.identity});}return ECM.Rules.Tablespace.ruleInfo({isAggregator:args.isAggregator,data:rule,firstChild:args.firstChild,identity:args.identity});}return false;}return false;},updateName:function(args){if(args){var struct=__structs__[args.identity]||{};struct.data.name=args.value;bufferName({data:struct.data.name,dirty:C.DIRTY.NAME,identity:args.identity});}},updateRuleDC:function(args){var firstChild;if(args){args.rowIndex=String.toInt(args.rowIndex);var struct=__structs__[args.identity]||{};var isSimpleTag=ECM.Rules.Tablespace.isSimpleTag({struct:struct});var key,rule;if(isSimpleTag){var rowIndex=args.rowIndex*2;if(ECM.Adapter.isEffective(args.columnId)&&(rowIndex===0||args.forceChangeField)&&args.columnId!==struct.data.key){struct.data.key=args.columnId;bufferKey({data:struct.data.key,dirty:C.DIRTY.KEY,identity:args.identity});}key=struct.data.key;if(ECM.Adapter.isArray(args.operands)&&args.operands.length>0){var newValue=args.operands[C.OPERANDS.FIRST][C.DATA.VALUE]||"";struct.data.values.search=struct.data.values.search||{};for(var keywordId in struct.data.values.search){var keyword=decodeURIComponent(keywordId);var location=ECM.Rules.Tablespace.findRuleSearchLocation({identity:args.identity,keyword:keyword,rowIndex:args.rowIndex});if(location.rowIndex>-1){struct.data.values.search[keywordId][(location.rowIndex*2)]=newValue;}}struct.data.values.originals=struct.data.values.originals||{};var value=struct.data.values[rowIndex];var identifier=ECM.Rules.Tablespace.identifier({struct:struct,value:value});struct.data.values.originals[newValue]=identifier;struct.data.values[rowIndex]=newValue;bufferMove({data:[identifier,newValue],dirty:C.DIRTY.TARGETING,identity:args.identity});}var values=struct.data.values;rule=[values[rowIndex],values[rowIndex+1]];if(args.switchToAdvanced){if(!struct.data.key){struct.data.key=args.columnId;}ECM.Subscribers.notify({topic:C.TOPIC.LOADING.SHOW});ECM.Rules.Tablespace.convert({bundle:args,identity:args.identity,rowIndex:args.rowIndex});}}else{var data=struct.data.rules[args.rowIndex];rule=ECM.Rules.Tablespace.findRuleByPath({data:data[C.DATA.MEMBER],path:args.indexPath,separator:args.separator});if(!!(rule[C.IDX.LOGIC]&C.LOGIC.GROUP)){rule[C.IDX.SOURCE]=args.group;firstChild=ECM.Rules.Tablespace.findRuleByPath({data:data[C.DATA.MEMBER],path:(args.indexPath+args.separator+C.DATA.FIRST),separator:args.separator});}else{rule[C.IDX.LOGIC]=args.newLogic;rule[C.IDX.COLUMN]=args.columnId;rule[C.IDX.TABLE]=table(rule[C.IDX.COLUMN]);(ECM.Adapter.isEffective(args.aggregateId))&&(rule[C.IDX.AGGREGATE]=args.aggregateId);var typeId=type(args.columnId,C.TAG.ADVANCED);switch(typeId){case C.TYPES.ASSOCIATIVE:case C.TYPES.SUBSCRIPTION:case C.TYPES.ZIP:case C.TYPES.ZIP_STATE:case C.TYPES.ZIP_CSTATE:case C.TYPES.ZIP_MSA:case C.TYPES.ZIP_CMSA:case C.TYPES.ZIP_MA:case C.TYPES.PLATFORM:case C.TYPES.GEOLOCATION:(ECM.Adapter.isEffective(args.operatorId))&&(rule[C.IDX.OPERATOR]=Number(args.operatorId));(!rule[C.IDX.OPERATOR]||isNaN(rule[C.IDX.OPERATOR]))&&(rule[C.IDX.OPERATOR]=__flags__.associativeOperator);(args.operands=(ECM.Adapter.isArray(args.operands))?args.operands:[args.operands]);break;case C.TYPES.BEHAVIOR:(!rule[C.IDX.OPERATOR]||isNaN(rule[C.IDX.OPERATOR]))&&(rule[C.IDX.OPERATOR]=__flags__.defaultOperator);break;case C.TYPES.NTHING:rule[C.IDX.OPERATOR]=__flags__.nthingOperator;break;default:(ECM.Adapter.isEffective(args.operatorId))&&(rule[C.IDX.OPERATOR]=Number(args.operatorId));
if(!rule[C.IDX.OPERATOR]||isNaN(rule[C.IDX.OPERATOR])){rule[C.IDX.OPERATOR]=(typeId===C.TYPES.DATE)?__flags__.dateOperator:__flags__.defaultOperator;}break;}rule[C.IDX.OPERANDS]=args.operands;}var identifier=ECM.Rules.Tablespace.identifier({rowIndex:args.rowIndex,struct:struct});bufferModify({data:data,dirty:C.DIRTY.TARGETING,identifier:identifier,identity:args.identity});}}return(args.switchToAdvanced)?false:ECM.Rules.Tablespace.ruleInfo({data:rule,firstChild:firstChild,identity:args.identity,isSimpleTag:isSimpleTag,key:key});},updateRule:function(args){if(!window.ecmTargetingModeOn){return this.updateRuleDC(args);}var firstChild;if(args){args.rowIndex=String.toInt(args.rowIndex);var struct=__structs__[args.identity]||{};var isSimpleTag=ECM.Rules.Tablespace.isSimpleTag({struct:struct});var key,rule;var data=struct.data.rules[args.rowIndex];rule=ECM.Rules.Tablespace.findRuleByPath({data:data[C.DATA.MEMBER],path:args.indexPath,separator:args.separator});if(args.newLogic){if(args.newLogic&C.LOGIC.INCLUDE){rule[C.IDX.LOGIC]&=~C.LOGIC.EXCLUDE;rule[C.IDX.LOGIC]|=C.LOGIC.INCLUDE;}else{rule[C.IDX.LOGIC]&=~C.LOGIC.INCLUDE;rule[C.IDX.LOGIC]|=C.LOGIC.EXCLUDE;}if(args.newLogic&C.LOGIC.AND){rule[C.IDX.LOGIC]&=~C.LOGIC.OR;rule[C.IDX.LOGIC]|=C.LOGIC.AND;}else{rule[C.IDX.LOGIC]&=~C.LOGIC.AND;rule[C.IDX.LOGIC]|=C.LOGIC.OR;}}var aggregateTotal=0;Ext.each(C.LOGIC_AGGREGATORS,function(agg,i,aggs){aggregateTotal+=C.LOGIC[agg];});rule[C.IDX.LOGIC]&=~aggregateTotal;if(args.aggregator&&args.aggregator>-1){rule[C.IDX.LOGIC]|=args.aggregator;}if(!!(rule[C.IDX.LOGIC]&C.LOGIC.GROUP)){if(dcForm.sourceTreeNode.attributes.isAggregator&&args.aggregator){var aggGroup=[];aggGroup[C.IDX.LOGIC]=rule[C.IDX.LOGIC];aggGroup[C.IDX.COLUMN]=rule[C.IDX.LOGIC]&C.LOGIC.COUNT?"":args.columnId;aggGroup[C.IDX.TABLE]=args.table;var typeId=type(args.columnId,C.TAG.ADVANCED);(ECM.Adapter.isEffective(args.operatorId))&&(aggGroup[C.IDX.OPERATOR]=Number(args.operatorId));if(!aggGroup[C.IDX.OPERATOR]||isNaN(aggGroup[C.IDX.OPERATOR])){aggGroup[C.IDX.OPERATOR]=(typeId===C.TYPES.DATE)?__flags__.dateOperator:__flags__.defaultOperator;}aggGroup[C.IDX.OPERANDS]=args.operands;args.group="Aggregator";rule[C.IDX.AGGREGATOR]=aggGroup;}rule[C.IDX.SOURCE]=args.group;firstChild=ECM.Rules.Tablespace.findRuleByPath({data:data[C.DATA.MEMBER],path:(args.indexPath+args.separator+C.DATA.FIRST),separator:args.separator});}else{rule[C.IDX.COLUMN]=args.columnId;rule[C.IDX.TABLE]=table(rule[C.IDX.COLUMN]);(ECM.Adapter.isEffective(args.aggregateId))&&(rule[C.IDX.AGGREGATE]=args.aggregateId);var typeId=type(args.columnId,C.TAG.ADVANCED);switch(typeId){case C.TYPES.ASSOCIATIVE:case C.TYPES.SUBSCRIPTION:case C.TYPES.ZIP:case C.TYPES.ZIP_STATE:case C.TYPES.ZIP_CSTATE:case C.TYPES.ZIP_MSA:case C.TYPES.ZIP_CMSA:case C.TYPES.ZIP_MA:case C.TYPES.PLATFORM:case C.TYPES.GEOLOCATION:(ECM.Adapter.isEffective(args.operatorId))&&(rule[C.IDX.OPERATOR]=Number(args.operatorId));(!rule[C.IDX.OPERATOR]||isNaN(rule[C.IDX.OPERATOR]))&&(rule[C.IDX.OPERATOR]=__flags__.associativeOperator);(args.operands=(ECM.Adapter.isArray(args.operands))?args.operands:[args.operands]);break;case C.TYPES.BEHAVIOR:rule[C.IDX.OPERATOR]=args.operator||__flags__.defaultOperator;break;case C.TYPES.NTHING:rule[C.IDX.OPERATOR]=__flags__.nthingOperator;break;default:(ECM.Adapter.isEffective(args.operatorId))&&(rule[C.IDX.OPERATOR]=Number(args.operatorId));if(!rule[C.IDX.OPERATOR]||isNaN(rule[C.IDX.OPERATOR])){rule[C.IDX.OPERATOR]=(typeId===C.TYPES.DATE)?__flags__.dateOperator:__flags__.defaultOperator;}break;}rule[C.IDX.OPERANDS]=args.operands;}var identifier=ECM.Rules.Tablespace.identifier({rowIndex:args.rowIndex,struct:struct});bufferModify({data:data,dirty:C.DIRTY.TARGETING,identifier:identifier,identity:args.identity});}return(args.switchToAdvanced)?false:ECM.Rules.Tablespace.ruleInfo({data:rule,firstChild:firstChild,identity:args.identity,isSimpleTag:isSimpleTag,key:key});},updateRules:function(args){args=args||{};if(!ECM.Adapter.isEffective(args.identity)||!ECM.Adapter.isEffective(args.rowIndex)){return{};}args.rowIndex=String.toInt(args.rowIndex);var struct=__structs__[args.identity]||{};var isSimpleTag=ECM.Rules.Tablespace.isSimpleTag({struct:struct});if(isSimpleTag){var rowIndex=args.rowIndex*2;var values=struct.data.values;var rule=[values[rowIndex],values[rowIndex+1]];if(args.renderMode==="standard"){return ECM.Rules.Tablespace.rulesInfo({data:rule,identity:args.identity,isSimpleTag:isSimpleTag,key:struct.data.key,pos:(rowIndex+1),renderMode:args.renderMode,topLevel:C.YES});}else{return{all:ECM.Rules.Tablespace.ruleInfo({data:rule,identity:args.identity,isSimpleTag:isSimpleTag,key:struct.data.key}).standard};}}else{var data=struct.data.rules[args.rowIndex];if(args.renderMode==="standard"){return ECM.Rules.Tablespace.rulesInfo({data:data,identity:args.identity,pos:(args.rowIndex+1),renderMode:args.renderMode,topLevel:C.YES});}else{var rule=ECM.Rules.Tablespace.findRuleByPath({data:data[C.DATA.MEMBER],path:args.indexPath,separator:args.separator});return{all:ECM.Rules.Tablespace.ruleInfo({data:rule,identity:args.identity}).standard};}}},updateRulesLabel:function(args){args=args||{};if(!ECM.Adapter.isEffective(args.identity)||!ECM.Adapter.isEffective(args.rowIndex)){return false;}args.rowIndex=String.toInt(args.rowIndex);var data,identifier;var struct=__structs__[args.identity]||{};var isDefault=false;if(ECM.Rules.Tablespace.isSimpleTag({struct:struct})){var rowIndex=args.rowIndex*2;var count=ECM.Rules.Tablespace.totalRules({identity:args.identity});isDefault=(args.rowIndex===count&&!ECM.Adapter.isEffective(struct.data.values[rowIndex]));if(isDefault){var defaultValue=L.DEFAULT.toLowerCase();struct.data.defaults=struct.data.defaults||[];var value=identifier=struct.data.defaults[C.DATA.VALUE]||defaultValue;data=struct.data.defaults[C.DATA.DESCRIPTION]=args.value;}else{struct.data.values.search=struct.data.values.search||{};for(var keywordId in struct.data.values.search){var keyword=decodeURIComponent(keywordId);var location=ECM.Rules.Tablespace.findRuleSearchLocation({identity:args.identity,keyword:keyword,rowIndex:args.rowIndex});if(location.rowIndex>-1){struct.data.values.search[keywordId][(location.rowIndex*2)+1]=args.value;}}struct.data.values.originals=struct.data.values.originals||{};var value=struct.data.values[rowIndex];identifier=ECM.Rules.Tablespace.identifier({struct:struct,value:value});data=struct.data.values[rowIndex+1]=args.value;}}else{data=struct.data.rules[args.rowIndex];data[C.DATA.DEFINITION]=args.value;identifier=ECM.Rules.Tablespace.identifier({rowIndex:args.rowIndex,struct:struct});if(ECM.Rules.Tablespace.isDefault({rowIndex:args.rowIndex,struct:struct})){identifier="";}}eval((isDefault)?"bufferDefault":"bufferModify")({data:data,dirty:C.DIRTY.TARGETING,identifier:identifier,identity:args.identity});return args.value;},wrap:function(args){args=args||{};if(ECM.Adapter.isEffective(args.data)){bufferWrap({data:args.data,dirty:C.DIRTY.CONTENT,identity:args.identity});}return((__structs__[args.identity]||{}).buffer||{}).wrap_width;},_bogus:true});ECM.Adapter.onUnload(function(){ECM.Rules.Tablespace.truncate();__ascendants__=__caches__=__catalog__=__options__=__structs__=__flags__=null;});})();}Ext.ns("Ext.ux.form");Ext.ux.form.FileUploadField=Ext.extend(Ext.form.TextField,{buttonText:"Browse...",buttonOnly:false,buttonOffset:3,readOnly:true,autoSize:Ext.emptyFn,initComponent:function(){Ext.ux.form.FileUploadField.superclass.initComponent.call(this);this.addEvents("fileselected");},onRender:function(c,a){Ext.ux.form.FileUploadField.superclass.onRender.call(this,c,a);this.wrap=this.el.wrap({cls:"x-form-field-wrap x-form-file-wrap"});this.el.addClass("x-form-file-text");this.el.dom.removeAttribute("name");this.createFileInput();var b=Ext.applyIf(this.buttonCfg||{},{text:this.buttonText});this.button=new Ext.Button(Ext.apply(b,{renderTo:this.wrap,cls:"x-form-file-btn"+(b.iconCls?" x-btn-icon":"")}));if(this.buttonOnly){this.el.hide();this.wrap.setWidth(this.button.getEl().getWidth());
}this.bindListeners();this.resizeEl=this.positionEl=this.wrap;},bindListeners:function(){this.fileInput.on({scope:this,mouseenter:function(){this.button.addClass(["x-btn-over","x-btn-focus"]);},mouseleave:function(){this.button.removeClass(["x-btn-over","x-btn-focus","x-btn-click"]);},mousedown:function(){this.button.addClass("x-btn-click");},mouseup:function(){this.button.removeClass(["x-btn-over","x-btn-focus","x-btn-click"]);},change:function(){var a=this.fileInput.dom.value;this.setValue(a);this.fireEvent("fileselected",this,a);}});},createFileInput:function(){this.fileInput=this.wrap.createChild({id:this.getFileInputId(),name:this.name||this.getId(),cls:"x-form-file",tag:"input",type:"file",size:1});},reset:function(){if(this.rendered){this.fileInput.remove();this.createFileInput();this.bindListeners();}Ext.ux.form.FileUploadField.superclass.reset.call(this);},getFileInputId:function(){return this.id+"-file";},onResize:function(a,b){Ext.ux.form.FileUploadField.superclass.onResize.call(this,a,b);this.wrap.setWidth(a);if(!this.buttonOnly){var a=this.wrap.getWidth()-this.button.getEl().getWidth()-this.buttonOffset;this.el.setWidth(a);}},onDestroy:function(){Ext.ux.form.FileUploadField.superclass.onDestroy.call(this);Ext.destroy(this.fileInput,this.button,this.wrap);},onDisable:function(){Ext.ux.form.FileUploadField.superclass.onDisable.call(this);this.doDisable(true);},onEnable:function(){Ext.ux.form.FileUploadField.superclass.onEnable.call(this);this.doDisable(false);},doDisable:function(a){this.fileInput.dom.disabled=a;this.button.setDisabled(a);},preFocus:Ext.emptyFn,alignErrorIcon:function(){this.errorIcon.alignTo(this.wrap,"tl-tr",[2,0]);}});Ext.reg("fileuploadfield",Ext.ux.form.FileUploadField);Ext.form.FileUploadField=Ext.ux.form.FileUploadField;Ext.ns("ECM.Form");ECM.provide("ECM.Form.DCOptions");ECM.DCOptions=function(){var a=new Ext.form.ComboBox({editable:false,store:new Ext.data.SimpleStore({fields:["typeval"],data:[["Comma, double quoted"],["Comma, single quoted"],["Comma"],["Tab, double quoted"],["Tab, single quoted"],["Tab"],["Pipe, double quoted"],["Pipe, single quoted"],["Pipe"]]}),displayField:"typeval",emptyText:"Please Select...",forceSelection:true,triggerAction:"all",fieldLabel:"Format",mode:"local",name:"format",value:"Comma, double quoted",width:200});a.setValue("Comma, double quoted");var c=new Ext.form.ComboBox({editable:false,store:new Ext.data.SimpleStore({fields:["typeval"],data:[["Select Link Tracking Option..."],["Based on &lt;a href&gt; URLs"],["Based on &lt;a href&gt; URLs (base URL only; suppress parameters)"],["Based on Absolute URLs (Http)"],["Based on Absolute URLs (Http-base URL only; suppress parameters)"]]}),displayField:"typeval",fieldLabel:"Track URLs",forceSelection:false,triggerAction:"all",mode:"local",name:"track",width:400});c.setValue("Select Link Tracking Option...");var b={xtype:"fieldset",title:"Upload options",cls:"ecm-upload-options",autoHeight:true,items:[a,c,{xtype:"checkbox",name:"isEncoded",fieldLabel:"URL Encoded"}]};return b;};ECM.provide("ECM.Library.Modal.Upload");ECM.Library.Modal.Upload=Ext.extend(ECM.Form.UploadDialog,{multiContent:true,allowImages:true,recIdTextField:{},uploadWindowWidth:850,lineNumberTextField:{},allowEncodingConversion:true,constructor:function(a){this.windowingClass=ECM.Window;this.addEvents("uploadSucceeded","uploadFailed");ECM.Form.UploadDialog.getInstance=(function(){return this;}).createDelegate(this);ECM.Library.Modal.Upload.superclass.constructor.apply(this,arguments);this.setMode("content");},getBaseParams:function(){return{};},display:function(){ECM.Library.Modal.Upload.superclass.display.apply(this,arguments);if(this.errorObj){this.errorObj.destroy();}},addUploadGrid:function(){var c=new Ext.data.ArrayStore({storeId:"uploadStore",fields:this.uploadRecordTemplate});var a=new Ext.grid.GridPanel({id:"uploadGrid",store:c,width:"100%",colModel:new Ext.grid.ColumnModel({columns:[{id:"name",header:gt.gettext("Name"),dataIndex:"name",sortable:false,width:200,renderer:function(j,f,d,l,h,g){var k="name_"+d.id;(function(){if(!this.recIdTextField[d.id]){var m=new Ext.form.TextField({renderTo:k,name:"name_"+this.lineNumberPlaceholder,hidden:true});if(Ext.isMac&&Ext.isSafari4){m.setWidth(130);}this.recIdTextField[d.id]=m;this.lineNumberTextField[this.lineNumberPlaceholder]=m;}else{this.recIdTextField[d.id].render(k);}}).defer(25,this);return(String.format('<span id="{0}"></span>',k));},scope:this},{id:"file",header:gt.gettext("File"),dataIndex:"file",sortable:false,width:245},{id:"type",header:gt.gettext("Type"),dataIndex:"type",sortable:false,width:185},{id:"options",header:gt.gettext("Options"),dataIndex:"options",sortable:false,width:435},{id:"remove",header:"",dataIndex:"remove",sortable:false,align:"center","vertical-align":"middle",width:29}]}),stripeRows:true,autoExpandColumn:"options",viewConfig:{forceFit:true},enableHdMenu:false,enableColumnMove:false,enableColumnResize:false,autoWidth:true,height:300,columnLines:true,renderTo:"uploadContainer",trackMouseOver:false,cls:"upload-content-panel library-upload"});var b=this;a.on("viewready",function(){b.addUploadLine();});this.loadMask=new Ext.LoadMask(this.uploadWindow.getEl(),{msg:gt.gettext("Uploading Files")});this.showMsg=true;this.needRefreshGrid=false;this.uploadWindow.on("close",function(){if(this.needRefreshGrid===true){this.fireEvent("uploadSucceeded",this.showMsg);}},this);},addUploadLine:function(){var a=ECM.Library.Modal.Upload.superclass.addUploadLine.apply(this,arguments);var b="fileType_"+a;Ext.getCmp(b).on("select",function(f,c){var d=f.getRawValue()!=="Dynamic Content"?"show":"hide";this.lineNumberTextField[f.name.split("_")[1]][d]();},this);},uploadContent:function(){var o=new Ext.form.BasicForm("uploadForm"),d=new Ext.form.BasicForm("uploadForm").getValues(),l={},f=[],g,a,h,m;Ext.iterate(d,function(q){var p=q.split("_"),r=p.pop();if(!r){return true;}if(!l[r]){l[r]={file_param:"fileName_"+r};}l[r][p.join("_")]=d[q];});var b={invalid:false,reason:"noName"};var c={};Ext.iterate(l,function(w,s){s.no_transaction=true;var x=["Dynamic Content"];if(this.allowImages){x.push("Image Files");}x=x.concat(["Text Content","HTML Content","Rich Text Content"]);var u={};var y="content";Ext.iterate(x,function(z){u[gt.gettext(z)]=z;});var v=u[s.fileType]||"";var r=Ext.getDom(s.file_param);var p=r?r.value:undefined;if(g=v.match("^(.*?) Content$")){if(g[1]==="Dynamic"){a="/cm/r/library/dynamic_content";s.overwrite="on";}else{a="/cm/r/library/content";s.format=g[1];}}else{if(g=v.match("Image Files")){a="/cm/r/library/image";s.image_type="i";y="image";if(p.match(/\s/)){b.invalid=true;b.reason="fileNameSpace";b.vars=p;return false;}}else{if(p&&p.length&&p.length>0){b.invalid=true;b.reason="missingType";return false;}else{return true;}}}if(g[1]!=="Dynamic"){if(!s.name.match(/.+/)){b.invalid=true;return false;}var q=y+"~~~"+s.name;if(c[q]){b.invalid=true;b.reason="dupName";return false;}else{c[q]=true;}}var t={url:a,params:s};f.push(t);},this);if(!o.getEl().dom.batch){h=new Ext.form.Hidden({name:"batch"});h.render(o.getEl());}o.getEl().dom.batch.value=Ext.encode(f);if(b.invalid){var k={noName:gt.gettext("Name is a required field."),dupName:gt.gettext("Name must be unique by type."),fileNameSpace:gt.gettext('Illegal filename: "{0}"'),missingType:gt.gettext("Type is a required field.")};var n={selector:".errorText",width:450,message:String.format.apply(window,[k[b.reason]].concat(b.vars))};ECM.publish("/notify/error/clear",n);return;}var j=(function(p){this.loadMask.hide();if(calls=p.responseJSON){ECM.publish("/notify/clear",{selector:".errorText"});Ext.each(calls,function(r){if(r.error&&r.error.length>0){var q=Ext.unique(r.error);Ext.each(q,function(s){var t=s.split(":");if(t[0]=="Name already exists"){ECM.publish("/notify/error/create",{selector:".errorText",width:450,message:t[1]+" already exists. Please enter a different name."});}else{ECM.publish("/notify/error/create",{selector:".errorText",width:450,message:s});}},this);
this.uploadWindow.syncShadow();}},this);this.fireEvent("uploadFailed");}}).createDelegate(this);this.loadMask.show();this.showMsg=false;this.needRefreshGrid=true;ECM.Ajax.request({form:"uploadForm",method:"POST",url:"/cm/r",isUpload:true,handleAs:"json",success:(function(p){var r=true,q;this.loadMask.hide();this.showMsg=true;this.uploadWindow.close();j();}).createDelegate(this),failure:j});}});ECM.provide("ECM.Mailing.MailingList.FilterHeader");ECM.Mailing.MailingList.FilterHeader=Ext.extend(Ext.Toolbar,{constructor:function(a){ECM.Mailing.MailingList.FilterHeader.superclass.constructor.apply(this,arguments);Ext.apply(this,new ECM.Mailing.MailingList.FilterControlBase());this.addEvents("filter");this.height=30;this.pageType=a.pageType;this.style={"background-image":"none","background-color":"transparent",border:"0"};this.filterHeaderReload();ECM.Mailing.MailingList.FilterDataModel.on("change",function(b){if(b===this.pageType){this.filterHeaderReload();}},this);},addButtons:function(){var a=this;if(!Ext.isDefined(this.filterObject)){return;}Ext.each(this.filterObject.option,function(f){var c=new Ext.form.Label({text:f.target+":",cls:"filter_opt"});var b=Ext.isIE?"":' style="max-width:900px;overflow:hidden;float:left" ';var g=new Ext.form.Label(f.target=="Mailing Folder"||f.target=="Segment Folder"?{text:f.text,style:{cursor:"pointer"},cls:"filter_value"}:{text:f.text,html:"<div"+b+' qtip="'+f.text.replace(/"/g,"&quot;")+'">'+f.text+"</div>",cls:"filter_value"});var d=this.createNewButton();if(f.target=="Mailing Folder"||f.target=="Segment Folder"){g.on("afterrender",function(j){var h=new Ext.data.ArrayStore({fields:["id",{name:"name",sortType:Ext.data.SortTypes.asUCString}],sortInfo:{field:"name",direction:"ASC"},data:ECM.Stash.folder_store.data});h.insert(0,[new h.recordType({id:0,name:"Default"})]);var k=new Ext.form.ComboBox({mode:"local",triggerAction:"all",valueField:"id",displayField:"name",editable:true,forceSelection:true,store:h});k.on("expand",function(o){var l=o.getStore().find(o.displayField,o.getValue(),0,0,1);o.select.defer(50,o,[l]);if(!o.listLayerEl&&!o.innerListEl){o.listLayerEl=Ext.query(".x-combo-list").pop();o.innerListEl=Ext.query(".x-combo-list-inner").pop();var m=o.view&&o.view.getEl()&&o.view.getEl().child(o.itemSelector||".x-combo-list-item");if(!o.listLayerEl||!o.innerListEl||!m){return;}var n=Ext.util.TextMetrics.createInstance(m);var p=Math.max(o.minListWidth,o.getWidth());o.getStore().each(function(q){p=Math.max(p,n.getWidth(q.get(o.displayField))+25);});o.innerListEl.style.width=p+"px";o.listLayerEl.style.width=p+"px";}});j.ownerCt.insert(j.ownerCt.items.indexOf(j)+1,k);k.onViewClick=k.onViewClick.createSequence(function(){var n=k;var l=n.findRecord(n.valueField,n.getValue());n.ownerCt.setValue(l.get("name"));a.addOrReplaceFilterObj({target:n.ownerCt.getValue().target,text:l.get("name"),query:l.get("id")});var m=a.makeFilterKey(a.filterObject);ECM.Mailing.MailingList.FilterDataModel.writeCookie(a.pageType,a.filterObject);a.fireEvent("filter",m,a.filterObject);},this);k.setValue(g.text);j.hide();j.ownerCt.doLayout();});}this.add({xtype:"container",layout:"toolbar",setValue:function(h){g.text=h.text;},getValue:function(){return{text:g.text,target:c.text.split(":")[0]};},items:[c,g,d,{xtype:"tbspacer",width:10}]});},this);},filterHeaderReload:function(a){this.pageType=a||this.pageType;this.removeAll();this.filterObject=ECM.Mailing.MailingList.FilterDataModel.readCookie(this.pageType);this.addButtons();if(this.items&&this.items.length>0){this.show();}else{this.hide();}this.doLayout();},addOrReplaceFilterObj:function(a){Ext.each(this.filterObject.option,function(d,b,c){if(d.target==a.target){d.text=a.text;(!Ext.isEmpty(d.query)&&!Ext.isEmpty(a.query)&&(d.query=a.query));return false;}});},removeFilterObj:function(a){Ext.each(this.filterObject.option,function(d,b,c){if((d.text==a.text)&&(d.target==a.target)){c.splice(b,1);return false;}});},createNewButton:function(){var a=new Ext.Button({cls:"filter_button",iconCls:"filter_delete_button"});a.on("click",function(b){this.removeFilterObj(b.ownerCt.getValue());b.ownerCt.destroy();var c=this.makeFilterKey(this.filterObject);ECM.Mailing.MailingList.FilterDataModel.writeCookie(this.pageType,this.filterObject);this.fireEvent("filter",c,this.filterObject);},this);return a;}});Ext.namespace("ECM.CMS");Ext.namespace("ECM.CMS.Exception");ECM.provide("ECM.CMS.MediatorInterface");ECM.CMS.MediatorInterface=Ext.extend(Ext.util.Observable,{constructor:function(){ECM.CMS.MediatorInterface.superclass.constructor.call(this);},save:function(){throw new ECM.CMS.Exception.Unimplemented("save");},load:function(){throw new ECM.CMS.Exception.Unimplemented("load");},refresh:function(){throw new ECM.CMS.Exception.Unimplemented("refresh");},getExtContainer:function(a){throw new ECM.CMS.Exception.Unimplemented("getExtContainer");},wasModified:function(){throw new ECM.CMS.Exception.Unimplemented("wasModified");}});ECM.CMS.Exception.Unimplemented=Ext.extend(Ext.Error,{constructor:function(a){this.arg="unimplemented";Ext.Error.call(this,a);}});Ext.ns("ECM.CMS");ECM.provide("ECM.CMS.Modal.SearchAndReplace");ECM.CMS.CodeEditor={};ECM.CMS.CodeEditor.marked=[];ECM.CMS.activeEditor=null;ECM.CMS.resetCodeEditor=function(){var a=ECM.CMS.CodeEditor;a.lastPos=null;a.lastStart=null;a.currentPattern=null;a.searchState=null;a.frames=["textFrame","htmlFrame","richTextFrame"];};ECM.CMS.CodeEditor.unmark=function(){var b=ECM.CMS.CodeEditor.marked;for(var a=0;a<b.length;++a){b[a]();}b.length=0;};ECM.CMS.getActiveEditor=function(a){ECM.CMS.activeEditor=a.getCodeMirrorActiveEditor();if(!ECM.CMS.activeEditor){window.alert(gt.strargs(gt.gettext("Unknown editor %1"),[a.activeTab.id]));return false;}ECM.CMS.mainTabContainer=a;ECM.CMS.resetCodeEditor();};ECM.CMS.showSearchAndReplaceModal=function(){if(!ECM.CMS.Modal.SearchAndReplaceModal){var a=new Ext.form.FormPanel({style:"text-align:left",items:[{html:gt.gettext("Use * for a wildcard search")+"<br/><br/>"},{xtype:"textfield",width:300,fieldLabel:gt.gettext("Find"),id:"cms_find_input",maxLength:100,enableKeyEvents:true,listeners:{keyup:{element:"el",fn:function(c,b){if(c.getValue().trim()===""){ECM.CMS.toggleButton("cms_replace_button",true);ECM.CMS.toggleButton("cms_replaceall_button",true);}}},render:function(){Ext.getCmp("cms_find_input").focus(true,500);}}},{xtype:"textfield",width:300,fieldLabel:gt.gettext("Replace with"),id:"cms_replace_input",maxLength:100}]});ECM.CMS.Modal.SearchAndReplaceModal=new ECM.Window({title:gt.gettext("Search and Replace"),id:"searchAndReplaceModal",width:450,closeAction:"hide",resizable:false,modal:false,padding:10,style:"text-align:left",disabledSnRButtons:[],listeners:{beforehide:function(){ECM.CMS.Modal.SearchAndReplaceModal.notify.clear();}},items:[a,{xtype:"checkbox",boxLabel:gt.gettext("Across all formats"),id:"cms_all_formats"}],windowButtons:[{text:gt.gettext("Find"),id:"cms_find_button",cls:"blue_button",handler:function(){ECM.CMS.findValue();}},{text:gt.gettext("Replace"),id:"cms_replace_button",cls:"blue_button",disabled:true,handler:function(){ECM.CMS.replaceAllValues();}},{text:gt.gettext("Find All"),id:"cms_findall_button",cls:"blue_button",handler:function(){ECM.CMS.findAllValues();}},{text:gt.gettext("Replace All"),id:"cms_replaceall_button",cls:"blue_button",disabled:true,handler:function(){ECM.CMS.replaceAllValues("replace_all");}}]});}else{Ext.getCmp("cms_find_input").setValue("");Ext.getCmp("cms_replace_input").setValue("");Ext.getCmp("cms_all_formats").setValue(false);Ext.getCmp("cms_find_input").focus(true,500);ECM.CMS.toggleButton("cms_replaceall_button",true);ECM.CMS.toggleButton("cms_replace_button",true);}ECM.CMS.Modal.SearchAndReplaceModal.show();};ECM.CMS.toggleButton=function(b,a){if(a){Ext.getCmp(b).disable();}else{Ext.getCmp(b).enable();}};ECM.CMS.getCurrentPattern=function(){var a=Ext.getCmp("cms_find_input").getValue().trim();if(!a){ECM.CMS.Modal.SearchAndReplaceModal.notify.error(gt.gettext("Please enter search criteria."));
return false;}return a;};ECM.CMS.getReplacement=function(){var a=Ext.getCmp("cms_replace_input").getValue().trim();if(a===ECM.CMS.CodeEditor.currentPattern){ECM.CMS.Modal.SearchAndReplaceModal.notify.error(gt.gettext("Your searching string and replacing string are the same."));return false;}return a;};ECM.CMS.jumpToPositionSearchAndReplace=function(a,d,c){var b=ECM.CMS.getCurrentPattern();a.setSelection(d.from(),d.to());c.currentPattern=b;c.lastPos=d.to();c.lastStart=d.from();};ECM.CMS.findValue=function(){var c=ECM.CMS.getCurrentPattern();if(!c){return false;}var f=c.indexOf("*")!==-1;if(f){var b=new RegExp(c.replace("*","\\S*"),"i");}var d=ECM.CMS.CodeEditor;var a=ECM.CMS.activeEditor;ECM.CMS.CodeEditor.unmark();if(d.currentPattern!==c){ECM.CMS.resetCodeEditor();d.currentPattern=c;}var g=a.getSearchCursor(f?b:c,a.getCursor()||d.lastPos,true);if(!g.findNext()){g=a.getSearchCursor(f?b:c,undefined,true);if(!g.findNext()){ECM.CMS.Modal.SearchAndReplaceModal.notify.error(gt.gettext("Content does not exist. Please re-enter search criteria."));ECM.CMS.toggleButton("cms_replace_button",true);ECM.CMS.toggleButton("cms_replaceall_button",true);return;}else{ECM.CMS.Modal.SearchAndReplaceModal.notify.clear();ECM.CMS.toggleButton("cms_replace_button",false);ECM.CMS.toggleButton("cms_replaceall_button",true);d.searchState="searchOne";}}else{ECM.CMS.Modal.SearchAndReplaceModal.notify.clear();ECM.CMS.toggleButton("cms_replace_button",false);ECM.CMS.toggleButton("cms_replaceall_button",true);d.searchState="searchOne";}ECM.CMS.jumpToPositionSearchAndReplace(a,g,d);};ECM.CMS.findAllValues=function(){var j=ECM.CMS.getCurrentPattern();if(!j){return false;}var c=j.indexOf("*")!==-1;if(c){var m=new RegExp(j.replace("*","\\S*"),"i");}var b=ECM.CMS.CodeEditor;var g=ECM.CMS.activeEditor;ECM.CMS.CodeEditor.unmark();ECM.CMS.resetCodeEditor();b.currentPattern=j;Ext.each(b.frames,function(n){if(Ext.isDefined(ECM.CMS.mainTabContainer[n])){ECM.CMS.mainTabContainer[n].setCursor(0);}});var a=ECM.CMS.CodeEditor.marked;var f=0;var h=0;var k=Ext.getCmp("cms_all_formats").getValue();if(k){var d=ECM.CMS.mainTabContainer;Ext.each(b.frames,function(q,o){var n=d[q];if(!Ext.isDefined(n)){return true;}for(var p=n.getSearchCursor(c?m:j,undefined,true);p.findNext();){a.push(n.markText(p.from(),p.to(),"searched"));if(h===0&&n===ECM.CMS.activeEditor){ECM.CMS.jumpToPositionSearchAndReplace(n,p,b);h=1;}f++;}});}else{for(var l=g.getSearchCursor(c?m:j,undefined,true);l.findNext();){a.push(g.markText(l.from(),l.to(),"searched"));if(h===0){ECM.CMS.jumpToPositionSearchAndReplace(g,l,b);h=1;}f++;}}if(!f){ECM.CMS.Modal.SearchAndReplaceModal.notify.error(gt.gettext("Content does not exist. Please re-enter search criteria."));ECM.CMS.toggleButton("cms_replace_button",true);ECM.CMS.toggleButton("cms_replaceall_button",true);return false;}else{ECM.CMS.Modal.SearchAndReplaceModal.notify.clear();b.searchState="searchAll";ECM.CMS.toggleButton("cms_replace_button",true);ECM.CMS.toggleButton("cms_replaceall_button",false);}};ECM.CMS.replaceAllValues=function(a){ECM.CMS.Modal.SearchAndReplaceModal.notify.clear();var m=ECM.CMS.getCurrentPattern();if(!m){return false;}var f=ECM.CMS.getReplacement();var c=m.indexOf("*")!==-1;if(c){var p=new RegExp(m.replace("*","\\S*"),"i");}ECM.CMS.CodeEditor.unmark();var b=ECM.CMS.CodeEditor;if(a){var n=Ext.getCmp("cms_all_formats").getValue();var l=0;if(n){var h=ECM.CMS.mainTabContainer;Ext.each(b.frames,function(v,s){var r=h[v];if(!Ext.isDefined(r)){return true;}for(var u=r.getSearchCursor(c?p:m,undefined,true);u.findNext();){r.replaceRange(f,u.from(),u.to());var q=u.to().ch;var t=f.length-m.length;if(q+t<0){Ext.apply(u.pos.to,{ch:0});}else{Ext.apply(u.pos.to,{ch:q+t});}l++;}});}else{var k=ECM.CMS.activeEditor;for(var o=k.getSearchCursor(c?p:m,undefined,true);o.findNext();){k.replaceRange(f,o.from(),o.to());var g=o.to().ch;var j=f.length-m.length;if(g+j<0){Ext.apply(o.pos.to,{ch:0});}else{Ext.apply(o.pos.to,{ch:g+j});}l++;}}if(l){var d=l>1?gt.strargs(gt.gettext("%1 has been replaced by %2 in %3 instances"),[m,f,l]):gt.strargs(gt.gettext("%1 has been replaced by %2 in 1 instance"),[m,f]);ECM.CMS.Modal.SearchAndReplaceModal.hide();Ext.Msg.show({cls:"blue_button",title:gt.gettext("Replace All Confirmation"),msg:d,buttons:Ext.Msg.OK,width:300,defaultTextHeight:300});ECM.CMS.toggleButton("cms_replaceall_button",true);}}else{var k=ECM.CMS.activeEditor;var o=k.getSearchCursor(c?p:m,b.lastStart||k.getCursor(),true);o.findNext();k.replaceRange(f,o.from(),o.to());b.searchState="replace";ECM.CMS.toggleButton("cms_replace_button",true);}};Ext.namespace("ECM.CMS.Modal");ECM.provide("ECM.CMS.Modal.GenerateTemplateField");ECM.CMS.Modal.GenerateTemplateField=Ext.extend(ECM.Window,{title:"Generate Template Field",closable:true,closeAction:"close",fieldNames:["name","type","columns","rows","wrap"],typeData:[["m","Multiline"],["p","Paragraph"],["i","Inline"]],wrapData:[["v","Virtual"],["h","Hard"],["o","Off"]],nameField:null,typeField:null,columnsField:null,rowsField:null,wrapField:null,validateNameFieldRegExp:/^[a-zA-Z]\w+$/,digitsOnlyRegExp:/^\d+$/,initComponent:function(){var a=this;this.title=gt.gettext("Generate Template Field");this.nameField=new Ext.form.TextField({fieldLabel:gt.gettext("Name"),value:"",validator:function(b){a.validateAllInputFields();if(!a.validateNameField(b)){return gt.gettext("Name invalid.");}return true;}});this.typeField=new Ext.form.ComboBox({fieldLabel:gt.gettext("Type"),mode:"local",triggerAction:"all",valueField:"id",displayField:"display_string",store:new Ext.data.ArrayStore({fields:["id","display_string"],data:this.typeData}),forceSelection:true,editable:false,validator:function(){a.validateAllInputFields();return true;},listeners:{afterrender:function(b){b.setValue("m");}}});this.columnsField=new Ext.form.TextField({fieldLabel:gt.gettext("Columns"),value:"75",validator:function(b){a.validateAllInputFields();if(!a.validateColumnsField(b)){return gt.gettext("Illegal width.");}return true;}});this.rowsField=new Ext.form.TextField({fieldLabel:gt.gettext("Rows"),value:"5",validator:function(b){a.validateAllInputFields();if(!a.validateRowsField(b)){return gt.gettext("Illegal height.");}return true;}});this.wrapField=new Ext.form.ComboBox({fieldLabel:gt.gettext("Wrap"),mode:"local",triggerAction:"all",valueField:"id",displayField:"display_string",store:new Ext.data.ArrayStore({fields:["id","display_string"],data:this.wrapData}),forceSelection:true,editable:false,listeners:{afterrender:function(b){b.setValue("v");}}});this.items=[new Ext.form.FormPanel({items:[this.nameField,this.typeField,this.columnsField,this.rowsField,this.wrapField]})];this.windowButtons=[{text:gt.gettext("Create Field"),id:"create_field_button",handler:function(){var b=a.generateTemplateField();a.close();var c=new ECM.CMS.Modal.DisplayNewTemplateField({templateField:b});c.show();}},{text:gt.gettext("Cancel"),handler:function(){a.close();}}];ECM.CMS.Modal.GenerateTemplateField.superclass.initComponent.apply(this,arguments);},validateNameField:function(a){if(!Ext.isString(a)){return false;}return this.validateNameFieldRegExp.test(a);},validateColumnsField:function(a){return !Ext.isEmpty(a)&&this.digitsOnlyRegExp.test(a);},validateRowsField:function(b,a){a=a||this.typeField.getValue();return a==="i"||(!Ext.isEmpty(b)&&this.digitsOnlyRegExp.test(b));},validateAllInputFields:function(){var a=this.nameField.getValue();var c=this.typeField.getValue();var b=this.columnsField.getValue();var d=this.rowsField.getValue();this.toggleCreateFieldButton(this.validateNameField(a)&&this.validateColumnsField(b)&&this.validateRowsField(d,c));},toggleCreateFieldButton:function(a){Ext.getCmp("create_field_button")[a?"enable":"disable"]();},generateTemplateField:function(){var a=this.nameField.getValue().toLowerCase();var d=this.typeField.getValue();var b=this.columnsField.getValue();var f=this.rowsField.getValue();var c=this.wrapField.getValue();return["%%","t:",a,"-",d,"-",b,(d==="p"||d==="m")?["-",f,"-",c].join(""):"","%%"].join("");
}});ECM.CMS.Modal.DisplayNewTemplateField=Ext.extend(ECM.Window,{closable:true,closeAction:"close",title:"Generate Template Field",templateField:"ERROR generating the template field.",constructor:function(a){this.templateField=a.templateField;ECM.CMS.Modal.DisplayNewTemplateField.superclass.constructor.apply(this,arguments);},initComponent:function(){var a=this;this.title=gt.gettext("Generate Template Field");this.items=[new Ext.BoxComponent({html:[gt.strargs(gt.gettext("Field code: %1"),[this.templateField])].join("")})];this.windowButtons=[{text:gt.gettext("Create Another"),handler:function(){a.close();a.createAnotherTemplateField();}},{text:gt.gettext("Done"),handler:function(){a.close();}}];ECM.CMS.Modal.DisplayNewTemplateField.superclass.initComponent.call(this);},createAnotherTemplateField:function(){(new ECM.CMS.Modal.GenerateTemplateField({})).show();}});ECM.provide("ECM.CMS.Panel.WizardWorkflowToolbar");ECM.CMS.Panel.WizardWorkflowToolbar=Ext.extend(Ext.Toolbar,{cls:"workflow_wizard_panel",height:43,width:770,autoWidth:true,hidden:true,constructor:function(a){this.buildButtons();this.items=this.buttonCollection;ECM.CMS.Panel.WizardWorkflowToolbar.superclass.constructor.apply(this,arguments);},buildButtons:function(){var a=this;this.generateTemplateFieldButton=new Ext.Button({text:gt.gettext("Generate<br />Template Field"),cls:"blue_button generate_template_field_button",scale:"large",hidden:true,handler:function(){var b=new ECM.CMS.Modal.GenerateTemplateField({});if(b){b.show();}}});this.settingButton=new Ext.Button({scale:"large",cls:"blue_button link_button workflow_setting",overCls:"link_button_over",hidden:true,enableToggle:true,toggleGroup:"workflow_button",text:gt.gettext("Step 1")+"<br/>"+gt.gettext("Enter Settings"),handler:function(){a.changePage("settings");}});this.createHTMLButton=new Ext.Button({scale:"large",cls:"blue_button link_button workflow_html",overCls:"link_button_over",hidden:true,enableToggle:true,toggleGroup:"workflow_button",text:gt.gettext("Step 2")+"<br/>"+gt.gettext("Create HTML Content"),handler:function(){a.changePage("html");}});this.createTextButton=new Ext.Button({scale:"large",cls:"blue_button link_button workflow_text",overCls:"link_button_over",hidden:true,enableToggle:true,toggleGroup:"workflow_button",text:gt.gettext("Step 3")+"<br/>"+gt.gettext("Create Text Content"),handler:function(){a.changePage("text");}});this.confirmAndApproveButton=new Ext.Button({scale:"large",cls:"blue_button link_button workflow_confirm",overCls:"link_button_over",hidden:true,enableToggle:true,toggleGroup:"workflow_button",text:gt.gettext("Step 4")+"<br/>"+gt.gettext("Confirm Details and Approve"),handler:function(){a.changePage("checklist");}});this.saveAndNext=new Ext.Button({scale:"large",cls:"blue_button workflow_save",hidden:true,enableToggle:true,toggleGroup:"workflow_button",text:gt.gettext("Save and Next"),handler:a.savePageAndNext.createDelegate(this)});this.buttonCollection=[this.generateTemplateFieldButton,this.settingButton,this.createHTMLButton,this.createTextButton,this.confirmAndApproveButton,this.saveAndNext];},wizardDisabled:true,mailingConfig:undefined,currentPage:undefined,pageMapping:{settings:"/cms/load/settings",html:"/cms/load/content",richtext:"",text:"/cms/load/content",checklist:"/cms/load/checklist"},pageWorkflow:[],turnOn:function(){this.wizardDisabled=false;},turnOff:function(){this.setCurrentPage("");this.hide();this.wizardDisabled=true;},isWizardDisabled:function(){return this.wizardDisabled;},buildPageWorkflow:function(a,b){if(this.pageWorkflow.length!==0&&!b){return false;}var c=ECM.CMS.Panel.WizardWorkflowToolbar;this.pageWorkflow=[];this.pageWorkflow.push(c.SETTINGS_PAGE);if(parseInt(a.html)===1){this.pageWorkflow.push(c.HTML_PAGE);}if(parseInt(a.text)===1){this.pageWorkflow.push(c.TEXT_PAGE);}this.pageWorkflow.push(c.CHECKLIST_PAGE);return this.pageWorkflow;},getCurrentPage:function(){return this.currentPage;},setCurrentPage:function(c){this.hideButtons();if(!this.wizardDisabled&&Ext.isDefined(c)&&Ext.isDefined(this.pageMapping[c.pageName])){var a=this.currentPage;this.mailingConfig=(Ext.isDefined(c.mailingConfig))?c.mailingConfig:this.mailingConfig;if(Ext.isEmpty(this.mailingConfig)){return false;}this.buildPageWorkflow(this.mailingConfig,(a==="settings")?true:false);if(c.showGenerateTemplate){this.generateTemplateFieldButton.show();}if(!Ext.isDefined(c.hideWizard)||c.hideWizard===false){var b=ECM.CMS.Panel.WizardWorkflowToolbar;if(c.pageName!==b.RICHTEXT_PAGE&&c.pageName!==b.CHECKLIST_PAGE){this.saveAndNext.show();}this.settingButton.show();this.createHTMLButton.show();this.createTextButton.show();this.confirmAndApproveButton.show();this.createHTMLButton.enable();if(parseInt(this.mailingConfig.html)===0){this.createHTMLButton.disable();}this.createTextButton.enable();if(parseInt(this.mailingConfig.text)===0){this.createTextButton.disable();}this.setToolbarState(c.pageName);}this.show();this.currentPage=c.pageName;return this.currentPage;}this.currentPage=undefined;this.hide();return this.currentPage;},hideButtons:function(){Ext.each(this.buttonCollection,function(a){a.hide();});},changePage:function(a){if(this.wizardDisabled||Ext.isEmpty(this.pageMapping[a])){return false;}if(a===this.currentPage){return this.currentPage;}var b=ECM.CMS.Panel.WizardWorkflowToolbar;if(a===b.TEXT_PAGE||a===b.HTML_PAGE){if(this.currentPage!==b.SETTINGS_PAGE&&this.currentPage!==b.CHECKLIST_PAGE){this.publish("cms/load/content/tab",a);}else{this.publish(this.pageMapping[a],a);}}else{this.publish(this.pageMapping[a]);}},savePageAndNext:function(){var b=ECM.CMS.Panel.WizardWorkflowToolbar;if(this.currentPage===b.SETTINGS_PAGE){var c=this.mailingConfig;c.html=(Ext.getCmp("settingsFormatHtml").getValue())?1:0;c.text=(Ext.getCmp("settingsFormatText").getValue())?1:0;c.rich_text=(Ext.getCmp("settingsFormatRichText").getValue())?1:0;this.buildPageWorkflow(c,true);}var a=this.pageWorkflow.indexOf(this.currentPage);a=this.pageWorkflow[a+1];if(Ext.isDefined(a)){this.publish("/cms/save",a);}else{this.publish("/cms/save",this.pageWorkflow[this.pageWorkflow.length-1]);}},setToolbarState:function(a){var b=ECM.CMS.Panel.WizardWorkflowToolbar;this.unboldButtons();switch(a){case b.SETTINGS_PAGE:this.boldButton(this.settingButton);break;case b.HTML_PAGE:this.boldButton(this.createHTMLButton);break;case b.TEXT_PAGE:case b.RICHTEXT_PAGE:this.boldButton(this.createTextButton);break;case b.CHECKLIST_PAGE:this.boldButton(this.confirmAndApproveButton);break;}},boldButton:function(a){a.addClass("workflow_highlight");},unboldButtons:function(){var a=[this.settingButton,this.createHTMLButton,this.createTextButton,this.confirmAndApproveButton];Ext.each(a,function(b){b.removeClass("workflow_highlight");});}});ECM.CMS.Panel.WizardWorkflowToolbar.SETTINGS_PAGE="settings";ECM.CMS.Panel.WizardWorkflowToolbar.HTML_PAGE="html";ECM.CMS.Panel.WizardWorkflowToolbar.RICHTEXT_PAGE="richtext";ECM.CMS.Panel.WizardWorkflowToolbar.TEXT_PAGE="text";ECM.CMS.Panel.WizardWorkflowToolbar.CHECKLIST_PAGE="checklist";Ext.reg("ecm.workflowtoolbar",ECM.CMS.Panel.WizardWorkflowToolbar);ECM.provide("ECM.CMS.Modal.EnterDefaults");ECM.CMS.Modal.EnterDefaults=Ext.extend(ECM.Window,{title:gt.gettext("Enter Defaults"),tableExpanded:false,filterString:"",testMode:false,p13nItems:[],mid:-1,mtype:-1,cls:"cm_text_align_left enter_default",initComponent:function(){var a=this;this.toggleHeader=new Ext.BoxComponent({html:this.makeHeader(),listeners:{afterrender:function(){a.initHeaderEventHandling();if(a.testMode){a.makeFilterHeader(Ext.getBody());}else{a.makeFilterHeader.defer(10,a,[]);}}}});this.items=[this.toggleHeader,new Ext.Panel({bodyStyle:"height: 250px",autoScroll:true,html:{tag:"table",children:[{tag:"tbody",children:this.makeTableRows()}]}})];this.windowButtons=[{text:gt.gettext("Done"),handler:function(){a.submitDefaults();a.close();}},{text:gt.gettext("Cancel"),handler:function(){a.close();}}];ECM.CMS.Modal.EnterDefaults.superclass.initComponent.call(this);},makeHeader:function(){var a="";
if(this.tableExpanded){a=['<span id="p13n_modal_view_common" class="toggle_header_link">',gt.gettext("Most Common"),"</span>"," | ",'<span class="toggle_header_bold">',gt.gettext("View All"),"</span>"].join("");}else{a=['<span class="toggle_header_bold">',gt.gettext("Most Common"),"</span>"," | ",'<span id="p13n_modal_view_all" class="toggle_header_link">',gt.gettext("View All"),"</span>"].join("");}a+="<br /><br />";return a;},initHeaderEventHandling:function(){var c=this;if(this.tableExpanded){var b=Ext.getDom("p13n_modal_view_common");if(b){b.onclick=function(){c.toggleView();};}}else{var a=Ext.getDom("p13n_modal_view_all");if(a){a.onclick=function(){c.toggleView();};}}},toggleView:function(){this.tableExpanded=!this.tableExpanded;this.redrawTable();this.toggleHeader.update(this.makeHeader());this.initHeaderEventHandling();},makeFilterHeader:function(b){var c=this;this.filterBox=new Ext.form.TextField({value:"",labelSeparator:"",id:"enterDefaultsSearch",fieldLabel:gt.gettext("Field"),enableKeyEvents:true,listeners:{keyup:function(){c.filterString=this.getValue().trim().toLowerCase();c.redrawTable();}}});var a=new Ext.Container({html:'<img src="/images/clear_search.gif" />',style:"cursor: pointer; padding-left: 4px;",listeners:{render:function(){this.el.on("click",function(){Ext.getCmp("enterDefaultsSearch").reset();c.filterString="";c.redrawTable();});}}});new Ext.form.FormPanel({renderTo:b?b:"th_fields",layout:"column",border:false,bodyStyle:"background: transparent; padding-top: 3px; padding-bottom: 3px;",items:[{xtype:"container",cls:"x-panel-header",html:gt.gettext("Field")},this.filterBox,a]});},makeTableRows:function(){var b=[{tag:"tr",cls:"x-panel-header",children:[{tag:"th",id:"th_fields",width:"60%"},{tag:"th",html:gt.gettext("Default")}]}];var a="b";Ext.each(this.p13nItems,function(c){var d="";if(!c.hidden){a=(a==="a")?"b":"a";d="row_"+a;}b.push({tag:"tr",id:"table_row_"+c.fieldName,style:c.hidden?"display: none":"",cls:d,children:[{tag:"td",html:c.text},{tag:"td",children:[{tag:"input",type:"text",style:"width: 90%",id:"PD_"+c.fieldName,value:c.defaultValue||""}]}]});return true;});return b;},redrawTable:function(){var b=this;var a="b";Ext.each(this.p13nItems,function(g){var d="table_row_"+g.fieldName;var c=Ext.getDom(d);if(c){var f=g.text.toLowerCase();var h=f.indexOf(b.filterString)>=0;if((!b.tableExpanded&&g.hidden)||!h){c.style.display="none";}else{c.style.display="";a=(a==="a")?"b":"a";c.className="row_"+a;}}return true;});},submitDefaults:function(){var a=this;ECM.Ajax.request({url:"/cm/mailing/personalization",method:"POST",params:this.gatherParameters(),success:function(b,d){var c=b.responseJSON;if(!Ext.isEmpty(c)&&!Ext.isEmpty(c.data)&&!Ext.isEmpty(c.data.pers_fields)){a.syncDefaultValues(c.data.pers_fields);}else{a.displaySaveErrorMessage();}},failure:function(b,c){a.displaySaveErrorMessage();}});},displaySaveErrorMessage:function(){Ext.Msg.alert(gt.gettext("Error"),gt.gettext("Error saving updated default personalization values."));},gatherParameters:function(){var a={json:1,"save.x":1,mid:this.mid,mtype:this.mtype};Ext.each(this.p13nItems,function(d){var c="PD_"+d.fieldName;var b=Ext.getDom(c);if(b){a[c]=b.value||"";}return true;});return a;},syncDefaultValues:function(a){Ext.each(this.p13nItems,function(b){var c=a[b.fieldName];if(!Ext.isEmpty(c)){if(!Ext.isEmpty(c[2])){b.defaultValue=c[2];}}return true;});}});ECM.provide("ECM.CMS.Panel.Personalization");ECM.CMS.Panel.Personalization=Ext.extend(Ext.Panel,{testMode:false,testP13NData:null,testCommonFields:null,bodyStyle:"height: auto",autoHeight:true,treeExpanded:false,layoutCompleted:false,initComponent:function(){if(this.testMode){this.renderTo=Ext.getBody();}this.loadMask=this.createInlineLoadMask(gt.gettext("Loading data..."));this.items=[this.loadMask];ECM.CMS.Panel.Personalization.superclass.initComponent.call(this);},loadTreeData:function(){if(this.p13nTree){return;}var a=this;if(this.testMode){this.setupCommonFields(this.testCommonFields);this.buildTree(this.testP13NData,false);}else{ECM.Ajax.request({url:"/cm/mailing/personalization",method:"POST",params:{json:1,mid:this.mid,mtype:this.mtype},success:function(b,f){if(!Ext.isObject(b)||!Ext.isObject(b.responseJSON)||!Ext.isObject(b.responseJSON.data)||!Ext.isObject(b.responseJSON.data.pers_fields)){a.buildTree(null,true);return;}var c=b.responseJSON;var g=c.data;var d=g.pers_fields;a.setupCommonFields(g.frequently_used_fields||[]);a.buildTree(d,false);},failure:function(b,c){a.buildTree(null,true);}});}},buildTree:function(d,c){this.remove(this.loadMask);if(c){Ext.Msg.alert(gt.gettext("Server Error"),gt.gettext("Failed to retrieve personalization data."));return;}this.p13nNodes=this.makePersonalizationNodes(d);var b=this;var a=new Ext.tree.AsyncTreeNode({text:gt.gettext("Demographics"),leaf:false,draggable:true,expanded:true,editable:false,children:this.p13nNodes});this.p13nTree=new Ext.tree.TreePanel({id:"p13n_tree_panel",bodyStyle:"overflow-y: auto; overflow-x: hidden;",enableDrag:true,ddGroup:"DCZone",cls:"p13n_tree_border",root:a,listeners:{afterrender:function(f){b.addViewAllLink(a);f.setHeight(180);},click:function(){ECM.Flare.onFocus("FLARE_LEFTNAV_PERSONALIZATION_DYNAMIC_CONTENT");}}});if(this.isVisible()){this.attachTree();}if(!this.layoutCompleted){this.on("show",this.attachTree);}},attachTree:function(){if(this.p13nTree&&!this.layoutCompleted){this.add(this.p13nTree);this.addEnterDefaultsButton();this.doLayout();this.layoutCompleted=true;}},addEnterDefaultsButton:function(){var a=this;this.enterDefaultsButton=new Ext.Button({text:gt.gettext("Enter All Defaults"),cls:"blue_button",listeners:{scope:this,click:function(){var b=new Ext.LoadMask(this.getEl(),{msg:gt.gettext("Loading default values ...")});b.show();ECM.Ajax.request({url:"/cm/mailing/personalization",params:{json:1,mid:a.mid,mtype:a.mtype},callback:function(g,j,c){if(j){var h=c.responseJSON.data;a.p13nNodes=a.makePersonalizationNodes(h.pers_fields);var f=new ECM.CMS.Modal.EnterDefaults({p13nItems:a.p13nNodes,mid:a.mid,mtype:a.mtype});b.hide();f.show();}else{var d=c.responseJSON.application_errors.toString().replace(",","<br/>")||gt.gettext("Error in retrieving default values. Please refresh the page");b.hide();Ext.Msg.show({title:gt.gettext("ERROR"),msg:d,cls:"blue_button",buttons:Ext.Msg.CANCEL,animEl:"elId",icon:Ext.MessageBox.ERROR});}}});}}});this.add(this.enterDefaultsButton);},setupCommonFields:function(b){var a={};Ext.each(b,function(c){a[c]=true;});this.commonFields=a;},isCommonField:function(a){return Ext.isDefined(this.commonFields[a]);},makePersonalizationNodes:function(b){var c=this;var a=[];Ext.iterate(b,function(d,f){a.push({text:f[1]||"",id:"p13n_"+d,fieldName:d,draggable:true,leaf:true,defaultValue:f[2],content:"%%"+d+"%%",hidden:!c.isCommonField(d),qtipCfg:c.testMode?null:{text:d},listeners:{click:function(){var g=new ECM.CMS.Modal.InsertPersonalization({tag:d.toUpperCase(),hideTransformation:true,mtype:c.mtype});g.show();}}});return true;});a.sort(function(f,d){f=f.text||"";d=d.text||"";return f.toLowerCase()>d.toLowerCase();});return a;},toggleViewPersonalizationNodes:function(){var b=this;this.treeExpanded=!this.treeExpanded;Ext.each(this.p13nNodes,function(c){var d=b.p13nTree.getNodeById(c.id);if(!d){Ext.Msg.alert(gt.gettext("Error"),gt.strargs(gt.gettext("Can't find personalization field %1."),[c.id]));return false;}if(b.treeExpanded){d.getUI().show();}else{if(c.hidden){d.getUI().hide();}}return true;});var a=Ext.getDom("view_button");if(a){if(this.treeExpanded){a.innerHTML=gt.gettext("Common");}else{a.innerHTML=gt.gettext("View All");}}},rootNodeInDOM:function(a){return(a&&a.ui&&a.ui.anchor&&a.ui.anchor.parentNode);},addViewAllLink:function(b){var g=this;if(this.rootNodeInDOM(b)){var f=b.ui.anchor.parentNode;var a=document.createTextNode("  (");var c=document.createElement("span");c.innerHTML=gt.gettext("View All");c.id="view_button";c.style.color="#347dbe";c.onclick=function(){g.toggleViewPersonalizationNodes();};var d=document.createTextNode(")");
f.appendChild(a);f.appendChild(c);f.appendChild(d);}else{Ext.Msg.alert(gt.gettext("Error"),gt.gettext("Failed to display the View All link."));}},createInlineLoadMask:function(a){return new Ext.BoxComponent({style:{fontSize:"11px"},html:['<img src="/js/extjs/resources/images/default/grid/loading.gif" />',"&nbsp;",a].join("")});}});Ext.reg("ecm.personalizationpanel",ECM.CMS.Panel.Personalization);ECM.provide("ECM.CMS.Panel.NonFieldTransformation");ECM.CMS.Panel.NonFieldTransformation=Ext.extend(Ext.Panel,{style:"margin-top: 1px;",border:false,id:"non_field_trans_panel",title:gt.gettext("Non-Field Specific Transformations"),nonFieldTransformations:[{text:gt.gettext("Today's Date"),fieldName:"TODAY",content:"%%dateformat(today,Mon DD YYYY)%%",qtipCfg:{title:gt.gettext("Today's Date"),text:gt.gettext("Drag and drop to insert into content")}},{text:gt.gettext("Bazaarvoice"),fieldName:"BV",content:"%%bv(userid,maxage,username,email)%%",qtipCfg:{title:gt.gettext("Bazaarvoice"),text:gt.gettext("Drag and drop to insert into content")}}],initComponent:function(){this.buildNonFieldTransformationsTree();this.items=[this.nonFieldTransformationsTree];ECM.CMS.Panel.NonFieldTransformation.superclass.initComponent.call(this);},buildNonFieldTransformationsTree:function(){this.makeNonFieldTransformationNodes();this.root=new Ext.tree.AsyncTreeNode({text:gt.gettext("Transformations"),leaf:false,draggable:false,expanded:true,editable:false,children:this.nonFieldTransformationNodes});this.nonFieldTransformationsTree=new Ext.tree.TreePanel({enableDrag:true,ddGroup:"DCZone",root:this.root});},makeNonFieldTransformationNodes:function(){var a=this;this.nonFieldTransformationNodes=[];Ext.each(this.nonFieldTransformations,function(b){a.nonFieldTransformationNodes.push({text:b.text,leaf:true,draggable:true,editable:false,content:b.content,qtipCfg:b.qtipCfg});return true;});}});ECM.provide("ECM.Form.TagSelection");ECM.Form.TagSelection=Ext.extend(Ext.form.Field,{border:false,defaultAutoCreate:{tag:"div"},delimiter:",",tagStore:new Ext.data.ArrayStore({fields:["id","target"],data:[[1,"one"],[2,"two"],[3,"three"]]}),initComponent:function(){ECM.Form.TagSelection.superclass.initComponent.apply(this,arguments);this.addEvents("tagadd","tagremove");},onRender:function(b,a){ECM.Form.TagSelection.superclass.onRender.call(this,b,a);this.tagList=new Ext.form.ComboBox({store:this.tagStore,mode:"local",valueField:"id",hideLabel:true,displayField:"target",triggerAction:"all",editable:false,width:250,listeners:{scope:this,select:function(f){f.getValue().length===0?this.addButton.disabled():this.addButton.enable();},expand:function(){this.tagList.store.realData=this.tagList.store.data;this.filterTagList(this.tagList.id);},collapse:function(){this.tagList.store.data=this.tagList.store.realData;this.tagList.store.snapshot=this.tagList.store.realData;}}});var c=this;this.addButton=new Ext.Button({text:gt.gettext("Add"),cls:"blue_button blue_button_spacing",disabled:true,listeners:{scope:this,render:function(){this.tagList.validate();},added:function(){this.addedTagList.doLayout();},removed:function(){this.addedTagList.doLayout();},click:function(){this.setValue(this.tagList.getValue());this.tagList.setValue("");this.addButton.disable();c.fireEvent("tagadd");}}});this.addedTagList=new Ext.Container({boxMinWidth:20,boxMinHeight:20});this.hiddenField=new Ext.form.Hidden({name:this.name});var d=new Ext.Panel({bodyStyle:this.bodyStyle,border:this.border,items:[this.addedTagList,{xtype:"container",hideBorders:true,layout:"column",items:[{xtype:"label",text:gt.gettext("Add new tag:"),style:{paddingRight:"10px"}},this.tagList,this.addButton],listeners:{afterrender:function(){c.addTagCombo=this;}}},this.hiddenField],listeners:{added:function(){this.doLayout();},removed:function(){this.doLayout();}}});d.render(this.el);},setStore:function(b){var a=[];b.each(function(c){a.push(c.json);});this.tagStore.loadData(a);this.tagList.bindStore(this.tagStore);},setValue:function(a){var b=this;Ext.each(a,function(g,c,d){var f=this.tagStore.find("id",g);var h;if(f>=0){h=this.tagStore.getAt(f).get("target");this.addedTagList.add({xtype:"container",layout:"column",items:[{xtype:"label",text:h},{xtype:"spacer",width:20,height:30},{xtype:"button",icon:"/images/closemodal.png",listeners:{click:function(){this.ownerCt.destroy();b.fireEvent("tagremove");},mouseover:function(){this.setIcon("/images/remove_x.png");},mouseout:function(){this.setIcon("/images/closemodal.png");}}}]});}},this);this.addedTagList.doLayout();this.reAlign();},reAlign:function(){var a=0;this.addedTagList.cascade(function(c){if(c.getXType()==="label"){var b=c.getWidth();if(a<b){a=b;}}},this);this.addedTagList.cascade(function(b){if(b.getXType()==="spacer"){b.setWidth(a-b.previousSibling().getWidth()+20);}},this);},filterTagList:function(a){var b=this.getValue(),c=Ext.getCmp(a);c.store.filterBy(function(d,f){return(b.indexOf(d.get("id"))===-1);});c.store.snapshot=c.store.data;},clear:function(){this.addedTagList.removeAll();},getValue:function(){var a=[];this.addedTagList.cascade(function(c){if(c.getXType()==="label"){var b=this.tagStore.findExact("target",c.text);if(b>=0){var d=this.tagStore.getAt(b).get("id");a.push(d);}}},this);return a;},sortTagsByAlphabet:function(b,d){var a=[];Ext.each(b,function(f){var g=Ext.each(d,function(h){if(this[0]==h){return false;}},f);if(Ext.isDefined(g)){a.push(g);}});var c=new Array(d.length);Ext.each(a,function(g,f){c.splice(f,1,d[g]);});return c;},setHidden:function(a){var b=a?"hide":"show";this.addTagCombo[b]();if(this.getValue().length===0&&a){this.clear();this.addedTagList.add({xtype:"container",items:[{xtype:"label",text:"No tag assigned"}]});this.addedTagList.doLayout();}else{this.addedTagList.cascade(function(c){if(c.getXType()==="button"){c[b]();}},this);}}});Ext.reg("ecm.tagselection",ECM.Form.TagSelection);ECM.provide("ECM.Window.AttachTagsModal");ECM.Window.AttachTagsModal=Ext.extend(ECM.Window,{id:"DynamicContentAttachTags",closeAction:"hide",width:400,title:gt.gettext("Tags"),reloadCombo:false,tagStore:new Ext.data.ArrayStore({fields:["id","tagName","desc"]}),initComponent:function(){var a=this;this.tagSelection=new ECM.Form.TagSelection({disabled:true,listeners:{tagremove:function(){a.syncShadow();}}});this.items=[{style:{margin:"0 0 10px 0"},items:[this.tagSelection]}];this.doneButton=new Ext.Button({text:gt.gettext("Done"),disabled:true,cls:"blue_button",handler:function(){a.selectedTags=a.tagSelection.getValue();a[a.closeAction]();a.fireEvent("ondone",a.selectedTags);}});this.buttons=[this.doneButton,{text:gt.gettext("Cancel"),cls:"blue_button",handler:function(){a[a.closeAction]();}}];ECM.Window.AttachTagsModal.superclass.initComponent.apply(this,arguments);this.addEvents("ondone");},listeners:{show:function(){if(!Ext.isDefined(this.availableTagsStore)||this.availableTagsStore.getCount()===0||this.reloadCombo){this.tagSelection.clear();this.loadDataWithAvailableTags();}else{this.tagSelection.clear();this.tagSelection.setValue(this.selectedTags);this.doLayout();}this.syncShadow();}},enable:function(){this.tagSelection.enable();this.doneButton.enable();},loadDataWithAvailableTags:function(){var c=Ext.query("#DynamicContentAttachTags .x-window-mc");var a=new Ext.LoadMask(c[0],{msg:"Please wait while tags are being loaded.."});a.show();var b=this;this.availableTagsStore=new Ext.data.ArrayStore({autoDestroy:true,proxy:new Ext.data.HttpProxy({url:"/cm/r/tags",method:"GET"}),root:"data.data",idProperty:"id",fields:["id","value","count"],listeners:{scope:this,load:function(d){a.hide();this.tagSelection.setStore(this.availableTagsStore);this.tagSelection.setValue(this.getSelectedTags());this.enable();},exception:function(){a.hide();this.notify.error(gt.gettext("Error loading tags."));}}});this.availableTagsStore.load();},getSelectedTags:function(){return this.selectedTags||[];},setSelectedTags:function(a){this.selectedTags=a;if(this.tagSelection.rendered){this.tagSelection.setValue(this.selectedTags);}}});ECM.provide("ECM.PerspectiveWindow");
(function(){ECM.PerspectiveWindow=ECM.Adapter.extend(ECM.GenericWindow,{__shared__:{dialog:null,inflight:0,loading:null},closable:true,layout:"border",modal:true,xtype:"ECM.PerspectiveWindow",listeners:{beforerender:function(){if(window.ecmTargetingModeOn){this.height=549;this.modal=false;}else{var a=Ext.getBody().getViewSize();this.height=Math.floor(a.height*0.9);this.width=Math.floor(a.width*0.9);}}},beforeDestroy:function(){ECM.PerspectiveWindow.superclass.beforeDestroy.call(this);(this.__shared__.dialog)&&(this.__shared__.dialog.destroy());(this.__shared__.loading)&&(this.__shared__.loading.hideAll())&&(this.__shared__.loading.destroy());this.__shared__=this.__shared__.dialog=this.__shared__.loading=null;delete this.__shared__;return true;},dialog:function(){(!this.__shared__.dialog)&&(this.__shared__.dialog=new ECM.GenericWindow({closeAction:"hide"}));return this.__shared__.dialog;},loading:function(){if(!this.__shared__.loading){var a=this;this.__shared__.loading=new Ext.LoadMask(ECM.Adapter.getBody());this.__shared__.loadingMask=this.el.mask();this.__shared__.saving=null;this.__shared__.loading.hide=function(){a.__shared__.inflight--;if(a.__shared__.inflight<0){a.__shared__.inflight=0;}if(a.__shared__.inflight===0){this.el.unmask();a.__shared__.loadingMask.setStyle({visibility:"hidden"});if(this.previousMsg){this.msg=this.previousMsg;delete this.previousMsg;}}};this.__shared__.loading.hideAll=function(){a.__shared__.inflight=0;a.__shared__.loading.hide();};this.__shared__.loading.show=function(b){if(a.__shared__.inflight===0){if(ECM.Adapter.isEffective(b)){this.previousMsg=this.msg;this.msg=b;}a.__shared__.loadingMask.setStyle({display:"block",visibility:"visible"});this.el.mask(this.msg,this.msgCls);}a.__shared__.inflight++;};}return this.__shared__.loading;},saving:function(){if(!this.__shared__.saving){var a=this;this.__shared__.saving=new Ext.LoadMask(ECM.Adapter.getBody());this.__shared__.savingMask=this.el.mask();this.__shared__.loading=null;this.__shared__.saving.hide=function(){a.__shared__.inflight--;if(a.__shared__.inflight<0){a.__shared__.inflight=0;}if(a.__shared__.inflight===0){this.el.unmask();a.__shared__.savingMask.setStyle({visibility:"hidden"});if(this.previousMsg){this.msg=this.previousMsg;delete this.previousMsg;}}};this.__shared__.saving.hideAll=function(){a.__shared__.inflight=0;a.__shared__.saving.hide();};this.__shared__.saving.show=function(b){if(a.__shared__.inflight===0){if(ECM.Adapter.isEffective(b)){this.previousMsg=this.msg;this.msg=b;}a.__shared__.savingMask.setStyle({display:"block",visibility:"visible"});this.el.mask(this.msg,this.msgCls);}a.__shared__.inflight++;};}return this.__shared__.saving;},toString:function(){return"["+this.xtype+(this.id?" "+this.id:"")+"]";}});ECM.Adapter.register("ECM.PerspectiveWindow",ECM.PerspectiveWindow);})();ECM.provide("ECM.Rules.Content");(function(){var a=ECM.Rules.Constants;ECM.Rules.Content=function(b){b=b||{};b.dataSource=b.dataSource||ECM.Rules.Tablespace;b.dataSource=(ECM.Adapter.isString(b.dataSource))?ECM.Adapter.namespace(b.dataSource):b.dataSource;b.editor=b.editor||ECM.Form.DCEditor;b.editor=(ECM.Adapter.isString(b.editor))?ECM.Adapter.namespace(b.editor):b.editor;b.identity=b.identity||"";b.rowIndex=(ECM.Adapter.isEffective(b.rowIndex))?b.rowIndex:-1;b.perspective=b.perspective||null;this.__data__={dataSource:b.dataSource,editor:b.editor,identity:b.identity,pending:false,perspective:b.perspective,rowIndex:b.rowIndex};this.subs=this.subs||[];this.subs.push(ECM.Subscribers.subscribe({topic:a.TOPIC.PRIORITY.ADJUSTED,subscriber:new ECM.Subscriber({notify:ECM.hitch(this,this.applyChanges)})}));this.subs.push(ECM.Subscribers.subscribe({topic:a.TOPIC.PRIORITY.MOVED,subscriber:new ECM.Subscriber({notify:ECM.hitch(this,this.onPriorityMoved)})}));this.subs.push(ECM.Subscribers.subscribe({topic:a.TOPIC.TAG.BEFORE_CLOSE,subscriber:new ECM.Subscriber({notify:ECM.hitch(this,this.applyChanges)})}));this.subs.push(ECM.Subscribers.subscribe({topic:a.TOPIC.TAG.SAVE,subscriber:new ECM.Subscriber({notify:ECM.hitch(this,this.onSave)})}));delete b.dataSource;delete b.editor;delete b.identity;delete b.rowIndex;delete b.perspective;ECM.Rules.Content.superclass.constructor.call(this,b);};ECM.Adapter.extend(ECM.Rules.Content,Ext.BoxComponent,{border:false,applyChanges:function(){if(this.__data__&&this.__data__.instance&&!this.__data__.pending){var d=this.__data__.instance.whatChanged()||[];if(d.length){var f=true;for(var b=0,c=d.length;b<c;b++){if(ECM.Adapter.isEffective(d[b])){f=false;break;}}if(!f){this.dataSource().updateContent({identity:this.identity(),rowIndex:this.rowIndex(),values:d});}}}},construct:function(){var c=this;c.__data__.perspective.loading().show();var b=c.identity();c.dataSource().content({id:b,rowIndex:c.rowIndex(),callback:function(f){if(!c.__data__.instance){try{var g=c.dataSource().otherIdentities(b);var d={editors:f.content,height:c.el.getHeight(),onContentTagDoubleClick:ECM.hitch(c,c.onContentTagDoubleClick),setWrapWidth:ECM.hitch(c,c.wrapWidth),window:c.__data__.perspective};(g.mailingType===a.MAILING.BULK)&&(d.hideDCMenu=a.YES);if(g.mailingType===a.MAILING.EBM){d.hideDCNew=a.YES;d.hidePersonalizationMenu=a.YES;}c.__data__.instance=new c.__data__.editor.TriplePlay(d);c.mon(c.__data__.perspective,"move",c.__data__.instance.onMove,c.__data__.instance);}catch(h){ECM.Subscribers.notify({topic:a.TOPIC.LOADING.HIDE_ALL});ECM.Subscribers.notify({bundle:[ECM.Locale.fetch({key:"CONTENT_EDITOR_ENCOUNTERED_PROBLEM"})],topic:a.TOPIC.NOTIFY.ERROR});}}c.update(c.__data__.instance.html,c.wrapWidth());c.__data__.perspective.loading().hide();}});},dataSource:function(){return this.__data__.dataSource||ECM.Rules.Tablespace;},identity:function(){return this.__data__.identity||"";},onContentTagDoubleClick:function(c){var b=this;b.applyChanges();var d=Object.extend(b.dataSource().otherIdentities(b.identity()),c);d.newIdentity=c.id;ECM.Subscribers.notify({bundle:[d],topic:a.TOPIC.TAG.CHANGE});},onDestroy:function(){ECM.Rules.Content.superclass.onDestroy.apply(this,arguments);ECM.Adapter.each(this.subs,function(b){ECM.Subscribers.unsubscribe({topic:b.data.topic_,subscriber:b});});this.__data__=this.container=this.el=this.filterOptRe=this.initialConfig=this.lastSize=this.subs=null;delete this.__data__;},onHide:function(){var b=this;ECM.Rules.Content.superclass.onShow.apply(b,arguments);this.applyChanges();},onPriorityMoved:function(b){var c=this.dataSource().lastIndexFromPath({path:b.indexPath,separator:b.separator});this.rowIndex(c,a.YES);},onRender:function(d,b){ECM.Rules.Content.superclass.onRender.apply(this,arguments);var c=this;this.__data__.pending=false;c.construct();},onResize:function(){this.setHeight();},onSave:function(){this.applyChanges();if(this.__data__.instance){this.__data__.instance.markUnchanged();}},onShow:function(){var b=this;b.__data__.perspective.loading().show();ECM.Rules.Content.superclass.onShow.apply(b,arguments);var c=b.rowIndex();b.dataSource().content({id:b.identity(),rowIndex:c,callback:function(d){b.updateEditor({data:d.content,rowIndex:c});b.__data__.perspective.loading().hideAll();}});},perspective:function(b){(ECM.Adapter.isEffective(b))&&(this.__data__.perspective=b);return this.__data__.perspective;},resetState:function(b){b=b||{};b.dataSource=b.dataSource||this.__data__.dataSource||ECM.Rules.Tablespace;b.dataSource=(ECM.Adapter.isString(b.dataSource))?ECM.Adapter.namespace(b.dataSource):b.dataSource;b.editor=b.editor||this.__data__.editor||ECM.Form.DCEditor;b.editor=(ECM.Adapter.isString(b.editor))?ECM.Adapter.namespace(b.editor):b.editor;b.identity=b.identity||"";b.instance=b.instance||this.__data__.instance||null;b.rowIndex=(ECM.Adapter.isEffective(b.rowIndex))?b.rowIndex:((ECM.Adapter.isEffective(this.__data__.rowIndex))?this.__data__.rowIndex:-1);b.perspective=b.perspective||this.__data__.perspective||null;this.__data__={dataSource:b.dataSource,editor:b.editor,identity:b.identity,instance:b.instance,pending:this.__data__.pending||false,perspective:b.perspective,rowIndex:b.rowIndex};
},rowIndex:function(c,b){if(ECM.Adapter.isEffective(c)){this.__data__.pending=!!!b;(!this.hidden&&this.__data__.rowIndex===c)&&(this.__data__.pending=false);this.__data__.rowIndex=c;}return(ECM.Adapter.isEffective(this.__data__.rowIndex))?this.__data__.rowIndex:-1;},setHeight:function(){if(this.__data__.instance){this.__data__.instance.setHeight(this.el.dom.style.height.replace("px","")*1);}},wrapWidth:function(b){var c={identity:this.identity()};if(ECM.Adapter.isEffective(b)){c.data=b;}return this.dataSource().wrap(c);},toString:function(){return"["+this.xtype+(this.id?" "+this.id:"")+"]";},updateEditor:function(c){c=c||{};if(ECM.Adapter.isEffective(c.rowIndex)){this.rowIndex(c.rowIndex,a.YES);}if(ECM.Adapter.isArray(c.data)&&c.data.length){(this.__data__.instance)&&(this.__data__.instance.update(c.data,this.wrapWidth()));}else{var b=this;b.dataSource().content({id:b.identity(),rowIndex:b.rowIndex(),callback:function(d){(b.__data__.instance)&&(b.__data__.instance.update(d.content,b.wrapWidth()));}});}}});ECM.Adapter.register("ECM.Rules.Content",ECM.Rules.Content);})();if(!ECM.Adapter.namespace("ECM.Subscribers")._bogus){ECM.provide("ECM.Subscribers");ECM.Subscribers=(function(){var a={};ECM.Adapter.onUnload(function(){a=null;});return{notify:function(g){g=g||{};g.bundle=g.bundle||[];if(ECM.Adapter.isEffective(g.topic)){for(var h in a){if(h.indexOf(g.topic)>-1){var m=h.split("#");var l=m.pop();l=l||"notify";var f=m.join("");var c=a[f+"#"+l];for(var d=0,b=c.length;d<b;d++){c[d][l].apply(this,g.bundle);}}}}},subscribe:function(b){b=b||{};b.handler=b.handler||"notify";if(ECM.Adapter.isEffective(b.topic)&&ECM.Adapter.isEffective(b.subscriber)){(!ECM.Adapter.isArray(a[b.topic+"#"+b.handler]))&&(a[b.topic+"#"+b.handler]=[]);Object.extend(b.subscriber.data,{topic_:b.topic});a[b.topic+"#"+b.handler].push(b.subscriber);}return b.subscriber;},unsubscribe:function(f){f=f||{};f.handler=f.handler||"notify";if(!a){return false;}var b=a[f.topic+"#"+f.handler];if(ECM.Adapter.isEffective(f.topic)&&ECM.Adapter.isArray(b)){var d=-1;for(var g=0,c=b.length;g<c;g++){if(b[g]===f.subscriber){d=g;break;}}(d>-1)&&(Array.removeAt(b,d));}},_bogus:true};})();ECM.Subscriber=function(a){a=a||{};this.data=a.data||{};this.notify=(ECM.Adapter.isFunction(a.notify))?a.notify:function(){};};}Ext.ns("ECM.ux");Ext.ns("Ext.ux.tree");Ext.ns("ECM.ux.treegrid");Ext.ns("ECM.tree");ECM.provide("ECM.Rules.Workbench");ECM.require("ECM.treegrid.TreeGrid");(function(){var a=ECM.Rules.Constants;ECM.Rules.Workbench=function(b){b=b||{};b.dataSource=b.dataSource||ECM.Rules.Tablespace;b.dataSource=(ECM.Adapter.isString(b.dataSource))?ECM.Adapter.namespace(b.dataSource):b.dataSource;b.identity=b.identity||"";b.rowIndex=(ECM.Adapter.isEffective(b.rowIndex))?b.rowIndex:-1;b.perspective=b.perspective||null;this.__data__={dataSource:b.dataSource,flip:false,identity:b.identity,moveIndex:-1,rowIndex:b.rowIndex,perspective:b.perspective,renderMode:"none",tagType:a.TAG.NONE,total:0};delete b.dataSource;delete b.identity;delete b.rowIndex;delete b.perspective;ECM.Rules.Workbench.superclass.constructor.call(this,b);this.addEvents("renderall","rendersegment","rendersearch","renderstandard");};ECM.Adapter.override(Ext.tree.MultiSelectionModel,{destroy:function(){this.purgeListeners();this.filterOptRe=this.tree=this.selMap=null;if(this.events){for(var b in this.events){this.events[b].obj=null;}}},init:function(b){this.tree=b;b.mon(b.getTreeEl(),"keydown",this.onKeyDown,this);},onNodeClick:function(b,c){if(c.ctrlKey&&this.isSelected(b)){this.unselect(b);}else{this.select(b,c,true);}}});ECM.Adapter.override(ECM.treegrid.TreeGrid,{ieSafeWidth:function(b){return isNaN(parseInt(b))||b<0?0:b;},updateColumnWidths:function(){var n=this.columns,p=n.length,b=this.outerCt.query("colgroup"),o=b.length,m,k,h,d,f;for(h=0;h<p;h++){m=n[h];for(d=0;d<o;d++){k=b[d];k.childNodes[h].style.width=(m.hidden?0:this.ieSafeWidth(m.width))+"px";}}for(h=0,b=this.innerHd.query("td"),len=b.length;h<len;h++){m=ECM.Adapter.fly(b[h]);if(n[h]&&n[h].hidden){m.addClass("x-treegrid-hd-hidden");}else{m.removeClass("x-treegrid-hd-hidden");}}var l=this.ieSafeWidth(this.getTotalColumnWidth());if(Ext.isIE&&this.scrollOffset){var q={overflow:"hidden",width:this.ieSafeWidth(l)+"px"};this.innerHd.setStyle(q);}ECM.Adapter.fly(this.innerHd.dom.firstChild).setWidth(l+(this.scrollOffset||0));this.outerCt.select("table").setWidth(l);this.syncHeaderScroll();}});ECM.Adapter.override(ECM.treegrid.TreeGridNodeUI,{getChildIndent:function(){if(!this.childIndent){var b=[],d=this.getAncestorCnt();for(var c=0;c<d-1;c++){b.unshift('<img src="'+this.emptyIcon+'" class="x-tree-icon" />');}this.childIndent=b.join("");}return this.childIndent;},getAncestorCnt:function(){var c=this.node,b=0;while(c.parentNode){b++;c=c.parentNode;}return b;},updateExpandIcon:function(){if(this.rendered){var h=this.node,f,d,b=" x-tree-elbow-minus",g=h.hasChildNodes();if(g||h.attributes.expandable){if(h.expanded){f="x-tree-node-collapsed";d="x-tree-node-expanded";}else{b=b.replace("x-tree-elbow-minus","x-tree-elbow-plus");f="x-tree-node-expanded";d="x-tree-node-collapsed";}b+=" ecm-elbow-visible";if(this.wasLeaf){this.removeClass("x-tree-node-leaf");this.wasLeaf=false;}if(this.c1!=f||this.c2!=d){ECM.Adapter.fly(this.elNode).replaceClass(f,d);this.c1=f;this.c2=d;}}else{if(!this.wasLeaf){ECM.Adapter.fly(this.elNode).replaceClass("x-tree-node-expanded","x-tree-node-collapsed");delete this.c1;delete this.c2;this.wasLeaf=true;}}var c="x-tree-ec-icon"+b;if(this.ecc!=c){this.ecNode.className=c;this.ecc=c;}}}});ECM.Adapter.extend(ECM.Rules.Workbench,ECM.treegrid.TreeGrid,{animate:false,border:false,cls:"",columns:[],columnResize:false,containerScroll:true,enableHdMenu:false,enableSort:false,stripeRows:true,beforeMoveNode:function(b,h,f,g,d,c){this.__data__.moveIndex=h.indexPath();},columnsAutoFit:function(){var z=this.getInnerWidth();if(z<0){return false;}var s=this.innerCt.getHeight()>this.innerBody.getHeight();var q=s?ECM.Adapter.number(this.scrollOffset,ECM.Adapter.getScrollBarWidth()):0;var o=z-q;var y=this.getVisibleColumns();if(this instanceof ECM.Rules.Targeting){y[0].width=y.length>1?o-y[1].width:o;}else{if(this instanceof ECM.Rules.Priority){var u=this.getTotalColumnWidth();var v=o/100;var m=100/u;var n=0;for(var D=0,B=y.length,A=B-1;D<B;D++){if(D===A){y[D].width=o-n;break;}y[D].width=Math.floor(v*(y[D].width*m));n+=y[D].width;}var F=this.isSimpleTag();var w={DESCRIPTION:((F)?1:3),RULES:((F)?2:4)};var l=this.root.childNodes||[];var f=l.length;var b=y[w.DESCRIPTION];if((f>0)&&ECM.Adapter.isEffective(b)){var g=4;var d=b.width-g;var H=y[w.RULES].width-g;var h=H-20;var t=document.createElement("span");t.style.whiteSpace="nowrap";t.style.visibility="hidden";t.className="ecm-priority-ellipsis";document.body.appendChild(t);var c=0;var r="";var E=0;function p(){while(c<E&&t.offsetWidth<h){t.innerHTML=r.substr(0,++c)+"...";}}for(var D=0;D<f;D++){var x=l[D];if(x.ui.elNode.childNodes[w.DESCRIPTION]){var I=x.ui.elNode.childNodes[w.DESCRIPTION].childNodes[a.DATA.FIRST];(I)&&(I.style.width=this.ieSafeWidth(d)+"px");var G=x.ui.elNode.childNodes[w.RULES].childNodes[a.DATA.FIRST];if(G){G.style.width=this.ieSafeWidth(H)+"px";r=x.attributes.rulesQtip;E=r.length;if(!c){t.innerHTML=r;if(t.offsetWidth>h){t.innerHTML="";p();G.innerHTML=t.innerHTML;}}else{c-=1;t.innerHTML=r.substr(0,c)+((c<E)?"...":"");p();G.innerHTML=t.innerHTML;}}}}document.body.removeChild(t);t=null;}}}this.updateColumnWidths();},construct:function(b){if(ECM.Adapter.isEffective(b.rowIndex)){this.rowIndex(b.rowIndex);}if(ECM.Adapter.isEffective(b.tagType)){this.tagType(b.tagType);}(!ECM.Adapter.isEffective(b.isSimpleTag))&&(b.isSimpleTag=this.isSimpleTag());this.reconstructRoot();this.constructNodes(b);},constructMember:function(d){d=d||{};d.data=d.data||[];var g=this.__data__.flip;var h=(d.isSimpleTag&&d.topLevel)?[d.data]:(d.data[a.DATA.MEMBER]||0);var b=d.holder;if(d.data.length>=1&&ECM.Adapter.isArray(h)){(!g)&&(b.beginUpdate());for(var f=0,c=h.length;
f<c;f++){d.holder=b;this.constructNodes(ECM.Adapter.apply(d,{data:h[f],internal:a.YES,isSimpleTag:d.isSimpleTag,node:(g)?b.childNodes[f]:null}));}(!g)&&(b.endUpdate());}},constructNodes:function(c){c=c||{};var b={};if(ECM.Adapter.isArray(c.data)){if(c.isSimpleTag){if(c.topLevel){delete c.topLevel;this.constructNode(c);}else{this.constructTopLevel(c);}}else{if(c.data.length>=1&&ECM.Adapter.isArray(c.data[a.DATA.DEFINITION])){var d;if(this.__data__.flip){d=c.node;d.ui.onTextChange(null,d.attributes[this.__data__.renderMode]);}else{d=this.constructNode(c);if(c.topLevelRefNode){b.node=d;delete c.refNode;delete c.topLevelRefNode;}}(c.data[a.DATA.DEFINITION][a.IDX.LOGIC]&a.LOGIC.GROUP)&&(this.constructMember(ECM.Adapter.apply(c,{holder:d})));d.isTarget=d.draggable;}else{if(typeof(c.data[a.DATA.DEFINITION])==="string"&&!c.internal){this.constructTopLevel(c);}}}}return b;},constructRoot:function(c){c=c||{};var f=this.__data__.flip;var d=(!f)?this.reconstructRoot():this.root;if(!f){var b=this.getSelectionModel();b.fireEvent("selectionchange",b,b.selNodes);}this.constructMember(ECM.Adapter.apply(c,{holder:d,topLevel:1}));(this.innerCt)&&(this.renderRoot());(!f)&&(this.expandAll());},dataSource:function(){return this.__data__.dataSource||ECM.Rules.Tablespace;},findNodeByPath:function(f){f=f||{};var h=(f.path||"").split(this.pathSeparator);var b=f.parentNode||this.root;for(var g=1,d=h.length,c=d-1;g<d;g++){b=b.childNodes[h[g]];}return b;},getSelectionModel:function(){(!this.selModel)&&(this.selModel=new Ext.tree.MultiSelectionModel());return this.selModel;},headersHide:function(){(this.mainHd)&&(this.mainHd.setStyle({display:"none"}));},headersShow:function(){(this.mainHd)&&(this.mainHd.setStyle({display:"block"}));},identity:function(){return this.__data__.identity||"";},initEvents:function(){Ext.tree.TreePanel.superclass.initEvents.call(this);this.getSelectionModel().init(this);this.relayEvents(this.selModel,["selectionchange"]);this.mon(this,"beforemovenode",this.beforeMoveNode,this);this.mon(this,"enddrag",this.onEndDrag,this);this.mon(this,"movenode",this.onMoveNode,this);this.mon(this,"nodedrop",this.onNodeDrop,this);this.mon(this,"selectionchange",this.onSelectionChange,this);this.mon(this,"startdrag",this.onStartDrag,this);this.subs=this.subs||[];},isSimpleTag:function(){return((this.__data__.tagType||a.TAG.SIMPLE)===a.TAG.SIMPLE);},isStandard:function(){return(this.__data__.renderMode==="standard");},loader:new ECM.treegrid.TreeGridLoader(),onDestroy:function(){ECM.Rules.Workbench.superclass.onDestroy.apply(this,arguments);ECM.Adapter.each(this.subs,function(b){ECM.Subscribers.unsubscribe({topic:b.data.topic_,subscriber:b});});ECM.Adapter.destroy(this.innerBody,this.innerCt,this.innerHd,this.layout,this.mainHd,this.outerCt,this.selModel);this.__data__=this.body=this.bwrap=this.colgroupTpl=this.collapseDefaults=this.colResizer=this.columns=this.container=this.dragConfig=this.dragZone=this.dropConfig=this.dropZone=this.el=this.eventModel=this.expandDefaults=this.filterOptRe=this.initialConfig=this.innerBody=this.innerCt=this.innerHd=this.internalTpl=this.items=this.lastSize=this.layout=this.loader=this.mainHd=this.outerCt=this.root=this.selModel=this.subs=this.tbar=this.toolTemplate=this.toolbars=this.tools=this.topToolbar=this.treeGridSorter=null;delete this.__data__;},onEndDrag:function(b,d,c){d.ignoreClickEvent=(d.dragStatus!=="drop");d.dragStatus="";},onMoveNode:function(p,c,n,o,h,j){var d;var k=this.identity();var m=c.indexPath();var g=this.__data__.moveIndex;var l=this.rowIndex();var f=this.pathSeparator;if(this instanceof ECM.Rules.Targeting){c.ui.elbowNode.className=(o.isRoot)?"x-tree-no-elbow":"x-tree-elbow";ECM.Adapter.fly(c.ui.elNode).removeClass("ecm-rules-first-row");}(g!==-1)&&(d=this.dataSource().move.call(this,{identity:k,indexPath:m,oldIndexPath:g,separator:f,rowIndex:l}));if(p.stripeRows){var b=(n.indexInParent()<o.indexInParent())?n:o;b=(b.isRoot)?b.childNodes[0]:b;p.__data__.total=0;b.parentNode.fixStripes();}ECM.Subscribers.notify({bundle:[{identity:k,indexPath:g,rowIndex:l,separator:f}],topic:a.TOPIC.TARGETING.RULE.BEFORE_MOVE});ECM.Subscribers.notify({bundle:[{data:d,identity:k,indexPath:m,rowIndex:l,separator:f}],topic:a.TOPIC.TARGETING.RULE.MOVE});if(this instanceof ECM.Rules.Priority){ECM.Subscribers.notify({bundle:[{identity:k,indexPath:m,rowIndex:l,separator:f}],topic:a.TOPIC.PRIORITY.MOVED});}this.__data__.moveIndex=-1;return d;},onNodeDrop:function(b){b.dropNode.dragStatus="drop";},onRender:function(){if(!Ext.QuickTips.isEnabled()){Ext.QuickTips.init();}Ext.tree.TreePanel.superclass.onRender.apply(this,arguments);this.el.addClass("x-treegrid ecm-rules-workbench");this.outerCt=this.body.createChild({cls:"x-tree-root-ct x-treegrid-ct "+(this.useArrows?"x-tree-arrows":this.lines?"x-tree-lines":"x-tree-no-lines")});if(this.hideHeaders){this.header.dom.style.display="none";}else{if(this.enableHdMenu){this.hmenu=new Ext.menu.Menu({id:this.id+"-hctx"});if(this.enableColumnHide){this.colMenu=new Ext.menu.Menu({id:this.id+"-hcols-menu"});this.colMenu.on({scope:this,beforeshow:this.beforeColMenuShow,itemclick:this.handleHdMenuClick});this.hmenu.add({itemId:"columns",hideOnClick:false,text:this.columnsText,menu:this.colMenu,iconCls:"x-cols-icon"});}this.hmenu.on("itemclick",this.handleHdMenuClick,this);}}(this.renderStandard)?this.renderStandard():this.setColumns();},onResize:function(c,b){ECM.Rules.Workbench.superclass.onResize.call(this,c,b);this.columnsAutoFit();},onSelectionChange:function(){},onStartDrag:function(l,c,j){c.dragStatus="start";c.ui.onSelectedChange(0);var h=this.dragZone.getProxy();var d=ECM.Adapter.select("input[type=checkbox]",false,h.el.dom);(d.elements&&d.elements.length)&&(d.elements[0].checked=false);var g=this.body.getBox().height<this.body.dom.childNodes[0].childNodes[1].childNodes[0].clientHeight?this.body.getBox().width-Ext.getScrollBarWidth():this.body.getBox().width-1;this.dragZone.getDragEl().style.width=g+"px";this.dragZone.getDragEl().style.overflow="hidden";this.dragZone.minX=this.body.getBox().x+1;this.dragZone.maxX=this.body.getBox().x+1;this.dragZone.deltaY=-10;var b=h.el.dom.childNodes[1].childNodes[0].childNodes;for(var f=0;f<b.length;f++){b[f].childNodes[0].style.width=this.body.dom.childNodes[0].childNodes[1].childNodes[0].childNodes[0].childNodes[f].style.width;}if(Ext.isIE){var k=h.el.dom.childNodes[1];k.innerHTML='<table cellpadding="0" cellspacing="0">'+k.innerHTML+"</table>";}},onTagConverted:function(b){this.tagType(a.TAG.ADVANCED);this.renderMode("none");this.renderStandard();},perspective:function(b){(ECM.Adapter.isEffective(b))&&(this.__data__.perspective=b);return this.__data__.perspective;},reconstructRoot:function(){(this.root)&&(this.root.destroy(true));var b=this.root=new ECM.treegrid.TreeNode({text:""});b.isRoot=true;b.ownerTree=this;this.registerNode(b);(!this.rootVisible)&&(b.ui=new ECM.treegrid.TreeGridRootNodeUI(b));return b;},renderMode:function(b){(ECM.Adapter.isEffective(b))&&(this.__data__.renderMode=b);return this.__data__.renderMode;},resetState:function(b){b=b||{};b.dataSource=b.dataSource||this.__data__.dataSource||ECM.Rules.Tablespace;b.dataSource=(ECM.Adapter.isString(b.dataSource))?ECM.Adapter.namespace(b.dataSource):b.dataSource;b.identity=b.identity||"";b.rowIndex=(ECM.Adapter.isEffective(b.rowIndex))?b.rowIndex:((ECM.Adapter.isEffective(this.__data__.rowIndex))?this.__data__.rowIndex:-1);b.perspective=b.perspective||this.__data__.perspective||null;this.__data__={dataSource:b.dataSource,flip:false,identity:b.identity,moveIndex:-1,rowIndex:b.rowIndex,perspective:b.perspective,renderMode:"none",total:0};},rowIndex:function(b){if(ECM.Adapter.isEffective(b)){this.__data__.rowIndex=b;this.__data__.flip=false;}return(ECM.Adapter.isEffective(this.__data__.rowIndex))?this.__data__.rowIndex:-1;},setColumns:function(c){if(c){this.columns=c;this.initColumns();(this.dragZone&&this.dragZone.destroy)&&(this.dragZone.destroy());(this.dropZone&&this.dropZone.destroy)&&(this.dropZone.destroy());
(this.innerBody)&&(Ext.dd.ScrollManager.unregister(this.innerBody));this.dragZone=this.dropZone=null;}ECM.DomHelper.emptyEl(this.outerCt.dom);this.internalTpl.overwrite(this.outerCt,{columns:this.columns});this.mainHd=ECM.Adapter.get(this.outerCt.dom.firstChild);this.innerHd=ECM.Adapter.get(this.mainHd.dom.firstChild);this.innerBody=ECM.Adapter.get(this.outerCt.dom.lastChild);this.innerCt=ECM.Adapter.get(this.innerBody.dom.firstChild);this.colgroupTpl.insertFirst(this.innerCt,{columns:this.columns});this.columnsAutoFit();if(this.enableDD){(this.containerScroll)&&(Ext.dd.ScrollManager.register(this.innerBody));var b=(((this.constructor).xtype||"").replace("ECM.Rules.",""))+"DD";this.dragZone=new Ext.tree.TreeDragZone(this,this.dragConfig||{ddGroup:this.ddGroup||b,scroll:this.ddScroll});this.dragZone.constrainX=true;this.dropZone=new Ext.tree.TreeDropZone(this,this.dropConfig||{allowContainerDrop:!!this.ddAllowContainerDrop,appendOnly:!!this.ddAppendOnly,ddGroup:this.ddGroup||b});}},setTopbar:function(b){if(b){(this.elements.split(",").indexOf("tbar")<0)&&(this.elements+=",tbar");if(!this.tbar){var d=(this.frame)?this.bwrap.dom.firstChild.firstChild.firstChild:this.bwrap.dom;var c=document.createElement("div");c.className=this.tbarCls;this.tbar=ECM.Adapter.get((d.firstChild)?d.insertBefore(c,d.firstChild):d.appendChild(c));(this.tbarCssClass)&&(this.tbar.addClass(this.tbarCssClass));(this.tbarStyle)&&(this.tbar.applyStyles(this.tbarStyle));(!this.frame&&!this.header)&&(this.tbar.addClass(this.tbarCls+"-noheader"));(!this.border)&&(this.tbar.addClass(this.tbarCls+"-noborder"));}if(this.topToolbar){this.topToolbar.removeAll(true);ECM.Adapter.each(b,function(f){this.topToolbar.add(f);},this);this.topToolbar[(!this.topToolbar.items.items.length)?"hide":"show"]();this.topToolbar.doLayout();}else{this.topToolbar=this.createToolbar(b);}if(this.tbar&&this.topToolbar){this.topToolbar.ownerCt=this;this.topToolbar.render(this.tbar);}}},tagType:function(b){if(ECM.Adapter.isEffective(b)){this.__data__.tagType=b;if(this.isSimpleTag()){this.el.removeClass("ecm-rules-advanced").addClass("ecm-rules-simple");}else{this.el.removeClass("ecm-rules-simple").addClass("ecm-rules-advanced");}}return this.__data__.tagType||a.TAG.NONE;}});ECM.Adapter.register("ECM.Rules.Workbench",ECM.Rules.Workbench);})();ECM.provide("ECM.Rules.Targeting");(function(){var c=ECM.Rules.Constants;var b={segment:["->",{text:ECM.Locale.fetch({key:"RETURN"}),cls:"blue_button",handler:function(){var d=this.ownerCt.ownerCt;d.renderStandard.apply(d,arguments);}}],standard:["->",{disabled:true,cls:"blue_button",text:gt.gettext("Delete"),handler:function(){var d=this.ownerCt.ownerCt;d.deleteConditions.apply(d,arguments);}},{xtype:"splitbutton",id:"createConditionBtn",text:ECM.Locale.fetch({key:"ADD_CONDITION"}),cls:"blue_button",handler:function(){var d=this.ownerCt.ownerCt;d.addCondition.apply(d,arguments);},menu:[{text:ECM.Locale.fetch({key:"CREATE_GROUP"}),cls:"blue_button",handler:function(){var d=this.ownerCt.ownerCt.ownerCt.ownerCt;d.addGroup.apply(d,arguments);}}]}],simpleBtn:{text:ECM.Locale.fetch({key:"ADD_CONDITION"}),cls:"blue_button",handler:function(){var d=this.ownerCt.ownerCt;d.addCondition.apply(d,arguments);}}};var a={segment:[{header:"",dataIndex:"segment",width:807}],standard:[{header:ECM.Locale.fetch({key:"TARGETING_WORKSPACE"}),dataIndex:"standard"},{header:"",dataIndex:"target",width:35,cls:"ecm-edit-col",tpl:new Ext.XTemplate("{icon:this.renderTarget}",{renderTarget:function(l,m){var f=ECM.Rules.Constants;var p=m.data[f.IDX.TABLE];var g=m.data[f.IDX.COLUMN]||"";var q=(g=="SEGMENT_ID"&&p=="_");var h=!q;var j=function(s,u){var r=ECM.Targeting.Store.AffiliateAssociative;var v=r.getAssociativeAffiliateMap(["","MAILING",u]);var t=true;Ext.each(s,function(w){if(!v||!v[w]||v[w]!=r.getAffiliateNameById(ECM.Stash.aid)){t=false;return false;}});return t;};if(h&&(!ECM.Stash.has_client_access||(window.ecmTargetingModeOn&&ECM.Targeting.Store.SegmentData.restrictAffiliate()))){if(("BCORST".split("").indexOf(p)>-1&&!Ext.isEmpty(g)&&g.match(/AFFILIATE_ID$/))||((p=="L")&&!ECM.Stash.has_client_access&&!Ext.isEmpty(g)&&g.match(/AFFILIATE_ID$/))){h=false;}else{if(g=="PRODUCT_ID"&&p=="L"){if(!ECM.Stash.has_client_access&&!Ext.isEmpty(m.data[f.IDX.OPERANDS])){Ext.each(m.data[f.IDX.OPERANDS][0],function(s){var r=ECM.Targeting.Store.SubscriberList.getSubscriberListAffiliateID(s);if(r.indexOf(ECM.Stash.desired_aid)==-1){h=false;return false;}});}}else{if("BCORSTL".split("").indexOf(p)>-1&&g.match(/_MAILING_ID$/)){if(!Ext.isEmpty(m.data[f.IDX.OPERANDS])){Ext.each(m.data[f.IDX.OPERANDS][0],function(r){if(Ext.isEmpty(ECM.Stash.mailings_used[r])){h=false;return false;}if(ECM.Stash.mailings_used[r][1]!=ECM.Stash.aid){h=false;return false;}});}}else{if("BCORSTL".split("").indexOf(p)>-1&&g.match(/_MAILING_FOLDER$/)){var o=ECM.Targeting.Store.SegmentData.getMailingFolderIds();if(!Ext.isEmpty(m.data[f.IDX.OPERANDS])){Ext.each(m.data[f.IDX.OPERANDS][0],function(r){if(o.indexOf(r)<0){h=false;return false;}});if(h&&ECM.Stash.has_client_access&&!j(m.data[f.IDX.OPERANDS][0],"FOLDER")){h=false;}}}else{if("BCORSTL".split("").indexOf(p)>-1&&g.match(/_MAILING_CAMPAIGN$/)){var d=ECM.Targeting.Store.SegmentData.getCampaignIds();if(!Ext.isEmpty(m.data[f.IDX.OPERANDS])){Ext.each(m.data[f.IDX.OPERANDS][0],function(r){if(d.indexOf(r)<0){h=false;return false;}});if(h&&ECM.Stash.has_client_access&&!j(m.data[f.IDX.OPERANDS][0],"CAMPAIGN")){h=false;}}}else{if(!ECM.Stash.show_access_location&&"BCORSTL".split("").indexOf(p)>-1&&g.match(/(CLICK|OPEN)_(GEOLOCATION|PLATFORM)/)){h=false;}}}}}}}var k=ECM.Rules.Tablespace.isAggregator(m.data[f.IDX.LOGIC]);if(h&&!ECM.Stash.show_activity_data&&(((["B","C","O","R","S","T"]).indexOf(m.data[f.IDX.TABLE])>-1)||k)){h=false;}var n=h?"ecm-target target-edit":"ecm-target-disabled target-edit-disabled";return(m.isDefault)?"":'<div class="'+n+'"></div>';}})}]};ECM.Rules.Targeting=ECM.Adapter.extend(ECM.Rules.Workbench,{activeCondition:function(f){if(f){if((f.attributes||{}).isGroup){f.expand();}var d=this.getSelectionModel();d.onNodeClick(f,{});if(d.selNodes&&d.selNodes.length>0){d.unselect(d.selNodes[d.selNodes.length-1]);}f.ui.elNode.scrollIntoView(false);this.fireEvent("targetclick",f,{},f.ui.targetNode);}},addAggregator:function(d){d.isAggregator=true;this.addGroup(d);},addCondition:function(h){if(!window.ecmTargetingModeOn){return this.addConditionDC(h);}var g=this;var k={identity:g.identity(),rowIndex:g.rowIndex()};if(h.data){k.data=h.data;}var f=this.selModel.getSelectedNodes();var j=g.dataSource().addCondition(k);if(ECM.Stash.exclude_xdb_perm&&j&&h.isSegment){var d=new Ext.LoadMask(Ext.getBody(),{msg:gt.gettext("Inspecting the selected segment. Please wait.")});d.show();ECM.Ajax.request({url:"/cm/r/segment/excluded_xdb",method:"GET",params:{list_id:h.segmentId},success:function(l,o){var n=l.responseJSON.data;var m=n[h.segmentId];d.hide();if(m){Ext.Msg.show({title:gt.gettext("Segment with excluded XDB(s)"),msg:gt.strargs(gt.gettext('Segment "%1" currently contains xDB file exclusions. The xDB exclusions will NOT be carried over. Do you wish to continue?'),[h.segmentName]),buttons:Ext.Msg.YESNO,cls:"blue_button",fn:function(p){g.addConditionHelper(h,p==="yes"?j:null,f);},icon:Ext.MessageBox.INFO});}else{g.addConditionHelper(h,j,f);}},failure:function(){d.hide();}});}else{g.addConditionHelper(h,j,f);}},addConditionHelper:function(g,k,d){var f=this;if(k){if(g.newFromTree){this.selModel.clearSelections();}var h=f.root;if(d.length==1&&d[0].allowChildren&&!g.skipMove){if(!(k[c.DATA.DEFINITION][c.IDX.LOGIC]&c.LOGIC.GROUP)){h=d[0];}if(!h.isRoot&&!!h.allowChildren&&h.childNodes.length>0&&h.childNodes[0].attributes.data[c.IDX.LOGIC]&c.LOGIC.OR){k[c.DATA.DEFINITION][c.IDX.LOGIC]&=~c.LOGIC.AND;k[c.DATA.DEFINITION][c.IDX.LOGIC]|=c.LOGIC.OR;}}var j=f.constructNode({data:k,holder:h});if(d.length==1&&d[0].allowChildren&&!g.skipMove){f.dataSource().move({identity:f.identity(),rowIndex:f.rowIndex(),separator:"/",oldIndexPath:"/"+f.root.childNodes.length,indexPath:d[0].indexPath()+"/"+d[0].childNodes.length});
}ECM.Subscribers.notify({bundle:[{data:k,identity:f.identity(),indexPath:j.indexPath(),rowIndex:f.rowIndex(),separator:f.pathSeparator}],topic:c.TOPIC.TARGETING.RULE.ADD});if(!!g.newFromTree){j.newFromTree=true;}if(g.isCopy&&j.isActivity()){j.wrapAggregate();}if(!g.skipModal){f.activeCondition(j);}}if(this.stripeRows){this.__data__.total=0;this.root.fixStripes();}this.onResize(this.container.dom.clientWidth,this.container.dom.clientHeight);},addConditionDC:function(){var f=this;if(f.isSimpleTag()){var h=f.dataSource().totalRules({identity:f.identity()});f.fireEvent("targetclick",{condition:function(){return{callback:ECM.hitch(f,function(){this.perspective().loading().show();this.dataSource().convert({addCondition:c.YES,identity:this.identity(),rowIndex:this.rowIndex()});}),mode:c.MODES.ADD,switchToAdvanced:c.YES,totalRules:h};},dialog:ECM.hitch(f,f.getDialog)},{},null);}else{var k=f.dataSource().addCondition({identity:f.identity(),rowIndex:f.rowIndex()});if(k){var g=f.selModel.selNodes.length>0?f.selModel.selNodes[0]:f.root;var j=f.constructNode({data:k,holder:g});var d=this.selModel.getSelectedNodes();if(d.length==1&&d[0].allowChildren&&!args.skipMove){f.dataSource().move({identity:f.identity(),rowIndex:f.rowIndex(),separator:"/",oldIndexPath:"/"+f.root.childNodes.length,indexPath:d[0].indexPath()+"/"+d[0].childNodes.length});}ECM.Subscribers.notify({bundle:[{data:k,identity:f.identity(),indexPath:j.indexPath(),rowIndex:f.rowIndex(),separator:f.pathSeparator}],topic:c.TOPIC.TARGETING.RULE.ADD});f.activeCondition(j);}}if(this.stripeRows){this.__data__.total=0;this.root.fixStripes();}this.onResize(this.container.dom.clientWidth,this.container.dom.clientHeight);},wrapTargeting:function(){var f=Ext.decode(Ext.encode(this.getTargetingJSON()));if(f.length>1){var d=f.shift();f=[[[22,"-Targeting Conditions-"]].concat([f])];f.unshift(d);}return f;},getExcludedXDBFiles:function(){var f=Ext.StoreMgr.get("xdbGridStore");if(Ext.isDefined(f)){var g=f.getRange();var d=[];Ext.each(g,function(h){d.push(h.data.segmentId);});return d.join();}return undefined;},saveCriteria:function(j,g){var l=ECM.Rules.DynamicContent.layout({id:j.identity()}).perspective.saving();l.show(gt.gettext("Saving..."));var h=this.wrapTargeting();var k={id:ECM.Targeting.Store.SegmentData.getId(),json:Ext.encode(h),method:"PUT",fid:ECM.Stash.segmentData.data[0].fid};if(g.saveCount){if(ECM.Targeting.Store.SegmentData.getLastCountedXdb()&&ECM.Targeting.Store.SegmentData.last_counted=="xdb"){k.unsaved_xdb_count=1;k.xdb=ECM.Targeting.Store.SegmentData.getLastCountedXdb();k.count=ECM.Targeting.Store.SegmentData.getTotalCount();k.last_count=ECM.Targeting.Store.SegmentData.getLastCountedTimeStamp();}else{if(ECM.Targeting.Store.SegmentData.last_counted=="db"){k.num_sent=ECM.Targeting.Store.SegmentData.getTotalCount();k.date_sent=ECM.Targeting.Store.SegmentData.getLastCountedTimeStamp();}}}k.excludedXdbFiles=this.getExcludedXDBFiles()||"";var f=[{url:"/cm/r/segment",params:k}];var d=ECM.Targeting.Splits.Utils.getSplitsBatchData();if(ECM.Targeting.Store.SegmentData.hasAssignedSplit()&&d.length>0){f.push({url:"/cm/r/segment/split",params:{batch:d,method:"PUT"}});}ECM.Ajax.request({url:"/cm/r",method:"POST",params:{batch:Ext.encode(f)},success:function(n){l.hide();if(f.length>1&&n.responseJSON.data.data.data[1].error){ECM.Targeting.Frame.error(n.responseJSON.data.data.data[1].error);}else{if(ECM.Stash.is_segment_scheduled){dcForm.unsavedSegment=false;Ext.getCmp("countSegmentBtn").fireEvent("click",{});}ECM.Targeting.Frame.info(gt.gettext("Saved segment targeting successfully."));}if(n.responseJSON.data.data.length>1){ECM.Targeting.Splits.Utils.updateMailingCopyIds(n.responseJSON.data.data[1].data.data);}var m=ECM.Targeting.Store.SegmentData;m.setLastSavedTargeting(Ext.decode(Ext.encode(j.getTargetingJSON())));m.setLastSavedCount(k.num_sent,m.getLastCounted(),k.date_sent);if(window.ecmTargetingModeOn){ECM.Targeting.SegmentEditor.updateSubscriptionList();}ECM.publish("targeting.changetitle",m.getName().decodeEntities());dcForm.unsavedSegment=false;dcForm.unsavedSplit=false;},failure:function(n){l.hide();var m=ECM.util.Parser.decodeResponse(n);var o=(!Ext.isEmpty(m.errors))?gt.gettext(m.errors):m.message;ECM.publish("/notify/error/clear",o);ECM.SessionLog.sessionLog(2821,[ECM.Targeting.Store.SegmentData.getName(),ECM.Targeting.Store.SegmentData.getId(),Ext.encode(h),o]);}});},addGroup:function(p){p=p||{};var g=ECM.Rules.Constants;var d=this.dataSource();var q=this.identity();var r=this.rowIndex();var m=this.pathSeparator;var j={identity:q,rowIndex:r,separator:m};if(p.isAggregator){Ext.apply(j,{columnId:p.columnId,tableId:p.tableId,isAggregator:true,aggCondition:p.aggCondition,aggName:p.aggName});}if(!!p.text){j.groupName=p.text;}if(!!p.useLogic){j.useLogic=p.useLogic;}j.logic=p.logic?p.logic:undefined;var t={holder:this.root,internal:g.YES,topLevelRefNode:g.YES};var n=this.getSelectionModel();var f=n.selNodes.slice(0);var o=f.length;f.sort(function(v,u){return(v.indexInParent()-u.indexInParent());});if(o){var s=o-1;t.holder=f[s].parentNode;t.refNode=f[s].nextSibling;j.children=[];for(var l=0;l<o;l++){j.children.push(f[l].indexPath());}}var k=d.addGroup(j);if(k.group){t.data=k.group;var h=(this.constructNodes(t)||{}).node;h.attributes.isAggregator=p.isAggregator;h.attributes.isInsight=p.isInsight;if(o){for(var l=o-1;l>=0;l--){f[l].parentNode.removeChild(f[l],1);}}if(!k.isInsight){ECM.Subscribers.notify({bundle:[{data:k.group,identity:q,indexPath:h.indexPath(),rowIndex:r,separator:m}],topic:g.TOPIC.TARGETING.RULE.ADD});}if(this.stripeRows){this.__data__.total=0;this.root.fixStripes();}if(!p.skipModal){if(p.deferActivate){this.activeCondition.defer(50,this,[h]);}else{this.activeCondition(h);}}if(p.skipModal&&!p.isInsight){h.expand(true);}}this.onResize(this.container.dom.clientWidth,this.container.dom.clientHeight);},afterRender:function(){ECM.Rules.Targeting.superclass.afterRender.call(this);if(!window.ecmTargetingModeOn){return false;}ECM.Targeting.SegmentEditor.placeTargeting(this);this.on("contextmenu",function(h,j){if(!this.allowContextMenu){return false;}if(!ECM.Stash.show_activity_data){if(Ext.encode(h.getJSON()).search(/\["?\d+"?,"[BCORST]"/)>-1){return false;}}if(!ECM.Stash.show_access_location){if(Ext.encode(h.getJSON()).search(/\["?\d+"?,"[CO]","(CLICK|OPEN)_(GEOLOCATION|PLATFORM)"/)>-1){return false;}}h.select();var k=h.getOwnerTree().contextMenu,g=Ext.getCmp("targeting_cmAddtoSavedGroups"),d=Ext.getCmp("targeting_cmSaveToScratchPad");var f=function(l){g[l]();d[l]();};k.contextNode=h;if(h.attributes.isGroup&&!h.attributes.isAggregator){g.show();Ext.isEmpty(h.childNodes)?f("disable"):f("enable");}else{g.hide();d.enable();}k.showAt(j.getXY());});ECM.FeatureHelp.unsuppressTooltip("btnCreate");},allowTopLevelOr:true,allowContextMenu:true,contextMenu:new Ext.menu.Menu({cls:"x-menu x-menu-cstm",items:[{itemCls:"x-menu-item x-menu-item-cstm",id:"targeting_cmSaveToScratchPad",text:gt.gettext("Save to Scratchpad")},{itemCls:"x-menu-item x-menu-item-cstm",id:"targeting_cmAddtoSavedGroups",hidden:true,text:gt.gettext("Add to Saved Groups")}],listeners:{itemclick:function(p){var h=p.parentMenu.contextNode;var f=h.getOwnerTree();var m=!!h.attributes.isGroup;var n=!!h.attributes.isAggregator;if(p.id==="targeting_cmSaveToScratchPad"){var k={data:Ext.decode(Ext.encode(h.getJSON())),skipModal:true};if(m&&!n){k.nodeClass="GROUP";k.text=f.getGroup({node:h}).text;}else{if(m&&!!n){k.nodeClass="AGGREGATOR";k.text=h.ui.conditionNode.dom.innerHTML.trim();}else{k.nodeClass="CONDITION";var g=h.condition();if(Ext.isObject(g)&&g.columnId==="SEGMENT_ID"){k.nodeClass="SEGMENT";k.segmentId=g.operands[0][0];k.text=ECM.Stash.segments_used[k.segmentId];}else{k.text=h.ui.conditionNode.dom.innerHTML.trim();}}}ECM.publish("scratchpad.add",k);}else{if(p.id==="targeting_cmAddtoSavedGroups"){var o=f.getGroup({node:h}).text;var d=ECM.publish("savedgroup.checkexist",o);var j=Ext.decode(Ext.encode(h.getJSON()));var l=function(){var q={successCb:function(s,t){ECM.Targeting.Frame.info(t);
},failureCb:function(s,t){ECM.Targeting.Frame.error(t);}};var r=Ext.apply({autoUpdate:true},q);ECM.publish("savedgroup.update",o,j,r);};if(d){Ext.Msg.show({title:gt.gettext("Confirmation"),msg:gt.strargs("%1 already exist. Do you want to replace it?",o),buttons:Ext.Msg.YESNO,cls:"cm_text_align_left blue_button",fn:function(q){if(q==="yes"){l();return;}}});}else{l();}}}}}}),construct:function(f){ECM.Rules.Targeting.superclass.construct.apply(this,arguments);if(window.ecmTargetingModeOn){if(ECM.Targeting.Store.SegmentData.isArchived()){this.disableTargeting();}}else{var l=!!(ECM.Adapter.isArray(f.data[c.DATA.DEFINITION])&&f.data[c.DATA.DEFINITION][c.IDX.LOGIC]&c.LOGIC.DEFAULT);var k=this.isSimpleTag();var d=this.isStandard();var m=this.topToolbar.items.itemAt.createDelegate(this.topToolbar.items);var j=this.tagType()||c.TAG.SIMPLE;var h=function(n,p){var o=m(c.TOOLBAR.TARGETING[j].CONDITION).menu.items;o.itemAt(n)[p]();};if(l){if(d){m(c.TOOLBAR.TARGETING[j].CONDITION).disable();if(!k){h(c.TOOLBAR.TARGETING[j].GROUP,"disable");}}}else{if(d){var g=this.dataSource().otherIdentities(this.identity());m(c.TOOLBAR.TARGETING[j].CONDITION)[(ECM.Adapter.isEffective(g.key))?"disable":"enable"]();if(!k){h(c.TOOLBAR.TARGETING[j].GROUP,"enable");}}}}},disableTargeting:function(){var f=this;this.innerCt.addClass("targeting-archived");var d=function(j){var h=Ext.get(j.dom);h.set({"ext:qtip":""},true);};var g=function(h){h=h?h:f.root.childNodes;Ext.each(h,function(k,j,l){if(k.ui.booleanNode){k.ui.booleanNode.removeAllListeners();d(k.ui.booleanNode);}if(k.ui.inclusionNode){k.ui.inclusionNode.removeAllListeners();d(k.ui.inclusionNode);}if(k.ui.conditionNode){k.ui.conditionNode.removeAllListeners();}if(k.ui.targetNode){k.ui.targetNode.hide();}if(k.ui.checkbox){k.ui.checkbox.disabled=true;}if(k.hasChildNodes()){g(k.childNodes);}});};if(this.dragZone){this.dragZone.unreg();}g();},constructNode:function(d){d=d||{};var h=(d.isSimpleTag)?d.data:d.data[c.DATA.DEFINITION];var j=((d.data[c.DATA.MEMBER]||[])[c.DATA.FIRST]||[])[c.DATA.DEFINITION]||[];var f=new ECM.treegrid.TreeNode(this.dataSource().ruleInfo({data:h,firstChild:j,identity:this.identity(),isSimpleTag:d.isSimpleTag,key:d.key}));f.on("expand",this.updateConditionNodes,this);var g=ECM.Form.FormElements.ElementHelper.getColumnInfoFromId(d.data[0][2]);f.isMainSubscription=(window.ecmTargetingModeOn&&g.type==ECM.Rules.Constants.TYPES.SUBSCRIPTION&&mt.root.childNodes.length==0);if(f.isMainSubscription&&window.ecmTargetingModeOn){f.hidden=true;}f.attributes.data=h;(this.isStandard())&&(f.allowChildren=!!((d.data[c.DATA.DEFINITION]||[])[c.IDX.LOGIC]&c.LOGIC.GROUP));if(d.holder){if(ECM.Adapter.isEffective(d.refNode)){d.holder.insertBefore(f,d.refNode);}else{d.holder.appendChild(f);}}else{return f;}if(!f.previousSibling&&f.ownerTree.root.id===f.parentNode.id){this.__data__.total=0;}f.stripeIndex=this.__data__.total++;return f;},constructTopLevel:function(d){ECM.Subscribers.notify({bundle:[d.data[(this.isSimpleTag())?c.DATA.DESCRIPTION:c.DATA.DEFINITION]],topic:c.TOPIC.TARGETING.LABEL.CONSTRUCT});this.constructRoot(d);var g=this.root.childNodes[c.DATA.FIRST];if(!d.isSimpleTag&&!g){ECM.Subscribers.notify({topic:c.TOPIC.TARGETING.ACTIVE});this.addCondition();}if(g){g.ui.addClass("ecm-rules-first-row");}var f=new RegExp("^"+ECM.Locale.fetch({key:"NEW_CONDITION"})+"[0-9]*");if(d.isSimpleTag&&ECM.Adapter.isString(d.data[c.DATA.VALUE])&&d.fresh){ECM.Subscribers.notify({topic:c.TOPIC.TARGETING.ACTIVE});this.fireEvent("conditionclick",g,{},g.ui.targetNode);}},deleteCondition:function(h){h=h||{};var g=h.node.indexPath();var d=h.node.parentNode;var k=h.dataSource.deleteCondition({identity:h.identity,indexPath:g,isSimpleTag:h.isSimpleTag,rowIndex:h.rowIndex,separator:h.separator});var f=ECM.Locale.fetch({key:"CREATE_GROUP"});if(!h.isSimpleTag&&h.node&&h.node.attributes&&h.node.attributes.isGroup&&k.isNew){if(k.children&&k.children.length>0){for(var j=0,l=k.children.length;j<l;j++){this.constructNodes({data:k.children[j],holder:h.node.parentNode,internal:c.YES,refNode:h.node,topLevelRefNode:c.YES});}}}if(h.node.parentNode.removeChild){(k.removed)&&(h.node.parentNode.removeChild(h.node,1));}else{(k.removed)&&(h.node.removeChild(h.node,1));}ECM.Subscribers.notify({bundle:[{identity:h.identity,indexPath:g,isSimpleTag:h.isSimpleTag,rowIndex:h.rowIndex,separator:h.separator,wholeRow:k.wholeRow}],topic:c.TOPIC.TARGETING.RULE.DELETE});if(this.stripeRows){this.__data__.total=0;this.root.fixStripes();}if(d.childNodes.length>0){d.childNodes[0].ui.addClass("ecm-rules-first-row");}this.onResize(this.container.dom.clientWidth,this.container.dom.clientHeight);},deleteConditions:function(){var j=this.getSelectionModel();var f=j.selNodes.slice(0);var k=f.length;if(k){var d=this.dataSource();var m=this.identity();var l=this.isSimpleTag();var o=this.root;var n=this.rowIndex();var h=this.pathSeparator;for(var g=0;g<k;g++){this.deleteCondition({dataSource:d,identity:m,isSimpleTag:l,node:f[g],rowIndex:n,separator:h});}if(o.childNodes.length==1){o.childNodes[0].attributes.data[c.IDX.LOGIC]=21;}}},disableTargeting:function(){var d=this;var f=function(g){g=g?g:d.root.childNodes;Ext.each(g,function(j,h,k){if(j.ui.booleanNode){j.ui.booleanNode.removeAllListeners();}if(j.ui.inclusionNode){j.ui.inclusionNode.removeAllListeners();}if(j.ui.conditionNode){j.ui.conditionNode.removeAllListeners();}if(j.ui.targetNode){j.ui.targetNode.removeAllListeners();}if(j.ui.checkbox){j.ui.checkbox.disabled=true;}if(j.hasChildNodes()){f(j.childNodes);}});};this.dragZone.unreg();f();},updateConditionNodes:function(d){d=d?d:this.getRootNode();d.cascade(function(f){f.updateConditionNode();});},doLayout:function(){ECM.Rules.Targeting.superclass.doLayout.apply(this,arguments);this.updateConditionNodes();},compatibleNodes:function(g,f){var j=ECM.Targeting.Util.Grain;var d=this.getUnknownTableFromNode(g,true);var h=g.attributes;if(!Ext.isArray(d)){d=[d];}return Array.all(d,function(k){return j.isCompatibleTable(k,f.getTable(),f.getGrain(1),h.isAggregator);});},dragConfig:{ddGroup:"TargetingDD"},dropConfig:{allowContainerDrop:true,appendOnly:false,ddGroup:"TargetingDD",showFeatureHelp:function(f){var d=f.ui.conditionNode.getXY();d[1]-=Ext.isSafari||Ext.isIE?115:100;ECM.FeatureHelp.showTooltip("btnCreate",d);ECM.FeatureHelp.suppressTooltip("btnCreate");},onContainerDrop:function(p,k,h){var n;var g=h.node.attributes;g=Ext.decode(Ext.encode(g));var d=ECM.Rules.Constants;if(g.isSegment){if(!Ext.isDefined(ECM.Stash.segments_used[g.segmentId])){ECM.Stash.segments_used[g.segmentId]=g.origText;}}if(!!g.fromTree){h.node.ui.removeClass("x-tree-node-over");this.tree.selModel.clearSelections();h.node.ownerTree.selModel.clearSelections();if(!!g.fromScratch&&!!g.isAggregator){this.tree.dropGroup(g);}else{if(!!g.isGroup){g=ECM.util.BracketRacket.toDropNode(g);this.tree.dropGroup(g);}else{var m={data:g.data,skipModal:g.skipModal,newFromTree:!g.skipModal,isSegment:g.isSegment};if(g.isSegment){m.segmentId=g.segmentId;m.segmentName=g.text;}this.tree.addCondition(m);if(g.skipModal){this.tree.onConditionChange();}}}var l=this.tree.getRootNode();l.ui.startDrop();n=this.tree.root.childNodes[this.tree.root.childNodes.length-1]||(p.getTreeNode?p.getTreeNode(h,l,"append",k):null);if(g.skipModal){dcForm.unsavedSegment=true;ECM.publish("/notify/clear/all");}if(n){n.dropIsContainer=true;n.dropArgs=arguments;n.dropObj=this;}var j=mt.root.childNodes?mt.root.childNodes[0]:false;if(g.useLogic&&j){var o=(j&&(j.attributes.data[d.IDX.LOGIC]&d.LOGIC.AND))?d.LOGIC.AND:d.LOGIC.OR;if(!(g.groupData.logic&o)){this.tree.onBooleanClick(j);}}var f=this.processDrop(l,h,"append",p,k,n);if(!!g.skipModal){n.dragStatus="";n.wrapAggregate();}if(g.isAggregator&&g.skipModal){this.showFeatureHelp(n);}return f;}else{return false;}},onNodeDrop:function(s,A,z,B){this.tree.selModel.clearSelections();var q=ECM.Rules.Constants;var u,h;var v=B.node.attributes;v=Ext.decode(Ext.encode(v));u=this.getDropPoint(z,s,A);if(v.isSegment){if(!Ext.isDefined(ECM.Stash.segments_used[v.segmentId])){ECM.Stash.segments_used[v.segmentId]=v.origText;
}}var g=s.node;if(!g.ownerTree.compatibleNodes(B.node,u=="append"?g:g.parentNode)){if(!v.isAggregator&&v.data[q.DATA.DEFINITION][q.IDX.TABLE]==="D"){Ext.MessageBox.alert(gt.gettext("Invalid Location"),gt.gettext("You cannot place demographic conditions inside aggregators."));}else{Ext.MessageBox.alert(gt.gettext("Invalid Location"),gt.gettext("That is not a valid location. Activity data conditions and aggregators follow a special set of rules. Please see our <a href='/WebHelp/index.htm'>Help</a> documents for more information."));}return false;}if(!v.fromTree){g=s.node;g.ui.startDrop();if(!this.isValidDropPoint(s,u,A,z,B)){g.ui.endDrop();return false;}h=B.node||(A.getTreeNode?A.getTreeNode(B,g,u,z):null);if(g.parentNode){var o=g.childrenRendered?1:0;h.updateConditionNode({modifyIndent:o});}this.tree.onConditionChange();var t=this.processDrop(g,B,u,A,z,h);B.node.wrapAggregate();return t;}else{var k=v.data[0];B.node.ui.removeClass("x-tree-node-over");B.node.ownerTree.selModel.clearSelections();var w=ECM.getObject("groupData.isInsight",v)||false;if(w&&v.dropPoint){u=v.dropPoint;}else{u=this.getDropPoint(z,s,A);}g.ui.startDrop();var d=g.attributes.data;if(d[q.IDX.OPERANDS]&&k&&k[q.IDX.OPERANDS]&&!Ext.isEmpty(k[q.IDX.OPERANDS][0])){var r=d[q.IDX.OPERANDS][0];var D=k[q.IDX.OPERANDS][0];var l=[10,83,115,117,119,121,137];if(d[q.IDX.COLUMN]==k[q.IDX.COLUMN]&&l.indexOf(parseInt(d[q.IDX.OPERATOR],10))!=-1){if(d[q.IDX.OPERATOR]==137){if(!(r&D[0])){g.updateNode({operands:[[r|D[0]],[]]});}else{g.ui.endDrop();return false;}}else{var x=r.length;r=Ext.unique(r.concat(D));if(x!==r.length){g.updateNode({operands:[r,[]]});}else{g.ui.endDrop();return false;}}var p=this.processDrop(g,B,u,A,z,g);if(p){dcForm.unsavedSegment=true;ECM.publish("/notify/clear/all");return p;}return false;}}if(!this.isValidDropPoint(s,u,A,z,B)){g.ui.endDrop();return false;}if(!!v.fromScratch&&!!v.isAggregator){this.tree.dropGroup(v);}else{if(!!v.isGroup){v=ECM.util.BracketRacket.toDropNode(v);this.tree.dropGroup(v);}else{var f={data:v.data,skipModal:v.skipModal,newFromTree:!v.skipModal,isSegment:v.isSegment};if(v.isSegment){f.segmentId=v.segmentId;f.segmentName=v.text;}this.tree.addCondition(f);if(v.skipModal){this.tree.onConditionChange();}}}var y=false;if(u=="append"&&g.childNodes[0]){y=g.childNodes[0];}else{if(u!="append"){y=g;}}if(v.useLogic&&y){var j=(y&&(y.attributes.data[q.IDX.LOGIC]&q.LOGIC.AND))?q.LOGIC.AND:q.LOGIC.OR;if(!(v.groupData.logic&j)){this.tree.onBooleanClick(y);}}h=this.tree.root.childNodes[this.tree.root.childNodes.length-1]||(A.getTreeNode?A.getTreeNode(B,g,u,z):null);if(h){h.dropArgs=arguments;h.dropObj=this;h.dropPoint=u;}var p=this.processDrop(g,B,u,A,z,h);if(!!v.skipModal){h.dragStatus="";var m=!!k?k[1]:v.aggCondition[1];h.wrapAggregate({table:m,indexPath:h.indexPath()});}if(p){dcForm.unsavedSegment=true;ECM.publish("/notify/clear/all");if(v.isAggregator&&v.skipModal){this.showFeatureHelp(h);}return p;}return false;}}},aggregatorFromScratchPad:function(f){f=f||[];var h=ECM.Rules.Constants;var g=f.data.shift();var d=[];Ext.each(f.data[0],function(l,k,j){d.push({data:l});});f.data=d;f.aggLogic=g[h.IDX.LOGIC];f.aggCondition=g[h.IDX.AGGREGATOR];f.fromScratch=false;return f;},dropGroup:function(l){if(!window.ecmTargetingModeOn){return false;}if(!!l.fromScratch&&!!l.isAggregator){l=this.aggregatorFromScratchPad(l);}var m=this.getSelectionModel(),d=m.getSelectedNodes();m.clearSelections();if(l&&!!l.isGroup){for(var k=0;k<l.data.length;k++){if(!!l.data[k].isGroup){this.dropGroup(l.data[k]);}else{this.addCondition({data:l.data[k].data,skipModal:true,skipMove:true});}m.select(this.root.childNodes[this.root.childNodes.length-1],{},true);}var h=ECM.getObject("groupData.name",l)||"";var j=ECM.getObject("groupData.isInsight",l)||false;var g={skipModal:true,text:h,isInsight:j};if(l.useLogic){g.useLogic=true;}if(l.isAggregator){var f=Ext.isDefined(l.skipModal)?l.skipModal:true;g={fromTree:true,skipModal:f,isAggregator:true,text:l.groupData?l.groupData.name:l.name,aggName:f?l.text:l.aggName,logic:l.aggLogic,deferActivate:true};if(l.aggCondition){g.aggCondition=l.aggCondition;}}else{g.logic=ECM.getObject("groupData.logic",l)||undefined;g.useLogic=!!g.logic;}this.addGroup(g);Ext.each(d,function(n){m.select(n,{},true);});}},getDialog:function(){var d=this.perspective();return d.dialog.call(d);},getGroup:function(l){l=l||{};var n=l.tree||this,f=ECM.Rules.Constants,j=__structs__[n.__data__.identity],k=j.data.rules[0][1],m={};if(!ECM.Adapter.isEffective(l.node)){l.node=n.getGroupParent();if(!l.node){return false;}}var h=l.node;var d=n.dataSource();var g=d.findRuleByPath({data:k,path:h.indexPath(),separator:"/"});if(Ext.isDefined(h.condition().group)||Ext.isDefined(h.condition().aggregator)){m.text=g[1];m.isGroup=true;m.isAggregator=Ext.isDefined(h.condition().aggregator);if(m.isAggregator){m.aggCondition=h.attributes.data[f.IDX.AGGREGATOR];m.aggLogic=h.attributes.data[f.IDX.LOGIC];}else{m.logic=h.attributes.data[f.IDX.LOGIC];}m.data=[];Ext.each(h.childNodes,function(q,p,o){if(!Ext.isDefined(q.condition().group)&&!Ext.isDefined(q.condition().aggregator)){g=d.findRuleByPath({data:k,path:q.indexPath(),separator:"/"});m.data.push({data:[g]});}else{g=n.getGroup({node:q,tree:n});m.data.push(g);}});return m;}else{return false;}},getAllGroupNames:function(){return this.getGroupNames(this.getTargetingJSON());},getGroupNames:function(f){var d=[];Ext.each(f,function(g){if(g[0]&&(g[0][0]&ECM.Rules.Constants.LOGIC.GROUP)){d.push(g[0][1]);d=d.concat(this.getGroupNames(g[1]));}},this);return d;},getGroupParent:function(){var d=this.getSelectionModel().getSelectedNodes();var f,h,k;var j=0;var g=[];Ext.each(d,function(n,m,l){k=n.indexPath().split("/").length;if(k<j||j==0){f=n;j=k;}else{g.push(k);}});Ext.each(d,function(n,m,l){if(!n.isAncestor(f)){return false;}});if(g.indexOf(j)>-1||!f.condition().group){return false;}else{return f;}},getTargetingJSON:function(){return __structs__[this.__data__.identity].data.rules[0][1];},containsActivityData:function(){var d=this.getTargetingJSON();return !Ext.isEmpty(d.toString().match(/\d+,[BCORST],/));},initComponent:function(){mt=this;this.lockFirstRow=Boolean(window.ecmTargetingModeOn);ECM.Rules.Targeting.superclass.initComponent.call(this);},initEvents:function(){ECM.Rules.Targeting.superclass.initEvents.call(this);this.mon(this,"booleanclick",this.onBooleanClick,this);this.mon(this,"checkchange",this.onCheckChanged,this);this.mon(this,"conditionclick",this.onTargetClick,this);this.mon(this,"inclusionclick",this.onInclusionClick,this);this.mon(this,"targetclick",this.onTargetClick,this);this.subs.push(ECM.Subscribers.subscribe({topic:c.TOPIC.PRIORITY.MOVED,subscriber:new ECM.Subscriber({notify:ECM.hitch(this,this.onPriorityMoved)})}));this.subs.push(ECM.Subscribers.subscribe({topic:c.TOPIC.TAG.CONVERTED,subscriber:new ECM.Subscriber({notify:ECM.hitch(this,this.onTagConverted)})}));},listeners:{startdrag:function(){var d=Array.prototype.slice.call(arguments);ECM.publish.apply(ECM,["targetingNodeStartDrag"].concat(d));},enddrag:function(){var d=Array.prototype.slice.call(arguments);ECM.publish.apply(ECM,["targetingNodeEndDrag"].concat(d));}},lockFirstRow:false,onBooleanClick:function(h){var f=h.ownerTree;var k=this.dataSource();var g={identity:this.identity(),indexPath:h.indexPath(),rowIndex:this.rowIndex(),separator:this.pathSeparator,isAggregator:h.attributes.isAggregator};var d=k.findLogicByPath(g);var j=this.inverseBooleanLogic(d);this.updateLogic({dataSource:k,newValue:j,parentNode:h.parentNode,request:g,clickTarget:"boolean"});this.onConditionChange();},onCheckChanged:function(f,h,o,k){if(!this.isSimpleTag()){var g=!!(((f.parentNode||{}).ui||{}).checkbox||{}).checked;if(!h&&!f.parentNode.isRoot&&g){f.ui.onSelectedChange(c.YES);if(!k){if(!window.ecmTargetingModeOn){this.perspective().notify.warn(ECM.Locale.fetch({key:"YOU_CANNOT_DESELECT_CONDITION_WITHIN_GROUP"}));}else{ECM.Targeting.Frame.error(gt.gettext("You can't unselect a criteria while the group is selected."));
}}}var n=f.attributes||{};if(n.isGroup){var d=f.childNodes||[];var l=this.getSelectionModel();for(var j=0,m=d.length;j<m;j++){l.unselect(d[j]);d[j].ui.onSelectedChange(h);}}}},onInclusionClick:function(g){var j=this.dataSource();var f={identity:this.identity(),indexPath:g.indexPath(),rowIndex:this.rowIndex(),separator:this.pathSeparator};var d=j.findLogicByPath(f);var h=this.inverseInclusionLogic(d);if(g.attributes.isAggregator){g.attributes.data[2][0]=h;}this.updateLogic({dataSource:j,newValue:h,node:g,request:f});this.onConditionChange();},onMoveNode:function(n,d,l,m,j,k){var h=ECM.Rules.Targeting.superclass.onMoveNode.apply(this,arguments);var g={identity:this.identity(),indexPath:d.indexPath(),rowIndex:this.rowIndex(),separator:this.pathSeparator};var f=this.dataSource().ruleInfo({data:h[c.DATA.FIRST],identity:g.identity,isAggregator:d.attributes.isAggregator});if(d.attributes.isAggregator){d.attributes.data[2][0]=d.attributes.data[0];}this.updateNode({attrs:f,bundle:g,node:d});},onPriorityMoved:function(d){var f=this.dataSource().lastIndexFromPath({path:d.indexPath,separator:d.separator});this.rowIndex(f);},onRender:function(){ECM.Rules.Targeting.superclass.onRender.apply(this,arguments);this.el.addClass("ecm-rules-targeting");},onSelectionChange:function(f,d){if(!window.ecmTargetingModeOn){return this.onSelectionChangeDC(f,d);}var j=this.__data__.total;if(this.renderMode()!=="segment"){var m=d.length;var g=this.tagType()||c.TAG.SIMPLE;var l=ECM.Targeting.Util.Grain;var h=Array.all(mt.selModel.getSelectedNodes(),function(n){var o=Array.any(l.getCompatibleTables(false,n.getParentGrain(true),true),function(p){return l.isCompatibleTable(n.getTable(),p,false,true);});return n.attributes&&n.attributes.isAggregator&&o;});var k=Ext.getCmp("btnCreate").menu.getComponent("aggregator");k&&k.setDisabled(!h);Ext.getCmp("btnDeleteCondition").setDisabled(((m)&&(m<j))?false:true);}},onSelectionChangeDC:function(f,d){if(this.renderMode()!=="segment"){var j=d.length;var h=ECM.hitch(this.topToolbar.items,this.topToolbar.items.itemAt);var g=this.tagType()||c.TAG.SIMPLE;h(c.TOOLBAR.TARGETING[g].DELETE)[(j)?"enable":"disable"]();}},onShow:function(){ECM.Rules.Targeting.superclass.onShow.apply(this,arguments);this.onResize(this.container.dom.clientWidth,this.container.dom.clientHeight);},onTagConverted:function(d){ECM.Rules.Targeting.superclass.onTagConverted.apply(this,arguments);if(d.addCondition){this.addCondition();}this.perspective().loading().hide();},onTargetClick:function(g,l,d){if(Ext.isDefined(g.attributes)&&g.attributes.processing){return;}if(!g.ignoreClickEvent){var m=g.dialog();if(!m.keyNav){m.keyNav=new Ext.KeyNav(Ext.getDoc(),{enter:function(p){if(p.target.nodeName==="BUTTON"&&p.target.textContent!=gt.gettext("Done")){return true;}var o=document.getElementById("dcModalDoneButton");if(o&&!o.disabled){ECM.publish("targeting_submit_form");}}});m.on("hide",m.keyNav.disable,m.keyNav);m.on("show",m.keyNav.enable,m.keyNav);}m.removeAll(true);if(m.fbar){m.fbar.removeAll(true);}if(g.attributes){m.width=g.attributes.isAggregator?660:635;dcForm.gridPickerWidth=g.attributes.isAggregator?626:601;}else{m.width=635;dcForm.gridPickerWidth=601;}m.height="auto";m.resizable=false;var k=ECM.Rules.Form.generateComponentsFromNode(g);var f=g.condition()||{},n=k[0].subtitle;if(f.group||f.aggregator){if(f.mode){if(g.attributes.isAggregator){m.setTitle(gt.gettext("Edit Aggregator"));}else{m.setTitle(gt.gettext("Edit Group"));}m.un("beforehide",ECM.Rules.Form.beforeDialogHide);}else{if(g.attributes.isAggregator){m.setTitle(gt.gettext("Create Aggregator"));}else{m.setTitle(gt.gettext("Create Group"));}m.on("beforehide",ECM.Rules.Form.beforeDialogHide);}}else{var j=false;if(Ext.isDefined(g.newFromTree)){j=g.newFromTree;}if(!j&&((d&&ECM.Adapter.fly(d).hasClass("ecm-condition"))||f.mode)){if(g.isMainSubscription){m.setTitle(gt.gettext("Subscription List - Choose List"));m.on("afterrender",function(){var o=Ext.get(Ext.query(".ecm-degp-panel")[0]);if(o){o.setStyle("display","none");}});}else{m.setTitle(gt.gettext("Edit Condition"+(n?" - "+n:"")));}if(!dcForm.isSimpleMode){m.un("beforehide",ECM.Rules.Form.beforeDialogHide);}}else{m.setTitle(gt.gettext("Create Condition"+(n?" - "+n:"")));m.on("beforehide",ECM.Rules.Form.beforeDialogHide);}}if(!!g.newFromTree||g.newOrStart){m.on("beforehide",ECM.Rules.Form.beforeDialogHide);}if(f.mode==ECM.Rules.Constants.MODES.ADD&&f.switchToAdvanced==ECM.Rules.Constants.YES){m.un("beforehide",ECM.Rules.Form.beforeDialogHide);}m.add(k[0]);for(var h=k.length-1;h>0;h--){m.addButton(k[h]);m.addButton({xtype:"spacer",html:"&nbsp;",width:4});}m.on("show",function(){var o=Ext.getCmp("btnPanel");o.validateForm();},this,{single:true});m.show();m.center.defer(100,m);}g.ignoreClickEvent="";},onConditionChange:function(){dcForm.unsavedSegment=true;ECM.publish("/notify/clear/all");ECM.publish("conditionChanged");},plugins:["ecm.subscription"],redraw:function(h){h=h||{};var g=h.self||this;var j=g.dataSource().otherIdentities(g.identity());var d=g.isStandard();g.enableDD=(!d)?false:!h.isSimpleTag;if(h.isSimpleTag&&d){var f=b[h.renderMode].slice(0);f.splice(c.TOOLBAR.TARGETING[c.TAG.SIMPLE].CONDITION,1,b.simpleBtn);g.setTopbar(f);}else{g.setTopbar(b[h.renderMode]);}g.setColumns(a[h.renderMode]);if(d){if(ECM.Adapter.isEffective(j.key)){var l=ECM.hitch(g.topToolbar.items,g.topToolbar.items.itemAt);var k=this.tagType()||c.TAG.SIMPLE;l(c.TOOLBAR.TARGETING[k].CONDITION).disable();}g.headersShow();g.el.removeClass("ecm-rules-targeting-segment").addClass("ecm-rules-targeting-standard");}else{g.headersHide();g.el.removeClass("ecm-rules-targeting-standard").addClass("ecm-rules-targeting-segment");}},renderError:function(f){var d=Ext.DomHelper.insertBefore(this.container.dom,{id:"targetingPaneErrorMsgArea",cls:"cm_error",html:f},true);d.setVisibilityMode(Ext.Element.DISPLAY);ECM.subscribe("/targetingpane/error/clear",function(){d.hide();});this.renderError=function(g){d.show();d.update(g);};},renderSegment:function(){var f=this;if(f.renderMode()==="segment"){return false;}var g=f.isSimpleTag();var h=f.renderMode("segment");f.redraw({isSimpleTag:g,renderMode:h,self:f});if(!f.containsActivityData()){this.__data__.total=0;f.dataSource().targeting({id:f.identity(),rowIndex:f.__data__.rowIndex,callback:function(j){f.construct({data:f.segmentTopLevel(j),key:j.key});}});}else{f.renderError(gt.gettext("Your criteria cannot be displayed in classic view because you are using new segmentation features."));}var d=this.container.dom;this.onResize(d.clientWidth,d.clientHeight);this.allowContextMenu=false;this.fireEvent("rendersegment",this);},renderStandard:function(){var f=this;ECM.publish("/targetingpane/error/clear");var d=(f.renderMode()!=="segment");if(f.isStandard()){return false;}if(d){f.perspective().loading().show();}var g=f.isSimpleTag();var h=f.renderMode("standard");f.redraw({isSimpleTag:g,renderMode:h,self:f});this.__data__.total=0;f.dataSource().targeting({id:f.identity(),rowIndex:f.__data__.rowIndex,callback:function(j){var k=(j.tagType===c.TAG.SIMPLE);if(g!==k){g=k;f.redraw({isSimpleTag:g,renderMode:h,self:f});}f.construct({data:j.rule,key:j.key,tagType:j.tagType});if(d){f.perspective().loading().hide();}}});this.onResize(this.container.dom.clientWidth,this.container.dom.clientHeight);this.allowContextMenu=window.ecmTargetingModeOn?!ECM.Targeting.Store.SegmentData.isArchived():false;this.fireEvent("renderstandard",this);},saveGroup:function(h){var g=Ext.getCmp("ln-acc-groups");var f=Ext.getCmp("ln-groups");g.expand();var j=this.getGroup({node:h,tree:this});if(!!j){var d=new ECM.tree.TreeNode(ECM.Adapter.apply(j,{fromTree:true,leaf:true}));f.root.appendChild(d);Ext.get(d.ui.elNode.id).highlight("b5f04a");}},segmentSanitize:function(j){var g=[];j[c.DATA.MEMBER]=j[c.DATA.MEMBER]||[];var d=j[c.DATA.MEMBER].length;if(d===0){if(!!!(j[c.DATA.DEFINITION][c.IDX.LOGIC]&c.LOGIC.GROUP)){g[c.DATA.DEFINITION]=Array.clone(j[c.DATA.DEFINITION]);g[c.DATA.MEMBER]=[];}}else{if(d===1){if(ECM.Adapter.isString(j[c.DATA.DEFINITION])){g[c.DATA.DEFINITION]=j[c.DATA.DEFINITION];
g[c.DATA.MEMBER]=[Array.clone(this.segmentSanitize(j[c.DATA.MEMBER][0]))];}else{g=Array.clone(this.segmentSanitize(j[c.DATA.MEMBER][0]));}}else{g[c.DATA.DEFINITION]=Array.clone(j[c.DATA.DEFINITION]);g[c.DATA.MEMBER]=[];var f=false;for(var h=0;h<d;h++){g[c.DATA.MEMBER][h]=Array.clone(this.segmentSanitize(j[c.DATA.MEMBER][h]));if(g[c.DATA.MEMBER][h][c.DATA.DEFINITION]&&!!(g[c.DATA.MEMBER][h][c.DATA.DEFINITION][c.IDX.LOGIC]&c.LOGIC.OR)){f=true;}}d=g[c.DATA.MEMBER].length;if(f){for(var h=0;h<d;h++){if(g[c.DATA.MEMBER][h][c.DATA.DEFINITION]){g[c.DATA.MEMBER][h][c.DATA.DEFINITION][c.IDX.LOGIC]&=~c.LOGIC.AND;g[c.DATA.MEMBER][h][c.DATA.DEFINITION][c.IDX.LOGIC]|=c.LOGIC.OR;}}}}}return g;},segmentTopLevel:function(g){var f=g.rule[c.DATA.MEMBER]||[];if(ECM.Adapter.isArray(f)){var d=[g.rule[c.DATA.DEFINITION],[[[((!!(f[c.DATA.FIRST][c.DATA.DEFINITION][c.IDX.LOGIC]&c.LOGIC.OR))?26:22),""],[]]]];for(var h=0,j=f.length;h<j;h++){d[c.DATA.MEMBER][c.DATA.FIRST][c.DATA.MEMBER].push(Array.clone(f[h]));}return this.segmentSanitize(d);}else{return g.rule;}},getUnknownTableFromNode:function(k,h){var j="*";if(k.getTable){var g;if(g=k.getTable()){j=g;}else{f=[];k.cascade(function(l){if(l.getTable()){if(h){f.push(l.getTable());}else{j=l.getTable();return false;}}});if(h){return Ext.unique(f);}}}else{if(k.attributes&&k.attributes.data&&k.attributes.data[0]){if(k.attributes.isGroup&&h){function d(n){var o=ECM.Rules.Constants;n=n||[];var m=[];for(var l=0;l<n.length;l++){if(n&&n[l]&&Ext.isArray(n[l])){if(parseInt(n[l][0])&o.LOGIC.GROUP){m=m.concat(d(n[l].slice(1)[0]));}else{m.push(n[l][0][o.IDX.TABLE]);}}}return m;}var f=d(k.attributes.data);return f.length>0?Ext.unique(f):"*";}else{if(k.attributes.data[0][1]){j=k.attributes.data[0][1];}}}else{if(k.attributes.aggCondition){j=k.attributes.aggCondition[c.IDX.TABLE]||"C";}}}return j;},subscriptions:{targetingNodeStartDrag:function(d,f){this.root.cascade(function(h){if(!h.ownerTree.compatibleNodes(f,h)){h.ui.addClass("invalid-drag-handle");}else{var g=false;if(h.stripeIndex){g=h.stripeIndex&1;}h.ui.addClass(g?"valid-drag-handle-odd":"valid-drag-handle");}});},targetingNodeEndDrag:function(d,f){this.root.cascade(function(g){g.ui.removeClass("invalid-drag-handle");g.ui.removeClass("valid-drag-handle");g.ui.removeClass("valid-drag-handle-odd");});}},toString:function(){return"["+this.xtype+(this.id?" "+this.id:"")+"]";},updateFirstRow:function(h){var l=this;h=h||l.root;var j=h.childNodes;if(j||!window.ecmTargetingModeOn){for(var g=0,n=j.length;g<n;g++){var f=(g===0);var k=j[g];var m=k.childNodes.length;var d=k.ui;if(d){d[(f)?"addClass":"removeClass"]("ecm-rules-first-row");d[(m)?"removeClass":"addClass"]("ecm-rules-no-children");}(m)&&(window.setTimeout(function(){l.updateFirstRow(k);},1));}}},inverseLogic:function(g,f,d){var h=g;h&=~f;h&=~d;h|=(!!(g&f))?d:f;return h;},inverseInclusionLogic:function(d){return this.inverseLogic(d,c.LOGIC.EXCLUDE,c.LOGIC.INCLUDE);},inverseBooleanLogic:function(d){return this.inverseLogic(d,c.LOGIC.AND,c.LOGIC.OR);},updateLogic:function(k){k=k||{};var n,f;if(k.node){n=ECM.Adapter.apply(k.request,{indexPath:k.node.indexPath(),value:k.newValue});f=k.dataSource.updateLogic(n);this.updateNode({attrs:f,bundle:n,node:k.node});}else{var l=k.parentNode.childNodes;for(var g=0,j=l.length;g<j;g++){var m=l[g];if(m.isMainSubscription){continue;}var d=m.attributes.data[c.IDX.LOGIC];var h=d&(c.LOGIC.AND|c.LOGIC.OR);d=((h&k.newValue)===0)?this.inverseBooleanLogic(d):d;if(m.attributes.isAggregator){m.attributes.data[2][0]=d;}n=ECM.Adapter.apply(k.request,{indexPath:m.indexPath(),value:d,clickTarget:k.clickTarget});f=k.dataSource.updateLogic(n);this.updateNode({attrs:f,bundle:n,node:m});}if(!k.parentNode.isRoot){n=ECM.Adapter.apply(k.request,{firstChild:l[c.DATA.FIRST],indexPath:k.parentNode.indexPath()});delete n.value;f=k.dataSource.updateLogic(n);this.updateNode({attrs:f,bundle:n,node:k.parentNode});}}},updateNode:function(f){f=f||{};var j=ECM.Rules.Constants;if(f.node){var d=this;var g=f.node;if(g.ui.booleanNode){d.mun(g.ui.booleanNode,"click",function(k,l){d.fireEvent("booleanclick",this,k,l);},g);}if(g.ui.conditionNode&&g.ui.conditionNode.hasClass("ecm-condition")){d.mun(g.ui.conditionNode,"click",function(k,l){d.fireEvent("conditionclick",this,k,l);},g);}if(g.ui.inclusionNode){d.mun(g.ui.inclusionNode,"click",function(k,l){d.fireEvent("inclusionclick",this,k,l);},g);}Ext.dd.Registry.unregister(g.ui.elNode.id);(f.attrs)&&(ECM.Adapter.apply(g.attributes,f.attrs));var h=d.renderMode();(h==="none")&&(h="standard");g.ui.onTextChange(null,g.attributes[h]);g.ui.booleanNode=ECM.Adapter.get(Ext.DomQuery.select(".ecm-boolean-toggle",g.ui.textNode)[0]);if(g.ui.booleanNode&&!!g.parentNode.isRoot){g.ui.booleanNode.addClass("ecm-root-node-bool");}if(g.ui.booleanNode){g.ui.booleanNode.addClassOnOver("ecm-boolean-toggle-mo");g.ui.booleanNode.dom.setAttribute("ext:qtip",gt.gettext("Click on the conjunction to toggle between and/or."));d.mon(g.ui.booleanNode,"click",function(k,l){d.fireEvent("booleanclick",this,k,l);},g);}g.ui.conditionNode=ECM.Adapter.get(Ext.DomQuery.select(".ecm-condition",g.ui.textNode)[0]);if(g.ui.conditionNode){g.ui.conditionNode.addClassOnOver("ecm-condition-mo");d.mon(g.ui.conditionNode,"click",function(k,l){d.fireEvent("conditionclick",this,k,l);},g);}else{g.ui.conditionNode=ECM.Adapter.get(Ext.DomQuery.select(".ecm-condition-disabled",g.ui.textNode)[0]);}g.updateConditionNode();g.ui.inclusionNode=ECM.Adapter.get(Ext.DomQuery.select(".ecm-inclusion-toggle",g.ui.textNode)[0]);if(g.ui.inclusionNode){g.ui.inclusionNode.addClassOnOver("ecm-inclusion-toggle-mo");g.ui.inclusionNode.dom.setAttribute("ext:qtip",gt.gettext("Click on action to toggle between include/exclude"));d.mon(g.ui.inclusionNode,"click",function(k,l){d.fireEvent("inclusionclick",this,k,l);},g);}if(this.enableDD){Ext.dd.Registry.register(g.ui.elNode,{node:g,handles:g.ui.getDDHandles(),isHandle:false});}ECM.Subscribers.notify({bundle:[f.bundle],topic:j.TOPIC.TARGETING.RULE.CHANGE});this.updateFirstRow(g.parentNode);}}});ECM.Adapter.override(ECM.treegrid.TreeNode,{applyChanges:function(g){if(g){var d=this.ownerTree;var h={identity:d.identity(),indexPath:this.indexPath(),rowIndex:d.rowIndex(),separator:d.pathSeparator};var j=d.dataSource().key({identity:h.identity});ECM.Adapter.apply(g,h);var f=d.dataSource().updateRule(g)||{};if(!d.updateNode){g.switchToAdvanced=true;}if(!g.switchToAdvanced){d.updateNode({attrs:f,bundle:h,node:this});if(ECM.Adapter.isEffective(g.columnId)&&d.isSimpleTag()&&(h.rowIndex===0||g.forceChangeField)&&g.columnId!==j){ECM.Subscribers.notify({bundle:[ECM.Adapter.apply({key:g.columnId},h)],topic:c.TOPIC.TARGETING.KEY.CHANGE});}}this.wrapAggregate(g);}},cancelChanges:function(){var d=this.ownerTree;var g=this.indexPath();if(d&&(this.condition().mode===0||this.dragStatus=="drop")){var k=d.dataSource();var l;if(this.childNodes.length>0){l=this.childNodes[0];var h={identity:d.identity(),indexPath:l.indexPath(),rowIndex:d.rowIndex(),separator:d.pathSeparator};var f=k.findLogicByPath(h);var j=f;j&=~c.LOGIC.OR;j|=c.LOGIC.AND;d.updateLogic({dataSource:k,newValue:j,parentNode:d.findNodeByPath({path:this.indexPath()}),request:h,clickTarget:"boolean"});}d.deleteCondition({dataSource:k,identity:d.identity(),isSimpleTag:d.isSimpleTag(),node:this,rowIndex:d.rowIndex(),separator:d.pathSeparator});}},condition:function(f){f=f||{};var d=this.ownerTree;return d.dataSource().condition.call(this,ECM.Adapter.apply(f,{identity:d.identity(),indexPath:this.indexPath(),rowIndex:d.rowIndex(),separator:d.pathSeparator}));},dataStore:function(f){f=f||{};var d=this.ownerTree;return d.dataSource().dataStore.call(this,ECM.Adapter.apply(f,{identity:d.identity(),indexPath:this.indexPath(),separator:d.pathSeparator,rowIndex:d.rowIndex()}));},dialog:function(){var d=this.ownerTree||{};return ECM.hitch(d,d.getDialog)();},getJSON:function(){var d=this;var g=this.indexPath().split("/");g.shift();var f=function(k,j){var h=k.shift();return k.length>0?f(k,j[h][1]):d.attributes.isAggregator?j[h]:d.attributes.isGroup?j[h][1]:j[h];
};return f(g,this.getOwnerTree().getTargetingJSON());},getCompatibleTables:function(){var f=ECM.Targeting.Util.Grain;var d=this.getNodeCompatibleTables();this.cascade(function(g){if(g==this){return;}d=Ext.partition(d,(function(h){return f.isCompatibleTable(g.getTable(),h,false,g.attributes.isAggregator);}).createDelegate(this))[0];},this);return d;},getNodeCompatibleTables:function(){var d=ECM.getObject("attributes.isAggregator",this);return ECM.Targeting.Util.Grain.getCompatibleTables(this.getTable(),d?this.getParentGrain(true):this.getGrain(),d);},getGrain:function(f){if(!window.ecmTargetingModeOn){return ECM.Targeting.Util.Grain.SUBSCRIBER;}var d=this.getTable()||"D";var g;if(this.attributes.isGroup&&!this.attributes.isAggregator){if(f===0){return undefined;}else{if(f<0){this.cascade(function(j){var h;if(h=j.getGrain(0)){g=h;return false;}});}else{g=this.getParentGrain();}}}else{if(this.getTable()){g=ECM.Targeting.Util.Grain.getGrainFromTable(d);}else{g=this.getParentGrain(true);}}return g;},getParentGrain:function(d){if(this.parentNode){if(d&&this.parentNode.getTable&&this.parentNode.getTable()){return ECM.Targeting.Util.Grain.getGrainFromTable(this.parentNode.getTable());}else{if(this.parentNode.getGrain){return this.parentNode.getGrain();}else{return this.getGrain();}}}else{return ECM.Targeting.Util.Grain.SUBSCRIBER;}},getTableAdvanced:function(){var f=[];var d=ECM.getObject("attributes",this);if(d.isAggregator){if(d.data&&d.data[c.IDX.AGGREGATOR]){f=d.data[c.IDX.AGGREGATOR];}}else{if(!d.isGroup&&d.data&&d.data[c.IDX.TABLE]){f=d.data;}else{if(this.parentNode&&this.parentNode.attributes.isAggregator){f[c.IDX.TABLE]=this.parentNode.getTableAdvanced();}}}if(f&&f[c.IDX.TABLE]){return f[c.IDX.TABLE];}},getTable:function(){var h=ECM.Rules.Constants;var g=ECM.Form.FormElements.ElementHelper;var d=undefined;if(this.ownerTree.isSimpleTag()){if(this.condition().columnId){var f=g.getColumnInfoFromId(this.condition().columnId).table;if(f){d=f;}}}else{d=this.getTableAdvanced();}return d;},isActivity:function(){var d=ECM.Rules.Constants;return this.attributes.data&&this.attributes.data[d.IDX.TABLE]&&"BCORST".indexOf(this.attributes.data[d.IDX.TABLE])>-1;},isDuplicate:function(f){var d=this.ownerTree||{};return d.dataSource().isDuplicate.call(this,ECM.Adapter.apply(f,{identity:d.identity(),indexPath:this.indexPath(),rowIndex:d.rowIndex(),separator:d.pathSeparator}));},updateConditionNode:function(g){var l=this.ui.conditionNode;var j=this.parentNode?this.parentNode.ui.getAncestorCnt():0;g=g||{};g.modifyIndent=g.modifyIndent||0;var m=this.getOwnerTree().getEl().getWidth();m-=250;if(l&&l.dom.getAttribute("ext:qtip")){if(this.parentNode){j=g.modifyIndent?j+g.modifyIndent:j;var k=m-(j?j*20:0);l.setWidth(k);var f=ECM.DomHelper.ellipsis({width:k-15,text:l.dom.getAttribute("ext:qtip"),cls:"ecm-condition-tip"});l.update(f.text);}for(var h=0;h<this.childNodes.length;h++){this.childNodes[h].updateConditionNode(g);}}else{if(this.parentNode){if(!this.ui.getEl()||!this.getOwnerTree().getEl().isDisplayed()){return false;}var k=Ext.get(this.ui.getEl()).getWidth()-610-(j?j*20:0);var d=this.ui.textNode.getAttribute("ext:qtip");if(d&&window.ecmTargetingModeOn){this.ui.textNode.innerHTML=d;}var f=ECM.DomHelper.ellipsis({text:l?l.dom.innerHTML:this.ui.textNode.innerHTML,width:k,cls:"x-tree-node"});if(f.truncated===true){this.ui.textNode.setAttribute("ext:qtip",this.ui.textNode.innerHTML);if(l){l.update(f.text);}else{this.ui.textNode.innerHTML=f.text;}}else{if(d&&!window.ecmTargetingModeOn){this.ui.textNode.removeAttribute("ext:qtip");}}}}},containsAggregator:function(){var d=false;this.cascade(function(f){if(f&&f.attributes&&f.attributes.isAggregator){d=true;return false;}});return d;},wrapAggregate:function(f){f=f||{};if(this.attributes.isAggregator||this.containsAggregator()){return;}var d=this.ownerTree;var h=ECM.Targeting.Util.Grain;if(h.isCompatibleGrain(this.getGrain(-1)||this.getGrain(),this.getParentGrain(true))){var g=278;if(this.attributes.data[c.IDX.LOGIC]&c.LOGIC.OR){g=282;}var j={logic:g,indexPath:this.indexPath(),fromTree:true,skipModal:true,operatorId:31,operands:[[1],[]],tableId:this.ownerTree.getUnknownTableFromNode(this),aggName:"Aggregator"};j.aggCondition=[j.logic,j.tableId,"",j.operatorId,j.operands];this.select();d.addAggregator(j);this.ownerTree=d;this.dragStatus="";}},updateNode:function(f){var d=this.ownerTree;var g=this.attributes.data;var h={forceChangeField:false,switchToAdvanced:false,identity:d.identity(),rowIndex:d.rowIndex(),indexPath:this.indexPath(),separator:"/",operatorId:g[3],columnId:g[2],operands:g[4],inclusion:g[0]&ECM.Rules.Constants.LOGIC.INCLUDE?true:false};ECM.Adapter.apply(h,f);this.applyChanges(h);}});ECM.Adapter.register("ECM.Rules.Targeting",ECM.Rules.Targeting);ECM.Adapter.onUnload(function(){b=a=null;});})();ECM.provide("ECM.Rules.Priority");(function(){var j=ECM.Rules.Constants;var d=j.TOPIC.PRIORITY;var b={xtype:"button",cls:"blue_button",id:"dcViewDetailBtn",viewDetailText:gt.gettext("View Details"),editRuleText:gt.gettext("Edit Details"),text:gt.gettext("View Details"),handler:function(){var k=ECM.Rules.DynamicContent.layout({id:Ext.getCmp("ViewDetailOld").__data__.identity}).priority;if(this.getText()===this.viewDetailText){k.renderAll();Ext.getCmp("dcViewDetailBtn").setText(this.editRuleText);}else{k.renderStandard();Ext.getCmp("dcViewDetailBtn").setText(this.viewDetailText);}}};var a={disabled:true,cls:"blue_button",text:ECM.Locale.fetch({key:"COPY_RULE"}),handler:function(){var k=this.ownerCt.ownerCt.ownerCt.ownerCt;k.copyRule.apply(k,arguments);}};var f={disabled:true,cls:"blue_button",text:ECM.Locale.fetch({key:"DELETE_RULE"}),handler:function(){var k=this.ownerCt.ownerCt.ownerCt.ownerCt;k.deleteRule.apply(k,arguments);}};var g={xtype:"splitbutton",text:ECM.Locale.fetch({key:"ADD_RULE"}),cls:"blue_button",handler:function(){var k=this.ownerCt.ownerCt;k.addRule.apply(k,arguments);},menu:[a,f]};var h={all:["","","","->",b,function(){g.disabled=true;return g;}()],allSimple:["","",""],standard:["","","","->",b,g]};var c={all:[{header:ECM.Locale.fetch({key:"VIEW_RULES_AND_TARGETING"}),dataIndex:"all",width:997}],standard:[{header:"",dataIndex:"draggable",width:22},{header:'<input type="checkbox" class="checkbox-toggler">',dataIndex:"checked",width:33,cls:"rules-row-cb-col",tpl:new Ext.XTemplate("{checked:this.renderCheckbox}",{renderCheckbox:function(l,k){return(k.isDefault)?"":'<input type="checkbox" class="selection-checkbox"'+((l)?' checked="checked"':"")+">";}}),align:"center"},{header:ECM.Locale.fetch({key:"PRIORITY"}),dataIndex:"priority",width:60,cls:"rules-row-priority-col",align:"center"},{header:'<span class="description-label">'+ECM.Locale.fetch({key:"DESCRIPTION"})+'</span><input type="text" class="description-search" value=""><span class="search-triggers"><div class="clear-trigger"></div></span>',dataIndex:"description",cls:"rules-row-description-col priority-data-col",width:242},{header:ECM.Locale.fetch({key:"TARGETING"}),dataIndex:"rules",cls:"rules-row-targeting-col priority-data-col",width:418}]};ECM.Rules.Priority=ECM.Adapter.extend(ECM.Rules.Workbench,{activeIndex:function(k){(ECM.Adapter.isEffective(k))&&(this.__data__.openIndex=k);(!ECM.Adapter.isEffective(this.__data__.openIndex))&&(this.__data__.openIndex=-1);return this.__data__.openIndex;},activeRule:function(l,k){if(l){k=k||{};k.force=j.YES;k.fresh=k.fresh||false;k.standard=k.standard||false;l.fireEvent("click",l,{},k);}},addRule:function(){var p=this.count({masterListOnly:j.YES});var k=this.dataSource();var q=this.isSimpleTag();var t=k.pageSize();if(!q&&(p+1)>t){this.perspective().notify.warn(ECM.Locale.fetch({key:"MAXED_OUT_ADD_RULE_IN_ADVANCED_MODE",params:[t]}));}else{ECM.Subscribers.notify({topic:j.TOPIC.PRIORITY.ADJUSTED});var r=this.identity();var s=this.pageNum();var m=k.addRule({identity:r,pageNum:s});if(m){var v=this.root;var u=v.childNodes.length;var n=(v.childNodes[u-1]&&v.childNodes[u-1].attributes.isDefault);(n)&&(u--);if(u>=t){v.removeChild(v.childNodes[--u],1);
}var l=this.constructNode({data:m.rules,holder:v,isSimpleTag:q,key:m.key,position:(this.pathSeparator+u),rowIndex:(u+1)});var o=k.totalPages({force:j.YES,identity:r,keyword:this.keyword()});if(s<o&&n){v.removeChild(v.childNodes[v.childNodes.length-1],1);}if(this.stripeRows){this.__data__.total=0;v.fixStripes.call(v);}this.activeRule(l,{fresh:j.YES,standard:j.YES});this.updateTotalRows();this.showPager(s);}}},addRules:function(k){if(this.isStandard()){this.updateRules(k);}else{var l=this.constructNode({data:k.data,holder:(k.holder||this.root.childNodes[k.rowIndex]),position:k.position,rowIndex:k.rowIndex});l.ui.elNode.scrollIntoView(false);}},beforeMoveRules:function(k){(!this.isStandard())&&(this.deleteRules(k));},checkboxToggle:function(k,o){var r=!!o.checked;var q=this.root.childNodes||[];var l=this.getSelectionModel();for(var n=0,m=q.length;n<m;n++){var p=q[n];if(typeof p.ui.checkbox!="undefined"){p.ui.checkbox.checked=p.ui.checkbox.defaultChecked=p.attributes.checked=r;(r)?p.select({internal:1,selModel:l}):p.unselect(1,{selModel:l});}}l.fireEvent("selectionchange",l,l.selNodes);k.stopPropagation();},clearActiveIndex:function(){var k=this.dataSource().findRuleOriginalLocation({identity:this.identity(),keyword:this.keyword(),rowIndex:this.activeIndex()});if(k.rowIndex>-1){this.activeIndex(k.rowIndex);}},clearSearch:function(k,n){var p=this.dataSource();if(this.count({masterListOnly:1})>p.pageSize()){this.clearActiveIndex();this.pageNum(this.masterListPageNum());this.masterListPageNum(1);this.searchEl.value=this.keyword("");this.renderSearch();return;}this.enableDD=true;this.searchEl.value="";if(this.enableDD){var m=this.root.childNodes||[];for(var l=0,o=m.length;l<o;l++){var q=m[l];if(q&&!q.isRoot&&!q.hidden){Ext.dd.Registry.register(q.ui.elNode,{node:q,handles:q.ui.getDDHandles(),isHandle:false});}}}this.filter.clear();if(this.stripeRows){this.__data__.total=0;this.root.fixStripes();}this.updateButtonOnClearSearch();return;},construct:function(l){l=l||{};l.data=l.data||[];var o=this.isSimpleTag();if(l.internal){this.constructNodes(ECM.Adapter.apply(l,{isSimpleTag:o}));}else{var p=l.data.slice(0);var n=this.constructRoot();for(var m=0,k=p.length;m<k;(o)?(m=m+2):m++){delete l.internal;if(o){this.constructNodes(ECM.Adapter.apply(l,{data:[p[m],p[m+1]],holder:n,isSimpleTag:o}));}else{this.constructNodes(ECM.Adapter.apply(l,{data:p[m],holder:n,isSimpleTag:o}));}}(this.innerCt)&&(this.renderRoot());this.expandAll();ECM.Adapter.select(".rules-row-description-col",false,this.el.dom).addClassOnOver("rules-row-description-col-mo");}},constructNode:function(n){n=n||{};var l=this;var q=this.dataSource();var p=this.renderMode();var m=q.rulesInfo({data:n.data,identity:this.identity(),isSimpleTag:n.isSimpleTag,key:n.key,pos:(n.position)?n.rowIndex:(n.holder.childNodes.length+1),renderMode:p,topLevel:n.holder.isRoot});(m.isDefault)&&(m.allowDrag=m.allowDrop=false);var o=new ECM.treegrid.TreeNode(m);(this.isStandard())&&(o.allowChildren=false);if(m.isDefault){delete o.attributes.allowDrag;delete o.attributes.allowDrop;}var k=false;(n.position)&&(k=this.findNodeByPath({parentNode:(this.isStandard())?this.root:this.root.childNodes[n.rowIndex],path:n.position}));(k)?n.holder.insertBefore(o,k):n.holder.appendChild(o);o.stripeIndex=this.__data__.total++;return o;},constructRoot:function(){return this.reconstructRoot();},constructTopLevel:function(k){(!this.isStandard())&&(this.__data__.total=-1);var l=this.constructNode(k);if(!this.isStandard()){this.__data__.total=0;this.constructMember(ECM.Adapter.apply(k,{holder:l,topLevel:1}));}},copyRule:function(){var t=this.getSelectionModel();var u=t.selNodes.slice(0);var p=u.length;if(p===1){var z=this.dataSource();var y=this.isSimpleTag();var D=z.pageSize();if(!y&&(this.count({masterListOnly:j.YES})+p)>D){this.perspective().notify.warn(ECM.Locale.fetch({key:"MAXED_OUT_COPY_RULES_IN_ADVANCED_MODE",params:[D]}));}else{this.perspective().loading().show();ECM.Subscribers.notify({topic:j.TOPIC.PRIORITY.ADJUSTED});this.__data__.copyCounter=0;var s={adjusted:[],first:null};var o=this.count({internal:j.YES,masterListOnly:j.YES});var E=this.identity();var A=this.pageNum();var m=(A-1)*D;var k=(o>=D);var w=this.root;var l=w.childNodes.length;var r=this;(w.childNodes[l-1].attributes.isDefault)&&(l--);u.sort(function(G,F){return(G.indexInParent()-F.indexInParent());});for(var x=0;x<p;x++){var v=u[x];if(!v){continue;}var q=v.indexInParent();if(q<D){q+=m;}var B={identity:E,pageNum:A,rowIndex:q};var n=l+x;if(s.adjusted[x]){B.pos=n;}z.content({id:E,rowIndex:q,callback:function(F){var J=z.copyRule(B);if(J){var H=r.constructNode({data:J.rules,holder:w,isSimpleTag:y,key:J.key,position:(r.pathSeparator+n),rowIndex:(n+1)});H.ui.checkbox.checked=H.ui.checkbox.defaultChecked=H.attributes.checked=true;H.select({internal:1,selModel:t});(!s.first)&&(s.first=H);r.__data__.copyCounter++;if(r.__data__.copyCounter===p){r.activeRule(s.first);for(var G=0;G<p;G++){var I=u[G];I.unselect(1,{internal:0,selModel:t});if(k&&(l+G)>=D){w.removeChild(w.childNodes[--l],1);s.adjusted[G]=true;}else{s.adjusted[G]=false;}}r.updateTotalRows();r.showPager(A);if(r.stripeRows){r.__data__.total=0;w.fixStripes();}r.resetMasterCheckbox();r.perspective().loading().hide();}}}});}}}},count:function(l){l=l||{};l.masterListOnly=!!l.masterListOnly;var k=this.keyword();if(k&&!l.masterListOnly){return this.dataSource().totalRules({identity:this.identity(),keyword:k});}if(l.internal||!this.__data__.count){this.__data__.count=this.dataSource().totalRules({identity:this.identity()});}return this.__data__.count;},deleteRule:function(){var y=this.getSelectionModel();var z=y.selNodes.slice(0);var t=z.length;if(t){this.perspective().loading().show();ECM.Subscribers.notify({topic:j.TOPIC.PRIORITY.ADJUSTED});var r=0;var F=this.activeIndex();var I={next:null};var K=this.dataSource();var Q=this.identity();var H=this.isSimpleTag();var N=this.keyword();var J=t-1;var L=this.pageNum();var M=K.pageSize();var w=((L-1)*M);var A=this.root;var s=A.childNodes.length;var G=(F>-1);var m=false;for(var E=0;E<t;E++){var u=z[E].indexInParent();if(u===F||(u==0&&F==-1)){m=true;}else{if(G&&u<F){r--;}}}for(var E=0;E<t;E++){var u=z[E].indexInParent();if(H&&N){var l=K.findRuleOriginalLocation({identity:Q,keyword:N,rowIndex:u});if(l.rowIndex>-1){u=l.rowIndex;}else{var x=this;K.priority({id:Q,pageNum:l.pageNum,callback:function(){x.deleteRule();return false;}});return false;}}if(u<M){u+=w;}var P=K.deleteRule({identity:Q,lastRemoved:(E===(t-1)),pageNum:L,rowIndex:u});(P)&&(A.removeChild(z[E],1));}var p=this.count({internal:j.YES,masterListOnly:j.YES});var x=this;var O=K.totalPages({force:j.YES,identity:Q,keyword:N});if(H&&t!==M&&L>O){var k=this.findAbsolutePage({dataSource:K,identity:Q,keyword:N,targetPage:O});L=this.pageNum(k.pageNum);K.priority({id:Q,keyword:N,pageNum:L,callback:function(R){x.updateTotalRows();x.showPage(L,{data:R.rules,key:R.key});x.resetMasterCheckbox();x.perspective().loading().hide();}});}else{if(H&&p>0&&(p>=M||L===O)){var k=this.findAbsolutePage({dataSource:K,identity:Q,keyword:N,targetPage:L});if(L===O&&(L===k.pageNum||t<(s-1))){this.deleteRuleCallback({adjustOpened:r,identity:Q,node:I.next,pageNum:L,root:A,wasOpened:m});}var v=A.childNodes.length;if(!v){u=0;}else{u=A.childNodes[v-1].indexInParent()+1;}if(L>1){if(u<M){u+=((L-1)*M);}}var B=k.adjustments;while(B>=M){B-=M;}var D=(L!==O)?(Math.min(t,M)-1):Math.min(J,(p%M)-1);var q=D-B;var n=k.pageNum;(t!==Math.min(s,M))&&(n++);(q<0||n>=O)&&(q=M);for(var E=0;E<t;E++){var o=u+E;if(o>=p){break;}K.targeting({currentIndex:E,currentPage:L,id:Q,keyword:N,pageNum:(E>q)?(n+1):n,rowIndex:o,callback:function(R){var S=x.constructNode({data:R.rule,holder:A,isSimpleTag:H,key:R.key});if(this.currentIndex===D){x.deleteRuleCallback({adjustOpened:r,identity:Q,node:I.next,pageNum:L,root:A,totalRemoved:t,wasOpened:m});}}});}}else{this.deleteRuleCallback({adjustOpened:r,identity:Q,node:I.next,pageNum:L,root:A,wasOpened:m});}}}},deleteRuleCallback:function(m){m=m||{};m.node=m.node||m.root.childNodes[j.DATA.FIRST];
var r=this.dataSource();var q=this.isSimpleTag();var l=this.keyword();var k=this;var p=r.totalPages({force:j.YES,identity:m.identity,keyword:l});if(q&&m.pageNum===p){var n=this.root.childNodes;if(n[n.length-1]&&!n[n.length-1].attributes.isDefault){var o=this.count({internal:j.YES,masterListOnly:j.YES});r.targeting({id:m.identity,keyword:this.keyword(),pageNum:m.pageNum,rowIndex:o,callback:function(s){var t=k.constructNode({data:s.rule,holder:k.root,isSimpleTag:q,key:s.key});}});}}if(m.wasOpened){this.activeRule(m.node,{afterRemoved:j.YES});this.perspective().loading().hide();}else{if(m.adjustOpened){ECM.Subscribers.notify({bundle:[{adjust:m.adjustOpened,identity:m.identity}],topic:j.TOPIC.PRIORITY.ADJUST_OPENED});this.perspective().loading().hide();}}if(!q&&this.isStandard()){this.updatePriorityNumber();}this.resetMasterCheckbox();this.updateTotalRows();this.showPager(m.pageNum);if(this.stripeRows){this.__data__.total=0;this.root.fixStripes();}window.setTimeout(function(){k.perspective().loading().hideAll();},1000);},deleteRules:function(r){if(r.isSimpleTag||r.wholeRow){var o=this.count({masterListOnly:j.YES});var k=this.dataSource();var p=this.keyword();var t=k.pageSize();while(r.rowIndex>=t){r.rowIndex-=t;}var u=this.root;var l=u.childNodes[r.rowIndex];var s=this.pageNum();var m=l.previousSibling;var n=k.totalPages({identity:r.identity,keyword:p});var q=(s!==n&&o>(s*t));u.removeChild(l,1);(!m)&&(m=u.childNodes[0]);if(!p){if(q){var v=this;k.targeting({id:r.identity,keyword:p,pageNum:s,rowIndex:r.rowIndex,callback:function(w){var y=v.constructNode({data:w.rule,holder:v.root,isSimpleTag:r.isSimpleTag,key:w.key});v.activeRule(y);var x=v.root.childNodes;n=k.totalPages({force:j.YES,identity:r.identity,keyword:p});if(s===n&&!x[x.length-1].attributes.isDefault){k.targeting({id:r.identity,keyword:p,pageNum:s,rowIndex:(r.rowIndex+1),callback:function(z){var A=v.constructNode({data:z.rule,holder:v.root,isSimpleTag:r.isSimpleTag,key:z.key});}});}}});}else{this.activeRule(m);}}else{this.activeRule(m);}this.updateTotalRows();this.showPager(s);if(this.stripeRows){this.__data__.total=0;this.root.fixStripes();}}else{if(this.isStandard()){this.updateRules(r);}else{var l=this.findNodeByPath({parentNode:this.root.childNodes[r.rowIndex],path:r.indexPath});l.parentNode.removeChild(l,1);}}},dragConfig:{ddGroup:"PriorityDD"},dropConfig:{allowContainerDrop:false,appendOnly:false,ddGroup:"PriorityDD"},findAbsolutePage:function(l){l=l||{};l.dataSource=l.dataSource||this.dataSource();l.identity=l.identity||this.identity();l.keyword=l.keyword||this.keyword();l.pageNum=String.toInt(l.pageNum)||this.pageNum();l.targetPage=String.toInt(l.targetPage||0);var k={isAdjusted:false,pageNum:0};k.adjustments=l.dataSource.adjustment({identity:l.identity,keyword:l.keyword,pageNum:l.targetPage});if(k.adjustments<0){k.adjustments*=-1;}k.pageNum=String.toInt(k.adjustments/l.dataSource.pageSize());k.isAdjusted=(k.pageNum>0);k.pageNum+=l.targetPage;return k;},initEvents:function(){ECM.Rules.Priority.superclass.initEvents.call(this);this.delayTask=new Ext.util.DelayedTask();this.mon(this,"expand",this.maximizeView);this.mon(this,"nodedragover",this.onNodeDragOver,this);var k=this;var l=k.perspective().loading();this.subs.push(ECM.Subscribers.subscribe({topic:j.TOPIC.LOADING.HIDE,subscriber:new ECM.Subscriber({notify:ECM.hitch(l,l.hide)})}));this.subs.push(ECM.Subscribers.subscribe({topic:j.TOPIC.LOADING.HIDE_ALL,subscriber:new ECM.Subscriber({notify:ECM.hitch(l,l.hideAll)})}));this.subs.push(ECM.Subscribers.subscribe({topic:j.TOPIC.LOADING.SHOW,subscriber:new ECM.Subscriber({notify:ECM.hitch(l,l.show)})}));this.subs.push(ECM.Subscribers.subscribe({topic:j.TOPIC.NOTIFY.CLEAR,subscriber:new ECM.Subscriber({notify:ECM.hitch(k.perspective().notify,k.perspective().notify.clear)})}));this.subs.push(ECM.Subscribers.subscribe({topic:j.TOPIC.NOTIFY.ERROR,subscriber:new ECM.Subscriber({notify:ECM.hitch(k.perspective().notify,k.perspective().notify.error)})}));this.subs.push(ECM.Subscribers.subscribe({topic:j.TOPIC.NOTIFY.INFO,subscriber:new ECM.Subscriber({notify:ECM.hitch(k.perspective().notify,k.perspective().notify.info)})}));this.subs.push(ECM.Subscribers.subscribe({topic:j.TOPIC.NOTIFY.WARN,subscriber:new ECM.Subscriber({notify:ECM.hitch(k.perspective().notify,k.perspective().notify.warn)})}));this.subs.push(ECM.Subscribers.subscribe({topic:j.TOPIC.PRIORITY.NAME.CHANGE,subscriber:new ECM.Subscriber({notify:ECM.hitch(k,k.updateName)})}));this.subs.push(ECM.Subscribers.subscribe({topic:j.TOPIC.PRIORITY.DESCRIPTION.CHANGE,subscriber:new ECM.Subscriber({notify:ECM.hitch(k,k.updateDescription)})}));this.subs.push(ECM.Subscribers.subscribe({topic:j.TOPIC.PRIORITY.LIBRARY_TAGS.CHANGE,subscriber:new ECM.Subscriber({notify:ECM.hitch(k,k.updateLibraryTags)})}));this.subs.push(ECM.Subscribers.subscribe({topic:j.TOPIC.TAG.CONVERTED,subscriber:new ECM.Subscriber({notify:ECM.hitch(k,k.onTagConverted)})}));this.subs.push(ECM.Subscribers.subscribe({topic:j.TOPIC.TARGETING.ACTIVE,subscriber:new ECM.Subscriber({notify:ECM.hitch(k,k.minimizeView)})}));this.subs.push(ECM.Subscribers.subscribe({topic:j.TOPIC.TARGETING.KEY.CHANGE,subscriber:new ECM.Subscriber({notify:ECM.hitch(k,k.updateKeyLabel)})}));this.subs.push(ECM.Subscribers.subscribe({topic:j.TOPIC.TARGETING.LABEL.CHANGE,subscriber:new ECM.Subscriber({notify:ECM.hitch(k,k.updateRulesLabel)})}));this.subs.push(ECM.Subscribers.subscribe({topic:j.TOPIC.TARGETING.RULE.ADD,subscriber:new ECM.Subscriber({notify:ECM.hitch(k,k.addRules)})}));this.subs.push(ECM.Subscribers.subscribe({topic:j.TOPIC.TARGETING.RULE.BEFORE_MOVE,subscriber:new ECM.Subscriber({notify:ECM.hitch(k,k.beforeMoveRules)})}));this.subs.push(ECM.Subscribers.subscribe({topic:j.TOPIC.TARGETING.RULE.CHANGE,subscriber:new ECM.Subscriber({notify:ECM.hitch(k,k.updateRules)})}));this.subs.push(ECM.Subscribers.subscribe({topic:j.TOPIC.TARGETING.RULE.DELETE,subscriber:new ECM.Subscriber({notify:ECM.hitch(k,k.deleteRules)})}));this.subs.push(ECM.Subscribers.subscribe({topic:j.TOPIC.TARGETING.RULE.MOVE,subscriber:new ECM.Subscriber({notify:ECM.hitch(k,k.moveRules)})}));},keyword:function(k){(ECM.Adapter.isEffective(k))&&(this.__data__.keyword=k);return this.__data__.keyword||"";},masterListPageNum:function(k){(ECM.Adapter.isEffective(k))&&(this.__data__.masterListPageNum=k);return this.__data__.masterListPageNum||1;},maximizeView:function(){this.resizeView("max");},minimizeView:function(){this.resizeView("min");},moveRules:function(l){if(!this.isStandard()){l=l||{};var k=((l.indexPath||"").split(l.separator)||[]);k.pop();k=k.join(l.separator);l.holder=this.findNodeByPath({parentNode:this.root.childNodes[l.rowIndex],path:k});l.position=l.indexPath;}this.addRules(l);if(this.isStandard()){this.updatePriorityNumber();}else{if(!this.isStandard()&&this.stripeRows){var m=this.root.childNodes[l.rowIndex];this.__data__.total=0;m.fixStripes();}}},onDestroy:function(){var k=this;ECM.Rules.Tablespace.truncate({id:k.identity(),structOnly:true});ECM.Rules.Priority.superclass.onDestroy.apply(k,arguments);k.delayTask=k.filter=k.filter.tree=null;},onNodeDragOver:function(k){return !(k.point==="below"&&k.target.attributes.isDefault);},onPagerClick:function(s,l){this.perspective().loading().show();ECM.Subscribers.notify({topic:j.TOPIC.PRIORITY.ADJUSTED});var k=this.dataSource();var o=this.identity();var n=this.keyword();var u=String.toInt(l.getAttribute("value"));var p=this.findAbsolutePage({dataSource:k,identity:o,keyword:n,targetPage:u});this.resetMasterCheckbox();var t=this;function q(v){v=v||{};v.callback=v.callback||function(){};v.pageNum=v.pageNum||1;v.targetPage=v.targetPage||v.pageNum;k.priority({id:o,keyword:n,pageNum:v.pageNum,callback:function(w){k.priority({id:o,keyword:n,pageNum:v.targetPage,callback:v.callback});}});}function r(v){t.updateTotalRows();t.showPage(p.pageNum,{data:v.rules,key:v.key});t.updateSelectedRow();t.perspective().loading().hide();}function m(){var w=k.rePage({identity:o,keyword:n,pageNum:u});function v(x){t.updateTotalRows();
t.showPage(u,{data:x.rules,key:x.key});t.updateSelectedRow();k.unPage({identity:o,keyword:n,pageNum:u,value:w});t.perspective().loading().hide();}if(p.adjustments>0){q({callback:v,pageNum:(p.pageNum+1),targetPage:u});}else{k.priority({id:o,keyword:n,pageNum:u,callback:v});}}k.priority({currentPage:(u<p.pageNum)?u:undefined,id:o,keyword:n,pageNum:p.pageNum,callback:function(v){if(p.isAdjusted){m();}else{if(p.adjustments>0){q({callback:r,pageNum:(p.pageNum+1),targetPage:p.pageNum});}else{r(v);}}}});return false;},onRender:function(){ECM.Rules.Priority.superclass.onRender.apply(this,arguments);this.el.addClass("ecm-rules-priority");},onSelectionChange:function(l,k){this.updateButtonOnSelectionChanged();},pageNum:function(k){(ECM.Adapter.isEffective(k))&&(this.__data__.pageNum=k);return this.__data__.pageNum||1;},redraw:function(m){m=m||{};var l=m.self||this;var k=l.isStandard();if(k){l.enableDD=!m.isSimpleTag;l.setTopbar(h[m.renderMode]);if(l.innerHd){l.mun(ECM.Adapter.fly(Ext.DomQuery.select(".checkbox-toggler",l.innerHd.dom)[0]),"click",l.checkboxToggle,l);var o=Ext.DomQuery.select(".description-search",l.innerHd.dom)[0];l.mun(ECM.Adapter.fly(o),"keydown",l.searchDelay,l);l.mun(ECM.Adapter.fly(Ext.DomQuery.select(".clear-trigger",l.innerHd.dom)[0]),"click",l.clearSearch,ECM.Adapter.apply({searchEl:o},l));}(l.filter)&&(l.filter=l.filter.filtered=l.filter.tree=null);if(m.isSimpleTag){var n=c[m.renderMode].slice(0);Array.removeAt(n,j.COLUMN.STANDARD.PRIORITY.ORDER);Array.removeAt(n,j.COLUMN.STANDARD.PRIORITY.DRAG_HANDLE);l.setColumns(n);}else{l.setColumns(c[m.renderMode]);}l.el.removeClass("ecm-rules-priority-all").addClass("ecm-rules-priority-standard");l.filter=new Ext.tree.TreeFilter(l);l.mon(ECM.Adapter.fly(Ext.DomQuery.select(".checkbox-toggler",l.innerHd.dom)[0]),"click",l.checkboxToggle,l);var o=Ext.DomQuery.select(".description-search",l.innerHd.dom)[0];o.value=l.keyword();l.mon(ECM.Adapter.fly(o),"keydown",l.searchDelay,l);l.mon(ECM.Adapter.fly(Ext.DomQuery.select(".clear-trigger",l.innerHd.dom)[0]),"click",l.clearSearch,ECM.Adapter.apply({searchEl:o},l));if(l.keyword()){this.updateButtonOnSearch();l.el.addClass("ecm-rules-priority-search");var p=Ext.DomQuery.select(".clear-trigger",this.innerHd.dom)[0];if(p){ECM.Adapter.fly(p).addClass("loading-trigger");}}else{this.updateButtonOnClearSearch();l.el.removeClass("ecm-rules-priority-search");}}else{l.enableDD=false;l.setTopbar(h[m.renderMode+((m.isSimpleTag)?"Simple":"")]);l.setColumns(c[m.renderMode]);l.el.removeClass("ecm-rules-priority-standard").addClass("ecm-rules-priority-all");}},renderAll:function(){var k=this;if(!k.isStandard()){return false;}k.perspective().loading().show();var l=k.isSimpleTag();var m=k.renderMode("all");k.redraw({isSimpleTag:l,renderMode:m,self:k});this.__data__.total=0;k.dataSource().priority({id:k.identity(),keyword:k.keyword(),pageNum:k.pageNum()||1,callback:function(n){k.updateTotalRows();if(l){k.showPage(k.pageNum()||1,{data:n.rules,key:n.key});}else{k.construct({data:n.rules,key:n.key});}k.maximizeView();k.perspective().loading().hide();}});this.fireEvent("renderall",this);},renderSearch:function(){this.renderMode("search");this.renderStandard();this.fireEvent("rendersearch",this);},renderStandard:function(){var l=this;var m=(l.renderMode()==="none");if(l.isStandard()){return false;}l.perspective().loading().show();var n=l.isSimpleTag();var k=ECM.Adapter.isEffective(l.__data__.bindIndex);l.__data__.count=l.dataSource().totalRules({identity:l.identity()});var o=l.renderMode("standard");l.redraw({isSimpleTag:n,renderMode:o,self:l});this.__data__.total=0;l.tagType(l.__data__.tagType);l.dataSource().priority({id:l.identity(),keyword:l.keyword(),pageNum:l.pageNum()||1,callback:function(p){var r=(p.tagType===j.TAG.SIMPLE);if(n!==r){l.tagType(p.tagType);n=r;l.redraw({isSimpleTag:n,renderMode:o,self:l});}ECM.Subscribers.notify({bundle:[p.name],topic:j.TOPIC.PRIORITY.NAME.CONSTRUCT});ECM.Subscribers.notify({bundle:[p.description],topic:j.TOPIC.PRIORITY.DESCRIPTION.CONSTRUCT});ECM.Subscribers.notify({bundle:[p.tags],topic:j.TOPIC.PRIORITY.LIBRARY_TAGS.CONSTRUCT});l.__data__.waitTime=(l.count({masterListOnly:1})>l.dataSource().pageSize())?500:0;l.updateTotalRows();if(n){l.showPage(l.pageNum()||1,{data:p.rules,key:p.key});ECM.Subscribers.notify({topic:j.TOPIC.BUTTONS.VIEW_DETAILS.HIDE});}else{l.construct({data:p.rules,key:p.key});ECM.Subscribers.notify({topic:j.TOPIC.BUTTONS.VIEW_DETAILS.SHOW});}l.updateSelectedRow();window.setTimeout(function(){if(l.__data__.count===0){k=j.YES;l.activeRule(l.root.childNodes[j.DATA.FIRST]);}if(Ext.isIE){l.ownerCt.setWidth(l.ownerCt.getWidth()-1);}},10);l.perspective().loading().hide();var q=Ext.DomQuery.select(".clear-trigger",l.innerHd.dom)[0];if(q){ECM.Adapter.fly(q).removeClass("loading-trigger");}}});this.fireEvent("renderstandard",this);},resetMasterCheckbox:function(){var k=Ext.DomQuery.select(".checkbox-toggler",this.innerHd.dom)[0];(k)&&(k.checked=false);},resizeView:function(n){n=n||"max";var k=145;if(!this.__data__.container){var m=this.perspective();this.__data__.container=m.items.itemAt(j.LAYOUT.CONTAINER);this.__data__.headerHeight=m.items.itemAt(j.LAYOUT.HEADER).getHeight();this.__data__.splitHeight=this.__data__.container.getLayout().north.getSplitBar().el.getHeight();}var o=this.getHeight();var l=this.__data__.perspective.getInnerHeight();l-=this.__data__.headerHeight;l-=this.__data__.splitHeight;if(this.collapsed){this.expand();}if(n==="max"){k=l;}else{if(o<l&&o>k){k=o;}}this.setHeight(k);this.__data__.container.doLayout();},search:function(o,q,k){var m=q.value+"";if(this.count({masterListOnly:1})>this.dataSource().pageSize()&&m!==this.keyword()){if(!m){this.clearActiveIndex();this.pageNum(this.masterListPageNum());this.masterListPageNum(1);}else{this.masterListPageNum(this.pageNum());this.pageNum(1);}this.keyword(m);this.renderSearch();return;}if(!m){return this.clearSearch.call(ECM.Adapter.apply({searchEl:q},this),k,null);}this.updateButtonOnSearch();this.enableDD=false;this.expandAll();var p=new RegExp(ECM.Adapter.escapeRe(m),"i");var l=this;var n=0;this.filter.filterBy(function(s){var r=p.test(s.attributes[o]);if(r){Ext.dd.Registry.unregister(s.ui.elNode.id);if(l.stripeRows){s.fixStripe(n++);}}return r;});},searchDelay:function(){if(this.__data__.waitTime){var k=Ext.DomQuery.select(".clear-trigger",this.innerHd.dom)[0];if(k){ECM.Adapter.fly(k).addClass("loading-trigger");}}this.delayTask.delay(this.__data__.waitTime,this.searchDescription,this,arguments);},searchDescription:function(k,l){this.search.call(this,"description",l,k);},showPage:function(m,k){(!k)&&(this.perspective().loading().show());this.showPager(m);m=this.pageNum();if(k){this.construct(k);}else{var l=this;l.__data__.total=0;l.dataSource().priority({id:l.identity(),pageNum:m,keyword:l.keyword(),callback:function(n){l.updateTotalRows();l.showPager(m);l.construct({data:n.rules,key:n.key});l.activeRule(l.root.childNodes[0]);l.perspective().loading().hide();}});}},showPager:function(r){var v=this;r=String.toInt(r)||1;(r<1)&&(r=1);var n=ECM.Rules.Tablespace.paging({identity:v.identity(),keyword:v.keyword(),pageNum:r});if(n){(r>n.totalPages)&&(r=n.totalPages);v.pageNum(r);if(n.totalPages>1){var l=[ECM.Locale.fetch({key:"DISPLAYING"}),": "];for(var o=0,t=n.pages.length;o<t;o++){var q=n.pages[o];var p=n.ranges[o];var s=q[j.PAGE.NUMBER];if(s===r){l.push('<font class="ecm-page-active" title="');l.push(p[j.PAGE.RANGE_START]+" - ");l.push(p[j.PAGE.RANGE_END]+'">');l.push(q[j.PAGE.ITEM_START]+"-");l.push(q[j.PAGE.ITEM_END]+"</font> ");}else{l.push('<a class="ecm-pager" href="#'+s);l.push('" value="'+s+'" title="');l.push(p[j.PAGE.RANGE_START]+" - ");l.push(p[j.PAGE.RANGE_END]+'">');l.push(q[j.PAGE.ITEM_START]+"-");l.push(q[j.PAGE.ITEM_END]+"</a> ");}}var u=this.topToolbar.el.dom;var m=Ext.DomQuery.select(".ecm-pager",u);for(var o=0,k=m.length;o<k;o++){this.mun(ECM.Adapter.fly(m[o]),"click",this.onPagerClick,this);}this.topToolbar.items.itemAt(j.TOOLBAR.PRIORITY.PAGER).setText(l.join(""));
m=Ext.DomQuery.select(".ecm-pager",u);for(var o=0,k=m.length;o<k;o++){this.mon(ECM.Adapter.fly(m[o]),"click",this.onPagerClick,this);}}else{this.topToolbar.items.itemAt(j.TOOLBAR.PRIORITY.PAGER).setText("");}}},toString:function(){return"["+this.xtype+(this.id?" "+this.id:"")+"]";},updateButton:function(k){var o=this.topToolbar.items.itemAt.createDelegate(this.topToolbar.items);var m=o(j.TOOLBAR.PRIORITY.ADD).menu.items.itemAt.createDelegate(o(j.TOOLBAR.PRIORITY.ADD).menu.items);switch(k){case"clear":if(this.isStandard()){o(j.TOOLBAR.PRIORITY.ADD).enable();}case"changed":if(this.isStandard()){var l=this.getSelectionModel();var n=l.selNodes.length;if(n){if(k==="clear"||(k==="changed"&&!this.keyword())){m(j.TOOLBAR.PRIORITY.COPY)[(n===1)?"enable":"disable"]();}m(j.TOOLBAR.PRIORITY.DELETE).enable();}else{m(j.TOOLBAR.PRIORITY.COPY).disable();m(j.TOOLBAR.PRIORITY.DELETE).disable();}}break;case"search":default:m(j.TOOLBAR.PRIORITY.COPY).disable();o(j.TOOLBAR.PRIORITY.ADD).disable();m(j.TOOLBAR.PRIORITY.DELETE).disable();break;}},updateButtonOnClearSearch:function(){this.updateButton("clear");},updateButtonOnSearch:function(){this.updateButton("search");},updateButtonOnSelectionChanged:function(){this.updateButton("changed");},updateDescription:function(k){this.dataSource().updateDescription(k);},updateLibraryTags:function(k){this.dataSource().updateLibraryTags(k);},updateKeyLabel:function(r){var u=this.renderMode();var m=this.dataSource().updateKeyLabel(ECM.Adapter.apply(r,{renderMode:"standard"}));if(ECM.Adapter.isEffective(m)){var k=this.root.childNodes;var v=new RegExp("^.*?"+m.operatorLabel,"ig");var l;if(this.isStandard()){var n={RULES:((this.isSimpleTag())?2:4)};for(var o=0,p=k.length;o<p;o++){l=k[o];if(!l.attributes.isDefault){var t=l.attributes.rules;t=t.replace(v,m.keyLabel+" "+m.operatorLabel);l.attributes.rules=l.attributes.rulesQtip=t;var w=l.ui.elNode;w.childNodes[n.RULES].firstChild.innerHTML=t;w.childNodes[n.RULES].firstChild.setAttribute("ext:qtip",t);}}}else{var q=ECM.Locale.fetch({key:"DEFAULT"}).toLowerCase();for(var o=1,p=k.length;o<p;o++){l=k[o].childNodes[j.DATA.FIRST];var s=l.attributes.all;if(s.toLowerCase()!==q){s=s.replace(v,m.keyLabel+" "+m.operatorLabel);l.attributes.all=s;l.ui.onTextChange(null,s);}}}}},updateName:function(k){this.dataSource().updateName(k);},updatePriorityNumber:function(){if(!this.isSimpleTag()){var l=this.root.childNodes;for(var k=0,o=l.length;k<o;k++){var m=l[k];if(m&&!m.attributes.isDefault){m.attributes.priority=(k+1);var n={PRIORITY:2};var p=m.ui.elNode;p.childNodes[n.PRIORITY].firstChild.innerHTML=m.attributes.priority;}}}},updateRules:function(q){var k=this.dataSource();var u=this.renderMode();var m=k.updateRules(ECM.Adapter.apply(q,{renderMode:u}));if(!Object.isEmpty(m)){var p=this.isSimpleTag();var o=this.keyword();var r=k.pageSize();var s=q.rowIndex;if(p&&o){var t=k.findRuleSearchLocation({identity:this.identity(),keyword:o,rowIndex:s});if(t.rowIndex>-1){s=t.rowIndex;}else{return false;}}while(s>=r){s-=r;}var l;if(this.isStandard()){l=this.findNodeByPath({path:"/"+s});ECM.Adapter.apply(l.attributes,m);var n={DESCRIPTION:((this.isSimpleTag())?1:3),RULES:((this.isSimpleTag())?2:4)};var v=l.ui.elNode;v.childNodes[n.DESCRIPTION].firstChild.innerHTML=m.description;v.childNodes[n.RULES].firstChild.innerHTML=ECM.DomHelper.ellipsis({cls:"ecm-priority-ellipsis",text:m.rulesQtip,width:v.childNodes[n.RULES].firstChild.clientWidth-20}).text;v.childNodes[n.RULES].firstChild.setAttribute("ext:qtip",m.rulesQtip);}else{l=this.findNodeByPath({parentNode:this.root.childNodes[s],path:q.indexPath});ECM.Adapter.apply(l.attributes,m);l.ui.onTextChange(null,l.attributes[u]);}}},updateRulesLabel:function(q){var k=this.dataSource();var u=this.renderMode();var m=k.updateRulesLabel(q);if(ECM.Adapter.isEffective(m)){var p=this.isSimpleTag();var o=this.keyword();var r=k.pageSize();var s=q.rowIndex;if(p&&o){var t=k.findRuleSearchLocation({identity:this.identity(),keyword:o,rowIndex:s});if(t.rowIndex>-1){s=t.rowIndex;}else{return false;}}while(s>=r){s-=r;}var l=this.findNodeByPath({path:"/"+s});if(this.isStandard()){ECM.Adapter.apply(l.attributes,{description:m});var n={DESCRIPTION:((p)?1:3)};var v=l.ui.elNode;v.childNodes[n.DESCRIPTION].firstChild.innerHTML=m;}else{ECM.Adapter.apply(l.attributes,{all:((p)?"":s+". ")+m});l.ui.onTextChange(null,l.attributes[u]);}}},updateSelectedRow:function(){var v=this.activeIndex();var l=this.root.childNodes;var k=this.dataSource();var u=false;var o=this.keyword();var p=l.length;var q=this.pageNum();var r=k.pageSize();var t=this;function m(){if(p>0){t.activeRule(l[j.DATA.FIRST]);}u=true;}if(v>-1){if(o){var s=k.findRuleSearchLocation({hideWarning:j.YES,identity:this.identity(),keyword:o,rowIndex:v});if(s.rowIndex>-1){v=this.activeIndex(s.rowIndex);}else{m();}}else{if(this.isSimpleTag()&&this.previousRowIndex===v){m();}}if(!u){while(v>=r){v-=r;}for(var n=0;n<p;n++){if(n===v){l[n].ui.addClass("ecm-selected-row");break;}}}}else{if(q>1||o){m();}}},updateTotalRows:function(){var k=this.count({internal:j.YES});var l=ECM.hitch(this.topToolbar.items,this.topToolbar.items.itemAt);l(j.TOOLBAR.PRIORITY.LABEL).setText((k>1)?(ECM.Locale.fetch({key:"TOTAL_RULES"})+":"):(ECM.Locale.fetch({key:"TOTAL_RULE"})+":"));l(j.TOOLBAR.PRIORITY.TOTAL).setText(String(k));return k;}});ECM.Adapter.override(Ext.tree.TreeFilter,{autoClear:true,clearBlank:true});ECM.Adapter.register("ECM.Rules.Priority",ECM.Rules.Priority);ECM.Adapter.onUnload(function(){d=h=c=null;});})();ECM.provide("ECM.util.BracketRacket");ECM.util.BracketRacket={toDropNode:function(b){b=Ext.decode(Ext.encode(b));if(Ext.isString(b.data)){b.data=Ext.decode(b.data);}var a=[];Ext.each(b.data,function(c){a.push({data:c});},this);return Ext.apply(b,{data:a});}};ECM.provide("ECM.Targeting.Util.Grain");(function(){ECM.Targeting.Util.Grain={ACTIVITY:"Activity",SUBSCRIBER:"Subscriber",MESSAGE:"Message",TRANSACTION:"Transaction",TRANSACTION_DETAIL:"Transaction Detail"};var d=ECM.Targeting.Util.Grain;var c={"(145)":d.SUBSCRIBER,_:d.SUBSCRIBER,A:d.SUBSCRIBER,B:d.ACTIVITY,C:d.ACTIVITY,D:d.SUBSCRIBER,E:d.SUBSCRIBER,I:d.SUBSCRIBER,L:d.SUBSCRIBER,O:d.ACTIVITY,R:d.ACTIVITY,S:d.MESSAGE,T:d.TRANSACTION};var b={SUBSCRIBER:{accepts:[d.ACTIVITY,d.MESSAGE,d.TRANSACTION],matchOn:"Grain"},MESSAGE:{accepts:[d.ACTIVITY,d.TRANSACTION],matchOn:"Table"},ACTIVITY:{accepts:[],matchOn:"Table"},TRANSACTION:{accepts:[d.TRANSACTION_DETAIL],matchOn:"Table"}};var a={};Ext.iterate(b,function(f,g){a[ECM.Targeting.Util.Grain[f]]=g;});b=a;Ext.apply(ECM.Targeting.Util.Grain,{getGrainFromTable:function(f){return c[f];},getAllTables:function(){var f=[];Ext.iterate(c,function(g){f.push(g);});return f;},isCompatibleGrain:function(g,f){return b[f].accepts.indexOf(g)>-1;},isCompatibleTable:function(k,g,j,f){if(k==="*"){return true;}var l=d.getGrainFromTable(k)||d.SUBSCRIBER;j=j||d.getGrainFromTable(g);var h=false;if(!f){if(b[l].matchOn==="Grain"){h=l===j;}else{h=k===g;}}return d.isCompatibleGrain(l,j)||h;},getCompatibleTables:function(f,h,g){var j=[];Ext.iterate(c,function(k){var l=g&&b[h].matchOn==="Grain";if(d.isCompatibleTable(k,f,h,l)){j.push(k);}});return j;}});})();ECM.provide("ECM.SessionLog");ECM.SessionLog.sessionLog=function(a,b){ECM.Ajax.request({url:"/cm/r/session_log",method:"POST",params:{log_id:a,params:b},failure:function(c){var d=c.responseJSON.error.join("; ");ECM.publish("/notify/error",{selector:".error_display",message:gt.gettext("Could not log session: ")+d});}});};ECM.provide("ECM.Rules.Shelf");(function(){var a=ECM.Rules.Constants;ECM.Rules.Shelf=function(b){b=b||{};b.change=b.change||{bundle:function(){},topic:""};b.construct=b.construct||{topic:""};b.identity=b.identity||"";b.maxLength=b.maxLength||100;b.rowIndex=(ECM.Adapter.isEffective(b.rowIndex))?b.rowIndex:-1;b.autoCreate=b.autoCreate||{tag:"input",type:"text",size:"30",autocomplete:"off",maxlength:b.maxLength},this.__data__={change:b.change,construct:b.construct,identity:b.identity,rowIndex:b.rowIndex};delete b.change;delete b.construct;
delete b.identity;delete b.rowIndex;ECM.Rules.Shelf.superclass.constructor.call(this,b);};ECM.Adapter.extend(ECM.Rules.Shelf,Ext.form.TextField,{allowBlank:false,enableKeyEvents:true,identity:function(b){if(ECM.Adapter.isEffective(b)){this.__data__.identity=b;}return this.__data__.identity||"";},initEvents:function(){ECM.Rules.Shelf.superclass.initEvents.call(this);this.subs=this.subs||[];this.subscribeToConstruct(this.__data__.construct);},onDestroy:function(){ECM.Rules.Shelf.superclass.onDestroy.call(this);ECM.Adapter.each(this.subs,function(b){ECM.Subscribers.unsubscribe({topic:b.data.topic_,subscriber:b});});this.__data__=this.autoCreate=this.autoEl=this.container=this.defaultAutoCreate=this.el=this.filterOptRe=this.initialConfig=this.lastSize=this.subs=null;},onKeyUp:function(c){var d=this;var f=d.__data__.change;if(f&&ECM.Adapter.isString(f.topic)&&f.topic){var b=f.bundle.apply(d)||{};ECM.Subscribers.notify({bundle:[ECM.Adapter.apply(b,{value:d.getValue()})],topic:f.topic});}this.fireEvent("keyup",this,c);},onPriorityMoved:function(b){var c=ECM.Rules.Tablespace.lastIndexFromPath({path:b.indexPath,separator:b.separator});this.rowIndex(c);},resetState:function(b){b=b||{};b.identity=b.identity||"";b.rowIndex=(ECM.Adapter.isEffective(b.rowIndex))?b.rowIndex:-1;this.__data__.identity=b.identity;this.__data__.rowIndex=b.rowIndex;},rowIndex:function(b){if(ECM.Adapter.isEffective(b)){this.__data__.rowIndex=b;}return(ECM.Adapter.isEffective(this.__data__.rowIndex))?this.__data__.rowIndex:-1;},subscribeToConstruct:function(b){if(b&&ECM.Adapter.isString(b.topic)&&b.topic){this.subs.push(ECM.Subscribers.subscribe({topic:b.topic,subscriber:new ECM.Subscriber({notify:ECM.hitch(this,function(c){if(c!=""){this.setValue(c);}})})}));}},subscribeToPriorityMoved:function(){this.subs=this.subs||[];this.subs.push(ECM.Subscribers.subscribe({topic:a.TOPIC.PRIORITY.MOVED,subscriber:new ECM.Subscriber({notify:ECM.hitch(this,this.onPriorityMoved)})}));return this;},toString:function(){return"["+this.xtype+(this.id?" "+this.id:"")+"]";}});ECM.Adapter.register("ECM.Rules.Shelf",ECM.Rules.Shelf);})();if(!ECM.Adapter.namespace("ECM.Rules.DynamicContent")._bogus){ECM.provide("ECM.Rules.DynamicContent");if(!window.ecmTargetingModeOn){ECM.modifyFlags({base:{js:"/jsbackback/",css:"/css/"}});}ECM.modifyFlags({base:{js:"/js/",css:"/css/"}});(function(){var a={};var c=ECM.Rules.Constants;var b=ECM.Rules.Tablespace;ECM.Rules.DynamicContent=(function(){var f=new ECM.Window.AttachTagsModal({reloadCombo:true});function g(r){r=r||{};var t=ECM.Rules.DynamicContent.layout({id:r.identity});var q=t.targeting.rowIndex();var s=q+r.adjust;t.shelves[c.SHELVES.EDITING].rowIndex(s);t.targeting.rowIndex(s);t.content.rowIndex(s,c.YES);}function n(){var r=this;var t=b.otherIdentities(r.id);var v={};if(t.onClose){v=b.closeParams(r.id);}var q=d({callback:function(y){if(y==="no"){if(t.onClose){t.onClose(v);}var x=ECM.Rules.Tablespace.ascendants({identity:r.id});if(ECM.Adapter.isArray(x)&&x.length>0){var B=x.pop();var A=ECM.Adapter.apply({newIdentity:B},t);ECM.Rules.DynamicContent.changeTag(A);return false;}var z=ECM.Rules.DynamicContent.layout({id:r.id}).perspective;(z.hidden)?z.doClose():z.hide(null,z.doClose,z);}else{if(y==="yes"){ECM.Subscribers.notify({topic:c.TOPIC.TAG.SAVE});b.save({identity:r.id});}}},id:r.id});if(q){if(t.onClose){t.onClose(v);}var s=ECM.Rules.Tablespace.ascendants({identity:r.id});if(ECM.Adapter.isArray(s)&&s.length>0){var w=s.pop();var u=ECM.Adapter.apply({newIdentity:w},t);ECM.Rules.DynamicContent.changeTag(u);return false;}}return q;}function m(x){x=x||{};var y=ECM.Rules.DynamicContent.layout({id:x.identity});var t=y.tabPanel.items.itemAt(c.LAYOUT.CONTENT);var r=x.node;var q=y.targeting;var w=y.tabPanel.items.itemAt(c.LAYOUT.TARGETING);var s=t.__data__.pending;var v=q.rowIndex();var u=x.bundle;t.__data__.pending=true;if(r.attributes.isDefault){w.disable();y.tabPanel.setActiveTab(t);}else{w.enable();y.tabPanel.setActiveTab(w);}t.__data__.pending=s;if(x.bundle.standard){var z=q.renderMode("standard");q.redraw({isSimpleTag:q.isSimpleTag(),renderMode:z,self:q});q=y.targeting;q.__data__.total=0;}if(y.tabPanel.activeTab instanceof ECM.Rules.Content){x.tree.dataSource().targetingAndContent({id:x.identity,rowIndex:x.rowIndex,callback:function(A){y.shelves[c.SHELVES.EDITING].rowIndex(x.rowIndex);if(q.renderMode()==="segment"){A.rule=q.segmentTopLevel(A);}q.construct({data:A.rule,key:A.key,rowIndex:x.rowIndex,tagType:A.tagType});if(x.tree.activeIndex()>0){x.tree.minimizeView();}if(!(x.bundle.force&&(x.bundle.afterRemoved||v===x.rowIndex))){y.content.applyChanges();}y.content.updateEditor({data:A.content,rowIndex:x.rowIndex});ECM.Subscribers.notify({topic:c.TOPIC.LOADING.HIDE});}});}else{x.tree.dataSource().targeting({id:x.identity,rowIndex:x.rowIndex,callback:function(A){y.shelves[c.SHELVES.EDITING].rowIndex(x.rowIndex);if(q.renderMode()==="segment"){A.rule=q.segmentTopLevel(A);}q.construct({data:A.rule,key:A.key,rowIndex:x.rowIndex,tagType:A.tagType,fresh:x.bundle.fresh});if(x.tree.activeIndex()>0){x.tree.minimizeView();}if(!(x.bundle.force&&(x.bundle.afterRemoved||v===x.rowIndex))){y.content.applyChanges();}y.content.rowIndex(x.rowIndex);q.columnsAutoFit();ECM.Subscribers.notify({topic:c.TOPIC.LOADING.HIDE});}});}ECM.Adapter.select(".ecm-selected-row",false,x.tree.el.dom).removeClass("ecm-selected-row");if(r&&r.ui){r.ui.addClass("ecm-selected-row");}}function k(v,t,s){var q=v.ownerTree;var u=q.identity();var w=q.__data__.bindIndex=v.topLevelIndex();q.activeIndex(w);w+=((q.pageNum()-1)*q.dataSource().pageSize());if(q.keyword()){var r=q.dataSource().findRuleOriginalLocation({identity:u,keyword:q.keyword(),rowIndex:w});if(r.rowIndex>-1){q.masterListPageNum(r.pageNum);m({bundle:s,identity:u,node:v,rowIndex:r.rowIndex,tree:q});}else{q.dataSource().priority({id:u,pageNum:r.pageNum,callback:function(y){var x=y.rules.indexOf(r.value);r.rowIndex=Math.ceil(x/2);r.rowIndex+=((r.pageNum-1)*q.dataSource().pageSize());q.masterListPageNum(r.pageNum);m({bundle:s,identity:u,node:v,rowIndex:r.rowIndex,tree:q});}});}}else{m({bundle:s,identity:u,node:v,rowIndex:w,tree:q});}}function d(q){q=q||{};ECM.Subscribers.notify({topic:c.TOPIC.TAG.BEFORE_CLOSE});if(b.dirty({id:q.id})){Ext.MessageBox.show({title:ECM.Locale.fetch({key:"CONFIRM_TITLE"}),minWidth:350,msg:ECM.Locale.fetch({key:"YOU_ARE_CLOSING_UNSAVED_MODAL"}),buttons:{yes:gt.gettext("Save"),no:gt.gettext("Don't Save"),cancel:gt.gettext("Cancel")},icon:Ext.MessageBox.WARNING,fn:q.callback});return false;}return true;}function p(s){s=s||{};s.constructLayout=(ECM.Adapter.isEffective(s.constructLayout))?s.constructLayout:c.YES;var r=s.id||"__create__";var q={destroy:ECM.hitch({external:c.DESTROY.FORCE,id:r},j)};if(a[r]){return q;}function t(){if(s.isRename){b.rename({oldIdentity:s.oldIdentity,newIdentity:s.id});}else{document.body.style.cursor="wait";b.ascendants({isRename:c.NO,oldIdentity:s.oldIdentity,newIdentity:s.id});var u=(r==="__create__"||s.isAmbivalent)?"fetchField":"fetchDefinition";b[u]({buffer:s.buffer,dcid:s.dcid,desiredAid:s.desiredAid,id:r,isAmbivalent:s.isAmbivalent,key:s.key,mfid:s.mfid,mid:s.mid,mailingType:s.mailingType,onClose:s.onClose,onSave:s.onSave,pageNum:s.pageNum,useLibrary:s.useLibrary});}if(s.constructLayout){window.setTimeout(function(){l(s);},10);}}(s.beginDeferred instanceof ECM.Deferred)?s.beginDeferred.addCallback(t):t();return q;}function o(){if(a){var q=(a[this.id]||{}).perspective;ECM.Adapter.destroy(q);if(q.subs){ECM.Adapter.each(q.subs,function(r){ECM.Subscribers.unsubscribe({topic:r.data.topic_,subscriber:r});});}q.beforeCloseScope=q.closeScope=q.notify=q.subs=null;}ECM.publish("dynamic_content_destroyed");}function l(v){v=v||{};var t=v.id||"__create__";var w=a[t]={};w.bundle=v;w.perspective=new ECM.PerspectiveWindow(h({id:t,hideDeleteButton:(v.isAmbivalent||v.useLibrary||t==="__create__"),object_id:v.object_id}));w.perspective.subs=w.perspective.subs||[];w.perspective.subs.push(ECM.Subscribers.subscribe({topic:c.TOPIC.PRIORITY.ADJUST_OPENED,subscriber:new ECM.Subscriber({notify:ECM.hitch(w,g)})}));
w.perspective.subs.push(ECM.Subscribers.subscribe({topic:c.TOPIC.TAG.CHANGE,subscriber:new ECM.Subscriber({notify:ECM.hitch(w,ECM.Rules.DynamicContent.changeTag)})}));w.perspective.beforeCloseScope={id:t};w.perspective.mon(w.perspective,"beforeclose",n,w.perspective.beforeCloseScope);w.perspective.closeScope={external:c.DESTROY.FORCE,id:t};w.perspective.mon(w.perspective,"close",j,w.perspective.closeScope);w.container=w.perspective.items.itemAt(c.LAYOUT.CONTAINER);w.priority=w.container.items.itemAt(c.LAYOUT.PRIORITY);w.priority.perspective(w.perspective);w.tabPanel=w.container.items.itemAt(c.LAYOUT.EDITOR).items.itemAt(c.LAYOUT.TABPANEL);w.targeting=w.tabPanel.items.itemAt(c.LAYOUT.TARGETING);w.targeting.perspective(w.perspective);w.content=w.tabPanel.items.itemAt(c.LAYOUT.CONTENT);w.content.perspective(w.perspective);w.shelves=[];var u=w.perspective.items.itemAt(c.LAYOUT.HEADER).items.itemAt(c.LAYOUT.FORM);var r=u.items.itemAt(c.LAYOUT.NAME);w.shelves.push(r);w.shelves.push(u.items.itemAt(c.LAYOUT.DESCRIPTION));var q=w.container.items.itemAt(c.LAYOUT.EDITOR).items.itemAt(c.LAYOUT.FORM);w.shelves.push(q.items.itemAt(c.LAYOUT.EDITING).subscribeToPriorityMoved());w.buttons=[];var s=w.perspective.items.itemAt(c.LAYOUT.HEADER).items.itemAt(c.LAYOUT.BUTTONS).items.itemAt(c.LAYOUT.HEADER);w.buttons.push(s.items.itemAt(c.LAYOUT.DELETE_BUTTON));w.buttons.push(s.items.itemAt(c.LAYOUT.VIEW_BUTTON));w.buttons.push(s.items.itemAt(c.LAYOUT.SAVE_BUTTON));w.perspective.subs.push(ECM.Subscribers.subscribe({topic:c.TOPIC.BUTTONS.VIEW_DETAILS.HIDE,subscriber:new ECM.Subscriber({notify:ECM.hitch(w,function(){Ext.getCmp("dcViewDetailBtn").hide();})})}));w.perspective.subs.push(ECM.Subscribers.subscribe({topic:c.TOPIC.BUTTONS.VIEW_DETAILS.SHOW,subscriber:new ECM.Subscriber({notify:ECM.hitch(w,function(){Ext.getCmp("dcViewDetailBtn").show();})})}));var x=w.perspective.items.itemAt(c.LAYOUT.HEADER).items.itemAt(c.LAYOUT.BUTTONS).items.itemAt(c.LAYOUT.NOTIFY);w.perspective.notify=x;w.endDeferred=v.endDeferred;w.perspective.show();if(r.label){ECM.DomHelper.destroyEl(r.label.dom.lastChild);}}function h(E){E=E||{};this.args=E;var x=new ECM.Rules.Shelf({xtype:"ECM.Rules.Shelf",id:"dcNameComponent",change:{bundle:function(){return{identity:this.identity()};},topic:ECM.Rules.Constants.TOPIC.PRIORITY.NAME.CHANGE},construct:{topic:ECM.Rules.Constants.TOPIC.PRIORITY.NAME.CONSTRUCT},fieldLabel:'<span class="rules-name">'+ECM.Locale.fetch({key:"NAME"})+':</span><span class="rules-name-prefix">d_</span>',identity:E.id,labelSeparator:" ",maxLength:25});var v=new ECM.Rules.Shelf({xtype:"ECM.Rules.Shelf",id:"dcDescriptionComponent",change:{bundle:function(){return{identity:this.identity()};},topic:ECM.Rules.Constants.TOPIC.PRIORITY.DESCRIPTION.CHANGE},construct:{topic:ECM.Rules.Constants.TOPIC.PRIORITY.DESCRIPTION.CONSTRUCT},fieldLabel:'<span class="rules-description">'+ECM.Locale.fetch({key:"DESCRIPTION"})+"</span>",identity:E.id});var q=0;var A=Ext.isIE7?15:0;var F=[x,v];if(ECM.Tablespace.get("mid")<0){ECM.Subscribers.subscribe({topic:c.TOPIC.PRIORITY.LIBRARY_TAGS.CONSTRUCT,subscriber:new ECM.Subscriber({notify:ECM.hitch(this,function(I){f.setSelectedTags(I);})})});f.on("ondone",function(I){ECM.Subscribers.notify({bundle:[{identity:this.args.id,value:I}],topic:ECM.Rules.Constants.TOPIC.PRIORITY.LIBRARY_TAGS.CHANGE});},this);A+=30;F.push(new ECM.Form.LinkButton({text:gt.gettext("Tags"),listeners:{click:function(){f.show();}}}));}var u=ECM.Locale.fetch({key:"VIEW_DETAILS"});var H=ECM.Locale.fetch({key:"EDIT_RULES"});var y=[{region:"west",xtype:"form",border:false,cls:"ecm-perspective-header-left",width:500,items:F},{region:"center",layout:"table",layoutConfig:{columns:1},border:false,cls:"ecm-perspective-header-right",items:[{layout:"table",layoutConfig:{columns:3},border:false,cls:"ecm-object-btn-area",cellCls:"ecm-object-btn-cell",items:[{xtype:"button",id:"dcDeleteTagBtn",cls:"blue_button",hidden:E.hideDeleteButton?true:false,__data__:{identity:E.id,object_id:E.object_id},text:gt.gettext("Delete Tag"),handler:function(){var I=new ECM.Window({title:gt.strargs(gt.gettext("Delete -  %1"),this.__data__.identity),items:[{xtype:"label",html:gt.gettext("You have selected 1 dynamic content tag to be deleted.  Are you sure you would like to delete it?")}],windowButtons:[{text:gt.gettext("Yes"),handler:(function(){I.hide();b.deleteTag({identity:this.__data__.identity,id:this.__data__.object_id});}).createDelegate(this)},{text:gt.gettext("No"),handler:function(K,J){I.hide();}}]}).show();}},{html:"",id:"ViewDetailOld",__data__:{identity:E.id}},{xtype:"button",cls:"blue_button",__data__:{identity:E.id},text:ECM.Locale.fetch({key:"SAVE"}),handler:function(){ECM.Subscribers.notify({topic:c.TOPIC.TAG.SAVE});b.save({identity:this.__data__.identity});}}]},{border:false,cellCls:"ecm-object-notify-cell",maxWidth:550,xtype:"ECM.Notify",align:"right"}]}];var G={region:"north",xtype:"ECM.Rules.Priority",border:false,split:true,collapsible:true,collapseMode:"mini",hideCollapseTool:true,height:200,minSize:145,maxHeight:1000,identity:E.id,clickDelayedTask:new Ext.util.DelayedTask(),listeners:{click:function(M,K,J){var L=M.topLevelIndex();J=J||{};if(J.force||!this.isStandard()||L!==this.previousRowIndex){if(!window.ecmTargetingModeOn){ECM.Subscribers.notify({topic:c.TOPIC.LOADING.SHOW});}this.previousRowIndex=L;this.clickDelayedTask.delay(100,k,this,[M,K,J]);}var I=M.ownerTree;I.minimizeView();},beforedblclick:function(K,J,I){J.stopEvent();return false;}}};var t={title:gt.gettext("Targeting"),xtype:"ECM.Rules.Targeting",border:false,height:250,autoWidth:true,identity:E.id,cls:"ecm-tab-panel",rowIndex:0,listeners:{beforedblclick:function(K,J,I){J.stopEvent();return false;}}};var B={title:ECM.Locale.fetch({key:"CONTENT"}),xtype:"ECM.Rules.Content",border:false,height:250,identity:E.id,cls:"ecm-tab-panel x-panel",rowIndex:0};var D={region:"center",xtype:"tabpanel",border:false,activeTab:0,items:[t,B]};var z=[{region:"north",xtype:"form",border:false,cls:"ecm-editing-form",height:32,items:[{xtype:"ECM.Rules.Shelf",change:{bundle:function(){return{identity:this.identity(),rowIndex:this.rowIndex()};},topic:ECM.Rules.Constants.TOPIC.TARGETING.LABEL.CHANGE},construct:{topic:ECM.Rules.Constants.TOPIC.TARGETING.LABEL.CONSTRUCT},fieldLabel:'<span class="rules-editing">'+ECM.Locale.fetch({key:"EDITING"})+"</span>",identity:E.id,maxLength:100,width:710,rowIndex:0}]},D];var r=[{region:"north",xtype:"panel",layout:"border",border:false,height:59+A,cls:"ecm-perspective-header",items:y},{region:"center",xtype:"panel",layout:"border",border:false,items:[G,{region:"center",xtype:"panel",layout:"border",border:false,items:z,cls:"ecm-editing-panel"}]}];var s=ECM.Locale.fetch({key:"DYNAMIC_CONTENT"})+(ECM.Tablespace.get("mtype")==="2"?" - Triggered":"");var w={title:E.title||s,id:"ecm_dc_modal_response",cls:"ecm-rules-perspective ecm-rules-dynamic-content dc_modal",items:r};if(window.ecmTargetingModeOn){w.width="100%";}return w;}function j(){var q=this;if(q.external){b.truncate({id:q.id,structOnly:true});if(q.external===c.DESTROY.FORCE){o.apply({id:q.id});}if(!a){return false;}var r=(a[q.id]||{}).endDeferred;if(r instanceof ECM.Deferred){r.callback();}}a[q.id]=null;delete a[q.id];}return{changeTag:function(r){r=r||{};if(!ECM.Adapter.isEffective(r.oldIdentity)||!ECM.Adapter.isEffective(r.newIdentity)||r.oldIdentity===r.newIdentity){return false;}var t=r.oldIdentity||"__create__";var s=a[t]||{};if(!s.perspective){return false;}function q(){var u=p({beginDeferred:r.beginDeferred,constructLayout:c.NO,dcid:r.dcid,desiredAid:r.desiredAid,endDeferred:r.endDeferred,id:r.newIdentity,isAmbivalent:r.isAmbivalent,isRename:r.isRename,key:r.key,mfid:r.mfid,mid:r.mid,mailingType:r.mailingType,oldIdentity:r.oldIdentity,onClose:r.onClose,onSave:r.onSave,useLibrary:r.useLibrary});var x=r.newIdentity||"__create__";var y=0;s.perspective.mun(s.perspective,"beforeclose",n,s.perspective.beforeCloseScope);s.perspective.mun(s.perspective,"close",j,s.perspective.closeScope);
var v=a[x]=Object.extend({},s);v.perspective.beforeCloseScope={id:x};v.perspective.mon(v.perspective,"beforeclose",n,v.perspective.beforeCloseScope);v.perspective.closeScope={external:c.DESTROY.FORCE,id:x};v.perspective.mon(v.perspective,"close",j,v.perspective.closeScope);v.bundle=r;v.shelves[c.SHELVES.NAME].resetState({identity:x});v.shelves[c.SHELVES.DESCRIPTION].resetState({identity:x});v.shelves[c.SHELVES.EDITING].resetState({identity:x,rowIndex:y});v.buttons[c.LAYOUT.DELETE_BUTTON].__data__.identity=x;v.buttons[c.LAYOUT.VIEW_BUTTON].__data__.identity=x;v.buttons[c.LAYOUT.SAVE_BUTTON].__data__.identity=x;v.content.resetState({identity:x});var w=s.priority.__data__.bindIndex;v.priority.resetState({identity:x});v.targeting.resetState({identity:x,rowIndex:y});if(r.isRename){v.priority.__data__.bindIndex=w;}v.priority.renderStandard();if(v.tabPanel.activeTab instanceof ECM.Rules.Content){v.priority.dataSource().targetingAndContent({id:x,rowIndex:y,callback:function(z){v.targeting.construct({data:z.rule,key:z.key,rowIndex:y,tagType:z.tagType});v.content.updateEditor({data:z.content,rowIndex:y});}});}else{v.priority.dataSource().targeting({id:x,rowIndex:y,callback:function(z){v.targeting.construct({data:z.rule,key:z.key,rowIndex:y,tagType:z.tagType});v.content.rowIndex(y);}});}j.apply({external:c.DESTROY.REQUEST,id:(r.oldIdentity||"__create__")});(r.callback)&&(r.callback(u));return u;}return((d({callback:function(u){if(u==="yes"){return q();}},id:t}))?q():false);},create:function(r){r=r||{};r.id="";var q=p(r);return q;},layout:function(q){q=q||{};return a[q.id||"__create__"]||{};},modify:function(r){r=r||{};if(!ECM.Adapter.isEffective(r.id)){return false;}var q=p(r);return q;},_bogus:true};})();ECM.Adapter.onUnload(function(){b.truncate();for(var d in a){try{typeof destroy==="function"&&destroy.apply({id:d});typeof purge==="function"&&purge.apply({id:d});}catch(f){}}a=null;});})();}ECM.provide("ECM.Form.LinkButton");ECM.Form.LinkButton=Ext.extend(Ext.Button,{initComponent:function(){ECM.Form.LinkButton.superclass.initComponent.call(this);},template:new Ext.Template('<table cellspacing="0" class="x-btn label_link {3}"><tbody class="{4}">',"<tr>",'<td class="x-btn">','<em class="{4}" unselectable="on">','<label style="display:block" target="{6}" class="x-btn-text {2}">{0}</label>',"</em>","</td>","</tr>","</tbody></table>").compile(),buttonSelector:"label:first",href:"",baseParams:{},params:{},getTemplateArgs:function(){return Ext.Button.prototype.getTemplateArgs.apply(this).concat([this.getHref(),this.target]);},onClick:function(a){if(a.button!==0){return;}if(this.disabled){this.stopEvent(a);}else{if(this.fireEvent("click",this,a)!==false){if(this.handler){this.handler.call(this.scope||this,this,a);}if(!Ext.isEmpty(this.href)){window.location.href=this.href;}}}},getHref:function(){var a=this.href;var b=Ext.urlEncode(Ext.apply(Ext.apply({},this.baseParams),this.params));if(b.length){a+=((this.href.indexOf("?")==-1)?"?":"&")+b;}return a;},setParams:function(a){this.params=a;this.el.child(this.buttonSelector,true).href=this.getHref();}});Ext.reg("ecm.linkbutton",ECM.Form.LinkButton);Ext.ns("ECM.Form");ECM.provide("ECM.Form.TextField");ECM.Form.TextField=Ext.extend(Ext.form.TextField,{clickToEdit:false,prependText:"",clickToEditTipText:"click to edit",enforceMaxLength:false,initComponent:function(){if(this.clickToEdit){this.addClass("cm_input_transparent");this.on("specialkey",function(a,b){if(b.getKey()==b.ENTER){this.blur();}});}ECM.Form.TextField.superclass.initComponent.apply(this,arguments);},afterRender:function(){ECM.Form.TextField.superclass.afterRender.call(this);Ext.DomHelper.insertBefore(this.el,this.prependText);if(this.clickToEdit){this.clickToEditToolTip=new Ext.ToolTip({target:this.el,html:this.clickToEditTipText});this.clickToEditToolTip.enable();this.el.on("click",function(){this.clickToEditToolTip.disable();this.removeClass("cm_input_transparent");this.el.stopFx();},this);this.el.on("focus",function(){this.clickToEditToolTip.disable();this.removeClass("cm_input_transparent");this.el.stopFx();},this);this.on("blur",function(){if(!this.isValid()){return;}this.clickToEditToolTip.enable();this.addClass("cm_input_transparent");},this);this.el.on("mouseover",function(){if(!this.el.hasClass("cm_input_transparent")){return;}this.el.highlight("#DEDEDE",{attr:"background-color",duration:2});},this);}},afterRender:function(){ECM.Form.TextField.superclass.afterRender.apply(this,arguments);if(this.enforceMaxLength){this.el.dom.maxLength=this.maxLength;}}});Ext.reg("ecm.textfield",ECM.Form.TextField);ECM.provide("ECM.Rules.Form");window.dcForm=ECM.Adapter.apply(ECM.Rules.Form,{controlWidth:300,gridPickerWidth:516,sourceTreeNode:{},condition:{},columnData:{},operatorData:{},associativeData:{},dialog:{},currentFieldValue:"",currentFieldType:"",promptOnHide:true,lastAddedRuleField:"",switchToAdvancedRequested:false,changeAllFieldsRequested:false,fieldIsSelectable:true,operatorIsSelectable:true,isSimpleMode:false,isEditMode:false,isMailingEbm:false,displaySwitchToAdvancedModal:false,hasNoValueOption:false,isNoValueSelected:false,numberOfValues:0,systemTableCheck:function(d){var b=this;var c=[];var a=function(g){var f=g.attributes.data;if(f[ECM.Rules.Constants.IDX.LOGIC]&ECM.Rules.Constants.LOGIC.GROUP){Ext.each(g.childNodes,function(h){a(h);});}};a(d);return c.length==0&&(!d.childrenRendered||d.childNodes.length>0)?true:false;},generateComponentsFromNode:function(g){var k=dcForm.switchToAdvancedRequested;dcForm.configureModal(g);var d=ECM.Rules.Constants;var f=[];var l={};var m=dcForm.condition.group!=undefined;if(g.attributes){var j=ECM.Form.FormElements.ElementHelper.getColumnInfoFromId(g.attributes.data[2]);g.isMainSubscription=(window.ecmTargetingModeOn&&g.stripeIndex==0&&j.type==ECM.Rules.Constants.TYPES.SUBSCRIPTION);}var a=g.isMainSubscription;var h=this.getNotificationArea(480);var c={};dcForm.numberOfValues=0;dcForm.hasNoValueOption=false;f.push(h);var b=function(n){if(!window.ecmTargetingModeOn){return false;}var o=ECM.getObject("attributes.data",n);return(o[1]==="I");};if(g.attributes&&g.attributes.isAggregator){return ECM.Form.View.Aggregator.getConfig({node:g});}if(dcForm.isMailingEbm){c=ECM.Form.View.Triggered;}else{if(b(g)){c=ECM.Form.View.Shortcut;}else{if(!dcForm.isEditMode&&dcForm.displaySwitchToAdvancedModal){c=ECM.Form.View.ConfirmSwitch;}else{if(dcForm.isSimpleMode&&!k){if((dcForm.condition&&dcForm.condition.totalRules<100)||!Ext.isDefined(dcForm.condition.totalRules)){c=ECM.Form.View.Simple;}else{c=ECM.Form.View.ConfirmSwitch;}}else{if(!m){if(a&&window.ecmTargetingModeOn){c=ECM.Form.View.SubscriptionList;this.currentFieldType=10;}else{if(!dcForm.isSimpleMode&&!window.ecmTargetingModeOn){c=ECM.Form.View.Advanced;}else{c=ECM.Form.View.Targeting;}}}else{if(m){c=ECM.Form.View.Group;}}}}}}return c.getConfig({node:g});},getComponentValue:function(b){var a=undefined;if(b&&b.xtype){if(b.xtype=="textfield"){a=b.getRawValue()||undefined;}else{if(b.xtype=="multiselect"){a=dcForm.getMultiSelectVals(b)||undefined;}else{if(b.xtype=="combo"){a=b.getRawValue()||undefined;}else{if(b.xtype=="label"){a=b.text||undefined;}else{if(b.xtype=="ecm.bitfield"){a=b.getValue()||undefined;}else{if(b.xtype=="panel"){a=b.getValue()||undefined;}else{if(b.xtype=="ecm.rangeof"){a=b.getValue()||undefined;}else{if(b.xtype=="ecm.dateControl"){a=b.getValue()||undefined;}else{if(b.xtype=="checkbox"){a=b.checked||undefined;}else{if(b.xtype=="ecm.citystate"){a=b.getValue()||undefined;}else{if(b.xtype=="ecm.platform"){a=b.getValue()||undefined;}else{if(b.xtype=="ecm.geolocation"){a=b.getValue()||undefined;}else{if(b.xtype=="ecm.gridpicker"||b.xtype=="ecm.directentrygridpicker"){a=b.getValue()||undefined;}else{if(typeof b.getRawValue==="function"){a=b.getRawValue();}}}}}}}}}}}}}}}return a;},getMultiSelectVals:function(d){var f=dcForm.getSelectedListboxItems(d);var a=d.store.data.items;var g=[];for(var c=0;c<f.length;c++){for(var b=0;b<a.length;b++){if(dcForm.chompString(f[c])==a[b].data.text){g.push(a[b].data.value);
break;}}}return g;},beforeDialogHide:function(a){if(dcForm.promptOnHide){dcForm.ignoreClickEvent=true;dcForm.promptOnHide=false;a.hide();dcForm.sourceTreeNode.cancelChanges();dcForm.promptOnHide=true;dcForm.ignoreClickEvent=false;if(Ext.getCmp("value0")){Ext.getCmp("value0").value="";}if(Ext.getCmp("value1")){Ext.getCmp("value1").value="";}}dcForm.switchToAdvancedRequested=false;dcForm.changeAllFieldsRequested=false;if(dcForm.sourceTreeNode&&dcForm.sourceTreeNode.childNodes){dcForm.sourceTreeNode.eachChild(function(b){b.wrapAggregate();});}},configureModal:function(a){if(a){dcForm.sourceTreeNode=a;dcForm.condition=a.condition();if(!!a.newFromTree){dcForm.condition.mode=ECM.Rules.Constants.MODES.ADD;}if(a.dataStore){if(!dcForm.switchToAdvancedRequested){dcForm.columnData=a.dataStore()[0]||{};if(!ECM.Stash.show_access_location){dcForm.columnData.data.removeKey("CLICK_GEOLOCATION");dcForm.columnData.data.removeKey("CLICK_PLATFORM");dcForm.columnData.data.removeKey("OPEN_GEOLOCATION");dcForm.columnData.data.removeKey("OPEN_PLATFORM");}}dcForm.operatorData=a.dataStore()[1]||{};dcForm.associativeData=a.dataStore()[2]||{};}dcForm.dialog=a.dialog();dcForm.dialog.on("show",function(){if(this.sourceTreeNode.attributes&&this.sourceTreeNode.attributes.isGroup){this.originalHash=Ext.decode(Ext.encode(this.generateChangeHash(this.sourceTreeNode.attributes.isGroup)));}},dcForm,{single:true});if(dcForm.condition.mode==ECM.Rules.Constants.MODES.ADD){dcForm.isEditMode=false;}else{dcForm.isEditMode=true;}if(dcForm.condition.mailingType==ECM.Rules.Constants.MAILING.EBM){dcForm.isMailingEbm=true;}else{dcForm.isMailingEbm=false;}if(dcForm.condition.tagType==ECM.Rules.Constants.TAG.SIMPLE){dcForm.isSimpleMode=true;}else{dcForm.isSimpleMode=false;}if(dcForm.condition.switchToAdvanced==ECM.Rules.Constants.YES){dcForm.displaySwitchToAdvancedModal=true;}else{dcForm.displaySwitchToAdvancedModal=false;}}},getNonGroupListeners:function(){var d=Ext.getCmp("value0");if(d){var b=d.parent;if(b&&b instanceof ECM.Form.DirectEntryGridPicker){if(!b.removeNonExistingDataKeys(b.selectedKeys(),true)){return false;}b.setValue(b.selectedKeys());}}var f=dcForm.generateChangeHash(false);if(!f.error){var a=ECM.Rules.Constants;var c=a.LOGIC.AND+a.LOGIC.OR;if(!dcForm.sourceTreeNode.isMainSubscription&&(dcForm.sourceTreeNode.attributes.data[0]&c)!=(f.newLogic&c)){dcForm.sourceTreeNode.ownerTree.onBooleanClick(dcForm.sourceTreeNode);}if(dcForm.isSimpleMode&&!dcForm.switchToAdvancedRequested){if(dcForm.sourceTreeNode.isDuplicate(f)){dcForm.sourceTreeNode.ownerTree.perspective().dialog().notify.warn(ECM.Locale.fetch({key:"VALUE_OF_X_SHOULD_BE_DISTINCT",params:[f.operands[ECM.Rules.Constants.OPERANDS.FIRST][ECM.Rules.Constants.DATA.VALUE]]}));return false;}}var j=dcForm.sourceTreeNode.indexPath();var k=dcForm.sourceTreeNode.ownerTree;if(dcForm.isSimpleMode&&!dcForm.switchToAdvancedRequested&&!dcForm.changeAllFieldsRequested){f.table=f.table||dcForm.sourceTreeNode.getTable();}dcForm.sourceTreeNode.applyChanges(f);dcForm.promptOnHide=false;var h=k.findNodeByPath({path:j});dcForm.sourceTreeNode=h;dcForm.sourceTreeNode.dialog().hide();dcForm.promptOnHide=true;dcForm.currentFieldValue="";dcForm.currentFieldType="";}else{if(f.error.target=="value"){if(Ext.getCmp("value0")){Ext.getCmp("value0").markInvalid();}if(Ext.getCmp("value1")){Ext.getCmp("value1").markInvalid();}dcForm.sourceTreeNode.ownerTree.perspective().dialog().notify.warn(ECM.Locale.fetch({key:"VALUE_INVALID"}));}else{if(f.error.target=="field"){var g=Ext.getCmp("field");if(g.xtype=="combo"){g.markInvalid();}dcForm.sourceTreeNode.ownerTree.perspective().dialog().notify.warn(ECM.Locale.fetch({key:"NO_FIELD_SELECTED"}));}else{if(f.error.target=="oper"){dcForm.sourceTreeNode.ownerTree.perspective().dialog().notify.warn(ECM.Locale.fetch({key:"OPERATOR_INVALID"}));}else{if(f.error.target=="desc"){Ext.getCmp("desc").markInvalid();dcForm.sourceTreeNode.ownerTree.perspective().dialog().notify.warn(ECM.Locale.fetch({key:"DESCRIPTION_INVALID"}));}else{if(f.error.target==="xdb"){dcForm.sourceTreeNode.ownerTree.perspective().dialog().notify.warn(f.error.msg);}}}}}}delete dcForm.sourceTreeNode.newFromTree;if(Ext.getCmp("value0")){Ext.getCmp("value0").value="";}if(Ext.getCmp("value1")){Ext.getCmp("value1").value="";}if(window.ecmTargetingModeOn&&dcForm.sourceTreeNode.isMainSubscription){ECM.Targeting.SegmentEditor.updateSubscriptionList();}},getGroupListeners:function(){var h=Ext.getCmp("groupname");var c=Ext.getCmp("value0");var g=Ext.getCmp("saveGroup");if(h||c){var d="";if(h){d=h.getValue();}else{if(c){d=c.getRawValue();}}if(d||(typeof c==="object"&&c.disabled===true)){var b=dcForm.generateChangeHash(true);var f=ECM.Rules.Constants;var a=f.LOGIC.AND+f.LOGIC.OR;if(b.newLogic&&(dcForm.sourceTreeNode.attributes.data[0]&a)!=(b.newLogic&a)){dcForm.sourceTreeNode.ownerTree.onBooleanClick(dcForm.sourceTreeNode);}dcForm.sourceTreeNode.applyChanges(b);dcForm.promptOnHide=false;dcForm.sourceTreeNode.dialog().hide();dcForm.promptOnHide=true;dcForm.currentFieldValue="";dcForm.currentFieldType="";}}if(g&&g.checked){dcForm.sourceTreeNode.ownerTree.saveGroup(dcForm.sourceTreeNode);}},changeAllFields:function(){dcForm.changeAllFieldsRequested=true;dcForm.switchToEditableField();},switchToEditableField:function(){var b=dcForm.getComponentValue(Ext.getCmp("value0"));dcForm.lastSimpleFieldValue=Ext.getCmp("field").text;var a=dcForm.sourceTreeNode.ownerTree.identity();var c=ECM.Rules.Tablespace.totalRules({identity:a});dcForm.sourceTreeNode.dataStore({types:["column"],switchToAdvanced:false,callback:function(f){dcForm.columnData=f[0];dcForm.condition.columnId=dcForm.getIdFromValue(dcForm.lastSimpleFieldValue,dcForm.columnData);var g=dcForm.getIdFromValue(Ext.getCmp("operator").text,dcForm.operatorData);var d=dcForm.dialog;d.removeAll();dcForm.isFieldSelectable=true;dcForm.isOperatorSelectable=false;var h=dcForm.generateComponentsFromNode(dcForm.sourceTreeNode)[0];d.insert(0,h);dcForm.dialog.doLayout();dcForm.dialog.afterExpand();dcForm.btnPanel.validateForm();}});},switchToAdvanced:function(){args=args||{};var d=__structs__[__structs__.dcFormIdentity]||__structs__[args.id]||{};var c=ECM.Rules.Tablespace.convertRules({bundle:args.bundle,force:true,identity:args.id,struct:d,switchToAdvanced:true});d.data.rules=c.rules.slice(0);var a=ECM.Form.FormElements.ElementHelper;var k="";var g=Ext.getCmp("value0");if(g){k=g.getValue();}dcForm.lastSimpleFieldValue=dcForm.getComponentValue(Ext.getCmp("field"));dcForm.preSwitchToAdvancedNode=dcForm.sourceTreeNode;var f=dcForm.getIdFromValue(dcForm.lastSimpleFieldValue,dcForm.columnData);var h=dcForm.sourceTreeNode.ownerTree.identity();var b=ECM.Rules.Tablespace.totalRules({identity:h});if(b<=100){dcForm.sourceTreeNode.dataStore({types:["column"],switchToAdvanced:true,callback:function(q){dcForm.switchToAdvancedRequested=true;dcForm.columnData=q[0];var o=dcForm.dialog;var l=function(n){return function(){return n;};};var v={};var t=Ext.getCmp("field");var u=dcForm.columnData;var r=u.getAt(u.findExact("value",t.getValue()));if(r){v={table:a.getColumnInfoFromId(r.get("value")).table,field:r.get("value")};}var p={dataStore:dcForm.sourceTreeNode.dataStore,indexPath:l("/"),dialog:l(o),childNodes:[],parentNode:{isRoot:true,childNodes:[]},attributes:{data:[21,v.table,v.field,29,[[k]]]},getTable:l(v.table),condition:l({mode:dcForm.sourceTreeNode.condition().mode,mailingType:1,rowIndex:dcForm.sourceTreeNode.condition().rowIndex,tagType:2,operatorId:29,columnId:v.field,operands:[[k]]}),ownerTree:{dataSource:l(ECM.Rules.Tablespace),identity:l(h),rowIndex:l(dcForm.sourceTreeNode.condition().rowIndex),getDialog:l(o),perspective:l(dcForm.sourceTreeNode.ownerTree.perspective()),getTargetingJSON:l({}),isSimpleTag:l(false)}};Ext.applyIf(p,ECM.treegrid.TreeNode.prototype);var s=false;if(Ext.getCmp("desc")){s=Ext.getCmp("desc").getValue();}Ext.applyIf(p.ownerTree,dcForm.sourceTreeNode.ownerTree);Ext.applyIf(p.ownerTree,dcForm.sourceTreeNode.ownerTree.prototype);
p.ownerTree.findNodeByPath=l(p);p.ownerTree.updateNode=false;o.removeAll();var m=dcForm.generateComponentsFromNode(p)[0];o.insert(0,m);dcForm.dialog.doLayout();if(s){Ext.getCmp("desc").setValue(s);}g=Ext.getCmp("value0");if(!window.ecmTargetingModeOn&&g){g.setValue(k);}dcForm.dialog.afterExpand();dcForm.dialog.center();dcForm.btnPanel.validateForm();}});}else{var j=ECM.Rules.Tablespace.pageSize();dcForm.sourceTreeNode.ownerTree.perspective().dialog().notify.warn(ECM.Locale.fetch({key:"MAXED_OUT_RULES_IN_ADVANCED_MODE",params:[j]}));}},switchToSimple:function(){dcForm.changeAllFieldsRequested=false;var b=Ext.getCmp("field");var c=b.getValue();var a=dcForm.getIdFromValue(c,dcForm.columnData);var d=ECM.Form.FormElements.ElementHelper;dcForm.sourceTreeNode.dataStore({types:["column"],switchToAdvanced:false,callback:function(f){dcForm.columnData=f[0];dcForm.switchToAdvancedRequested=false;dcForm.isSimpleMode=true;var k=Ext.getCmp("field").columnType;var m=29;var o,h=Ext.getCmp("value0");if(h){o=dcForm.getComponentValue(h);}if(a=="145"){dcForm.condition.columnId=a;}else{for(var q=0,r=dcForm.columnData.data.items.length;q<r;q++){var x=dcForm.columnData.data.items[q].id;if(x.indexOf(".")){var l=x.split(".");if(l[l.length-1]==a||l[l.length-1]==a.substr(1,a.length-1)){dcForm.condition.columnId=dcForm.columnData.data.items[q].id;break;}}}}var s=false;if(Ext.getCmp("desc")){s=Ext.getCmp("desc").getValue();}var v=dcForm.dialog;v.removeAll();var u=[];var y=dcForm.sourceTreeNode.ownerTree.identity();if(ECM.Rules.Tablespace.totalRules({identity:y})>1){dcForm.isFieldSelectable=false;}else{dcForm.isFieldSelectable=true;}dcForm.isOperatorSelectable=false;var p=dcForm.generateComponentsFromNode(dcForm.preSwitchToAdvancedNode)[0];v.insert(0,p);if(s){Ext.getCmp("desc").setValue(s);}var w=Ext.getCmp("field");w.setValue(c);var t=d.getColumnInfoFromId(Ext.getCmp("field").getValue()).table;var j=Ext.getCmp("selTable");if(t&&j){j.setValue(t);}dcForm.dialog.doLayout();dcForm.dialog.afterExpand();dcForm.dialog.center();var g=Ext.getCmp("value0");if(g){if((h.xtype=="ecm.directentrygridpicker"||h.xtype=="ecm.gridpicker")&&Ext.isArray(o)&&o.length>1){g.setValue();}else{g.setValue(o);}g.allowBlank=true;if(g.xtype!="ecm.bitfield"){g.validate();}}dcForm.btnPanel.validateForm();}});},getChangeAllFieldsInterface:function(a){return{xtype:"label",html:"<span onclick='ECM.Rules.Form.changeAllFields()' style='cursor:pointer;color:blue;text-decoration:underline;'>Change field for all rules</span>",fieldLabel:"&nbsp;",labelSeparator:""};},isModified:function(){return !(Ext.encode(this.originalHash)===Ext.encode(this.generateChangeHash(this.sourceTreeNode.attributes.isGroup)));},getAdvancedSwitchInterface:function(a){var b="";if(a==0){b="field";}else{if(a==1){b="operator";}}return{xtype:"label",targetName:b,html:"Need a different "+b+"? Switch to <span onclick='ECM.Rules.Form.switchToAdvanced()' style='cursor:pointer;color:blue;text-decoration:underline;'>Advanced</span>.",fieldLabel:"&nbsp;",labelSeparator:"",id:"advancedSwitcher"};},getSimpleSwitchInterface:function(a){var b="";if(a==0){b="field";}else{if(a==1){b="operator";}}return{xtype:"label",html:"Return to <span onclick='ECM.Rules.Form.switchToSimple()' style='cursor:pointer;color:blue;text-decoration:underline;'>Simple</span>.",fieldLabel:"&nbsp;",labelSeparator:""};},getNotificationArea:function(a){var b=this;return{layout:"table",layoutConfig:{columns:1},border:false,cls:"ecm-condition-notify",items:[{xtype:"ECM.Notify",maxWidth:a,border:false,listeners:{afterRender:function(){b.dialog.notify=this;}}}]};},doSwitchInterface:function(){var w=Ext.getCmp("value0");var u=Ext.getCmp("value1");var f=Ext.getCmp("valuePanel");if(w.xtype=="textfield"){var k=w.getRawValue().split(",");k=dcForm.chompArray(k);var d=Ext.getCmp("field").columnType;dcForm.numberOfValues=1;var h=Ext.getCmp("valueTable");h.populatePanel(d);w=Ext.getCmp("value0");var r=[];if(w.store){r=w.store.data.items;}var c=[];for(var o=0;o<k.length;o++){for(var n=0;n<r.length;n++){var p="";if(r[n].data.text){p=dcForm.chompString(r[n].data.text);}else{if(r[n].data.field2){p=dcForm.chompString(r[n].data.field2);}}var t=p.lastIndexOf("(");var l=dcForm.chompString(p.substr(0,t));var m=dcForm.chompString(p.substr(t+1,p.length-(t+2)));if(k[o]==l||k[o]==m||k[o]==p){if(w.xtype=="combo"){c.push(l);c.push(m);}else{c.push(n);}break;}}}if(w.xtype=="combo"){if(c.length>0){w.setValue(c[0]+" ("+c[1]+")");}else{}}else{if(w.xtype=="ecm.bitfield"){w.setValue(k[0]);}else{if(w.xtype=="ecm.gridpicker"||w.xtype=="ecm.directentrygridpicker"){w._selectedDataKeys=k[0];w.refreshSelections();}else{if(w.view){w.view.select(c);}}}}}else{var v=[];var q="";if(w.xtype=="combo"){var g=w.getRawValue();if(g!="Select item..."&&g!="No Value (Empty)"){var t=g.lastIndexOf("(");var l=dcForm.chompString(g.substr(0,t));var m=dcForm.chompString(g.substr(t+1,g.length-(t+2)));v=[m];}}else{if(w.xtype=="ecm.bitfield"){var b=dcForm.getComponentValue(w);v=[b];}else{if(w.xtype=="multiselect"){q=[];if(w.view){q=dcForm.getSelectedListboxItems(w);}var a=w.store;for(var o=0;o<q.length;o++){var t=q[o].lastIndexOf("(");var l=dcForm.chompString(q[o].substr(0,t));var m=dcForm.chompString(q[o].substr(t+1,q[o].length-(t+2)));v.push(m);}}else{if(w.xtype=="ecm.gridpicker"||w.xtype=="ecm.directentrygridpicker"){dcForm.getComponentValue(w);}else{q=[];if(w.view){q=w.view.getSelectedRecords();}var a=w.store;for(var o=0;o<q.length;o++){v.push(q[o].data.text);}}}}}f.removeAll();var s=dcForm.getMultiSelectSwapComponent(v);s.store=a;f.add(s);}f.doLayout();dcForm.dialog.afterExpand();},chompString:function(b){var a=b.replace(/^\s+|\s+$/g,"");return a;},chompArray:function(b){var d=[];for(var c=0,a=b.length;c<a;c++){d.push(this.chompString(b[c]));}return d;},getMultiSelectSwapComponent:function(a){return{id:"value0",xtype:"textfield",fieldLabel:"Value:",labelSeparator:"",width:dcForm.controlWidth-17,value:a};},validateDateVals:function(b){var a=false;if(Ext.get(b.id)&&b.currentDateField){var h=b.currentDateField.getValue(),k=h[0],g=h[1],m="",n="",j=[11,24,28,32],f=null,d=null;if(j.indexOf(k)>-1){if(k!==11){m="^[0-9]+$";d=ECM.Adapter.fly(b.id).query("input.ecm-date-daynum");if(d.length){f=Ext.getCmp(d[0].id);}}else{m="^[0-9]{2} [0-9]{2} [0-9]{4}$";d=ECM.Adapter.fly(b.id).query("input.ecm-date-exact");if(d.length){f=Ext.getCmp(d[0].id);}}if(g&&g.match(m)){var c="Please select a value from 1-";if(k==24){if(parseInt(g)!=0&&parseInt(g)<=7){a=true;}else{setTimeout(function(){f.markInvalid(c+"7");},1000);}}else{if(k==28){if(parseInt(g)!=0&&parseInt(g)<=31){a=true;}else{setTimeout(function(){f.markInvalid(c+"31");},1000);}}else{if(k==32){if(parseInt(g)!=0&&parseInt(g)<=365){a=true;}else{setTimeout(function(){f.markInvalid(c+"365");},1000);}}else{if(k==11){a=true;}}}}}}else{var l=b.currentDateField.intValue;a=l?l.isValid():true;}}return a;},determineFieldXtype:function(){if(!dcForm.isFieldSelectable){return"label";}else{return"combo";}},isConditionEditSupported:function(a){var b=true;if(a&&dcForm.isSimpleMode&&!dcForm.switchToAdvancedRequested){if(a==ECM.Rules.Constants.TYPES.DATE||a==ECM.Rules.Constants.TYPES.NTHING||a==ECM.Rules.Constants.TYPES.VIRTUAL){b=false;}}return b;},onEditableComboFocus:function(b){if(b.xtype=="combo"){var a=dcForm.getComponentValue(b);if(a=="Select field..."||a=="Select item..."){b.clearValue();}}},updateSwitchToAdvancedLink:function(b,a){if(b&&b.el){if(!dcForm.isConditionEditSupported(a)){b.el.dom.innerHTML="Want to use this field? Switch to <span onclick='ECM.Rules.Form.switchToAdvanced()' style='cursor:pointer;color:blue;text-decoration:underline;'>Advanced</span>.";}else{b.el.dom.innerHTML="Need a different "+b.targetName+"? Switch to <span onclick='ECM.Rules.Form.switchToAdvanced()' style='cursor:pointer;color:blue;text-decoration:underline;'>Advanced</span>.";}}},getSwitchToAdvancedInterface:function(){var b="Adding an additional condition to your rule will change this tag to an Advanced tag.";if(dcForm.condition.totalRules<=100){b+=" Do you want to proceed?";
}else{var a=dcForm.condition.totalRules-100;b+=" Advanced tags can only have 100 rules, so you will have to delete "+a+" rules before you can save your changes.";}return{xtype:"label",id:"field",text:b};},getIdFromValue:function(b,h){var c="";var f=b||"";if(!Ext.isNumber(f)){f=f.toUpperCase();}var d=h.data.items;for(var g=0,a=d.length;g<a;g++){if(d[g].data.text&&f==d[g].data.text.toUpperCase()){c=d[g].data.value;break;}}return c;},getValueFromId:function(b,g){var f="";var c=g.data.items;for(var d=0,a=c.length;d<a;d++){if(b==c[d].data.value){f=c[d].data.text;break;}}return f;},generateChangeHash:function(o){var B={};var f=Ext.getCmp("selInclusion");if(f){B.newLogic=f.getValue();}var t=ECM.Rules.Constants;var F=Ext.getCmp("selTable");if(F&&F.getValue()){B.table=F.getValue();}if(this.sourceTreeNode.attributes.isAggregator){var u=Ext.getCmp("selAggregator");if(u&&u.getValue()){var J=u.getValue();B.aggregator=J;B.newLogic|=J;}}var p=function(){var M=Ext.getCmp("groupname");var j=Ext.getCmp("value0");var L="";if(M){L=M.getValue();B.group=L;}else{if(j){L=j.getRawValue();B.columnId=dcForm.condition.columnId;B.operatorId=dcForm.condition.operatorId;var K=Ext.getCmp("EbmUseBlank");if(K&&K.getValue()){B.operands=[[""]];}else{B.operands=[[L]];}}}};if(o){p();}else{var g="";var k;if(dcForm.sourceTreeNode.attributes.isAggregator&&Ext.getCmp("selAggregator")&&Ext.getCmp("selAggregator").getValue()&t.LOGIC.COUNT){k={getValue:function(){return"COUNT";},getRawValue:function(){return"COUNT";},getType:function(){return"3";}};}else{k=Ext.getCmp("field");}if(!k){return{};}g=k.getRawValue();var n=false;if(k.getType){n=k.getType();}else{var a=k.getStore().find("value",k.getValue());if(a){n=k.getStore().getAt(a).get("type");}}if(n){var b=k.getValue();var D=Ext.getCmp("operator");var E=dcForm.getComponentValue(D);var w=false;var G=Ext.getCmp("includeNoValue");if(G){w=dcForm.getComponentValue(G);}var v=D.operators;var c=-1;if((dcForm.isSimpleMode&&!dcForm.switchToAdvancedRequested)){c="29";}else{if(n==ECM.Rules.Constants.TYPES.NTHING){c="145";}else{for(var z=0;z<v.length;z++){if(v[z][1]==E){if(w){if(n>=ECM.Rules.Constants.TYPES.ZIP&&n<=ECM.Rules.Constants.TYPES.ZIP_MA){if(v[z][2]!=-2){c=v[z][2];}else{c=v[z][0];}break;}if((v[z][0]=="83"||v[z][0]=="84"||v[z][0]=="132")&&v[z][2]==-2){c=v[z][0];break;}if(v[z][2]==-1){c=v[z][0];break;}else{c=v[z][2];break;}}else{if(v[z][2]>=0||v[z][2]==-2){c=v[z][0];break;}}}}}}var I=Ext.getCmp("value0");var H=Ext.getCmp("value1");var m=[];var l=[];if(n==ECM.Rules.Constants.TYPES.DATE||n==ECM.Rules.Constants.TYPES.DATETIME||n==ECM.Rules.Constants.TYPES.NTHING){if(I){m=!Ext.isArray(I.getValue(1))?[I.getValue(1)]:I.getValue(1);}if(H){l=!Ext.isArray(H.getValue(1))?[H.getValue(1)]:H.getValue(1);}}else{if(n==ECM.Rules.Constants.TYPES.BEHAVIOR){if(I){if(I.getValue()){m=[I.getValue()];}}}else{if(n==ECM.Rules.Constants.TYPES.SUBSCRIPTION||n==ECM.Rules.Constants.TYPES.MAILING||n==ECM.Rules.Constants.TYPES.VIRTUAL||(n==ECM.Rules.Constants.TYPES.ASSOCIATIVE||n>=ECM.Rules.Constants.TYPES.ZIP&&n<=ECM.Rules.Constants.TYPES.ZIP_MA)||n==ECM.Rules.Constants.TYPES.PLATFORM||n==ECM.Rules.Constants.TYPES.GEOLOCATION){if(I){if(I.xtype=="combo"){if(I.getValue()=="Select item..."){B.error={msg:"Invalid Selection",target:"value"};}else{var y=dcForm.getComponentValue(I);if(y=="NULL (empty, unspecified) ()"){y="";m.push(y);}else{var y=dcForm.getComponentValue(I);if(y=="NULL (empty, unspecified) ()"){y="";m.push(y);}else{for(var z=0,A=I.store.data.items.length;z<A;z++){if(I.store.data.items[z].data.text){if(y==I.store.data.items[z].data.text||y==I.store.data.items[z].data.text+" ("+I.store.data.items[z].data.value+")"){m.push(I.store.data.items[z].data.value);break;}}else{if(I.store.data.items[z].data.field2){if(y==I.store.data.items[z].data.field2||y==I.store.data.items[z].data.field2+" ("+I.store.data.items[z].data.field1+")"){m.push(I.store.data.items[z].data.field1);break;}}}}}}}}else{if(I.xtype=="textfield"){if(dcForm.isSimpleMode&&!dcForm.switchToAdvancedRequested){var J=I.getRawValue()||"";var r=J.split(",");r=dcForm.chompArray(r);for(var z=0,A=r.length;z<A;z++){if(r[z]){m.push(r[z]);}}}else{if(I.store){var J=I.getRawValue()||"";var r=J.split(",");r=dcForm.chompArray(r);var d=[];if(I.store.data){d=I.store.data.items;}else{d=I.store;}for(vari=0,A=d.length;z<A;z++){for(var x=0,A=r.length;x<A;x++){if(d[z].data){if(r[x]==d[z].data.text||r[x]==d[z].data.value){m.push(d[z].data.value);}}else{if(r[x]==d[z][1]||r[x]==d[z][0]){m.push(d[z][0]);}}}}}else{var J=I.getRawValue()||"";var r=J.split(",");r=dcForm.chompArray(r);for(var z=0,A=r.length;z<A;z++){if(r[z]){m.push(r[z]);}}if(H){l.push(H.getRawValue());}}}}else{if(I){m=this.getComponentValue(I);var q=ECM.Rules.Tablespace.anyXDBExpired({columnId:b,ids:m});if(q){B.error={msg:gt.strargs(gt.gettext("The XDB file %1 has expired. Please select another XDB filename."),[q]),target:"xdb"};}}if(H){l=this.getComponentValue(H);}}}}}else{if(n==ECM.Rules.Constants.TYPES.BITMASK){if(I){var h=this.getComponentValue(I);var s=0;for(z=0;z<h.length;z++){s+=(h[z]*1);}m=[s];}if(H){var h=this.getComponentValue(H);var s=0;for(z=0;z<h.length;z++){s+=(h[z]*1);}l=[s];}}else{if(I){if(I.getValue()){m=[I.getValue()];}}if(H){if(H.getValue()){l=[H.getValue()];}}}}}}if(G&&G.isVisible()&&G.checked){if(n==ECM.Rules.Constants.TYPES.SUBSCRIPTION||n==ECM.Rules.Constants.TYPES.ASSOCIATIVE||n>ECM.Rules.Constants.TYPES.ZIP){m.push(I.nullDisplayValue||"");}}if(b&&c&&c!=-1){if(c==55||c==56){l=m.slice(0,m.length);c=c==55?75:76;}if(c==57||c==58){l=m.slice(0,m.length);c=c==57?77:78;}B.columnId=b;B.operatorId=c;B.operands=[m,l];B.switchToAdvanced=dcForm.switchToAdvancedRequested;B.forceChangeField=dcForm.changeAllFieldsRequested;dcForm.lastAddedRuleField=g;}else{if(!c||c==-1){B.error={msg:"Missing Data",target:"oper"};}else{B.error={msg:"Missing Data",target:"value"};}}}else{B.error={msg:"Invalid field",target:"field"};}}if(!B.error&&!dcForm.validDescription()){B.error={msg:"Invalid Description",target:"desc"};}if(n==ECM.Rules.Constants.TYPES.BEHAVIOR){B.operator=B.operands[0][0]==1?31:30;}return B;},validDescription:function(){var a=Ext.getCmp("desc");if(!a){return true;}if(dcForm.isSimpleMode&&!dcForm.switchToAdvancedRequested){a.fireEvent("change",a,a.getValue()||Ext.getCmp("value0").getValue());return true;}else{return !!a.getValue();}},getSelectedListboxItems:function(f){var g=[];var d=f.view.getSelectedRecords()||[];for(var c=0,a=d.length;c<a;c++){var b=d[c].data.text;if(b){g.push(b);}}return g;},getSelectedItems:function(o,m,a,k){var f=[];var l=m.data.items||[];var b=-1;for(var g=0,h=o.length;g<h;g++){for(var d=0,c=l.length;d<c;d++){if(o[g]==l[d].data.value||o[g]==l[d].data.text){if(a){f.push(l[d].data.value);}else{var n=l[d].data.text;if(k){n+=" ("+l[d].data.value+")";}f.push(n);}break;}else{if(o[g]==""){f.push("");break;}}}}return f;},getColumnInfoFromId:function(c){var a={};var b=__catalog__.columns[ECM.Rules.Constants.IDX.COLUMN];if(c){a.value=c;a.text=b[c][0];a.type=b[c][1];a.table=b[c][2];}return a;},getListDataFromStore:function(j,f,d){var g=[],a,b,h;if(j&&j.data){a=j.data.items||[];for(var c=0;c<a.length;c++){h=a[c].data.text;if(f){h+=" ("+a[c].data.value+")";}b=[a[c].data.value,h,!!a[c].json[2]?a[c].json[2]:"D",!!a[c].json[1]?a[c].json[1]:2];g.push(b);}}return g;},resetAll:function(){var a={sourceTreeNode:{},condition:{},columnData:{},operatorData:{},associativeData:{},dialog:{},currentFieldValue:"",currentFieldType:"",promptOnHide:true,lastAddedRuleField:"",switchToAdvancedRequested:false,changeAllFieldsRequested:false,fieldIsSelectable:true,operatorIsSelectable:true,isSimpleMode:false,isEditMode:false,isMailingEbm:false,displaySwitchToAdvancedModal:false,hasNoValueOption:false,isNoValueSelected:false};return Ext.apply(dcForm,a);}});ECM.Adapter.override(Ext.form.CheckboxGroup,{onRender:function(j,g){if(!this.el){var p={autoEl:{id:this.id},cls:this.groupCls,layout:"column",renderTo:j,bufferResize:false};var a={xtype:"container",defaultType:this.defaultType,layout:"form",defaults:{hideLabel:true,anchor:"100%"}};
if(this.items[0]&&this.items[0].items){Ext.apply(p,{layoutConfig:{columns:this.items.length},defaults:this.defaults,items:this.items});for(var f=0,m=this.items.length;f<m;f++){Ext.applyIf(this.items[f],a);}}else{var d,n=[];if(typeof this.columns=="string"){this.columns=this.items.length;}if(!Ext.isArray(this.columns)){var k=[];for(var f=0;f<this.columns;f++){k.push((100/this.columns)*0.01);}this.columns=k;d=this.columns.length;for(var f=0;f<d;f++){var b=Ext.apply({items:[]},a);b[this.columns[f]<=1?"columnWidth":"width"]=this.columns[f];if(this.defaults){b.defaults=Ext.apply(b.defaults||{},this.defaults);}n.push(b);}if(this.vertical){var r=Math.ceil(this.items.length/d),o=0;for(var f=0,m=this.items.length;f<m;f++){if(f>0&&f%r==0){o++;}if(this.items[f].fieldLabel){this.items[f].hideLabel=false;}n[o].items.push(this.items[f]);}}else{for(var f=0,m=this.items.length;f<m;f++){var q=f%d;if(this.items[f].fieldLabel){this.items[f].hideLabel=false;}n[q].items.push(this.items[f]);}}Ext.apply(p,{layoutConfig:{columns:d},items:n});}this.panel=new Ext.Container(p);this.panel.ownerCt=this;this.el=this.panel.getEl();if(this.forId&&this.itemCls){var c=this.el.up(this.itemCls).child("label",true);if(c){c.setAttribute("htmlFor",this.forId);}}var h=this.panel.findBy(function(l){return l.isFormField;},this);this.items=new Ext.util.MixedCollection();this.items.addAll(h);}Ext.form.CheckboxGroup.superclass.onRender.call(this,j,g);}}});ECM.subscribe("dynamic_content_destroyed",dcForm.resetAll.createDelegate(dcForm));ECM.provide("ECM.Rules.Form.Operators");ECM.Rules.Form.Operators.Order={enumList:[83,84],string:[23,24,25,27,29,31,33,35,37,39,45,47,49,51,41,43],numeric:[23,24,25,27,29,31,33,35,45,47,49,51],date:[63,53,54,59,61,65,67,69,71,73,55,57,75,77],datetime:[63,53,54,59,61,65,67,69,71,73,55,57,75,77],zipcode:[91,87,89,95,93,107,111,99,103,85,97,109,113,101,105,86],bitmask:[135,136,137,139,141,143],subscription:[83,84,128],behavior:[]};var globs={};Ext.ns("ECM.Form");ECM.provide("ECM.Form.RelativeDate");(function(){var N_YEARS_FROM_NOW=0,ONE_YEAR_FROM_NOW=1,N_MONTHS_FROM_NOW=3,ONE_MONTH_FROM_NOW=4,N_WEEKS_FROM_NOW=6,ONE_WEEK_FROM_NOW=7,N_DAYS_FROM_NOW=8,THREE_DAYS_AGO=15,N_DAYS_AGO=16,ONE_WEEK_AGO=25,N_WEEKS_AGO=26,ONE_MONTH_AGO=29,N_MONTHS_AGO=30,ONE_YEAR_AGO=35,N_YEARS_AGO=36;var translate_relative={16:["days","-"],26:["weeks","-"],30:["months","-"],8:["days","+"],6:["weeks","+"],3:["months","+"],0:["years","+"],36:["years","-"]};var supportedTypes={relations:[["+","From Now"],["-","Ago"]],units:["Days","Weeks","Months","Years"]};ECM.Form.RelativeDate=Ext.extend(Ext.form.Field,{cls:"relative_date",defaultAutoCreate:{tag:"div"},getValue:function(){if(this.intValue&&this.units&&this.relation){var rel=this.relation.getValue()==="+"?"FROM_NOW":"AGO";var unitsToUpper=this.units.getValue().toUpperCase();var relDate="N_"+unitsToUpper+"_"+rel;return[eval(relDate),this.intValue.getValue()];}return[N_DAYS_FROM_NOW,""];},afterRender:function(){ECM.Form.RelativeDate.superclass.afterRender.call(this);var el=this.el;var obj=this;if(!obj.value){obj.value=obj.getValue();}var val_arr=translate_relative[this.value[0]];if(val_arr){val_arr=val_arr.slice(0,val_arr.length);val_arr.unshift(this.value[1]);}var myPanel=new Ext.Panel({layout:"column",border:false,defaults:{xtype:"panel",border:false,width:96},items:[{xtype:"textfield",allowBlank:false,width:100,cls:"relative_date_input",value:Ext.isArray(val_arr)?val_arr[0]:"",style:"margin-right: 4px",regex:new RegExp("^[0-9]+$"),invalidText:gt.gettext("Please enter a numeric value"),enableKeyEvents:true,listeners:{afterRender:function(){this.clearInvalid();obj.intValue=this;},keyup:function(){ECM.publish("valueChanged");}}},{xtype:"combo",value:Ext.isArray(val_arr)?val_arr[1]:"",store:supportedTypes.units.map(function(a,i){return[a.toLowerCase(),a];}),editable:false,forceSelection:false,triggerAction:"all",listeners:{afterRender:function(){this.getEl().dom.parentNode.style.marginRight="4px";obj.units=this;}}},{xtype:"combo",value:Ext.isArray(val_arr)?val_arr[2]:"",store:supportedTypes.relations,editable:false,forceSelection:false,triggerAction:"all",listeners:{afterRender:function(){obj.relation=this;}}},{width:4}]});myPanel.render(el);}});Ext.reg("ecm.relativeDate",ECM.Form.RelativeDate);ECM.Form.RelativeDate.isRelativeDateType=function(typ){var validTypes=[N_YEARS_FROM_NOW,ONE_YEAR_FROM_NOW,N_MONTHS_FROM_NOW,ONE_MONTH_FROM_NOW,N_WEEKS_FROM_NOW,ONE_WEEK_FROM_NOW,N_DAYS_FROM_NOW,THREE_DAYS_AGO,N_DAYS_AGO,ONE_WEEK_AGO,N_WEEKS_AGO,ONE_MONTH_AGO,N_MONTHS_AGO,ONE_YEAR_AGO,N_YEARS_AGO];for(var i=0;i<validTypes.length;i++){if(validTypes[i]==typ){return true;}}return false;};ECM.Form.RelativeDate.convertDeprecated=function(vals){var deprecatedTypes={ONE_YEAR_FROM_NOW:function(val){return[N_YEARS_FROM_NOW,1];},ONE_MONTH_FROM_NOW:function(val){return[N_MONTHS_FROM_NOW,1];},ONE_WEEK_FROM_NOW:function(val){return[N_WEEKS_FROM_NOW,1];},THREE_DAYS_AGO:function(val){return[N_DAYS_AGO,3];},ONE_WEEK_AGO:function(val){return[N_WEEKS_AGO,1];},ONE_MONTH_AGO:function(val){return[N_MONTHS_AGO,1];},ONE_YEAR_AGO:function(val){return[N_YEARS_AGO,1];}};for(var i in deprecatedTypes){deprecatedTypes[eval(i)]=deprecatedTypes[i];}if(deprecatedTypes[vals[0]]){return deprecatedTypes[vals[0]]();}else{return vals;}};})();Ext.ns("ECM.Form");ECM.provide("ECM.Form.MonthDay");(function(){ECM.Form.MonthDay=Ext.extend(Ext.form.Field,{defaultAutoCreate:{tag:"div"},months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sept","Oct","Nov","Dec"],getValue:function(){if(this.monthCb){var a=[this.months.indexOf(this.monthCb.getValue())+1,this.daysCb.getValue()];for(var b=0;b<a.length;b++){if(a[b]<10){a[b]="0"+parseInt(a[b]);}}return a.join(" ");}else{return ECM.Form.MonthDay.superclass.getValue.call(this);}},getNumberOfDays:function(h){var a=new Date();var b=a.getFullYear();var f=new Date(b,this.months.indexOf(h),1);var d=f.getDaysInMonth();var g=[];for(var c=0;c<d;c++){g[c]=c+1;}return g;},afterRender:function(){ECM.Form.MonthDay.superclass.afterRender.apply(this,arguments);var c=this;var b=this.el;var a=[1,1];if(this.value){a=this.value.split(" ");}a[0]=this.months[(a[0]-1)];var f=this.getNumberOfDays(a[0]);var d=new Ext.Panel({layout:"column",border:false,width:94,defaults:{xtype:"panel",border:false,width:90},items:[{xtype:"combo",value:a[0],width:50,listWidth:50,editable:false,forceSelection:false,triggerAction:"all",store:this.months,listeners:{afterRender:function(){c.monthCb=this;},select:function(){var g=c.getNumberOfDays(this.getValue());c.daysCb.store.loadData(g);if(c.daysCb.getValue()>g.length){c.daysCb.setValue(g.length);}}}},{xtype:"label",width:4,html:"&nbsp;"},{xtype:"combo",editable:false,forceSelection:false,triggerAction:"all",width:40,listWidth:40,value:a[1],store:f,listeners:{afterRender:function(){c.daysCb=this;}}}]});d.render(b);return this;}});Ext.reg("ecm.monthday",ECM.Form.MonthDay);})();var globs={};Ext.ns("ECM.Form");ECM.provide("ECM.Form.EventDate");(function(){var w=0,K=1,y=2,j=3,J=4,f=5,g=6,F=7,R=8,q=9,t=10,H=11,E=12,k=13,B=14,b=15,L=16,d=17,h=18,S=19,a=20,D=21,M=22,T=23,v=24,U=25,Q=26,N=27,p=28,z=29,s=30,x=31,A=32,m=33,o=34,c=35,r=36;var u={"Exact Date":H,"Last day~of this year":y,"Last day~of this month":f,"First day~of this year":x,"First day~of this month":N,"Day number~of this year":A,"Day number~of this month":p,"Day number~of this week":v,"Month/Day":m,Sunday:T,Monday:M,Tuesday:D,Wednesday:a,Thursday:S,Friday:h,Saturday:d,Today:t,Yesterday:B,Tomorrow:q};var G=["of this week"];var n=["of this month","of this year"];var O=["of this week","of this month","of this year"];var P=["of this year"];var V=[];var l=[["Today",V],["Yesterday",V],["Tomorrow",V],["First day",n],["Last day",n],["Day #",O,{xtype:"textfield",width:50,style:"margin-left: 4px;",allowBlank:false,regex:new RegExp("^[0-9]+$"),regexText:"Please enter a numeric value",cls:"ecm-date-daynum"}],["Month/Day",P,{xtype:"ecm.monthday",style:"margin-left: 4px"}],["Exact Date",H,{xtype:"ecm.datefield",width:132,cls:"ecm-date-exact",regex:new RegExp("^[0-9]{2}/[0-9]{2}/[0-9]{4}$"),regexText:"Please enter a valid date in the form mm/dd/yyyy",invalidText:"Please enter a valid date in the form mm/dd/yyyy",listeners:{afterrender:function(){this.wrap.dom.style.marginLeft="4px";
Date.useStrict=true;}}}],["Sunday",G],["Monday",G],["Tuesday",G],["Wednesday",G],["Thursday",G],["Friday",G],["Saturday",G]];var I=function(W){var X=[];for(var Y in u){if(u[Y]==W){X=Y.split("~");break;}}if(X[0]){X[0]=X[0].replace("number","#");}var Z=[];for(var Y=0;Y<l.length;Y++){if(X[0]==l[Y][0]){X[0]=Y;Z=l[Y][1];break;}}for(var Y=0;Y<Z.length;Y++){if(Z[Y]==X[1]){X[1]=Y;break;}}return X;};ECM.Form.DateField=ECM.Adapter.extend(Ext.form.DateField,{altFormats:Ext.form.DateField.prototype.altFormats+"|j",initComponent:function(){if(this.value){this.value=new Date(this.value.replace(/\s/g,"/","g"));}return ECM.Form.DateField.superclass.initComponent.apply(this,arguments);},listeners:{valid:function(){ECM.publish("valueChanged");}},getValue:function(Z){var X=ECM.Form.DateField.superclass.getValue.call(this);if(!Z){return X;}if(X){var Y=function(ac){if(ac<10){return"0"+ac;}return ac;};var ab=X.format("Y");var W=Y(X.getDate());var aa=Y(X.getMonth()+1);return[aa,W,ab].join(" ");}else{return;}}});Ext.reg("ecm.datefield",ECM.Form.DateField);ECM.Form.EventDate=Ext.extend(Ext.form.Field,{valueObj:{},defaultAutoCreate:{tag:"div"},getValue:function(){var aa;if(!this.eventType){return[t];}var X=l[this.eventType.getValue()][0];X=X.replace("#","number");var Y=l[this.eventType.getValue()][1];aa=X+(this.valueObj.unitCmp?"~"+Y[this.valueObj.unitCmp.getValue()]:"");aa=u[aa];var W=[aa];switch(aa){case m:var Z=this.valueObj.intValue.getValue();W.push(Z);break;case A:case p:case v:case H:W.push(this.valueObj.intValue.getValue(1));break;default:}return W;},afterRender:function(){ECM.Form.EventDate.superclass.afterRender.call(this);Ext.getCmp(this.el.findParent(".x-panel").id).setWidth("auto");var X=this.el;var Y=this;if(!this.value){this.value=this.getValue();}var W=I(this.value[0]);var Z=new Ext.Panel({layout:"column",border:false,columns:3,defaults:{xtype:"panel",border:false},items:[{xtype:"combo",value:W[0],width:90,store:l.map(function(aa,ab){return[ab,aa[0]];}),editable:false,forceSelection:false,triggerAction:"all",listeners:{select:function(){Y.valueObj={eventType:this};Y.unitsContainer.removeAll();Y.inputContainer.removeAll();if(l[this.getValue()][2]){var ae={};var af=l[this.getValue()][2];for(var ad in af){ae[ad]=af[ad];}if(!this.initialized){if(ae.cls=="ecm-date-daynum"&&String(Y.value[1]).match(/^\d\d:\d\d$/)){ae.value="";}else{ae.value=Y.value[1];}this.initialized=true;}Y.valueObj.intValue=Y.inputContainer.add(ae);}if(l[this.getValue()][1].length>0){var ac="";if(l[this.getValue()][1].length==1){ac={xtype:"component",style:"padding-top: 3px;margin-left: 4px",html:l[this.getValue()][1][0]};}else{ac={xtype:"combo",value:W[1]||0,width:100,store:l[this.getValue()][1].map(function(ag,ah){return[ah,ag];}),editable:false,forceSelection:false,triggerAction:"all",listeners:{afterrender:function(){this.wrap.dom.style.marginLeft="4px";}}};W[1]=0;}var aa=Y.unitsContainer.add(ac);if(aa.getValue){Y.valueObj.unitCmp=aa;aa.on("select",function(){ECM.publish("valueChanged");});}}Y.inputContainer.doLayout();Y.unitsContainer.doLayout();var ab=Y.inputContainer.el.query("input");if(ab.length){Ext.fly(ab[0]).on("keyup",function(){ECM.publish("valueChanged");});}Y.getEl().dom.firstChild.firstChild.firstChild.firstChild.style.width="auto";ECM.publish("valueChanged");},afterRender:function(){Y.eventType=this;ECM.publish("valueChanged");}}},{autoEl:"span",cls:"ecm-date-input-container",listeners:{afterRender:function(){Y.inputContainer=this;}}},{autoEl:"span",cls:"ecm-date-units-container",style:"margin-right:4px;",listeners:{afterRender:function(){Y.unitsContainer=this;}}}]});Z.render(X);Y.eventType.fireEvent("select");}});Ext.reg("ecm.eventDate",ECM.Form.EventDate);ECM.Form.EventDate.isEventType=function(X){var W=[H,y,f,q,t,B,d,h,S,a,D,M,T,v,N,p,x,A,m,o];for(var Y=0;Y<W.length;Y++){if(W[Y]==X){return true;}}return false;};ECM.Form.EventDate.convertDeprecated=function(X){var W={};if(X[0]==o){X[1]=X[1].split(" ").reverse().join(" ");}return X;};})();ECM.provide("ECM.Form.ModeSwitcher");Ext.ns("ECM.Form");(function(){ECM.Form.ModeSwitcher=Ext.extend(Ext.form.Field,{defaultAutoCreate:{tag:"div",width:400,height:400},initComponent:function(){this.addEvents("select");},items:[{text:"Calendar",iconCls:"cal-mode-img-calendar"},{text:"Relative",iconCls:"cal-mode-img-relative"},{text:"Event",iconCls:"cal-mode-img-event"}],afterRender:function(){if(Ext.isDefined(this.value)&&Ext.isObject(this.getFirst(this.items,"text",this.value))){this.setValue(this.value);}else{this.setValue(this.items[0].text);}ECM.Form.ModeSwitcher.superclass.afterRender.call(this);var c=this.el;var d=this;var f=new Ext.menu.Menu({cls:"ecm-mode-switcher-menu"});for(var b=0;b<this.items.length;b++){f.addItem(new Ext.menu.Item({text:this.items[b].text,iconCls:this.items[b].iconCls,handler:this.modeSelect,scope:d}));}var a=new Ext.Panel({border:false,items:[{xtype:"button",iconCls:"mode-btn "+this.iconCls,menu:f}]});a.render(c);},setValue:function(d){if(this.getValue()!=d){var a=Ext.select("div#"+this.id+" .mode-btn");var c=this;var b=this.getFirst(this.items,"text",d);if(Ext.isObject(b)){this.value=d;if(this.rendered){this.el.dom.value=(Ext.isEmpty(d)?"":d);this.validate();}a.removeClass(c.iconCls);c.iconCls=b.iconCls;a.addClass(c.iconCls);return"Mode Set: "+d;}else{return"Invalid Mode. No action taken";}}else{return d+" mode already set. No action taken.";}},modeSelect:function(a){this.setValue(a.text);this.fireEvent("select");},getFirst:function(d,c,b){for(var a=0;a<d.length;a++){if(d[a][c]==b){return d[a];}}return false;}});Ext.reg("ecm.modeSwitcher",ECM.Form.ModeSwitcher);})();ECM.provide("ECM.Form.DateControl");(function(){var a=11;ECM.Form.DateControl=ECM.Adapter.extend(Ext.form.Field,{defaultAutoCreate:{tag:"div"},getMainPanel:function(){this.operand=this.value;this.date_xtype="ecm.eventDate";this.date_type="Event";this.item_value=false;if(this.operand&&this.operand.length>1){this.setWidth=undefined;if(ECM.Form.EventDate.isEventType(this.operand[0])){this.item_value=ECM.Form.EventDate.convertDeprecated(this.operand);if(this.operand[1]&&this.operand[1].replace){this.operand=this.operand[1].replace(/\s/,"/");}}else{if(ECM.Form.RelativeDate.isRelativeDateType(this.operand[0])){this.date_type="Relative";this.date_xtype="ecm.relativeDate";this.item_value=ECM.Form.RelativeDate.convertDeprecated(this.operand);}}}else{if(this.operand&&ECM.Form.EventDate.isEventType(this.operand[0])){this.item_value=ECM.Form.EventDate.convertDeprecated(this.operand);}}var g=this;var b={xtype:this.date_xtype,idNum:this.idNum,width:this.setWidth,allowBlank:false,invalidText:"A valid date must be specified (mm/dd/yyyy).",value:this.item_value?this.item_value:undefined,listeners:{afterRender:function(){g.currentDateField=this;}}};var f=[[null,gt.gettext("Anytime")]];for(var c=0;c<24;c++){c=c<10?"0"+c:c;for(var d=0;d<60;d=Number(d)+5){d=d<10?"0"+d:d;f.push([c+":"+d,c+":"+d]);}}var h=gt.gettext("Use Relative Date");var l=gt.gettext("Use Absolute Date");var k=new Ext.Panel({layout:"column",border:false,cls:"date_control",items:Ext.clean([{xtype:"panel",border:false,listeners:{afterrender:function(){g.panel=this;}},items:[b]},{xtype:"combo",id:"ecm-event-time-combo"+this.idNum,width:80,store:f,value:String(this.item_value[this.item_value.length-1]).match(/^\d\d:\d\d$/)?this.item_value[this.item_value.length-1]:null,hidden:Number(this.columnType)!==ECM.Rules.Constants.TYPES.DATETIME,triggerAction:"all"},{xtype:"button",text:h,cls:"ecm-toggle-text-button",value:this.date_type,listeners:{afterrender:function(j){j.setText(g.date_type=="Event"?h:l);},click:function(m,o){var n={event:"ecm.eventDate",relative:"ecm.relativeDate"};g.date_type=g.date_type=="Event"?"Relative":"Event";m.setText(g.date_type=="Event"?h:l);g.panel.removeAll();var j={xtype:n[g.date_type.toLowerCase()]};g.currentDateField=g.panel.add(j);g.panel.doLayout();}}}])});return k;},afterRender:function(){ECM.Form.DateControl.superclass.afterRender.call(this);this.renderPanel();},isValid:function(){return dcForm.validateDateVals(this);
},renderPanel:function(){this.mainPanel=this.getMainPanel();this.mainPanel.render(this.el);},setValue:function(b){this.value=b;if(this.mainPanel){this.mainPanel.destroy();this.renderPanel();}},getValue:function(b){if(this.currentDateField&&this.currentDateField.getValue){var c=this.currentDateField.getValue(b);if(Ext.getCmp("ecm-event-time-combo"+this.idNum).getValue()){c.push(Ext.getCmp("ecm-event-time-combo"+this.idNum).getValue());}return c;}else{return undefined;}}});Ext.reg("ecm.dateControl",ECM.Form.DateControl);})();ECM.provide("ECM.Rules.Form.Date");(function(){ECM.Rules.Form.Date=function(b){ECM.Rules.Form.Date.superclass.constructor.call(this);this.operand=b;};var a=0;ECM.Adapter.extend(ECM.Rules.Form.Date,Object,{getConfigurationHash:function(){return{xtype:"ecm.dateControl",value:this.operand,fieldLabel:"Value",id:"value"+a++};}});})();Ext.ns("ECM.Form");ECM.provide("ECM.Form.BitField");(function(){var a="text";ECM.Form.BitField=Ext.extend(Ext.ux.form.MultiSelect,{setValue:function(c){this.value=c||0;if(this.rendered){var f=[];var b=0;for(var d=1;d<=c;d+=d){if((c&d)>0){f.push(d);}}ECM.Form.BitField.superclass.setValue.call(this,f);}},getValue:function(){var d=ECM.Form.BitField.superclass.getValue.call(this);d=d.split(",");var c=0;for(var b=0;b<d.length;b++){c+=parseInt(d[b]);}return c;},initComponent:function(){var b=[];var c=this.value;if(this.store){this.store.each(function(d){var f=d.get("value");var g=(1&(c>>f))==1;b.push([Math.pow(2,f),(d.get(a))]);});}this.store=b;ECM.Form.BitField.superclass.initComponent.apply(this,arguments);this.setValue(c);}});Ext.reg("ecm.bitfield",ECM.Form.BitField);})();ECM.provide("ECM.Form.CityState");Ext.ns("ECM.Form");(function(){ECM.Form.CityState=ECM.Adapter.extend(Ext.form.Field,{defaultAutoCreate:{tag:"div"},initialized:false,buildCityStatePanel:function(){var c=[],g,b=this;if(this.stateStore){if(this.stateStore.data){for(var f=0,d=this.stateStore.data.items.length;f<d;f++){var k=this.stateStore.data.items[f].data;c.push([k.value,k.text+" ("+k.value+")"]);}}else{for(var f=0,d=this.stateStore.length;f<d;f++){c.push([this.stateStore[f][0],this.stateStore[f][1]+" ("+this.stateStore[f][0]+")"]);}}}var h={xtype:"multiselect",id:"cityStateState",region:"center",allowBlank:false,width:300,minSelections:1,store:c,listeners:{click:function(o,q){var n=this.getValue().split(","),p=Ext.get("cityStateState");if(!Ext.get("loadCont")){var m=document.createElement("img");m.src="/images/blue_loading.gif";var l=document.createElement("div");l.id="loadCont";l.style.padding="20px";l.style.textAlign="center";l.style.width="300px";l.appendChild(m);setTimeout(function(){p.dom.parentNode.appendChild(l);},50);}else{Ext.getDom("loadCont").style.display="block";}if(Ext.get("cityStateCity")){Ext.getDom("cityStateCity").style.display="none";}var j=ECM.Ajax.request({url:"/cm/r/dynamic_content/cities",params:{state:n},method:"GET",success:function(s,v){var x=s.responseJSON.data,y=null,r=Ext.getDom("loadCont");r.style.display="none";if(n.length>=1){if(Ext.get("cityStateCity")){var A=Ext.getDom("cityStateCity");A.parentNode.removeChild(A);}var z=document.createElement("select");z.setAttribute("id","cityStateCity");z.setAttribute("multiple","multiple");z.setAttribute("size","6");Ext.getDom("cityStateState").parentNode.appendChild(z);var u=Ext.get("cityStateCity");u.dom.style.marginTop="4px";u.dom.style.fontSize="11px";u.dom.style.fontFamily="Arial, Tahoma, Helvetica, sans-serif";for(var w=0,t=x.length;w<t;w++){y=document.createElement("option");y.value=x[w];y.innerHTML=(n.length===1?x[w].replace(/,.*$/,""):x[w]);u.dom.appendChild(y);}u.dom.style.display="block";u.dom.style.visibility="visible";Ext.each(u.query("option"),function(D,B){Ext.get(D).on("mousedown",function(F,E){E.selected=(E.selected?false:true);F.stopEvent();return false;});});if(ECM.Adapter.isFunction(q)){q();}}},failure:function(r,s){dcForm.dialog.notify.error("Server request failed");}});},afterrender:function(j,l){if(!b.initialized){b.setValue(b.value);b.initialized=true;}}}};var a=new Ext.Panel({border:false,width:300,items:[h]});return a;},afterRender:function(){ECM.Form.CityState.superclass.afterRender.call(this);this.renderPanel();},renderPanel:function(){this.cityStatePanel=this.buildCityStatePanel();this.cityStatePanel.render(this.el);},setValue:function(g){if(!ECM.Adapter.isArray(g)){return;}var k=[];for(var c=0,f=g.length;c<f;c++){var d=g[c]?g[c].split(","):"";var a=d.length===2?d[d.length-1].replace(" ",""):"";if(a!==""&&k.indexOf(a)===-1){k.push(a);}}var j=function(){var l=[];Ext.each(g,function(n,p){l=Ext.query("#cityStateCity option");for(var o=0,m=l.length;o<m;o++){if(l[o].value===n){l[o].selected=true;break;}}});};var b=Ext.getCmp("cityStateState");var h=Ext.get("cityStateState");if(h&&b&&k.length){b.setValue(k);b.fireEvent("click",b,j);}},getValue:function(){var a=Ext.query("#cityStateCity option"),b=[];Ext.each(a,function(d,c){if(d.selected){b.push(d.value);}});return b;},isValid:function(){return true;}});Ext.reg("ecm.citystate",ECM.Form.CityState);})();Ext.ns("ECM.Form");ECM.provide("ECM.Form.RangeOf");(function(){ECM.Form.RangeOf=Ext.extend(Ext.form.Field,{defaultAutoCreate:{tag:"div"},enableKeyEvents:true,getValue:function(){if(this.from){return[this.from.getValue(),this.to.getValue()];}else{return ECM.Form.RangeOf.superclass.getValue.call(this);}},initComponent:function(){ECM.Form.RangeOf.superclass.initComponent.call(this);this.addEvents("keydown","keyup","keypress");},initEvents:function(){ECM.Form.RangeOf.superclass.initEvents.call(this);this.mon(this.el,{scope:this,keyup:this.onKeyUp,keydown:this.onKeyDown,keypress:this.onKeyPress});},onKeyUp:function(a){this.fireEvent("keyup",this,a);},onKeyDown:function(a){this.fireEvent("keydown",this,a);},onKeyPress:function(a){this.fireEvent("keypress",this,a);},afterRender:function(){ECM.Form.RangeOf.superclass.afterRender.apply(this,arguments);var d=this;var c=gt.gettext("Please enter a valid whole integer for nth-ing parts");var b=this.el;var a=["",""];if(this.value){a=this.value;}var f=new Ext.Panel({layout:"column",border:false,defaults:{border:false},items:[{xtype:"textfield",maskRe:/^[0-9-,]+$/,invalidText:c,validator:function(h){var g=h.split(",");var j=false;Ext.each(g,function(k){if(k.match(/^\d+$/)||k.match(/^\d+-\d+$/)){j=true;}else{j=false;return false;}});return j;},value:a[0],width:40,allowBlank:false,listeners:{afterRender:function(){d.from=this;}}},{xtype:"label",html:" of ",style:"margin: 4px"},{xtype:"textfield",maskRe:/^[0-9]+$/,invalidText:c,validator:function(g){return !!g.match(/^\d+$/);},width:40,value:a[1],allowBlank:false,listeners:{afterRender:function(){d.to=this;}}}]});f.render(b);return this;},isValid:function(a){a=(typeof a=="undefined")?false:a;return(this.from.isValid(a)&&this.to.isValid(a));}});Ext.reg("ecm.rangeof",ECM.Form.RangeOf);})();Ext.ns("Ext.ux.data");Ext.ux.data.PagingStore=Ext.extend(Ext.data.Store,{add:function(b){b=[].concat(b);if(b.length<1){return;}for(var d=0,a=b.length;d<a;d++){b[d].join(this);}var c=this.data.length;this.data.addAll(b);if(this.allData){this.allData.addAll(b);}if(this.snapshot){this.snapshot.addAll(b);}this.totalLength+=b.length;this.fireEvent("add",this,b,c);},remove:function(a){if(Ext.isArray(a)){Ext.each(a,function(c){this.remove(c);},this);return;}if(this!=a.store){return;}a.join(null);var b=this.data.indexOf(a);if(b>-1){this.data.removeAt(b);}if(this.pruneModifiedRecords){this.modified.remove(a);}if(this.allData){this.allData.remove(a);}if(this.snapshot){this.snapshot.remove(a);}this.totalLength--;if(b>-1){this.fireEvent("remove",this,a,b);}},removeAll:function(b){var a=[].concat((this.snapshot||this.allData||this.data).items);this.clearData();if(this.pruneModifiedRecords){this.modified=[];}this.totalLength=0;if(b!==true){this.fireEvent("clear",this,a);}},insert:function(c,b){b=[].concat(b);for(var d=0,a=b.length;d<a;d++){this.data.insert(c,b[d]);b[d].join(this);}if(this.allData){this.allData.addAll(b);}if(this.snapshot){this.snapshot.addAll(b);
}this.totalLength+=b.length;this.fireEvent("add",this,b,c);},getById:function(a){return(this.snapshot||this.allData||this.data).key(a);},clearData:function(){if(this.allData){this.data=this.allData;delete this.allData;}if(this.snapshot){this.data=this.snapshot;delete this.snapshot;}this.data.each(function(a){a.join(null);});this.data.clear();},execute:function(f,a,c,b){if(!Ext.data.Api.isAction(f)){throw new Ext.data.Api.Error("execute",f);}c=Ext.applyIf(c||{},{params:{}});if(b!==undefined){this.addToBatch(b);}var d=true;if(f==="read"){d=this.fireEvent("beforeload",this,c);Ext.applyIf(c.params,this.baseParams);}else{if(this.writer.listful===true&&this.restful!==true){a=(Ext.isArray(a))?a:[a];}else{if(Ext.isArray(a)&&a.length==1){a=a.shift();}}if((d=this.fireEvent("beforewrite",this,f,a,c))!==false){this.writer.apply(c.params,this.baseParams,f,a);}}if(d!==false){if(this.writer&&this.proxy.url&&!this.proxy.restful&&!Ext.data.Api.hasUniqueUrl(this.proxy,f)){c.params.xaction=f;}if(f==="read"&&this.isPaging(Ext.apply({},c.params))){(function(){if(this.allData){this.data=this.allData;delete this.allData;}this.applyPaging();this.fireEvent("datachanged",this);var g=[].concat(this.data.items);this.fireEvent("load",this,g,c);if(c.callback){c.callback.call(c.scope||this,g,c,true);}}).defer(1,this);return true;}this.proxy.request(Ext.data.Api.actions[f],a,c.params,this.reader,this.createCallback(f,a,b),this,c);}return d;},loadRecords:function(h,b,g){if(this.isDestroyed===true){return;}if(!h||g===false){if(g!==false){this.fireEvent("load",this,[],b);}if(b.callback){b.callback.call(b.scope||this,[],b,false,h);}return;}var f=h.records,d=h.totalRecords||f.length;if(!b||b.add!==true){if(this.pruneModifiedRecords){this.modified=[];}for(var c=0,a=f.length;c<a;c++){f[c].join(this);}this.clearData();this.data.addAll(f);this.totalLength=d;this.applySort();if(!this.allData){this.applyPaging();}if(f.length>this.getCount()){f=[].concat(this.data.items);}this.fireEvent("datachanged",this);}else{this.totalLength=Math.max(d,this.data.length+f.length);this.add(f);}this.fireEvent("load",this,f,b);if(b.callback){b.callback.call(b.scope||this,f,b,true);}},loadData:function(c,a){if(this.isPaging){this.isPaging(Ext.apply({},this.lastOptions?this.lastOptions.params:null,this.baseParams));}var b=this.reader.readRecords(c);this.loadRecords(b,{add:a},true);},getTotalCount:function(){if(this.allData){return this.allData.getCount();}return this.totalLength||0;},sortData:function(){var a=this.hasMultiSort?this.multiSortInfo:this.sortInfo,k=a.direction||"ASC",h=a.sorters,c=[];if(!this.hasMultiSort){h=[{direction:k,field:a.field}];}for(var d=0,b=h.length;d<b;d++){c.push(this.createSortFunction(h[d].field,h[d].direction));}if(!c.length){return;}var g=k.toUpperCase()=="DESC"?-1:1;var f=function(n,m){var l=c[0].call(this,n,m);if(c.length>1){for(var p=1,o=c.length;p<o;p++){l=l||c[p].call(this,n,m);}}return g*l;};if(this.allData){this.data=this.allData;delete this.allData;}this.data.sort(k,f);if(this.snapshot&&this.snapshot!=this.data){this.snapshot.sort(k,f);}this.applyPaging();},filterBy:function(b,a){this.snapshot=this.snapshot||this.allData||this.data;this.data=this.queryBy(b,a||this);this.applyPaging();this.fireEvent("datachanged",this);},clearFilter:function(a){if(this.isFiltered()){this.data=this.snapshot;delete this.snapshot;delete this.allData;this.applyPaging();if(a!==true){this.fireEvent("datachanged",this);}}},isFiltered:function(){return !!this.snapshot&&this.snapshot!=(this.allData||this.data);},queryBy:function(b,a){var c=this.snapshot||this.allData||this.data;return c.filterBy(b,a||this);},collect:function(j,k,b){var h=(b===true?this.snapshot||this.allData||this.data:this.data).items;var m,n,a=[],c={};for(var f=0,g=h.length;f<g;f++){m=h[f].data[j];n=String(m);if((k||!Ext.isEmpty(m))&&!c[n]){c[n]=true;a[a.length]=m;}}return a;},findInsertIndex:function(a){this.suspendEvents();var c=this.data.clone();this.data.add(a);this.applySort();var b=this.data.indexOf(a);this.data=c;this.totalLength--;this.resumeEvents();return b;},isPaging:function(f){var b=this.paramNames,g=f[b.start],a=f[b.limit];if((typeof g!="number")||(typeof a!="number")){delete this.start;delete this.limit;this.lastParams=f;return false;}this.start=g;this.limit=a;delete f[b.start];delete f[b.limit];var c=this.lastParams;this.lastParams=f;if(!this.proxy){return true;}if(!c){return false;}for(var d in f){if(f.hasOwnProperty(d)&&(f[d]!==c[d])){return false;}}for(d in c){if(c.hasOwnProperty(d)&&(f[d]!==c[d])){return false;}}return true;},applyPaging:function(){var j=this.start,b=this.limit;if((typeof j=="number")&&(typeof b=="number")){var f=this.data,g=new Ext.util.MixedCollection(f.allowFunctions,f.getKey);g.items=f.items.slice(j,j+b);g.keys=f.keys.slice(j,j+b);var a=g.length=g.items.length;var h={};for(var c=0;c<a;c++){var d=g.items[c];h[g.getKey(d)]=d;}g.map=h;this.allData=f;this.data=g;}}});Ext.ux.data.PagingDirectStore=Ext.extend(Ext.ux.data.PagingStore,{constructor:Ext.data.DirectStore.prototype.constructor});Ext.reg("pagingdirectstore",Ext.ux.data.PagingDirectStore);Ext.ux.data.PagingJsonStore=Ext.extend(Ext.ux.data.PagingStore,{constructor:Ext.data.JsonStore.prototype.constructor});Ext.reg("pagingjsonstore",Ext.ux.data.PagingJsonStore);Ext.ux.data.PagingXmlStore=Ext.extend(Ext.ux.data.PagingStore,{constructor:Ext.data.XmlStore.prototype.constructor});Ext.reg("pagingxmlstore",Ext.ux.data.PagingXmlStore);Ext.ux.data.PagingArrayStore=Ext.extend(Ext.ux.data.PagingStore,{constructor:function(){Ext.data.ArrayStore.prototype.constructor.apply(this,arguments);},loadData:function(f,b){if(this.expandData===true){var d=[];for(var c=0,a=f.length;c<a;c++){d[d.length]=[f[c]];}f=d;}Ext.ux.data.PagingArrayStore.superclass.loadData.call(this,f,b);}});Ext.reg("pagingarraystore",Ext.ux.data.PagingArrayStore);Ext.ux.data.PagingSimpleStore=Ext.ux.data.PagingArrayStore;Ext.reg("pagingsimplestore",Ext.ux.data.PagingSimpleStore);Ext.ux.data.PagingGroupingStore=Ext.extend(Ext.ux.data.PagingStore,Ext.copyTo({},Ext.data.GroupingStore.prototype,["constructor","remoteGroup","groupOnSort","groupDir","clearGrouping","groupBy","sort","applyGroupField","applyGrouping","getGroupState"]));Ext.reg("paginggroupingstore",Ext.ux.data.PagingGroupingStore);Ext.ux.PagingToolbar=Ext.extend(Ext.PagingToolbar,{onLoad:function(a,b,d){if(!this.rendered){this.dsLoaded=[a,b,d];return;}var c=this.getParams();this.cursor=(d.params&&d.params[c.start])?d.params[c.start]:0;this.onChange();},onChange:function(){var b=this.store.getTotalCount(),c=this.pageSize;if(this.cursor>=b){this.cursor=Math.ceil((b+1)/c)*c;}var g=this.getPageData(),a=g.activePage,f=g.pages;this.afterTextItem.setText(String.format(this.afterPageText,g.pages));this.inputItem.setValue(a);this.first.setDisabled(a==1);this.prev.setDisabled(a==1);this.next.setDisabled(a==f);this.last.setDisabled(a==f);this.refresh.enable();this.updateInfo();this.fireEvent("change",this,g);},onClear:function(){this.cursor=0;this.onChange();},doRefresh:function(){delete this.store.lastParams;this.doLoad(this.cursor);},bindStore:function(b,c){var a;if(!c&&this.store){if(b!==this.store&&this.store.autoDestroy){this.store.destroy();}else{this.store.un("beforeload",this.beforeLoad,this);this.store.un("load",this.onLoad,this);this.store.un("exception",this.onLoadError,this);this.store.un("datachanged",this.onChange,this);this.store.un("add",this.onChange,this);this.store.un("remove",this.onChange,this);this.store.un("clear",this.onClear,this);}if(!b){this.store=null;}}if(b){b=Ext.StoreMgr.lookup(b);b.on({scope:this,beforeload:this.beforeLoad,load:this.onLoad,exception:this.onLoadError,datachanged:this.onChange,add:this.onChange,remove:this.onChange,clear:this.onClear});a=true;}this.store=b;if(a){this.onLoad(b,null,{});}}});Ext.reg("ux.paging",Ext.ux.PagingToolbar);Ext.ns("ECM.Form");ECM.provide("ECM.Form.GridPicker");(function(){ECM.Form.GridPickerHelper={colRenderer:function(c,a,b){return'<div ext:qtip="'+c+'">'+c+"</div>";}};
ECM.Form.GridPicker=Ext.extend(Ext.grid.GridPanel,{cls:"ecm-gridpicker",customFilter:false,customFilterFields:null,bodyCssClass:"ecm-gridpicker-body",plugins:"ecm.searchcolumn",deferRowRender:false,enableColumnMove:false,enableColumnHide:false,constructor:function(x){var m=this;x.height=261;x.autoHeight=false;if(!Ext.isDefined(x.store)){throw"Must specify a data-store !";}x.checkBoxes=x.checkBoxes||!Ext.isDefined(x.selModel);if(!Ext.isDefined(x.filterBox)){x.filterBox={enable:true,filterDropdownInTitle:false,filterButtonInTitle:false};}else{if(!Ext.isDefined(x.filterBox.enable)){x.filterBox.enable=true;}}x.paging=Ext.isDefined(x.paging)?x.paging:!Ext.isDefined(x.tbar);if(x.paging){x.pageSize=x.pageSize||10;}this.keyField=x.keyField||"key";x.remotePage=x.remotePage||false;if(x.remotePage&&!x.loadMask){x.loadMask={msg:gt.gettext("Loading data&hellip;")};}this.uniqueID=Ext.id();var v=function(y){m._updateSelectedKeys();if(m.store.getCount()!=0){var j=Ext.get(m.el.select("#x-grid3-label-checker").elements[0]);if(y.getCount()==m.store.limit||y.getCount()==m.store.getCount()){j.addClass("x-grid3-hd-checker-on");}else{j.removeClass("x-grid3-hd-checker-on");}}m.fireEvent("selectionchange");};if(typeof x.selModel!="undefined"){if(typeof x.selModel.listeners=="undefined"){x.selModel.listeners={selectionchange:v};}else{if(typeof x.selModel.listeners.selectionchange=="function"){var k=x.selModel.listeners.selectionchange;x.selModel.listeners.selectionchange=function(j){v.call(j,j);k.call(j,j);};}else{x.selModel.listeners.selectionchange=v;}}}else{if(!x.checkBoxes){x.selModel=new Ext.grid.RowSelectionModel({listeners:{selectionchange:v}});}}if(x.checkBoxes){x.selModel=new Ext.grid.CheckboxSelectionModel({listeners:{selectionchange:v,selectall:function(){}},selectAll:function(){if(this.isLocked()){return;}this.selections.clear();for(var y=0,j=this.grid.store.getCount();y<j;y++){this.selectRow(y,true);}this.fireEvent("selectall",this);},clearSelections:function(j){if(this.isLocked()){return;}if(j!==true){var z=this.grid.store;var y=this.selections;y.each(function(A){this.deselectRow(z.indexOfId(A.id));},this);y.clear();}else{this.selections.clear();}this.last=false;this.fireEvent("clearall",this);}});if(typeof x.colModel=="undefined"){if(typeof x.columns=="undefined"){x.columns=[x.selModel];}else{x.columns.unshift(x.selModel);}}else{if(typeof x.colModel.columns=="undefined"){if(typeof x.columns=="undefined"){x.colModel.columns=[x.selModel];}else{x.columns.unshift(x.selModel);}}else{x.colModel.columns.unshift(x.selModel);}}}if(x.selModel instanceof Ext.grid.RowSelectionModel&&x.selModel.singleSelect){var l=function(j,z,y){m._updateSelectedKeys();m.fireEvent("selectionchange");};x.selModel.addListener("rowselect",l);x.selModel.addListener("rowdeselect",l);}if(x.filterBox.enable&&!x.filter){var f;if(typeof x.title!="string"){f="";}else{f=x.title;}var a='<div><div id="filter_window'+m.uniqueID+'" class="filter-window-radius" style="position: absolute; '+(x.filterBox.filterDropdownInTitle?"display: none; ":"")+'z-index: 999;"><fieldset class="filter-fieldset" style="padding: 10px;"><legend>Filter</legend><p class="filter-row"><input type="radio" name="showGroup" value="0" id="showAll'+m.uniqueID+'" checked /><label for="showAll'+m.uniqueID+'">Show All</label><br style="clear: both;" /></p>';if(!x.selModel.singleSelect){a+='<p class="filter-row"><input type="radio" name="showGroup" value="1" id="showSelected'+m.uniqueID+'" /><label for="showSelected'+m.uniqueID+'">Show Selected</label><br style="clear: both;" /></p>';}if(x.customFilter&&x.customFilterFields!=null){var r;for(var s in x.customFilterFields){if(!x.customFilterFields.hasOwnProperty(s)){continue;}a+='<p class="filter-row"><input type="radio" name="showGroup" value="2" id="customFilter'+m.uniqueID+s+'" /><label for="customFilter'+m.uniqueID+s+'">'+Ext.util.Format.capitalize(s)+':</label><select id="customFilter'+m.uniqueID+s+'Value" disabled="true" style="visibility: visible;">';for(r in x.customFilterFields[s]){if(!x.customFilterFields[s].hasOwnProperty(r)){continue;}a+='<option value="'+x.customFilterFields[s][r]+'">'+x.customFilterFields[s][r]+"</option>";}a+='</select><br style="clear: both;" /></p>';}}a+='<p style="padding-top: 15px;"><button class="cm_button  blue_button_spacing" onclick="document.getElementById(\''+(x.filterBox.filterDropdownInTitle?"filter_window":"filterBoxContainer")+m.uniqueID+"').style.display = 'none';\" id=\"filterWindowCancelButton"+m.uniqueID+'"><div>Cancel</div></button><button class="cm_button" onclick="document.getElementById(\''+(x.filterBox.filterDropdownInTitle?"filter_window":"filterBoxContainer")+m.uniqueID+"').style.display = 'none';\" id=\"filterWindowApplyButton"+m.uniqueID+'"><div>Apply</div></button></p></fieldset></div>';if(x.filterBox.filterDropdownInTitle){if(x.filterBox.filterButtonInTitle){a+='<p><span id="openFilterBoxButton'+m.uniqueID+'" class="openFilterBoxButton" onclick="document.getElementById(\''+(x.filterBox.filterDropdownInTitle?"filter_window":"filterBoxContainer")+m.uniqueID+"').style.display = (document.getElementById('"+(x.filterBox.filterDropdownInTitle?"filter_window":"filterBoxContainer")+m.uniqueID+"').style.display == 'none') ? 'block' : 'none';\">Show All</span>&nbsp;"+f+"</p>";}else{a=f;var h='<p><span id="openFilterBoxButton'+m.uniqueID+'" class="openFilterBoxButton" onclick="document.getElementById(\''+(x.filterBox.filterDropdownInTitle?"filter_window":"filterBoxContainer")+m.uniqueID+"').style.display = (document.getElementById('"+(x.filterBox.filterDropdownInTitle?"filter_window":"filterBoxContainer")+m.uniqueID+"').style.display == 'none') ? 'block' : 'none';\">Show All</span>&nbsp;</p>";}}a+="</div>";if(x.filterBox.filterDropdownInTitle){x.title=a;}else{var b=Ext.get("filterBoxContainer"+m.uniqueID);if(b){b.dom.style.display="none";b.update(a);}else{b=document.createElement("div");b.style.position="absolute";b.style.display="none";b.style.width="300px";b.style.height="300px";b.style.zIndex="9999";b.setAttribute("id","filterBoxContainer"+m.uniqueID);b.innerHTML=a;document.body.appendChild(b);}if(x.filterBox.filterButtonInTitle){x.title='<p><span id="openFilterBoxButton'+m.uniqueID+'" class="openFilterBoxButton" onclick="document.getElementById(\''+(x.filterBox.filterDropdownInTitle?"filter_window":"filterBoxContainer")+m.uniqueID+"').style.display = (document.getElementById('"+(x.filterBox.filterDropdownInTitle?"filter_window":"filterBoxContainer")+m.uniqueID+"').style.display == 'none') ? 'block' : 'none';\">Show All</span>&nbsp;"+f+"</p>";}else{x.title=f;var h='<p><span id="openFilterBoxButton'+m.uniqueID+'" class="openFilterBoxButton" onclick="document.getElementById(\''+(x.filterBox.filterDropdownInTitle?"filter_window":"filterBoxContainer")+m.uniqueID+"').style.display = (document.getElementById('"+(x.filterBox.filterDropdownInTitle?"filter_window":"filterBoxContainer")+m.uniqueID+"').style.display == 'none') ? 'block' : 'none';\">Show All</span>&nbsp;</p>";}}if(!x.filterBox.filterButtonInTitle){var c={html:h,region:"west",width:165,height:23,cls:"x-toolbar"};if(typeof x.tbar=="undefined"){x.tbar={xtype:"panel",id:"gridpicker_tbar",layout:"border",height:23,items:[c]};}else{if(typeof x.tbar.items=="undefined"){x.tbar.items=[];}x.tbar.items.unshift(c);}}}else{var n=[];if(x.filter){n.push(x.filter);}x.tbar={xtype:"panel",id:"gridpicker_tbar",layout:"border",height:23,items:n};}m._selectedDataKeys=[];m._rendered=false;if(typeof x.selectedKeys!="undefined"){m._selectedDataKeys=x.selectedKeys;delete x.selectedKeys;}if(x.paging){var p=function(j,y){m.refreshSelections();};if(typeof x.store.listeners=="undefined"){x.store.listeners={datachanged:p};}else{if(typeof x.store.listeners.datachanged=="function"){var u=x.store.listeners.datachanged;x.store.listeners.datachanged=function(j,y){p.call(j,y);u.call(j,y);};}else{x.store.listeners.datachanged=p;}}var o=function(j,y){};if(typeof x.store.listeners=="undefined"){x.store.listeners={beforeload:o};
}else{if(typeof x.store.listeners.beforeload=="function"){var w=x.store.listeners.beforeload;x.store.listeners.beforeload=function(j,y){o.call(j,y);w.call(j,y);};}else{x.store.listeners.beforeload=o;}}var d=false;if(x.store.xtype!=undefined){x.store=x.remotePage?new Ext.data.ArrayStore(x.store):new Ext.ux.data.PagingArrayStore(x.store);d=true;}if(!x.remotePage){this._allKeys=x.store.collect(this.keyField);}if(d){x.store.load({params:{start:0,limit:x.pageSize}});}var g=new Ext.PagingToolbar({ref:"pagingtb",region:"center",store:x.store,displayInfo:false,pageSize:x.pageSize,prependButtons:true,height:23,listeners:{beforerender:function(){if(Ext.isDefined(m.hideRefresh)&&m.hideRefresh){this.refresh.hidden=true;}},change:function(){m.selModel.fireEvent("selectionchange",m.selModel);}}});if(typeof x.tbar=="undefined"){x.tbar={xtype:"panel",id:"gridpicker_tbars",layout:"border",height:23,items:[{html:'<div id="filterHolder">&nbsp;</div>',region:"west",width:"50%",height:23,cls:"x-toolbar"},g]};}else{if(typeof x.tbar.items=="undefined"){x.tbar.items=[];}x.tbar.items.push(g);}}var t=function(F){if(x.filterBox.enable&&!x.filter){var G=Ext.get("openFilterBoxButton"+m.uniqueID);var H=Ext.get("filterWindowApplyButton"+m.uniqueID);var D=Ext.get("filterWindowCancelButton"+m.uniqueID);var j=[],E=Ext.get("showAll"+m.uniqueID),y=Ext.get("showSelected"+m.uniqueID);if(typeof x.customFilterFields!="undefined"&&x.customFilterFields!=null){for(var A in x.customFilterFields){if(!x.customFilterFields.hasOwnProperty(A)){continue;}j.push(Ext.get("customFilter"+m.uniqueID+A));}}H.on("click",this.fireFilter,m);D.on("click",function(){G.removeClass("filterBoxOpened");if(E!=null){E.dom.checked=false;}if(y!=null){y.dom.checked=false;}j.forEach(function(I){I.dom.checked=false;});Ext.get(G.selected).dom.checked=true;});G.on("click",function(){if(G.hasClass("filterBoxOpened")){G.removeClass("filterBoxOpened");if(E!=null){E.dom.checked=false;}if(y!=null){y.dom.checked=false;}j.forEach(function(K){K.dom.checked=false;});Ext.get(this.selected).dom.checked=true;}else{G.addClass("filterBoxOpened");this.selected=null;if(E!=null&&E.dom.checked){this.selected="showAll"+m.uniqueID;}else{if(y!=null&&y.dom.checked){this.selected="showSelected"+m.uniqueID;}else{if(typeof x.customFilterFields!="undefined"&&x.customFilterFields!=null){for(var J in x.customFilterFields){if(!x.customFilterFields.hasOwnProperty(J)){continue;}var I=Ext.get("customFilter"+m.uniqueID+J);if(I&&I.dom.checked){this.selected="customFilter"+m.uniqueID+J;break;}}}}}if(this.selected==null){this.selected="showAll"+m.uniqueID;if(y!=null){E.dom.checked=true;}}}});if(!x.filterBox.filterDropdownInTitle){var B=function(){if(Ext.get("filterBoxContainer"+m.uniqueID).isVisible()){Ext.get("filterBoxContainer"+m.uniqueID).setXY([Ext.get("openFilterBoxButton"+m.uniqueID).getX(),Ext.get("openFilterBoxButton"+m.uniqueID).getBox().bottom-2]);setTimeout(B,100);}else{setTimeout(B,1000);}};setTimeout(B,100);}}m._rendered=true;var z=document.getElementById("customFilter"+m.uniqueID+A+"Value");if(z){Ext.get("showAll"+m.uniqueID).on("click",function(){z.disabled=true;});Ext.get("showSelected"+m.uniqueID).on("click",function(){z.disabled=true;});Ext.get("customFilter"+m.uniqueID+A).on("click",function(){z.disabled=false;});}};if(typeof x.listeners=="undefined"){x.listeners={afterrender:t};}else{if(typeof x.listeners.afterrender=="function"){var q=x.listeners.afterrender;x.listeners.afterrender=function(j){t.call(j,j);q.call(j,j);};}else{x.listeners.afterrender=t;}}if(typeof x.onRemoveNonExistingKeys=="function"){this["onRemoveNonExistingKeys"]=x.onRemoveNonExistingKeys;}ECM.Form.GridPicker.superclass.constructor.call(this,x);},fireFilter:function(){this.store.lastOptions.params.start=0;var c=false;var d=Ext.get("openFilterBoxButton"+this.uniqueID);if(Ext.get("showSelected"+this.uniqueID)!=null&&Ext.get("showSelected"+this.uniqueID).dom.checked){d.update("Show Selected");}else{if(typeof this.customFilterFields!="undefined"&&this.customFilterFields!=null){for(var b in this.customFilterFields){if(!this.customFilterFields.hasOwnProperty(b)){continue;}var a=Ext.get("customFilter"+this.uniqueID+b);if(a&&a.dom.checked){d.update("Filter: "+b);c=b;break;}}}if(c===false){d.update("Show All");}}d.removeClass("filterBoxOpened");this.setFilter((Ext.get("showSelected"+this.uniqueID)==null)?false:document.getElementById("showSelected"+this.uniqueID).checked,c!==false,c,(c===false)?null:Ext.get("customFilter"+this.uniqueID+c+"Value").getValue());},keysOnCurrentPage:function(){if(!Ext.isDefined(this.getStore())){return[];}return this.getStore().collect(this.keyField);},selectedKeysOnCurrentPage:function(){var a=this.getSelectionModel().getSelections();var c=this.keyField;var b=[];Ext.each(a,function(d){b.push(d.get(c));});return b;},setValue:function(a){if(!Ext.isArray(a)){return;}this._selectedDataKeys=this.removeNonExistingDataKeys(a);},removeNonExistingDataKeys:function(g,c){if(!Ext.isDefined(c)){c=false;}if(!this.remotePage&&(!Ext.isArray(g)||!Ext.isDefined(this._allKeys))){return c?false:null;}var a=[];var d=[];var f;var b=this.getStore();Ext.each(g,function(h){if(this._allKeys.indexOf(h)!==-1){a.push(h);}else{if(h!="NULL (empty, unspecified)"){d.push(h);}}},this);if(!c&&d.length>0){if(typeof this["onRemoveNonExistingKeys"]=="function"){this["onRemoveNonExistingKeys"].call(this,d);}}return c?(d.length==0):a;},_updateSelectedKeys:function(){if(!this._rendered){return;}if(this.selModel.singleSelect){this._selectedDataKeys=this.selectedKeysOnCurrentPage();return;}var a=this.keysOnCurrentPage();var b=this.selectedKeysOnCurrentPage();Ext.each(b,function(f){var d=a.indexOf(f);if(d>=0){a.splice(d,1);}var c=this._selectedDataKeys.indexOf(f);if(c<0){this._selectedDataKeys.push(f);}},this);Ext.each(a,function(d){var c=this._selectedDataKeys.indexOf(d);if(c>=0){this._selectedDataKeys.splice(c,1);}},this);this.updateCalledFromLoad=false;},selectedKeys:function(b){if(b){var a=Array.clone(this._selectedDataKeys);return a.remove("NULL (empty, unspecified)");}return this._selectedDataKeys;},getValue:function(){return this.selectedKeys();},selectedRecordIDs:function(){return Ext.pluck(this.getSelectionModel().getSelections(),"id");},allDataByKey:function(){var a=[];Ext.each(this.store.allData.getRange(),function(b){a.push(b.get(this.keyField));},this);return a;},selectedRecords:function(){return this.getSelectionModel().getSelections();},setFilter:function(b,f,g,a){var d=this;var c=d.getStore();c.customFiltered=true;if(f){c.filter(g,new RegExp(Ext.escapeRe(a)+"([,]|$).*"));c.reload();return;}if(b){c.filterBy(function(h){return this._selectedDataKeys.indexOf(h.get(this.keyField))!==-1;},this);}else{c.customFiltered=false;c.filterBy(function(){return true;});}c.reload();},renderFilters:function(a){var b={};Ext.iterate(a,function(d,c){b.field=d;b.value=c;return false;});this.getStore().filter(b.field||"name",b.value||"",true,false);this.topToolbar.items.items[1].changePage(1);},refreshSelections:function(){var b=this.getStore();if(!Ext.isDefined(b)||b==null||b.getCount()==0){return;}var a=this.getSelectionModel();if(!a.grid){return;}a.suspendEvents(false);a.clearSelections(false);Ext.each(this._selectedDataKeys,function(c){a.selectRow(b.findBy(function(d){if(c===d.get(this.keyField)){return true;}},this),true);},this);a.resumeEvents();a.fireEvent("selectionchange",a);}});Ext.reg("ecm.gridpicker",ECM.Form.GridPicker);})();Ext.ns("ECM.Form");ECM.provide("ECM.Form.ItemPicker");ECM.Form.ItemPicker=Ext.extend(ECM.GenericWindow,{constructor:function(b){var a=this;if(!Ext.isDefined(b.gridPicker)){b.gridPicker={};}else{if(Ext.isDefined(b.gridPicker.selectedKeys)){delete b.gridPicker.selectedKeys;}}if(!Ext.isDefined(b.dialog)){b.dialog={};}a.selection=null;a.onDone=null;a.onCancel=null;for(var c in b){if(c!="gridPicker"&&c!="dialog"&&b.hasOwnProperty(c)&&typeof b.dialog[c]=="undefined"){b.dialog[c]=b[c];}}if(!Ext.isDefined(b.dialog.buttons)){b.dialog.buttons=[{text:"Cancel",cls:"blue_button",handler:function(){a.hide();
if(Ext.isFunction(a.onCancel)){a.onCancel.call(a,a.selection);}}}];}if(b.width&&!b.gridPicker.width){b.gridPicker.width=b.width;}if(b.height&&!b.gridPicker.height){b.gridPicker.height=b.height;}b.gridPicker.checkBoxes=false;if(!b.gridPicker.selModel){b.gridPicker.selModel=new Ext.grid.RowSelectionModel({singleSelect:true});}else{b.gridPicker.selModel.singleSelect=true;}if(b.filter){b.gridPicker.filter=b.filter;}a.gridPicker=new ECM.Form.GridPicker(b.gridPicker);if(!b.dialog.items){b.dialog.items=[];}b.dialog.items.splice(0,0,a.gridPicker);if(b.dialog.onDone){a.onDone=b.dialog.onDone;}if(b.dialog.onCancel){a.onCancel=b.dialog.onCancel;}if(b.filter){b.filter.menu.on("beforefilter",function(d){d.selectedId=a.selectedKeys();});}ECM.Form.ItemPicker.superclass.constructor.call(this,b.dialog);},selectedKey:function(){var a=this.gridPicker.selectedKeys();if(a.length>0){return a[0];}else{return null;}},selectedRecord:function(){var a=this.gridPicker.selectedRecords();if(a.length>0){return a[0];}else{return null;}},selectedKeys:function(){return this.selectedId||[];},selectedRecordIDs:function(){return this.gridPicker.selectedRecordIDs();},setFilter:function(b,c,a){this.gridPicker.setFilter(b,c,a);},refreshSelections:function(){this.gridPicker.refreshSelections();},setValue:function(a){this.gridPicker.setValue(a);},clearSelections:function(){this.gridPicker.selModel.clearSelections();},listeners:{afterrender:function(){var a=this;a.gridPicker.selModel.on("rowselect",function(c){a.selection=a.selectedKey();var b=a.selectedRecord();c.clearSelections();a.hide();if(Ext.isFunction(a.onDone)){a.onDone.call(a,b);}});a.on("beforeclose",function(){a.hide();return false;});},beforeshow:function(){this.gridPicker.refreshSelections();}}});Ext.reg("ecm.itempicker",ECM.Form.ItemPicker);ECM.provide("ECM.Form.DirectEntryGridPicker");(function(){ECM.Form.DirectEntryGridPicker=Ext.extend(Ext.Panel,{cls:"ecm-directentrygridpicker",customFilter:false,customFilterFields:null,directEntry:false,enableColumnMove:false,enableColumnHide:false,gridPicker:null,validateEntry:false,displayMode:"both",trimValue:false,remoteValidationSuccessCB:Ext.emptyFn,constructor:function(c){c.displayMode=typeof(c.displayMode)=="undefined"?this.displayMode:c.displayMode;if(typeof c.pickerConfig=="undefined"&&(c.displayMode=="both"||c.displayMode=="grid")){throw"Must specify a GridPicker configuration !";}if((c.displayMode=="both"||c.displayMode=="grid")&&c.pickerConfig.remotePage&&!c.pickerConfig.remoteValidationUrl){throw"Must specify a remote validation URL.";}var b=this;var f=(typeof c.pickerConfig["onRemoveNonExistingKeys"]=="function")?c.pickerConfig["onRemoveNonExistingKeys"]:function(g){};c.pickerConfig["onRemoveNonExistingKeys"]=function(g){ECM.publish("/notify/clear/all",{selector:".error_display2"});ECM.publish("/notify/error",{selector:".error_display2",message:(g.length)+" invalid value(s).",width:300});f.call(this,g);};if(c.filter){c.filter.menu.on("beforefilter",function(g){g.selectedId=b.selectedKeys();});}this["uniqueID"]=Math.floor(Math.random()*999999)+"";if(typeof c.items=="undefined"){c.items=[];}if(c.displayMode=="both"){c.items.push(this.getRadioBtnHTML());}if(c.displayMode=="both"||c.displayMode=="manual"){if(c.displayMode=="manual"){c.pickerConfig.selectedKeys=Ext.isDefined(c.pickerConfig.selectedKeys)?c.pickerConfig.selectedKeys:"";c.items.push(this.getTextAreaHTML(c.pickerConfig.selectedKeys));this["_isDirectEntry"]=true;}if(typeof c.listeners=="undefined"){c.listeners={afterrender:this.afterrenderFunction};}else{if(typeof c.listeners["afterrender"]=="function"){var a=c.listeners["afterrender"];c.listeners["afterrender"]=function(g){this.afterrenderFunction.call(g,g);a.call(g,g);};}else{c.listeners["afterrender"]=this.afterrenderFunction;}}}if(c.displayMode=="both"||c.displayMode=="grid"){c.pickerConfig.filter=c.filter;var d=new ECM.Form.GridPicker(Ext.apply(c.pickerConfig,{enableHdMenu:false}));if(c.pickerConfig.remotePage&&c.pickerConfig.store.xtype==undefined){d.store.on("beforeload",function(){var g=this.getSelectionModel();g.suspendEvents(false);},d);d.store.on("load",function(){var g=this.getSelectionModel();g.resumeEvents();this.refreshSelections();},d);}this["gridPicker"]=d;this["gridPicker"].parent=b;this["_isDirectEntry"]=false;c.items.push(d);}ECM.Form.DirectEntryGridPicker.superclass.constructor.call(this,c);},initComponent:function(){var a=this;ECM.Form.DirectEntryGridPicker.superclass.initComponent.apply(this,arguments);if(a.displayMode!="manual"&&a.gridPicker.remotePage){this.gridPicker.store.addListener("load",function(){var c=(function(){this.selectGP();}).createDelegate(a);var b=(function(){this.selectDE();}).createDelegate(a);a.directEntryisValid(false,c,b);},this,{single:true});}},afterrenderFunction:function(d){this.textBox=Ext.get("directEntry"+this["uniqueID"]+"TextValues");var c=this,h=c.selectedKeys().remove("NULL (empty, unspecified)");c.textBox.dom.value=h.join(",");if(c.displayMode!="manual"&&!c.gridPicker.remotePage){if(!c.directEntryisValid()){ECM.publish("/notify/clear/all",{selector:".error_display2"});c.selectDE();}}else{if(c.displayMode=="manual"){c.selectDE();}}var b=function(k){var m=new Ext.LoadMask(Ext.getCmp("valueTable").container.parent().parent().parent(),{msg:gt.gettext("Uploading...")});m.show();var l=Ext.getCmp("dcModalDoneButton");ECM.Ajax.request({form:Ext.getCmp("uploadForm"+c.uniqueID).getForm().id,method:"POST",url:"/cm/utils/filereader",isUpload:true,handleAs:"json",params:{hasText:true,hasRichText:false,hasHTML:false},success:function(o){Ext.get("directEntry"+c.uniqueID+"TextValues").dom.value=o.responseJSON.data;var n=Ext.getCmp("dcModalDoneButton");if(n){n.enable();}m.hide();if(l){l.enable();}},failure:function(){m.hide();}});};var f=new Ext.Button({text:gt.gettext("Upload"),id:"uploadBtn",name:"upload",inputValue:"upload",disabled:true,handler:b,style:{marginLeft:"5px"}});var g=new Ext.ux.form.FileUploadField({id:"uploadField",name:"uploadField",width:"250px",height:"25px",buttonText:gt.gettext("Browse"),validator:function(k){return(/\.(csv|txt|tsv)$/i).test(k);},listeners:{afterrender:function(){this.el.setStyle("width","185px");this.el.setStyle("background-color","#EEEEEE");this.el.setStyle("background-image","none");this.el.setStyle("cursor","default");this.el.parent().setStyle("margin-top","0px");},fileselected:function(k,m){var l=Ext.getCmp("uploadBtn");if(m!=""&&this.isValid()){l.enable();}else{l.disable();}}}});var j=new Ext.form.ComboBox({hideLabel:true,editable:false,mode:"local",width:167,value:"c",forceSelection:true,valueField:"id",displayField:"text",triggerAction:"all",store:new Ext.data.ArrayStore({id:0,fields:["id","text"],data:[["c","Comma"],["t","Tab"]]}),listeners:{afterrender:function(){this.el.parent().setStyle("margin-top","0px");this.el.parent().setStyle("width","172px");}},style:"marginLeft: 5px;"});var a=new Ext.form.FormPanel({id:"uploadForm"+c.uniqueID,hideLabels:true,fileUpload:true,method:"POST",url:"/cm/utils/filereader",renderTo:"uploadForm",items:[{layout:"column",style:{marginTop:"-10px"},items:[g,j,f]}]});if(c.displayMode!="manual"){Ext.get("directEntry"+c.uniqueID+"EnterValues").on("click",function(){if(Ext.get("directEntry"+c.uniqueID+"EnterValuesSection").dom.style.display=="block"){return;}var k=Ext.get("openFilterBoxButton"+c.gridPicker.uniqueID);var m=Ext.get("filterBoxContainer"+c.gridPicker.uniqueID);if(k&&m){k.removeClass("filterBoxOpened");m.hide();}var l=c.selectedKeys().remove("NULL (empty, unspecified)");c.textBox.dom.value=l.join(",");c.selectDE();});Ext.get("directEntry"+c.uniqueID+"List").on("click",function(){if(Ext.get("directEntry"+c.uniqueID+"EnterValuesSection").dom.style.display=="none"){return;}var m=(function(){this.selectGP();}).createDelegate(c);var k=(function(){this.selectDE();}).createDelegate(c);var l=c.directEntryisValid(true,m,k);if(!c.gridPicker.remotePage||c.directEntryValues().length==0){if(l){c.setValue(c.directEntryValues());m();}else{ECM.publish("/notify/clear/all",{selector:".error_display2"});
ECM.publish("/notify/error",{selector:".error_display2",message:gt.gettext("Invalid entry/entries."),width:300});c.selectDE();}}});}if(typeof c.onDirectEntryKeyUp=="function"){Ext.get("directEntry"+c.uniqueID+"TextValues").on("keyup",function(){c.onDirectEntryKeyUp.call(c);});}if(typeof c.onDirectEntryChange=="function"){Ext.get("directEntry"+c.uniqueID+"TextValues").on("change",function(){c.onDirectEntryChange.call(c);});}},getRadioBtnHTML:function(){return{html:'<div class="ecm-degp-panel" id="directEntry'+this["uniqueID"]+'"><div class="ecm-degp-mode-bar"><div class="ecm-degp-modes" style="float:left"><input class="ecm-degp-radio" type="radio" value="0" id="directEntry'+this["uniqueID"]+'List" name="directEntry'+this["uniqueID"]+'" checked /><label for="directEntry'+this["uniqueID"]+'List">Select Values</label>&nbsp;<input class="ecm-degp-radio" type="radio" value="1" id="directEntry'+this["uniqueID"]+'EnterValues" name="directEntry'+this["uniqueID"]+'" /><label for="directEntry'+this["uniqueID"]+'EnterValues">Enter IDs</label></div><div style="clear:both"></div></div><div style="display: none;" class="ecm-degp-entry-panel" id="directEntry'+this["uniqueID"]+'EnterValuesSection"><div class="ecm-degp-form"><div><div class="ecm-degp-entry-label" style="width:40px;float:left;font-weight:bold;">Manual</div><div id="directEntry'+this["uniqueID"]+'notify" class="error_display2"></div><div style="clear:both"></div><div style="float:left;" class="ecm-degp-entry-rightcol"><textarea style="width:580px;height:102px" id="directEntry'+this["uniqueID"]+'TextValues"></textarea></br>* comma delimited</br></br></div><div style="clear:both"></div></div><div><div class="ecm-degp-entry-label" style="margin-top:0px; font-weight:bold;">File Upload</div><div id="uploadForm" class="ecm-degp-entry-rightcol" style="width: 580px; margin-top:-5px; float:left;"></div><div style="clear:both"></div></div></div></div></div>',region:"north"};},getTextAreaHTML:function(a){a=!Ext.isArray(a)?a:a.join(",");return{html:'<div class="ecm-degp-form" style="border-width: 1px;border-color: #99BBE8;border-style:solid;"><div><div class="ecm-degp-entry-label" style="width:75px;float:left;font-weight:bold;">Enter Values</div><div id="directEntry'+this["uniqueID"]+'notify" class="error_display2"></div><div style="clear:both"></div><div style="float:left;" class="ecm-degp-entry-rightcol"><textarea style="width:580px;height:102px" id="directEntry'+this["uniqueID"]+'TextValues">'+a+'</textarea></br>* comma delimited</div><div style="clear:both"></div></div><div><div class="ecm-degp-entry-label" style="margin-top:0px; font-weight:bold;">File Upload</div><div id="uploadForm" class="ecm-degp-entry-rightcol" style="width: 580px; margin-top:-5px; margin-bottom:5px; float:left;"></div><div style="clear:both"></div></div></div>',region:"north"};},keysOnCurrentPage:function(){return this["gridPicker"]["keysOnCurrentPage"]();},selectedKeysOnCurrentPage:function(){return this["gridPicker"]["selectedKeysOnCurrentPage"]();},setValue:function(b){var a=this.gridPicker.removeNonExistingDataKeys(b,true);if(a){if(Ext.getCmp("includeNoValueDegp")&&Ext.getCmp("includeNoValueDegp").checked){b.push("NULL (empty, unspecified)");}this.gridPicker.setValue(b);}else{if(this.textBox){this.textBox.dom.value=Ext.isArray(b)?b.join(","):b;}}},isValid:function(){var a=Ext.getCmp("includeNoValueDegp");if(a){return(this.selectedKeys().length>0||a.checked);}else{if(this.isDirectEntry()&&this.manualMask){var b=(this.selectedKeys().length>0);if(b==true){b=this.manualMask.test(this.directEntryValue());}return b;}else{return(this.selectedKeys().length>0);}}},removeNonExistingDataKeys:function(b,a){if(this["gridPicker"]==undefined){return[];}else{return this["gridPicker"]["removeNonExistingDataKeys"](b,a);}},isDirectEntry:function(){return this["_isDirectEntry"];},directEntryValue:function(){var a=[];var c=[];try{a=Ext.get("directEntry"+this["uniqueID"]+"TextValues").dom.value.split(",");}catch(b){a=this.selectedKeys();}Ext.each(a,function(d){if(this.trimValue){d=Ext.util.Format.trim(d);if(Ext.isEmpty(d)){return true;}}if(c.indexOf(d)==-1){c.push(d);}},this);return c.join(",");},directEntryValues:function(){var a=this.directEntryValue();if(a.trim()==""){return[];}return this.directEntryValue().split(",");},getValue:function(){return this.selectedKeys();},selectGP:function(){var a=this;if(a.displayMode=="both"){Ext.get("directEntry"+a.uniqueID+"EnterValues").dom.checked=false;Ext.get("directEntry"+a.uniqueID+"List").dom.checked=true;Ext.get("directEntry"+a.uniqueID+"EnterValuesSection").dom.style.display="none";a.gridPicker.refreshSelections();a.gridPicker.show();}a._isDirectEntry=false;},selectDE:function(){var a=this;if(a.displayMode=="both"){Ext.get("directEntry"+a.uniqueID+"EnterValues").dom.checked=true;Ext.get("directEntry"+a.uniqueID+"List").dom.checked=false;var b=a.textBox.dom;Ext.get("directEntry"+a.uniqueID+"EnterValuesSection").dom.style.display="block";b.focus();b.select();a.gridPicker.hide();}a._isDirectEntry=true;},directEntryisValid:function(d,g,b){ECM.publish("/notify/clear/all",{selector:".error_display2"});if(!this.rendered){return true;}d=Ext.isDefined(d)?d:true;var l=this.directEntryValue().trim();l=l==""?[]:l.split(",");if(l.length==0){return true;}var c=gt.gettext("Invalid entry/entries.");if(this.gridPicker.remotePage){var k=this;if(!Ext.isDefined(k.remoteValidating)){var a=new Ext.LoadMask(this.gridPicker.el,{msg:gt.gettext("Loading data&hellip;")});if(d){a=new Ext.LoadMask(Ext.get("directEntry"+k.uniqueID+"EnterValuesSection"),{msg:gt.gettext("Validating...")});}a.show();k.remoteValidating=true;var f=ECM.Ajax.eventsSuspended;ECM.Ajax.eventsSuspended=true;ECM.Ajax.request({url:this.gridPicker.remoteValidationUrl,method:"GET",params:{filter:'["id","=",'+Ext.encode(l)+"]"},failure:function(m){if(b){b();}delete k.remoteValidating;a.hide();ECM.Ajax.eventsSuspended=f;ECM.publish("/notify/error/clear",{selector:".error_display2",message:c,width:300});},success:function(m,n){if(m.responseJSON.data.data.length==l.length){k.gridPicker._selectedDataKeys=l;k.remoteValidationSuccessCB.call(k,m);if(g){g();}}else{if(b){b();}ECM.publish("/notify/error/clear",{selector:".error_display2",message:c,width:300});}delete k.remoteValidating;a.hide();ECM.Ajax.eventsSuspended=f;}});}}else{var j=this.removeNonExistingDataKeys(l,true);if(!j){var h="this";if(Ext.isDefined(this.currentConditionField)){h=this.currentConditionField;}ECM.publish("/notify/error/clear",{selector:".error_display2",message:c,width:300});}else{if(g){g();}}return j;}return false;},selectedKeys:function(a){if(typeof a=="undefined"||!a){if(this.isDirectEntry()){return this.directEntryValues();}}if(this["gridPicker"]==undefined){return[];}else{return this["gridPicker"]["selectedKeys"]();}},selectedRecordIDs:function(){return this["gridPicker"]["selectedRecordIDs"]();},setFilter:function(b,c,d,a){return this["gridPicker"]["setFilter"](b,c,d,a);},refreshSelections:function(){return this["gridPicker"]["refreshSelections"];}});Ext.reg("ecm.directentrygridpicker",ECM.Form.DirectEntryGridPicker);})();ECM.provide("ECM.Form.FrequencyCap");(function(){Ext.apply(Ext.form.VTypes,{daterange:function(d,c){var b=c.parseDate(d);if(!b){return;}if(c.startDateField&&(!this.dateRangeMax||(b.getTime()!=this.dateRangeMax.getTime()))){var f=Ext.getCmp(c.startDateField);f.setMaxValue(b);f.validate();this.dateRangeMax=b;}else{if(c.endDateField&&(!this.dateRangeMin||(b.getTime()!=this.dateRangeMin.getTime()))){var a=Ext.getCmp(c.endDateField);a.setMinValue(b);a.validate();this.dateRangeMin=b;}}return true;}});ECM.Form.FrequencyCap=ECM.Adapter.extend(Ext.form.Field,{defaultAutoCreate:{tag:"div"},hideLabel:"true",freq_num:3,freq_range:1,freq_from:null,freq_to:null,getMainPanel:function(){var b=this;this.row1=new Ext.Panel({layout:"column",border:false,width:500,style:"margin-top:5px;",items:[{xtype:"numberfield",id:"freq_num",value:b.freq_num,maxLength:2,width:"40px",allowBlank:false,listeners:{afterrender:function(){b.freqNum=this;
},invalid:function(){dcForm.upDoneStatus();},valid:function(){dcForm.upDoneStatus();}}},{xtype:"label",html:" messages or less in the ",style:"margin:4px;"},{xtype:"combo",value:b.freq_range,id:"freq_range",mode:"local",triggerAction:"all",editable:false,allowBlank:false,store:new Ext.data.SimpleStore({id:0,fields:["id","val"],data:[[1,"Last Day"],[2,"Last Week"],[3,"Last Month"],[4,"Last Year"],[5,"Selected Time Frame"]]}),valueField:"id",displayField:"val",listeners:{afterrender:function(){b.freqRange=this;},select:function(g,d,f){Ext.each(b.row2.items.items,function(j,h,k){if(d.data.val=="Selected Time Frame"){j.show();b.fireEvent("onchange");}else{j.hide();}});}}}]});var a=this.freq_range!=5;this.row2=new Ext.Panel({layout:"column",layoutConfig:{renderHidden:a},border:"false",forceLayout:true,width:500,style:"padding-top:5px;",items:[{xtype:"label",html:"From:",style:"margin:4px;"},{xtype:"datefield",value:b.freq_from,format:"Y-M-d",fieldLabel:"",id:"startdt",name:"startdt",width:140,allowBlank:false,vtype:"daterange",endDateField:"enddt",listeners:{afterrender:function(){b.freqFrom=this;},invalid:function(){dcForm.upDoneStatus();},valid:function(){dcForm.upDoneStatus();}}},{xtype:"label",html:"To:",style:"margin:4px;"},{xtype:"datefield",value:b.freq_to,format:"Y-M-d",fieldLabel:"",id:"enddt",name:"enddt",width:140,allowBlank:false,vtype:"daterange",startDateField:"startdt",listeners:{afterrender:function(){b.freqTo=this;},invalid:function(){dcForm.upDoneStatus();},valid:function(){dcForm.upDoneStatus();}}}]});var c=new Ext.Panel({style:"margin:5px;",items:[this.row1,this.row2]});return c;},afterRender:function(){ECM.Form.FrequencyCap.superclass.afterRender.call(this);this.renderPanel();this.validate();},renderPanel:function(){this.mainPanel=this.getMainPanel();this.mainPanel.render(this.el);},setValue:function(a){this.value=a;if(this.mainPanel){this.mainPanel.destroy();this.renderPanel();}},getValue:function(a){var c,b,f,d;if(this.freqNum){fNum=this.freqNum.getValue();fRange=this.freqRange.getValue();fFrom=fRange==5?this.freqFrom.getValue():null;fTo=fRange==5?this.freqTo.getValue():null;return{freq_num:fNum,freq_range:fRange,freq_from:fFrom,freq_to:fTo};}return false;},getNodeText:function(){var c=this.freqNum.getValue();var a=this.freqRange.getValue();var b;if(a!=5){b="in the "+ECM.Form.FrequencyCap.rangeMap[a];}else{var f=function(m){var l=m.getMonth()+1;var j=m.getDate();var k=m.getFullYear();return l+"/"+j+"/"+k;};var h=this.freqFrom.getValue();var g=this.freqTo.getValue();b="from "+f(h)+" to "+f(g);}var d=" Frequency Cap of "+c+" messages or less "+b+".";return d;}});ECM.Form.FrequencyCap.rangeMap={1:"Last Day",2:"Last Week",3:"Last Month",4:"Last Year",5:"Selected Time Frame"},Ext.reg("ecm.frequencyCap",ECM.Form.FrequencyCap);})();ECM.provide("ECM.Plugins.Component.Subscription");ECM.Plugins.Component.Subscription=Ext.extend(Ext.util.Observable,{init:function(a){this.subscriptions=[];this.subConfig={};var b=Object.getPrototypeOf?Object.getPrototypeOf(a).subscriptions:a.constructor.prototype.subscriptions;Ext.apply(this.subConfig,a.subscriptions,b);Ext.iterate(this.subConfig,function(c,d){this.subscriptions.push(ECM.subscribe(c,d,a));},this);a.destroy=a.destroy.createInterceptor(function(){Ext.each(this.subscriptions,ECM.unsubscribe);},this);}});Ext.preg("ecm.subscription",ECM.Plugins.Component.Subscription);ECM.provide("ECM.Targeting.Store.SubscriberList");ECM.Targeting.Store.SubscriberList={buildAffiliateListHash:function(){this._affiliateHash={};Ext.each(ECM.Stash.affiliates,function(a){this._affiliateHash[a.id]=a.name;},this);},getAffiliateNameById:function(a){if(!this._affiliateHash){this.buildAffiliateListHash();}return this._affiliateHash[a];},buildSubListHash:function(){this._subListHash={};if(!ECM.Stash.subscriber_list){return{};}Ext.each(ECM.Stash.subscriber_list.data,function(a){if(!this._subListHash[a[0]]){this._subListHash[a[0]]=[];}this._subListHash[a[0]].push({id:a[2],name:this.getAffiliateNameById(a[2])});},this);},getSubscriberListAffiliate:function(a){if(!this._subListHash){this.buildSubListHash();}var b="Unknown Affiliate";if(this._subListHash[a]){b=Ext.pluck(this._subListHash[a],"name").join(",");}return b;},getSubscriberListAffiliateID:function(a){if(!this._subListHash){this.buildSubListHash();}var b="";if(this._subListHash[a]){b=Ext.pluck(this._subListHash[a],"id");}return b;}};ECM.provide("ECM.Form.View.Base");ECM.Form.View.Base=Ext.extend(Object,{});ECM.Form.View.Base.fieldWidth=300;ECM.provide("ECM.Form.FormElements.ElementHelper");ECM.Form.FormElements.ElementHelper={getValueType:function(f){var g=ECM.Form.FormElements.ValueHelpers;for(var d in g){var c=g[d];if(c.valueType){for(var b=0,a=c.valueType.length;b<a;b++){if(c.valueType[b]==f){return c;}}}}},getColumnInfoFromId:function(f){var c={};var a=dcForm.isSimpleMode&&!dcForm.switchToAdvancedRequested?1:2;var d=__catalog__.columns[a];if(d&&d[f]){c.value=f;c.text=d[f][0];c.type=d[f][1];var b=d[f][2];if(Ext.isEmpty(b)&&f==="145"){b="D";}c.table=b;c.length=d[f][4];}return c;},getListDataFromStore:function(d,b,f){var g=[],c,h,j;if(d&&d.data){c=d.data.items||[];for(var a=0;a<c.length;a++){j=c[a].data.text;if(b){j+=" ("+c[a].data.value+")";}var k=c[a].json[2];if(Ext.isEmpty(k)&&c[a].data.value==145){k="D";}h=[c[a].data.value,j,k,!!c[a].json[1]?c[a].json[1]:2];g.push(h);}}return g;},getDefaultNode:function(){return{ownerTree:dcForm.sourceTreeNode.ownerTree,condition:function(){return{mode:dcForm.isEditMode?1:0};}};},hideElement:function(a){a.disable();a.hide();a.getEl().up(".x-form-item").setDisplayed(false);},showElement:function(a){a.enable();a.show();a.getEl().up(".x-form-item").setDisplayed(true);}};ECM.provide("ECM.Form.FormElements.ValueSimple");ECM.Form.FormElements.ValueSimple=Ext.extend(Ext.form.TextField,{elHelper:ECM.Form.FormElements.ElementHelper,id:"value0",fieldLabel:"Value",hideParent:true,width:ECM.Form.View.Base.fieldWidth,enableKeyEvents:true,plugins:["ecm.subscription"],listeners:{afterRender:function(){if(this.formObject.isEditMode){if(Ext.isArray(this.node.condition().operands)){this.setValue(this.node.condition().operands[0]);}}ECM.Form.FormElements.ValueSimple.superclass.initComponent.call(this);ECM.publish.defer(250,ECM.publish,["valueChanged"]);},keyUp:function(){ECM.publish("valueChanged");}},subscriptions:{operator_changed:function(a){var b=a&&a.columnInfo.value!=undefined&&a.columnInfo.value!=""&&dcForm.isConditionEditSupported(a.columnInfo.type);this.setVisible(b);}}});Ext.reg("ecm.formelements.valuesimple",ECM.Form.FormElements.ValueSimple);ECM.provide("ECM.Form.FormElements.Table");ECM.Form.FormElements.Table=Ext.extend(Ext.form.ComboBox,{id:"selTable",fieldLabel:"Table",emptyText:gt.gettext("Please Select..."),width:ECM.Form.View.Base.fieldWidth,mode:"local",editable:false,triggerAction:"all",valueField:"id",displayField:"val",listeners:{select:function(c,a,b){ECM.publish("table_changed",c,a,b);}},isActivity:function(){return Ext.isArray(this.getValue().match(/[BCORST]/));},initComponent:function(){var c=ECM.Rules.Constants;var f=[];var d=ECM.Form.FormElements.Table.tblLayout;var b=ECM.Form.FormElements.Table.tblGroupIndex;var a=this.node.getCompatibleTables();if(this.node.attributes.isAggregator&&this.node.hasChildNodes()){a=[this.node.getTable()];}Ext.each(d,function(j,g,h){Ext.each(j[1],function(m,k,l){if(a.indexOf(m[0])>-1&&!b[m[0]].hidden){f.push(m);}});});if(this.node&&this.node.getTable){this.value=this.node.getTable();if(this.value==="(145)"){this.value="D";}if(this.value==="_"){this.value="L";}}this.store=new Ext.data.SimpleStore({id:0,fields:["id","val"],data:f});ECM.Form.FormElements.Table.superclass.initComponent.call(this);}});ECM.Form.FormElements.Table.tblLayout=[[gt.gettext("Client"),[["D",gt.gettext("Demographic")]]],[gt.gettext("System"),[["L",gt.gettext("Subscription")],["S",gt.gettext("Sends")],["C",gt.gettext("Clicks")],["O",gt.gettext("Opens")],["R",gt.gettext("Referrals")],["T",gt.gettext("Transactions")],["I",gt.gettext("Insights")]]]];
ECM.Form.FormElements.Table.tblGroupIndex={C:{parent:gt.gettext("System"),text:gt.gettext("Clicks"),index:3,parentIndex:1,hidden:!ECM.Stash.show_activity_data},D:{parent:gt.gettext("Client"),text:gt.gettext("Demographic"),index:0,parentIndex:0},I:{parent:gt.gettext("System"),text:gt.gettext("Insights"),index:7,parentIndex:1,hidden:true},L:{parent:gt.gettext("System"),text:gt.gettext("Subscription"),index:0,parentIndex:1},O:{parent:gt.gettext("System"),text:gt.gettext("Opens"),index:4,parentIndex:1,hidden:!ECM.Stash.show_activity_data},R:{parent:gt.gettext("System"),text:gt.gettext("Referrals"),index:5,parentIndex:1,hidden:!ECM.Stash.show_activity_data},S:{parent:gt.gettext("System"),text:gt.gettext("Sends"),index:1,parentIndex:1,hidden:!ECM.Stash.show_activity_data},T:{parent:gt.gettext("System"),text:gt.gettext("Transactions"),index:6,parentIndex:1,hidden:!ECM.Stash.show_activity_data}};Ext.reg("ecm.formelements.table",ECM.Form.FormElements.Table);Ext.ns("ECM.Form");ECM.provide("ECM.Form.ComboBox");ECM.Form.ComboBox=Ext.extend(Ext.form.ComboBox,{filterBy:function(b,a){var c=this.store;c.filterBy(b,a);c.realSnapshot=c.snapshot;c.snapshot=c.data;},clearFilter:function(a){var b=this.store;if(b.realSnapshot&&b.realSnapshot!=b.snapshot){b.snapshot=b.realSnapshot;delete b.realSnapshot;}b.clearFilter(a);},anyMatch:false,doQuery:function(c,b){if(c===undefined||c===null){c="";}var a={query:c,forceAll:b,combo:this,cancel:false};if(this.fireEvent("beforequery",a)===false||a.cancel){return false;}c=a.query;b=a.forceAll;if(b===true||(c.length>=this.minChars)){if(this.lastQuery!==c){this.lastQuery=c;if(this.mode=="local"){this.selectedIndex=-1;if(b){this.store.clearFilter();}else{this.store.filter(this.displayField,c,this.anyMatch);}this.onLoad();}else{this.store.baseParams[this.queryParam]=c;this.store.load({params:this.getParams(c)});this.expand();}}else{this.selectedIndex=-1;this.onLoad();}}}});Ext.reg("ecm.combo",ECM.Form.ComboBox);ECM.provide("ECM.Form.FormElements.Field");ECM.Form.FormElements.Field=Ext.extend(ECM.Form.ComboBox,{displayField:"text",valueField:"value",id:"field",fieldLabel:"Field",disabled:false,width:ECM.Form.View.Base.fieldWidth,forceSelection:true,triggerAction:"all",hidden:true,invalidText:"A valid field must be specified.",lastQuery:"",mode:"local",isDirty:false,emptyText:gt.gettext("Please Select..."),stripCharsRe:/^(&nbsp;)+/,plugins:["ecm.subscription"],listeners:{select:function(){this.isDirty=true;var b=this.getType();if(this.columnType&&(this.columnType!=b)&&(b==ECM.Rules.Constants.TYPES.NUMERIC)){var a=Ext.getCmp("value0");(a&&Ext.isFunction(a.setValue)&&a.setValue("")&&(dcForm.condition.operands=[]));}this.columnType=b;this.formObject.currentFieldValue=this.getRawValue();if(this.getValue()!=""){var c=ECM.Form.FormElements.ElementHelper;var d=c.getColumnInfoFromId(this.getValue(),this.formObject.columnData);this.formObject.currentFieldType=d.type;}ECM.publish("field_changed",arguments);}},subscriptions:{table_changed:function(f,b,d){var a=this.getValue();this.clearValue();this.clearFilter();this.filterBy(function(g,h){return(g.data.table==b.id);});if(!this.findRecord(this.valueField,a)){var c=[this];for(i=0;i<arguments.length;i++){c.push(arguments[i]);}this.show();}var c=[this];Ext.each(arguments,function(g){c.push(g);});ECM.publish("field_changed",c);}},getType:function(){var b=this.getStore().findExact("value",this.getValue());var a=false;if(b>-1){a=this.getStore().getAt(b).get("type");}return a;},afterRender:function(){ECM.Form.FormElements.Field.superclass.afterRender.call(this);var a=Ext.getCmp("selTable");if(a&&a.getValue()!=""){this.store.filter("table",a.getValue());this.setVisible(true);}ECM.publish("field_changed",[this]);},initComponent:function(){var b=ECM.Form.FormElements.ElementHelper;var k=b.getListDataFromStore(this.formObject.columnData,false);var l={};var h=[];Ext.each(k,function(n,m){if(Ext.isDefined(n)){if((!ECM.Stash.has_client_access&&(n.indexOf("AFFILIATE_ID")===0||n[0].match(/^[CORST]\_AFFILIATE\_ID$/)))||(ECM.Stash.has_client_access&&window.ecmTargetingModeOn&&ECM.Targeting.Store.SegmentData.restrictAffiliate()&&n[0].match(/^[CORST]\_AFFILIATE\_ID$/))){return true;}else{if(n[0]&&(n[0].match(/^ZIP$/)||n[0].match(/^ZIP:/))){l[n[1]]=n;}else{if(n[1]&&n[1].match(/^&nbsp/)){l[n[1]]=n;}}}if(n[1]){h.push(n);}}},this);var a=this.node.condition().columnId;if(!Ext.isEmpty(a)){a=a.replace("_PRODUCT_ID","PRODUCT_ID");}var d=this.originalColumnInfo=b.getColumnInfoFromId(a);var f;var c=new Ext.data.ArrayStore({data:h,fields:["value",{name:"text",type:"string",sortType:function(p){if(l[p]){var o=l[p];if(!Ext.isEmpty(o)){if(o[2]=="D"){var m=o[0].split(":");var n=b.getColumnInfoFromId(m[0]);if(n.text){p=m.length>1?n.text+" "+p:p+" ";}}else{p="MAILING Z"+p;}}}return Ext.data.Types.STRING.sortType(p);}},"table","type"],sortInfo:{field:"text",direction:"ASC"}});var j=c.find("value",a);if(j>-1){f=c.getAt(j).get("text");}if(this.formObject){this.formObject.currentFieldValue=f;this.formObject.currentFieldType=d.type;}var g={store:c||{}};if(a){Ext.apply(g,{value:a,text:f,columnType:d&&d.type});}Ext.apply(this,g);ECM.Form.FormElements.Field.superclass.initComponent.call(this);},doQuery:function(f,c){f=Ext.isEmpty(f)?"":f;var a={query:f,forceAll:c,combo:this,cancel:false};if(this.fireEvent("beforequery",a)===false||a.cancel){return false;}f=a.query;c=a.forceAll;if(c===true||f.length>=this.minChars){if(this.lastQuery!==f){this.lastQuery=f;this.selectedIndex=-1;var b=!!Ext.getCmp("selTable")&&Ext.getCmp("selTable").getValue()?Ext.getCmp("selTable").getValue():"";if(c||f==""){if(b&&!Ext.isEmpty(b)){this.store.filter([{property:"table",value:b}]);}else{this.store.clearFilter();}}else{var d=[{property:"text",value:f}];if(b&&!Ext.isEmpty(b)){d.push({property:"table",value:b});}this.store.filter(d);}this.onLoad();}else{this.selectedIndex=-1;this.onLoad();}}}});Ext.reg("ecm.formelements.field",ECM.Form.FormElements.Field);ECM.provide("ECM.Form.FormElements.FieldLabel");ECM.Form.FormElements.FieldLabel=Ext.extend(Ext.form.Label,{id:"field",fieldLabel:"Field",allowBlank:false,width:ECM.Form.View.Base.fieldWidth,plugins:["ecm.subscription"],subscriptions:{table_changed:function(c,a,b){ECM.publish("field_changed",arguments);}},afterRender:function(){ECM.publish("field_changed",[this].concat(arguments));},getValue:function(){return this.value;},setValue:function(a){this.setText(a);},getRawValue:function(){return this.text;},getType:function(){return this.type;}});Ext.reg("ecm.formelements.fieldlabel",ECM.Form.FormElements.FieldLabel);ECM.provide("ECM.Form.Components.Globals");ECM.Form.Components.Globals={getNotificationArea:function(a){var b=this;return{layout:"table",layoutConfig:{columns:1},border:false,cls:"ecm-condition-notify",items:[{xtype:"ECM.Notify",maxWidth:a,border:false,listeners:{beforeRender:function(c){dcForm.sourceTreeNode.ownerTree.perspective().dialog().notify=c;}}}]};}};ECM.provide("ECM.Form.FormElements.Buttons");ECM.Form.FormElements.Buttons=Ext.extend(Ext.Container,{id:"btnPanel",border:"false",cls:"cm_float_right cm_clear_both",style:"padding-top:15px;",btns:{},plugins:["ecm.subscription"],listeners:{afterrender:function(a){a.formObject.btnPanel=a;a.validateForm();}},subscriptions:{valueChanged:function(){this.validateForm();dcForm.dialog.syncShadow();}},defaults:{xtype:"button",cls:"blue_button ecm_btn_left_margin cm_float_right"},initComponent:function(){this.items=[];this.btns={};var k=this;var b=this.node;this.items.push({text:gt.gettext("Cancel"),listeners:{afterrender:function(){k.btns.cancelButton=this;}},handler:function(){dcForm.dialog.hide();}});var h=function(){var m=function(){if(Ext.isDefined(dcForm.condition.group)){dcForm.getGroupListeners();}else{dcForm.getNonGroupListeners();}mt.onConditionChange();dcForm.switchToAdvancedRequested=dcForm.switchToAdvancedRequested||false;dcForm.changeAllFieldsRequested=false;};var n=Ext.getCmp("value0");if(n){var l=Ext.get("directEntry"+n.uniqueID+"EnterValuesSection");if(n.xtype=="ecm.directentrygridpicker"&&l&&l.dom.style.display!="none"){if(!n.gridPicker.remotePage&&!n.validateEntry){m();
}else{if(dcForm.condition.columnId&&Ext.isDefined(ECM.Stash.segmentData)){n.currentConditionField=ECM.Stash.segmentData.data[1][0][dcForm.condition.columnId][0];}n.directEntryisValid(true,m);}}else{m();}}else{m();}};this.items.push({text:gt.gettext("Done"),id:"dcModalDoneButton",plugins:["ecm.subscription"],subscriptions:{targeting_submit_form:h},listeners:{afterrender:function(){k.btns.doneButton=this;},click:h}});if(dcForm.condition.group!=undefined&&dcForm.condition.mode==0){this.items.push({text:gt.gettext("Add Condition"),id:"dcModalAddButton",listeners:{afterrender:function(){k.btns.addButton=this;},click:function(m,o){var n=b;if(n.attributes.data[ECM.Rules.Constants.IDX.LOGIC]&ECM.Rules.Constants.LOGIC.GROUP){n.select();dcForm.getGroupListeners();}else{n.parentNode.select();dcForm.getNonGroupListeners();}dcForm.orMode=true;var l=b.ownerTree;l.addCondition(mt,arguments);}}});}if(dcForm.isEditMode){var f=b.attributes.data[1];var d=[];if(window.ecmTargetingModeOn){d=Ext.decode(Ext.encode(b.getJSON()));}dcForm.dialog.on("beforehide",function(){if(k.btns.cancelButton&&k.btns.cancelButton.disabled){return false;}});var j=function(m){Ext.iterate(k.btns,function(n,o){o[m]();});var l=["groupname","selInclusion"];Ext.each(l,function(o){var n=Ext.getCmp(o);if(Ext.isObject(n)&&Ext.isFunction(n[m])){n[m]();}});};var g={beforeReqCb:function(){j("disable");},successCb:function(){ECM.publish("/notify/info/clear",gt.gettext("Changes have been applied to the saved group."));j("enable");},failureCb:function(l,m){dcForm.dialog.notify.error(m);j("enable");}};var a=function(n){var l=Ext.MessageBox.buttonText.ok;var m=Ext.MessageBox.buttonText.cancel;Ext.MessageBox.buttonText.ok=gt.gettext("Keep Changes");Ext.MessageBox.buttonText.cancel=gt.gettext("Abandon Changes");Ext.Msg.show({title:gt.gettext("Edit Confirmation"),msg:gt.gettext("You have made changes. Would you like to keep these changes and continue, or abandon them?"),buttons:Ext.Msg.OKCANCEL,cls:"cm_text_align_left blue_button",fn:n});Ext.MessageBox.buttonText.ok=l;Ext.MessageBox.buttonText.cancel=m;};var c=function(){var l=Ext.apply({},g);var m=function(n){if(n=="ok"){l.successCb=l.successCb.createSequence(h);}else{l.successCb=l.successCb.createSequence(k.btns.cancelButton.handler,k.btns.cancelButton);}ECM.publish("savedgroup.update",f,d,l);};return m;};if(!b.isMainSubscription&&window.ecmTargetingModeOn){this.items.push({xtype:"splitbutton",text:gt.gettext("More Actions"),listeners:{afterrender:function(){k.btns.moreActionButton=this;},arrowclick:function(m){if(!dcForm.condition.group){return;}f=Ext.getCmp("groupname").getValue();var o=ECM.publish("savedgroup.checkexist",f);var l=false;if(!ECM.Stash.show_activity_data){if(Ext.encode(b.getJSON()).search(/\["?\d+"?,"[BCORST]"/)>-1){l=true;}}var n={addGroupMenuItem:(o||Ext.isEmpty(d)||l)?"hide":"show",removeGroupMenuItem:!o?"hide":"show",applyGroupMenuItem:(!o||Ext.isEmpty(d)||l)?"hide":"show"};Ext.iterate(n,function(p,q){m.menu[p][q]();});m.menu.doLayout();}},menu:new Ext.menu.Menu({items:[{text:"Copy",handler:function(){var l=function(n){dcForm.dialog.hide();if(b.attributes.data[0]&ECM.Rules.Constants.LOGIC.GROUP){var t=ECM.Rules.Constants;var q=mt.getGroup({node:b,tree:b.ownerTree});var s=Ext.apply({},q);s.data=Ext.decode(Ext.encode(s.data));Ext.apply(s,{fromTree:true,leaf:false,skipModal:true});var o=(function(){var u=mt.getAllGroupNames();return function(y){var x=0;var w;y=y||"";y=y.replace(/\s[(][0-9]*[)]$/,"");Ext.each(u,function(z){w=z.match(/(.*)\s[(]([0-9]*)[)]$/);if(w){if(w[1]===y){x=Math.max(x,w[2]);}}});var v=y+" ("+(x+1)+")";u.push(v);return v;};})();var p=function(u){Ext.each(u,function(v){if(v.isGroup){v.text=o(v.text);if(!v.groupData){v.groupData={};}v.groupData.name=v.text;v.groupData.logic=v.logic||undefined;if(v.data.length>0){p(v.data);}}});};if(!s.isAggregator){p(s.data);}var m=new ECM.tree.TreeNode(s);var r=b.attributes.data[1];if(s.isAggregator){r=ECM.Form.FormElements.Table.tblGroupIndex[b.attributes.data[t.IDX.AGGREGATOR][t.IDX.TABLE]].text;}m.attributes.groupData={};m.attributes.groupData.name=!s.isAggregator?o(r):r;m.attributes.groupData.logic=b.attributes.data[ECM.Rules.Constants.IDX.LOGIC];mt.dropGroup(m.attributes);}else{mt.addCondition({data:Array.clone([b.attributes.data]),skipModal:true,newFromTree:false,isCopy:true});}dcForm.unsavedSegment=true;ECM.publish("/notify/clear/all");if(n=="ok"){h();}};if(dcForm.isModified()){a(l);}else{l();}}},{text:"Delete",handler:function(){dcForm.dialog.hide();mt.deleteCondition({dataSource:mt.dataSource(),identity:mt.identity(),isSimpleTag:dcForm.isSimpleMode,node:b,rowIndex:b.ownerTree.rowIndex(),separator:"/"});mt.onConditionChange();}},{text:gt.gettext("Add to Saved Groups"),hidden:true,ref:"addGroupMenuItem",handler:function(){dcForm.dialog.notify.clear();if(dcForm.isModified()){a(c());}else{var l=Ext.apply({},g);l.successCb=l.successCb.createSequence(h);ECM.publish("savedgroup.update",f,d,l);}}},{text:gt.gettext("Remove from Saved Groups"),hidden:true,ref:"removeGroupMenuItem",handler:function(){dcForm.dialog.notify.clear();g.successCb=function(l,m){ECM.publish("/notify/info/clear",m);j("enable");k.btns.cancelButton.handler();};ECM.publish("savedgroup.remove",f,g);}},{text:gt.gettext("Apply Changes to Saved Group"),hidden:true,ref:"applyGroupMenuItem",handler:function(){dcForm.dialog.notify.clear();if(dcForm.isModified()){a(c());}else{var l=Ext.apply({},g);l.successCb=l.successCb.createSequence(h);ECM.publish("savedgroup.update",f,d,l);}}}]})});}}ECM.Form.FormElements.Buttons.superclass.initComponent.apply(this,arguments);},validateForm:function(){if(!this.el||(this.el&&!this.el.dom)){return false;}var b=this.btns.doneButton;var a=this.btns.nextButton;var d=this.btns.addButton;if(!b){return;}else{if(Ext.isDefined(dcForm.condition.group)&&!dcForm.sourceTreeNode.attributes.isAggregator){var j=this.btns.moreActionButton;var g=Ext.getCmp("groupname");if(g.isValid()===false||g.getValue().length==0){b.disable();if(a){a.disable();}if(d){d.disable();}if(j){j.disable();}}else{b.enable();if(a){a.enable();}if(d){d.enable();}if(j){j.enable();}}return;}}b.disable();var m=Ext.getCmp("value0");var k=Ext.getCmp("value1");var c=Ext.getCmp("operator");var l=parseInt(c?c.selectedOperatorId:null);var f=[23,24,53,54,85,86,135,136].indexOf(isNaN(l)?null:l);if(f>=0){b.enable();return;}var r=Ext.getCmp("includeNoValue");var p=Ext.getCmp("field");var q=(p&&Ext.isFunction(p.getStore))?p.getStore():false;var o=true;if(q){var n=q.find("value",p.getValue());if(n>-1){o=q.getAt(n).get("type");o=(o!=ECM.Rules.Constants.TYPES.STRING)&&(o!=ECM.Rules.Constants.TYPES.NUMERIC)&&(o!=ECM.Rules.Constants.TYPES.URL);}}if(k){var s=m.isValid(true)&&k.isValid(true);var h=(r&&o)?(s||r.checked):s;b.setDisabled(!h);}else{if(m){b.setDisabled(!(m.isValid(true)||(r&&r.checked&&o)));}}}});Ext.reg("ecm.formelements.buttons",ECM.Form.FormElements.Buttons);ECM.provide("ECM.Form.View.Simple");ECM.Form.View.Simple={getConfig:function(c){var f=ECM.Form.FormElements.ElementHelper;c.node=c.node||f.getDefaultNode();var b=c.node.ownerTree.identity();if(dcForm.changeAllFieldsRequested||ECM.Rules.Tablespace.totalRules({identity:b})<=1){dcForm.isFieldSelectable=true;}else{dcForm.isFieldSelectable=false;if(!dcForm.lastAddedRuleField){dcForm.lastAddedRuleField=dcForm.columnData.getById(c.node.condition().columnId).get("text");}}var g,d;if(c.node.condition().columnId){g=dcForm.columnData.getById(c.node.condition().columnId).get("value");d=dcForm.columnData.getById(c.node.condition().columnId).get("text");}var a=[{id:"simpleViewPanel",xtype:"panel",layout:"form",layoutConfig:{trackLabels:true},defaults:{node:c.node,formObject:dcForm},items:Ext.clean([ECM.Form.Components.Globals.getNotificationArea.createDelegate(dcForm.sourceTreeNode.ownerTree.perspective(),[480])(),(!dcForm.isEditMode)?({xtype:"field",fieldLabel:"Description",id:"desc",width:ECM.Form.View.Base.fieldWidth,listeners:{change:function(h,k){var j=ECM.Rules.Constants;ECM.Subscribers.notify({bundle:[k],topic:j.TOPIC.TARGETING.LABEL.CONSTRUCT});
ECM.Subscribers.notify({bundle:[{value:k,rowIndex:c.node.ownerTree.rowIndex(),identity:c.node.ownerTree.identity()}],topic:j.TOPIC.TARGETING.LABEL.CHANGE});}}}):false,{xtype:dcForm.isFieldSelectable?"ecm.formelements.table":"label",text:"ALL",fieldLabel:"Table"},{xtype:(dcForm.isFieldSelectable?"ecm.formelements.field":"ecm.formelements.fieldlabel"),value:g,text:(d||"Select field..."),type:ECM.Rules.Constants.TYPES.STRING},(dcForm.isFieldSelectable?false:{xtype:"label",html:"<span onclick='ECM.Rules.Form.changeAllFields()' style='cursor:pointer;color:blue;text-decoration:underline;'>Change field for all rules</span>",fieldLabel:"&nbsp;",labelSeparator:""}),ECM.Form.View.Simple.getOperatorList(),{xtype:"label",html:"Need a different operator? Switch to <span onclick='ECM.Rules.Form.switchToAdvanced()' style='cursor:pointer;color:blue;text-decoration:underline;'>Advanced</span>.",fieldLabel:"&nbsp;",labelSeparator:"",id:"advancedSwitcher"},{xtype:"ecm.formelements.value"},{xtype:"ecm.formelements.buttons"}])}];return a;},getOperatorList:function(){var a=[["29","is",30,1]];return{xtype:"label",text:"is",id:"operator",fieldLabel:"Operator",allowBlank:false,hidden:true,store:a,plugins:["ecm.subscription"],operators:a,numValues:a[0][3],selectedOperatorId:"29",subscriptions:{field_changed:function(c){var h=c[0].getValue();var d=ECM.Form.FormElements.ElementHelper;var g=d.getColumnInfoFromId(h,dcForm.columnData);var j=(h!=""&&dcForm.isConditionEditSupported(g.type));this.setVisible(j);var f=gt.gettext("Need a different operator? Switch to ")+"<span onclick='ECM.Rules.Form.switchToAdvanced()' style='cursor:pointer;color:blue;text-decoration:underline;'>"+gt.gettext("Advanced")+"</span>.";if(h!=""&&!j){f=gt.gettext("Want to use this field? Switch to ")+"<span onclick='ECM.Rules.Form.switchToAdvanced()' style='cursor:pointer;color:blue;text-decoration:underline;'>"+gt.gettext("Advanced")+"</span>.";}var b=Ext.getCmp("advancedSwitcher");if(b.rendered){b.update(f);}ECM.publish("operator_changed",{columnInfo:g});}}};}};ECM.provide("ECM.Form.FormElements.Action");(function(){var a=new Ext.data.SimpleStore({fields:["id","val"],data:[[20,"AND Include"],[36,"AND Exclude"],[24,"OR Include"],[40,"OR Exclude"]]});var b=60;ECM.Form.FormElements.Action=Ext.extend(Ext.form.ComboBox,{id:"selInclusion",fieldLabel:"Action",disabled:false,allowBlank:false,mode:"local",editable:false,triggerAction:"all",store:a,valueField:"id",displayField:"val",width:ECM.Form.View.Base.fieldWidth,forceSelection:true,listeners:{select:function(){ECM.publish("action_changed",{args:arguments});}},getValueFromNode:function(){var d=this.node.attributes.data[ECM.Rules.Constants.IDX.LOGIC];if(this.node.attributes.isAggregator){d=this.node.attributes.data[ECM.Rules.Constants.IDX.AGGREGATOR][ECM.Rules.Constants.IDX.LOGIC];}var c=d&ECM.Rules.Constants.LOGIC.INCLUDE?true:false;return d&b;},initComponent:function(){(function(){this.setValue(this.getValueFromNode());}).defer(80,this);this.value=this.originalValue=this.getValueFromNode();ECM.Form.FormElements.Action.superclass.initComponent.call(this);}});})();Ext.reg("ecm.formelements.action",ECM.Form.FormElements.Action);ECM.provide("ECM.Form.FormElements.Operator");(function(){ECM.Form.FormElements.Operator=Ext.extend(Ext.Container,{id:"operatorPanel",layout:"form",plugins:["ecm.subscription"],subscriptions:{field_changed:function(){this.doChangeField();}},initComponent:function(){if(this.node.attributes.isAggregator){this.labelWidth=125;}var b=Ext.getCmp("field");if(b&&b.getValue()!=""){var a=this.getInterfaceHash(b);Ext.apply(this,{items:[a]});}ECM.Form.FormElements.Operator.superclass.initComponent.call(this);},getInterfaceHash:function(m){var c=ECM.Form.FormElements.ElementHelper;var d=c.getColumnInfoFromId(m.getValue(),dcForm.columnData);var l=0;var n=false;var f="";var a=this.selectedOperatorId;var g=this.getOperators(d);if(dcForm.sourceTreeNode.stripeIndex==0&&window.ecmTargetingModeOn){this.operators=g=Ext.partition(g,function(o){return[84,130].indexOf(parseInt(o[0]))===-1;})[0];}var b=this.getDisplayOperators(g,d.type);if(a){for(var h=0,k=b.length;h<k;h++){if(a==b[h][0]){n=true;l=b[h][3];f=b[h][1];break;}else{if(a==b[h][2]){n=true;l=b[h][3];a=b[h][0];f=b[h][1];}}}}if(b.length==1){if(b[0][0]=="11"){f="is";a="11";}else{if(b[0][0]=="145"){f="parts";a="145";}}l=b[0][3];}else{if(!n){a=b[0][0];f=b[0][1];l=b[0][3];}}var j={};if(b.length==1){b[0][1]="is";j={xtype:"label",text:f,getValue:function(){return this.selectedOperatorId;}};}else{j={xtype:"combo",isDirty:false,allowBlank:false,width:ECM.Form.View.Base.fieldWidth,editable:false,forceSelection:true,triggerAction:"all",store:Ext.StoreMgr.lookup(b),listeners:{select:function(){this.selectedOperatorId=this.getValue();var o=Ext.getCmp("field");if(o){o.isDirty=false;}this.isDirty=true;ECM.publish("operator_changed",{args:arguments});}}};}Ext.apply(j,{id:"operator",fieldLabel:"Operator",value:a,operators:g,selectedOperatorId:a,columnType:d.type,numValues:l});return j;},getOperators:function(c){var a=this.node.dataStore({columnId:c.value,switchToAdvanced:dcForm.switchToAdvancedRequested,types:["operator"]})[0];if(c.type==undefined){c.type=ECM.Rules.Constants.TYPES.STRING;}var d=[];if(a){for(var f=0,h=a.data.items.length;f<h;f++){var l=a.data.items[f].data.assocTypes;if(l.indexOf("|"+c.type+"|")>-1){var b=a.data.items[f].data.assocNullOption;var k=a.data.items[f].data.numValues;var j=a.data.items[f].id;var g=a.data.items[f].data.text;d.push([j,g,b,k]);}}}return d;},getDisplayOperators:function(g,c){var h=[];var f=[];for(var b=0,a=g.length;b<a;b++){if(g[b][2]>=0||g[b][2]==-2){var d=this.fetchOperatorPlacementIndex(g[b][0],c);if(d>=0){h[d]=g[b];}else{f.push(g[b]);}}}if(f.length>0){h=h.concat(f);}var a=h.length;for(var b=a-1;b>=0;b--){if(h[b]==undefined){h.splice(b,1);}}return h;},fetchOperatorPlacementIndex:function(c,f){var b=-1;var h=[];var g={ASSOCIATIVE:"enumList",STRING:"string",SUBSCRIPTION:"subscription",NUMERIC:"numeric",ZIP:"zipcode",DATE:"date",DATETIME:"datetime",BITMASK:"bitmask",BEHAVIOR:"behavior"};Ext.iterate(g,function(j,k){if(this[j]==f){h=ECM.Rules.Form.Operators.Order[k];return true;}},ECM.Rules.Constants.TYPES);for(var d=0,a=h.length;d<a;d++){if(c==h[d]){b=d;break;}}return b;},doChangeField:function(){this.removeAll();var b=Ext.getCmp("field");if(b&&b.getValue()!=""){var a=this.getInterfaceHash(b);this.add(a);}this.doLayout();ECM.publish("operator_changed");}});Ext.reg("ecm.formelements.operator",ECM.Form.FormElements.Operator);})();ECM.provide("ECM.Form.View.Advanced");ECM.Form.View.Advanced={getConfig:function(b){var c=ECM.Form.FormElements.ElementHelper;var a=[{xtype:"panel",layout:"form",layoutConfig:{trackLabels:true},defaults:{node:b.node,formObject:dcForm,selectedOperatorId:ECM.Form.View.Advanced.getSelectedOperator()},items:Ext.clean([ECM.Form.Components.Globals.getNotificationArea.createDelegate(dcForm.sourceTreeNode.ownerTree.perspective(),[480])(),dcForm.isEditMode||(Ext.isDefined(b.node.previousSibling)&&b.node.previousSibling!=null)?false:{xtype:"ecm.formelements.description"},{xtype:"ecm.formelements.action"},{xtype:"ecm.formelements.table"},{xtype:"ecm.formelements.field"},{xtype:"ecm.formelements.operator"},dcForm.switchToAdvancedRequested?dcForm.getSimpleSwitchInterface():false,{xtype:"ecm.formelements.value"},{xtype:"ecm.formelements.null"},{xtype:"panel",id:"actionChangedWarning",style:"padding-top:10px",hidden:true,html:gt.gettext("Changing the action of this condition will change the action for the entire group."),plugins:["ecm.subscription"],subscriptions:{action_changed:function(d){if((d.args[0].value&ECM.Rules.Constants.LOGIC.OR)&&(d.args[0].originalValue&ECM.Rules.Constants.LOGIC.AND)){this.show();}else{this.hide();}}}},{xtype:"ecm.formelements.buttons"},false])}];return a;},getSelectedOperator:function(){return(!!dcForm.isSystemGroup&&!!dcForm.sourceTreeNode.attributes.data[2])?dcForm.sourceTreeNode.attributes.data[2][3]:dcForm.condition.operatorId;},getValueInterface:function(a){var b=new ECM.Form.FormElements.Value({numValues:1});
return b;}};ECM.provide("ECM.Form.FormElements.Null");(function(){ECM.Form.FormElements.Null=Ext.extend(Ext.Panel,{id:"noValueTable",border:"false",width:601,plugins:["ecm.subscription"],subscriptions:{valueChanged:function(){var b=Ext.getCmp("operator");this.selectedOperatorId=b?b.getValue():null;var a=Ext.getCmp("includeNoValue");var c=Ext.getCmp("noValuePanel");var d=this.operatorStatus();if(d.hidden){Ext.getCmp("includeNoValue").setValue(!this.operatorStatus().hidden);c.hide();}else{c.show();if(d.hideLabel){a.showLabel(false);if(c.el){c.el.addClass("noValueGridPicker");}}else{a.showLabel(true);if(c.el){c.el.removeClass("noValueGridPicker");}}}}},operatorStatus:function(){var d=Ext.getCmp("value0");var a=true,g=false;var b=d&&d.xtype.indexOf("gridpicker")>=0;var f=__options__.operators[this.selectedOperatorId];if(f&&f[5]>-2){a=false;g=(f[5]==-1);if(!Ext.getCmp("operator")||Ext.getCmp("operator").columnType==ECM.Rules.Constants.TYPES.BEHAVIOR){a=true;}}if(this.formObject.currentFieldValue=="E-mail address"){a=false;}var c=/city\/state/i;if(c.test(this.formObject.currentFieldValue)){a=false;g=Ext.isDefined(this.node.condition().operands)&&this.node.condition().operands[0].indexOf("NULL (empty, unspecified)")>-1;}return{hidden:a,checked:g,hideLabel:b};},initComponent:function(){var a=this.operatorStatus();this.items=[{xtype:"panel",layout:"form",border:false,id:"noValuePanel",hidden:a.hidden,items:[{xtype:"checkbox",id:"includeNoValue",boxLabel:gt.gettext("Include empty (no value)"),checked:a.checked,listeners:{check:function(){var c=Ext.getCmp("value0"),b=Ext.getCmp("value1");if(c&&Ext.isEmpty(c.getValue())){this.checked?c.clearInvalid():c.isValid();}if(b&&Ext.isEmpty(b.getValue())){this.checked?b.clearInvalid():b.isValid();}ECM.publish("null_check",{args:arguments});ECM.publish("valueChanged",{args:arguments});}},hideLabel:a.hideLabel,showLabel:function(b){if(this.container&&this.label){if(b){this.container.dom.style.paddingLeft="105px";this.label.dom.style.display="inline";}else{this.container.dom.style.paddingLeft="0px";this.label.dom.style.display="none";}}}}]}];ECM.Form.FormElements.Null.superclass.initComponent.apply(this,arguments);}});})();Ext.reg("ecm.formelements.null",ECM.Form.FormElements.Null);ECM.provide("ECM.Form.FormElements.Description");ECM.Form.FormElements.Description=Ext.extend(Ext.form.Field,{elHelper:ECM.Form.FormElements.ElementHelper,id:"desc",fieldLabel:"Description",width:ECM.Form.View.Base.fieldWidth,listeners:{change:function(a,c){var b=ECM.Rules.Constants;ECM.Subscribers.notify({bundle:[c],topic:b.TOPIC.TARGETING.LABEL.CONSTRUCT});ECM.Subscribers.notify({bundle:[{value:c,rowIndex:this.node.ownerTree.rowIndex(),identity:this.node.ownerTree.identity()}],topic:b.TOPIC.TARGETING.LABEL.CHANGE});}}});Ext.reg("ecm.formelements.description",ECM.Form.FormElements.Description);ECM.provide("ECM.Form.FormElements.ActivityWarning");(function(){var a=(new Date()).add(Date.MONTH,(-1)*parseInt(ECM.Stash.retention_policy)).format("F j, Y");var b=gt.strargs(gt.gettext("Activity Data is available for querying from %1 to today."),[a]);ECM.Form.FormElements.ActivityWarning=Ext.extend(Ext.Panel,{plugins:["ecm.subscription"],html:b,style:"margin-bottom: 8px",subscriptions:{field_changed:function(c){this.hide();if(Ext.isDefined(c)){var d=c[0];if(d.getId()==="field"&&Ext.getCmp("selTable").isActivity()&&(parseInt(d.getType())===ECM.Rules.Constants.TYPES.DATE||parseInt(d.getType())===ECM.Rules.Constants.TYPES.DATETIME)){this.show();}}}},initComponent:function(){ECM.Form.FormElements.ActivityWarning.superclass.initComponent.apply(this,arguments);}});})();Ext.reg("ecm.formelements.activitywarning",ECM.Form.FormElements.ActivityWarning);ECM.provide("ECM.Form.View.Targeting");ECM.Form.View.Targeting={getConfig:function(b){var c=ECM.Form.FormElements.ElementHelper;b.node=b.node||c.getDefaultNode();var a=[{xtype:"panel",layout:"form",layoutConfig:{trackLabels:true},defaults:{node:b.node,formObject:dcForm,selectedOperatorId:ECM.Form.View.Targeting.getSelectedOperator()},items:Ext.clean([ECM.Form.Components.Globals.getNotificationArea.createDelegate(dcForm.sourceTreeNode.ownerTree.perspective(),[480])(),{xtype:"ecm.formelements.activitywarning"},{xtype:"ecm.formelements.action"},{xtype:"ecm.formelements.table"},{xtype:"ecm.formelements.field"},{xtype:"ecm.formelements.operator"},{xtype:"ecm.formelements.value"},{xtype:"ecm.formelements.null"},{xtype:"panel",id:"actionChangedWarning",style:"padding-top:10px",hidden:true,html:gt.gettext("Changing the action of this condition will change the action for the entire group."),plugins:["ecm.subscription"],subscriptions:{action_changed:function(d){if((d.args[0].value&ECM.Rules.Constants.LOGIC.OR)&&(d.args[0].originalValue&ECM.Rules.Constants.LOGIC.AND)){this.show();}else{this.hide();}}}},{xtype:"ecm.formelements.buttons"},false])}];return a;},getSelectedOperator:function(){if(dcForm.condition.operatorId==75||dcForm.condition.operatorId==76){var b=Ext.encode(dcForm.sourceTreeNode.attributes.data[4][0]);var a=Ext.encode(dcForm.sourceTreeNode.attributes.data[4][1]);if(b==a){dcForm.condition.operatorId=dcForm.condition.operatorId==75?55:56;}}if(dcForm.condition.operatorId==77||dcForm.condition.operatorId==78){var b=Ext.encode(dcForm.sourceTreeNode.attributes.data[4][0]);var a=Ext.encode(dcForm.sourceTreeNode.attributes.data[4][1]);if(b==a){dcForm.condition.operatorId=dcForm.condition.operatorId==77?57:58;}}return(!!dcForm.isSystemGroup&&!!dcForm.sourceTreeNode.attributes.data[2])?dcForm.sourceTreeNode.attributes.data[2][3]:dcForm.condition.operatorId;},getValueInterface:function(a){var b=new ECM.Form.FormElements.Value({numValues:1});return b;}};ECM.provide("ECM.Form.View.Triggered");ECM.Form.View.Triggered={getConfig:function(d){var b=this;var f=ECM.Form.FormElements.ElementHelper;var c=dcForm.condition.operands[0];var g=c==="";var a=[{xtype:"panel",layout:"form",defaults:{node:d.node,formObject:dcForm},items:Ext.clean([ECM.Form.Components.Globals.getNotificationArea.createDelegate(dcForm.sourceTreeNode.ownerTree.perspective(),[480])(),dcForm.isEditMode?false:{xtype:"ecm.formelements.description"},{xtype:"textfield",id:"value0",width:ECM.Form.View.Base.fieldWidth,fieldLabel:"Value",invalidText:"A value must be specified.",enableKeyEvents:true,initComponent:function(){var h=this.node.condition().operands[0];if(h!=="Create Condition"){this.value=h;}Ext.form.TextField.superclass.initComponent.call(this);},listeners:{afterrender:this.validateForm,change:this.validateForm,keyup:this.validateForm}},{xtype:"panel",layout:"table",id:"noValueTable",border:false,layoutConfig:{tableAttrs:{style:{width:ECM.Form.View.Base.fieldWidth}},columns:1},items:[{xtype:"panel",layout:"form",border:false,items:[{xtype:"checkbox",id:"EbmUseBlank",boxLabel:"Use blank value",checked:g,listeners:{check:function(h,j){b.validateForm();}}}]}]},{id:"btnPanel",border:"false",style:"padding-top:15px;",validateForm:this.validateForm,defaults:{xtype:"button",cls:"blue_button ecm_btn_left_margin",style:"float:right"},items:[{text:gt.gettext("Cancel"),listeners:{click:function(){dcForm.dialog.hide();}}},{text:gt.gettext("Done"),id:"dcModalDoneButton",disabled:true,listeners:{click:function(){dcForm.getGroupListeners();mt.onConditionChange();}}}]},false])}];return a;},validateForm:function(){var b=Ext.getCmp("EbmUseBlank");var a=Ext.getCmp("dcModalDoneButton");var c=Ext.getCmp("value0");if(b){if(c.getRawValue()==""){b.setDisabled(false);}else{b.setDisabled(true);}}if(c.getRawValue()==""&&!b.checked){a.disable();c.enable();}else{if(b.checked){c.disable();}a.enable();}}};ECM.provide("ECM.Form.FormElements.Aggregator");ECM.Form.FormElements.Aggregator=Ext.extend(Ext.form.ComboBox,{id:"selAggregator",fieldLabel:"Aggregator",emptyText:gt.gettext("Please Select..."),width:ECM.Form.View.Base.fieldWidth,valueField:"id",displayField:"val",store:[],triggerAction:"all",mode:"local",listeners:{select:function(c,a,b){ECM.publish("aggregator_changed",c,a,b);if(c.getValue()&ECM.Rules.Constants.LOGIC.COUNT){ECM.publish("valueChanged",c,a,b);
}},beforeselect:function(c,a,b){this.lastSelectionText=a.data[this.displayField];this.el.dom.value=a.data[this.displayField];this.value=a.data[this.valueField];this.collapse();this.fireEvent("select",this,a,b);return false;}},plugins:["ecm.subscription"],subscriptions:{table_changed:function(d,a,c){this.clearValue();var b=this.getAggregators(a.id);this.store.loadData(b);this.show();ECM.publish("aggregator_changed");}},beforeBlur:function(){var b=this.getRawValue(),a=this.findRecord(this.displayField,b);if(!a&&this.forceSelection){if(b.length>0&&b!=this.emptyText){this.el.dom.value=Ext.isDefined(this.lastSelectionText)?this.lastSelectionText:"";this.applyEmptyText();}else{this.clearValue();}}else{if(a){if(b==a.get(this.displayField)){return;}b=a.get(this.valueField||this.displayField);}this.setValue(b);}},initComponent:function(){var f=ECM.Rules.Constants;var b=f.LOGIC;var d=Ext.getCmp("selTable");var c;if(d&&d.getValue()!=""){c=this.getAggregators(d.getValue());}else{c=this.getAggregators();}this.store=new Ext.data.ArrayStore({fields:["id","val","types"],data:c});var a=b.COUNT+b.UNIQUE+b.MIN+b.MAX+b.AVERAGE+b.SUM;this.value=this.node.attributes.data[f.IDX.LOGIC]&a;ECM.Form.FormElements.Aggregator.superclass.initComponent.call(this);},afterRender:function(){ECM.Form.FormElements.Aggregator.superclass.afterRender.call(this);var a=ECM.Rules.Constants;var b=a.LOGIC;var h=this.node.attributes.data[a.IDX.AGGREGATOR];var g=__catalog__.columns[2];var k=g[h[a.IDX.COLUMN]];if(!Ext.isEmpty(k)){var f,c=parseInt(k[a.CATALOG.COLUMN[a.TAG.SIMPLE].TYPE]);f=this.store.findBy(function(l){if(l.data.id==this.value&&l.data.types[0]==c){return true;}},this);if(f>=0){var d=this.store.getAt(f);this.lastSelectionText=d.data.val;this.el.dom.value=d.data.val;}}var j=Ext.getCmp("selTable");this.setVisible((j&&j.getValue()!=""));ECM.publish("field_changed",[this]);},getAggregators:function(h){var g=ECM.Rules.Constants;var d={COUNT:[g.LOGIC.COUNT,gt.gettext("Count"),[]],UNIQUE:[g.LOGIC.UNIQUE,gt.gettext("Unique Count"),[]],AVERAGE:[g.LOGIC.AVERAGE,gt.gettext("Average"),[3]],MAX:[g.LOGIC.MAX,gt.gettext("Max"),[3]],MIN:[g.LOGIC.MIN,gt.gettext("Min"),[3]],SUM:[g.LOGIC.SUM,gt.gettext("Sum"),[3]],FIRST:[g.LOGIC.MIN,gt.gettext("First"),[14]],LAST:[g.LOGIC.MAX,gt.gettext("Last"),[14]]};var f=[];f.push(d.COUNT,d.UNIQUE);var b=__catalog__.columns[2];var a=[];if(h){for(key in b){var c=b[key];if(c[2]==h&&a.indexOf(c[1])<0){a.push(c[1]);switch(c[1]){case"3":f.push(d.AVERAGE,d.MAX,d.MIN,d.SUM);break;case"4":case"14":f.push(d.FIRST,d.LAST);break;}}}}return f;}});Ext.reg("ecm.formelements.aggregator",ECM.Form.FormElements.Aggregator);ECM.provide("ECM.Form.FormElements.AggregatorTable");ECM.Form.FormElements.AggregatorTable=Ext.extend(ECM.Form.FormElements.Table,{id:"selTable",fieldLabel:"Aggregate By",initComponent:function(){var a=ECM.Rules.Constants;this.value=this.node.attributes.data[a.IDX.AGGREGATOR][a.IDX.TABLE];ECM.Form.FormElements.AggregatorTable.superclass.initComponent.call(this);}});Ext.reg("ecm.formelements.aggregatortable",ECM.Form.FormElements.AggregatorTable);ECM.provide("ECM.Form.FormElements.AggregatorField");ECM.Form.FormElements.AggregatorField=Ext.extend(ECM.Form.FormElements.Field,{fieldLabel:"Aggregate using field",getFilterFunction:function(a){var b=Ext.getCmp("selTable");return function(f,g){var d=f.data,c=d.type*1;if(b&&b.getValue()){if(b.getValue()!=d.table||d.value.indexOf("MAILING_TAG")>-1){return false;}else{if(a){if(a.data.types.length>0&&a.data.types.indexOf(c)<0){return false;}}}}return true;};},subscriptions:{aggregator_changed:function(h,b,d){if(b){var f=[];if(b.data.val=="Count"){this.hide();ECM.publish("field_changed");return;}var g=Ext.getCmp("selTable").getValue();var a=this.getValue();this.clearValue();this.store.filterBy(this.getFilterFunction(b));if(!this.findRecord(this.valueField,a)){var c=[this];for(i=0;i<arguments.length;i++){c.push(arguments[i]);}ECM.publish("field_changed",c);}else{this.setValue(a);}this.show();}else{this.hide();}ECM.publish("field_changed");}},afterRender:function(){ECM.Form.FormElements.AggregatorField.superclass.afterRender.call(this);this.store.filterBy(this.getFilterFunction());var h=ECM.Rules.Constants;var f=this.node.attributes.data[h.IDX.LOGIC]&h.LOGIC.COUNT;if(f){this.hide();}var d=this.store.find("value",this.node.attributes.data[h.IDX.AGGREGATOR][h.IDX.COLUMN]);var a;if(d>0){a=this.store.getAt(d).get("type");}var g=Ext.getCmp("selAggregator");if(g&&g.getValue()){var b=g.getStore();var c=b.findBy(function(j){if(j.get("id")==g.getValue()){if(Ext.isEmpty(j.get("types"))){return true;}if(a&&j.get("types").indexOf(a*1)>=0){return true;}}});if(c>=0){ECM.publish("aggregator_changed",g,b.getAt(c),c);}}}});Ext.reg("ecm.formelements.aggregatorfield",ECM.Form.FormElements.AggregatorField);ECM.provide("ECM.Form.FormElements.AggregatorOperator");(function(){ECM.Form.FormElements.AggregatorOperator=Ext.extend(ECM.Form.FormElements.Operator,{plugins:["ecm.subscription"],subscriptions:{field_changed:function(){this.doChangeField();},aggregator_changed:function(){this.doChangeField();}},initComponent:function(){if(this.node.attributes.isAggregator){this.labelWidth=125;}var b=Ext.getCmp("field");var c=Ext.getCmp("selAggregator");if(b&&b.getValue()!=""){var a=this.getInterfaceHash(b);}else{if(c&&c.getValue()&ECM.Rules.Constants.LOGIC.COUNT){var a=this.getInterfaceHash("COUNT");}}if(a){Ext.apply(this,{items:[a]});}ECM.Form.FormElements.Operator.superclass.initComponent.call(this);},getInterfaceHash:function(n){var d=ECM.Form.FormElements.ElementHelper;var f;if(n=="COUNT"){f={text:"",type:"13"};}else{f=d.getColumnInfoFromId(n.getValue(),dcForm.columnData);}var b=Ext.getCmp("selAggregator");if(b&&b.getValue()&ECM.Rules.Constants.LOGIC.UNIQUE){f.type="13";}var m=0;var o=false;var h="";var a=this.selectedOperatorId;var g=this.getOperators(f);if(dcForm.sourceTreeNode.stripeIndex==0&&window.ecmTargetingModeOn){this.operators=g=Ext.partition(g,function(q){return[84,130].indexOf(parseInt(q[0]))===-1;})[0];}var c=this.getDisplayOperators(g,f.type);var p=[];Ext.each(c,function(s,r,q){if(["23","24","53","54"].indexOf(s[0])==-1){p.push(s);}});c=p;if(a){for(var j=0,l=c.length;j<l;j++){if(a==c[j][0]){o=true;m=c[j][3];h=c[j][1];break;}else{if(a==c[j][2]){o=true;m=c[j][3];a=c[j][0];h=c[j][1];}}}}if(c.length==1){if(c[0][0]=="11"){h="is";a="11";}else{if(c[0][0]=="145"){h="parts";a="145";}}m=c[0][3];}else{if(!o){a=c[0][0];h=c[0][1];m=c[0][3];}}var k={};if(c.length==1){c[0][1]="is";k={xtype:"label",text:h,getValue:function(){return this.selectedOperatorId;}};}else{k={xtype:"combo",isDirty:false,allowBlank:false,width:ECM.Form.View.Base.fieldWidth,editable:false,forceSelection:true,triggerAction:"all",store:Ext.StoreMgr.lookup(c),listeners:{select:function(){this.selectedOperatorId=this.getValue();var q=Ext.getCmp("field");if(q){q.isDirty=false;}this.isDirty=true;ECM.publish("operator_changed",{args:arguments});}}};}Ext.apply(k,{id:"operator",fieldLabel:"Operator",value:a,operators:g,selectedOperatorId:a,columnType:f.type,numValues:m});return k;},getOperators:function(d){var b=ECM.Rules.Constants;var o=Ext.getCmp("selAggregator");if(!d.type&&o&&o.getValue()){var h=[b.LOGIC.COUNT,b.LOGIC.UNIQUE].indexOf(o.getValue())>-1;if(h){d={text:"",type:"13"};}}var a=this.node.dataStore({columnId:d.value,switchToAdvanced:dcForm.switchToAdvancedRequested,types:["operator"]})[0];if(d.type==undefined){d.type=ECM.Rules.Constants.TYPES.STRING;}var f=[];if(a){for(var g=0,k=a.data.items.length;g<k;g++){var n=a.data.items[g].data.assocTypes;if(n.indexOf("|"+d.type+"|")>-1){var c=a.data.items[g].data.assocNullOption;var m=a.data.items[g].data.numValues;var l=a.data.items[g].id;var j=a.data.items[g].data.text;f.push([l,j,c,m]);}}}return f;},doChangeField:function(){this.removeAll();var d=ECM.Rules.Constants;var c;var a=Ext.getCmp("selAggregator");if(a&&a.getValue()==""){ECM.publish("operator_changed");return;}if(a&&a.getValue()&d.LOGIC.COUNT){c={getValue:function(){return"COUNT";}};
}else{c=Ext.getCmp("field");}if(c&&c.getValue()!=""){var b=this.getInterfaceHash(c);this.add(b);}this.doLayout();ECM.publish("operator_changed");}});Ext.reg("ecm.formelements.aggregatoroperator",ECM.Form.FormElements.AggregatorOperator);})();ECM.provide("ECM.Form.View.Aggregator");ECM.Form.View.Aggregator={getConfig:function(b){var c=ECM.Form.FormElements.ElementHelper;var a=[{xtype:"panel",layout:"form",id:"aggrForm",labelWidth:125,layoutConfig:{trackLabels:true},defaults:{node:b.node,formObject:dcForm,selectedOperatorId:ECM.Form.View.Aggregator.getSelectedOperator()},items:Ext.clean([ECM.Form.Components.Globals.getNotificationArea.createDelegate(dcForm.sourceTreeNode.ownerTree.perspective(),[480])(),{xtype:"ecm.formelements.activitywarning"},{xtype:"ecm.formelements.action"},{xtype:"ecm.formelements.aggregatortable"},{xtype:"ecm.formelements.aggregator"},{xtype:"ecm.formelements.aggregatorfield"},{xtype:"ecm.formelements.aggregatoroperator"},{xtype:"ecm.formelements.value"},{xtype:"ecm.formelements.buttons"},false])}];return a;},getSelectedOperator:function(){return(!!dcForm.isSystemGroup&&!!dcForm.sourceTreeNode.attributes.data[2])?dcForm.sourceTreeNode.attributes.data[2][3]:dcForm.condition.operatorId;},getValueInterface:function(a){var b=new ECM.Form.FormElements.Value({numValues:1});return b;}};ECM.provide("ECM.Form.View.SubscriptionList");ECM.Form.View.SubscriptionList={getConfig:function(b){var c=ECM.Form.FormElements.ElementHelper;b.node=b.node||c.getDefaultNode();var a=[{xtype:"panel",layout:"form",defaults:{node:b.node,formObject:dcForm,selectedOperatorId:ECM.Form.View.Advanced.getSelectedOperator()},items:Ext.clean([ECM.Form.Components.Globals.getNotificationArea.createDelegate(dcForm.sourceTreeNode.ownerTree.perspective(),[480])(),{xtype:"label",fieldLabel:"Action",text:"Include",id:"selInclusion",getValue:function(){return 20;}},{xtype:"ecm.formelements.fieldlabel",value:"PRODUCT_ID",text:"Subscription List",type:ECM.Rules.Constants.TYPES.SUBSCRIPTION,originalColumnInfo:{value:"PRODUCT_ID",type:ECM.Rules.Constants.TYPES.SUBSCRIPTION}},{xtype:"ecm.formelements.operator"},{xtype:"ecm.formelements.value"},{xtype:"ecm.formelements.buttons"},{xtype:"hidden",id:"selTable",value:"L"},false])}];return a;},getSelectedOperator:function(){return(!!dcForm.isSystemGroup&&!!dcForm.sourceTreeNode.attributes.data[2])?dcForm.sourceTreeNode.attributes.data[2][3]:dcForm.condition.operatorId;},getValueInterface:function(a){var b=new ECM.Form.FormElements.Value({numValues:1});return b;}};ECM.provide("ECM.Form.FormElements.GroupName");ECM.Form.FormElements.GroupName=Ext.extend(Ext.form.TextField,{id:"groupname",fieldLabel:gt.gettext("Group Name"),maxLength:100,maxLengthText:gt.gettext("A group name must be shorter than 100 characters."),blankText:gt.gettext("A group name must be specified."),width:ECM.Form.View.Base.fieldWidth,value:"",enableKeyEvents:true,listeners:{afterrender:function(){},keyup:function(a,b){if(b.getKey()==13){ECM.Rules.Form.getGroupListeners();}if(a.allowBlank){a.allowBlank=false;a.validate();}ECM.publish("valueChanged");},change:function(a,b){ECM.publish("valueChanged");}},initComponent:function(){this.setValue(dcForm.condition.group===ECM.Locale.fetch({key:"CREATE_GROUP"})?"":dcForm.condition.group);ECM.Form.FormElements.GroupName.superclass.initComponent.call(this);}});Ext.reg("ecm.formelements.groupname",ECM.Form.FormElements.GroupName);ECM.provide("ECM.Form.View.Group");ECM.Form.View.Group={getConfig:function(c){var d=ECM.Form.FormElements.ElementHelper;c.node=c.node||d.getDefaultNode();var b=[ECM.Form.Components.Globals.getNotificationArea.createDelegate(dcForm.sourceTreeNode.ownerTree.perspective(),[480])()];if(!!c.node.attributes.orWarning){b.push({xtype:"panel",id:"groupOrWarning",style:"padding-bottom:10px",html:gt.gettext("Conditions must be part of a group in order to 'or' them.")});}if(dcForm.condition.mode==1){b.push({xtype:"ecm.formelements.action"});}b.push({xtype:"ecm.formelements.groupname"},{xtype:"ecm.formelements.buttons"});var a=[{xtype:"panel",layout:"form",defaults:{node:c.node,formObject:dcForm},items:Ext.clean(b)}];return a;}};ECM.provide("ECM.Form.FormElements.ValueHelpers.String");ECM.Form.FormElements.ValueHelpers.String={valueType:[ECM.Rules.Constants.TYPES.STRING,ECM.Rules.Constants.TYPES.URL],generateHash:function(c){if(!c.id){}c.index=c.index||0;var g={};g.id=c.id;g.xtype="textfield";g.width=dcForm.controlWidth;g.enableKeyEvents=true;g.validateOnBlur=false;var d=[41,42,43,44,49,50,51,83,84,103,104,105,106,111,112,127,129,133,131,137,138,141,142];var a=!Ext.isEmpty(c.columnInfo.length)?c.columnInfo.length:Number.MAX_VALUE;g.validator=function(k){var j=Ext.getCmp("operator");var m=Ext.getCmp("includeNoValue");if(Ext.isFunction(j.getValue)&&(d.indexOf(parseInt(j.getValue(),10))>-1)){var o=true;var n=k.split(",");var l=true;Ext.each(n,function(p){var q=Ext.util.Format.trim(p);if(q.length>0){o=false;}if(q.length>a){l=gt.strargs(gt.gettext("The maximum length for this string field is %1."),[a]);return false;}});if(o){l=gt.gettext("A value must be specified.");}}else{if(k.trim().length==0){l=gt.gettext("A value must be specified.");}else{if(k.length>a){l=gt.strargs(gt.gettext("The maximum length for this string field is %1."),[a]);}}}return l;};g.getValue=function(){var m=Ext.form.TextField.superclass.getValue.apply(this,arguments);var l=Ext.getCmp("operator");if(Ext.isFunction(l.getValue)&&(d.indexOf(parseInt(l.getValue(),10))>-1)){var k=m.split(",");var j=[];Ext.each(k,function(n){j.push(Ext.util.Format.trim(n));});m=j.join(",");}return m;};g.listeners={afterrender:function(k){var j=Ext.getCmp("EbmUseBlank");if(j){if(k.getRawValue()==""){j.setDisabled(false);}else{j.setDisabled(true);}}},change:function(k){var j=Ext.getCmp("EbmUseBlank");if(j){if(k.getRawValue()==""){j.setDisabled(false);}else{j.setDisabled(true);}}},keyup:function(k,l){var j=Ext.getCmp("EbmUseBlank");if(j){if(k.getRawValue()==""){j.setDisabled(false);}else{j.setDisabled(true);}}k.validate();ECM.publish("valueChanged");},valid:function(k){var j=Ext.getCmp("EbmUseBlank");if(j){if(k.getRawValue()==""){j.setDisabled(false);}else{j.disable();}}},invalid:function(k){var j=Ext.getCmp("EbmUseBlank");if(j){if(k.getRawValue()==""){j.setDisabled(false);}else{j.disable();}}}};var h=ECM.Rules.Constants;var b=dcForm.condition.operands;if(!!dcForm.isSystemGroup&&!!dcForm.sourceTreeNode.attributes.data[h.IDX.AGGREGATOR]){b=dcForm.sourceTreeNode.attributes.data[h.IDX.AGGREGATOR][h.IDX.OPERANDS];}g.fieldLabel=gt.gettext("Value");if(c.index>0){g.fieldLabel=gt.gettext("and");g.itemCls="ecm-and-label-item";}if(dcForm.isEditMode||(!!dcForm.isSystemGroup&&!!b)){var f=Ext.getCmp("field");if(f.xtype.indexOf("label")>=0||c.columnInfo.type==f.originalColumnInfo.type){g.value=b[c.index];}}return g;}};ECM.provide("ECM.Form.FormElements.ValueHelpers.Number");ECM.Form.FormElements.ValueHelpers.Number={valueType:[ECM.Rules.Constants.TYPES.NUMERIC],generateHash:function(f){var h={};h.id=f.id;h.xtype="textfield";h.maskRe=/^[0-9;.]+$/;h.width=dcForm.controlWidth;h.enableKeyEvents=true;h.invalidText=gt.gettext("A valid number must be specified.");var g=[41,42,43,44,49,50,51,83,84,103,104,105,106,111,112,127,129,133,131,137,138,141,142];var d=["49","51"];var b=!Ext.isEmpty(f.columnInfo.length)?f.columnInfo.length:Number.MAX_VALUE;var a=Ext.getCmp("operator").getValue();if(d.indexOf(a.toString())>=0){h.maskRe=/^[(0-9)|(,);.]+$/;h.regex=/^[0-9]+([;.,]?[0-9])*$/;}h.validator=function(k){var j=Ext.getCmp("operator"),m=Ext.getCmp("includeNoValue"),n=k.split(","),l=true;if(Ext.isFunction(j.getValue)&&(g.indexOf(parseInt(j.getValue(),10))>-1)){Ext.each(n,function(o){var p=Ext.util.Format.trim(o);if(p.length>b){l=gt.strargs(gt.gettext("The maximum length for this number field is %1."),[b]);return false;}});}else{if(k.length>b){l=gt.strargs(gt.gettext("The maximum length for this number field is %1."),[b]);}else{if(Ext.isEmpty(Ext.util.Format.trim(k))){l=false;}}}if(l==true){Ext.each(n,function(o){l=(!!o.match(/^\d+$/)||!!o.match(/^\d+\.?\d+$/))||(m&&m.checked);
if(!l){return;}});}if(l==true){this.clearInvalid();}return l;};h.allowBlank=false;h.listeners={keyup:function(k,j){k.validate();ECM.publish("valueChanged");}};var c=dcForm.condition.operands;if(!!dcForm.isSystemGroup&&!!dcForm.sourceTreeNode.attributes.data[C.IDX.AGGREGATOR]){c=dcForm.sourceTreeNode.attributes.data[C.IDX.AGGREGATOR][C.IDX.OPERANDS];}h.fieldLabel=gt.gettext("Value");if(f.index>0){h.fieldLabel="and";h.itemCls="ecm-and-label-item";}if(dcForm.isEditMode||(!!dcForm.isSystemGroup&&!!c)){h.value=c[f.index];}return h;}};ECM.provide("ECM.Form.FormElements.ValueHelpers.Count");ECM.Form.FormElements.ValueHelpers.Count={valueType:[ECM.Rules.Constants.TYPES.COUNT],generateHash:function(d){var g=ECM.Rules.Constants;var f={};f.id=d.id;f.width=dcForm.controlWidth;f.xtype="textfield";f.enableKeyEvents=true;f.invalidText=gt.gettext("A number must be specified.");f.maskRe=/^[0-9;.]+$/;f.regex=/^[0-9;.]+$/;f.allowBlank=false;var c=["49","51"];var a=Ext.getCmp("operator").getValue();if(c.indexOf(a.toString())>=0){f.maskRe=/^[0-9;.,]+$/;f.regex=/^[0-9]+([;.,]?[0-9])*$/;}f.listeners={keyup:function(j,h){j.validate();ECM.publish("valueChanged");}};var b=dcForm.condition.operands;if(!!dcForm.sourceTreeNode.attributes.isAggregator&&!!dcForm.sourceTreeNode.attributes.data[g.IDX.AGGREGATOR]){b=dcForm.sourceTreeNode.attributes.data[g.IDX.AGGREGATOR][g.IDX.OPERANDS];}f.fieldLabel=gt.gettext("Value");if(d.index>0){f.fieldLabel="and";f.itemCls="ecm-and-label-item";}if(b&&b[d.index]&&(dcForm.isEditMode||dcForm.isSystemGroup)){if(b[d.index].length>1){f.value=b[d.index].join(",");}else{f.value=b[d.index][0];}}return f;}};ECM.provide("ECM.Native.Function");ECM.Native.Function.compose=function(c,b,a){a=a||window;return function(){return c.call(a,b.apply(a,arguments));};};ECM.provide("ECM.Plugins.DirectEntryGridPicker.NoValueCheckbox");ECM.Plugins.DirectEntryGridPicker.NULLVALUE="NULL (empty, unspecified)";ECM.Plugins.DirectEntryGridPicker.NoValueCheckbox=Ext.extend(Ext.util.Observable,{init:function(a){this.degp=a;this.initialValue=this.degp.getValue();a.on("afterrender",this.addCheckBox,this,{single:true});},addCheckBox:function(){var a=(Ext.isDefined(this.degp.node.condition().operands))?this.degp.node.condition().operands[0].indexOf(ECM.Plugins.DirectEntryGridPicker.NULLVALUE)>-1:false;this.degp.add({xtype:"panel",layout:"form",items:[{xtype:"checkbox",id:"includeNoValueDegp",hideLabel:true,checked:a,boxLabel:gt.gettext("Include empty (no value)"),listeners:{check:function(){ECM.publish("valueChanged");}}}]});this.degp.doLayout();this.degp.getValue=ECM.Native.Function.compose(this.modifyValue,this.degp.getValue,this.degp);},modifyValue:function(a){a.remove(ECM.Plugins.DirectEntryGridPicker.NULLVALUE);if(Ext.getCmp("includeNoValueDegp").checked){a.push(ECM.Plugins.DirectEntryGridPicker.NULLVALUE);}return a;}});Ext.preg("ecm.degp.novaluecheckbox",ECM.Plugins.DirectEntryGridPicker.NoValueCheckbox);ECM.provide("ECM.Plugins.DirectEntryGridPicker.SelectAll");ECM.Plugins.DirectEntryGridPicker.SelectAll=Ext.extend(Ext.util.Observable,{init:function(a){this.degp=a;this.initialValue=this.degp.getValue();a.on("afterrender",this.addCheckBox,this,{single:true});},addCheckBox:function(){var a=this.degp;var c=a.gridPicker;if(c.store.totalLength>c.store.limit){a.add({xtype:"panel",layout:"form",hidden:true,items:[{xtype:"checkbox",id:"selectAllDegp",hideLabel:true,gridPicker:c,boxLabel:gt.strargs(gt.gettext("Check this box to select all %1 items"),c._allKeys.length),listeners:{check:function(){this.gridPicker.selModel.suspendEvents(false);if(this.checked){this.gridPicker._selectedDataKeys=this.gridPicker.allDataByKey();}else{this.gridPicker._selectedDataKeys=[];}this.gridPicker.selModel.resumeEvents();this.gridPicker.refreshSelections();this.gridPicker.selModel.fireEvent("selectionchange",this.gridPicker.selModel);ECM.publish("valueChanged");}},updateBoxCounts:function(f,h){var g="There are %1 selected. Check this box to unselect all %2 items.";var d="There are %1 selected. Check this box to select all %2 items.";if(this.rendered){var j=gt.strargs(gt.gettext(this.getValue()?g:d),[f,h]);this.wrap.child(".x-form-cb-label").update(j);this.boxLabel=j;}},setChecked:function(d){this.suspendEvents(false);this.setValue(d);this.resumeEvents();},setVisible:function(d){this.findParentByType("panel").setVisible(d);}}]});a.doLayout();a.selectAllDegp=Ext.getCmp("selectAllDegp");c.selModel.on("selectAll",function(){var d=this.gridPicker;this.selectAllDegp.setChecked(d.selectedKeys(true).length==d.store.getTotalCount());var f=(d.selModel.getCount()==d.store.limit||d.selModel.getCount()==d.store.getCount())&&(d.store.getTotalCount()>d.store.limit);this.selectAllDegp.setVisible(f);},a);c.selModel.on("clearall",function(){this.selectAllDegp.setChecked(false);this.selectAllDegp.setVisible(false);},a);c.on("afterrender",function(){var d=Ext.getCmp("includeNoValueDegp").checked?a.getValue().length-1:a.getValue().length;var f=(this.gridPicker.selectedKeys(true).length==this.gridPicker.store.getTotalCount())&&this.gridPicker.selectedKeys(true).length!=0;this.selectAllDegp.setChecked(f);if(f){this.selectAllDegp.updateBoxCounts(d,this.gridPicker.store.getTotalCount());}},a);c.on("selectionchange",function(){var f=this.gridPicker;var d=Ext.getCmp("includeNoValueDegp");var g=(d&&d.checked)?a.getValue().length-1:a.getValue().length;var h=(this.gridPicker.selectedKeys(true).length==this.gridPicker.store.getTotalCount())&&this.gridPicker.selectedKeys(true).length!=0;this.selectAllDegp.setChecked(h);h=(f.selModel.getCount()==f.store.limit||f.selModel.getCount()==f.store.getCount())&&(f.store.getTotalCount()>f.store.limit);this.selectAllDegp.setVisible(h);if(h){this.selectAllDegp.updateBoxCounts(g,this.gridPicker.store.getTotalCount());}},a);var b=Ext.get("directEntry"+a.uniqueID+"EnterValues");if(b){b.on("click",function(){this.selectAllDegp.setVisible(false);},a);}}}});Ext.preg("ecm.degp.selectall",ECM.Plugins.DirectEntryGridPicker.SelectAll);ECM.provide("ECM.Targeting.Filter.Mailing");ECM.Targeting.Filter.Mailing=Ext.extend(Ext.menu.Menu,{cls:"filter_flyout",allowOtherMenus:true,constructor:function(a){Ext.apply(a,{filterData:{mailing:{option:[],checkedRadio:"filterRadio"}},setData:this.setData,getData:this.getData,makeFilterKey:this.makeFilterKey,resetPageType:this.resetPageType});Ext.applyIf(this,new ECM.Mailing.MailingList.FilterControlBase());Ext.apply(this,a);this.createPanel();this.affiliateStore=new Ext.data.JsonStore({idProperty:"id",fields:["id",{name:"name",sortType:Ext.data.SortTypes.asUCString}],sortInfo:{field:"name",direction:"ASC"},data:[[0,"Default"]]});if(ECM.Stash.has_ebm_access){this.eventStore=new Ext.data.ArrayStore({fields:["id",{name:"name",sortType:Ext.data.SortTypes.asUCString}],data:ECM.Stash.events.data,sortInfo:{field:"name",direction:"ASC"}});}this.folderStore=new Ext.data.ArrayStore({fields:["id",{name:"name",sortType:Ext.data.SortTypes.asUCString}],sortInfo:{field:"name",direction:"ASC"},data:[]});this.tagStore=new Ext.data.ArrayStore({fields:["id",{name:"name",sortType:Ext.data.SortTypes.asUCString}],sortInfo:{field:"name",direction:"ASC"},data:[]});this.typeStore=new Ext.data.ArrayStore({fields:["id",{name:"name",sortType:Ext.data.SortTypes.asUCString}],sortInfo:{field:"name",direction:"ASC"},data:[[1,"bulk"],[2,"ebm"]]});this.resetPageType("mailing");ECM.Targeting.Filter.Mailing.superclass.constructor.apply(this,arguments);},setData:function(a,b){this.filterData[a]=b;},getData:function(a){return this.filterData[a];},makeFilterKey:function(d){var a=[],b=["cor"];if(Ext.isEmpty(d)||d.checkedRadio=="allRadio"){}else{if(d.checkedRadio=="selectedRadio"){a=["id","=",d.selectedId];}else{if(Ext.isEmpty(d.option)){a="";}else{var c={Affiliate:["affiliate_id","="],Event:["event","event_id","="],Folder:["fid","="],"Mailing Tag":["tag","tag_id","="],"Mailing Type":["targeted","matches"],"Sent Date":["date","matches"]};Ext.each(d.option,function(h){switch(h.target){case"Text Search":a.push(["or",["name","matches",String.escape(h.text)],["list","name","matches",String.escape(h.text)],["affiliate","name","matches",String.escape(h.text)]]);
break;case"Sent Date":var g=h.text.format("m/d/Y");a.push(["or",["product","date_sent",">",String.escape(g)]]);break;default:var f=c[h.target].slice(0);f.push(h.query);a.push(f);break;}});if(b.length>1){a.push(b);}if(a.length>1){a.unshift("and");}else{a=a[0];}}}}return a;},resetPageType:function(a){this.pageType=a;var b=[["Folder",this.folderStore],["Mailing Tag",this.tagStore],["Sent Date"],["Text Search"]];this.uniqueOpt=["Folder","Mailing Tag","Sent Date","Text Search"];if(ECM.Stash.has_ebm_access){b.push(["Event",this.eventStore]);this.uniqueOpt.push("Event");b.push(["Mailing Type",this.typeStore]);this.uniqueOpt.push("Mailing Type");}if(!ECM.Targeting.Store.SegmentData.restrictAffiliate()){b.push(["Affiliate",this.affiliateStore]);this.uniqueOpt.push("Affiliate");}delete this.defaultFilterValue;this.affiliateStore.loadData(ECM.Stash.affiliates);this.folderStore.loadData(ECM.Stash.mailing_folders.data);this.folderStore.insert(0,[new this.affiliateStore.recordType({id:0,name:"Default"})]);this.tagStore.loadData(ECM.Stash.mailing_tags.data);this.filterButton.enable();this.filterByStore=new Ext.data.ArrayStore({fields:["target","display"]});this.optionStorePair={};Ext.each(b,function(c){if(!Ext.isEmpty(c[1])){this.optionStorePair[c[0].split(" ").join("_")]=c[1];}this.filterByStore.loadData([[c[0],gt.gettext(c[0])]],true);},this);this.filterByStore.sort("display","ASC");}});ECM.provide("ECM.Targeting.Store.AffiliateAssociative");ECM.Targeting.Store.AffiliateAssociative={MAILING_TYPE:"MAILING",TAG_SUBTYPE:"TAG",FOLDER_SUBTYPE:"FOLDER",CAMPAIGN_SUBTYPE:"CAMPAIGN",affiliateIdMap:undefined,mailingTagMap:undefined,mailingFolderMap:undefined,mailingCampaignMap:undefined,getAffiliate:function(a,b){var c=this.getAssociativeAffiliateMap(b);return c&&c[a]?c[a]:gt.gettext("Unknown Affiliate");},getAssociativeAffiliateMap:function(a){var b;if(a[1]===this.MAILING_TYPE&&a[2]===this.TAG_SUBTYPE){if(!this.mailingTagMap){this.mailingTagMap=this.buildAssociativeAffiliateMap(ECM.Stash.mailing_tag_list,this.mailingTagMap);}b=this.mailingTagMap;}else{if(a[1]===this.MAILING_TYPE&&a[2]===this.FOLDER_SUBTYPE){if(!this.mailingFolderMap){this.mailingFolderMap=this.buildAssociativeAffiliateMap(ECM.Stash.mailing_folder_list,this.mailingFolderMap);}b=this.mailingFolderMap;}else{if(a[1]===this.MAILING_TYPE&&a[2]===this.CAMPAIGN_SUBTYPE){if(!this.mailingCampaignMap){this.mailingCampaignMap=this.buildAssociativeAffiliateMap(ECM.Stash.campaign_list,this.mailingCampaignMap);}b=this.mailingCampaignMap;}}}return b;},buildAssociativeAffiliateMap:function(a){var b={};Ext.each(a,function(c){b[c[0]]=this.getAffiliateNameById(c[2]);},this);return b;},getAffiliateNameById:function(a){if(!this.affiliateIdMap){this.affiliateIdMap={};Ext.each(ECM.Stash.affiliates,function(b){this.affiliateIdMap[b.id]=b.name;},this);}return this.affiliateIdMap[a];},getAffiliateIdByName:function(a){var b="";Ext.each(ECM.Stash.affiliates,function(c){if(c.name==a){b=c.id;return false;}},this);return b;}};ECM.provide("ECM.Form.FormElements.ValueHelpers.Associative");ECM.Form.FormElements.ValueHelpers.Associative={valueType:[ECM.Rules.Constants.TYPES.ASSOCIATIVE,ECM.Rules.Constants.TYPES.SUBSCRIPTION,ECM.Rules.Constants.TYPES.VIRTUAL,ECM.Rules.Constants.TYPES.ZIP_CMSA,ECM.Rules.Constants.TYPES.ZIP_MA,ECM.Rules.Constants.TYPES.ZIP_MSA,ECM.Rules.Constants.TYPES.ZIP_STATE],generateHash:function(z){var G=false;if(!z.id){}var j=ECM.Form.FormElements.ElementHelper;var H={};H.node=z.node;var s=z.columnInfo;var y=parseInt(s.type||ECM.Rules.Constants.TYPES.STRING);dcForm.associativeData=z.node.dataStore({columnId:s.value,switchToAdvanced:dcForm.switchToAdvancedRequested,types:["associative"]})[0];if(!ECM.Stash.has_client_access&&s.value.match(/(_MAILING_FOLDER|_MAILING_CAMPAIGN$)$/)){var K=[];if(s.value.match(/_MAILING_FOLDER$/)){K=ECM.Targeting.Store.SegmentData.getMailingFolderIds();}else{if(s.value.match(/_MAILING_CAMPAIGN$/)){K=ECM.Targeting.Store.SegmentData.getCampaignIds();}}dcForm.associativeData.filterBy(function(N,O){if(K.indexOf(N.get("value"))>-1){return true;}});}var L=j.getListDataFromStore(dcForm.associativeData,!this.isXDBField(s),y);var d=z.node.condition().operands;var t=[];var D=true;var k=false;var E=y;if(dcForm.isSimpleMode&&!dcForm.switchToAdvancedRequested){D=false;}var x=[];if(Ext.isDefined(d)){if(Ext.isArray(d[0])){x=d[0];}else{x=[d[0]];}}var g=Ext.getCmp("field");if(g.originalColumnInfo&&(z.columnInfo.value==g.originalColumnInfo.value)){t=x;}else{t=this.getSelectedItems(x,dcForm.associativeData,D,true);}H.isSwitchHidden=false;H.id=z.id;var q=[];var u=false;var o=undefined;var h,f,M,n;var n=ECM.Form.GridPickerHelper.colRenderer;var B=ECM.Stash.has_client_access;var I=s.value.split("_"),A=(I.length===3&&I[1]==="MAILING"&&(I[2]==="CAMPAIGN"||I[2]==="FOLDER"||I[2]==="TAG"));if((y!==ECM.Rules.Constants.TYPES.SUBSCRIPTION&&!A&&!this.isXDBField(s))||(!window.ecmTargetingModeOn&&y===ECM.Rules.Constants.TYPES.SUBSCRIPTION)){for(var J=0,m=L.length;J<m;J++){if(L[J][0]==""||L[J][0]=="NULL (empty, unspecified)"){o=L[J][0];if(dcForm.isSimpleMode&&!dcForm.switchToAdvancedRequested){q.push(["",gt.gettext("NULL (empty, unspecified)"),undefined,2]);}else{u=true;}}else{q.push(L[J]);}}h=q;f=[{name:"key"},{name:"value",sortType:Ext.data.SortTypes.asUCString}];M=[{id:"value",header:"Value",searchable:true,dataIndex:"value",renderer:n.createDelegate(this)}];}else{G=true;h=[];var v=ECM.Targeting.Store.SubscriberList.getAffiliateNameById(ECM.Stash.aid);ECM.Adapter.each(L,function(O){var N=y==ECM.Rules.Constants.TYPES.SUBSCRIPTION?ECM.Targeting.Store.SubscriberList.getSubscriberListAffiliate(O[0]):(this.isXDBField(s)?ECM.Targeting.Store.XDB.getAffiliate(O[0]):ECM.Targeting.Store.AffiliateAssociative.getAffiliate(O[0],I));if(window.ecmTargetingModeOn&&(ECM.Stash.has_client_access&&y!=ECM.Rules.Constants.TYPES.SUBSCRIPTION)&&!s.value.match(/_MAILING_TAG$/)&&!ECM.Targeting.Store.SegmentData.getMultiAffiliate()){if(!N.match(Ext.escapeRe(v)+"([,]|$).*")){return true;}}h.push([O[0],O[1],N]);},this);f=[{name:"key"},{name:"value",sortType:Ext.data.SortTypes.asUCString},{name:"affiliate"}];M=[{id:"value",header:"Value",searchable:true,dataIndex:"value",renderer:n.createDelegate(this)}];if((!window.ecmTargetingModeOn&&ECM.Stash.has_client_access)||(window.ecmTargetingModeOn&&((ECM.Stash.has_client_access&&(y==ECM.Rules.Constants.TYPES.SUBSCRIPTION))||!ECM.Targeting.Store.SegmentData.restrictAffiliate()))){M.push({id:"affiliate",header:"Affiliate",dataIndex:"affiliate",renderer:n.createDelegate(this)});}}if(k){var w=dcForm.getMultiSelectSwapComponent(t);w.store=q;w.displayNullOption=u;return w;}else{if(dcForm.isSimpleMode&&!dcForm.switchToAdvancedRequested){var F="";if(t.length>0&&(t[0]!="Create Condition")){F=t[0];}if(F==""){F=o||"";}Ext.apply(H,{xtype:"combo",nullDisplayValue:o,displayNullOption:u,name:"combo",fieldLabel:gt.gettext("Value"),width:dcForm.controlWidth-17,store:q,value:F,forceSelection:true,triggerAction:"all",allowBlank:false,listeners:{focus:function(){dcForm.onEditableComboFocus(this);},select:function(){ECM.publish("valueChanged");}}});}else{var b=[];for(var J=0,m=t.length;J<m;J++){if(t[J]==""||t[J]=="NULL (empty, unspecified)"){dcForm.isNoValueSelected=true;}else{b.push(t[J]);}}var l=undefined;if(y==ECM.Rules.Constants.TYPES.MAILING){var l=new Ext.Button({cls:"filter_button",iconCls:"filter_button_icon",iconAlign:"right",region:"west",text:"Filter"});l.menu=new ECM.Targeting.Filter.Mailing({pageType:"segment"});l.menu.on("filter",function(){self.store.lastOptions.params.start=0;var P=this.findByType("radiogroup")[0];var R=this.findByType("radiogroup")[0].items.items[0].checked;var O=this.findByType("radiogroup")[0].items.items[1].checked;var Q=this.findByType("radiogroup")[0].items.items[2].checked;if(Q){var S="value";var N="";self.setFilter(O,Q,S,N);}else{self.setFilter(O,Q);}});y=E;}var r=null;if(y==ECM.Rules.Constants.TYPES.SUBSCRIPTION||A){if(!window.ecmTargetingModeOn||s.value.match(/_MAILING_TAG$/)||(ECM.Stash.has_client_access&&((y==ECM.Rules.Constants.TYPES.SUBSCRIPTION)||ECM.Targeting.Store.SegmentData.getMultiAffiliate()))){r={affiliate:ECM.Stash.affiliates.map(function(N){return N.name;
}).concat(["Affiliate1","Affiliate2"])};}}var a=["ecm.degp.selectall"];if(!G&&u){a.unshift("ecm.degp.novaluecheckbox");}var p=(z.node.isMainSubscription||this.isXDBField(s)||this.isZipField(y))?"grid":"both";if(/_mailing_/i.test(s.value)){p="grid";}var c=new ECM.Plugins.Grid.SearchColumn();c.onHeaderSubmitSearch=function(){if(Ext.isDefined(this.grid.store.customFiltered)&&this.grid.store.customFiltered===true){this.grid.fireFilter();}else{this.grid.store.filterBy(function(){return true;});this.grid.topToolbar.pagingtb.changePage(1);}};Ext.apply(H,{displayNullOption:u,xtype:"ecm.directentrygridpicker",trimValue:y==ECM.Rules.Constants.TYPES.SUBSCRIPTION||y==ECM.Rules.Constants.TYPES.ASSOCIATIVE,validateEntry:y==ECM.Rules.Constants.TYPES.SUBSCRIPTION,plugins:a,width:dcForm.gridPickerWidth,displayMode:p,pickerConfig:{xtype:"ecm.gridpicker",id:id,customFilter:B,selectedKeys:b,plugins:[c],store:{xtype:"arraystore",fields:f,data:h,sortInfo:{field:"value",direction:"ASC"},filterBy:function(O,N){O=O.createInterceptor(function(T){var S="value";var R=Ext.decode(c.getValue());if(Ext.isDefined(R.filter[S])){var Q=R.filter[S];Q=Ext.util.Format.lowercase(Q);var P=new RegExp("^(.*"+Q+".*)\\(.*\\)$");if(!P.test(Ext.util.Format.lowercase(T.get(S)))){return false;}}return true;});return this.superclass().filterBy.call(this,O,N);}},colModel:new Ext.grid.ColumnModel({defaults:{sortable:false},columns:M}),stripeRows:true,autoExpandColumn:"value",autoHeight:true,viewConfig:{scrollOffset:1,forceFit:true},width:dcForm.gridPickerWidth,listeners:{selectionchange:function(N){ECM.publish("valueChanged");}},hideRefresh:true,filter:l,customFilterFields:r},onDirectEntryKeyUp:function(){ECM.publish("valueChanged");}});}}dcForm.hasNoValueOption=u;return H;},getSelectedItems:function(o,m,a,k){var f=[];var l=m.data.items||[];var b=-1;for(var g=0,h=o.length;g<h;g++){for(var d=0,c=l.length;d<c;d++){if(o[g]==l[d].data.value||o[g]==l[d].data.text){if(a){f.push(l[d].data.value);}else{var n=l[d].data.text;if(k){n+=" ("+l[d].data.value+")";}f.push(n);}break;}else{if(o[g]==""){f.push("");break;}}}}return f;},isVirtualField:function(c){var b=ECM.Rules.Constants.TYPES,a=Number(c);return(a===b.VIRTUAL);},isXDBField:function(a){return(this.isVirtualField(a.type)&&a.table===ECM.Rules.Tablespace.getTableAlias("EXT_DB"));},isZipField:function(c){var b=ECM.Rules.Constants.TYPES,a=Number(c);return(a===b.ZIP_STATE||a===b.ZIP_MSA||a===b.ZIP_CMSA||a===b.ZIP_MA);}};ECM.provide("ECM.Data.ListStore.ListStore");ECM.Data.ListStore.ListStore=Ext.extend(Ext.data.ArrayStore,{remoteSort:true,autoDestroy:false,constructor:function(c){c=c||{};var a=parseInt(c.pageSize)||ECM.Stash.rows_per_page||20;var d={baseParams:{start:c.page?(parseInt(c.page)-1)*a:0,limit:a,desired_aid:ECM.Stash.aid}},b={root:"data.data",totalProperty:"data.rows"};Ext.apply(c,b);c.baseParams=Ext.apply(d.baseParams,c.baseParams);Ext.apply(this,c);ECM.Data.ListStore.ListStore.superclass.constructor.call(this,c);},setPage:function(b,a){if(!Ext.isEmpty(b)){b=Ext.isNumber(b)?b:parseInt(b,10);this.setBaseParam("start",b);}if(!Ext.isEmpty(a)){a=Ext.isNumber(a)?a:parseInt(a,10);this.setBaseParam("limit",a);}},getPageSize:function(){return ECM.Stash.user_preferences?ECM.Stash.user_preferences.rows_per_page:this.baseParams.limit;}});ECM.provide("ECM.Mailing.Store");ECM.Mailing.Store=Ext.extend(ECM.Data.ListStore.ListStore,{});ECM.provide("ECM.Form.FormElements.ValueHelpers.Store.Mailing");ECM.Form.FormElements.ValueHelpers.Store.Mailing=Ext.extend(ECM.Mailing.Store,{storeId:"mailing.standard",proxy:new Ext.data.HttpProxy({url:window.ecmTargetingModeOn&&ECM.Targeting.Store.SegmentData.restrictAffiliate()?"/cm/r/mailings/affiliateall":"/cm/r/mailings/all",method:"GET"}),constructor:function(a){ECM.Form.FormElements.ValueHelpers.Store.Mailing.superclass.constructor.call(this,Ext.apply(a||{},{appliedFilters:{},fields:[{name:"product_id"},{name:"name"},{name:"affiliate_name"}],idIndex:0,idProperty:"product_id"}));this.proxy=new Ext.data.HttpProxy({url:window.ecmTargetingModeOn&&ECM.Targeting.Store.SegmentData.restrictAffiliate()?"/cm/r/mailings/affiliateall":"/cm/r/mailings/all",method:"GET"});this.on("beforeload",this.applyFilter,this);},getFilter:function(){var a=[];Ext.iterate(this.appliedFilters,function(b,c){if(!Ext.isEmpty(c)){a.push(c);}});return a;},applyFilter:function(a,b){var c=this.getFilter();if(b.params){if(Ext.isEmpty(c)){delete b.params.filter;}else{b.params.filter=Ext.encode(c.length>1?["and"].concat(c):c[0]);}}}});ECM.provide("ECM.Form.FormElements.ValueHelpers.Mailing");ECM.Form.FormElements.ValueHelpers.Mailing={valueType:[ECM.Rules.Constants.TYPES.MAILING],generateHash:function(B){var r=false;if(!B.id){}var c=ECM.Form.FormElements.ElementHelper;var g={};g.node=B.node;var d=B.columnInfo;var o=d.type||ECM.Rules.Constants.TYPES.STRING;dcForm.associativeData=new ECM.Form.FormElements.ValueHelpers.Store.Mailing({pageSize:10,page:1,autoLoad:true});var h=c.getListDataFromStore(dcForm.associativeData,true,o);var m=B.node.condition().operands;var D=[];var s=true;var u=false;if(dcForm.isSimpleMode&&!dcForm.switchToAdvancedRequested){s=false;}var y=[];if(Ext.isArray(m[0])){y=m[0];}else{y=[m[0]];}var f=Ext.getCmp("field");if(f.originalColumnInfo&&(B.columnInfo.value==f.originalColumnInfo.value)){D=y;}else{D=ECM.Form.FormElements.ValueHelpers.Associative.getSelectedItems(y,dcForm.associativeData,s,true);}g.isSwitchHidden=false;g.id=B.id;var v=[];var k=false;var z=undefined;var b,p,A,t;var E=new Ext.data.JsonStore({fields:["id",{name:"name",sortType:Ext.data.SortTypes.asUCString}],data:ECM.Stash.affiliates});var t=function(H,F,G){return H;};var q=function(H,F,G){return Ext.util.Format.htmlEncode(G.data.name)+" ("+G.data.product_id+")";};h.sort(function(G,F){G=G[1];F=F[1];return G==F?0:(G<F?-1:1);});var j=true;r=true;b=[];for(var w=0;w<h.length;w++){b.push([h[w][0],h[w][1],ECM.Targeting.Store.SubscriberList.getSubscriberListAffiliate(h[w][0])]);}p=[{name:"key"},{name:"value"},{name:"affiliate"}];A=[{id:"name",header:"Name",searchable:true,dataIndex:"name",renderer:q.createDelegate(this)}];if(!ECM.Targeting.Store.SegmentData.restrictAffiliate()){A.push({id:"affiliate",header:"Affiliate",dataIndex:"affiliate_name",renderer:t.createDelegate(this)});}var n=[];for(var w=0,x=D.length;w<x;w++){if(D[w]==""||D[w]=="NULL (empty, unspecified)"){dcForm.isNoValueSelected=true;}else{n.push(D[w]);}}var l=this._getFilterBtn();var a=new ECM.Plugins.Grid.SearchColumn();a.onHeaderSubmitSearch=function(){var H,G=false;Ext.iterate(this.columnIdToInputBox,function(I,K){var J=this.eventDataFromId(I);if(!Ext.isEmpty(J.value)){H=J.value;G=true;return false;}},this);if(!Ext.isDefined(this.grid.store.appliedFilters)){this.grid.store.appliedFilters={};}var F=["name","matches",H];F=Ext.isEmpty(H)?"":F;this.grid.store.appliedFilters.quicksearch=F;this.grid.topToolbar.pagingtb.changePage(1);};if(!ECM.Targeting.Store.SegmentData.restrictAffiliate()){dcForm.associativeData._baseFilter=["affiliate_id","=",ECM.Stash.aid];dcForm.associativeData.appliedFilters.base=dcForm.associativeData._baseFilter;dcForm.associativeData.on("load",function(){l.fireEvent("filtered",gt.gettext("Filtered"));var F=l.menu.findByType("radiogroup")[0];F.on("afterrender",function(){if(this.filterContainer.items.items.length==0){this.createNewOption();var H=this.filterContainer.items.items[0].items.items;H[0].setValue("Affiliate");var G=H[1].store.getById(ECM.Stash.aid);if(G){H[1].setRawValue(G.data.name);this.setData(this.pageType,{checkedRadio:"filterRadio",option:[{query:ECM.Stash.aid,target:"Affiliate",text:G.data.name}]});}}},l.menu,{single:true});},this,{single:true});}Ext.apply(g,{displayNullOption:k,xtype:"ecm.directentrygridpicker",plugins:(r?[]:["ecm.degp.novaluecheckbox"]),width:dcForm.gridPickerWidth,displayMode:"both",trimValue:true,filter:l,remoteValidationSuccessCB:function(F){Ext.each(F.responseJSON.data.data,function(G){if(!ECM.Stash.mailings_used[G[0]]){var H=ECM.Targeting.Store.AffiliateAssociative.getAffiliateIdByName(G[2]);
ECM.Stash.mailings_used[G[0]]=[G[1],H];}});},pickerConfig:{xtype:"ecm.gridpicker",id:id,customFilter:j,plugins:[a],selectedKeys:n,store:dcForm.associativeData,keyField:"product_id",colModel:new Ext.grid.ColumnModel({defaults:{sortable:false},columns:A}),remotePage:true,remoteValidationUrl:ECM.Targeting.Store.SegmentData.restrictAffiliate()?"/cm/r/mailings/affiliateall":"/cm/r/mailings/all",stripeRows:true,autoExpandColumn:"value",autoHeight:true,viewConfig:{scrollOffset:1,forceFit:true},width:dcForm.gridPickerWidth,listeners:{selectionchange:function(F){var G=this.store;Ext.each(this._selectedDataKeys,function(I){if(!Ext.isDefined(ECM.Stash.mailings_used[I])){var H=G.getById(I);if(H){ECM.Stash.mailings_used[I]=[H.data.name,ECM.Targeting.Store.AffiliateAssociative.getAffiliateIdByName(H.data.affiliate_name)];}}});ECM.publish("valueChanged");}}},onDirectEntryKeyUp:function(){ECM.publish("valueChanged");}});dcForm.hasNoValueOption=k;return g;},_getFilterBtn:function(){var a=this;var b=new Ext.Button({cls:"filter_button",iconCls:"filter_button_icon",iconAlign:"right",region:"west",text:gt.gettext("Show all")});b.menu=new ECM.Targeting.Filter.Mailing({pageType:"mailing"});b.menu.on("filter",function(k,f,h){var j=Ext.getCmp("value0").gridPicker;var g=this.findByType("radiogroup")[0];var d=g.items.items[0].checked;var m=g.items.items[1].checked;var c=g.items.items[2].checked;var l=gt.gettext("Show all");if(m||c){l=gt.gettext("Filtered");}if(!Ext.isDefined(j.store.appliedFilters)){j.store.appliedFilters={};}j.store.appliedFilters.base=k;j.topToolbar.pagingtb.changePage(1);b.fireEvent("filtered",l);});b.on("filtered",function(c){this.setText(c);});return b;}};ECM.provide("ECM.Form.FormElements.ValueHelpers.Date");ECM.Form.FormElements.ValueHelpers.Date={valueType:[ECM.Rules.Constants.TYPES.DATE,ECM.Rules.Constants.TYPES.DATETIME],generateHash:function(a){var b={};if(dcForm.isConditionEditSupported(a.columnInfo.type)){var c=a.node.condition();b.id=a.id;b.xtype="ecm.dateControl";if(Ext.isDefined(c.operands)){b.value=c.operands[a.index];}b.fieldLabel=gt.gettext("Value");b.columnType=a.columnInfo.type;b.idNum=a.index;if(a.index==1){b.fieldLabel="and";b.itemCls="ecm-and-label-item";}}return b;}};ECM.provide("ECM.Form.FormElements.ValueHelpers.CityState");ECM.Form.FormElements.ValueHelpers.CityState={valueType:[ECM.Rules.Constants.TYPES.ZIP_CSTATE],generateHash:function(c){if(!c){c={};}if(!c.val){c.val=[];}var f=new ECM.Form.CityState({xtype:"ecm.citystate",value:c.val,id:"value0",fieldLabel:gt.gettext("Value")});var b=ECM.Form.FormElements.ElementHelper;dcForm.associativeData=dcForm.sourceTreeNode.dataStore({columnId:c.columnInfo.value,switchToAdvanced:dcForm.switchToAdvancedRequested,types:["associative"]})[0];var l=b.getListDataFromStore(dcForm.associativeData,false);var j=(Ext.isDefined(dcForm.condition.operands))?dcForm.condition.operands[0]:new Array();var a=[];var d="";for(var g=0,h=l.length;g<h;g++){if(l[g][0]==""||l[g][0]=="NULL (empty, unspecified)"){dcForm.hasNoValueOption=true;d=l[g][0];}else{a.push(l[g]);}}var k=[];for(var g=0,h=j.length;g<h;g++){if(j[g]==""||j[g]=="NULL (empty, unspecified)"){dcForm.isNoValueSelected=true;}else{k.push(j[g]);}}f.stateStore=a;f.value=k;f.nullDisplayValue=d;return f;}};ECM.provide("ECM.Form.FormElements.ValueHelpers.Platform");ECM.Form.FormElements.ValueHelpers.Platform={valueType:[ECM.Rules.Constants.TYPES.PLATFORM],generateHash:function(c){if(!c){c={};}if(!c.val){c.val=[];}var f=new ECM.Form.Platform({xtype:"ecm.platform",value:c.val,id:"value0",fieldLabel:gt.gettext("Value")});var b=ECM.Form.FormElements.ElementHelper;dcForm.associativeData=dcForm.sourceTreeNode.dataStore({columnId:c.columnInfo.value,switchToAdvanced:dcForm.switchToAdvancedRequested,types:["associative"]})[0];var l=b.getListDataFromStore(dcForm.associativeData,false);var j=dcForm.condition.operands[0];var a=[];var d="";for(var g=0,h=l.length;g<h;g++){if(l[g][0]==""||l[g][0]=="NULL (empty, unspecified)"){dcForm.hasNoValueOption=true;d=l[g][0];}else{a.push(l[g]);}}var k=[];for(var g=0,h=j.length;g<h;g++){if(j[g]==""||j[g]=="NULL (empty, unspecified)"){dcForm.isNoValueSelected=true;}else{k.push(j[g]);}}f.platformStore=a;f.value=k;f.nullDisplayValue=d;return f;}};ECM.provide("ECM.Form.FormElements.ValueHelpers.Geolocation");ECM.Form.FormElements.ValueHelpers.Geolocation={valueType:[ECM.Rules.Constants.TYPES.GEOLOCATION],generateHash:function(c){if(!c){c={};}if(!c.val){c.val=[];}var f=new ECM.Form.Geolocation({xtype:"ecm.geolocation",value:c.val,id:"value0",fieldLabel:gt.gettext("Value")});var b=ECM.Form.FormElements.ElementHelper;dcForm.associativeData=dcForm.sourceTreeNode.dataStore({columnId:c.columnInfo.value,switchToAdvanced:dcForm.switchToAdvancedRequested,types:["associative"]})[0];var l=b.getListDataFromStore(dcForm.associativeData,false);var j=dcForm.condition.operands[0];var a=[];var d="";for(var g=0,h=l.length;g<h;g++){if(l[g][0]==""||l[g][0]=="NULL (empty, unspecified)"){dcForm.hasNoValueOption=true;d=l[g][0];}else{a.push(l[g]);}}var k=[];for(var g=0,h=j.length;g<h;g++){if(j[g]==""||j[g]=="NULL (empty, unspecified)"){dcForm.isNoValueSelected=true;}else{k.push(j[g]);}}f.countryStore=a;f.value=k;f.nullDisplayValue=d;return f;}};ECM.provide("ECM.Form.FormElements.ValueHelpers.BitMask");ECM.Form.FormElements.ValueHelpers.BitMask={valueType:[ECM.Rules.Constants.TYPES.BITMASK],generateHash:function(b){var h=[];var g=b;var j=ECM.Form.GridPickerHelper.colRenderer;var a=ECM.Form.FormElements.ElementHelper;dcForm.associativeData=dcForm.sourceTreeNode.dataStore({columnId:b.columnInfo.value,switchToAdvanced:dcForm.switchToAdvancedRequested,types:["associative"]})[0];if(Ext.isDefined(dcForm.condition.operands)){g.val=dcForm.condition.operands[0];}g.listData=a.getListDataFromStore(dcForm.associativeData,false);if(g.val){for(d=0;d<32;d++){if(g.val>>d&1?1:0){h.push(Math.pow(2,d));}}}g.listData.sort(function(m,l){m=m[1];l=l[1];return m==l?0:(m<l?-1:1);});var k=[];for(var d=0;d<g.listData.length;d++){k.push([Math.pow(2,(g.listData[d][0]*1)),g.listData[d][1]]);}var f=new ECM.Plugins.Grid.SearchColumn();var c={};c.isSwitchHidden=true;Ext.apply(c,{xtype:"ecm.gridpicker",id:g.id,selectedKeys:h,plugins:[f],store:{xtype:"arraystore",fields:[{name:"key"},{name:"value"}],data:k},colModel:new Ext.grid.ColumnModel({defaults:{sortable:false},columns:[{id:"value",header:"Value",dataIndex:"value",searchable:true,renderer:j.createDelegate(this)}]}),stripeRows:true,autoExpandColumn:"value",width:dcForm.gridPickerWidth,listeners:{selectionchange:function(){ECM.publish("valueChanged");}},customFilterFields:{affiliate:["Affiliate1","Affiliate2"]},hideRefresh:true,isValid:function(){return(this._selectedDataKeys.length>0);}});return c;}};ECM.provide("ECM.Form.FormElements.ValueHelpers.Behavior");ECM.Form.FormElements.ValueHelpers.Behavior={valueType:[ECM.Rules.Constants.TYPES.BEHAVIOR],generateHash:function(c){var g={},f=__catalog__.columns[2][c.columnInfo.value],b=dcForm.condition.operands,d,j,h,a;if(f[3]&&f[3].length>0){a=(parseInt(f[3][0])||0).toString();h=f[3][1];j=(parseInt(f[3][2])||0).toString();d=f[3][3];}else{j="1";d=gt.gettext("Set");a="0";h=gt.gettext("Not Set");}Ext.apply(g,{xtype:"panel",id:c.id,bodyBorder:false,allowBlank:false,columns:[70,70],width:dcForm.controlWidth,invalidText:gt.gettext("An option must be selected."),getValue:function(){if(this.items.items[0].checked){return j;}else{return a;}},isValid:function(){return(this.items.items[0].checked||this.items.items[2].checked);},setValue:function(l){l=parseInt(l);if(this.rendered){var k=l?0:2;this.items.items[k].setValue(true);}else{switch(l){case 0:this.items.items[0].checked=false;this.items.items[2].checked=true;break;case 1:this.items.items[0].checked=true;this.items.items[2].checked=false;break;default:this.items.items[0].checked=false;this.items.items[2].checked=true;}}},layout:{type:"hbox",align:"left"},items:[{xtype:"radio",name:"radioGroup",value:j,checked:false,boxLabel:d},{xtype:"label",html:"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"},{xtype:"radio",name:"radioGroup",value:a,checked:true,boxLabel:h}]});
if(Ext.isDefined(b)&&b[0][0]==j){g.items[0].checked=true;g.items[2].checked=false;}else{g.items[0].checked=false;g.items[2].checked=true;}g.fieldLabel=gt.gettext("Value");return g;}};ECM.provide("ECM.Form.FormElements.ValueHelpers.Nthing");ECM.Form.FormElements.ValueHelpers.Nthing={valueType:[ECM.Rules.Constants.TYPES.NTHING],generateHash:function(a){var d=a.node.condition();var b=(Ext.isDefined(d.operands)&&d.operands.length>=1)?d.operands[0]:[];var c={xtype:"ecm.rangeof",value:b,fieldLabel:gt.gettext("Value"),id:a.id,listeners:{keyup:function(){ECM.publish("valueChanged");}}};return c;}};ECM.provide("ECM.Form.FormElements.ValueHelpers.Zip");ECM.Form.FormElements.ValueHelpers.Zip={valueType:[ECM.Rules.Constants.TYPES.ZIP],generateHash:function(d){var c=d.node.condition().operands;var a=Ext.getCmp("operator");var b=a.getValue();var f=[91,"91",87,"87",89,"89",95,"95",93,"93",99,"99",97,"97",101,"101",107,"107",109,"109"];var h=(f.indexOf(b)>=0);if(h){d.fieldLabel=gt.gettext("Value");if(d.index>0){d.fieldLabel="and";d.itemCls="ecm-and-label-item";}}var g=Ext.isDefined(c)?c[d.index]:undefined;Ext.apply(d,h?this._getTextfield(g,b):this._getDegp(g));return d;},_getDegp:function(a){return{xtype:"ecm.directentrygridpicker",trimValue:true,width:dcForm.gridPickerWidth,displayMode:"manual",pickerConfig:{xtype:"ecm.gridpicker",selectedKeys:a,store:{xtype:"arraystore",data:""},autoExpandColumn:"value",autoHeight:true,viewConfig:{scrollOffset:1,forceFit:true},width:dcForm.gridPickerWidth,listeners:{selectionchange:function(b){ECM.publish("valueChanged");}},hideRefresh:true},onDirectEntryKeyUp:function(){ECM.publish("valueChanged");}};},_getTextfield:function(d,a){var b=[99,100,101,102];var c=b.indexOf(a*1)>=0?/^[a-zA-Z0-9-%\s]+$/:/^[a-zA-Z0-9-\s]+$/;return{xtype:"textfield",allowBlank:false,enableKeyEvents:true,maskRe:c,regex:c,validateOnBlur:false,width:dcForm.controlWidth,value:Ext.isEmpty(d)?undefined:d,listeners:{keyup:function(){ECM.publish("valueChanged");}}};}};ECM.provide("ECM.Form.FormElements.Value");ECM.Form.FormElements.Value=Ext.extend(Ext.Panel,{layout:"table",id:"valueTable",border:false,plugins:["ecm.subscription"],subscriptions:{operator_changed:function(){this.populatePanel();}},layoutConfig:{columns:3},initComponent:function(){var a=this.getInterfaceHash();Ext.apply(this,{items:[a]});ECM.Form.FormElements.Value.superclass.initComponent.call(this);},getInterfaceHash:function(){var l=Ext.getCmp("field");var f=Ext.getCmp("operator");if(!f){f={numValues:0};}var h=ECM.Form.FormElements.ElementHelper;var k=true;var d=true;var b=ECM.Rules.Constants;var a=[];var c,j;var m=b.TYPES.STRING;if(dcForm.isMailingEbm){if(dcForm.hasNoValueOption){d=false;}else{d=true;}}var g=[{xtype:"panel",id:"valuePanel",layout:"form",border:false,labelWidth:this.node.attributes.isAggregator?125:100,items:[],listeners:{afterlayout:function(){if(this.items.length>0){ECM.publish("valueChanged");}}}},{border:false,xtype:"button",iconCls:"toggle_icon",id:"switchLabel",cls:"ecm-blank-button",hidden:k,ctCls:"condition-input-toggle-td",listeners:{click:function(){dcForm.doSwitchInterface();}}},{border:false,xtype:"label",html:"<span style='font-weight:bold;'>&nbsp;OR</span>",id:"orLabel",hidden:d}];return g;},populatePanel:function(){var a=["75","76","77","78","55","56","57","58"];var p=Ext.getCmp("operator");var s=Ext.getCmp("switchLabel");var j=Ext.getCmp("valuePanel");if(!p){j.removeAll();s.hide();ECM.publish("valueChanged");return;}var c=ECM.Form.FormElements.ElementHelper;var t=Ext.getCmp("selAggregator");var f;if(t&&t.getValue()&(ECM.Rules.Constants.LOGIC.COUNT+ECM.Rules.Constants.LOGIC.UNIQUE)){f={type:"13",value:""};}else{var h=Ext.getCmp("field");var b=h.getValue();f=c.getColumnInfoFromId(b);if(f.type==14&&a.indexOf(p.getValue().toString())>=0){f.type=4;}}var q=f.type;var z=parseInt(p.selectedOperatorId?p.selectedOperatorId:0);var d=[];for(var u=0,v=p.operators.length;u<v;u++){if(p.operators[u][0]==z){d=p.operators[u];break;}}var m=d[3];s.hide();var l=[];var w=c.getValueType(q);m=w?m:0;var n=(j.items.items.length!=m);if(!n&&(f.type==4||f.type==14)){Ext.each(j.items.items,function(A){if(A.columnType!=f.type){n=true;return false;}});}for(var u=0;u<m;u++){var g=w.generateHash({id:"value"+u,columnInfo:f,index:u,node:this.node});g.isSwitchHidden=g.isSwitchHidden==undefined?true:g.isSwitchHidden;s.setVisible(!g.isSwitchHidden&&!window.ecmTargetingModeOn);if(j.items.items.length>=m){if(j.items.items[u].xtype!=g.xtype||j.items.items[u].maskRe!=g.maskRe){n=true;}}if(g.xtype){l.push(g);}}if(!n&&p.isDirty){ECM.publish("valueChanged");return;}var r=Ext.pluck(l,"xtype");var x=true;if(j.items.length>0){x=!(r[0]==j.items.items[0].xtype);}j.removeAll();var k=(b!=""&&dcForm.isConditionEditSupported(f.type));var o=Ext.getCmp("advancedSwitcher");if(o&&o.rendered){var y=gt.gettext("Need a different operator? Switch to ")+"<span onclick='ECM.Rules.Form.switchToAdvanced()' style='cursor:pointer;color:blue;text-decoration:underline;'>"+gt.gettext("Advanced")+"</span>.";if(b!=""&&!k){y=gt.gettext("Want to use this field? Switch to ")+"<span onclick='ECM.Rules.Form.switchToAdvanced()' style='cursor:pointer;color:blue;text-decoration:underline;'>"+gt.gettext("Advanced")+"</span>.";}o.update(y);}j.setVisible(k);if(!k){return;}if(l.length==0){ECM.publish("valueChanged");return;}if(h&&h.isDirty||(p.isDirty&&n)){l.forEach(function(A){delete A.value;delete A.selectedKeys;if(A.pickerConfig){delete A.pickerConfig.selectedKeys;}});}j.add(l);j.doLayout();ECM.publish("valueChanged");}});Ext.reg("ecm.formelements.value",ECM.Form.FormElements.Value);ECM.provide("ECM.Form.Components.Base");try{ECM.Form.Components.Base=Ext.extend(Object,{constructor:function(a){this.nodeValues=a;},getTablesList:function(){return this._generateTableInterface();},getFieldsList:function(){return this._generateFieldInterface().interfaceHash;},getOperatorsList:function(){return this._generateOperatorInterface();},getValueFields:function(){},getNull:function(){},getActivityFields:function(){}});}catch(e){if(console){console.log(e);}}ECM.provide("ECM.Form.Components.String");ECM.Form.Components.String=Ext.extend(ECM.Form.Components.Base,{fieldXtype:"textfield",typeId:ECM.Rules.Constants.TYPES.STRING});ECM.provide("ECM.Form.ComponentBuilder");ECM.Form.ComponentBuilder=Ext.extend(Object,{_templateChanged:0,constructor:function(a){this.setTemplate(a);},setTemplate:function(a){return this.template=a;},buildComponent:function(a){var b=this.template;Ext.apply(b,a);return[{xtype:"panel",layout:"form",items:[b.getTopFields(),b.getInnerFields()]},b.getButtons()];}});ECM.provide("ECM.Form.View.ConfirmSwitch");ECM.Form.View.ConfirmSwitch={getConfig:function(b){var c=ECM.Form.FormElements.ElementHelper;b.node=b.node||c.getDefaultNode();var a=[{text:"Ok",listeners:{click:function(){dcForm.dialog.hide();}}}];if(dcForm.condition.totalRules<=100){a=[{text:"No",listeners:{click:function(){dcForm.dialog.hide();}}},{text:"Yes",listeners:{click:function(){dcForm.dialog.hide();dcForm.condition.callback();}}}];}return[{xtype:"panel",layout:"form",defaults:{node:b.node,formObject:dcForm},items:[dcForm.getSwitchToAdvancedInterface(),{id:"btnPanel",border:"false",btns:{},style:"padding-top:15px;",defaults:{xtype:"button",cls:"blue_button ecm_btn_left_margin",style:"float:right"},items:a,validateForm:function(){return true;}}]}];}};ECM.provide("ECM.Shortcut.FrequencyCap.Template");ECM.Shortcut.FrequencyCap.Template={bracketRacket:new Ext.XTemplate("","[","[",'[278, "", [278,"S","", 27,[["{messageAmount}"],[]]]],',"[","[",'[21, "S", "SEND_TIME", {[this.operatorValue(values)]}, [{[this.timeValue(values)]}] ]',"]",'<tpl if="messageType">',",[",'[21, "S", "S_MAILING_TYPE", 29, [["{messageType}"],[]]]',"]","</tpl>","]","],","]",{timeValue:function(a){if(a.timeframe==="selected"){return Ext.encode(a.from_date)+","+Ext.encode(a.to_date);}else{return a.timeframe+",[]";}},operatorValue:function(a){var b=67;if(a.timeframe==="selected"){b=71;}else{if(a.timeframe==='[10, "1"]'){b=63;
}}return b;}})};Ext.ns("ECM.Form");ECM.provide("ECM.Form.SelectBox");ECM.Form.SelectBox=Ext.extend(Ext.form.ComboBox,{disabled:false,forceSelection:true,triggerAction:"all",lastQuery:"",mode:"local",isDirty:false});Ext.reg("ecm.combo",ECM.Form.SelectBox);ECM.provide("ECM.Shortcut.FrequencyCap.Form");ECM.Shortcut.FrequencyCap.Form=Ext.extend(Ext.Container,{initCfg:{items:[{html:"Subscribers who were sent: ",cls:"cm_margin_5_0"},{xtype:"container",layout:"hbox",cls:"cm_indent_105 cm_padding_3_0",items:[{id:"messageAmount",xtype:"textfield",name:"messageAmount",enableKeyEvents:true,width:26,maskRe:/[0-9]/,listeners:{afterrender:function(){this.allowBlank=false;this.validator=function(b){var a=this.maskRe.test(b);return a;};},change:function(){ECM.publish("valueChanged");},keyup:function(){ECM.publish("valueChanged");}}},{xtype:"spacer",width:4},{id:"messageType",xtype:"ecm.combo",name:"messageType",width:300,editable:false,typeAhead:false,triggerAction:"all",hidden:!ECM.Stash.has_ebm_access,value:"1",store:[["",gt.gettext("standard or triggered messages")],["1",gt.gettext("standard messages")],["2",gt.gettext("triggered messages")]]},{xtype:"panel",width:300,cls:"cm_margin_5_0",hidden:ECM.Stash.has_ebm_access,html:"messages"}]},{xtype:"container",layout:"hbox",cls:"cm_indent_105 cm_padding_3_0",items:[{html:"or less ",width:40,cls:"cm_margin_5_0"},{xtype:"spacer",width:4},{id:"timeframe",xtype:"ecm.combo",width:180,name:"timeframe",typeAhead:false,triggerAction:"all",editable:false,value:'[26, "1"]',store:[['[10, "1"]',gt.gettext("today")],['[26, "1"]',gt.gettext("in the last week")],['[30, "1"]',gt.gettext("in the last month")],['[36, "1"]',gt.gettext("in the last year")],["selected",gt.gettext("in the selected timeframe")]],listeners:{select:function(){if(this.getValue()==="selected"){this.ownerCt.ownerCt.dateControl.show();}else{this.ownerCt.ownerCt.dateControl.hide();}ECM.publish("valueChanged");}}}]},{id:"dateControl",xtype:"container",ref:"dateControl",cls:"cm_indent_105 cm_padding_3_0",width:410,columnWidth:410,hidden:true,items:[{html:"from",cls:"cm_margin_5_0"},{itemId:"from_date",xtype:"ecm.dateControl",columnType:ECM.Rules.Constants.TYPES.DATETIME,idNum:0,name:"from_date"},{html:"to",cls:"cm_margin_5_0"},{itemId:"to_date",xtype:"ecm.dateControl",columnType:ECM.Rules.Constants.TYPES.DATETIME,idNum:1,name:"to_date"}]}]},constructor:function(a){Ext.apply(a,this.initCfg);ECM.Shortcut.FrequencyCap.Form.superclass.constructor.call(this,a);},validateForm:function(){var g=ECM.Stash.has_ebm_access;var f=dcForm.btnPanel;var d=f.btns.doneButton;if(d){var h=Ext.getCmp("messageAmount");var c=Ext.getCmp("timeframe").getValue();var a=!!h.getValue()&&h.maskRe.test(h.getValue());var j=!!c;if(c=="selected"){var b=Ext.getCmp("dateControl");j=(b.getComponent("from_date").isValid()&&b.getComponent("from_date").isValid());}if(a&&j){d.enable();}else{d.disable();}}}});Ext.reg("ecm.shortcut.frequencycap",ECM.Shortcut.FrequencyCap.Form);ECM.provide("ECM.Shortcut.Engagement.Template");ECM.Shortcut.Engagement.Template={bracketRacket:new Ext.XTemplate("","[",'<tpl for="action">',"[",'[{[this.getLogic(parent)]}, "",["{[this.getLogic(parent)]}","{.}","","{parent.subscriberStatus}",[["{parent.count}"]]]],',"[","[",'[21, "{.}", "{[this.getTable(values)]}_TIME", {[this.operatorValue(parent)]}, [{[this.timeValue(parent)]}] ]',"]",'<tpl if="parent.messageType">',",[",'[21, "{.}", "{.}_MAILING_TYPE", "29", [','["{parent.messageType}"],',"[]","]]","]","</tpl>","]","]",'<tpl if="xindex!=xcount">',",","</tpl>","</tpl>","]",{getLogic:function(a){return a.subscriberStatus==31?282:278;},getTable:function(b){var a={C:"CLICK",O:"OPEN",T:"TRANSACTION"};return a[b];},timeValue:function(a){if(a.timeframe==="selected"){return Ext.encode(a.from_date)+","+Ext.encode(a.to_date);}else{return a.timeframe+",[]";}},operatorValue:function(a){switch(a.timeframe){case'[10, "1"]':return 63;case"selected":return 71;default:return 67;}}})};ECM.provide("ECM.Container.CollapsibleContent");ECM.Container.CollapsibleContent=Ext.extend(Ext.Container,{openText:gt.gettext("Read more"),closeText:gt.gettext("Read less"),content:"",clickableCls:"clickable",inline:true,collapse:function(){this.openText.show();this.closeText.hide();this.content.hide();this.fireEvent("collapsed",this);},expand:function(){this.openText.hide();this.closeText.show();this.content.show();this.content.doLayout();this.fireEvent("expanded",this);},contentAlign:"bottom",constructor:function(a){Ext.apply(this,a);this.addEvents("collapsed","expanded");var b=false;if(Ext.isString(this.content)){this.content={html:this.inline?this.content+this.closeText:this.content,listeners:{scope:this,afterrender:function(){if(this.inline){var c=this.content.el.child("a");c.addClass(this.clickableCls);c.on("click",this.collapse,this);this.closeText=c;}}}};b=this.inline?true:false;}this.content.ref="content";this.content.hidden=true;this.openText={html:this.openText,ref:"openText",listeners:{scope:this,afterrender:function(){var c=this.openText.el.child("a")||this.openText.el;c.addClass(this.clickableCls);c.on("click",this.expand,this);}}};if(!b){this.closeText={html:this.closeText,ref:"closeText",hidden:true,listeners:{scope:this,afterrender:function(){var c=this.closeText.el.child("a")||this.closeText.el;c.addClass(this.clickableCls);c.on("click",this.collapse,this);}}};if(this.contentAlign=="top"){this.items=[this.content,this.openText,this.closeText];}else{if(this.contentAlign=="middle"){this.items=[this.openText,this.content,this.closeText];}else{this.items=[this.openText,this.closeText,this.content];}}}else{this.items=[this.openText,this.content];}ECM.Container.CollapsibleContent.superclass.constructor.call(this,a);}});Ext.reg("ecm.collapsiblecontent",ECM.Container.CollapsibleContent);Ext.ns("Ext.Form");ECM.provide("ECM.Form.CheckboxGroup");ECM.Form.CheckboxGroup=Ext.extend(Ext.form.CheckboxGroup,{getValue:function(a){if(a){return ECM.Form.CheckboxGroup.superclass.getValue.call(this,arguments);}else{var b=[];this.eachItem(function(c){if(c.checked){b.push(c.name);}});return b;}}});Ext.reg("ecm.checkboxgroup",ECM.Form.CheckboxGroup);ECM.provide("ECM.Shortcut.Engagement.Form");ECM.Shortcut.Engagement.Form=Ext.extend(Ext.Container,{initCfg:{listeners:{select:function(c,d){ECM.publish("valueChanged");var a={31:{text:gt.gettext("as they have"),operator:gt.gettext("greater than or equal to"),ctxt:gt.gettext("clicked, or"),otxt:gt.gettext("opened, or")},25:{text:gt.gettext("as they have not"),operator:gt.gettext("less than"),ctxt:gt.gettext("clicked, and not"),otxt:gt.gettext("opened, and not")}};var b=d.json[0];this.actionCmp.text.update(a[b].text);this.actionCmp.actionCBs.items.itemAt(0).el.dom.parentNode.childNodes[1].innerHTML=a[b].ctxt;this.actionCmp.actionCBs.items.itemAt(1).el.dom.parentNode.childNodes[1].innerHTML=a[b].otxt;this.actionCmp.doLayout();if(this.additionalOptions.content.operator.html){this.additionalOptions.content.operator.html=a[b].operator;}else{this.additionalOptions.content.operator.update(a[b].operator);this.additionalOptions.doLayout();}}},items:[{xtype:"container",layout:"hbox",items:[{html:gt.gettext("Subscribers who are"),style:"line-height:22px",width:120},{xtype:"ecm.combo",typeAhead:false,triggerAction:"all",editable:false,name:"subscriberStatus",value:"31",store:[["31",gt.gettext("active")],["25",gt.gettext("inactive")]],bubbleEvents:["select"]}],bubbleEvents:["add","remove","select"]},{xtype:"container",layout:"hbox",ref:"actionCmp",style:"margin-top:2px;",items:[{xtype:"spacer",width:120},{html:gt.gettext("as they have"),style:"line-height:22px;",ref:"text",width:100},{xtype:"ecm.checkboxgroup",columns:1,name:"action",ref:"actionCBs",width:150,items:[{boxLabel:gt.gettext("clicked, or"),name:"C"},{boxLabel:gt.gettext("opened, or"),name:"O"},{boxLabel:gt.gettext("transacted"),name:"T"}],listeners:{change:function(){ECM.publish("valueChanged");}}}]},{xtype:"container",layout:"hbox",hidden:!ECM.Stash.has_ebm_access,items:[{xtype:"spacer",width:120},{xtype:"ecm.combo",name:"messageType",width:300,typeAhead:false,triggerAction:"all",editable:false,value:"1",store:(new Ext.data.ArrayStore({data:[["",gt.gettext("standard or triggered messages")],["1",gt.gettext("standard messages")],["2",gt.gettext("triggered messages")]],fields:["id","text"]})),valueField:"id",displayField:"text"},{xtype:"panel",width:300,style:"line-height:22px;",hidden:ECM.Stash.has_ebm_access,html:"messages"}]},{xtype:"container",layout:"hbox",style:"margin-top:4px;",items:[{xtype:"spacer",width:120},{xtype:"ecm.combo",name:"timeframe",typeAhead:false,triggerAction:"all",editable:false,width:300,value:'[26, "1"]',store:[['[10, "1"]',gt.gettext("today")],['[26, "1"]',gt.gettext("in the last week")],['[30, "1"]',gt.gettext("in the last month")],['[36, "1"]',gt.gettext("in the last year")],["selected",gt.gettext("in the selected timeframe")]],listeners:{select:function(){if(this.getValue()==="selected"){this.ownerCt.ownerCt.dateControl.show();
}else{this.ownerCt.ownerCt.dateControl.hide();}ECM.publish("valueChanged");}}}]},{xtype:"container",ref:"dateControl",style:"margin-left: 120px;margin-top:4px;",width:410,columnWidth:410,hidden:true,defaults:{style:"margin-bottom: 2px"},items:[{itemId:"from_date",xtype:"ecm.dateControl",columnType:ECM.Rules.Constants.TYPES.DATETIME,idNum:0,name:"from_date"},{html:gt.gettext("to"),style:"line-height:22px;"},{itemId:"to_date",xtype:"ecm.dateControl",columnType:ECM.Rules.Constants.TYPES.DATETIME,idNum:1,name:"to_date"}]},{xtype:"ecm.collapsiblecontent",ref:"additionalOptions",style:"margin-top:10px;",openText:gt.strargs("%1Additional options%2",["<a>","</a>"]),closeText:gt.strargs("Don't need these? Return to %1Basic%2",["<a>","</a>"]),content:{xtype:"container",layout:"hbox",style:"margin-top:5px;",items:[{xtype:"spacer",width:120},{html:gt.gettext("greater than or equal to"),forceLayout:1,width:130,style:"line-height:22px;",ref:"operator"},{xtype:"spacer",width:10},{xtype:"textfield",name:"count",ref:"textfield",maskRe:/[0-9]/,value:1,width:26,enableKeyEvents:true,listeners:{afterrender:function(){this.allowBlank=false;this.validator=function(b){var a=this.maskRe.test(b);return a;};},change:function(){ECM.publish("valueChanged");},keyup:function(){ECM.publish("valueChanged");}}},{html:gt.gettext("Times"),style:"line-height:22px;margin-left:3px;"}]},listeners:{collapsed:function(a){a.content.textfield.reset();},expanded:function(a){a.doLayout();}}}]},constructor:function(a){Ext.apply(a,this.initCfg);ECM.Shortcut.Engagement.Form.superclass.constructor.call(this,a);},validateForm:function(){var j=ECM.Stash.has_ebm_access;var l=dcForm.btnPanel;var f=l.btns.doneButton;var d=this.ownerCt.getComponent("insightForm");if(f){var b=l.ownerCt.getForm().getFieldValues();var h=!!b.action.length;var c=!!b.subscriberStatus;var g=d.additionalOptions.content.textfield;var n=!!g.getValue()&&g.maskRe.test(g.getValue());var k=b.timeframe;var a=!!k;if(k=="selected"){var m=d.dateControl;a=(m.getComponent("from_date").isValid()&&m.getComponent("from_date").isValid());}if(h&&c&&a&&n){f.enable();}else{f.disable();}}}});Ext.reg("ecm.shortcut.engagement",ECM.Shortcut.Engagement.Form);ECM.provide("ECM.Shortcut.MobileDevices.Template");ECM.Shortcut.MobileDevices.Template={bracketRacket:new Ext.XTemplate("","[",'<tpl for="action">',"[",'[282, "",["282","{.}","","31",[["{parent.count}"]]]],',"[",'[[21, "{.}", "{.}_MAILING_TYPE", "29", [["1"],[]]]],','[[21, "{.}", "{[this.getTable(values)]}_TIME", {[this.operatorValue(parent)]}, [{[this.timeValue(parent)]}] ]],','[[21, "{.}", "{[this.getTable(values)]}_PLATFORM",149,[[{[this.getDevice(parent)]}],[]]]]',"]","]",'<tpl if="xindex!=xcount">',",","</tpl>","</tpl>","]",{getTable:function(b){var a={C:"CLICK",O:"OPEN"};return a[b];},timeValue:function(a){if(a.timeframe==="selected"){return Ext.encode(a.from_date)+","+Ext.encode(a.to_date);}else{return a.timeframe+",[]";}},operatorValue:function(a){switch(a.timeframe){case'[10, "1"]':return 63;case"selected":return 71;default:return 67;}},getDevice:function(a){if(a.deviceType==="1"){return'"Any Mobile, M"';}else{var b=new Array();Ext.each(ECM.Stash.insights_mobile_selection.sort(),function(d,c){Ext.each(ECM.Stash.mobile_devices,function(g,f){if(d==g[1]){b.push('"'+g.join(", ")+'"');}});});return b.join();}}})};ECM.provide("ECM.Shortcut.MobileDevices.Form");ECM.Shortcut.MobileDevices.Form=Ext.extend(Ext.Container,{cls:"insights_container",initCfg:{items:[{xtype:"container",layout:"form",items:[{xtype:"textfield",name:"subscriberStatus",value:"31",hidden:true},{xtype:"ecm.checkboxgroup",fieldLabel:gt.gettext("Subscribers who have"),cls:"form_field_indent checkbox_group",columns:1,name:"action",ref:"actionCBs",items:[{boxLabel:gt.gettext("clicked, or"),name:"C"},{boxLabel:gt.gettext("opened"),name:"O"}],listeners:{change:function(){ECM.publish("valueChanged");this.ownerCt.ownerCt.validateForm();}}}]},{xtype:"container",layout:"form",hidden:!ECM.Stash.has_ebm_access,items:{xtype:"textfield",name:"messageType",fieldLabel:gt.gettext("Mailing Type"),value:gt.gettext("Standard Messages"),readOnly:true,cls:"form_field_indent default_field",mailingType:"1"}},{xtype:"container",layout:"form",items:{xtype:"ecm.combo",cls:"form_field_indent",name:"timeframe",typeAhead:false,triggerAction:"all",editable:false,width:300,value:'[26, "1"]',store:[['[10, "1"]',gt.gettext("today")],['[26, "1"]',gt.gettext("in the last week")],['[30, "1"]',gt.gettext("in the last month")],['[36, "1"]',gt.gettext("in the last year")],["selected",gt.gettext("in the selected timeframe")]],listeners:{select:function(){if(this.getValue()==="selected"){this.ownerCt.ownerCt.dateControl.show();}else{this.ownerCt.ownerCt.dateControl.hide();}ECM.publish("valueChanged");}}}},{xtype:"container",ref:"dateControl",cls:"timeframe_container",width:470,columnWidth:470,hidden:true,items:[{itemId:"from_date",xtype:"ecm.dateControl",columnType:ECM.Rules.Constants.TYPES.DATETIME,idNum:0,name:"from_date"},{html:gt.gettext("to"),cls:"cm_padding_2"},{itemId:"to_date",xtype:"ecm.dateControl",columnType:ECM.Rules.Constants.TYPES.DATETIME,idNum:1,name:"to_date"}]},{xtype:"container",layout:"form",ref:"using",items:{xtype:"ecm.combo",name:"deviceType",ref:"deviceTypeSelection",fieldLabel:gt.gettext("Using"),cls:"form_field_indent",width:300,typeAhead:false,triggerAction:"all",editable:false,value:"1",store:(new Ext.data.ArrayStore({data:[["1",gt.gettext("any mobile device")],["2",gt.gettext("specific mobile devices")]],fields:["id","text"]})),valueField:"id",displayField:"text",listeners:{afterrender:function(){if(this.getValue()==="1"){this.ownerCt.ownerCt.mobileType.hide();}else{this.ownerCt.ownerCt.mobileType.show();}},select:function(){if(this.getValue()==="2"){this.ownerCt.ownerCt.mobileType.show();}else{this.ownerCt.ownerCt.mobileType.hide();}ECM.publish("valueChanged");}}}},{xtype:"container",width:360,ref:"mobileType",id:"MobileDevicesGridPickerContainer",cls:"margin_left_135",hidden:true,listeners:{show:function(){this.ownerCt.generateMobileDEGP();}}},{xtype:"ecm.collapsiblecontent",ref:"additionalOptions",cls:"option_container",openText:gt.strargs("%1Additional options%2",["<a>","</a>"]),closeText:gt.strargs("Don't need these? Return to %1Basic%2",["<a>","</a>"]),content:{xtype:"container",layout:"hbox",items:[{html:gt.gettext("greater than or equal to"),forceLayout:1,width:130,ref:"operator"},{xtype:"textfield",name:"count",ref:"textfield",cls:"cm_indent_5",maskRe:/[0-9]/,value:1,width:26,enableKeyEvents:true,listeners:{afterrender:function(){this.allowBlank=false;this.validator=function(b){var a=this.maskRe.test(b);return a;};},change:function(){ECM.publish("valueChanged");},keyup:function(){ECM.publish("valueChanged");}}},{html:gt.gettext("Times"),cls:"cm_indent_5 cm_padding_side_5"}]},listeners:{collapsed:function(a){a.content.textfield.reset();},expanded:function(a){a.doLayout();}}}],listeners:{render:function(){Ext.fly("selInclusion").addClass("form_field_indent");ECM.Stash.insights_mobile_selection=[];}}},generateMobileDEGP:function(){var a=Ext.getCmp("MobileDevicesDEGP");if(a){a.destroy();}return new ECM.Form.DirectEntryGridPicker({width:360,id:"MobileDevicesDEGP",displayMode:"grid",renderTo:"MobileDevicesGridPickerContainer",pickerConfig:{xtype:"ecm.gridpicker",ref:"mobileDevicesSelection",selectedKeys:ECM.Stash.insights_mobile_selection||[],store:{xtype:"arraystore",fields:[{name:"value",sortType:Ext.data.SortTypes.asUCString},{name:"key"}],data:ECM.Stash.mobile_devices||[],sortInfo:{field:"value",direction:"ASC"}},colModel:new Ext.grid.ColumnModel({defaults:{sortable:false},columns:[{id:"value",header:"Value",searchable:true,dataIndex:"value"}]}),stripeRows:true,autoExpandColumn:"value",autoHeight:true,viewConfig:{scrollOffset:1,forceFit:true},width:360,listeners:{selectionchange:function(b){ECM.publish("valueChanged");ECM.Stash.insights_mobile_selection=this.getValue();}},hideRefresh:true}});},constructor:function(a){Ext.apply(a,this.initCfg);
ECM.Shortcut.MobileDevices.Form.superclass.constructor.call(this,a);},validateForm:function(){var k=dcForm.btnPanel;var f=k.btns.doneButton;var d=this.ownerCt.getComponent("insightForm");if(f){var c=k.ownerCt.getForm().getFieldValues();var h=!!c.action.length;var g=d.additionalOptions.content.textfield;var m=!!g.getValue()&&g.maskRe.test(g.getValue());var j=c.timeframe;var b=!!j;var a=((d.using.deviceTypeSelection.getValue()==1)||(ECM.Stash.insights_mobile_selection.length>0))?true:false;if(j=="selected"){var l=d.dateControl;b=(l.getComponent("from_date").isValid()&&l.getComponent("from_date").isValid());}if(h&&b&&m&&a){f.enable();}else{f.disable();}}}});Ext.reg("ecm.shortcut.mobiledevices",ECM.Shortcut.MobileDevices.Form);ECM.provide("ECM.Shortcut.Config");ECM.Shortcut.Config=[{id:"engagement",text:gt.gettext("Engagement"),formXtype:"ecm.shortcut.engagement",template:ECM.Shortcut.Engagement.Template,subtitle:gt.gettext("Engagement")},{id:"frequencyCap",text:gt.gettext("Frequency Cap"),formXtype:"ecm.shortcut.frequencycap",template:ECM.Shortcut.FrequencyCap.Template,subtitle:gt.gettext("Frequency Cap")},{id:"mobileDevices",text:gt.gettext("Mobile Devices"),formXtype:"ecm.shortcut.mobiledevices",template:ECM.Shortcut.MobileDevices.Template,subtitle:gt.gettext("Mobile Devices"),hidden:!ECM.Stash.show_access_location}];ECM.Shortcut.ConfigDataStore=new Ext.data.JsonStore({autoDestroy:true,data:{data:ECM.Shortcut.Config},root:"data",idProperty:"id",fields:["id","text","template","formXtype","subtitle"]});ECM.provide("ECM.Form.View.Shortcut");ECM.Form.View.Shortcut={getConfig:function(d){var f=ECM.Form.FormElements.ElementHelper;d.node=d.node||f.getDefaultNode();function c(h){var j=ECM.getObject("attributes.data",h);if(j){return ECM.Shortcut.ConfigDataStore.getById(j[2]);}}var b=c(d.node);var g=b.get("formXtype")=="ecm.shortcut.engagement";var a=[{xtype:"form",layout:"form",subtitle:b.get("subtitle"),labelWidth:g?115:100,plugins:["ecm.subscription"],subscriptions:{valueChanged:function(){dcForm.btnPanel.validateForm();}},defaults:{node:d.node,formObject:dcForm,record:b},items:Ext.clean([ECM.Form.Components.Globals.getNotificationArea.createDelegate(dcForm.sourceTreeNode.ownerTree.perspective(),[480])(),{xtype:"ecm.formelements.action"},{itemId:"insightForm",xtype:b.get("formXtype")},{xtype:"panel",id:"actionChangedWarning",style:"padding-top:10px",hidden:true,html:gt.gettext("Changing the action of this condition will change the action for the entire group."),plugins:["ecm.subscription"],subscriptions:{action_changed:function(h){if((h.args[0].value&ECM.Rules.Constants.LOGIC.OR)&&(h.args[0].originalValue&ECM.Rules.Constants.LOGIC.AND)){this.show();}else{this.hide();}}}},{xtype:"container",id:"btnPanel",border:"false",style:"padding-top:15px;",btns:{},listeners:{beforerender:function(h){this.formObject.btnPanel=h;var j=this.ownerCt.getComponent("insightForm");this.validateForm=j.validateForm;}},defaults:{xtype:"button",cls:"blue_button ecm_btn_left_margin",style:"float:right",formObject:dcForm,record:b,node:d.node},items:Ext.clean([{text:gt.gettext("Cancel"),listeners:{afterrender:function(h){this.formObject.btnPanel.btns.cancelButton=h;},click:function(){this.formObject.dialog.hide();}}},{id:"dcModalDoneButton",disabled:true,text:gt.gettext("Done"),listeners:{afterrender:function(h){this.formObject.btnPanel.btns.doneButton=h;},click:function(){var h=this.record.get("template").bracketRacket.apply(this.ownerCt.ownerCt.getForm().getFieldValues());h=Ext.decode(h);var k={attributes:{data:h,isGroup:true,groupData:{name:b.get("text"),logic:Ext.getCmp("selInclusion").getValue(),isInsight:true},fromTree:true,dropPoint:this.node.dropPoint,useLogic:true,skipModal:true},childNodes:[],ownerTree:mt};k.ui={startDrop:function(){},endDrop:function(){},removeClass:function(){}};Ext.applyIf(k,ECM.treegrid.TreeNode.prototype);var j=this.node.dropArgs;if(this.node.dropIsContainer){mt.dropConfig.onContainerDrop.call(this.node.dropObj,j[0],j[1],{node:k});}else{mt.dropConfig.onNodeDrop.call(this.node.dropObj,j[0],j[1],j[2],{node:k});}this.formObject.dialog.hide();}}}])}])}];return a;}};ECM.provide("ECM.Form.Platform");(function(){ECM.Form.Platform=ECM.Adapter.extend(Ext.form.Field,{defaultAutoCreate:{tag:"div"},cls:"multiselect_container",initialized:false,buildplatformSelectionPanel:function(){var d=[],c=this;if(this.platformStore){if(this.platformStore.data){for(var g=0,f=this.platformStore.data.items.length;g<f;g++){var h=this.platformStore.data.items[g].data;d.push([h.value,h.text+" ("+h.value+")"]);}}else{for(var g=0,f=this.platformStore.length;g<f;g++){d.push([this.platformStore[g][0],this.platformStore[g][1]+" ("+this.platformStore[g][0]+")"]);}}}var a={xtype:"multiselect",id:"platformSelectionPlatform",region:"center",allowBlank:false,width:300,minSelections:1,store:d,listeners:{click:function(n,p){var m=this.getValue().split(","),j=Ext.get("platformSelectionPlatform");if(!Ext.get("loadCont")){var l=document.createElement("img");l.src="/images/blue_loading.gif";var k=document.createElement("div");k.id="loadCont";k.appendChild(l);setTimeout(function(){j.dom.parentNode.appendChild(k);},50);}else{Ext.getDom("loadCont").style.display="block";}if(Ext.get("platformSelectionSelection")){Ext.getDom("platformSelectionSelection").style.display="none";Ext.getDom("device_container").style.display="none";}var o=ECM.Ajax.request({url:"/cm/r/segment/platform_selection",params:{platform:m,table:Ext.getCmp("selTable").value,any_mobile:Ext.encode(dcForm.condition.operands).indexOf("Any Mobile, M")>-1?"yes":"no"},method:"GET",success:function(s,u){var w=s.responseJSON.data,x=null,r=Ext.getDom("loadCont");r.style.display="none";if(m.length>=1){if(Ext.get("platformSelectionSelection")){var B=Ext.getDom("platformSelectionSelection");B.parentNode.removeChild(B);var q=Ext.getDom("device_container");q.parentNode.removeChild(q);}var z=document.createElement("select");z.setAttribute("id","platformSelectionSelection");z.setAttribute("multiple","multiple");var A=document.createElement("div");A.setAttribute("id","device_container");A.className="sub_list_container";A.appendChild(z);Ext.getDom("platformSelectionPlatform").parentNode.appendChild(A);var y=Ext.get("platformSelectionSelection");if(Ext.getCmp("platformSelectionPlatform").isValid()){for(var v=0,t=w.length;v<t;v++){x=document.createElement("option");x.value=w[v];x.innerHTML="&nbsp;"+(m.length==1?w[v].replace(/,.*$/,""):w[v]);y.dom.appendChild(x);}}y.dom.style.display="block";y.dom.style.visibility="visible";Ext.each(y.query("option"),function(E,D){Ext.get(E).on("mousedown",function(G,F){F.selected=(F.selected?false:true);G.stopEvent();return false;});});if(ECM.Adapter.isFunction(p)){p();}}},failure:function(q,r){dcForm.dialog.notify.error("Server request failed");}});},afterrender:function(j,k){if(!c.initialized){c.setValue(c.value);c.initialized=true;}}}};var b=new Ext.Panel({border:false,items:[a]});return b;},afterRender:function(){ECM.Form.Platform.superclass.afterRender.call(this);this.renderPanel();},renderPanel:function(){this.platformSelectionPanel=this.buildplatformSelectionPanel();this.platformSelectionPanel.render(this.el);},setValue:function(f){if(!ECM.Adapter.isArray(f)){return;}var d=[];for(var h=0,c=f.length;h<c;h++){var g=f[h]?f[h].split(","):"";var b=g.length==2?g[g.length-1].replace(" ",""):"";b=b.split("-")[0];if(b!=""&&d.indexOf(b)==-1){d.push(b);}}var a=function(){var k=[];Ext.each(f,function(m,o){k=Ext.query("#platformSelectionSelection option");for(var n=0,l=k.length;n<l;n++){if(k[n].value==m){k[n].selected=true;break;}}});};var j=Ext.getCmp("platformSelectionPlatform");var b=Ext.get("platformSelectionPlatform");if(b&&j&&d.length){j.setValue(d);j.fireEvent("click",j,a);}},getValue:function(){var a=Ext.query("#platformSelectionSelection option"),b=[];Ext.each(a,function(d,c){if(d.selected){b.push(d.value);}});return b;}});Ext.reg("ecm.platform",ECM.Form.Platform);})();ECM.provide("ECM.Form.Geolocation");(function(){ECM.Form.Geolocation=ECM.Adapter.extend(Ext.form.Field,{defaultAutoCreate:{tag:"div"},cls:"multiselect_container",initialized:false,buildCountryStatePanel:function(){var c=[],b=this;
if(this.countryStore){if(this.countryStore.data){for(var f=0,d=this.countryStore.data.items.length;f<d;f++){var g=this.countryStore.data.items[f].data;c.push([g.value,g.text+" ("+g.value+")"]);}}else{for(var f=0,d=this.countryStore.length;f<d;f++){c.push([this.countryStore[f][0],this.countryStore[f][1]+" ("+this.countryStore[f][0]+")"]);}}}var h={xtype:"multiselect",id:"countryStateCountry",region:"center",allowBlank:false,width:300,minSelections:1,store:c,listeners:{click:function(n,p){var m=this.getValue().split(","),o=Ext.get("countryStateCountry");if(!Ext.get("loadCont")){var l=document.createElement("img");l.src="/images/blue_loading.gif";var k=document.createElement("div");k.id="loadCont";k.appendChild(l);setTimeout(function(){o.dom.parentNode.appendChild(k);},50);}else{Ext.getDom("loadCont").style.display="block";}if(Ext.get("countryStateState")){Ext.getDom("countryStateState").style.display="none";Ext.getDom("state_container").style.display="none";}var j=ECM.Ajax.request({url:"/cm/r/segment/country_state",params:{country:m},method:"GET",success:function(u,w){var y=u.responseJSON.data,z=null,t=Ext.getDom("loadCont");t.style.display="none";if(m.length>=1){if(Ext.get("countryStateState")){var B=Ext.getDom("countryStateState");B.parentNode.removeChild(B);var s=Ext.getDom("state_container");s.parentNode.removeChild(s);}var A=document.createElement("select");A.setAttribute("id","countryStateState");A.setAttribute("multiple","multiple");var q=document.createElement("div");q.setAttribute("id","state_container");q.className="sub_list_container";q.appendChild(A);Ext.getDom("countryStateCountry").parentNode.appendChild(q);var r=Ext.get("countryStateState");if(Ext.getCmp("countryStateCountry").isValid()){for(var x=0,v=y.length;x<v;x++){z=document.createElement("option");z.value=y[x];z.innerHTML="&nbsp;"+(m.length==1?y[x].replace(/,.*$/,""):y[x]);r.dom.appendChild(z);}}r.dom.style.display="block";r.dom.style.visibility="visible";Ext.each(r.query("option"),function(E,D){Ext.get(E).on("mousedown",function(G,F){F.selected=(F.selected?false:true);G.stopEvent();return false;});});if(ECM.Adapter.isFunction(p)){p();}}},failure:function(q,r){dcForm.dialog.notify.error("Server request failed");}});},afterrender:function(j,k){if(!b.initialized){b.setValue(b.value);b.initialized=true;}}}};var a=new Ext.Panel({border:false,items:[h]});return a;},afterRender:function(){ECM.Form.Geolocation.superclass.afterRender.call(this);this.renderPanel();},renderPanel:function(){this.countryStatePanel=this.buildCountryStatePanel();this.countryStatePanel.render(this.el);},setValue:function(c){if(!ECM.Adapter.isArray(c)){return;}var b=[];for(var f=0,a=c.length;f<a;f++){var d=c[f]?c[f].split(","):"";var h=d.length==2?d[d.length-1].replace(" ",""):"";h=h.split("-")[0];if(h!=""&&b.indexOf(h)==-1){b.push(h);}}var j=function(){var k=[];Ext.each(c,function(m,o){k=Ext.query("#countryStateState option");for(var n=0,l=k.length;n<l;n++){if(k[n].value==m){k[n].selected=true;break;}}});};var g=Ext.getCmp("countryStateCountry");var h=Ext.get("countryStateCountry");if(h&&g&&b.length){g.setValue(b);g.fireEvent("click",g,j);}},getValue:function(){var a=Ext.query("#countryStateState option"),b=[];Ext.each(a,function(d,c){if(d.selected){b.push(d.value);}});return b;}});Ext.reg("ecm.geolocation",ECM.Form.Geolocation);})();ECM.provide("ECM.Form.DCEditor");Ext.onReady(function(){Ext.QuickTips.init();});window.$=function(a){return document.getElementById(a);};(function(){var o=navigator.userAgent.indexOf("MSIE")>=0;var m=navigator.userAgent.indexOf("Firefox")>=0;var L=navigator.userAgent.indexOf("KHTML")>=0;var P=function(af){return setTimeout(af,99);};var k=o?function(ag,ah,af){ag.attachEvent("on"+ah,af);}:function(ag,ah,af){ag.addEventListener(ah,af,false);};var c=o?function(ag,ah,af){ag.detachEvent("on"+ah,af);}:function(ag,ah,af){ag.removeEventListener(ah,af,false);};var a=o?function(af){if(!af){af=window.event;}if(af){return af.srcElement;}}:function(af){return af.target;};var H=o?function(ag,ah){var af=setInterval(function(){if(!ag.cd||!ag.cd.body){return;}clearInterval(af);ah();},99);}:function(af,ag){ag();};var v=o?function(af){return af.cd.selection;}:function(af){return af.cw.getSelection();};var F=o?function(af){if(!af){return;}return af.createRange().parentElement();}:function(ah,ag){if(!ah){return;}var af=ah.anchorNode;return ag&&af?af.parentNode:af;};var t=o?F:function(ah,ag){var af=ah.focusNode;return ag&&af?af.parentNode:af;};var h=o?function(af){af.clear();}:function(af){if(!af.isCollapsed){af.deleteFromDocument();}};var ac=o?function(af,ag){if(ag.tagName==="SPAN"){ag.parentNode.removeChild(ag);}}:function(ag,ah){var af=aa(ag);z(af,ah);af.deleteContents();};var ad=o?function(af){af.selLast=j(af).duplicate();}:function(af){af.selLast=j(af).cloneRange();};var E=function(af){if(af.selLast&&!af.inHtmlEditor){l(af.selLast,v(af));}};var U=o?function(ag){var af=j(ag);ag.selLast2=[af.offsetLeft,af.offsetTop,af.text.length];}:function(af){var ah=v(af);var ag=F(ah);var ai=R(ag)-V(af,ah);if(!ag){return;}if(ag.parentNode&&ag.parentNode.tagName==="SPAN"){ag=ag.parentNode;}for(ag=ag.nextSibling;ag;ag=ag.nextSibling){ai+=R(ag);}af.selLast2=[ai,u(j(af)).length];};var Y=o?function(ag){if(ag.inHtmlEditor){return;}var af=aa(ag);try{af.moveToPoint(ag.selLast2[0],ag.selLast2[1]+10);if(ag.selLast2[2]){Z(af,ag.selLast2[2]);}af.select();}catch(ah){return;}}:function(ai){if(ai.inHtmlEditor){return;}var ak,aj=0;if(ai.cd.body.childNodes.length===1){ak=ai.cd.body.firstChild;aj=R(ak);}else{if(ai.selLast2[0]===0){ak=ai.cd.body.lastChild;aj=R(ak);}else{var al;for(al=ai.cd.body.lastChild;aj<ai.selLast2[0]&&al;al=al.previousSibling){aj+=R(al);}ak=al?al.nextSibling||al:ai.cd.body.firstChild;if(aj===ai.selLast2[0]){ak=ak.previousSibling||ak;}}}var af;if(aj===ai.selLast2[0]){for(;ak&&ak.tagName==="BR";ak=ak.previousSibling){af=2;}}else{for(;ak&&ak.tagName==="BR";ak=ak.nextSibling){af=1;}}var ah=R(ak);if(af){aj=af===1?0:ah+ai.selLast2[0];}var am=aj-ai.selLast2[0];am=am>0?am<ah?am:ah:0;var ag=aa(ai);ae(ag,am,ak);ai.selLast2[1]?Z(ag,am+ai.selLast2[1],ak):ag.collapse(true);l(ag,v(ai));};var T=function(ah){ah.cw.focus();var ai=v(ah);var ag=j(ah);var af=u(ag).length;if(af){ag.collapse(true);l(ag,ai);}y(ah,'<span id="ieCursor">.</span>');if(af){Z(ag,af,F(ai));l(ag,ai);}ah.selLast3=af;};var X=function(ag){var ai=ag.$("ieCursor");if(!ai){return;}var ah=v(ag);var af=aa(ag);z(af,ai);l(af,ah);if(!o&&!(ai.parentNode&&ai.parentNode.tagName==="SPAN")){y(ag,".");af=j(ag);ae(af,ah.anchorOffset-1,F(ah));l(af,ah);}h(ah);if(ag.selLast3){af=j(ag);Z(af,(ah.anchorOffset||0)+ag.selLast3,F(ah));l(af,ah);}ad(ag);};var B=o?function(af){af.empty();}:function(af){af.removeAllRanges();};var ae=o?function(af,ah,ag){af.moveStart("textedit");af.moveStart("character",ah);}:function(af,ai,ag){try{af.setStart(ag,ai);}catch(ah){return;}};var Z=o?function(af,ag){af.moveEnd("character",ag);}:function(af,ai,ag){try{af.setEnd(ag,ai);}catch(ah){return;}};var z=o?function(af,ag){af.moveToElementText(ag);}:function(af,ag){af.selectNode(ag);};var l=o?function(af,ag){B(ag);af.select();}:function(af,ag){B(ag);ag.addRange(af);};var aa=o?function(af){return af.cd.body.createTextRange();}:function(af){return af.cd.createRange();};var j=o?function(af){return v(af).createRange();}:function(af){var ag=v(af);try{return ag.getRangeAt(0);}catch(ah){return aa(af);}};var u=o?function(af){return af.text;}:function(af){return af.toString();};var w=o?function(af){return af.htmlText;}:function(ag){var aj=[],ai=ag.extractContents().childNodes;for(var ah=0,af=ai.length;ah<af;ah++){aj.push(ai[ah].tagName==="BR"?"<br>":ai[ah].nodeValue);}return aj.join("");};var M=o?function(af){return af.boundingWidth===0;}:function(af){return af.collapsed;};var y=o?function(af,ag){j(af).pasteHTML(ag);}:function(af,ah){try{af.cd.execCommand("insertHTML",false,ah);}catch(ag){return;}};var I=o?function(af){af.cancelBubble=true;af.returnValue=false;}:function(af){af.stopPropagation();af.preventDefault();};
var A=o?function(){}:function(af){if(v(af)){af.insert("<div></div>");}};var Q=o?function(af){P(function(){var ag=af.cd.body.innerHTML.replace(/([sS][rR][cC]=)<A href=".*?">(.*?)<\/A>/g,'$1"$2"').replace(/([hH][rR][eE][fF]=)<A href=".*?">(.*?)<\/A>/g,'$1"$2"').replace(/"?<A href=".*?">(.*?)<\/A>"?/g,'"$1"');if(ag!==af.cd.body.innerHTML){T(af);af.cd.body.innerHTML=ag;X(af);}});}:function(){};var V=o?function(ah,aj){ah.cw.focus();var ag=aj.createRange();var af=ag.text.length;if(af){ag.collapse(true);}ag.pasteHTML('<span id="ieCursor">.</span>');var ak=ah.$("ieCursor");var al=0;for(var ai=ak.previousSibling;ai;ai=ai.previousSibling){al+=ai.nodeValue?ai.nodeValue.length:0;}ak.parentNode.removeChild(ak);if(af){Z(ag,af);ag.select();}return(al);}:function(af,ag){return ag?ag.anchorOffset:0;};var S=o?function(af){var ag=af.textContent||af.innerHTML;if(!ag){ag=(af.nodeValue||"")+(af.nextSibling?af.nextSibling.nodeValue||"":"");}return ag;}:function(af){if(!af){return"";}return af.textContent||af.innerHTML||"";};var O=function(af,ag){if(af===undefined){af="";}if(!ag){af=af.replace(/&[^\s;]+;/gi,".");}return af.replace(/<br>/gi,".").length;};var R=function(af){return O(S(af),true);};var b=function(af){var ai=af.match(/\w+?\(/g);if(!ai){return af;}ai=ai.length;var ah=af.split(/\w+?\(/).pop();var ag=ah.match(/\)/g);ag=ag?ag.length:0;ah=ah.replace(/\s+/g,"").replace(/[^a-zA-Z0-9_'"].+/,"");if(ai===ag&&(!ah.match(/['"]/))&&(ah=ah.match(/[\w]+/))){return ah?ah[0]:af;}};var n=function(ai,ag){if(!ag){ag=0;}var ah=RegExp(/(?:<|&lt;)a[^a-z]?/gi);var af=RegExp(/(?:<|&lt;)\/a(?:>|&gt;)/gi);while(ah.exec(ai)){ag++;}while(af.exec(ai)){ag--;}return ag;};var ab=function(af){if(af===undefined){af="";}return af.replace(/<br\/?>/gi,"\n").replace(/<\/?span.*?>/gi,"").replace(/&lt;/gi,"<").replace(/&gt;/gi,">").replace(/&nbsp;/gi," ").replace(/&amp;/gi,"&");};var D=function(af,ag){if(af===undefined){af="";}af=r(af);if(!ag){af=af.replace(/&(?!amp;)/g,"&amp;");}return af.replace(/<span class="(?:p13n|dc)\-(?:good|bad)">(.*?)<\/span>/g,"$1").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\r/g,"").replace(/\n/g,"<br>").replace(RegExp(String.fromCharCode(194),"g"),"");};var r=function(ai){var aj=RegExp(/&(?:amp;)?#x[0-9a-fA-F]+;/g);var ah,af=0,ag=[];while(ah=aj.exec(ai)){ag.push(ai.substring(af,ah.index)+(ah[0]==="&#x26;"?"&amp;":f(ah[0])));af=ah.index+ah[0].length;}if(af!==ai.length){ag.push(ai.substring(af,ai.length));}return ag.length?ag.join(""):ai;};var f=function(){var ag=document.createElement("div");var af={};return function(aj){if(af[aj]){return af[aj];}ag.innerHTML=aj;var ah=[];for(var ai=ag.firstChild;ai;ai=ai.nextSibling){ah.push(S(ai));}return af[aj]=ah.join("");};}();var W=function(af){if(af===undefined){af="";}if(o){af=af.replace(/([hH][rR][eE][fF]=)<A href=".*?">(.*?)<\/A>/g,'$1"$2"');}return af.replace(/<br\/?>/gi,"\1").replace(/<span id="?ieCursor"?>.<\/span>/i,"\2").replace(/<[^>]*>/g,"").replace("\2",'<span id="ieCursor">.</span>').replace(/[\1\n]/g,"<br>");};var J=function(ak,ai){var ah=document.getElementsByTagName("head")[0];var aj=RegExp(ak+"$");for(var ag=ah.firstChild;ag;ag=ag.nextSibling){if(aj.exec(ag.src)){ai();return;}}var af=document.createElement("script");af.src=ak;if(ai){k(af,"load",ai);}ah.appendChild(af);};var N;var g=function(ag){if(!ag){return;}if(!ag.width){ag.width=600;}if(!ag.height){ag.height=650;}ag.autoScroll=true;ag.layout="border";ag.items=[{region:"center",html:ag.html||" "}];delete ag.html;if(!ag.listeners){ag.listeners={};}if(ag.listeners.close){var af=ag.listeners.close;ag.listeners.close=function(){af();N=undefined;};}else{ag.listeners.close=function(){N=undefined;};}N=new ECM.GenericWindow(ag);N.show();};var p=function(){if(!N){return;}N.close();delete N;};var K=function(){};var G=function(af){af.cls="ecm-message-box";Ext.Msg.show(af);if(af.onLoad){setTimeout(af.onLoad,999);}};var d=function(){d=ECM.Tablespace.get("mtype")==="2"?function(){return true;}:function(){return false;};return d();};var x=function(af){if(!af){return af;}if(o){af=af.replace(/<br\/?>/gi,"\1").replace(/&nbsp;/gi,"\2");}return f(af.replace(/<br\/?>/gi,"\n").replace(/&nbsp;/gi," ").replace(/<[^>]+>/g,"")).replace(/\1/g,"\n").replace(/\2/g," ").replace(/\n$/,"");};var q,s;ECM.Form.DCEditor=function(){var af=0;return function(ah){ECM.Form.DCEditor.instances.push(this);this.id=af++;if(!ah.format){ah.format="text";}if(ah.content===undefined||ah.content===null){ah.content="";}for(var ag in ah){this[ag]=ah[ag];}if(d()){this.hidePersonalizationMenu=true;}return[this,this.write()];};}();ECM.Form.DCEditor.instances=[];ECM.Form.DCEditor.data=function(){var af={};return function(ag,ah){ag=ag.replace(/_.+/,"");if(ah){af[ag]=ah;}return af[ag];};}();ECM.Form.DCEditor.getData=function(af,ag){if(!ag){ag=function(){};}if(ECM.Form.DCEditor.data(af)){ag(ECM.Form.DCEditor.data(af));return;}if(ECM.Ajax.isLoading()){return P(function(){ECM.Form.DCEditor.getData(af,ag);});}ECM.Ajax.request({url:ECM.Form.DCEditor.url(af,true),method:"GET",success:function(ah){ag(ECM.Form.DCEditor.data(af,ah.responseJSON.data));}});};ECM.Form.DCEditor.url=function(){var af={P13n:"get_personalization",Tx:"get_tx",Link:"get_special_links",DC:"get_dc",setP13nDefault:"set_personalization_default"};return function(ah,ai){var ag=af[ai?ah.replace(/_.+/,""):ah]||ah;if(ah==="Link"){return"/cm/r/library/dynamic_content/"+ag.replace(/^get_/,"")+"?mtype="+ECM.Tablespace.get("mtype");}else{return"/m/service/content?rm="+ag+"&"+ECM.Tablespace.asQueryString();}};}();ECM.Form.DCEditor.submit=function(af){try{for(var ag=0,aj=ECM.Form.DCEditor.instances.length;ag<aj;ag++){var am=ECM.Form.DCEditor.instances[ag];if(am.inHtmlEditor){var ak=document.createElement("input");ak.type="hidden";ak.name="smtmpl_tmpl_use_htmleditor";ak.value=1;af.appendChild(ak);am.switchHtmlEditor();}var al=document.createElement("textarea");al.name="smtmpl_tmpl_"+am.format;al.value=x(am.cd.body.innerHTML);al.style.display="none";af.appendChild(al);}var am=ECM.Form.DCEditor.data("DC");var ah=[];for(var an in am[0]){if(am[0][an][4]){ah.push(an);}}if(ah.length){var ak=document.createElement("input");ak.name="dclib_overwrite";ak.value=ECM.Adapter.encode(ah);ak.style.display="none";af.appendChild(ak);}return true;}catch(ai){return false;}};ECM.Form.DCEditor.markDCFormats=function(am){var af=ECM.Form.DCEditor.data("DC");var al,ak;if(am!==undefined){al=Math.floor(am/3);ak=al+3;}else{al=0;ak=ECM.Form.DCEditor.instances.length;}var aj=d()?"\\[[^\\]]+\\]":"";for(var ai in af[0]){af[0][ai][3]=[];for(var ag=al,ah=ak;ag<ah;ag++){if(ECM.Form.DCEditor.instances[ag].cd&&RegExp("%%"+ai+aj+"%%","i").exec(ECM.Form.DCEditor.instances[ag].cd.body.innerHTML)){af[0][ai][3].push(ECM.Form.DCEditor.instances[ag].format==="html"?"h":ECM.Form.DCEditor.instances[ag].format==="aol"?"r":"t");}}}for(var ai in af[1]){af[1][ai][3]=[];}};ECM.Form.DCEditor.onDCModalClose=function(af){try{if(!af){return;}af.identity="d_"+af.identity.toLowerCase();var am=ECM.Form.DCEditor.data("DC");if(af.tagOrig){delete am[0][af.tagOrig.toUpperCase()];}var ai=af.identity!==af.tagOrig;var an=af.identity.toUpperCase();var ag=am[0][an]&&!ai;am[0][an]=[af.identity,(af.description||""),(af.tagType||1),[]];if(ag){return;}for(var ah=0,al=ECM.Form.DCEditor.instances.length;ah<al;ah++){var ak="DCEditorMenuInsert"+ECM.Form.DCEditor.instances[ah].id;ai?ECM.Form.DCEditor.instances[ah].renameDCTag(af.tagOrig,af.identity,"dc-good"):ECM.Form.DCEditor.instances[ah].recolorizeDCTag(af.identity,"dc-good");}}catch(aj){}};ECM.Form.DCEditor.formatInfo=function(ah,aj){var ai=ECM.Tablespace.asQueryString();var af='<li>&#149; <a href="/m/mailers/mailings/preview?'+ai+"&format="+ah+'" target="_PREVIEW_">'+gt.gettext("Preview")+"</a></li>";var ag='<li>&#149; <a href="/cgi-bin/mailers/mailings/content.cgi?'+ai+"&smtmpl_fmt="+ah+'" target="_TEMPLATE_">'+gt.gettext("Template-Based Editor")+"</a></li>";return ah==="aol"?{title:"RICH TEXT",titleAlt:"Rich Text",className:"cascade_3",menuBar:'			<li>&#149; <a href="javascript:void(0)" onclick="ECM.Form.DCEditor.instances['+aj+'].expand(this)">'+gt.gettext("Expand")+"</a></li>			"+af+"			"+ag,hdr:function(){return"";
},ftr:'			<tr>				<td class="bold">'+gt.gettext("Generate RICH TEXT")+':</td>				<td>					<input type="checkbox" name="smtmpl_aolgen" value="1">					'+gt.gettext("Create RICH TEXT template from TEXT template, overwriting any existing  template.")+"				</td>			</tr>		"}:ah==="html"?{title:"HTML",className:"cascade_4",menuBar:'			<li id="DCEditorMenuHtmlExpand'+aj+'">&#149; <a href="javascript:void(0)" onclick="ECM.Form.DCEditor.instances['+aj+'].expand(this)">'+gt.gettext("Expand")+"</a></li>			"+af+"			"+ag+'			<li>&#149; <a id="DCEditorMenuHtml'+aj+'" href="javascript:void(0)" onclick="ECM.Form.DCEditor.instances['+aj+'].switchHtmlEditor(this)">'+gt.gettext("HTML Editor")+"</a></li>		",hdr:function(){return"";}}:ah==="text"?{title:"TEXT",titleAlt:"Text",className:"cascade_2",menuBar:'			<li>&#149; <a href="javascript:void(0)" onclick="ECM.Form.DCEditor.instances['+aj+'].expand(this)">'+gt.gettext("Expand")+'</a></li>			<li>&#149; <a href="javascript:void(0)" onclick="ECM.Form.DCEditor.instances['+aj+'].pwWrapText(this)">'+gt.gettext("Wrap Text")+"</a></li>			"+af+"			"+ag,hdr:function(ak){return'<div id="DCEditorRuler'+aj+'" type="text" class="dc-wrap-ruler"'+(ak?' style="display:none"':"")+">1-------10--------20--------30--------40--------50--------60--------70--------80</div>";},ftr:'			<tr>				<td class="bold">'+gt.gettext("Generate TEXT")+':</td>				<td>					<input type="checkbox" name="smtmpl_h2txtgen" value="1">					'+gt.gettext("Create TEXT template from HTML template, overwriting any existing template.")+"				</td>			</tr>		"}:{};};ECM.Form.DCEditor.prototype={$:function(af){return this.cd.getElementById(af);},INSERT_MENU_LIMIT:10,selLast:undefined,rxTag:RegExp(/^%%.*?%%$/),rxTag2:RegExp(/%%([^<]*?)%%(?!<\/span>)/gi),rxTagMarker:RegExp(/%%/g),rxTagInTag:RegExp(/.%%./),rxEBM:RegExp(/^(.+)?\[(.+?)\]$/),initialize:function(){if(this.initialized){this.cw.focus();return;}this.initializeDom();this.initialized=true;if(o){this.cd.designMode="On";try{this.cd.execCommand("AutoUrlDetect",false,false);}catch(ag){}}var af=this;H(af,function(){if(af.content){var ah;if(af.wrapBound){ah=this._wrapText(af.content,af.wrapBound,true);delete af.wrapBound;}else{ah=D(af.content,false);}af.cd.body.innerHTML=af.colorizeText(ah);}else{af.cd.body.innerHTML="";}if(!o){af.cd.designMode="On";}af.addEvents();af.setStateFirst();if(af.useHtmlEditor&&af.format==="html"){af.switchHtmlEditor($("DCEditorMenuHtml"+af.id));}af.cw.focus();});},initializeDom:function(){this.ed=$("DCEditor"+this.id);this.cw=this.ed.contentWindow;this.cd=this.cw.document;},write:function(){var ag=ECM.Form.DCEditor.formatInfo(this.format,this.id);if(this.noDecoration){var af=ag.hdr(this.hide)+'<iframe id="DCEditor'+this.id+'"'+(this.onload?' onload="'+this.onload+'"':"")+' src="/js/ECM/resources/DCEditor.html" style="width:100%;height:'+(this.height?(this.height-61)+"px":"35em")+(this.hide?";display:none":"")+(o?";z-index:-1":"")+'"></iframe>';delete this.noDecoration;delete this.hide;return af;}document.write('	<div class="ecm-3p-wrap">	<div class="bluebox '+ag.className+'" style="width:54.5em">		<table style="width:100%">			<tr>				<td style="text-align:left">					<span style="font-weight:bold">'+ag.title+'</span>				</td>				<td style="text-align:right">					<ul class="menubar">						'+ag.menuBar+'						<li>&#149; <span id="DCEditorMenuInsert'+this.id+'" onclick="ECM.Form.DCEditor.instances['+this.id+'].showMenuInsert(-3)" class="menu-btn" onmouseover="this.className+=\' menu-hover\'" onmouseout="this.className=this.className.replace(\' menu-hover\', \'\')">Insert&#9660;</span></li>					</ul>				</td>			</tr>		</table>	</div>	<div class="bluebox '+ag.className+'" style="width:54.5em">'+ag.hdr()+'		<iframe id="DCEditor'+this.id+'" onload="ECM.Form.DCEditor.instances['+this.id+'].initialize()" src="/js/ECM/resources/DCEditor.html" class="ed-iframe"></iframe>		<table class="ecm-dceditor-ftr">'+(ag.ftr||"")+'			<tr>				<td class="bold">'+gt.gettext("Link prefix")+':</td>				<td>					<input type="text" name="smtmpl_track_'+this.format+'" maxlength="4" size="4">					'+gt.gettext("(up to 4 characters [a-z]) Generate tracking links with this base name.")+'				</td>			</tr>			<tr>				<td class="bold">'+gt.gettext("Include format")+':</td>				<td>					<input type="radio" value="1" name="smtmpl_include_'+this.format+'"'+(this.include?" checked":"")+"> "+gt.gettext("Yes")+'					<input type="radio" value="0E0" name="smtmpl_include_'+this.format+'"'+(!this.include?" checked":"")+"> "+gt.gettext("No")+"					&nbsp; ("+gt.gettext("send this format as part of mailing")+")				</td>			</tr>		</table>	</div></div>	");},addEvents:function(){var ag=this;var ai,af;var ah;k(ag.cd,"mouseover",function(aj){ag.onMouseOver(aj);});k(ag.cd,"mousedown",function(aj){ag.onMouseDown(aj);});k(ag.cd,"mouseup",function(aj){ag.onMouseUp(aj);});k(ag.cd,"dblclick",function(aj){ag.onDoubleClick(aj);});k(ag.cd.body,"drop",function(aj){ag.onDrop(aj);});k(ag.cd.body,"cut",function(aj){ag.onCut(aj);});k(ag.cd,"keydown",function(aj){ai=true;if(aj.ctrlKey||aj.metaKey){s=true;clearTimeout(ah);ah=setTimeout(function(){s=false;},500);}ag.onKeyDown(aj);});k(ag.cd,"keyup",function(aj){ai=false;if(aj.ctrlKey||aj.metaKey){s=true;clearTimeout(ah);ah=setTimeout(function(){s=false;},500);}ag.onKeyUp(aj);if(af){ag.colorizeAll(true);af=false;}});m?k(ag.cd.body,"paste",function(aj){if(ai){af=true;return;}window.alert(gt.gettext("Please use Ctrl-v to paste content"));I(aj);}):L?k(ag.cd.body,"paste",function(aj){ag._paste(aj.clipboardData.getData("text/plain"));I(aj);}):k(ag.cd.body,"beforepaste",function(aj){ag.onBeforePaste();});},isEmpty:function(){return !this.cd.body.innerHTML.replace(/<br\/?>/gi,"");},insert:function(aj,am,ag){this.cw.focus();if(this.inHtmlEditor){y(this,aj);return;}if(o&&!am){E(this);}this.skipToTheEnd();var al=o&&!am;if(!am){var af=v(this);var ai=F(af,true);if(ai){var an=t(af,true);if(ai.tagName==="SPAN"||an.tagName==="SPAN"){al=true;if(!ag){var ak=j(this);if(o){z(ak,ai);}else{if(ai.tagName==="SPAN"){ae(ak,0,ai);var ah=u(ak).length;ae(ak,ai.innerHTML.length,ai);if(u(ak).length<ah){ae(ak,0,ai);}}if(an.tagName==="SPAN"){Z(ak,0,an);var ah=u(ak).length;Z(ak,1,an);if(u(ak).length<ah){Z(ak,0,an);}}}l(ak,af);}}}}y(this,aj);if(al){this.colorizeAll(true);ad(this);}},addTag:function(af,ag,ai,ah){if(!ai){E(this);if(!ah&&!this.confirmTagReplace()){return;}}af=af.replace(this.rxTagMarker,"");this.insert("<span "+(ag?'class="'+ag+'"':"")+">%%"+af+"%%</span>",ai);if(!ai){this.setStateLast();}},confirmTagReplace:function(){var ag=v(this);var af=F(ag,true);if(af&&af.tagName==="SPAN"){var ah=V(this,ag);if(ah&&ah!==af.innerHTML.length){return confirm(gt.gettext("Replace current tag?"));}}return true;},getP13nClassname:function(af){af=af.toUpperCase();var ag=ECM.Form.DCEditor.data("P13n");af=b(af);return !ag||af&&!d()&&(ag[1][af]||af.match(/^"/)&&af.match(/"$/)||af.match(/^'/)&&af.match(/'$/))?"p13n-good":"p13n-bad";},getDCClassname:function(af){af=af.toUpperCase();var ag=ECM.Form.DCEditor.data("DC");if(d()){var ah=this.rxEBM.exec(af);if(!ah){return"dc-bad";}af=ah[1];}return !ag||ag[0][af]?"dc-good":"dc-bad";},addTagP13n:function(af,ah,ag){this.addTag(af,this.getP13nClassname(af.toUpperCase()),ah,ag);},addTx:function(af){this.addTagP13n(af+"()",false,true);},addTagDC:function(af,aj,ak,ah){var ai=af.toUpperCase();if(ak==="lib"){var ag=ECM.Form.DCEditor.data("DC");if(ag[0][ai]&&!ag[0][ai][4]&&!confirm(gt.gettext("Dynamic Content tag")+' "'+af+'" '+gt.gettext("already exists in this mailing. Overwrite?"))){return;}ag[0][ai]=ag[1][ai];ag[0][ai][4]=true;}if(!aj&&d()){af+="[]";}this.addTag(af,this.getDCClassname(ai),aj,ah);},addSpecialLink:function(ar){this.cw.focus();E(this);if(this.format==="text"||!ar.match(/^http/)){this.insert(this.colorizeText(ar));}else{var aj=w(j(this));if(m&&F(v(this)).tagName==="BODY"||this.inHtmlEditor){this.cw.focus();this.insert(this.inHtmlEditor?'<a href="'+this.colorizeText(ar)+'">'+(aj||gt.gettext("click here"))+"</a>":'&lt;a href="'+this.colorizeText(ar)+'"&gt;'+(aj||gt.gettext("click here"))+"&lt;/a&gt;",true);
this.setStateLast();return;}T(this);this.cd.body.innerHTML=W(this.cd.body.innerHTML).replace(/<br\/?>/gi,"\1");X(this);var ai=v(this);if(o){var ao=j(this);var aj=u(ao);var ap=aj.match(/\1/g);if(ap){Z(ao,-1*ap.length);l(ao,ai);aj=w(ao);}}var an=F(ai);var ag=V(this,ai);var aq=0;var aw=S(an);if(o){aw=aw.replace(/&lt;/gi,"<").replace(/&gt;/gi,">").replace(/&(?:amp;)?nbsp;/gi,"\2").replace(/&amp;/gi,"\3");}var au=aw.substr(0,ag);if(!n(au)){aq=1;}else{if(!au.match(/href="/)){var al,ak=0,af=ag;for(al=aw.charAt(ag);al&&al!==">"&&!(ak%2);al=aw.charAt(++ag)){if(al==='"'){ak++;}}if(al){au=aw.substr(0,ag);}else{ag=af;}}var ah=RegExp(/(.*<a[^>]*href=")([^"]*"?)/i);var at=au.replace(ah,"$1"+ar+'"');var am=ah.exec(au);if(am){if(am[2].charAt(am[2].length-1)!=='"'){ag--;while(aw.charAt(++ag)&&aw.charAt(ag)!=='"'){}ag++;}else{if(ar===am[2]){aq=2;}}}else{if(au===at){aq=1;}}}if(!aq){var av=at+aw.substr(ag);U(this);if(o){an.innerHTML=av.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\3/gi,"&amp;").replace(/\2/g,"&nbsp;");}else{an.nodeValue=av;}Y(this);}else{if(aq===1){this.insert(this.inHtmlEditor?'<a href="'+ar+'">'+(aj||gt.gettext("click here"))+"</a>":'&lt;a href="'+ar+'"&gt;'+(aj||gt.gettext("click here"))+"&lt;/a&gt;",true);}}T(this);this.cd.body.innerHTML=this.cd.body.innerHTML.replace(/\1/g,"<br>");this.colorizeAll(true,true);X(this);}this.setStateLast();ad(this);},addContent:function(ai,ah,ag,af){if(ai===undefined||ai===null){ai="";}if(!this.initialized){this.content=ai;return;}ai=this.colorizeText(this._wrapText(ai,ah));ag?this.insert(ai):this.cd.body.innerHTML=ai;af?this.setStateFirst():this.setStateLast();A(this);if(o){this.selLast2=[0,0];Y(this);ad(this);}},getContent:function(){return x(this._contentLast===undefined?this.cd&&this.cd.body?this.cd.body.innerHTML:this.getStateLast():this._contentLast);},setCursorNext:function(af){var ak=v(this);var aj=F(ak);if(aj.tagName==="BODY"){return;}if(aj.parentNode.tagName==="SPAN"){aj=aj.parentNode;}var ai=af?aj.previousSibling:aj.nextSibling;if(!aj.tagName&&!ai){return;}var ah;if(o||!ai){ai=this.cd.createElement("div");ai.innerHTML="\1";af?this.cd.body.insertBefore(ai,aj):aj.nextSibling?this.cd.body.insertBefore(ai,aj.nextSibling):this.cd.body.appendChild(ai);ah=true;}var ag=aa(this);z(ag,ai);if(!ah){ag.collapse(!af);}l(ag,ak);},moveCursor:function(ai,ah){var ag=v(this);if(!ah){ah=F(ag);}if(ai<0){ai=R(ah)+ai;}var af=aa(this);z(af,ah);ae(af,V(this,ag)+ai,ah);af.collapse(true);l(af,ag);},onMouseOver:function(ah){var ag=a(ah);if(this.noDoubleClickProtip||ag.tagName!=="SPAN"||ag.className==="p13n-bad"){return;}this.eLast=[ah.clientX,ah.clientY];if(this.toolTime){return;}if(!this._tooltip||ag!==this.mouseOverLast||!this._tooltip.isVisible()){var af=this;af.toolTime=setTimeout(function(){af.showTooltip("Double-click to edit",af.eLast[0],af.eLast[1]);delete af.toolTime;delete af.eLast;},900);}this.mouseOverLast=ag;},onMouseDown:function(af){Q(this);},onMouseUp:function(af){ad(this);},onDoubleClick:function(ag){var af=a(ag);if(af.tagName!=="SPAN"){return;}var ah=af.innerHTML.replace(this.rxTagMarker,"");switch(af.className){case ("dc-good"):this.pwEditDC(ah,false);break;case ("dc-bad"):this.pwEditDC(ah,true);break;case ("p13n-good"):this.pwEditP13n(ah);break;}},isModifierKey:function(ag){var af=ag.keyCode;if(s&&af!==88||ag.altKey){return;}return(af>47&&af<58||af>64&&af<91||this._modifierKeys[af]);},_modifierKeys:{0:1,8:1,13:1,32:1,46:1,59:1,61:1,106:1,107:1,109:1,111:1,188:1,190:1,191:1,192:1,219:1,220:1,221:1,222:1},skipToTheEnd:function(af){var ah=v(this);var ag=F(ah,true);if(!ag||ag.tagName!=="SPAN"||!M(j(this))){return;}var ai=V(this,ah);if(ai===0&&af!==8&&af!==46){this.setCursorNext(true);return;}if(ai===ag.innerHTML.length&&af!==8){this.setCursorNext();}},setStateFirst:function(){this.stateStack=[[this.cd.body.innerHTML,0]];this.statePtr=0;},setStateLast:function(){if(!this.stateStack||this.inHtmlEditor){return;}clearTimeout(this.undoBuf);U(this);this.stateStack[++this.statePtr]=[this.cd.body.innerHTML,this.selLast2];if(this.stateStack[this.statePtr+1]){this.stateStack.splice(this.statePtr+1,this.stateStack.length-(this.statePtr+1));}},restoreState:function(af){if(!this.stateStack[this.statePtr+af]){return;}this.statePtr+=af;if(this.cd.body.innerHTML===this.stateStack[this.statePtr][0]){return this.restoreState(af);}this.cd.body.innerHTML=this.stateStack[this.statePtr][0];this.selLast2=this.stateStack[this.statePtr+(af===-1?1:0)][1];Y(this);A(this);},getStateLast:function(){return this.stateStack&&this.stateStack[this.statePtr]?this.stateStack[this.statePtr][0]:"";},onKeyDown:function(ag){var af=ag.keyCode;if(s){if(af===90&&ag.shiftKey||af===89){this.restoreState(1);I(ag);return;}else{if(af===90){this.restoreState(-1);I(ag);return;}}}if(m&&(af===86&&s||af===45&&ag.shiftKey)){this.onBeforePaste();return;}if(o||!this.isModifierKey(ag)){return;}this.skipToTheEnd(ag.keyCode);},onKeyUp:function(al){var ah=al.keyCode;if(s&&ah===88){return;}if(ah>=33&&ah<=40){ad(this);}var aj=!this.isModifierKey(al);if(aj&&!s){Q(this);return;}var ao=this;clearTimeout(this.undoBuf);this.undoBuf=setTimeout(function(){ao.setStateLast();},222);if(aj){Q(this);return;}if(o){if(s){return;}var ak=j(this);var am=ak.offsetTop;if(ah===13){ak.select();ak.moveStart("character",-1);ak.pasteHTML("<br>");am=ak.offsetTop;}this.colorizeAll();Q(this);if(ah!==13){var an=5;var ai=j(this);while(ai.offsetTop-am>1&&an--){ai.move("character",-1);ai.select();}}}else{if(m){if(ah===32){var af=v(this);var ag=F(af);if(S(ag)===" "){var ai=j(this);z(ai,ag);l(ai,af);y(this,"&nbsp;");}}}this.colorizeSelected(al);}ad(this);},onDrop:function(ag){var af=this;P(function(){af.colorizeAll(true);Q(af);af.setStateLast();});},onCut:function(ag){var af=this;P(function(){af.setStateLast();af.colorizeSelected(ag,true);});},onBeforePaste:function(){var af=this;var ag=$("pastebox");if(!ag){ag=document.createElement("textarea");ag.id="pastebox";ag.style.position="absolute";ag.style.border="none";ag.style.width=ag.style.height="1px";document.body.appendChild(ag);}if(ECM.Form.DCEditor._pasteLast){c(ag,"paste",ECM.Form.DCEditor._pasteLast);}k(ag,"paste",ECM.Form.DCEditor._pasteLast=function(){af.onPaste();});ag.style.top=document.body.scrollTop+"px";ag.value="";ad(af);ag.focus();},onPaste:function(){var af=this;var ag=$("pastebox");if(!ag){return;}P(function(){af._paste(ag.value);});},_paste:function(af){this.insert(this.colorizeText(D(af.replace(/&(amp;)/gi,"&amp;$1"))),false,true);this.setStateLast();},mergeTextNodes:function(ah,af,aj){var ai=ah.nodeValue.length;ah.nodeValue+=af.nodeValue;af.parentNode.removeChild(af);var ag=aa(this);z(ag,ah);ae(ag,ai+(aj?1:0),ah);ag.collapse(true);l(ag,v(this));},colorizeSelected:function(al,ap){var ai=al.keyCode;var ak=ap||ai===8;var aj=ai===46;var af=v(this);var ah=F(af);if(m){if(ah&&!ah.tagName){if(ah.nextSibling&&!ah.nextSibling.tagName){this.mergeTextNodes(ah,ah.nextSibling);return this.colorizeSelected(al,ap);}if(ah.previousSibling&&!ah.previousSibling.tagName){this.mergeTextNodes(ah.previousSibling,ah,true);return this.colorizeSelected(al,ap);}}if(aj&&ah.tagName==="BODY"&&!this.cd.body.lastChild.tagName){var am=S(this.cd.body.lastChild);if(am.match(/<\/?span.*?>/gi)){var ag=aa(this);z(ag,this.cd.body.lastChild);l(ag,af);y(this,am.replace(/<\/?span.*?>/gi,""));return;}}if(ah.tagName==="HTML"){this.moveCursor(-1,this.cd.body.lastChild);return;}if(ah.tagName==="BODY"){this.colorizeAll(true);return;}}if(!ah){return;}if(m&&(ak||aj)){if(ak&&ah.nextSibling&&ah.nextSibling.tagName==="SPAN"){ah=ah.nextSibling;}else{if(ah.previousSibling&&ah.previousSibling.tagName==="SPAN"){ah=ah.previousSibling;}}}var ao;if(ah.tagName==="SPAN"){ao=ah;ah=ao.firstChild;if(!ah){ac(this,ao);return;}}else{ao=ah.parentNode;}if(!ao){return;}var an=S(ah);if(ao.tagName!=="SPAN"){return this.colorizeNode(ah,af,an,true);}if(!this.rxTag.exec(an)||this.rxTagInTag.exec(an)){an=ao.innerHTML;U(this);ao.parentNode.removeChild(ao);if(L){E(this);}y(this,an);Y(this);if(!ak&&!aj){this.colorizeSelected(al,ap);
}return;}if(ao.innerHTML===""){ac(this,ao);}an=an.replace(this.rxTagMarker,"");ao.className=an.match(/^d_/i)?this.getDCClassname(an):this.getP13nClassname(an);},recolorizeDCTag:function(af,ag){var ah=RegExp(d()?"%%"+af+"\\[.+\\]%%":"%%"+af+"%%","i");for(var ai=this.cd.body.firstChild;ai;ai=ai.nextSibling){if(ai.tagName==="SPAN"&&ah.exec(ai.innerHTML)){ai.className=ag;}}},renameDCTag:function(af,ai,ah){var aj=RegExp(d()?"%%"+af+"(\\[.+\\]%%)":"%%"+af+"(%%)","i");for(var ak=this.cd.body.firstChild;ak;ak=ak.nextSibling){if(ak.tagName==="SPAN"){var ag=aj.exec(ak.innerHTML);if(ag){ak.innerHTML="%%"+ai+ag[1];ak.className=ah;}}}},colorizeText:function(ai){var af,ag=[],ah=0;ai=ai.replace(/<span id="?ieCursor"?>.<\/span>/i,"\1");while(af=this.rxTag2.exec(ai)){ag.push(ai.substring(ah,af.index),'<span class="'+(af[1].match(/^d_/i)?this.getDCClassname(af[1]):this.getP13nClassname(af[1]))+'">'+af[0]+"</span>");ah=af.index+af[0].length;}if(ag.length){if(ah<ai.length){ag.push(ai.substring(ah,ai.length));}ai=ag.join("");}return ai.replace("\1",'<span id="ieCursor">.</span>');},colorizeAll:function(ah,aj){if(this.inHtmlEditor){return;}if(!aj){T(this);}var ag;if(ah||o){var ai=W(this.cd.body.innerHTML);if(ai!==this.cd.body.innerHTML){this.cd.body.innerHTML=ai;}}var af=this.colorizeText(this.cd.body.innerHTML);if(af!==this.cd.body.innerHTML){this.cd.body.innerHTML=af;}if(!aj){X(this);}},colorizeNode:function(aj,ag,am,ah){if(!am){return;}var ak=am.search(this.rxTag2);if(ak<0){return;}var an=RegExp.$1;if(o){var af=am.substr(ak+an.length+4);ak+=af.length-am.length-O(af);}var al;if(ah){al=V(this,ag);}var ai=aa(this);z(ai,aj);ae(ai,ak,aj);Z(ai,ak+an.length+4,aj);l(ai,ag);if(!o){h(ag);}an.match(/^d_/i)?this.addTagDC(an,true):this.addTagP13n(an,true);if(ah){ag=v(this);aj=F(ag);z(ai,aj);ae(ai,al-ak,aj);ai.collapse(true);l(ai,ag);}return true;},expand:function(af){var ag=this.ed.parentNode;var ah=$("DCEditorRuler"+this.id);if(ag.style.width==="54.5em"){af.innerHTML="Collapse";ag.style.width="84.2em";this.ed.style.height="50em";if(ah){ah.innerHTML="1-------10--------20--------30--------40--------50--------60--------70--------80--------90-------100-------110-------120-----";}}else{af.innerHTML="Expand";ag.style.width="54.5em";this.ed.style.height="30em";if(ah){ah.innerHTML="1-------10--------20--------30--------40--------50--------60--------70--------80";}}},wrap:function(ag){var af=Ext.isIE?this.colorizeText(this._wrapText(this.cd.body.innerText,ag)):this.colorizeText(this._wrapText(this.cd.body.textContent,ag));if(af===this.cd.body.innerHTML){return;}this.cd.body.innerHTML=af;this.setStateLast();},_wrapText:function(ao,aq,an){aq=parseInt(aq);if(!aq){return D(ao,an);}this._lastWrapBound=aq;ao=ab(ao);var ap="";var ah,ak;var ai=0,ag=-1,af="";for(var aj=0,am=ao.length-1;aj<am;aj++){var al=ao.charAt(aj);af+=al;ai++;if(al==="%"){if(ak){ah=!ah;ak=false;}else{ak=true;}}else{ak=false;}if(ah){continue;}if(al===" "||al==="\t"||al==="\n"){ag=ai;}if(ai>aq&&ag>=0||al==="\n"){ap+=af.substr(0,ag-1)+"\n";af=af.substr(ag);ai=af.length;ag=-1;}}return D(ap+af+ao.charAt(ao.length-1),an);},_lastWrapBound:"",switchHtmlEditor:function(af){var ag=this;J(Ext.isIE10p?"/js/editor/CKEditor4/ckeditor.js":"/js/editor/CKEditor/ckeditor.js",function(){var ai=ag.cw,am=ag.cd;var ao,aj;var an,ah=RegExp(/^.*?&lt;body.*?&gt;/i);var ak,al=RegExp(/&lt;\/body&gt;.*$/i);ag.switchHtmlEditor=function(ap){if(ag.ed.style.display==="none"){if(ap){if(ap.setText){ap.setText("HTML Editor");$("DCEditorMenuPreview").style.display="inline";}else{ap.innerHTML="HTML Editor";}}ag.cd=am;ag.cw=ai;ag.ed.style.display="block";delete ag.inHtmlEditor;if(aj.checkDirty()){ag.addContent(((an?an[0].replace(/<br>/gi,"\n"):"")+aj.getData().replace(/&quot;/gi,'"')+(ak?ak[0].replace(/<br>/gi,"\n"):"")).replace(/\n(&nbsp;|\n|\s)+/g,"\n").replace(/<br \/>/g,"<br>").replace(/&lt;/gi,"<").replace(/&gt;/gi,">"));}var at=$("DCEditorMenuHtmlExpand"+ag.id);if(at){at.style.display="inline";}ao.style.display="none";}else{ag.setStateLast();if(ap){if(ap.setText){ap.setText(gt.gettext("Standard Editor"));$("DCEditorMenuPreview").style.display="none";}else{ap.innerHTML=gt.gettext("Standard Editor");}}var ar=ag.cd.body.innerHTML;var aq=x(ar).replace(/<!--[^\1]*?-->/gi,"").replace(/<\/?meta[^\1]*?>/gi,"").replace(/<\/?link[^\1]*?>/gi,"").replace(/<style>\s*<\/style>/gi,"");if(an=ah.exec(ar)){ak=al.exec(ar);}if(aj){ao.style.display="block";ag.inHtmlEditor=true;ag.cw=aj.window.$;ag.cd=aj.document.$;H(ag,function(){ag.cd.body.innerHTML=aq;aj.resetDirty();});}else{ao=document.createElement("div");ao.className="ed-iframe-ck";ag.ed.parentNode.insertBefore(ao,ag.ed);aj=CKEDITOR.appendTo(ao);aj.on("instanceReady",function(){ag.inHtmlEditor=true;ag.cw=aj.window.$;ag.cd=aj.document.$;H(ag,function(){ag.cd.body.innerHTML=aq;aj.resetDirty();});});}var at=$("DCEditorMenuHtmlExpand"+ag.id);if(at){at.style.display="none";}ag.ed.style.display="none";}};ag.switchHtmlEditor(af);});},switchOutOfHtmlEditor:function(){if(!this.inHtmlEditor){return;}var af=$("DCEditorMenuHtml");this.switchHtmlEditor(af?af.getElementsByTagName("button")[0]:undefined);},previewHtml:function(ah){var ag=this;var ai=$("DCEditorTriplePlayBar"+ah);ai.style.display="none";var aj="DCEditorTriplePlayClosePreview"+ah;var af=$(aj);if(!af){af=document.createElement("div");af.id=aj;af.className="bluebox";af.innerHTML='			<table style="float:right">				<tr><td>					<div id="DCEditorTriplePlayClosePreviewBtn'+ah+'"></div>				</td></tr>			</table>			<div style="clear:right">';ai.parentNode.insertBefore(af,ai);new Ext.Button({renderTo:"DCEditorTriplePlayClosePreviewBtn"+ah,cls:"blue_button",text:"Close Preview",listeners:{click:function(){ag.closePreviewHtml(ah);}}});}af.style.display="block";ag._contentLast=ag.cd.body.innerHTML;ag.cd.designMode="Off";H(ag,function(){ag.cd.body.style.whiteSpace="normal";ag.cd.body.innerHTML=ab(ag._contentLast).replace(/<a /g,'<a target="_blank" ');});},closePreviewHtml:function(ai,ah){var ag=this;var af=$("DCEditorTriplePlayClosePreview"+ai);if(!af){if(ah){H(ag,function(){ah.call(ag);});}return;}af.style.display="none";$("DCEditorTriplePlayBar"+ai).style.display="block";ag.cd.designMode="On";H(ag,function(){ag.cd.body.setAttribute("style","white-space:pre-wrap");if(ah){ah.call(ag);}else{ag.cd.body.innerHTML=ag._contentLast;}delete ag._contentLast;});},showMenuWrapText:function(ai){var ag=this;var ak="DCEditorMenuWrapText"+this.id;var af=$(ak),aj=$(ak+"_m");if(!af){af=$("DCEditorMenuWrapText");}else{af.className="menu-btn-active";}if(aj){if(aj.style.display==="block"){return this.hideMenu("WrapText");}}else{aj=document.createElement("div");aj.id=ak+"_m";aj.className="pmenu";aj.style.padding="5px";aj.innerHTML='			<div style="padding:0 0 3px 0;height:20px;"><span style="float:left;line-height:18px;" class="bold">'+gt.gettext("Characters")+'</span> <input style="float:right" id="DCEditorWrapIn'+this.id+'" size="2" value="'+(this._lastWrapBound||72)+'"/></div>			<div style="clear:both;padding:0 0 5px 0;"><input style="position:relative;top:3px;" id="DCEditorWrapCk'+this.id+'" type="checkbox"> <span style="line-height:18px;">'+gt.gettext("Wrap for all rules")+'</span></div>			<div id="DCEditorMenuWrapTextWrap'+this.id+'" class="pmenu_nohover" style="float:right; padding:0;"></div>';aj.style.top=(af.childNodes[0].childNodes[0].offsetHeight+7)+"px";af.parentNode.insertBefore(aj,af.nextSibling);new Ext.Button({renderTo:"DCEditorMenuWrapTextWrap"+ag.id,cls:"blue_button",text:"Wrap",listeners:{click:function(){var al=$("DCEditorWrapIn"+ag.id).value;ECM.Form.DCEditor.instances[ag.id].wrap(al);if(ai&&$("DCEditorWrapCk"+ag.id).checked){ai.call(ag,al);}ag.hideMenu("WrapText");}}});}aj.style.display="block";var ah=1;k(document.body,"click",this._fnMenuWrapText=function(am){if(ah--){return;}var al=a(am);while(al.className!=="pmenu"&&(al=al.parentNode)){}if(!al){ag.hideMenu("WrapText");}});k(ag.cd.body,"click",this._fnMenu2WrapText=function(al){ag.hideMenu("WrapText");});},showMenuInsert:function(aj){var ak="DCEditorMenuInsert"+this.id;
var af=$(ak),ai=$(ak+"_m");if(!af){af=$("DCEditorMenuInsert");}else{af.className="menu-btn-active";}if(ai){if(ai.style.display==="block"){return this.hideMenu("Insert");}}else{ai=document.createElement("div");ai.id=ak+"_m";ai.className="pmenu pinsert bold";ai.style.top=(af.offsetHeight+(aj||0))+"px";af.parentNode.insertBefore(ai,af.nextSibling);}ECM.Form.DCEditor.markDCFormats(this.id);this.fillMenuInsert(ai,af);ai.style.display="block";var ag=this,ah=1;k(document.body,"click",this._fnMenuInsert=function(al){if(ah--<=0&&al.target&&al.target.className!=="menu-disabled"){ag.hideMenu("Insert");}});k(ag.cd.body,"click",this._fnMenu2Insert=function(al){ag.hideMenu("Insert");});},fillMenuInsert:function(ah,af){if(!ah){return;}var ag=this;ECM.Form.DCEditor.getData("DC",function(ak){var ap="ECM.Form.DCEditor.instances["+ag.id+"]";var aj=[],an="";if(!ag.hideDCMenu){var ai=[];for(var am in ak[0]){ai.push(am);}ai=ai.sort();if(ai.length>ag.INSERT_MENU_LIMIT){ai.splice(ag.INSERT_MENU_LIMIT,ai.length-ag.INSERT_MENU_LIMIT);an='<div class="italic" onclick="'+ap+'.pwInsertDC_Mailing()">'+gt.gettext("More")+"</div>";}for(var am=0,al=ai.length;am<al;am++){aj.push('<div class="italic" onclick="'+ap+".addTagDC('"+ak[0][ai[am]][0]+"', false, 'mailing')\">"+ak[0][ai[am]][0]+" <span>("+ak[0][ai[am]][3].join(",")+")</span></div>");}}var ao='<hr class="menu-disabled" />';ah.innerHTML=(ag.hidePersonalizationMenu?"":'<div onclick="'+ap+'.pwInsertP13n(this)">'+gt.gettext("Personalization")+"</div>")+'<div onclick="'+ap+'.pwInsertTx(this)">Data Transformation</div>'+ao+'<div onclick="'+ap+'.pwInsertLink(this)">Special Link</div>'+(ag.hideDCMenu?"":ao+'<div class="menu-disabled">'+gt.gettext("Dynamic Content")+"</div><span>"+(ag.hideDCNew?"":'<div style="margin-bottom:2px" onclick="'+ap+'.pwEditDC()">'+gt.gettext("New")+"</div>")+aj.join("")+an+'	<div style="margin-top:2px" onclick="'+ap+'.pwInsertDC_Lib(this)">'+gt.gettext("Library")+"</div></span>");});},hideMenu:function(ag){var ai="DCEditorMenu"+ag+this.id;var af=$(ai),ah=$(ai+"_m");if(!af){af=$("DCEditorMenu"+ag);}else{af.className="menu-btn";}if(ah){ah.style.display="none";}if(this["_fnMenu"+ag]){c(document.body,"click",this["_fnMenu"+ag]);delete this["_fnMenu"+ag];}if(this["_fnMenu2"+ag]){c(this.cd.body,"click",this["_fnMenu2"+ag]);delete this["_fnMenu2"+ag];}},showTooltip:function(ag,af,ai){if(!this._tooltip){this._tooltip=new Ext.ToolTip({dismissDelay:1800,title:ag,cls:"x-tip-nowrap"});}this._tooltip.setTitle(ag);for(var ah=this.ed;ah;ah=ah.offsetParent){af+=ah.offsetLeft;ai+=ah.offsetTop;}this._tooltip.showAt([af+5,ai+5]);},pwEditDC:function(af,ai){if(this.hideDCNew){return;}try{this.cd.body.style.cursor="wait";E(this);var am={};if(af){if(d()){var al=this.rxEBM.exec(af);if(al){af=al[1];am.key=al[2];}else{am.key="KEY";af=af.replace("[]","");}}am.id=af.replace(/^d_/i,"");var ag=ECM.Form.DCEditor.data("DC");var ak="D_"+am.id.toUpperCase();if(d()){ai=!ag[0][ak];}if(ai){am.isAmbivalent=true;}else{if(ag[0][ak][4]){am.useLibrary=true;}}}else{if(!this.confirmTagReplace()){return;}if(d()){am.key="KEY";}}var ah=this;am.onClose=function(an){ah.cd.body.style.cursor="";if(!an){return;}an.tagOrig=af;ECM.Form.DCEditor.onDCModalClose(an);if(!af){ah.addTagDC(an.identity||af,false,"mailing",true);}ECM.Form.DCEditor.markDCFormats(0);};if(this.rulesCall){this.rulesCall(am);}else{ECM.require("ECM.Rules.DynamicContent");am.dcid=-1;am.desiredAid=ECM.Tablespace.get("aid");am.mid=ECM.Tablespace.get("mid");am.mailingType=ECM.Tablespace.get("mtype");am.mfid=ECM.Tablespace.get("mfid");ECM.Rules.DynamicContent[af?"modify":"create"](am);}}catch(aj){this.cd.body.style.cursor="";}},pwEditP13n:function(af,ai){var ag=this;af=b(af);var aj=ECM.Form.DCEditor.data("P13n");var ah=aj[1][af]?af:af.toUpperCase();G({title:"Personalization",msg:(ai?'<span class="error">'+gt.gettext("Error")+": "+ai+'</span><br style="margin-bottom:7px"/>':"")+gt.gettext("Set the default value for")+' <span class="mono">'+af+"</span>",buttons:{ok:gt.gettext("Submit")},prompt:true,value:aj[1][ah][3],fn:function(ak,al){if(ak!=="ok"){return;}ECM.Ajax.request({url:ECM.Form.DCEditor.url("setP13nDefault"),method:"GET",params:{tag:af,value:al},success:function(am,an){if(!am.responseJSON.data.success){ag.pwEditP13n(af,gt.gettext("Invalid input"));return;}aj[1][ah][3]=al;},failure:function(am,an){ag.pwEditP13n(af,gt.gettext("Invalid input"));}});}});},pwGrid:function(ah,aj,ag){var af=this;var ai=function(ak){af.hideMenu("Insert");ak.dom.innerHTML=ag||"";af["get"+ah+"Grid"].call(af).render(ak.dom);};aj.listeners={resize:function(am,al){var ak=af[ah+"Grid"];if(!ak){return;}ak.setWidth(al-22);}};if(ECM.Form.DCEditor.data(ah)){aj.listeners.afterRender=function(){ai(this.getLayoutTarget());};}else{aj.autoLoad={url:ECM.Form.DCEditor.url(ah,true),method:"GET",callback:function(am,ao,al){try{if(ah=="Link"){var ak=af.transformLinkData(ECM.Adapter.decode(al.responseText||"").data.data);ECM.Form.DCEditor.data(ah,ak);}else{ECM.Form.DCEditor.data(ah,ECM.Adapter.decode(al.responseText||"").data);}ai(am||N.getLayoutTarget());setTimeout(function(){af[ah+"Grid"].syncSize();},333);}catch(an){}}};}g(aj);},formGrid:function(ah,aj,ag){var af=this;var ai=function(ak){af.hideMenu("Insert");ak.dom.innerHTML=ag||"";af["get"+ah+"Grid"](ak.dom);};aj.listeners={resize:function(am,al){var ak=af[ah+"Grid"];if(!ak){return;}ak.setWidth(al-22);}};aj.listeners.afterRender=function(){ai(this.getLayoutTarget());};g(aj);},getGrid:function(ag,af){af.autoWidth=true;af.autoHeight=true;af.scrollOffset=0;af.scroll=true;af.enableHdMenu=false;af.enableColumnMove=false;af.stripeRows=true;af.bodyCssClass="hand";af.viewConfig={forceFit:true};af.listeners.destroy=function(){delete self[ag+"Grid"];};return this[ag+"Grid"]=new Ext.grid.GridPanel(af);},getP13nGrid:function(){var af=this;return af.getGrid("P13n",{store:new Ext.data.ArrayStore({fields:[{name:"fieldName",sortType:Ext.data.SortTypes.asUCString},{name:"insertValue"}],sortInfo:{field:"fieldName",direction:"ASC"},data:af.getP13nArr(ECM.Form.DCEditor.data("P13n"))}),columns:[{dataIndex:"fieldName",header:gt.gettext("Field Name")+" <input onfocus=\"if(this.className==='tr-search grey italic'){this.value='';this.className='tr-search'}\" onblur=\"if(this.value===''){this.value='Search';this.className='tr-search grey italic'}\" class=\"tr-search grey italic\" onkeyup=\"ECM.Form.DCEditor.instances["+af.id+"].P13nGrid.getStore().filter('fieldName', RegExp(this.value, 'i'), true)\" value=\"Search\" id=\"DCEditorP13nSearch"+af.id+'"/>'},{dataIndex:"insertValue",header:gt.gettext("Insert Value")}],listeners:{click:{fn:function(ai){var ah=ai.getTarget();while(ah&&ah.tagName!=="TR"){ah=ah.parentNode;}if(ah&&!ah.className.match(/\bhd-row\b/)){var ag=ah.childNodes[1].childNodes[0].innerHTML;p();af.addTagP13n(ag.replace(af.rxTagMarker,""),false,true);}}}}});},getTxGrid:function(){var ag=this;var af=ag.getGrid("Tx",{store:new Ext.data.ArrayStore({fields:[{name:"fieldName",sortType:Ext.data.SortTypes.asUCString},{name:"insertValue"}],sortInfo:{field:"fieldName",direction:"ASC"},data:ag.getTxArr(ECM.Form.DCEditor.data("Tx"))}),columns:[{dataIndex:"fieldName",header:gt.gettext("Data Transformation")+" <input onfocus=\"if(this.className==='tr-search grey italic'){this.value='';this.className='tr-search'}\" onblur=\"if(this.value===''){this.value='Search';this.className='tr-search grey italic'}\" class=\"tr-search grey italic\" onkeyup=\"ECM.Form.DCEditor.instances["+ag.id+'].TxGrid.getStore().filter(\'fieldName\', this.value, true, false, false)" value="Search" style="left:11em" id="DCEditorTxSearch'+ag.id+'"/>'},{dataIndex:"insertValue",header:gt.gettext("Insert Value")}],listeners:{click:{fn:function(aj){var ai=aj.getTarget();while(ai&&ai.tagName!=="TR"){ai=ai.parentNode;}if(ai&&!ai.className.match(/\bhd-row\b/)){var ah=ai.childNodes[1].childNodes[0].innerHTML;p();ag.addTx(ah.replace(ag.rxTagMarker,"").replace(/\(.*/,""));}}}}});return af;},getLinkGrid:function(){var af=this;return af.getGrid("Link",{store:new Ext.data.ArrayStore({fields:[{name:"type"},{name:"name"},{name:"url"}],data:ECM.Form.DCEditor.data("Link")}),columns:[{dataIndex:"type",header:gt.gettext("Link Type"),width:140},{dataIndex:"name",header:gt.gettext("Name"),width:210},{dataIndex:"url",header:gt.gettext("URL"),width:300,renderer:function(ag){return"<span"+(ag?' ext:qtip="'+ag+'"/>':">")+ag+"</span>";
}}],listeners:{click:{fn:function(al){var ak=al.getTarget();while(ak&&ak.tagName!=="TR"){ak=ak.parentNode;}var ag=ak.childNodes[2].childNodes[0].innerHTML;var ah=true;var aj=/\(([^\]]+)\)%%"/;var am=aj.exec(ag);if(am){p();var ai=/\>([^\]]+)\</.exec(ag);if(ai[1]==="%%t_fblike_url(url,text)%%"){ah=false;af.pwFBLikeLink(ai[1]);}}if(ah){if(ak&&!ak.className.match(/\bhd-row\b/)){p();af.addSpecialLink(ag.replace(/<.*?>/g,"").replace(/&amp;/gi,"&"));}}}}}});},getFBLikeGrid:function(ah){var af=this;Ext.QuickTips.init();var ag=new Ext.FormPanel({name:"fbLike",id:"fbLike",renderTo:ah,autoHeight:true,width:550,layout:"form",defaults:{border:0},border:false,monitorValid:true,items:[new Ext.form.TextField({fieldLabel:gt.gettext("Description of URL"),id:"desc",name:"desc",width:350,labelStyle:"width:120; font-size:11px;",emptyText:gt.gettext("Enter Description of URL"),maxLength:50,maxLengthText:gt.gettext("Invalid text parameter - must contain no more than 50 characters")}),new Ext.form.TextField({fieldLabel:gt.gettext("URL to Like"),id:"url",name:"url",width:350,allowBlank:false,labelStyle:"width:120; font-size:11px;",blankText:gt.gettext("Please enter a valid URL."),vtype:"url",vtypeText:gt.gettext("This is not a valid url. Please make sure you have entered a valid URL."),emptyText:gt.gettext("Enter URL to Like")})],buttons:[{text:"Insert",align:"right",width:"50px",minButtonWidth:100,formBind:true,handler:function(){if(ag.getForm().isValid()){var ak=ag.findById("url").getValue();var al=ag.findById("desc").getValue();al=al?al:ak.substring(0,30);var ai=document.getElementById("t_fblike_url").innerHTML;var aj=/\(([^\]]+)\)/;var am='("'+ak+'","'+al+'")';ai=ai.replace(aj,am);p();af.addSpecialLink(ai.replace(/<.*?>/g,"").replace(/&amp;/gi,"&"));}else{Ext.MessageBox.alert(gt.gettext("Failure"),gt.gettext("Fail to insert"));}}}]});return ag;},getDC_LibGrid:function(){var af=this;return af.getGrid("DC_Lib",{store:new Ext.data.ArrayStore({fields:[{name:"fieldName",sortType:Ext.data.SortTypes.asUCString},{name:"description"}],sortInfo:{field:"fieldName",direction:"ASC"},data:af.getDCArr(ECM.Form.DCEditor.data("DC"),"lib")}),columns:[{dataIndex:"fieldName",header:gt.gettext("Name")+" <input onfocus=\"if(this.className==='tr-search grey italic'){this.value='';this.className='tr-search'}\" onblur=\"if(this.value===''){this.value='Search';this.className='tr-search grey italic'}\" class=\"tr-search grey italic\" onkeyup=\"ECM.Form.DCEditor.instances["+af.id+"].DC_LibGrid.getStore().filter('fieldName', RegExp(this.value, 'i'), true)\" value=\"Search\"/>"},{dataIndex:"description",header:gt.gettext("Description")}],listeners:{click:{fn:function(ai){var ah=ai.getTarget();while(ah&&ah.tagName!=="TR"){ah=ah.parentNode;}if(ah&&!ah.className.match(/\bhd-row\b/)){var ag=ah.childNodes[0].childNodes[0].innerHTML;p();af.addTagDC(ag,false,"lib",true);}}}}});},getDC_MailingGrid:function(){var af=this;return af.getGrid("DC_Mailing",{store:new Ext.data.ArrayStore({fields:[{name:"fieldName",sortType:Ext.data.SortTypes.asUCString}],sortInfo:{field:"fieldName",direction:"ASC"},data:af.getDCArr(ECM.Form.DCEditor.data("DC"),"mailing")}),columns:[{dataIndex:"fieldName",header:gt.gettext("Tag")}],listeners:{click:{fn:function(ai){var ah=ai.getTarget();while(ah&&ah.tagName!=="TR"){ah=ah.parentNode;}if(ah&&!ah.className.match(/\bhd-row\b/)){var ag=ah.childNodes[0].childNodes[0].innerHTML;p();af.addTagDC(ag.replace(/ \(.*/,""),false,"mailing",true);}}}}});},pwInsertP13n:function(af){if(!this.confirmTagReplace()){return;}var ag=['<div class="dc_insert_modal">',"<span>",gt.gettext("Select a Personalization Field below to insert"),"</span>",'<div id="DCEditorP13nSelector'+this.id+'">',this.getP13nSelectorHtml(),"</div>","</div>"].join("");this.pwGrid("P13n",{title:gt.gettext("Insert Personalization"),width:600,height:350,animateTarget:af,cls:"personalization-panel"},ag);},pwInsertTx:function(ag){var af=['<div class="dc_insert_modal">','<span style="display:inline; float:left">',gt.gettext("Select a Data Transformation below to insert"),"</span>",'<span style="display:inline; float:right">','<a href="javascript:cmHelp(\'FLARE_FIELD_TRANSFORMATIONS\')" class="ahelp">',gt.gettext("Help"),"</a>","</span>",'<div style="clear:both">',"</div>"].join("");this.pwGrid("Tx",{title:gt.gettext("Insert Data Transformation"),width:600,height:350,animateTarget:ag,cls:"personalization-panel"},af);},pwInsertLink:function(af){var ag=['<div class="dc_insert_modal">',"<span>",gt.gettext("Select a Special Link below to insert"),"</span>","</div>"].join("");this.pwGrid("Link",{title:gt.gettext("Insert Special Link"),width:600,height:350,animateTarget:af,cls:"dc-insert-panel"},ag);},pwFBLikeLink:function(af){this.formGrid("FBLike",{title:gt.gettext("Facebook Like: Custom URL"),width:600,height:220,cls:"dc-insert-panel"},"<div style='padding-bottom: 10px; background-color: rgb(255,255,255);'> <span style='size: 11pt; font-weight:bold;'>"+gt.gettext("The description of the URL is not required. It will display before the URL if entered. If you don't enter a description, the URL will be displayed twice.")+" </span></div><div style='visibility:hidden' id='t_fblike_url'>"+af+"</div>");},pwInsertDC_Lib:function(af){if(!this.confirmTagReplace()){return;}this.pwGrid("DC_Lib",{title:gt.gettext("Insert Dynamic Content from Library"),width:600,height:313,animateTarget:af,cls:"dc-insert-panel"},'<div style="padding:5px;background-color:#fff">'+gt.gettext("Select a Dynamic Content tag below to insert")+"</div>");},pwInsertDC_Mailing:function(af){if(!this.confirmTagReplace()){return;}this.pwGrid("DC_Mailing",{title:gt.gettext("Insert Dynamic Content (More)"),buttons:[new Ext.Button({text:"Cancel",cls:"blue_button",listeners:{click:p}})],width:300,height:350,animateTarget:af,cls:"dc-insert-panel"},'<div style="padding:5px;background-color:#fff">'+gt.gettext("Select a Dynamic Content tag below to insert")+"</div>");},transformLinkData:function(ag){var af=0;var ai;var ah=[];Ext.iterate(ag,function(al){if(ai!==al.type){af=1;ai=al.type;var ak=al.name?af+". "+al.name:"";var aj=(al.type==="Web View")?"Tag Link":al.type;ah.push([aj,ak,al.url]);}else{ah.push(["",++af+". "+al.name,al.url]);}});return ah;},getP13nSelectorHtml:function(af){return af?'<span class="hand" onclick="ECM.Form.DCEditor.instances['+this.id+'].switchP13nGrid()">'+gt.gettext("Most Common")+'</span> | <span class="bold">'+gt.gettext("Full List")+"</span>":'<span class="bold">'+gt.gettext("Most Common")+'</span> | <span class="hand" onclick="ECM.Form.DCEditor.instances['+this.id+'].switchP13nGrid(true)">'+gt.gettext("Full List")+"</span>";},switchP13nGrid:function(ag){var af=this;$("DCEditorP13nSelector"+af.id).innerHTML=af.getP13nSelectorHtml(ag);$("DCEditorP13nSearch"+af.id).value="";ECM.Form.DCEditor.getData("P13n",function(ah){af.P13nGrid.getStore().loadData(af.getP13nArr(ah,ag));});},getP13nArr:function(aj,ah){if(!aj){return;}if(ah){var af={};for(var ag in aj[0]){af[ag]=aj[0][ag];}for(var ag in aj[1]){af[ag]=aj[1][ag];}aj=af;}else{aj=aj[0];}var ai=[];for(var ag in aj){ai.push([aj[ag][2],"%%"+aj[ag][0]+"%%"]);}return ai;},getTxArr:function(af){if(!af){return;}var ag=[];for(var al in af){var ai=[];for(var ah=0,ak=af[al].args.length;ah<ak;ah++){var aj=af[al].args[ah].name.toLowerCase();if(aj!=="day"){ai.push((aj==="casing"||aj==="format"||aj==="type"?"'"+aj+"'":aj).replace("string","value"));}}ag.push([af[al].display_name,"%%"+al+'(<span class="dark_grey">'+ai.join(", ")+"</span>)%%"]);}return ag;},getDCArr:function(af,ak){if(!af){return;}ECM.Form.DCEditor.markDCFormats(this.id);var aj=ak==="lib"?1:0;var ah=[];for(var ai in af[aj]){ah.push([af[aj][ai][0],af[aj][ai][1],(af[aj][ai][3]||[]).join(", ")]);}if(ak==="mailing"){ah=ah.sort();ah.splice(0,this.INSERT_MENU_LIMIT);for(var ai=0,ag=ah.length;ai<ag;ai++){ah[ai][0]+=" ("+ah[ai][2]+")";}}return ah;},pwWrapText:function(af){var ag=this;G({title:gt.gettext("Wrap Text"),msg:gt.gettext("Wrap text at")+' <input id="DCEditorPwWrapIn'+ag.id+'" size="3" maxlength="4" value="'+(this._lastWrapBound||72)+'"/> '+gt.gettext("characters")+".",buttons:{ok:gt.gettext("GO")},fn:function(ah){if(ah!=="ok"){return;
}ag.wrap($("DCEditorPwWrapIn"+ag.id).value);},animEl:af,onLoad:function(){$("DCEditorPwWrapIn"+ag.id).focus();}});}};ECM.Form.DCEditor.TriplePlay=function(){var af=0;return function(ah){if(!ah||!ah.editors){ah={editors:[{format:"html"},{format:"text"},{format:"aol"}]};}else{if(!ah.editors[0]||typeof ah.editors[0]!=="object"){ah.editors=[{format:"html",content:ah.editors[0]},{format:"text",content:ah.editors[1]},{format:"aol",content:ah.editors[2]}];}}var ao=[],am=[];for(var ai=0,an=ah.editors.length;ai<an;ai++){ah.editors[ai].noDecoration=true;ah.editors[ai].noDoubleClickProtip=true;if(ai){ah.editors[ai].hide=true;}if(ah.hideDCMenu){ah.editors[ai].hideDCMenu=true;}if(ah.hideDCNew){ah.editors[ai].hideDCNew=true;}if(ah.hidePersonalizationMenu){ah.editors[ai].hidePersonalizationMenu=true;}if(ah.height){ah.editors[ai].height=ah.height;}if(!ai){ah.editors[ai].onload="ECM.Form.DCEditor.TriplePlay.onLoad("+af+")";}if(ah.editors[ai].content){ah.editors[ai].content=ah.editors[ai].content.replace(/&/g,"&amp;");}var ap=new ECM.Form.DCEditor(ah.editors[ai]);if(ah.onContentTagDoubleClick){ap[0].rulesCall=ah.onContentTagDoubleClick;ah.editors[ai].noDoubleClickProtip=false;}if(ah.hideDCMenu){ap[0].pwEditDC=function(){};}ao.push(ap[0]);am.push(ap[1]);}var ak=['<div class="ecm-dc-menubar"><span class="bold">'+gt.gettext("Format")+':&nbsp;</span><ul class="menubar">'];for(var ai=0,an=ao.length;ai<an;ai++){var ag=ECM.Form.DCEditor.formatInfo(ao[ai].format,ao[ai].id);var al=ag.titleAlt||ag.title||ao[ai].format;ak.push("<li>"+(ai?'<span style="padding:0 6px">|</span>':"")+'<span id="DCEditorTriplePlayFormat'+ao[ai].id+'" class="'+(ai?"hand":"bold")+'" onclick="ECM.Form.DCEditor.TriplePlay.switchEditor('+af+","+ao[ai].id+')">'+al+"</span></li>");}ak.push("</ul></div>");var aj=[];aj.push('			<div class="ecm-3p-wrap">			<div id="DCEditorTriplePlayBar'+af+'" class="bluebox">				<div style="float:left">				'+ak.join("")+'				</div>				<div id="DCEditorTriplePlayButtons'+af+'" style="float:right;margin-top:-'+(m?8:1)+'px">				</div>				<div style="clear:both"></div>			</div>			<div class="bluebox">');for(var ai=0,an=am.length;ai<an;ai++){aj.push(am.shift());}aj.push("</div></div>");this.id=af++;this.dc=ao;this.activeId=ao[0].id;this.html=aj.join("");this.setWrapWidth=ah.setWrapWidth;ECM.Form.DCEditor.TriplePlay.instances.push(this);return this;};}();ECM.Form.DCEditor.TriplePlay.instances=[];ECM.Form.DCEditor.TriplePlay.onLoad=function(ai){var af=ECM.Form.DCEditor.TriplePlay.instances[ai];ECM.Form.DCEditor.instances[af.activeId].initialize();for(var ah=0,ag=af.dc.length;ah<ag;ah++){af.dc[ah].initializeDom();}af.setHeight(af.height);$("DCEditorTriplePlayButtons"+ai).innerHTML='		<ul class="menubar DCEditorTriplePlayButtons">				<li><span id="DCEditorMenuGenerateText" style="display:none"></span></li>				<li><span id="DCEditorMenuGenerateHTML" style="display:none"></span></li>				<li><span id="DCEditorMenuWrapText" style="display:none"></span></li>				<li><span id="DCEditorMenuHtml"></span></li>				<li><span id="DCEditorMenuInsert"></span></li>				<li><span id="DCEditorMenuPreview"></span></li>		</ul>	';new Ext.Button({renderTo:"DCEditorMenuGenerateText",cls:"blue_button",text:gt.gettext("Generate From Text"),listeners:{click:function(){af.copyContent("text","aol");}}});new Ext.Button({renderTo:"DCEditorMenuGenerateHTML",cls:"blue_button",text:gt.gettext("Generate From HTML"),listeners:{click:function(){af.copyContent("html","text");}}});new Ext.Button({renderTo:"DCEditorMenuWrapText",cls:"blue_button",text:gt.gettext("Wrap Text")+"&#9660;",listeners:{click:function(){ECM.Form.DCEditor.instances[af.activeId].showMenuWrapText(af.setWrapWidth);}}});new Ext.Button({renderTo:"DCEditorMenuHtml",cls:"blue_button",text:gt.gettext("HTML Editor"),listeners:{click:function(aj){ECM.Form.DCEditor.instances[af.activeId].switchHtmlEditor(aj);}}});new Ext.Button({renderTo:"DCEditorMenuInsert",cls:"blue_button",text:"Insert&#9660;",listeners:{click:function(){ECM.Form.DCEditor.instances[af.activeId].showMenuInsert(15);}}});new Ext.Button({renderTo:"DCEditorMenuPreview",cls:"blue_button",text:gt.gettext("Preview"),listeners:{click:function(){ECM.Form.DCEditor.instances[af.activeId].previewHtml(ai);}},tooltip:gt.gettext("Preview is specific to this targeting.")+"<br/>"+gt.gettext("The display may vary from overall")+"<br/>"+gt.gettext("mailing preview")+"."});};ECM.Form.DCEditor.TriplePlay.switchEditor=function(aj,ai){var ah=ECM.Form.DCEditor.TriplePlay.instances[aj];var al=ah.activeId;if(al===ai){return;}var ag=ECM.Form.DCEditor.instances[al];var ak=ECM.Form.DCEditor.instances[ai];ak.ed.style.display="block";ak.initialize();ag.hideMenu("Insert");ag.hideMenu("WrapText");$("DCEditorTriplePlayFormat"+al).className="hand";$("DCEditorTriplePlayFormat"+ai).className="bold";ag.switchOutOfHtmlEditor();ag.ed.style.display="none";if($("DCEditorRuler"+ai)){$("DCEditorRuler"+ai).style.display="block";}if($("DCEditorRuler"+al)){$("DCEditorRuler"+al).style.display="none";}var af=ah.height?ah.height-71:0;switch(ak.format){case ("text"):$("DCEditorMenuGenerateText").style.display="none";$("DCEditorMenuGenerateHTML").style.display="inline";$("DCEditorMenuWrapText").style.display="inline";$("DCEditorMenuHtml").style.display="none";$("DCEditorMenuInsert").style.display="inline";$("DCEditorMenuPreview").style.display="none";if(af){ak.ed.style.height=(af-26)+"px";}break;case ("aol"):$("DCEditorMenuGenerateText").style.display="inline";$("DCEditorMenuGenerateHTML").style.display="none";$("DCEditorMenuWrapText").style.display="none";$("DCEditorMenuHtml").style.display="none";$("DCEditorMenuInsert").style.display="inline";$("DCEditorMenuPreview").style.display="none";if(af){ak.ed.style.height=af+"px";}break;case ("html"):$("DCEditorMenuGenerateText").style.display="none";$("DCEditorMenuGenerateHTML").style.display="none";$("DCEditorMenuWrapText").style.display="none";$("DCEditorMenuHtml").style.display="inline";$("DCEditorMenuInsert").style.display="inline";$("DCEditorMenuPreview").style.display=ak.ed.style.display==="none"?"none":"inline";if(af){ak.ed.style.height=af+"px";}break;}ah.activeId=ai;};ECM.Form.DCEditor.TriplePlay.prototype={update:function(aj,ai){for(var ah=0,ag=this.dc.length;ah<ag;ah++){var af=this.dc[ah];af.content=aj[ah];if(!af.initialized){af.wrapBound=ai;continue;}if(af.ed.style.display==="none"){af.wasHidden=true;af.ed.style.display="block";}af.switchOutOfHtmlEditor();af.closePreviewHtml(this.id,function(){this.addContent(this.content,ai,false,true);if(this.wasHidden){this.ed.style.display="none";delete this.wasHidden;}else{var ak=this;P(function(){ak.cw.focus();});}});}},whatChanged:function(){var ai=Array(this.dc.length);for(var ah=0,ag=this.dc.length;ah<ag;ah++){if(!this.dc[ah].initialized){continue;}this.dc[ah].switchOutOfHtmlEditor();var af=this.dc[ah].getContent();if(af!==(this.dc[ah].content===undefined||this.dc[ah].content===null?"":this.dc[ah].content).replace(/&amp;/g,"&").replace(/\n$/,"")){ai[ah]=af;}}return ai;},markUnchanged:function(){for(var ag=0,af=this.dc.length;ag<af;ag++){if(!this.dc[ag].initialized){continue;}this.dc[ag].content=this.dc[ag].getContent();}},copyContent:function(al,ak){var ag=this;var aj,ai;for(var ah=0,af=ag.dc.length;ah<af;ah++){if(ag.dc[ah].format===al){aj=ah;continue;}if(ag.dc[ah].format===ak){ai=ah;continue;}}ECM.Ajax.request({url:ECM.Form.DCEditor.url(al+"_to_"+ak),method:"GET",params:{from:ab(ag.dc[aj].initialized?ag.dc[aj].cd.body.innerHTML:ag.dc[aj].content)},success:function(am,an){ag.dc[ai].addContent(am.responseJSON.data.to);},failure:function(am,an){window.alert(gt.gettext("Error communicating with server"));}});},setHeight:function(af){if(!af||af<71){return;}this.height=af;for(var ah=0,ag=this.dc.length;ah<ag;ah++){if(this.dc[ah].ed){this.dc[ah].ed.style.height=(af-71)+"px";}}},onMove:function(ag,af,ah){}};})();ECM.provide("ECM.CMS.Modal.CopyLibrary");ECM.CMS.Modal.CopyLibrary=Ext.extend(ECM.Window,{closable:true,width:600,constructor:function(a){this.title=gt.gettext("Copy to Library");
this.tags=a.tags;this.mid=a.mid;this.overwrite=a.overwrite;var b=this;if(this.tags.length===0){Ext.Msg.alert(gt.gettext("No Selections"),gt.gettext("No Dynamic Content tags were selected to copy."));this.close();}this._copyForm=new Ext.form.FormPanel({labelWidth:150,items:this._getItems(this.tags)});this.items=[{html:gt.gettext("Could not copy some tags because their names conflicted with existing tags or the names were illegal. Check the box to overwrite them all, or give each tag a unique name for the library.")+"<br/><br/>"},this._copyForm];this.windowButtons=[{text:gt.gettext("Copy to Library"),handler:function(){b.notify.clear();b.copyToLibrary();}},{text:gt.gettext("Cancel"),handler:function(){b.close();}}];ECM.CMS.Modal.CopyLibrary.superclass.constructor.call(this,a);},_getItems:function(a){var b=[];var c=this;Ext.each(a,function(d){b.push({xtype:"textfield",labelSeparator:"d_",fieldLabel:"<b>"+gt.gettext("Copy")+" </b>"+d+"<b> "+gt.gettext("to")+" </b> ",name:"name_"+d,id:d});});b.push({xtype:"checkbox",hideLabel:true,boxLabel:gt.gettext("Overwrite all conflicting tags"),name:"overwrite",listeners:{check:function(f,d){c.overwrite=d;}}});return b;},copyToLibrary:function(){var a=this;this.tagBatch=[];if(this.isVisible()){var b=this._copyForm.getForm().getValues();Ext.iterate(b,function(f,c){if(f.substring(0,5)==="name_"){var d=f.substring(5);if(Ext.isEmpty(c)){a._addTagToBatch(d,d);}else{a._addTagToBatch(d,c);}}});this.hide();}else{Ext.each(a.tags,function(c){a._addTagToBatch(c,c);});}ECM.Ajax.request({url:"/cm/r",method:"POST",params:{batch:Ext.encode(a.tagBatch)},success:function(c,f){var d=c.responseJSON;Ext.Msg.alert(gt.gettext("Copy Confirmation"),gt.gettext("Copy to the library has been completed for the selected dynamic content element(s)"));a.close();},failure:function(c,h){var d=c.responseJSON;var g=gt.gettext("An error has occurred, Please try again.");if(d.error.length>0){g=gt.gettext("Fatal Error: ")+d.error.join(", ");}else{if(d.application_errors.length>0){g=gt.gettext("Error: ")+d.application_errors.join(", ");}}if(g.match(/Name already exists/)){var j="";var f=[];Ext.each(d.error,function(k){if(k.match(/Name already exists: (.*)/)){f.push("d_"+RegExp.$1);}});Ext.each(a.tags,function(k){if(f.indexOf(k)===-1){Ext.getCmp(k).destroy();j=j+gt.strargs(gt.gettext("Copied %1 to Tag Library.<br>"),[k]);}});a.show();a.tags=f;if(Ext.isDefined(j)){a.notify.info(j);}}else{if(a.hidden){Ext.Msg.alert(gt.gettext("Error"),g);a.close();}else{a.notify.error(g);}}}});},_addTagToBatch:function(a,b){this.tagBatch.push({url:"/cm/r/library/dynamic_content",params:{action:"copy",mid:this.mid,name:a.replace(/^d_/,""),name_copy:b.replace(/^d_/,""),overwrite:this.overwrite?1:0}});}});Ext.reg("ecm.modalcopylibrary",ECM.CMS.Modal.CopyLibrary);ECM.provide("ECM.CMS.Modal.CopyDCTag");ECM.CMS.Modal.CopyDCTag=Ext.extend(ECM.Window,{closable:true,closeAction:"close",width:600,constructor:function(a){Ext.QuickTips.init();this.title=gt.gettext("Copy Dynamic Content");this.tag=a.tag;this.mid=a.mid;var b=this;this._tagPanel=new Ext.form.FormPanel({items:{xtype:"textfield",width:250,labelSeparator:"d_",fieldLabel:gt.gettext("Copy to: "),id:"name_copy",allowBlank:false,vtype:"dcTagNameFormat",vtypeText:gt.gettext("Name can only contain digits, alphabets and underscores. Name must also start with alphabets."),invalidText:gt.gettext("Invalid name."),minLength:1,maxLength:50,maxLengthText:gt.gettext("Name cannot exceed 50 characters."),emptyText:gt.gettext("Enter a name"),msgTarget:"side",listeners:{invalid:function(){b.copyButton.disable();},valid:function(){b.copyButton.enable();}}}});this.items=[{html:this.tag+"<br/><br/>"},this._tagPanel];this.copyButton=new Ext.Button({text:gt.gettext("Copy"),disabled:true,handler:function(){var c=b._tagPanel.getForm().getValues().name_copy;ECM.Ajax.request({url:"/cm/r/library/dynamic_content?action=copy",method:"POST",params:{mid:b.mid,to_mid:b.mid,name:b.tag.replace(/^d_/,""),name_copy:c},success:function(d,f){Ext.getCmp("leftnav_dc").refreshTree();Ext.Msg.alert(gt.gettext("Copy Confirmation"),gt.strargs(gt.gettext("d_%2 has been copied from %1."),[b.tag,c]));b.close();},failure:function(d,h){var f=d.responseJSON;var k=f.error;if(k){for(var g=0;g<k.length;g++){var j=k[g].match(/: (.+)(.cdb)?/);if(j[1]){k[g]="That name (d_"+j[1]+") already exists, please choose another name.";}}error=k.join(", ");}b.notify.error(error||gt.gettext("An error has occurred, please try again."));}});}});this.windowButtons=[this.copyButton,{text:gt.gettext("Cancel"),handler:function(){b.close();}}];ECM.CMS.Modal.CopyDCTag.superclass.constructor.call(this,a);},initComponent:function(){ECM.CMS.Modal.CopyDCTag.superclass.initComponent.apply(this,arguments);this.on("beforeclose",function(){this._tagPanel.destroy();});}});ECM.provide("ECM.CMS.Panel.DynamicContent");ECM.CMS.Panel.DynamicContent=Ext.extend(Ext.Panel,{maxTagLength:8,constructor:function(a){this.appimght=a.appimght;this.mfid=a.mfid;this.mid=a.mid;this.mtype=a.mtype;this.aid=a.aid;this.existingTags=[];this.resetCodeMirror=true;this.tagsChanged=false;this.tagDeleted;ECM.CMS.Panel.DynamicContent.superclass.constructor.call(this,a);},initComponent:function(){Ext.QuickTips.init();this.loadIcon=this._createInlineLoadIcon(gt.gettext("Loading data&hellip;"));ECM.Tablespace={params:{appimght:this.appimght,aid:this.aid.toString(),mid:this.mid.toString(),mtype:this.mtype.toString(),desired_aid:this.aid.toString(),ref_mid:"",img_upload:"true"},get:function(b){return this.params[b];},asQueryString:function(){return Ext.urlEncode(this.params);}};var a=this;a.subscribe("/cms/leftnav/dc/refresh",function(){a.tagsChanged=true;a.refreshTree();});this.newDcTree=new Ext.tree.TreePanel({enableDrag:true,listeners:{click:function(){ECM.Flare.onFocus("FLARE_LEFTNAV_PERSONALIZATION_DYNAMIC_CONTENT");}},root:{nodeType:"async",text:gt.gettext("Dynamic Content"),leaf:false,draggable:false,expanded:true,editable:false,children:[{text:gt.gettext("New"),leaf:true,listeners:{click:function(){if(Ext.isGecko3){a.fixFireFox3Glitch("fixed","hidden");}ECM.Rules.DynamicContent.create({desiredAid:a.aid,dcid:-1,mfid:a.mfid,mid:a.mid,mailingType:a.mtype,key:(a.mtype===2)?"KEY":undefined,onClose:function(){if(Ext.isGecko3){a.fixFireFox3Glitch("absolute","");}ECM.Form.DCEditor.onDCModalClose.apply(this,arguments);if(!Ext.isEmpty(arguments[0])){a.refreshTree();}}});}}}]}});this.items=[this.newDcTree,this.loadIcon];this.newDcTree.hide();ECM.CMS.Panel.DynamicContent.superclass.initComponent.call(this);},loadTreeData:function(a){if(this.tree){return;}this.loadIcon.show();var b=this;ECM.Ajax.request({scope:this,url:"/m/service/content",method:"POST",params:{rm:"get_dc",mid:this.mid},success:function(d){var c=d.responseJSON;ECM.Form.DCEditor.data("DC",c.data);if(Ext.isDefined(a)&&!a){return;}b._buildAndAttachTree(c.data[0]);},failure:function(c){b._publishErrorMsg(c.responseText,"Dynamic Content");b.loadIcon.hide();}});},loadP13nData:function(a){if(!this.newDcTree.hidden){return;}this.loadIcon.show();var b=this;ECM.Ajax.request({scope:this,url:"/m/service/content",method:"POST",params:{rm:"get_personalization",mid:this.mid,mtype:this.mtype,desired_aid:this.aid,cid:0,lid:0},success:function(c){var d=c.responseJSON;ECM.Form.DCEditor.data("P13n",d.data);b.loadTreeData(a);},failure:function(c){b._publishErrorMsg(c.responseText,"Personalization");b.loadIcon.hide();}});},_buildAndAttachTree:function(d){if(this.tree){return;}var h=this;var g=[];this.tagsArray=[];this.tagsChecked=[];var f=[];var c={};Ext.iterate(d,function(k,l){f.push(k);});f.sort();Ext.each(f,function(k){c[k]=d[k];});d=c;Ext.iterate(d,function(k,m){k=k.toLowerCase();var l=k;if(h.existingTags.indexOf(l)===-1&&!h.newDcTree.hidden){h.tagsChanged=true;}h.tagsArray.push(l);g.push({text:h._generateNodeText(k),draggable:true,leaf:true,expanded:true,icon:"/js/extjs/resources/images/default/tree/leaf.gif",id:"lib_"+l,ddText:l,checked:false,content:(h.mtype===2)?"%%"+l+"[]%%":"%%"+l+"%%",qtipCfg:{title:(l.length>h.maxTagLength)?l:"",text:gt.gettext(m[1])},listeners:{click:function(q,p){var o=p.getTarget().id;
if(o==="copy_"+l){var n=new ECM.CMS.Modal.CopyDCTag({tag:l,mid:h.mid});n.show();}else{if(Ext.isGecko3){h.fixFireFox3Glitch("fixed","hidden");}ECM.Rules.DynamicContent.modify({desiredAid:h.aid,dcid:-1,mfid:h.mfid,mid:h.mid,mailingType:h.mtype,id:l.replace(/^d_/i,""),key:(h.mtype===2)?"KEY":undefined,onClose:function(){if(Ext.isGecko3){h.fixFireFox3Glitch("absolute","");}ECM.Form.DCEditor.onDCModalClose.apply(this,arguments);if(!Ext.isEmpty(arguments[0])){h.tagDeleted=arguments[0].deleted;h.refreshTree();}}});}}}});});var j=Ext.getCmp("leftnav_panel");if(j.dcLibOverwrite.length){var b=ECM.Form.DCEditor.data("DC");Ext.apply(b[0],j.libTags);}if((this.tagsChanged||this.tagDeleted)&&this.resetCodeMirror){var b=ECM.Form.DCEditor.data("DC");Ext.getCmp("leftnav_panel").resetCodeMirror(b[0]);}else{if(!this.resetCodeMirror){this.resetCodeMirror=true;}}if(g.length===0){this.loadIcon.hide();this.newDcTree.show();return;}var a=new Ext.tree.AsyncTreeNode({text:gt.gettext("In Mailing"),leaf:false,draggable:false,expanded:true,editable:false,children:g});this.tree=new Ext.tree.TreePanel({enableDrag:true,ddGroup:"DCZone",id:"dc_treePanelId",root:a,buttonAlign:"center",buttons:[{text:gt.gettext("Download"),cls:"blue_button",scope:this,handler:function(){var k="desired_aid="+this.aid+"&mid="+this.mid+"&op=download";window.location="/m/mailers/mailings/dynamic_content_list?"+k;}},{text:gt.gettext("More Actions"),cls:"blue_button",scope:this,menu:new Ext.menu.Menu({items:[{text:gt.gettext("Copy to Library"),handler:function(){if(h.tagsChecked.length===0){h._noSelectionModal("copy");return;}var k=new ECM.CMS.Modal.CopyLibrary({tags:h.tagsChecked,mid:h.mid,overwrite:false});k.copyToLibrary();}},{text:gt.gettext("Delete Tags"),handler:function(){if(h.tagsChecked.length===0){h._noSelectionModal("delete");return;}var k=Ext.Msg.buttonText.ok;Ext.Msg.buttonText.ok=gt.gettext("Delete");Ext.Msg.show({title:gt.gettext("Delete Dynamic Content"),msg:gt.strargs(gt.ngettext("You have selected %1 dynamic content element to be deleted. ","You have selected %1 dynamic content elements to be deleted. ",h.tagsChecked.length),[h.tagsChecked.length])+gt.gettext("Are you sure you would like to delete them?"),buttons:Ext.Msg.OKCANCEL,width:500,fn:function(l){if(l==="ok"){h._batchDeleteDC();}}});Ext.Msg.buttonText.ok=k;}}]})}],listeners:{checkchange:function(l,k){if(k){h.tagsChecked.push(l.getUI().node.id.substring(4));}else{h.tagsChecked.remove(l.getUI().node.id.substring(4));}},startdrag:function(k,m,l){try{k.dragZone.proxy.update("");var o=m.ui.elNode.cloneNode(true);o.removeChild(o.lastChild);o.lastChild.innerHTML=m.attributes.ddText;k.dragZone.proxy.ghost.dom.appendChild(o);}catch(n){}},afterrender:function(){if(h.mtype!==2){return;}h.tree.hide();h._loadNestedTag();}}});if(this.mtype===1){this.loadIcon.hide();this.newDcTree.show();}this.existingTags=this.tagsArray;this.add(this.tree);this.doLayout();this._checkContentForTagsTimer();this.tagsChanged=false;},_createInlineLoadIcon:function(a){return new Ext.BoxComponent({style:{fontSize:"11px"},html:['<img src="/js/extjs/resources/images/default/grid/loading.gif" />',"&nbsp;",a].join("")});},_loadNestedTag:function(){this.loadIcon.show();var b=this;var a=[];this.ruleObj={};this.nestedTagCount=0;this.levelDepth=0;Ext.each(b.tagsArray,function(c){a.push({url:"/cm/r/dynamic_content/content_all",params:{mid:b.mid,rs_id:c.replace(/^d_/,"")}});});ECM.Ajax.request({url:"/cm/r",method:"GET",params:{batch:Ext.encode(a)},success:function(c){var d=c.responseJSON.data.data;if(!Ext.isDefined(d)){b._publishErrorMsg(c.responseText,"Dynamic Content");b.loadIcon.hide();return;}Ext.each(d,function(h,g){var f=b.tagsArray[g];b.ruleObj[f]=h.data.data;});Ext.each(b.tagsArray,function(f){b._buildNestedTagTree(b.tree.getNodeById("lib_"+f),f);});b.loadIcon.hide();b.newDcTree.show();b.tree.show();},failure:function(c){b._publishErrorMsg(c.responseText,"Dynamic Content");b.loadIcon.hide();}});},_buildNestedTagTree:function(a,d){var c=this;var b=[];this.levelDepth++;if(this.levelDepth>4){this.levelDepth--;return;}Ext.iterate(c.ruleObj[d],function(g,f){if(!Ext.isDefined(f)){return true;}Ext.each(f,function(h){if(!h){return true;}Ext.each(c.tagsArray,function(j){var m=new RegExp("%%("+j+")(\\[.*?\\])?%%","i");var o=h.match(m);if(Ext.isArray(o)){var k=o[1];if(b.indexOf(k)===-1){var n=k;var l=16-2*(c.levelDepth);if(k.length>l){n=k.substring(0,l)+"&hellip;";}a.leaf=false;a.appendChild({text:n,id:"nested-"+c.nestedTagCount+++"-"+k,expanded:true,leaf:true,icon:"/js/extjs/resources/images/default/tree/leaf.gif",qtipCfg:(k.length>l)?{title:k}:""});b.push(k);c._buildNestedTagTree(a.lastChild,k);}}});});});this.levelDepth--;},refreshTree:function(){if(Ext.isDefined(this.tree)){Ext.destroy(this.tree);this.tree=undefined;}this.loadTreeData();},_publishErrorMsg:function(a,b){if(a.match(/Session Timeout/)){this.publish("/cms/error/add",{message:gt.gettext("Session timeout. Please login again.")});}else{this.publish("/cms/error/add",{message:gt.strargs(gt.gettext("Failed to load %1 tags. Please try again."),[b])});}},_checkContentForTagsTimer:function(){var a=["htmltextarea","plaintextarea","richtextarea"];var c={htmltextarea:gt.gettext("h"),plaintextarea:gt.gettext("t"),richtextarea:gt.gettext("rt")};var g=this;var f=function(){var j=[];Ext.each(a,function(k){if(Ext.isDefined(Ext.getCmp(k))){j.push(k);}});var h=[];Ext.each(j,function(k){if(!Ext.isDefined(Ext.getCmp(k))){return false;}var l=Ext.getCmp(k).getValue();if(!Ext.isDefined(l)){return true;}if(Ext.isDefined(l)&&l.match(/%%d_/i)){Ext.each(g.tagsArray,function(m){if(!Ext.isDefined(Ext.get("indicator"+m))){return false;}if(!Ext.isDefined(h[m])){h[m]="(";}var n=new RegExp(m,"i");if(l.match(n)){h[m]+=(h[m]==="(")?"":", ";h[m]+=c[k];}});}});Ext.each(g.tagsArray,function(k){if(!Ext.isDefined(h[k])){h[k]="()";}else{h[k]+=")";}var l=(h[k]==="()")?"":h[k];g.setNodeText(k,l);});};var b={run:f,interval:5000};var d=new Ext.util.TaskRunner();d.start(b);},_generateNodeText:function(b,a){if(b.length>this.maxTagLength){b=b.substring(0,this.maxTagLength)+"&hellip;";}return b+"&nbsp;"+(a||"");},setNodeText:function(c,a){c=c.toLowerCase();if(!Ext.isDefined(this.tree)){return false;}var f=this.tree.getRootNode().findChild("id","lib_"+c);if(!Ext.isEmpty(f)){var d=this._generateNodeText(c,a);if(!Ext.isDefined(f.getUI().copyNode)){var b=Ext.DomHelper.createDom({tag:"a",id:"copy_"+c,cls:"leftnav_copy",href:"#",html:gt.gettext("Copy")});f.getUI().elNode.appendChild(b);f.getUI().copyNode=b;}f.setText(d);}},fixFireFox3Glitch:function(a,b){var c=document.getElementsByClassName("CodeMirror-TextArea");Ext.each(c,function(d){d.style.position=a;d.style.visibility=b;});},_noSelectionModal:function(a){Ext.Msg.alert(gt.gettext("No Selections"),gt.strargs(gt.gettext("No Dynamic Content tags were selected to %1."),[a]));},_batchDeleteDC:function(){var c=this;var a=[];Ext.each(this.tagsChecked,function(d){a.push({mid:c.mid,name:d.replace(/^d_/i,"")});});var b=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Deleting...")});Ext.get("cm_wrapper").setHeight(ECM.CMS.STANDARD_LOADING_HEIGHT);b.show();ECM.Ajax.request({url:"/cm/r/library/dynamic_content?action=delete",method:"POST",params:{batch:Ext.encode(a)},success:function(f){b.hide();c.tagsChanged=true;var g=f.responseJSON;var d=ECM.Form.DCEditor.data("DC");Ext.each(c.tagsChecked,function(h){delete d[0][h.toUpperCase()];});c.tagsChanged=true;c.refreshTree();if(Ext.getCmp("cmsShell")._activePanel.id==="cmsCheckList"){this.publish("/cms/load/checklist");}if(g.data.data.unapproved){c._displayUnapprovedMsg();}},failure:function(d){b.hide();c.publish("/cms/error/add",{message:gt.gettext("Failed to delete tags. Please try again.")});}});},_displayUnapprovedMsg:function(){ECM.publish("/cms/updateMailingTitle",{mailing_status:gt.gettext("(Not Approved)")});this.publish("/cms/error/add",{message:gt.gettext("Mailing has been unapproved due to this change.")});}});Ext.reg("ecm.dynamiccontentpanel",ECM.CMS.Panel.DynamicContent);
ECM.provide("ECM.CMS.Panel.Emoticons");ECM.CMS.Panel.Emoticons=Ext.extend(Ext.Panel,{treeExpanded:false,layoutCompleted:false,autoScroll:true,initComponent:function(){this.loadMask=this.createInlineLoadMask(gt.gettext("Loading data..."));this.items=[this.loadMask];ECM.CMS.Panel.Emoticons.superclass.initComponent.call(this);},loadTreeData:function(){if(this.emoTree){return;}var a=this;this.loadMask.show();ECM.Ajax.request({url:"/cm/mailing/emoticons",success:function(b,f){var d=b.responseJSON;var c=d.data.emoticons;a.buildTree(c,false);},failure:function(b,c){a.buildTree(null,true);}});},buildTree:function(b,c){this.loadMask.hide();if(c){Ext.Msg.alert(gt.gettext("Server Error"),gt.gettext("Failed to retrieve emoji. Please try again."));this.publish("/cms/error/add",{message:gt.gettext("Failed to load emoji. Please try again.")});Ext.getCmp("leftnav_emo").collapse();return;}this.publish("/cms/error/add",{message:gt.gettext("")});var a=new Ext.tree.AsyncTreeNode({text:gt.gettext("Emoji"),leaf:false,draggable:false,expanded:true,editable:false,children:this.makeCategory(b)});this.emoTree=new Ext.tree.TreePanel({id:"emo_tree_panel",enableDrag:true,draggable:false,ddGroup:"DCZone",root:a});if(this.isVisible()){this.attachTree();}if(!this.layoutCompleted){this.on("show",this.attachTree);}},attachTree:function(){if(this.emoTree&&!this.layoutCompleted){this.add(this.emoTree);this.doLayout();this.layoutCompleted=true;}},makeCategory:function(a){var b=[];var c=this;Ext.iterate(a,function(d,f){b.push({text:gt.gettext(d),leaf:false,draggable:false,children:c.makeEmoticonsNodes(f),listeners:{expand:function(){var g=Ext.getCmp("cm_p_dc").getInnerHeight();var h=Ext.getCmp("p13n_dc_tabpanel").getHeight();Ext.getCmp("leftnav_emo").setHeight(g-h);}}});return true;});b.sort(function(f,d){if(f.text>d.text){return 1;}if(f.text<d.text){return -1;}return 0;});return b;},makeEmoticonsNodes:function(b){var a=[];Ext.iterate(b,function(c){a.push({text:c.html_code+"&nbsp;"+gt.gettext(c.name),draggable:true,id:"emo_"+c.name,cls:"x-tree-noicon",leaf:true,content:c.utf8_code,qtipCfg:{title:gt.gettext(c.name),text:"Drag and Drop to insert into Subject, From and Reply-To"}});return true;});return a;},createInlineLoadMask:function(a){return new Ext.BoxComponent({cls:"inline_loadmask",html:['<img src="/js/extjs/resources/images/default/grid/loading.gif" />',"&nbsp;",a].join("")});}});Ext.reg("ecm.emoticonspanel",ECM.CMS.Panel.Emoticons);ECM.provide("ECM.CMS.Nav.LibraryFilterContainerUi");ECM.CMS.Nav.LibraryFilterContainerUi=Ext.extend(Ext.Panel,{selectedListType:ECM.Rules.Constants.LIBRARY.ITEM.HTML,initComponent:function(){var a=[{typeName:gt.gettext("Content - HTML"),typeValue:ECM.Rules.Constants.LIBRARY.ITEM.HTML},{typeName:gt.gettext("Content - Rich Text"),typeValue:ECM.Rules.Constants.LIBRARY.ITEM.RTF},{typeName:gt.gettext("Content - Text"),typeValue:ECM.Rules.Constants.LIBRARY.ITEM.TEXT}];if(!this.hideDC){a.push({typeName:gt.gettext("Dynamic Content"),typeValue:ECM.Rules.Constants.LIBRARY.ITEM.DYNAMIC_CONTENT});}a.push({typeName:gt.gettext("Image"),typeValue:ECM.Rules.Constants.LIBRARY.ITEM.IMAGE},{typeName:gt.gettext("Link"),typeValue:ECM.Rules.Constants.LIBRARY.ITEM.LINK});this.items=[{layout:"form",padding:1,id:"libraryFilterForm",bodyStyle:"background-color: #D6E3F3",items:[{id:"libraryFilterFeatureHelp",xtype:"fieldset",title:gt.gettext("Filter library by:"),labelWidth:75,items:[this.formContentTypeCbx=new ECM.Form.ListViewComboBox({fieldLabel:gt.gettext("Content type"),width:110,listWidth:120,items:a,listeners:{scope:this,listselect:function(d,c){if(this.selectedListType===c){return;}var b=ECM.Rules.Constants.LIBRARY.ITEM;if(this.selectedListType===b.LINK||c===b.LINK){this.formTagsTxf.setValue("");}this.selectedListType=c;},focus:function(){ECM.Flare.updateLink("FLARE_LEFTNAV_LIBRARY");}}}),{xtype:"fieldset",title:gt.gettext("Additional filtering:"),labelWidth:70,items:[{xtype:"container",layout:"form",labelWidth:20,items:[this.formTagsTxf=new Ext.form.TextField({fieldLabel:gt.gettext("Tag"),emptyText:gt.gettext("Enter tags, comma delimited"),anchor:"100%",listeners:{focus:function(){ECM.Flare.updateLink("FLARE_LEFTNAV_LIBRARY");}}}),{id:"tagCloudLink",text:gt.gettext("Or view tag cloud &raquo;"),xtype:"ecm.linkbutton",anchor:"100%",cls:"cm_library_tag_cloud_button",handler:(function(){if(this.selectedListType===ECM.Rules.Constants.LIBRARY.ITEM.LINK){if(Ext.isDefined(this.tagCloud)&&!this.tagCloud.hidden){this.tagCloud.hide();}if(!Ext.isDefined(this.linkCloud)){this.linkCloud=new ECM.Form.ModalTagCloud({libraryType:this.selectedListType,mailingType:this.mtype,closeAction:"hide",x:this.getPosition()[0]+this.getInnerWidth(),y:Ext.getCmp("tagCloudLink").getPosition()[1],listeners:{scope:this,filter:this.setFormTagsTxf}});}this.linkCloud.show();}else{if(Ext.isDefined(this.linkCloud)&&!this.linkCloud.hidden){this.linkCloud.hide();}if(!Ext.isDefined(this.tagCloud)){this.tagCloud=new ECM.Form.ModalTagCloud({filter:["tag_object.object_class","matches","LIBRARY"],libraryType:this.selectedListType,mailingType:this.mtype,closeAction:"hide",x:this.getPosition()[0]+this.getInnerWidth(),y:Ext.getCmp("tagCloudLink").getPosition()[1],listeners:{scope:this,filter:this.setFormTagsTxf}});}this.tagCloud.show();}}).createDelegate(this)}]},this.formTextTxf=new Ext.form.TextField({fieldLabel:gt.gettext("Name search"),anchor:"100%",listeners:{focus:function(){ECM.Flare.updateLink("FLARE_LEFTNAV_LIBRARY");}}})]},this.formFilterBtn=new Ext.Button({text:gt.gettext("Filter"),cls:"cm_float_right blue_button"})]}]},{xtype:"panel",padding:3,labelWidth:50,id:"libraryFilterResult",bodyStyle:"background-color: #D6E3F3",items:[{xtype:"fieldset",title:gt.gettext("Filtered by:"),items:[this.resultContentTypeDsp=new Ext.form.DisplayField({fieldLabel:gt.gettext("Content type"),anchor:"100%"}),this.resultTagsCtn=new Ext.Container({fieldLabel:gt.gettext("Tags"),anchor:"100%"}),this.resultNameDsp=new Ext.form.DisplayField({fieldLabel:gt.gettext("Name search"),anchor:"100%"})]},{xtype:"ecm.linkbutton",text:gt.gettext("Edit filter"),handler:this.toggleFilterPanels.createDelegate(this)}]},{xtype:"panel",id:"libraryFilterResultTree"}];ECM.CMS.Nav.LibraryFilterContainerUi.superclass.initComponent.call(this);},toggleFilterPanels:function(a){a=a||this.getComponent("libraryFilterResult").isVisible();this.getComponent("libraryFilterForm").setVisible(a);this.getComponent("libraryFilterResult").setVisible(!a);this.getComponent("libraryFilterResultTree").setVisible(!a);},setFormTagsTxf:function(a){}});ECM.provide("ECM.CMS.Nav.MapToContent");ECM.CMS.Nav.MapToContent=Ext.extend(ECM.Window,{title:gt.gettext("Map to Content"),resizable:false,modal:false,cls:"library_map_content_modal",constructor:function(a){Ext.apply(this,a);this.items=[this.buildModal()];this.buttons=[{text:gt.gettext("Apply"),id:"ecm_map_to_content_apply",cls:"blue_button",handler:function(){var m=Ext.getCmp("cmsShell")._activePanel;if(m.id==="contentPanelId"){if(Ext.getCmp("contentPanelId").getActiveEditor()!=="html"){this.notify.error(gt.gettext("Please switch to HTML content. This feature is only applicable to HTML content."));return false;}Ext.getCmp("extjseditor").syncValue();}var b=this.searchInput.getValue().trim(),c='<img src="'+this.data.url+'" alt="" />',f=0;var g="";var l="";if(m.id==="contentPanelId"){g=Ext.getCmp("contentPanelId").getCodeMirrorActiveEditor();l=g.getSearchCursor(b);}else{if(m.id==="settingsFormPanel"){g=Ext.getCmp("settingsFormPanel").getCodeMirrorActiveComponent();l=g?g.getSearchCursor(b):"";}}if(Ext.isEmpty(b)){this.notify.error(gt.gettext("No keyword entered. A keyword is required for this operation."));this.searchInput.reset();return false;}var h=0;var j=0;var k=0;if(!Ext.isEmpty(l)){while(l.findNext()){if(l.from().line!=k||l.from().ch>j){g.replaceRange(c,l.from(),l.to());h=l.from().ch;k=l.from().line;j=h+c.length;f++;}}}if(f>0){var d=f>1?gt.strargs(gt.gettext('"%1" has been mapped to %2 occurrences'),[Ext.util.Format.htmlEncode(b),f]):gt.strargs(gt.gettext('"%1" has been mapped to 1 occurrence'),[Ext.util.Format.htmlEncode(b),f]);
this.notify.info(d);if(m.id==="contentPanelId"){Ext.getCmp("extjseditor").setValue(g.getValue());}}else{this.notify.warn(gt.strargs(gt.gettext('Unable to find the "%1" keyword in the content'),[Ext.util.Format.htmlEncode(b)]));}}.createDelegate(this)},{text:gt.gettext("Cancel"),cls:"blue_button",handler:this.close.createDelegate(this)}];ECM.CMS.Nav.MapToContent.superclass.constructor.call(this,a);},buildModal:function(){this.content=new Ext.Panel({items:[{xtype:"container",cls:"img_container",layout:"column",items:[{xtype:"box",autoEl:{tag:"img",src:this.data.url,width:"70px"}},{xtype:"panel",layout:"form",width:390,labelWidth:60,items:[{xtype:"displayfield",value:this.data.name.wordBreak(40),fieldLabel:gt.gettext("File name"),anchor:"100%"},{xtype:"displayfield",value:this.data.url,fieldLabel:gt.gettext("URL"),cls:"word_wrap_break",anchor:"100%"}]}]},{xtype:"container",items:[{xtype:"label",text:gt.gettext("In this mailing, use this image everywhere ")},this.searchInput=new Ext.form.TextField({width:200,emptyText:gt.gettext("Enter a keyword")}),{xtype:"label",text:gt.gettext(" is found.")}]}]});return this.content;}});ECM.provide("ECM.Library.Store");ECM.Library.Store=Ext.extend(ECM.Data.ListStore.ListStore,{constructor:function(a){ECM.Library.Store.superclass.constructor.call(this,Ext.apply(a||{},{sortInfo:this.defaultSort||{field:"name",direction:"ASC"}}));}});ECM.provide("ECM.Library.Store.Content");ECM.Library.Store.Content=Ext.extend(ECM.Library.Store,{storeId:"library.content",proxy:new Ext.data.HttpProxy({url:"/cm/r/library/contents",method:"GET"}),constructor:function(a){ECM.Library.Store.Content.superclass.constructor.call(this,Ext.apply(a||{},{fields:[{name:"id"},{name:"name"},{name:"format"},{name:"affiliate_user_aff_user_name"},{name:"date_created",sortDir:"DESC"}],idIndex:0}));}});ECM.provide("ECM.Library.Store.DynamicContent");ECM.Library.Store.DynamicContent=Ext.extend(ECM.Library.Store,{storeId:"library.dynamiccontent",proxy:new Ext.data.HttpProxy({url:"/cm/r/library/dynamic_contents",method:"GET"}),constructor:function(a){ECM.Library.Store.DynamicContent.superclass.constructor.call(this,Ext.apply(a||{},{fields:[{name:"id"},{name:"name"},{name:"description"},{name:"affiliate_user_aff_user_name"},{name:"date_created",sortDir:"DESC"}],idIndex:0}));}});ECM.provide("ECM.Library.Store.DynamicContentSimple");ECM.Library.Store.DynamicContentSimple=Ext.extend(ECM.Library.Store,{storeId:"library.dynamiccontentsimple",proxy:new Ext.data.HttpProxy({url:"/cm/r/library/dynamic_contents/simple",method:"GET"}),constructor:function(a){ECM.Library.Store.DynamicContentSimple.superclass.constructor.call(this,Ext.apply(a||{},{fields:[{name:"id"},{name:"name"},{name:"description"},{name:"affiliate_user_aff_user_name"},{name:"date_created",sortDir:"DESC"}],idIndex:0}));}});ECM.provide("ECM.Library.Store.ImageUrl");ECM.Library.Store.ImageUrl=Ext.extend(ECM.Library.Store,{storeId:"library.imageurl",proxy:new Ext.data.HttpProxy({url:"/cm/r/library/image/urls",method:"GET"}),constructor:function(a){ECM.Library.Store.ImageUrl.superclass.constructor.call(this,Ext.apply(a||{},{fields:[{name:"name"},{name:"url"}],idIndex:0}));}});ECM.provide("ECM.Library.Store.Link");ECM.Library.Store.Link=Ext.extend(ECM.Library.Store,{storeId:"library.link",proxy:new Ext.data.HttpProxy({url:"/cm/r/library/links",method:"GET"}),constructor:function(a){ECM.Library.Store.Link.superclass.constructor.call(this,Ext.apply(a||{},{fields:[{name:"id"},{name:"name"},{name:"url"},{name:"type"},{name:"affiliate_user_aff_user_name"},{name:"date_created",sortDir:"DESC"}],idIndex:0}));}});ECM.provide("ECM.Form.ListViewComboBox");ECM.Form.ListViewComboBox=Ext.extend(Ext.form.ComboBox,{triggerAction:"all",mode:"local",valueField:"value",displayField:"displayText",editable:false,allowBlank:false,initComponent:function(){this.store=new Ext.data.ArrayStore({fields:[this.displayField,this.valueField],data:this._buildStore(this.items)});if(this.store.getCount()===0){throw new Ext.Error("No item to be selected");}this.value=this.store.getAt(this.selectedConfiguration||0).get(this.valueField);this.on("select",function(a,b){this.fireEvent("listselect",b.get(this.displayField),b.get(this.valueField));});ECM.Form.ListViewComboBox.superclass.initComponent.apply(this,arguments);this.addEvents("listselect");},_buildStore:function(a){var b=[];Ext.each(a,function(c){b.push([c.typeName,c.typeValue]);});return b;}});Ext.reg("ecm.listviewcombo",ECM.Form.ListViewComboBox);ECM.provide("ECM.Flyout");ECM.Flyout=Ext.extend(ECM.Window,{modal:false,resizable:false,draggable:false,closable:false,header:false,cls:"ecm-generic-window ecm-generic-window-no-title ecm-window",autoClose:true,controlButtons:[],constructor:function(a){Ext.apply(this,a);ECM.Flyout.superclass.constructor.call(this,a);},initComponent:function(){var a=this.controlButtons||[];if(a.length){this.bbar=this.createBBar(a);}ECM.Flyout.superclass.initComponent.apply(this);},createBBar:function(a){var b=new Ext.Toolbar({cls:"ecm-flyout-bottom-toolbar cm_button_group",items:["->",a]});return b;},afterRender:function(){ECM.Window.superclass.afterRender.call(this);this.setPosition(this.x,this.y);this.notify=this.items.itemAt(0).items.itemAt(0);},onRender:function(b,a){ECM.Window.superclass.onRender.call(this,b,a);this.el.addClass("ecm-flyout");this.proxy.addClass("ecm-flyout-proxy");},listeners:{show:function(){this.initAutoClose=true;Ext.EventManager.on(document,"click",this.checkClick,this);(function(){this.initAutoClose=false;}).defer(100,this);},hide:function(){Ext.EventManager.un(document,"click",this.checkClick,this);},close:function(){Ext.EventManager.un(document,"click",this.checkClick,this);}},checkCombo:function(c,b){var a=false;if(c.cascade){c.cascade(function(f){if(a){return false;}var d=this;if(d.getXType()=="combo"){if(d.innerList&&d.innerList.contains(f.getTarget())){a=true;return false;}}else{if(d.getXType()=="propertygrid"){if(!Ext.isEmpty(d.activeEditor)&&Ext.isDefined(d.activeEditor)){if(d.activeEditor.field.getXType()=="combo"&&d.activeEditor.field.innerList.contains(f.getTarget())){a=true;return false;}}}}},null,[b]);}return a;},checkClick:function(a){if(!this.initAutoClose&&this.autoClose&&!(a.within(this.getEl())||(a.target.attributes.parenttype&&a.target.attributes.parenttype.value=="flyout")||this.checkCombo(Ext.getCmp(this.getEl().id),a))){this[this.closeAction]();}}});ECM.provide("ECM.Tags.TagItem");ECM.Tags.TagItem=Ext.extend(Ext.Container,{enableRemoveButton:true,constructor:function(a){Ext.apply(this,a);ECM.Tags.TagItem.superclass.constructor.call(this,a);this.addEvents("removeitem");},initComponent:function(){this.layout="column";this.items=this.buildItems();ECM.Tags.TagItem.superclass.initComponent.call(this);},buildItems:function(){var a=[{xtype:"displayfield",value:this.displayTxt,columnWidth:0.8}];if(this.enableRemoveButton){a.push({xtype:"ecm.linkbutton",text:"X",cls:"ecm-linkbutton-delete-tagitem",columnWidth:0.2,handler:this.removeItem.createDelegate(this)});}return a;},removeItem:function(a,b){this.fireEvent("removeitem",this.displayTxt);this.destroy();}});Ext.reg("ecm.tagitem",ECM.Tags.TagItem);ECM.provide("ECM.Tags.TagsWindow");ECM.Tags.TagsWindow=Ext.extend(ECM.Flyout,{tags:[],itemsPerColumn:1,constructor:function(a){Ext.apply(this,a);ECM.Tags.TagsWindow.superclass.constructor.call(this,a);this.addEvents("removetag");},initComponent:function(){var a=this.buildTagList(this.tags,true);this.width=350;this.items=[a];this.controlButtons=[{xtype:"button",text:gt.gettext("Cancel"),cls:"blue_button",listeners:{scope:this,click:function(){this[this.closeAction]();}}}];ECM.Tags.TagsWindow.superclass.initComponent.call(this);},buildTagList:function(d,a){var c={id:"tagContainer",xtype:"container",layout:"column",items:[]};var b=[];Ext.each(d,function(g,f){if(f%this.itemsPerColumn===0&&f!==0){c.items.push({xtype:"container",columnWidth:0.5,items:b});b=[];}b.push({xtype:"ecm.tagitem",displayTxt:g,listeners:{scope:this,removeitem:function(h){this.fireEvent("removetag",h,f,this);
}}});},this);if(b.length>0){c.items.push({xtype:"container",columnWidth:0.5,items:b});}if(a){return c;}else{return c.items;}},refreshTags:function(c){var b=this.getComponent("tagContainer");b.removeAll();var a=this.buildTagList(c,false);if(a.length!==0){b.add(a);b.doLayout();this.syncShadow();}else{this[this.closeAction]();}}});Ext.reg("ecm.tagswindow",ECM.Tags.TagsWindow);ECM.provide("ECM.Form.ModalTagCloud");(function(){var a=10;ECM.Form.ModalTagCloud=Ext.extend(ECM.Flyout,{closeAction:"hide",libraryType:ECM.Rules.Constants.LIBRARY.ITEM.HTML,constructor:function(d){var g=this;g.nameField="value";g.addEvents("filter");g.selectedTag={};g.selectedTagBackup={};var h,b,f;if(d.libraryType===ECM.Rules.Constants.LIBRARY.ITEM.LINK){g.nameField="type";h="/cm/r/library/link/types";b=["type","count"];if(d.mailingType===ECM.Rules.Constants.MAILING.TRIGGERED){f=["library_link","type","!=","Social"];}}else{h=d.url||"/cm/r/tag/names";b=["value","count"];f=Ext.isDefined(d.filter)?d.filter:"";}var c=new Ext.LoadMask(Ext.getBody(),{msg:gt.gettext("Please wait..."),store:g.tagStore});g.tagStore=new Ext.data.ArrayStore({proxy:new Ext.data.HttpProxy({url:h,method:"GET"}),autoLoad:true,listeners:{scope:this,beforeload:function(j,k){g.notify.warn(gt.gettext("Retrieving data from server..."));g.pagingToolbar.disable();},load:function(k,j,l){g.notify.info(gt.gettext("Please select tags"));g.reloadCloud(k);g.pagingToolbar.enable();},exception:function(){g.notify.error(gt.gettext("Error: Server not responding, please try again later"));g.pagingToolbar.enable();}},baseParams:{start:0,limit:a,filter:Ext.isEmpty(f)?"":Ext.encode(f)},root:"data.data",totalProperty:"data.rows",fields:b,remoteSort:true,sortInfo:{field:g.nameField,direction:"ASC"}});g.pagingToolbar=new Ext.PagingToolbar({pageSize:a,buttonAlign:"left",hidden:d.libraryType===ECM.Rules.Constants.LIBRARY.ITEM.LINK,displayInfo:true,cls:"cloud_paging",store:g.tagStore,listeners:{render:function(j){j.refresh.hide();},change:function(m,j){var k="page"+j.activePage.toString();if(g.selectedTag.hasOwnProperty(k)){var l={};Ext.each(g.selectedTag[k],function(n){l[n.name]=true;});g.checkboxCloud.setValue(l);}}}});g.cloudContainer=new Ext.Container({cls:"cloud_container",hideBorders:true});g.items=[g.pagingToolbar,g.cloudContainer];g.windowButtons=[{xtype:"button",text:gt.gettext("Filter"),listeners:{scope:this,click:this.filter}},{xtype:"button",text:gt.gettext("Cancel"),handler:function(){g.selectedTag=g.selectedTagBackup;g[g.closeAction]();}}];ECM.Form.ModalTagCloud.superclass.constructor.apply(this,arguments);},filter:function(){this.selectedTagBackup=this.selectedTag;this.fireEvent("filter",this.getValue());},getValue:function(){var b=[];Ext.iterate(this.selectedTag,function(c,d,f){Ext.each(d,function(g){b.push(g.name);});});return b;},reloadCloud:function(c){var b=c.getRange();var d=this;var f=[];if(Ext.isObject(this.checkboxCloud)){this.checkboxCloud.destroy();}c.each(function(g){var h={itemId:g.get("id"),name:g.get(d.nameField),ctCls:"tag_cloud_box_ct",boxLabel:g.get(d.nameField)+" ("+g.get("count")+")"};f.push(h);},this);this.checkboxCloud=new Ext.form.CheckboxGroup({listeners:{change:function(g,h){var j=Math.ceil((d.pagingToolbar.cursor+d.pagingToolbar.pageSize)/d.pagingToolbar.pageSize);d.selectedTag["page"+j.toString()]=h;}},columns:2,vertical:true,items:f});this.cloudContainer.add(this.checkboxCloud);this.doLayout();}});})();ECM.provide("ECM.CMS.Nav.LibraryFilterContainer");ECM.CMS.Nav.LibraryFilterContainer=Ext.extend(ECM.CMS.Nav.LibraryFilterContainerUi,{shiftTagItemsBy:3,originalTreeHeight:0,constructor:function(a){Ext.apply(this,a);ECM.CMS.Nav.LibraryFilterContainer.superclass.constructor.call(this,a);this.addEvents("contentretrieved");},initComponent:function(){ECM.CMS.Nav.LibraryFilterContainer.superclass.initComponent.call(this);this.toggleFilterPanels(true);this.formFilterBtn.on("click",this.filterLibrary,this);var a=this;Ext.getCmp("cmsCenterRegionId").on("afterrender",function(){this.on("add",function(b,d,c){if(d.id==="contentPanelId"){d.un("addededitorpanels",a.attachDDController,a);if(a.hasListener("contentretrieved")){a.events.contentretrieved.clearListeners();}d.on("addededitorpanels",a.attachDDController,a);}});});this.on("bodyresize",function(){var c=this.getComponent("libraryFilterResultTree");if(Ext.isDefined(c)){this.setTreeContainerHeight(c);var b=Ext.getCmp("ecm-libraryfiltertree");if(b){b.setHeight(Math.min(this.originalTreeHeight,c.getInnerHeight()));}}});},attachDDController:function(a,c,b,g){var f=this;var d=[[ECM.Rules.Constants.LIBRARY.ITEM.HTML,g,a.htmlFrame],[ECM.Rules.Constants.LIBRARY.ITEM.RTF,b,a.richTextFrame],[ECM.Rules.Constants.LIBRARY.ITEM.TEXT,c,a.textFrame]];Ext.each(d,function(k,h){var j=k[0],m=k[1],l=k[2];if(Ext.isEmpty(m)||Ext.isEmpty(l)){return true;}m.dropTarget.notifyDrop=m.dropTarget.notifyDrop.createInterceptor(function(n,q,r){if(Ext.isEmpty(f.searchType)||f.ownerCt.collapsed||(f.searchType!==ECM.Rules.Constants.LIBRARY.ITEM.HTML&&f.searchType!==ECM.Rules.Constants.LIBRARY.ITEM.TEXT&&f.searchType!==ECM.Rules.Constants.LIBRARY.ITEM.RTF)){return true;}var p=a.getActiveEditor();var o=new Ext.LoadMask(m.getEl(),{msg:gt.gettext("Please wait while we retrieve your content...")});if(f.matchEditorAndType(p,f.searchType)){Ext.Msg.confirm(gt.gettext("Different content type detected"),gt.strargs(gt.gettext("Are you sure you'd like to use this content type for %1 content?"),(p==="html")?p.toUpperCase():p),function(s){if(s==="no"){return false;}else{f.getContent(r.node.attributes.objectId,o,this);}});}else{f.getContent(r.node.attributes.objectId,o,this);}return false;});});if(!f.hasListener("contentretrieved")){f.on("contentretrieved",function(h,m,k,l){var n;if(f.searchType===ECM.Rules.Constants.LIBRARY.ITEM.HTML&&a.activeTab.id=="htmleditor"){n=m.match(/<body[.\s\S]*?\>([\s\S]*?)<\/body\>/);}if(a.activeTab.id=="htmleditor"&&a.activeTab.activeTab.id==="extjseditor"){m=n?n[1]:m;var j=Ext.getCmp("extjseditor").getValue().replace(l.attributes.content,m+"\n");Ext.getCmp("extjseditor").setValue(j);}else{if(a.getActiveEditor()=="html"&&!Ext.isEmpty(a.getCodeMirrorActiveEditor().getValue())){m=n?n[1]:m;}a.getCodeMirrorActiveEditor().replaceRange(m+"\n",a.getCodeMirrorActiveEditor().getCursor());}});}},matchEditorAndType:function(b,a){if(b==="text"&&a!==ECM.Rules.Constants.LIBRARY.ITEM.TEXT){return true;}else{if(b==="html"&&a!==ECM.Rules.Constants.LIBRARY.ITEM.HTML){return true;}else{if(b==="richtext"&&a!==ECM.Rules.Constants.LIBRARY.ITEM.RTF){return true;}else{return false;}}}},getContent:function(a,c,b,f){var d=this;if(Ext.isDefined(c)){c.show();}ECM.Ajax.request({method:"GET",url:"/cm/r/library/content",params:{id:a},success:function(g,h){if(Ext.isDefined(c)){c.hide();}var j=g.responseJSON.data;if(Ext.isEmpty(j)){Ext.Msg.alert(gt.gettext("Data not found"),gt.gettext("This content might have been deleted."));return false;}d.fireEvent("contentretrieved",this,j.content,b,f);},failure:function(g,j){if(Ext.isDefined(c)){c.hide();}var h=g.responseJSON&&!Ext.isEmpty(g.responseJSON.error)?g.responseJSON.error[0]:gt.gettext("Lost communication with the server.");Ext.Msg.confirm(gt.gettext("Unable to retrieve content"),h+" "+gt.gettext("Would you like to try again?"),function(k){if(k==="yes"){d.getContent(a,c,b,f);}return false;});}});},filterLibrary:function(){this.resetFilterResults();this.getFilterFormValues();this.buildFilterQuery();this.toggleFilterPanels();this.getFilterResults();this.setFilterResultValues();},resetFilterResults:function(){var a=["tagCloud","linkCloud"];Ext.each(a,function(b){if(Ext.isDefined(this[b])){this[b].hide();}},this);this.resultTagsCtn.removeAll();this.resultTagsCtn.doLayout();this.resultNameDsp.setValue(gt.gettext("None"));this.setTreeContainerHeight(this.getComponent("libraryFilterResultTree"));},getFilterFormValues:function(){this.searchType=this.formContentTypeCbx.getValue();this.searchTags=(!Ext.isEmpty(this.formTagsTxf.getValue()))?Ext.util.Format.htmlEncode(this.formTagsTxf.getValue()).split(","):"";
if(!Ext.isEmpty(this.searchTags)){Ext.each(this.searchTags,function(c,a,b){if(b.length===this.searchTags.length){this.searchTags=[];}if(!Ext.isEmpty(c)){this.searchTags.push(c.trim());}},this);this.searchTags=Ext.unique(this.searchTags);this.searchTags.remove("");}this.searchText=Ext.util.Format.htmlEncode(this.formTextTxf.getValue());},buildFilterQuery:function(){var b=[],d,a=["cor"],c=["or"];switch(this.searchType){case ECM.Rules.Constants.LIBRARY.ITEM.HTML:b.push(["library_content","format","=","HTML"]);break;case ECM.Rules.Constants.LIBRARY.ITEM.RTF:b.push(["library_content","format","=","Rich Text"]);break;case ECM.Rules.Constants.LIBRARY.ITEM.TEXT:b.push(["library_content","format","=","Text"]);break;case ECM.Rules.Constants.LIBRARY.ITEM.LINK:if(this.mtype===ECM.Rules.Constants.MAILING.TRIGGERED){b.push(["library_link","type","!=","Social"]);}break;}if(!Ext.isEmpty(this.searchTags)){Ext.each(this.searchTags,function(f){if(this.searchType===ECM.Rules.Constants.LIBRARY.ITEM.LINK){a.push(["library_link","type","=",f]);}else{a.push(["tag","value","=",f]);}},this);b.push(a);}if(!Ext.isEmpty(this.searchText)){switch(this.searchType){case ECM.Rules.Constants.LIBRARY.ITEM.DYNAMIC_CONTENT:d="library_dynamic_content";c.push([d,"description","matches",this.searchText]);break;case ECM.Rules.Constants.LIBRARY.ITEM.IMAGE:d="library_image";c.push([d,"file_name","matches",this.searchText]);break;case ECM.Rules.Constants.LIBRARY.ITEM.LINK:d="library_link";c.push([d,"url","matches",this.searchText]);break;default:d="library_content";c.push([d,"format","matches",this.searchText]);break;}c.push([d,"name","matches",this.searchText]);c.push(["affiliate_user","aff_user_name","matches",this.searchText]);b.push(c);}if(b.length>1){this.filterQuery=Ext.encode(["and"].concat(b));}else{if(b.length===1){this.filterQuery=Ext.encode(b[0]);}else{this.filterQuery="";}}return this.filterQuery;},getFilterResults:function(){var d={limit:"",filter:this.filterQuery},c=this.getComponent("libraryFilterResultTree"),b={scope:this,beforeload:function(){this.setTreeContainerHeight(c);},exception:function(){Ext.Msg.confirm(gt.gettext("Library filtering failure"),gt.gettext("Unable to load library assets. Would you like to try again?"),function(f){if(f==="yes"){this.getFilterResults();}},this);c.removeAll();this.tree=this.buildResultTree();c.add(this.tree);c.doLayout();},load:function(g,f){this.data=f;c.removeAll();this.tree=this.buildResultTree();c.add(this.tree);c.doLayout();}};switch(this.searchType){case ECM.Rules.Constants.LIBRARY.ITEM.DYNAMIC_CONTENT:if(this.mtype===2){this.store=new ECM.Library.Store.DynamicContentSimple({listeners:b,baseParams:d});}else{this.store=new ECM.Library.Store.DynamicContent({listeners:b,baseParams:d});}break;case ECM.Rules.Constants.LIBRARY.ITEM.IMAGE:this.store=new ECM.Library.Store.ImageUrl({listeners:b,baseParams:d});break;case ECM.Rules.Constants.LIBRARY.ITEM.LINK:this.store=new ECM.Library.Store.Link({listeners:b,baseParams:d});break;default:this.store=new ECM.Library.Store.Content({listeners:b,baseParams:d});break;}var a=new Ext.LoadMask("libraryFilterResultTree",{store:this.store});this.store.load();},setFilterResultValues:function(){this.resultContentTypeDsp.setValue(this.formContentTypeCbx.getRawValue());var a={scope:this,removeitem:this.removeTag};if(!Ext.isEmpty(this.searchTags)){Ext.each(this.searchTags,function(c,b){if(b<this.shiftTagItemsBy){this.resultTagsCtn.add(new ECM.Tags.TagItem({displayTxt:c,listeners:a}));}},this);if(this.searchTags.length>this.shiftTagItemsBy){this.resultTagsCtn.add(this.resultMoreTagLnk=new ECM.Form.LinkButton({id:"moreTagLink",text:gt.gettext("More tags &raquo;"),fieldLabel:" ",labelSeparator:" ",columnWidth:1,handler:this.buildMoreTagsWindow.createDelegate(this,[this.searchTags])}));}}else{this.resultTagsCtn.add(new ECM.Tags.TagItem({displayTxt:gt.gettext("None"),enableRemoveButton:false,listeners:a}));}this.resultTagsCtn.doLayout();if(!Ext.isEmpty(this.searchText)){this.resultNameDsp.setValue(this.searchText);}},buildResultTree:function(){var f=[],d,l=[];var h=Ext.util.Format.htmlEncode;if(this.data.length===0){f.push({text:gt.gettext("No library items match filter criteria"),draggable:false,content:"",leaf:true});}else{var g={text:"<b>"+this.formContentTypeCbx.getRawValue()+"</b>",draggable:false,expandable:true,expanded:true,leaf:false,children:[]};switch(this.searchType){case ECM.Rules.Constants.LIBRARY.ITEM.HTML:case ECM.Rules.Constants.LIBRARY.ITEM.RTF:case ECM.Rules.Constants.LIBRARY.ITEM.TEXT:Ext.each(this.data,function(o){var m=ECM.DomHelper.ellipsis({width:130,text:h(o.data.name)});var n={text:m.text,leaf:true,content:"["+o.data.name+"]",objectId:o.data.id};if(m.truncated){n.qtipCfg={text:o.data.name};}g.children.push(n);});f.push(g);break;case ECM.Rules.Constants.LIBRARY.ITEM.DYNAMIC_CONTENT:Ext.each(this.data,function(o){var m=ECM.DomHelper.ellipsis({width:120,text:o.data.name});var n={text:"d_"+m.text,id:"libItem_"+o.data.name,leaf:true,content:(this.mtype===2)?"%%d_"+o.data.name+"[]%%":"%%d_"+o.data.name+"%%",dcTagSource:"library",checked:false,qtipCfg:{text:o.data.description}};n.qtipCfg.title=m.truncated?"d_"+o.data.name:undefined;g.children.push(n);},this);f.push(g);break;case ECM.Rules.Constants.LIBRARY.ITEM.IMAGE:Ext.each(this.data,function(p,n){var m=ECM.DomHelper.ellipsis({width:100,text:h(p.data.name)});d='<span><div class="leftnav_treepanel_link leftnav_dcmap"><a id="img-map-'+n+'" href="#">Map</a></div></span>';var o={text:m.text+d,type:"image",leaf:true,content:'<img src="'+p.data.url+'" alt="" />',textContent:p.data.url,ddText:m.text};if(m.truncated){o.qtipCfg={text:p.data.name};}g.children.push(o);});f.push(g);break;case ECM.Rules.Constants.LIBRARY.ITEM.LINK:var k=["Unsub","RAF","Web View","Mobile View"],b=[];if(this.mtype!==ECM.Rules.Constants.MAILING.TRIGGERED){k.push("Social");}Ext.each(k,function(m){b.push({linkType:m,data:this.store.query("type",m)});},this);Ext.each(b,function(n){var m={text:"<b>"+n.linkType+"</b>",draggable:false,expandable:true,expanded:true,leaf:false,children:[]};n.data.each(function(q){var o=ECM.DomHelper.ellipsis({width:130,text:h(q.data.name)});var p={text:o.text,leaf:true,type:"link",content:n.linkType=="Social"?q.data.url:'<a href="'+q.data.url+'">'+h(q.data.name)+"</a>",textContent:q.data.url,qtipCfg:{text:q.data.url}};p.qtipCfg.title=o.truncated?q.data.name:undefined;m.children.push(p);});f.push(m);});break;}}var j=new Ext.tree.AsyncTreeNode({text:gt.gettext("Library Assets"),draggable:false,expanded:true,editable:false,children:f}),c=[{text:gt.gettext("Copy to Mailing"),cls:"blue_button",scope:this,handler:function(){var p=this;if(l.length){var n=[];var r=ECM.Form.DCEditor.data("DC")[0];var m=[];Ext.each(l,function(s){if(r[("d_"+s).toUpperCase()]){m.push(s);}else{n.push({name:s,name_copy:s,to_mid:p.mid,overwrite:1});}});var q=false;if(m.length>0){var o=m.length===1?"d_"+m[0]:"d_"+m.join(", d_");Ext.Msg.show({title:gt.gettext("Overwrite"),msg:gt.strargs(gt.ngettext('Dynamic Content tag "%1" already exists in this mailing. ','Dynamic Content tags "%1" already exist in this mailing. ',m.length),[o])+'<br/><br/><input id="dc_overwrite" type="checkbox" /> '+gt.gettext("Overwrite all conflicting tags"),buttons:Ext.Msg.OKCANCEL,width:500,fn:function(s){if(s==="ok"){if(Ext.select("#dc_overwrite").elements[0].checked){Ext.each(m,function(t){n.push({name:t,name_copy:t,to_mid:p.mid,overwrite:1});});}if(n.length>0){p.libToMailing(n);}else{Ext.Msg.alert(gt.gettext("No Selections"),gt.gettext("No Dynamic Content tags to copy"));}}}});}else{p.libToMailing(n);}}else{Ext.Msg.alert(gt.gettext("No Selections"),gt.gettext("No Dynamic Content tags were selected to copy."));}}}],a=new Ext.tree.TreePanel({id:"ecm-libraryfiltertree",containerScroll:true,autoScroll:true,enableDrag:true,ddGroup:"DCZone",rootVisible:false,root:j,buttons:(this.searchType===ECM.Rules.Constants.LIBRARY.ITEM.DYNAMIC_CONTENT&&this.data.length)?c:"",listeners:{scope:this,dragdrop:function(n,q,m){if(Ext.isEmpty(this.searchType)||(this.searchType!==ECM.Rules.Constants.LIBRARY.ITEM.HTML&&this.searchType!==ECM.Rules.Constants.LIBRARY.ITEM.TEXT&&this.searchType!==ECM.Rules.Constants.LIBRARY.ITEM.RTF)){return true;
}if(Ext.getCmp("contentPanelId")){var p=Ext.getCmp("contentPanelId").getActiveEditor();var o=new Ext.LoadMask(Ext.getCmp("contentPanelId").getActiveTab().getEl(),{msg:gt.gettext("Please wait while we retrieve your content...")});if(this.searchType!==ECM.Rules.Constants.LIBRARY.ITEM.HTML){Ext.Msg.confirm(gt.gettext("Different content type detected"),gt.strargs(gt.gettext("Are you sure you'd like to use this content type for %1 content?"),(p==="html")?p.toUpperCase():p),function(s){if(s==="no"){var r=Ext.getCmp("extjseditor").getValue().replace(q.attributes.content,"");Ext.getCmp("extjseditor").setValue(r);}else{this.getContent(q.attributes.objectId,o,n,q);}},this);}else{this.getContent(q.attributes.objectId,o,n,q);}}},startdrag:function(m,p,o){if(Ext.isEmpty(this.searchType)||this.searchType!==ECM.Rules.Constants.LIBRARY.ITEM.IMAGE){return true;}try{m.dragZone.proxy.update("");var r=p.ui.elNode.cloneNode(true);var n=Ext.isIE?r.children[3].firstChild:r;n.removeChild(n.lastChild);n.lastChild.innerHTML=p.attributes.ddText;m.dragZone.proxy.ghost.dom.appendChild(r);}catch(q){}},afterrender:function(m){this.originalTreeHeight=m.getHeight();this.setTreeContainerHeight(m);if(this.searchType===ECM.Rules.Constants.LIBRARY.ITEM.IMAGE){Ext.each(this.data,function(o,n){Ext.fly("img-map-"+n).on("click",function(){if(Ext.isDefined(this.mapToContent)){this.mapToContent.close();this.mapToContent.destroy();}this.mapToContent=new ECM.CMS.Nav.MapToContent({data:o.data});this.mapToContent.show();},this);},this);}},checkchange:function(n,m){if(m){l.push(n.getUI().node.id.substring(8));}else{l.remove(n.getUI().node.id.substring(8));}}}});return a;},libToMailing:function(a){var c=this;var b=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Copying...")});Ext.get("cm_wrapper").setHeight(ECM.CMS.STANDARD_LOADING_HEIGHT);b.show();ECM.Ajax.request({url:"/cm/r/library/dynamic_content?action=copy",method:"POST",params:{batch:Ext.encode(a)},success:function(d){b.hide();c.publish("/cms/leftnav/dc/refresh");Ext.Msg.alert(gt.gettext("Copy Confirmation"),gt.gettext("Copy to mailing has been completed for the selected dynamic content element(s)."));},failure:function(d){b.hide();this.publish("/cms/error/add",{message:gt.gettext("Failed to copy Dynamic Content tags. Please try again.")});}});},buildMoreTagsWindow:function(a){a=this.shiftTags(a,this.shiftTagItemsBy);if(Ext.isDefined(this.tagsWindow)){this.tagsWindow.destroy();}this.tagsWindow=new ECM.Tags.TagsWindow({tags:a,x:this.getPosition()[0]+this.getInnerWidth(),y:this.resultMoreTagLnk.getPosition()[1]});this.tagsWindow.on("removetag",this.removeTag,this);this.tagsWindow.show();},shiftTags:function(c,b){var a=c.map(function(d){return d;});Ext.each(a,function(f,d){if(d<this.shiftTagItemsBy){a.shift();}},this);return a;},removeTag:function(c,b,a){if(this.searchTags.indexOf(c)!==-1){this.searchTags.remove(c);if(a instanceof ECM.Tags.TagsWindow){a.refreshTags(this.shiftTags(this.searchTags,this.shiftTagItemsBy),b);}this.resetFilterResults();this.buildFilterQuery();this.getFilterResults();this.setFilterResultValues();}else{throw new Ext.Error("Unable to remove tag. Tag does not exist or may have already been removed.");}},setFormTagsTxf:function(d){var b=[],c=[];b=this.formTagsTxf.getValue().split(",");Ext.each(b,function(f){c.push(f.trim());});c=Ext.unique(c.concat(d));c.remove("");this.formTagsTxf.setValue(c);var a=["tagCloud","linkCloud"];Ext.each(a,function(f){if(Ext.isDefined(this[f])){this[f].hide();}},this);},setTreeContainerHeight:function(d){var c=this.ownerCt.getInnerHeight(),a=this.getComponent("libraryFilterResult").getInnerHeight(),b=d.id==="ecm-libraryfiltertree"?Math.min(Math.max(this.originalTreeHeight,50),c-a):c-a;d.setHeight(b);this.getComponent("libraryFilterResultTree").setHeight(c-a);}});Ext.reg("ecm.libraryfilter",ECM.CMS.Nav.LibraryFilterContainer);ECM.provide("ECM.CMS.Nav.SendReportSchedule");ECM.CMS.Nav.SendReportSchedule=Ext.extend(Ext.Container,{cls:"schedule_recur_container",width:600,autoHeight:true,hideMode:"offsets",nextId:function(){var a=0;return function(){return a++;};}(),constructor:function(a){var b=[["hours",gt.gettext("hour(s)")],["days",gt.gettext("day(s)")]];this.iGotFocus=false;this.toSaveSchedule=false;this.toCancelSchedule=false;this.sendReportStore=new Ext.data.ArrayStore({data:b,fields:["id","option"],idIndex:0});this.items=[this.buildSendObject(this.nextId())];Ext.apply(this,a);ECM.CMS.Nav.SendReportSchedule.superclass.constructor.call(this);},reset:function(){this.removeAll();this.items.add(this.buildSendObject(this.nextId()));this.doLayout();},addRow:function(){this.items.add(this.buildSendObject(this.nextId()));this.doLayout();},removeRow:function(a){this.remove(a);if(this.items.length===1){if(this.items.items[0].delay_hour.getValue().length===0){this.items.items[0].deleteLink.disable();}}this.doLayout();},getValue:function(){var c="";for(var b=0;b<this.items.length;b++){if(this.items.items[b].delay_hour.isValid()){var a=this.items.items[b].delay_hour.getValue();if(a){if(this.items.items[b].hoursOrDays.getValue()==="days"){a=a*24;}c+=a+",";}}else{ECM.publish("/cms/error/add",{message:gt.gettext("Please enter a whole number between 1 and 180.")});return undefined;}}return c;},setValue:function(c){if(!c){return false;}var a=c.split(",");this.setSched(this.items.items[0],a[0]);if(a.length>1){for(var b=1;b<a.length;b++){var d=this.buildSendObject(this.nextId());this.setSched(d,a[b]);this.items.add(d);}}this.items.add(this.buildSendObject(this.nextId()));this.doLayout();},setSched:function(b,a){if((a<24)||(a%24!==0)){b.delay_hour.setValue(a);}else{b.delay_hour.setValue(a/24);b.hoursOrDays.setValue("days");}},maintainRows:function(){if(this.toSaveSchedule||this.toCancelSchedule){return;}var c=[];for(var b=0;b<this.items.items.length;b++){if(this.items.items[b].delay_hour.getValue().length===0){c.push(this.items.items[b].id);}}if(c.length===0){this.addRow();}else{for(var a=0;a<(c.length-1);a++){this.removeRow(c[a]);}}},buildSendObject:function(c){var b=this;var a="container_"+c;return new Ext.Container({id:a,layout:"toolbar",defaultType:"spacer",style:{"padding-bottom":"5px"},items:[{width:10},{xtype:"textfield",width:50,maskRe:/[0-9]/,maxLength:3,autoCreate:{tag:"input",type:"text",maxlength:"3"},ref:"delay_hour",invalidText:gt.gettext("Please enter a whole number between 1 and 180."),validator:function(d){if(b.items.length===1){if(d.length===0){this.ownerCt.deleteLink.disable();}else{this.ownerCt.deleteLink.enable();}}if(d&&this.nextSibling().nextSibling().getValue()==="days"){if((d>=1)&&(d<=180)){return true;}else{return false;}}return true;},listeners:{invalid:function(){ECM.publish("/cms/error/add",{message:gt.gettext("Please enter a whole number between 1 and 180.")});if(b.items.length===1){this.ownerCt.deleteLink.disable();}},blur:function(){b.maintainRows();b.iGotFocus=false;b.toSaveSchedule=false;b.toCancelSchedule=false;},focus:function(){b.iGotFocus=true;}}},{width:5},{xtype:"combo",width:70,mode:"local",store:b.sendReportStore,displayField:"option",valueField:"id",value:"hours",typeAhead:true,triggerAction:"all",ref:"hoursOrDays",listeners:{select:function(f,g,d){if(this.ownerCt.delay_hour.getValue()){this.ownerCt.delay_hour.validate();}}}},{width:20},{xtype:"label",text:gt.gettext("after deployment")},{width:5},{xtype:"label",html:'<span id="delete-send-rpt" parenttype="flyout">'+gt.gettext("Delete")+"</span>;",ref:"deleteLink",disabled:(c===0)?true:false,listeners:{afterrender:function(){this.el.on("click",function(){var d=b.items.length;if(d===1){this.ownerCt.delay_hour.setValue("");this.disable();}else{b.removeRow(a);}},this);}}}]});}});Ext.reg("ecm.sendreportschedule",ECM.CMS.Nav.SendReportSchedule);ECM.provide("ECM.CMS.Nav.ScheduleFlyout");var autoHeightScheduleFlyout=true;ECM.CMS.Nav.ScheduleFlyout=Ext.extend(ECM.Flyout,{id:"scheduleMailingWindow",width:660,autoHeight:autoHeightScheduleFlyout,closeAction:"hide",cls:"ecm-generic-window-no-title",modal:true,autoClose:false,scheduleOption:{UNSCHEDULED:0,SEND_ONCE:1,SEND_ON_DAY_OF_WEEK:2,SEND_ON_DAY_OF_MONTH:3,SEND_ON_DAY_FROM_END_OF_MONTH:4,SEND_EVERY_N_DAYS:5},createEmailStore:function(){return new Ext.data.ArrayStore({autoDestroy:true,data:{},sortInfo:{field:"email",direction:"ASC"},fields:["id","email"]});
},constructor:function(a){if(!a.mid){throw new Ext.Error(gt.gettext("Mailing ID is missing, cannot show Schedule window."));}Ext.apply(this,a);ECM.CMS.Nav.ScheduleFlyout.superclass.constructor.call(this);},initComponent:function(){this.availEmailStore=this.createEmailStore();this.selectedEmailStore=this.createEmailStore();this.addEvents("beforerequest","afterrequest");ECM.subscribe("/cms/error/add",function(a){if(a.message){this.notify.error(a.message);}},this);this.buildMainPanel();ECM.CMS.Nav.ScheduleFlyout.superclass.initComponent.call(this);},afterRender:function(){ECM.CMS.Nav.ScheduleFlyout.superclass.afterRender.call(this);var b=new Ext.LoadMask(this.el,{msg:gt.gettext("Loading schedule...")});var a=new Ext.LoadMask(this.el,{msg:gt.gettext("Save schedule...")});this.on("beforerequest",b.show,b);this.on("afterrequest",b.hide,b);this.on("beforesave",a.show,a);this.on("aftersave",a.hide,a);this.on("show",this.loadData,this);},validateInput:function(d){if((this.optOneTime.getValue()===false)&&(this.optRecurring.getValue()===false)){return true;}if(!this.startDate.isValid()){this.notify.error(gt.gettext("Please set a valid start mailing date - it must be in the format MM/DD/YYYY"));return false;}if((d.startHour<0||d.startHour>23)){this.notify.error(gt.gettext("Please set a valid start mailing time."));return false;}if((d.startMinute<0||d.startMinute>59)){this.notify.error(gt.gettext("Please set a valid start mailing time."));return false;}var c=Ext.isNumber(d.startHour);var a=Ext.isNumber(d.startMinute);if((!c&&a)||(c&&!a)){this.notify.error(gt.gettext("You have not completed the start mailing time!"));return false;}else{if(c&&a&&!d.startDate){this.notify.error(gt.gettext("You have not set a valid start mailing date!"));return false;}else{if(!c&&!a&&d.startDate){this.notify.error(gt.gettext("You have not set a valid start mailing time!"));return false;}}}if(d.startDate&&c&&a){d.startDate.setHours(d.startHour);d.startDate.setMinutes(d.startMinute);}if(this.optRecurring.getValue()){if(!d.optRecurrence[0]&&!d.optRecurrence[1]&&!d.optRecurrence[2]){this.notify.error(gt.gettext("Please ensure that scheduled dates exist, are in the future, and that days of the week are specified if necessary."));return false;}if(d.optRecurrence[0]&&(this.dayOfWeek.getValue().length===0)){this.notify.error(gt.gettext("You selected the daily recurrence option but have not chosen any day of week."));return false;}if(d.optRecurrence[1]&&(!this.monthDay.getValue())){this.notify.error(gt.gettext("You have not selected the day of month."));return false;}if(d.optRecurrence[2]&&(!this.nDays.getValue())){this.notify.error(gt.gettext("You have not entered the number of days beginning on the start date."));return false;}if(d.endDate==="yes"){if(!this.specifiedEndDate.isValid()){this.notify.error(gt.gettext("Please set a valid end date - it must be in the format MM/DD/YYYY"));return false;}if(!d.specifiedEndDate){this.notify.error(gt.gettext("You have not selected an end date."));return false;}}if((!d.startDate)&&!c&&!a){this.notify.error(gt.gettext("You selected a recurring mailing but did not set the start mailing date/time"));return false;}if((this.optRecurring.getValue())&&(d.endDate==="yes")&&(d.startDate)){if(this.specifiedEndDate.getValue().getTime()<=this.startDate.getValue().getTime()){this.notify.error(gt.gettext("You have specified an end date that is earlier than mailing scheduled start date"));return false;}}}var b=this.scheduleReportSection.scheduleSend.getValue();if(b===undefined){return false;}else{if(b===""){if((this.selectedEmailStore.getCount()>0)||(this.additionalEmail.getValue().length>0)){this.notify.error(gt.gettext("You have entered a mailing report recipient but have not entered a time for your report(s) to be scheduled.")+"<BR>"+gt.gettext("Please enter a report schedule."));return false;}}}return true;},composeParams:function(f){var a={};a.mid=this.mid;a.mtype=this.mtype||1;if((!f.startDate)&&!Ext.isNumber(f.startHour)&&!Ext.isNumber(f.startMinute)){a.send_year=this.data.send_year;a.send_month=this.data.send_month;a.send_day=this.data.send_day;a.recur=this.scheduleOption.UNSCHEDULED;}else{a.send_day=f.startDate.format("j");a.send_month=f.startDate.format("n");a.send_year=f.startDate.format("Y");a.hour=f.startHour;a.minute=f.startMinute;if(this.optOneTime.getValue()){a.recur=this.scheduleOption.SEND_ONCE;}else{a.start_year=a.send_year;a.start_month=a.send_month;a.start_day=a.send_day;a.every_hour=a.hour;a.every_minute=a.minute;if(f.endDate==="yes"){a.nostop=0;a.end_day=f.specifiedEndDate.format("j");a.end_month=f.specifiedEndDate.format("n");a.end_year=f.specifiedEndDate.format("Y");}else{a.nostop=1;a.end_day=a.send_day;a.end_month=a.send_month;a.end_year=a.send_year;}if(f.optRecurrence[0]){a.recur=this.scheduleOption.SEND_ON_DAY_OF_WEEK;var d=[];Ext.each(f.weekDay,function(h,g){d.push(h.boxLabel);});a.weekday=[];for(var b=0;b<this.weekDaysLabel.length;b++){if(d.indexOf(this.weekDaysLabel[b])!==-1){a.weekday.push(b);}}}if(f.optRecurrence[1]){a.monthend=f.monthend;a.monthday=f.monthday;a.recur=this.scheduleOption.SEND_ON_DAY_OF_MONTH;}if(f.optRecurrence[2]){a.recur=this.scheduleOption.SEND_EVERY_N_DAYS;a.days=f.days;}}}a.to_select=[];if(this.selectedEmailStore.getCount()>0){this.selectedEmailStore.each(function(g){a.to_select.push(g.get("id"));});}a.additional_names=this.additionalEmail.getValue();a.save_address=this.saveReportAddr.getValue()?1:0;var c=this.scheduleReportSection.scheduleSend.getValue();a.sched=c?c:0;return a;},saveSchedule:function(){var c=this.scheduleMailingSection.getForm().getFieldValues();if(!this.validateInput(c)){return;}var b=this.composeParams(c);var a=this;a.fireEvent("beforesave",a);a.saveButton.disable();ECM.Ajax.request({url:"/cm/mailing/schedule/save",method:"POST",params:b,success:function(f,g){a.fireEvent("aftersave",a);var d=f.responseJSON;if(Ext.isDefined(d.application_errors)&&d.application_errors.length>0){a.notify.error(gt.gettext("Failed to save schedule information. Please retry later."));a.saveButton.disable();}else{a.clearSchedule();a[a.closeAction]();a.scheduleMailingSection.note.removeAll();a.publish("/cms/schedule/update");}},failure:function(f,g){a.fireEvent("aftersave",a);var d=f.responseJSON;if(d&&Ext.isDefined(d.error)&&d.error.length>0){a.notify.error(d.error[0]);}else{a.notify.error(gt.gettext("There is an unexpected network error. Please retry later."));}a.saveButton.enable();}});},initSchedule:function(){this.clearSchedule();this.clearButton.disable();},clearSchedule:function(){this.scheduleMailingSection.getForm().reset();this.optOneTime.setValue(true);this.optRecurring.setValue(false);this.notify.clear();this.saveButton.enable();this.recurrenceContainer.setVisible(false);if(this.recurDaily.getValue()){this.recurDaily.setValue(false);}if(this.specifiedEndDate.isVisible()){this.specifiedEndDate.setVisible(false);}if(this.selectedEmailStore.getCount()>0){var a=[];this.selectedEmailStore.each(function(c){a.push(c);});for(var b=0;b<a.length;b++){this.selectedEmailStore.remove(a[b]);this.availEmailStore.addSorted(a[b]);}}this.saveReportAddr.setValue(false);this.additionalEmail.setValue("");this.scheduleReportSection.scheduleSend.reset();},displaySLTNote:function(c){var a='<div style="font-size: smaller;"><span style="font-weight: bold;">'+gt.gettext("Note")+":</span>";if(Ext.isDefined(c.subject_line_test_started)&&(c.subject_line_test_started)){if(Ext.isDefined(c.winning_criteria_short_description)&&(c.winning_criteria_short_description)){a+=gt.gettext("no ")+c.winning_criteria_short_description+gt.gettext(" data was generated. A winning mailing could not be chosen. Return to the Subject Line Test page to manually deploy a mailing to the remainder.");}else{a+='<span class="cm_error">['+gt.gettext("Subject Line Test in progress")+"]</span>";}a+="<br>"+gt.gettext('When test mailings have completed, please go to Settings page and click "Send Remainder"');}else{a+=gt.gettext("All mailings within this subject line test will go out at the same time, with the exception of the test winner if one is assigned.");
}a+="<br>"+gt.gettext("Subject lines included are")+":<br><ul>";if(Ext.isDefined(c.slt_subjects)){for(var b=0;b<c.slt_subjects.length;b++){a+="<li>"+c.slt_subjects[b];}}a+="</ul></div>";this.scheduleMailingSection.note.removeAll();this.scheduleMailingSection.note.add(new Ext.form.Label({html:a}));this.scheduleMailingSection.note.setVisible(true);this.doLayout();},loadSchedule:function(g){this.data=g;this.addDayOfWeekLabel(g);if(Ext.isDefined(g.subject_line_test)&&g.subject_line_test){this.displaySLTNote(g);this.optRecurring.setVisible(false);this.recurrenceContainer.setVisible(false);}else{this.optRecurring.setVisible(true);}if(Ext.isDefined(g.first_time)&&g.first_time){this.clearButton.setVisible(false);}else{this.clearButton.setVisible(true);this.clearButton.enable();}this.mailingOptions.reset();if((g.recur>this.scheduleOption.SEND_ONCE)&&(g.recur<=this.scheduleOption.SEND_EVERY_N_DAYS)){this.optRecurring.setValue(true);}switch(g.recur){case this.scheduleOption.UNSCHEDULED:this.initSchedule();break;case this.scheduleOption.SEND_ONCE:this.optOneTime.setValue(true);break;case this.scheduleOption.SEND_ON_DAY_OF_WEEK:if(g.weekday){this.recurDaily.setValue(true);this.dayOfWeek.setValue(g.weekday);}break;case this.scheduleOption.SEND_ON_DAY_OF_MONTH:case this.scheduleOption.SEND_ON_DAY_FROM_END_OF_MONTH:this.recurNDayFromMonth.setValue(true);this.monthDay.setValue(g.monthday);this.startEndMonth.setValue(g.monthend);break;case this.scheduleOption.SEND_EVERY_N_DAYS:this.recurNDayFromStart.setValue(true);this.nDays.setValue(g.days);break;default:this.clearSchedule();this.notify.error(gt.gettext("There is an unexpected error. Please retry later"));return;}if(g.last_sent&&(g.last_sent.length>0)&&g.last_sent_desc&&(g.last_sent_desc.length>0)){this.notify.info(gt.gettext("Last sent: ")+g.last_sent_desc);}if(Ext.isDefined(g.tz)&&(g.tz.length>0)){this.timezone.setText(g.tz);}if(g.recur>this.scheduleOption.UNSCHEDULED){var b=new Date(g.send_year+"/"+g.send_month+"/"+g.send_day);this.startDate.setValue(b);this.startHour.setValue(g.hour);this.startMinute.setValue(g.minute);}if(g.recur>this.scheduleOption.SEND_ONCE){if((g.end_year===g.send_year)&&(g.end_month===g.send_month)&&(g.end_day===g.send_day)){this.endDate.setValue("no");}else{this.endDate.setValue("yes");this.specifiedEndDate.setVisible(true);var h=new Date(g.end_year+"/"+g.end_month+"/"+g.end_day);this.specifiedEndDate.setValue(h);}}var j=[];if(g.additional_emails&&(g.additional_emails.length>0)){j=g.additional_emails.split(",");}var f=[];var a=[];var c=[];var d=g.addresses;var l;for(l in d){if(d.hasOwnProperty(l)){if((g.recipients.indexOf(d[l].EMAIL_ID)!==-1)||(j.indexOf(l)!==-1)){a.push([l,l]);c.push(l);}else{f.push([l,l]);}}}if(j.length>0){var k=[];Ext.each(j,function(n,m){if(c.indexOf(n)===-1){k.push(n);}});if(k.length>0){this.additionalEmail.setValue(k.join(","));}}this.availEmailStore.loadData(f);this.selectedEmailStore.loadData(a);if(g.schedule_times){this.scheduleReportSection.scheduleSend.setValue(g.schedule_times);}},loadData:function(){var a=this;a.fireEvent("beforerequest",a);ECM.Ajax.request({url:"/cm/mailing/schedule/load",method:"POST",params:{mid:a.mid,mtype:a.mtype||1},success:function(c,d){var b=c.responseJSON;if(Ext.isDefined(b.application_errors)&&b.application_errors.length>0){a.notify.error(gt.gettext("Failed to load schedule information. Please retry later."));a.saveButton.disable();}else{a.loadSchedule(b.data);}a.fireEvent("afterrequest",a);},failure:function(c,d){a.fireEvent("afterrequest",a);var b=c.responseJSON;if(Ext.isDefined(b.error)&&b.error.length>0){a.notify.error(b.error[0]);}else{a.notify.error(gt.gettext("There is an unexpected network error. Please retry later."));}a.saveButton.disable();}});},addDayOfWeekLabel:function(b){if(!this.dayOfWeek){this.dayOfWeek=new Ext.form.CheckboxGroup({columns:7,width:430,name:"weekDay",listeners:{scope:this,change:function(d,c){this.recurDaily.setValue(true);}},items:[]});if(b.dow_label&&(b.dow_label.length>0)){this.weekDaysLabel=b.dow_label;}else{this.weekDaysLabel=[gt.gettext("Sun"),gt.gettext("Mon"),gt.gettext("Tue"),gt.gettext("Wed"),gt.gettext("Thu"),gt.gettext("Fri"),gt.gettext("Sat")];}for(var a=0;a<this.weekDaysLabel.length;a++){this.dayOfWeek.items.push(new Ext.form.Checkbox({boxLabel:this.weekDaysLabel[a]}));}this.dailyContainer.add(this.dayOfWeek);}},buildMainPanel:function(){this.mainPanel=new Ext.Panel({frame:false,border:false,width:Ext.isIE?600:610,items:[]});var a=this;this.saveButton=new Ext.Button({text:gt.gettext("Save Schedule"),handler:function(){a.saveSchedule();},listeners:{mouseover:function(){if(a.scheduleReportSection.scheduleSend.iGotFocus){a.scheduleReportSection.scheduleSend.toSaveSchedule=true;}},mouseout:function(){if(a.scheduleReportSection.scheduleSend.iGotFocus){a.scheduleReportSection.scheduleSend.toSaveSchedule=false;}}}});this.cancelButton=new Ext.Button({text:gt.gettext("Cancel"),handler:function(){a.clearSchedule();a.scheduleMailingSection.note.removeAll();a[a.closeAction]();},listeners:{mouseover:function(){if(a.scheduleReportSection.scheduleSend.iGotFocus){a.scheduleReportSection.scheduleSend.toCancelSchedule=true;}},mouseout:function(){if(a.scheduleReportSection.scheduleSend.iGotFocus){a.scheduleReportSection.scheduleSend.toCancelSchedule=false;}}}});this.content=[this.mainPanel];this.scheduleMailingSection=new Ext.form.FormPanel({title:gt.gettext("Mailing Schedule"),frame:false,border:false,baseCls:"grey-x-panel x-panel",cls:"schedule_mailing",items:[]});this.scheduleReportSection=new Ext.form.FieldSet({title:gt.gettext("Schedule Report Send"),baseCls:"grey-x-panel x-panel",hideMode:"offsets",collapsible:true,collapsed:true,frame:false,border:false,items:[]});this.scheduleReportSection.on("expand",function(){if(this.reportRecipients){this.reportRecipients.fromMultiselect.view.refresh();this.reportRecipients.toMultiselect.view.refresh();}if(this.scheduleReportSection.scheduleSend){this.scheduleReportSection.scheduleSend.doLayout();}},this);this.mainPanel.add([this.scheduleMailingSection,this.scheduleReportSection]);this.buildMailingSchedule();this.buildReportSchedule();this.windowButtons=[this.saveButton,this.cancelButton];},buildMailingSchedule:function(){var l=this;var g=['<div style="text-align: right; margin-right: 20px; padding: 2px;">',ECM.Flare.makeLink("FLARE_LEFTNAV_SCHEDULE"),"</div>"].join("");var m=[[0,"00"],[1,"01"],[2,"02"],[3,"03"],[4,"04"],[5,"05"],[6,"06"],[7,"07"],[8,"08"],[9,"09"],[10,"10"],[11,"11"],[12,"12"],[13,"13"],[14,"14"],[15,"15"],[16,"16"],[17,"17"],[18,"18"],[19,"19"],[20,"20"],[21,"21"],[22,"22"],[23,"23"]];var c=new Ext.data.ArrayStore({data:m,fields:["value","hour"],idIndex:0});var b=[[0,"00"],[5,"05"],[10,"10"],[15,"15"],[20,"20"],[25,"25"],[30,"30"],[35,"35"],[40,"40"],[45,"45"],[50,"50"],[55,"55"]];var j=new Ext.data.ArrayStore({data:b,fields:["value","minute"],idIndex:0});l.scheduleMailingSection.add([{xtype:"container",html:g},{xtype:"container",hidden:true,ref:"note"},{xtype:"radiogroup",hideLabel:true,width:500,listeners:{change:function(r,q){if(q){l.recurrenceContainer.setVisible(q.itemId==="recurring");l.recurrenceContainer.doLayout();}},afterrender:function(){l.mailingOptions=this;}},items:[{xtype:"radio",itemId:"one-time",name:"optMailing",boxLabel:gt.gettext("One-time mailing"),listeners:{afterrender:function(){l.optOneTime=this;}}},{xtype:"radio",itemId:"recurring",name:"optMailing",boxLabel:gt.gettext("Recurring mailing"),listeners:{afterrender:function(){l.optRecurring=this;}}}]},{xtype:"label",text:gt.gettext("Start mailing on:")},{xtype:"container",layout:"toolbar",style:{margin:"5px"},items:[{xtype:"datefield",width:120,name:"startDate",emptyText:gt.gettext("MM/DD/YYYY"),invalidText:gt.gettext("{0} is not a valid date - it must be in the format MM/DD/YYYY"),listeners:{afterrender:function(){l.startDate=this;},select:function(){if(l.clearButton.disabled){l.clearButton.enable();}}}},{xtype:"spacer",width:10},{xtype:"label",text:gt.gettext("At")},{xtype:"spacer",width:10},{xtype:"combo",width:50,name:"startHour",mode:"local",store:c,displayField:"hour",value:"HH",valueField:"value",typeAhead:true,triggerAction:"all",listeners:{afterrender:function(){l.startHour=this;
},select:function(){if(l.clearButton.disabled){l.clearButton.enable();}}}},{xtype:"label",text:"  :  "},{xtype:"combo",width:50,name:"startMinute",mode:"local",store:j,displayField:"minute",value:"MM",valueField:"value",typeAhead:true,triggerAction:"all",listeners:{afterrender:function(){l.startMinute=this;},select:function(){if(l.clearButton.disabled){l.clearButton.enable();}}}},{xtype:"spacer",width:10},{xtype:"label",text:gt.gettext("EST"),listeners:{afterrender:function(){l.timezone=this;}}},{xtype:"spacer",width:10},{xtype:"button",cls:"blue_button",text:gt.gettext("Clear Schedule"),hidden:true,handler:function(){l.clearSchedule();this.disable();},listeners:{afterrender:function(){l.clearButton=this;}}}]},{xtype:"spacer",width:300,height:25}]);l.recurrenceContainer=new Ext.Container({cls:"schedule_recur_container",width:600,hidden:true});var o=[{xtype:"label",text:gt.gettext("Recurrence:")},{xtype:"container",id:"dailyContainer",layout:"toolbar",style:{margin:"5px"},listeners:{afterrender:function(){l.dailyContainer=this;}},items:[{xtype:"radio",name:"optRecurrence",boxLabel:gt.gettext("Daily"),listeners:{afterrender:function(){l.recurDaily=this;}}},{xtype:"spacer",width:15}]}];var n=[[1,1],[2,2],[3,3],[4,4],[5,5],[6,6],[7,7],[8,8],[9,9],[10,10],[11,11],[12,12],[13,13],[14,14],[15,15],[16,16],[17,17],[18,18],[19,19],[20,20],[21,21],[22,22],[23,23],[24,24],[25,25],[26,26],[27,27]];var a=new Date();if(a.isLeapYear()){n.push([28,28]);}var h=new Ext.data.ArrayStore({data:n,fields:["id","day"],idIndex:0});var p=[[0,gt.gettext("start")],[1,gt.gettext("end")]];var k=new Ext.data.ArrayStore({data:p,fields:["id","option"],idIndex:0});o.push({xtype:"container",layout:"toolbar",style:{margin:"5px"},defaultType:"spacer",items:[{xtype:"radio",name:"optRecurrence",boxLabel:gt.gettext("Every"),listeners:{afterrender:function(){l.recurNDayFromMonth=this;}}},{width:"10"},{xtype:"combo",width:50,listWidth:50,name:"monthday",mode:"local",store:h,displayField:"day",valueField:"id",typeAhead:true,triggerAction:"all",listeners:{select:function(r,s,q){l.recurNDayFromMonth.setValue(true);},afterrender:function(){l.monthDay=this;}}},{width:"5"},{xtype:"label",text:" "+gt.gettext("days from the")+" "},{width:"5"},{xtype:"combo",width:60,listWidth:60,name:"monthend",mode:"local",store:k,displayField:"option",valueField:"id",value:0,typeAhead:true,triggerAction:"all",listeners:{select:function(r,s,q){l.recurNDayFromMonth.setValue(true);},afterrender:function(){l.startEndMonth=this;}}},{width:"5"},{xtype:"label",text:"  "+gt.gettext("of the month")}]});o.push({xtype:"container",layout:"toolbar",style:{margin:"5px"},defaultType:"spacer",items:[{xtype:"radio",name:"optRecurrence",boxLabel:gt.gettext("Every"),listeners:{afterrender:function(){l.recurNDayFromStart=this;}}},{width:"10"},{xtype:"textfield",width:50,name:"days",maskRe:/[0-9]/,listeners:{valid:function(){if(this.getValue()){l.recurNDayFromStart.setValue(true);}},afterrender:function(){l.nDays=this;}}},{width:"5"},{xtype:"label",text:" "+gt.gettext("days beginning on the start date")}]});var f=[["no",gt.gettext("No end date")],["yes",gt.gettext("Specified end date")]];var d=new Ext.data.ArrayStore({data:f,fields:["id","option"],idIndex:0});o.push({xtype:"container",layout:"toolbar",style:{margin:"5px"},defaultType:"spacer",items:[{xtype:"label",text:gt.gettext("Until:")},{width:"10"},{xtype:"combo",width:140,name:"endDate",mode:"local",store:d,displayField:"option",valueField:"id",value:"no",typeAhead:true,triggerAction:"all",listeners:{select:function(r,s,q){if(s.get("id")==="yes"){l.specifiedEndDate.setVisible(true);}else{l.specifiedEndDate.setVisible(false);}},afterrender:function(){l.endDate=this;}}},{width:"10"},{xtype:"datefield",width:"80",name:"specifiedEndDate",emptyText:gt.gettext("MM/DD/YYYY"),invalidText:gt.gettext("{0} is not a valid date - it must be in the format MM/DD/YYYY"),hidden:true,listeners:{afterrender:function(){l.specifiedEndDate=this;}}}]});l.recurrenceContainer.add(o);l.scheduleMailingSection.add(l.recurrenceContainer);},buildReportSchedule:function(){var c=[["hours",gt.gettext("hour(s)")],["days",gt.gettext("day(s)")]];var a=new Ext.data.ArrayStore({data:c,fields:["id","option"],idIndex:0});var b=this;this.scheduleReportSection.add({xtype:"label",style:{padding:"10px"},text:gt.gettext("To:")},{xtype:"ecm.itemselector",hideLabel:true,width:520,style:{"margin-left":"10px"},stores:[b.availEmailStore,b.selectedEmailStore],listeners:{afterrender:function(){b.reportRecipients=this;}}},{xtype:"container",layout:"toolbar",defaultType:"spacer",style:{margin:"5px"},items:[{width:10},{xtype:"label",text:gt.gettext("Additional Email:"),autoWidth:true},{width:5},{xtype:"textfield",width:300,name:"additional_names",vtype:"multipleEmails",listeners:{afterrender:function(){b.additionalEmail=this;}}},{width:5},{xtype:"checkbox",width:100,name:"save_address",boxLabel:gt.gettext("Save to Report Addresses"),autoWidth:true,listeners:{afterrender:function(){b.saveReportAddr=this;}}}]},{xtype:"label",style:{padding:"10px"},text:gt.gettext("Send Report:")},{xtype:"ecm.sendreportschedule",ref:"scheduleSend"});}});Ext.reg("ecm.CMS.Nav.ScheduleFlyout",ECM.CMS.Nav.ScheduleFlyout);ECM.provide("ECM.CMS.Nav.SendTest");var errors_as_string=function(){var b=arguments[0];var d=arguments[1];var c="";if(b.error.length>0){if(d){c=gt.gettext("Failed to load send test modal, please try again.");}else{c=gt.gettext("Failed to send test.");}}if(b.application_errors.length>0){for(var a=0;a<b.application_errors.length;a++){c+=b.application_errors[a]+"<br/>";}}return c;};ECM.CMS.Nav.SendTest=Ext.extend(ECM.Flyout,{id:"sendTestWindow",closeAction:"hide",initComponent:function(){this.on("show",this.loadData);if(this.send_type==="Preview"){this.addClass("ecm-window");}ECM.CMS.Nav.SendTest.superclass.initComponent.call(this);},loadData:function(){Ext.getCmp("sendTestWindow").notify.clear();var b=new Ext.LoadMask(this.getEl(),{msg:gt.gettext("Send Test loading...")});b.show();var c=this;var a;ECM.Ajax.request({url:"/cm/mailing/sendtest/load",method:"POST",params:{mid:c.mid,mtype:c.mtype,eid:c.eid?c.eid:"",desired_aid:c.desired_aid},success:function(d,f){a=d.responseJSON;if(Ext.select("#sendTestForm").getCount()!==0){Ext.select("#sendTestForm").first().remove();}if(Ext.select("#closePanel").getCount()>0){Ext.select("#closePanel").first().remove();}c.add(new ECM.CMS.Nav.SendTest.Panel({data:a.data,mtype:c.mtype,send_type:c.send_type,is_template:c.is_template}));c.doLayout();if(c.send_type==="Preview"&&c.eid!=""){Ext.getCmp("formats").setValue(Ext.getCmp("selectedFormat").getValue());}b.hide();},failure:function(d,g){a=d.responseJSON;b.hide();if(Ext.select("#closePanel").getCount()>0){Ext.select("#closePanel").first().remove();}if(Ext.select("#sendTestForm").getCount()!==0){Ext.select("#sendTestForm").first().remove();}this.closeButton=new Ext.Button({text:gt.gettext("Close"),id:"close",cls:"blue_button",handler:function(){Ext.getCmp("sendTestWindow").hide();Ext.getCmp("sendTestWindow").remove(Ext.getCmp("closePanel"));}});c.remove();c.add(new Ext.Container({id:"closePanel",columnWidth:0.98,layout:"column",items:[{xtype:"spacer",columnWidth:0.95,html:"&nbsp;"},this.closeButton]}));c.doLayout();if(a.error.length>0||a.application_errors.length>0){var f=errors_as_string(a);c.notify.error(f);}}});},sendTest:function(){var b=new Ext.LoadMask(this.getEl(),{msg:gt.gettext("Sending...")});b.show();var f=Ext.getCmp("sendTestForm").getForm().getValues();var a={};var g=f.formats;if(f.send_formats==="true"||(this.eid&&this.send_type==="Preview")){if(g){g=g.split(",");}else{this.notify.error(gt.gettext("Tests could not be sent. No sending options were selected."));b.hide();return false;}}a.formats={selected:g};a.test_tag=f.test_tag;a.post_social_media_tests=f.post_social_media_tests;a.personalization_fields=this.personalization;a.dynamic_content=this.dynamic_content;var d;if(this.send_type==="LeftNav"){d=f.email_list;}else{d=Ext.getCmp("previewRadioViewed").getValue()===true?f.email_list_current_view:f.email_list;
}if(d){d=d.replace(/( |\n\r|\n)/g,"");d=d.split(",");}a.send_to={email_list:d,testers_list:{selected:f.testers_list}};var c=this;ECM.Ajax.request({url:"/cm/mailing/sendtest/save",method:"POST",params:{send_test:Ext.encode(a),mid:this.mid,eid:this.eid?this.eid:"",desired_aid:this.desired_aid},success:function(j){var h=j.responseJSON;Ext.getCmp("sendTestWindow").hide();Ext.getCmp("sendTestForm").removeAll();Ext.getCmp("sendTestSubmit").destroy();Ext.getCmp("sendTestCancel").destroy();c.showConfirmationBox(gt.gettext("Send Tests Confirmation"),h.application_errors);},failure:function(l){var h=l.responseJSON;if(h.data.from_social_media_post_test){Ext.getCmp("sendTestWindow").hide();Ext.getCmp("sendTestForm").removeAll();Ext.getCmp("sendTestSubmit").destroy();Ext.getCmp("sendTestCancel").destroy();c.showConfirmationBox(gt.gettext("Send Tests Confirmation"),h.application_errors);}else{c.show();if(Ext.isDefined(h.error)||Ext.isDefined(h.application_errors)){var k=1;var j=errors_as_string(h,k);c.notify.error(j);}else{c.notify.error(gt.gettext("There is an unexpected network error. Please retry later."));}}},callback:function(h){b.hide();}});},showConfirmationBox:function(f,c){var d="The test mailings have been sent.";for(var a=0;a<c.length;a++){d+="</br>"+c[a];}var b=new ECM.Window({id:"sendTestConfirmationBox",title:f,items:[{html:d}],windowButtons:[{text:gt.gettext("OK"),cls:"blue_button",handler:function(){var g=Ext.getCmp("sendTestConfirmationBox");Ext.destroy(g);}}]});b.show();}});ECM.CMS.Nav.SendTest.Panel=Ext.extend(Ext.FormPanel,{id:"sendTestForm",constructor:function(a){Ext.apply(this,a);this.items=[this.getItems(this.data)];this.sendButton=new Ext.Button({id:"sendTestSubmit",text:gt.gettext("Send Tests"),cls:"blue_button",handler:function(){Ext.getCmp("sendTestWindow").sendTest();}});this.cancelButton=new Ext.Button({id:"sendTestCancel",text:gt.gettext("Cancel"),cls:"blue_button",handler:function(){Ext.getCmp("sendTestWindow").hide();Ext.getCmp("sendTestForm").removeAll();Ext.getCmp("sendTestSubmit").destroy();Ext.getCmp("sendTestCancel").destroy();}});this.buttons=[this.sendButton,this.cancelButton];this.testersListFlag=true;if(this.send_type==="Preview"&&this.mtype==="1"){this.onActivate();}if(!this.data.send_test.send_to.testers_list){this.noTestersList();this.testersListFlag=false;}ECM.CMS.Nav.SendTest.Panel.superclass.constructor.call(this,a);},getItems:function(f){var a=this.send_type;var c=this.mtype;var d=this;var b=['<div style="text-align: right; padding: 2px;">',ECM.Flare.makeLink("FLARE_LEFTNAV_SENDTESTS"),"</div>"].join("");this.formCurrentlyViewedHeader=new Ext.Container({layout:"column",items:[{xtype:"label",text:gt.gettext("To:")},{xtype:"spacer",width:10,height:10},{xtype:"textarea",name:"email_list_current_view",id:"emailListPreview",width:450,allowBlank:false,validator:this.validate_email_area,autoScroll:true,overflow:"auto",value:!this.isEmpty(f.send_test.send_to.email_list)?Ext.util.Format.htmlDecode(f.send_test.send_to.email_list):""}]});if(!f.send_test.send_to.testers_list){f.send_test.send_to.testers_list="";}if(!f.send_test.send_to.testers_list.selected){f.send_test.send_to.testers_list.selected="";}this.formAddressBookHeader=new Ext.Container({layout:"form",cls:"form_container",items:[{xtype:"container",html:b,style:{textAlign:"right"}},{xtype:"container",layout:"column",style:{padding:"2px"},items:[{xtype:"label",text:gt.gettext("Tests last sent:"),width:100},{xtype:"label",text:f.send_test.last_sent,width:200}]},{xtype:"container",layout:"column",cls:"send_list_container",items:[{xtype:"label",text:gt.gettext("To: "),width:20},{xtype:"radio",name:"send_to",id:"sendToList",checked:f.send_test.send_to.use_tester_list?true:false,value:true,handler:this.checkEmailList},{xtype:"container",width:190,cls:"tester_list",items:[{xtype:"combo",name:"testers_list",id:"testersList",hiddenName:"testers_list",store:new Ext.data.JsonStore({root:"list",autoLoad:f.send_test.send_to.testers_list?true:false,fields:["id","name"],data:f.send_test.send_to.testers_list}),value:f.send_test.send_to.testers_list.selected,triggerAction:"all",displayField:"name",emptyText:"None",mode:"local",valueField:"id",hiddenValue:f.send_test.send_to.testers_list.selected,disabled:f.send_test.send_to.use_tester_list?false:true,width:180,style:{"float":"left"},validator:this.checkEmailList}]},{xtype:"label",html:'<a href="#" id="viewLink" style=text-decoration:underline>'+gt.gettext("View")+"</a>",width:80,listeners:{scope:this,afterrender:function(){Ext.get("viewLink").on("click",this.openTesterList,this);}}}]},{xtype:"container",layout:"column",style:{padding:"2px"},items:[{xtype:"spacer",width:40,height:10},{xtype:"label",text:gt.gettext("Test will be sent as specified in Admin/Tester Address Book"),width:400,cls:"sendtest_msg"}]},{xtype:"container",layout:"column",style:{padding:"2px"},items:[{xtype:"spacer",width:20,height:10},{xtype:"radio",name:"send_to",id:"sendTo",value:false,handler:this.checkEmailList,checked:f.send_test.send_to.use_tester_list?false:true},{xtype:"textfield",name:"email_list",id:"emailList",width:450,allowBlank:false,validator:this.validate_email_area,value:!this.isEmpty(f.send_test.send_to.email_list)?Ext.util.Format.htmlDecode(f.send_test.send_to.email_list):"",disabled:f.send_test.send_to.use_tester_list?true:false}]}]});this.formatsToSendMultipart=false;if(f.send_test.formats.selected=="default"||!f.send_test.formats.selected){this.formatsToSendMultipart=true;}this.formFormatsToSend=new Ext.Container({layout:"form",cls:"form_container",items:[{xtype:"radiogroup",vertical:true,fieldLabel:gt.gettext("Formats to send"),columns:1,items:[{id:"sendMultipart",name:"send_formats",boxLabel:gt.gettext("As email would be sent (multipart)"),inputValue:false,checked:this.formatsToSendMultipart?true:false,listeners:{scope:this,afterrender:function(){Ext.get("sendMultipart").on("click",this.checkFormats);}}},{id:"sendSpecific",name:"send_formats",inputValue:true,boxLabel:gt.gettext("Specific formats:"),checked:this.formatsToSendMultipart?false:true,listeners:{scope:this,afterrender:function(){Ext.get("sendSpecific").on("click",this.checkFormats);}}}]},{xtype:"multiselect",allowBlank:false,editable:false,lazyInit:false,mode:"local",autoHeight:true,cls:"sendtest_format_view",triggerAction:"all",id:"formats",store:new Ext.data.ArrayStore({fields:["data_value","display_text"],data:f.send_test.formats.list.map(function(g){if(g==="html"){return[g,"HTML"];}else{if(g==="text"){return[g,"Text"];}else{if(g==="rtf"){return[g,"Rich Text"];}else{return[g,g];}}}})}),hiddenName:"formats",name:"formats",valueField:"data_value",value:f.send_test.formats.selected,inputValue:f.send_test.formats.selected,hiddenValue:f.send_test.formats.selected,displayField:"display_text",disabled:(this.formatsToSendMultipart?true:false)}]});this.formSocialMedia=new Ext.Container({layout:"form",cls:"form_container",items:(d.is_template?[]:f.allow_social_media?[{xtype:"checkbox",name:"post_social_media_tests",id:"postSocialMediaTests",boxLabel:gt.gettext("Post to social media test account"),value:1,inputValue:1,checked:(f.send_test.post_social_media_tests?true:false)}]:[]).concat(f.send_test.hasOwnProperty("test_tag")?[{xtype:"textfield",name:"test_tag",id:"testTag",fieldLabel:gt.gettext("Test label"),width:300,value:Ext.util.Format.htmlDecode(f.send_test.test_tag)}]:[])});this.previewRadioCurrentlyViewed=new Ext.form.Radio({name:"preview_radio",id:"previewRadioViewed",boxLabel:gt.gettext("Send version currently viewed"),checked:true});this.previewRadioCurrentlyViewed.on("check",function(){if(this.getValue()){d.formCurrentlyViewedHeader.show();Ext.getCmp("emailListPreview").enable();d.formAddressBookHeader.hide();}});this.previewRadioAddressBook=new Ext.form.Radio({name:"preview_radio",id:"previewRadioAddressBook",boxLabel:gt.gettext("Send tests to address book")});this.previewRadioAddressBook.on("check",function(){if(this.getValue()){d.formCurrentlyViewedHeader.hide();Ext.getCmp("emailListPreview").disable();
Ext.getCmp("sendTestSubmit").enable();d.formAddressBookHeader.show();}});if(a==="LeftNav"){switch(c){case 1:this.items=[this.formAddressBookHeader,this.formFormatsToSend,this.formSocialMedia];break;case 2:this.items=[{xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("To: "),width:20},{xtype:"textfield",name:"email_list",id:"emailList",width:450,allowBlank:false,validator:this.validate_email_area,value:function(){if(f.send_test.email_list){return Ext.util.Format.htmlDecode(f.send_test.email_list);}return"";}()}]},this.formFormatsToSend,{xtype:"container",layout:"column",items:[{xtype:"label",width:500,text:gt.gettext("To test your personalization and dynamic content options, please use the Send Tests functionality on the Preview page.")}]},{xtype:"container",layout:"column",items:[{xtype:"spacer",width:500,height:10}]}];break;}}else{if(a==="Preview"){switch(c){case"1":this.items=[{xtype:"container",layout:"column",style:{padding:"2px"},items:[this.previewRadioCurrentlyViewed,{xtype:"spacer",width:30,height:10},this.previewRadioAddressBook]},{xtype:"spacer",width:30,height:10},this.formCurrentlyViewedHeader,this.formAddressBookHeader,this.formFormatsToSend,this.formSocialMedia];break;case"2":this.items=[this.formCurrentlyViewedHeader,{xtype:"spacer",width:25,height:10},{xtype:"container",layout:"column",style:{padding:"2px"},items:[{xtype:"label",text:gt.gettext("Format to send:"),height:20},{xtype:"spacer",width:10,height:10},{xtype:"multiselect",allowBlank:false,editable:false,lazyInit:false,mode:"local",autoHeight:true,triggerAction:"all",id:"formats",store:new Ext.data.ArrayStore({fields:["data_value","display_text"],data:f.send_test.formats.list.map(function(g){if(g==="html"){return[g,"HTML"];}else{if(g==="text"){return[g,"Text"];}else{if(g==="rtf"){return[g,"Rich Text"];}else{return[g,g];}}}})}),hiddenName:"formats",name:"formats",valueField:"data_value",value:f.send_test.formats.selected,inputValue:f.send_test.formats.selected,hiddenValue:f.send_test.formats.selected,displayField:"display_text"}]}];break;}}}return this.items;},isEmpty:function(a){if(a===""){return true;}if(a===null){return true;}if(a===undefined){return true;}return false;},onActivate:function(){this.formAddressBookHeader.hide();},noTestersList:function(a){Ext.getCmp("testersList").disable();Ext.getCmp("sendTo").checked=true;},checkEmailList:function(){if(Ext.getCmp("sendToList").getValue()){Ext.getCmp("testersList").enable();if(Ext.getCmp("testersList").getValue()){Ext.getCmp("sendTestSubmit").enable();}else{Ext.getCmp("sendTestSubmit").disable();}Ext.getCmp("emailList").disable();Ext.getCmp("emailList").clearInvalid();}else{Ext.getCmp("emailList").enable();Ext.getCmp("testersList").disable();if(!Ext.getCmp("emailList").getValue()){Ext.getCmp("sendTestSubmit").disable();}else{Ext.getCmp("sendTestSubmit").enable();}}},checkFormats:function(){if(Ext.getCmp("sendSpecific").getValue()){Ext.getCmp("formats").enable();Ext.getCmp("formats").markInvalid(["This field is required."]);}else{Ext.getCmp("formats").disable();Ext.getCmp("formats").clearInvalid();}},validate_email_area:function(a){var f=200;a=Ext.util.Format.trim(a);var d=a.split(",");var c=Ext.getCmp("sendTestSubmit");if(!a.length){c.disable();return gt.gettext("An email address is required.");}var b=0;if(b>f){c.disable();return[gt.strargs(gt.gettext("The recipient list is longer that the allowed maximum (%1)."),[f])].join("");}c.enable();return true;},openTesterList:function(){var a="/cgi-bin/mailers/mailings/tester-addresses?"+Ext.urlEncode({desired_aid:this.data.aid,tlid:Ext.getCmp("testersList").getValue()});window.open(a);}});Ext.reg("ecm.sendtest",ECM.CMS.Nav.SendTest);(function(){ECM.provide("ECM.CMS.Nav.UploadFlyout");var a=[{frame:"textFrame",setMethod:"setTextContent",content_type:"text",displayText:"Text"},{frame:"richTextFrame",setMethod:"setRichTextContent",content_type:"richtext",displayText:"Rich Text"},{frame:"htmlFrame",setMethod:"setHTMLContent",content_type:"html",displayText:"HTML"}],c="contentPanelId";var b=Ext.isIE?function(g){var h=g.textContent||g.innerHTML;if(!h){h=(g.nodeValue||"")+(g.nextSibling?g.nextSibling.nodeValue||"":"");}return h;}:function(g){if(!g){return"";}return g.textContent||g.innerHTML||"";};var d=function(){var h=document.createElement("div");var g={};return function(l){if(g[l]){return g[l];}h.innerHTML=l;var j=[];for(var k=h.firstChild;k;k=k.nextSibling){j.push(b(k));}g[l]=j.join("");return g[l];};}();var f=function(k){var l=RegExp(/&(?:amp;)?#x[0-9a-fA-F]+;/g);var j,g=0,h=[];while(j=l.exec(k)){h.push(k.substring(g,j.index)+d(j[0]));g=j.index+j[0].length;}if(g!==k.length){h.push(k.substring(g,k.length));}return h.length?h.join(""):k;};ECM.CMS.Nav.UploadFlyout=Ext.extend(ECM.Form.UploadDialog,{multiContent:false,allowImages:true,windowingClass:ECM.Flyout,title:"",constructor:function(h){this.mid=h.mid;this.mtype=h.mtype;this.upload_url=h.upload_url;Ext.apply(this,h);ECM.CMS.Nav.UploadFlyout.superclass.constructor.apply(this,arguments);var j;var g=new Ext.LoadMask(Ext.getBody(),{msg:gt.gettext("Loading...")});var l=function(){var n=this.uploadWindow;if(n&&n.mask){var m=n.mask.dom.style;j=m.zIndex;m.zIndex="19999";}g.show();};var k=function(){var m=this.uploadWindow;if(Ext.isDefined(j)&&m&&m.mask){m.mask.dom.style.zIndex=j;}g.hide();};this.on("startUpload",l,this);this.on("serverResponse",k,this);this.on("serverError",k,this);},getBaseParams:function(){return{aid:this.aid,desired_aid:this.aid,tag_mid:this.mid,tag_mtype:this.mtype};},confirmationWindowClosed:function(g){var h=Ext.getCmp(c),k=g.success;var l=[];if(k&&h){Ext.each(a,function(n,m){var p=k[n.content_type];if(p){k[n.content_type]=f(p);var o=h[n.setMethod](k[n.content_type]);if(!o){l.push(n.displayText);}}},this);if(!Ext.isEmpty(l)){var j;if(l.length>2){j=gt.gettext("Sorry, cannot upload content. No formats were selected.");}else{l=l.join(gt.gettext(" and "));j=gt.strargs("Sorry, cannot upload %1 content. Mailing format(s) were not selected.",[l]);}this.publish("/cms/error/add",{message:j});}}if(k.text){this.wrapText(k.text,k.text_wrap);}this.publish("/cms/leftnav/dc/refresh");},wrapText:function(n,l){var o=new ECM.CMS.Util.TextWrapper();var h=Ext.getCmp("wraptextat");if(h){var j=o.wrap(n,parseInt(l,10));var g=Ext.getCmp("plaintextarea");if(g){g.setValue(j);}var k=Ext.getCmp("texteditor");if(k){k.fireEvent("textgenerated",j);}var m=(!Ext.isEmpty(l))?l:h.value;h.setValue(m);}},getDCEditorInstances:function(){var h=Ext.getCmp(c);if(!h){throw Error("no content panel found");}var g=function(k){return function(){var l=h[k];if(!l){return true;}else{return l.getValue().length===0;}};};var j=[];Ext.each(a,function(k){j.push({isEmpty:g(k.frame)});});return j;}});})();ECM.provide("ECM.Plugins.Panel.FloatTop");ECM.Plugins.Panel.FloatTop=Ext.extend(Ext.util.Observable,{dynamicHeight:false,constructor:function(a){Ext.apply(this,a);ECM.Plugins.Panel.FloatTop.superclass.constructor.apply(this,arguments);},init:function(a){this.panel=a;this.panel.on("afterrender",function(){this.panelEl=this.panel.getEl();this.panelPadding=this.panelEl.getPadding("t");this.minTop=this.panelEl.getTop()+this.panelPadding;this.origHeight=this.panel.getHeight();this.origPosition=this.panelEl.getStyle("position");},this);var b=this.capAndDefer(this.floatToTop,100,this);this.panel.on("afterlayout",function(){this.floatToTop();},this,{delay:100});Ext.fly(window).on("scroll",b,this);},floatToTop:function(){var d=this.panel.ownerCt?this.panel.ownerCt.getEl():this.panelEl.parent().parent();var b=Ext.fly(document.body).getScroll().top;var a=this.origHeight;if(this.dynamicHeight){if(b>this.minTop){a=Ext.getBody().getViewSize().height;var c=d.getBottom()-a;if(b>c){a=a-(b-c);}}else{a=Ext.getBody().getViewSize().height-(this.minTop-b);a=Math.min(a,d.getHeight());}if(Ext.isNumber(this.minDynHeight)&&this.minDynHeight>0){a=Math.max(a,this.minDynHeight);}this.panel.setHeight(a);}this.maxTop=d.getBottom()-a;if(b>this.minTop){this.panelEl.setStyle({position:"absolute"});
if(b>this.maxTop){this.panelEl.setY(this.maxTop);}else{this.panelEl.setY(b-this.panelPadding,true);}}else{this.panelEl.setStyle({position:this.origPosition});this.panelEl.setTop(0);}},capAndDefer:function(c,f,b){var a=false;var d=c;return(function(){if(a){window.clearTimeout(a);}a=d.defer(f,b,arguments);});}});Ext.preg("ecm.floattop",ECM.Plugins.Panel.FloatTop);ECM.provide("ECM.Config.FeatureHelp");ECM.Config.FeatureHelp=Ext.extend(Object,{bitBlock:-1,tooltipConfigs:[],getTooltipConfigs:function(b){if(arguments.length===0){return this.tooltipConfigs;}var a=[];Ext.each(this.tooltipConfigs,function(c){if(b.indexOf(c.bitPosition)>=0){a.push(c);}},this);return a;}});ECM.provide("ECM.Config.FeatureHelp.CMS");ECM.Config.FeatureHelp.CMS=Ext.extend(ECM.Config.FeatureHelp,{bitBlock:0,tooltipConfigs:[{bitPosition:0,targetId:"send_test_button",message:gt.gettext("Once you are happy with the layout, send a test to see how the email will look to your recipients."),anchorOffset:18},{bitPosition:1,targetId:"p13n_dc_tabpanel",message:gt.gettext("Dragging a personalization or dynamic content element from the left navigation into your content will insert that element in the content, where the cursor indicates."),maxWidth:205},{bitPosition:2,targetId:"envelopeSection",message:gt.gettext("The envelope tells the basic information about who your mailing is from, and who it's going to.")},{bitPosition:3,targetId:"dataSection",message:gt.gettext("Not sure of your segment yet? You can add it later.")},{bitPosition:4,targetId:"checklist_mainPanel",message:gt.gettext("Here's where you can double check everything about your mailing. If there are no errors or warnings showing up, approve to get your mailing out. Or you can open each section and review your settings.")},{bitPosition:5,targetId:"libraryFilterFeatureHelp",message:gt.gettext("Select the content you'd like to use from the library, and then click the Filter button to see the items you can drag and drop into your content. You'll find special links under Links."),maxWidth:205}]});ECM.provide("ECM.CMS.Panel.LeftNav");ECM.CMS.Panel.LeftNav=Ext.extend(Ext.Panel,{plugins:new ECM.Plugins.Panel.FloatTop({dynamicHeight:true,minDynHeight:550}),constructor:function(a){this._appimght=a.appimght;this._mid=a.mid;this._mtype=a.mtype;this._eid=a.eid;this._aid=a.aid;this._mfid=a.mfid;this._flyout=a.flyout;this._role=a.role;this._testMode=Ext.isDefined(a.testMode)?a.testMode:false;this._flyoutsOpened=false;this._is_template=a.is_template;this.dcLibOverwrite=[];this.libTags={};this.dcTagBackTruncateCount=(a.mtype===2)?4:2;a=Ext.apply({layout:"accordion",layoutConfig:{animate:true,height:600},frame:false,id:"leftnav_panel",hideBorders:true,items:this._getChildren(),listeners:{afterlayout:function(){if(!this._flyoutsOpened){this._openFlyouts();this._flyoutsOpened=true;}}}},a);if(!this._testMode){this._tasksOnClickEvents();}ECM.CMS.Panel.LeftNav.superclass.constructor.call(this,a);},_getChildren:function(){var d=this;var b=new ECM.Config.FeatureHelp.CMS();ECM.FeatureHelp.setFeatureHelp(b);var c=(this._mtype===2)?gt.gettext("Dynamic Content"):((d._role==="MAILING_PRODUCER")?gt.gettext("Personalization"):gt.gettext("Personalization and <br />Dynamic Content"));var g={border:false,title:gt.gettext("Tasks"),contentEl:this._testMode?"":"tasks_acc_nav",listeners:{expand:function(){ECM.publish("/flare/setDefaultTabAnchorName");},collapse:function(){ECM.publish("/flare/setDefaultTabAnchorName");}}};var f={border:false,title:c,id:"cm_p_dc",listeners:{beforeexpand:function(){if(Ext.isDefined(Ext.getCmp("leftnav_p13n"))){Ext.getCmp("leftnav_p13n").loadTreeData();}var h=Ext.getCmp("leftnav_dc");if(Ext.isDefined(h)&&h.newDcTree.hidden){h.loadTreeData();}if(Ext.isDefined(Ext.getCmp("leftnav_emo"))){Ext.getCmp("leftnav_emo").loadTreeData();}},expand:function(){ECM.FeatureHelp.showTooltip("p13n_dc_tabpanel");ECM.Flare.updateLink("FLARE_LEFTNAV_PERSONALIZATION_DYNAMIC_CONTENT");},collapse:function(){ECM.FeatureHelp.hideTooltip("p13n_dc_tabpanel");ECM.publish("/flare/setDefaultTabAnchorName");},afterrender:function(){if(Ext.isDefined(Ext.getCmp("leftnav_dc"))){Ext.getCmp("leftnav_dc").loadP13nData(false);}Ext.getCmp("leftnav_panel").on("collapse",function(){ECM.FeatureHelp.hideTooltip("p13n_dc_tabpanel");});}},layout:{type:"vbox",pack:"start",align:"stretch"},items:[{xtype:"container",flex:0,layout:"fit",items:[{xtype:(this._mtype===2||this._role==="MAILING_PRODUCER")?"":"tabpanel",id:"p13n_dc_tabpanel",border:false,height:320,autoScroll:true,activeTab:0,items:[{xtype:"panel",id:"p13n_non_field",title:this._role==="MAILING_PRODUCER"?"":gt.gettext("Personalization"),listeners:{activate:function(){ECM.Flare.updateLink("FLARE_LEFTNAV_PERSONALIZATION_DYNAMIC_CONTENT");}},items:[{xtype:this._testMode?"":"ecm.personalizationpanel",id:"leftnav_p13n",mid:d._mid,mtype:d._mtype,border:false},new ECM.CMS.Panel.NonFieldTransformation({})]},{xtype:this._testMode?"":"ecm.dynamiccontentpanel",id:"leftnav_dc",autoScroll:true,title:(this._mtype===2)?"":gt.gettext("Dynamic Content"),appimght:d._appimght,mid:d._mid,aid:d._aid,mfid:d._mfid,mtype:d._mtype,border:false,listeners:{activate:function(){ECM.Flare.updateLink("FLARE_LEFTNAV_PERSONALIZATION_DYNAMIC_CONTENT");}}}]}]},{xtype:"container",flex:1,layout:"fit",items:[{xtype:"ecm.emoticonspanel",id:"leftnav_emo",autoScroll:true,title:gt.gettext("Emoji"),border:false}]}]};if(this._mtype===2){f.items[0].items[0].items.splice(0,1);}else{if(this._role==="MAILING_PRODUCER"){f.items[0].items[0].items.splice(1,1);}}var a={border:false,title:gt.gettext("Library"),items:{xtype:"ecm.libraryfilter",mtype:d._mtype,mid:d._mid,hideDC:this._role==="MAILING_PRODUCER"?true:false},listeners:{bodyresize:function(h){h.items.each(function(j){j.setHeight(h.getInnerHeight());});},afterrender:function(){Ext.getCmp("leftnav_panel").on("collapse",function(){ECM.FeatureHelp.hideTooltip("libraryFilterFeatureHelp");});},expand:function(){ECM.FeatureHelp.showTooltip("libraryFilterFeatureHelp");ECM.Flare.updateLink("FLARE_LEFTNAV_LIBRARY");},collapse:function(){ECM.FeatureHelp.hideTooltip("libraryFilterFeatureHelp");ECM.publish("/flare/setDefaultTabAnchorName");}}};return[g,f,a];},_dehighlightAllTaskItems:function(){var b=Ext.query(".left_nav li.current");for(var a=0;a<b.length;a++){Ext.get(b[a]).removeClass("current");}},_highlightTask:function(a){this._dehighlightAllTaskItems();Ext.get(a).dom.parentNode.className="current";},_hideFlyouts:function(){if(this.scheduleFlyout.isVisible()){this.scheduleFlyout.hide();}if(this.sendTest.isVisible()){this.sendTest.hide();}if(this.upload.uploadWindow&&this.upload.uploadWindow.getVisibilityEl()&&this.upload.uploadWindow.isVisible()){this.upload.uploadWindow.close();}},_tasksOnClickEvents:function(){var d=this;this.scheduleFlyout=new ECM.CMS.Nav.ScheduleFlyout({frame:true,hidden:true,mid:d._mid,mtype:d._mtype,listeners:{hide:function(){d._dehighlightAllTaskItems();}}});this.sendTest=new ECM.CMS.Nav.SendTest({frame:true,hidden:true,mid:d._mid,mtype:d._mtype,eid:d._eid,is_template:d._is_template,send_type:"LeftNav",closable:false,closeAction:"hide",desired_aid:d._aid,listeners:{hide:function(){d._dehighlightAllTaskItems();}}});this.upload=new ECM.CMS.Nav.UploadFlyout({mid:d._mid,mtype:d._mtype,aid:d._aid,upload_url:"/m/service/content_upload",isPriv:ECM.CMS.priv,hideCallback:function(){d._dehighlightAllTaskItems();}});var g="";if(Ext.isDefined(Ext.getCmp("contentPanelId"))){if(!Ext.isEmpty(Ext.getCmp("contentPanelId").activeTab)){g=Ext.getCmp("contentPanelId").getActiveEditor(true);}}var h=Ext.isDefined(Ext.getCmp("socialMediaPanelId"))?"Social Media":"";var b=["/m/mailers/mailings/preview",[["aid",this._aid].join("="),["mid",this._mid].join("="),["mtype",this._mtype].join("="),["mfid",this._mfid].join("="),["eid",this._eid].join("="),["format",g].join("="),["script",h].join("=")].join("&")].join("?");Ext.get("preview_and_qa").dom.href=b;Ext.get("preview_and_qa").dom.target="_PREVIEW";var f=Ext.get("schedule_mailing");
if(!Ext.isEmpty(f)){f.on("click",function(j){j.preventDefault();d._highlightTask("schedule_mailing");d._hideFlyouts();d._setPositionFlyout(d.scheduleFlyout);d.scheduleFlyout.show();});f.on("contextmenu",function(k){var j=window.location.href.replace(/#.*$/,"");j=j.replace(/&flyout=[^&#]*/,"");f.dom.href=j+"&flyout=schedule"+window.location.hash;});}var c=Ext.get("send_tests");if(!Ext.isEmpty(c)){c.on("click",function(j){j.preventDefault();d._highlightTask("send_tests");d._hideFlyouts();d._setPositionFlyout(d.sendTest);d.sendTest.show();});c.on("contextmenu",function(k){var j=window.location.href.replace(/#.*$/,"");c.dom.href=j+"&flyout=sendtest"+window.location.hash;});}var a=Ext.get("upload_content");if(!Ext.isEmpty(a)){a.on("click",function(){if(!Ext.isDefined(Ext.getCmp("contentPanelId"))){d.publish("/cms/load/content");d.openUploadFlyout=true;}else{d._openUploadContent();}});a.on("contextmenu",function(k){var j=window.location.href.replace(/#.*$/,"");a.dom.href=j+"&flyout=upload"+window.location.hash;});}},_openUploadContent:function(){var b=this;var a=b.upload;var c=a.uploadWindow;b.openUploadFlyout=false;if(!c||!c.getVisibilityEl()||!c.isVisible()){b._highlightTask("upload_content");b._hideFlyouts();a.setMode("content");a.init();a.display();b._setPositionFlyout(b.upload.uploadWindow);}},_openFlyouts:function(){if(this._flyout==="schedule"){this._highlightTask("schedule_mailing");this._hideFlyouts();this._setPositionFlyout(this.scheduleFlyout);this.scheduleFlyout.show();}else{if(this._flyout==="sendtest"){this._highlightTask("send_tests");this._hideFlyouts();this._setPositionFlyout(this.sendTest);this.sendTest.show();}else{if(this._flyout==="upload"){if(this.upload.uploadWindow&&this.upload.uploadWindow.isVisible()){return;}this._highlightTask("upload_content");this._hideFlyouts();this.upload.setMode("content");this.upload.init();this.upload.display();this._setPositionFlyout(this.upload.uploadWindow);}}}},_setPositionFlyout:function(a){var c=this.getPosition()[0]+this.getInnerWidth();var b=this.getPosition()[1];a.setPosition(c,b);},_openPreviewWindow:function(){var b="";if(Ext.isDefined(Ext.getCmp("contentPanelId"))){if(!Ext.isEmpty(Ext.getCmp("contentPanelId").activeTab)){b=Ext.getCmp("contentPanelId").getActiveEditor(true);}else{b="";}}else{b="";}var c=Ext.isDefined(Ext.getCmp("socialMediaPanelId"))?"Social Media":"";var a=["/m/mailers/mailings/preview",[["aid",this._aid].join("="),["mid",this._mid].join("="),["mtype",this._mtype].join("="),["mfid",this._mfid].join("="),["eid",this._eid].join("="),["format",b].join("="),["script",c].join("=")].join("&")].join("?");window.open(a,"_PREVIEW");},checkLibraryTag:function(f){var d=Ext.getCmp("cmsShell")._activePanel;if(d.id!=="settingsFormPanel"&&d.id!=="contentPanelId"){return;}var g=this;var b=f.tag.length;var c=f.tag.substring(2,b-this.dcTagBackTruncateCount);var h=c.toUpperCase();var a=ECM.Form.DCEditor.data("DC");if(a[0][h]){if(this.dcLibOverwrite.indexOf(c)===-1){Ext.Msg.confirm(gt.gettext("Overwrite"),gt.strargs(gt.gettext('Dynamic Content tag "%1" already exists in this mailing. Overwrite?'),[c]),function(j){if(j==="yes"){g.dcLibOverwrite.push(c);g._dropLibTag(f);}});return false;}else{this._dropLibTag(f);}}else{this.dcLibOverwrite.push(c);this._dropLibTag(f);}},_dropLibTag:function(d){if(d.editorType==="extjseditor"){Ext.getCmp("extjseditor").insertAtCursor(d.tag);}else{d.editorType.replaceRange(d.tag,d.replaceFrom,d.replaceTo);}var b=d.tag.length;var c=d.tag.substring(2,b-this.dcTagBackTruncateCount);var f=c.toUpperCase();var a=ECM.Form.DCEditor.data("DC");if(!a[0][f]&&!(c in this.libTags)){this.libTags[f]=[c];Ext.apply(a[0],this.libTags);this.resetCodeMirror(a[0]);}},resetCodeMirror:function(a){var b=Ext.getCmp("cmsShell")._activePanel;if(b.id==="contentPanelId"||b.id==="settingsFormPanel"){b.resetCodeMirror(a);}}});ECM.provide("ECM.Mailing.Modal.Copy");ECM.Mailing.Modal.Copy=Ext.extend(ECM.Window,{refreshCallback:Ext.emptyFn,eventId:"",constructor:function(f){this._selectedMailings=f.selectedMailings;this._numberOfMailings=f.selectedMailings.length;this._mtype=f.mtype;this._isTemplate=f.isTemplate;var b=this;var h=function(){this.refreshCallback();this._copyWindow.close();};var c=function(){this._templateExisted();};var j=new Ext.Button({text:gt.gettext("Cancel"),scope:this,handler:h});var d=new Ext.Button({text:gt.gettext("Create"),scope:this,handler:c});var g;if(this._isTemplate){g=(this._numberOfMailings>1)?gt.gettext("Copy Multiple Templates"):gt.gettext("Copy Template");}else{g=(this._numberOfMailings>1)?gt.gettext("Copy Multiple Mailings"):gt.gettext("Copy Mailing");}var a=(this._numberOfMailings>9)?500:"";Ext.QuickTips.init();this._copyPanel=this._getCopyPanel();this._copyWindow=new ECM.Window({title:g,width:620,height:a,autoScroll:true,autoHeight:false,closable:true,cls:"cm_text_align_left",windowButtons:[d,j],listeners:{beforeclose:function(){b.refreshCallback();}},items:[this._copyPanel]});ECM.Mailing.Modal.Copy.superclass.constructor.apply(this,arguments);},setSelections:function(a){this._selectedMailings=a;this._numberOfMailings=a.length;},getContainer:function(){return this._copyWindow;},_getCopyPanel:function(){var f=this._selectedMailings;var h=[];for(var d=0;d<this._numberOfMailings;d++){var c=f[d].data.name;var b=f[d].data.id;var a=(d>0)?"copy_multiple_separator":"";h.push({html:gt.gettext("Copying")+" "+c,cls:"copy_mailing "+a});h.push({xtype:"label",id:"error"+d,cls:"cm_error"});h.push({xtype:"textfield",fieldLabel:this._isTemplate?gt.gettext("New template name"):gt.gettext("New mailing name"),id:"copy"+d,name:"name"+d,value:[gt.gettext("Copy of"),(function(k){var j=document.createElement("div");j.innerHTML=k;return j.childNodes.length===0?"":j.childNodes[0].nodeValue;})(c)].join(" "),allowBlank:false,vtype:"mailingNameFormat",vtypeText:gt.gettext("Invalid name."),invalidText:gt.gettext("Invalid name."),minLength:1,maxLength:100,maxLengthText:gt.gettext("Name cannot exceed 100 characters."),width:400,msgTarget:"side",bodyStyle:"padding:10px 0"});h.push({xtype:"hidden",name:"mid"+d,value:b});}var g=new Ext.form.FormPanel({url:"/cm/mailing/copy",ctCls:"mailing_window",itemCls:"copy_mailing_form",items:h,listeners:{afterrender:function(){this.body.dom.parentNode.parentNode.parentNode.style.position="relative";Ext.getCmp("copy0").focus(true,500);}}});return g;},_templateExisted:function(){if(!this.isTemplate){this._copyHandler();return;}var b=this._copyWindow.findByType("textfield");var f=[];var a=[];Ext.each(b,function(h){var g=h.getValue().trim();if(g){if(f.indexOf(g)!==-1){if(a.indexOf(g)===-1){a.push(g);}}else{f.push(g);}}});if(a.length>0){this._copyWindow.notify.error(gt.gettext("Template ")+a.join(",")+gt.gettext(" duplicated. Please retry with different names"));return;}var d=new Ext.LoadMask(this._copyWindow.el,{msg:gt.gettext("Checking template name. Please wait...")});d.show();var c=this;ECM.Ajax.request({url:(c._mtype==2)?"/cm/r/mailing/templates_event":"/cm/r/mailing/templates",method:"GET",params:{filter:Ext.encode(["name","=",f])},success:function(h){d.hide();var j=h.responseJSON.data;if(j.data.length===0){c._copyHandler();}else{var g=[];Ext.each(j.data,function(k){g.push(k[1]);});c._copyWindow.notify.error(gt.gettext("Template ")+g.join(",")+gt.gettext(" existed. Please retry with different names"));}},failure:function(){d.hide();c._copyWindow.notify.error(gt.gettext("Unable to copy as there was unexpected network errors. Please try again."));}});},_copyHandler:function(){var f=this._copyPanel;var d=this;var a;for(a=0;a<this._numberOfMailings;a++){Ext.getCmp("error"+a).setText("");}var c;if(this._isTemplate){c=gt.ngettext("Copying template. Please wait...","Copying templates. Please wait...",this._numberOfMailings);}else{c=gt.ngettext("Copying mailing. Please wait...","Copying mailings. Please wait...",this._numberOfMailings);}var b=new Ext.LoadMask(Ext.getBody(),{msg:c});this._copyWindow.notify.clear();b.show();ECM.Ajax.request({url:"/cm/mailing/copy",method:"POST",loadMask:true,params:f.getForm().getValues(),success:function(g,k){b.hide();
var h=g.responseJSON;if(h.authorization_errors.length<1&&h.authentication_error<1&&h.application_errors.length<1&&h.error.length<1){if(d._numberOfMailings===1){var j="";if(d._isTemplate&&d._mtype==ECM.Rules.Constants.MAILING.TRIGGERED){j=d.eventId;}var l=["/cm/mailing/cms",[["desired_aid",ECM.Stash.desired_aid].join("="),["mid",h.data.mid_0].join("="),["mtype",d._mtype].join("="),["eid",j].join("=")].join("&")].join("?");window.location=l+"#settings";}else{d._copyWindow.close();ECM.publish("/notify/info/show",{selector:".error_display",message:gt.gettext("The selected mailings have been copied")});d.refreshCallback();}}},failure:function(q,k){var j=q.responseJSON;if(!Ext.isEmpty(j.application_errors)){d._copyWindow.notify.error("One of your inputs is incorrect. Please fix and try again.");var o=j.application_errors;var l=j.application_errors.length;for(a=0;a<l;a++){var n=o[a];var m=n.indexOf("]");var p="error"+n.substring(5,m);var h=n.substring(m+2);var g=Ext.getCmp(p);g.setText(h);g.setVisible();g.show();}}else{d._copyWindow.notify.error("Unable to copy. Please try again.");}b.hide();}});},show:function(){this._copyWindow.show();}});Ext.reg("ecm.mailing.modal.copy",ECM.Mailing.Modal.Copy);ECM.provide("ECM.CMS.Modal.SelectTemplate");ECM.CMS.Modal.SelectTemplate=Ext.extend(ECM.Window,{id:"templateModal",title:gt.gettext("Select Template"),width:800,height:600,modal:true,constructor:function(a){Ext.apply(this,a);ECM.CMS.Modal.SelectTemplate.superclass.constructor.call(this);},initComponent:function(){var b=this;var a=new Ext.LoadMask(Ext.getDom("outerDiv")||Ext.getBody(),{msg:gt.gettext("Getting template(s)...")});a.show();ECM.Ajax.request({url:"/cm/r",params:{batch:Ext.encode([{url:(b.mtype==2)?"/cm/r/mailing/templates_event":"/cm/r/mailing/templates",params:{dir:"ASC",sort:"name",as_kvp:1}},{url:"/cm/r/library/image/template_urls",params:{as_kvp:1}}])},success:function(g){a.hide();var d=Ext.decode(g.responseText);if(d&&d.data&&d.data.data&&d.data.data[0]&&d.data.data[0].data&&d.data.data[0].data.data){if(d.data.data[0].data.data.length){var c={};Ext.iterate(d.data.data[1].data.data,function(h){this[h.name]=h.url;},c);var f=new ECM.CMS.templateContainer({templates:d.data.data[0].data.data,mid:b.mid,page:b.page,templateUrls:c});b.add(f);b.doLayout();b.show();}else{b.publish("/cms/error/add",{message:gt.gettext("No available templates.")});b.loadPage(b.page);}}else{b.publish("/cms/error/add",{message:gt.gettext("Unable to load templates.")});b.loadPage(b.page);}},failure:function(){a.hide();b.publish("/cms/error/add",{message:gt.gettext("Fail to get template(s)")});b.loadPage(b.page);}});this.buttons=[{text:gt.gettext("Skip"),cls:"blue_button",handler:function(){this.loadPage(this.page);this.close();}.createDelegate(this)}];ECM.CMS.Modal.SelectTemplate.superclass.initComponent.call(this);this.addEvents("loadsettings","loadcontent");},closeModal:function(){this.loadPage(this.page);this.close();},loadPage:function(a){if(a==="settings"){this.fireEvent("loadsettings");}else{if(a==="content"){this.fireEvent("loadcontent");}}},reloadPage:function(b){var a=Ext.getCmp("leftnav_dc");if(Ext.isDefined(a)){if(Ext.isDefined(a.tree)){a.refreshTree();}else{if(!a.newDcTree.hidden){a.loadTreeData();}}}this.loadPage(b);},closeAction:"closeModal"});ECM.CMS.templateContainer=Ext.extend(Ext.Container,{layout:"table",defaults:{bodyStyle:"padding:2px"},layoutConfig:{columns:3},height:300,overflow:"auto",autoScroll:true,constructor:function(a){Ext.apply(this,a);this.items=[this.getComponents()];ECM.CMS.templateContainer.superclass.constructor.call(this,a);},DEFAULT_IMAGE:"/images/template_missing.png",getComponents:function(){var a=this;return[{xtype:"container",html:gt.gettext("Select the template you need to start entering your content, by clicking on the template. Already have HTML to enter or upload? You can skip this step and go to the Content section to enter, or skip and select the Upload option in the left navigation to upload content. You can always change templates once selected."),colspan:3},{xtype:"container",colspan:3,items:[{xtype:"spacer",height:10}]},a.templates.map(function(b){return a.getImageComponent(b);})];},getThumbnail:function(a){return this.templateUrls[a]?this.templateUrls[a]:this.DEFAULT_IMAGE;},getImageComponent:function(a){var b=this;return[{xtype:"container",layout:"column",width:200,defaults:{bodyStyle:"padding:2px"},items:[{xtype:"container",items:[{xtype:"box",id:a.id,autoEl:{tag:"img",style:"cursor: pointer",src:this.getThumbnail(a.id)},width:200,height:200,listeners:{render:function(c){c.getEl().on("click",function(d){b.selectTemplateEventListener(a);},c);}}}]},{xtype:"container",items:[{xtype:"label",html:a.name,style:"cursor: pointer",listeners:{render:function(){this.el.on("click",function(c){b.selectTemplateEventListener(a);},this);}}}]},{xtype:"container",items:[{xtype:"spacer",height:30}]}]}];},selectTemplateEventListener:function(b){var c=this;var a=new Ext.LoadMask(c.ownerCt.body.dom,{msg:gt.gettext("Applying template to mailing...")});a.show();ECM.Ajax.request({url:"/cm/template/apply_template_to_mailing",method:"POST",params:{template_id:b.id,mailing_id:c.mid,mid:c.mid},template_id:b.id,mailing_id:c.mid,success:function(d){a.hide();Ext.getCmp("templateModal").reloadPage(c.page);Ext.getCmp("templateModal").close();ECM.publish("/cms/updateMailingTitle",{template_title:d.responseJSON.data.last_template_selected,mailing_status:"("+gt.gettext("Not Approved")+")"});},failure:function(){a.hide();Ext.getCmp("templateModal").notify.error(gt.gettext("Fail to apply template to mailing!"));}});}});Ext.reg("ecm.modalselecttemplate",ECM.CMS.Modal.SelectTemplate);ECM.provide("ECM.CMS.Modal.ConfirmChange");ECM.CMS.Modal.ConfirmChange=Ext.extend(ECM.Window,{title:gt.gettext("Change Template Confirmation"),modal:true,closable:true,constructor:function(a){this.mid=a.mid;this.mtype=a.mtype;ECM.CMS.Modal.ConfirmChange.superclass.constructor.call(this);},initComponent:function(){var a=this;this.items=[{html:gt.gettext("Changing your template will erase all changes you have made and additional content you have entered. Would you like to continue and change templates?")}],this.windowButtons=[{scope:this,text:gt.gettext("Continue"),cls:"blue_button",handler:function(){this.close();new ECM.CMS.Modal.SelectTemplate({mid:a.mid,mtype:a.mtype,page:"content",listeners:{loadcontent:function(){a.publish("/cms/load/content");}}});}},{scope:this,text:gt.gettext("Cancel"),cls:"blue_button",handler:function(){this.close();}}];ECM.CMS.Modal.ConfirmChange.superclass.initComponent.call(this);}});ECM.provide("ECM.CMS.Panel.Nav");ECM.CMS.Panel.Nav=Ext.extend(Ext.Panel,{constructor:function(a){this._mailingID=a.mid;this._isTemplate=a.isTemplate;this._mtype=a.mtype;this._desired_aid=a.desired_aid;this._eid=a.eid;if(a.mailingName){this._mailingName=a.mailingName;}if(a.approved){this._approved=a.approved;}if(a.templatesEnabled){this._templateSelected=a.templateSelected||"";this._templatesEnabled=a.templatesEnabled;}this._pageTitle=this._getPageTitle();this.panelTabs=a.panelTabs;a=Ext.apply({layout:"anchor",id:"mailing_nav_panel",hideBorders:true,border:false,header:false,items:this.getChildren()},a);ECM.CMS.Panel.Nav.superclass.constructor.call(this,a);},getChildren:function(){var j=this;ECM.subscribe("/cms/updateMailingTitle",function(m){if(Ext.isDefined(m.mailing_name)&&Ext.isDefined(Ext.get("header_mailing_name"))){Ext.get("header_mailing_name").dom.innerHTML=m.mailing_name;}if(Ext.isDefined(m.mailing_status)&&Ext.isDefined(Ext.get("header_mailing_status"))){Ext.get("header_mailing_status").dom.innerHTML=m.mailing_status;}if(Ext.isDefined(m.template_title)&&Ext.isDefined(Ext.get("header_template_title"))){Ext.get("header_template_title").dom.innerHTML=gt.strargs(gt.gettext("Selected template: %1"),[m.template_title]);}});var a=new Ext.Button({text:gt.gettext("Go To Event"),cls:"blue_button",handler:function(m){var o=["/cm/event/edit",[["desired_aid",j._desired_aid].join("="),["eid",j._eid].join("=")].join("&")].join("?");
try{window.location=o;}catch(n){}}});var l=new Ext.Button({text:gt.gettext("Copy"),cls:"blue_button",handler:function(m){var n=new Array();n.push({data:{name:j._mailingName,id:j._mailingID}});var o=new ECM.Mailing.Modal.Copy({selectedMailings:n,mtype:j._mtype,isTemplate:j._isTemplate});o.getContainer().show();j.publish("/cms/copy");}});var d=new Ext.form.DisplayField({value:"",height:19,width:900});d.addClass("alertCmsField");d.subscribe("/cms/alert/add",function(m){this.removeClass("ecm-error");this.addClass("ecm-alert");if(Ext.isArray(m.message)){this.setHeight(22*m.message.length+1);this.setValue(m.message.join("<br />"));}else{this.setHeight(19);this.setValue(m.message);}},d);d.subscribe("/cms/error/add",function(m){d.removeClass("ecm-alert");d.addClass("ecm-error");if(Ext.isArray(m.message)){this.setHeight(22*m.message.length+1);this.setValue(m.message.join("<br />"));}else{this.setHeight(19);this.setValue(m.message);}},d);d.subscribe("/cms/alert/clear",function(){this.setHeight(19);this.setValue("");},d);d.subscribe("/cms/error/clear",function(){this.setHeight(19);this.setValue("");},d);var k=[];if(j._eid&&!this._isTemplate&&j._desired_aid&&j._mtype==2){k.push(a);}k.push(l);var b=new Ext.Panel({layout:"hbox",baseCls:"x-plain",anchor:"100%",id:"hBoxTitlePanel",height:40,layoutConfig:{align:"top",padding:"0"},defaults:{margins:"0 4 0 0",pressed:false,allowDepress:false},items:[{xtype:"box",id:"labelPanelId",html:j._pageTitle,cls:"page_title",width:"80%",height:40},{xtype:"spacer",flex:1},k]});var c="";for(var f=0;f<this.panelTabs.length;f++){var g=this.panelTabs[f];c+="<li"+(c?"":' class="cm_first"')+' id="navLink_'+g.name+'"><a class="navLink" style="cursor:pointer" id="/cms/load/'+g.name+'">'+g.label+"</a></li>";}var h=new Ext.Panel({layout:"anchor",bodyBorder:false,header:false,id:"navPanelId",items:[new Ext.Template('<div class="cm_sub_tabs" id="navPanelTmplId">',"<ul>",c,"</ul>","</div>")],listeners:{scope:this,afterrender:function(){var m=Ext.get("navPanelId");m.on("click",function(q,p){this.publish(p.id);var n=p.id.replace(/\/cms\/load\//gi,"");_gaq.push(["_trackEvent","CMS Tab",""+n+""]);if(Ext.getCmp("scheduleMailingWindow").isVisible()){Ext.getCmp("scheduleMailingWindow").hide();}if(Ext.getCmp("sendTestWindow").isVisible()){Ext.getCmp("sendTestWindow").hide();}var o=Ext.getCmp("searchAndReplaceModal");if(Ext.isDefined(o)&&o.isVisible()){o.hide();}},this,{delegate:"a.navLink",buffer:100});}}});return[b,d,h];},_publishErrorMsg:function(a,b){if(a.match(/Session Timeout/)){this.publish("/cms/error/add",{message:gt.gettext("Session timeout. Please login again.")});}else{this.publish("/cms/error/add",{message:gt.strargs(gt.gettext("Failed to %1. Please try again."),[b])});}},highlight:function(c){var a="cm_current";var b=Ext.get(c);Ext.select("."+a,Ext.get(c).up("ul")).removeClass(a);b.toggleClass(a);},_getPageTitle:function(){var a=[{tag:"span",id:"header_mailing_name",html:this._mailingName},{tag:"span",html:" "},{tag:"span",id:"header_mailing_status",html:this._approved}];if(this._templatesEnabled&&!this._isTemplate){a=a.concat(this._getTemplateChangeLink());}return a;},_getTemplateChangeLink:function(){var a=this._templateSelected?this._templateSelected:"[ "+gt.gettext("None")+" ]";return[{tag:"span",id:"header_template_title",cls:"font12 cm_font_normal",style:"padding: 5px 10px",html:gt.strargs(gt.gettext("Selected template: %1"),[a])},{tag:"a",href:"#",cls:"strip-wrap-link",html:gt.gettext("Change"),onclick:["new ECM.CMS.Modal.ConfirmChange({","mid:",this._mailingID,",","mtype:",this._mtype,"}).","show();"].join("")}];}});ECM.provide("ECM.Panel.EditorRuler");ECM.Panel.EditorRuler=Ext.extend(Ext.Panel,{FONT_FAMILY:"monospace",height:15,initComponent:function(){this.html=this._generateRuler();this.bodyStyle="margin-left:23px; font-family: "+this.FONT_FAMILY;ECM.Panel.EditorRuler.superclass.initComponent.apply(this,arguments);},_generateRuler:function(){var b="1";for(var a=10;a<200;a+=10){if(a==10){b+="-------";}else{if(a>90){b+="-------";}else{b+="--------";}}b+=a;}return b.replace(/-+$/,"");}});Ext.reg("ecm.editorruler",ECM.Panel.EditorRuler);ECM.provide("ECM.Plugins.HtmlEditor.ModalInsertImage");ECM.Plugins.HtmlEditor.ModalInsertImage=Ext.extend(ECM.Window,{title:gt.gettext("Image Properties"),width:600,scrollable:true,constructor:function(c){var d=this;var b=Ext.isDefined(c.imgAttributes.src);Ext.apply(this,c);Ext.QuickTips.init();this.topPanel=new Ext.Panel({region:"north",height:130,layout:"form",items:[{xtype:"textfield",fieldLabel:gt.gettext("Image URL"),value:b?c.imgAttributes.src:undefined,width:430,allowBlank:false,blankText:gt.gettext("Please enter a valid URL."),vtype:"url",vtypeText:gt.gettext("This is not a valid url. Please make sure you have entered a valid URL."),msgTarget:"side",listeners:{change:function(){if(this.isValid()){d.loadMask.show();d.notify.clear();d.imgPreview.dom.setAttribute("src",this.getValue());}else{d.imgPreview.dom.removeAttribute("src");d._onImgErrorEvent();}},invalid:function(){d.okButton.disable();},valid:function(){d.okButton.enable();},afterrender:function(){d.srcField=this;}}},{xtype:"textfield",fieldLabel:gt.gettext("Alternative Text"),width:430,value:c.imgAttributes.alt,listeners:{afterrender:function(){d.altField=this;}}},{xtype:"textfield",fieldLabel:gt.gettext("Target Link"),width:430,value:c.imgAttributes.href,listeners:{afterrender:function(){d.arefField=this;}}},{xtype:"combo",fieldLabel:gt.gettext("Target Window"),emptyText:gt.gettext("<not set>"),editable:true,triggerAction:"all",typeAhead:true,mode:"local",width:200,listWidth:200,validator:function(f){if(!this.findRecord(this.displayField,f)){this.clearValue();}return true;},store:new Ext.data.ArrayStore({fields:["targetValue","displayText"],data:[["_blank",gt.gettext("New Window")+" (_blank)"],["_top",gt.gettext("Topmost Window")+" (_top)"],["_self",gt.gettext("Same Window")+" (_self)"],["_parent",gt.gettext("Parent Window")+" (_parent)"]]}),valueField:"targetValue",displayField:"displayText",value:c.imgAttributes.target,listeners:{afterrender:function(){d.arefTargetField=this;}}}],listeners:{afterrender:function(){if(!b){return;}this.insert(1,{xtype:"checkbox",boxLabel:gt.gettext("Keep width and height of previous image."),height:20,listeners:{check:function(){if(this.checked==true){d.leftPanel.items.items[3].setValue(false);d._onImgLoadEvent();}},afterrender:function(){d.keepOldWHBox=this;}}});this.setHeight(this.height+10);}}});this.leftPanel=new Ext.Panel({region:"west",width:200,layout:"form",labelWidth:60,items:[{xtype:"spacer",height:20},{xtype:"numberfield",fieldLabel:gt.gettext("Width"),width:100,allowNegative:false,allowDecimals:false,enableKeyEvents:true,value:c.imgAttributes.width,msgTarget:"side",validator:function(f){if(f==="0"){return gt.gettext("Width cannot be 0.");}return true;},listeners:{keyup:function(){if(!this.isValid()){return;}if(d.keepOldWHBox){d.keepOldWHBox.setValue(false);}if(d.leftPanel.items.items[3].getValue()){d._adjustWH(this.getValue(),"height");}if(d.imgPreview.dom.style.visibility==="hidden"){return;}d._modifyPreviewAttr("width","width",this.getValue());d._modifyPreviewAttr("height","height",d.leftPanel.items.items[2].getValue());},valid:function(){if(d.leftPanel.items.items[2].isValid()){d.okButton.enable();}},invalid:function(){d.okButton.disable();}}},{xtype:"numberfield",fieldLabel:gt.gettext("Height"),width:100,allowNegative:false,allowDecimals:false,enableKeyEvents:true,value:c.imgAttributes.height,msgTarget:"side",validator:function(f){if(f==="0"){return gt.gettext("Height cannot be 0.");}return true;},listeners:{keyup:function(){if(!this.isValid()){return;}if(d.keepOldWHBox){d.keepOldWHBox.setValue(false);}if(d.leftPanel.items.items[3].getValue()){d._adjustWH(this.getValue(),"width");}if(d.imgPreview.dom.style.visibility==="hidden"){return;}d._modifyPreviewAttr("width","width",d.leftPanel.items.items[1].getValue());d._modifyPreviewAttr("height","height",this.getValue());},valid:function(){if(d.leftPanel.items.items[1].isValid()){d.okButton.enable();
}},invalid:function(){d.okButton.disable();}}},{xtype:"checkbox",boxLabel:gt.gettext("Lock ratio"),checked:true,listeners:{check:function(h,j){if(!d.firstLoad&&j){if(d.keepOldWHBox){d.keepOldWHBox.setValue(false);}var g=d.leftPanel.items.items[1].getValue();var f=d.leftPanel.items.items[2].getValue();if(!Ext.isEmpty(g)){d._adjustWH(g,"height");}else{if(!Ext.isEmpty(f)){d._adjustWH(f,"width");}}if(d.imgPreview.dom.style.visibility==="hidden"){return;}d._modifyPreviewAttr("width","width",d.leftPanel.items.items[1].getValue());d._modifyPreviewAttr("height","height",d.leftPanel.items.items[2].getValue());}}}},{xtype:"button",cls:"blue_button",text:gt.gettext("Reset Size"),handler:function(){if(d.keepOldWHBox){d.keepOldWHBox.setValue(false);}d._resetSize();if(d.imgPreview.dom.style.visibility==="hidden"){return;}d._modifyPreviewAttr("width","width",d.leftPanel.items.items[1].getValue());d._modifyPreviewAttr("height","height",d.leftPanel.items.items[2].getValue());}},{xtype:"spacer",height:50},{xtype:"numberfield",fieldLabel:gt.gettext("Border"),width:100,allowNegative:false,allowDecimals:false,enableKeyEvents:true,value:c.imgAttributes.border,msgTarget:"side",listeners:{keyup:function(){if(!this.isValid()||d.imgPreview.dom.style.visibility==="hidden"){return;}var f=this.getValue();f=Ext.isEmpty(f)?null:(f+"px solid black");if(Ext.isIE&&!f){d.imgPreview.dom.style.setAttribute("border","");}else{d._modifyPreviewAttr("border","border",f);}}}},{xtype:"numberfield",fieldLabel:gt.gettext("HSpace"),width:100,allowNegative:false,allowDecimals:false,enableKeyEvents:true,value:c.imgAttributes.marginlr,msgTarget:"side",listeners:{keyup:function(){if(!this.isValid()||d.imgPreview.dom.style.visibility==="hidden"){return;}var f=this.getValue();d._modifyPreviewAttr("margin-left","margin-left",f);d._modifyPreviewAttr("margin-right","margin-right",f);}}},{xtype:"numberfield",fieldLabel:gt.gettext("VSpace"),width:100,allowNegative:false,allowDecimals:false,enableKeyEvents:true,value:c.imgAttributes.margintb,msgTarget:"side",listeners:{keyup:function(){if(!this.isValid()||d.imgPreview.dom.style.visibility==="hidden"){return;}var f=this.getValue();d._modifyPreviewAttr("margin-top","margin-top",f);d._modifyPreviewAttr("margin-bottom","margin-bottom",f);}}},{xtype:"combo",fieldLabel:gt.gettext("Align"),emptyText:gt.gettext("<not set>"),editable:true,triggerAction:"all",typeAhead:true,width:100,mode:"local",validator:function(f){if(!this.findRecord(this.displayField,f)){this.clearValue();}return true;},store:new Ext.data.ArrayStore({fields:["floatValue","displayText"],data:[["left",gt.gettext("Left")],["right",gt.gettext("Right")]]}),valueField:"floatValue",displayField:"displayText",value:c.imgAttributes.align,listeners:{change:function(){if(!this.isValid()||d.imgPreview.dom.style.visibility==="hidden"){return;}d._modifyPreviewAttr("float","float",this.getValue());}}}]});this.previewPanel={region:"center",items:[{html:gt.gettext("Preview")},{height:300,width:350,id:"HtmlInsertImagePreview",autoScroll:true,html:'<table><tbody><tr><td><img id="imgpreview" style="visibility: hidden; width: 0px; height: 0px;">Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Maecenas feugiat consequat diam. Maecenas metus. Vivamus diam purus, cursus a, commodo non, facilisis vitae, nulla. Aenean dictum lacinia tortor. Nunc iaculis, nibh non iaculis aliquam, orci felis euismod neque, sed ornare massa mauris sed velit.Nulla pretium mi et risus. Fusce mi pede, tempor id, cursus ac, ullamcorper nec, enim. Sed tortor. Curabitur molestie. Duis velit augue, condimentum at, ultrices a, luctus ut, orci. Donec pellentesque egestas eros. Integer cursus, augue in cursus faucibus, eros pede bibendum sem, in tempus tellus justo quis ligula. Etiam eget tortor. Vestibulum rutrum, est ut placerat elementum, lectus nisl aliquam velit, tempor aliquam eros nunc nonummy metus. In eros metus, gravida a, gravida sed, lobortis id, turpis. Ut ultrices, ipsum at venenatis fringilla, sem nulla lacinia tellus, eget aliquet turpis mauris non enim. Nam turpis. Suspendisse lacinia. Curabitur ac tortor ut ipsum egestas elementum. Nunc imperdiet gravida mauris.</td></tr></tbody></table>'}]};this.okButton=new Ext.Button({text:gt.gettext("OK"),disabled:true,handler:function(){d.fireEvent("insertimage",{src:d.srcField.getValue(),alt:d.altField.getValue(),href:d.arefField.getValue(),target:d.arefTargetField.getValue(),style:d._getImgStyle()});d.close();}});var a={layout:"border",height:460,items:[this.topPanel,this.leftPanel,this.previewPanel]};this.items=[a];this.windowButtons=[this.okButton,{text:gt.gettext("Cancel"),handler:function(){d.close();}}];ECM.Plugins.HtmlEditor.ModalInsertImage.superclass.constructor.call(this,c);this.addEvents("insertimage");},listeners:{afterrender:function(){var a=this.imgAttributes.src;this.firstLoad=a?true:false;this.imgPreview=Ext.get("imgpreview");this.imgPreview.on("load",this._onImgLoadEvent,this);this.imgPreview.on("error",this._onImgErrorEvent,this);this.imgPreview.on("abort",this._onImgErrorEvent,this);this.loadMask=new Ext.LoadMask(Ext.getDom("HtmlInsertImagePreview"));if(a){this.imgPreview.dom.setAttribute("src",a);}}},_getImgStyle:function(){var a=this.leftPanel.items,b={};b.width=a.items[1].getValue();b.height=a.items[2].getValue();b.border=a.items[6].getValue();b.marginlr=a.items[7].getValue();b.margintb=a.items[8].getValue();b.align=a.items[9].getValue()||null;Ext.iterate(b,function(c,d){b[c]=Ext.isEmpty(d)?null:d;});return b;},_adjustWH:function(d,f){if(!this.naturalRatio){return;}var b=this.leftPanel.items;switch(f){case"height":if(Ext.isEmpty(d)){b.items[2].setValue("");}else{var a=(d/this.naturalRatio)*1000;b.items[2].setValue(Math.round(a));}break;case"width":if(Ext.isEmpty(d)){b.items[1].setValue();}else{var c=(d*this.naturalRatio)/1000;b.items[1].setValue(Math.round(c));}break;}},_onImgLoadEvent:function(){this.loadMask.hide();this.okButton.enable();this._clearPreviewStyles();this.naturalHeight=this.imgPreview.getHeight();this.naturalWidth=this.imgPreview.getWidth();this._switchLockRatio();if(this.firstLoad){this.firstLoad=false;}else{this._resetSize();}this._setPreviewAttr("visibility","visible");this._setupPreview();},_onImgErrorEvent:function(){this.notify.error(gt.gettext("Please ensure the URL contains an image."));this.loadMask.hide();this.okButton.disable();this.naturalHeight=this.naturalWidth=undefined;this._clearPreviewStyles();this._setPreviewAttr("visibility","hidden");this._setPreviewAttr("width","0");this._setPreviewAttr("height","0");},_resetSize:function(){var b=this.leftPanel.items;var c=Ext.isDefined(this.keepOldWHBox)&&this.keepOldWHBox.checked?this._getImgAttribute("width"):this.naturalWidth;var a=Ext.isDefined(this.keepOldWHBox)&&this.keepOldWHBox.checked?this._getImgAttribute("height"):this.naturalHeight;b.items[1].setValue(c);b.items[2].setValue(a);},_getImgAttribute:function(a){if(Ext.isDefined(this.imgAttributes[a])){return this.imgAttributes[a];}return"";},_switchLockRatio:function(){this.naturalRatio=this.naturalWidth*1000/this.naturalHeight;if(!this.firstLoad){return;}var c=this.leftPanel.items,d=c.items[1].getValue(),a=c.items[2].getValue();if(!d||!a){c.items[3].setValue(false);return;}var b=d*1000/a;if(Math.round(this.naturalRatio)===Math.round(b)){c.items[3].setValue(true);}else{c.items[3].setValue(false);}},_modifyPreviewAttr:function(a,c,b){if(Ext.isEmpty(b)){this._removePreviewAttr(a);}else{this._setPreviewAttr(c,b);}},_setPreviewAttr:function(a,b){if(Ext.isIE){this.imgPreview.dom.style.setAttribute(this._toggleCase(this._getIEStyle(a)),b);}else{this.imgPreview.dom.style.setProperty(a,b,null);}},_removePreviewAttr:function(a){if(Ext.isIE){this.imgPreview.dom.style.removeAttribute(this._toggleCase(this._getIEStyle(a)));}else{this.imgPreview.dom.style.removeProperty(a);}},_toggleCase:function(a){if(a.match(/-/g)){return a.replace(/-([a-z])/g,function(c,b){return b.toUpperCase();});}else{return a;}},_getIEStyle:function(a){switch(a){case"float":return"styleFloat";
break;default:return a;}},_setupPreview:function(){if(!this.imgPreview||this.imgPreview.dom.style.visibility==="hidden"){return;}var a=this._getImgStyle();a.border=Ext.isEmpty(a.border)?null:(a.border+"px solid black");a["margin-left"]=a["margin-right"]=a.marginlr;a["margin-top"]=a["margin-bottom"]=a.margintb;a["float"]=a.align;delete a.marginlr;delete a.margintb;delete a.align;Ext.iterate(a,function(b,c){this._modifyPreviewAttr(b,b,c);},this);},_clearPreviewStyles:function(){var a=["width","height","border","margin-left","margin-right","margin-top","margin-bottom","float"];Ext.each(a,function(b){this._removePreviewAttr(b);},this);if(Ext.isIE){this.imgPreview.dom.style.setAttribute("border","");}}});ECM.provide("ECM.Plugins.HtmlEditor.Image");ECM.Plugins.HtmlEditor.Image=Ext.extend(Ext.util.Observable,{urlSizeVars:["width","height"],init:function(a){this.langTitle=gt.gettext("Insert Image");this.cmp=a;this.cmp.on("render",this.onRender,this);this.cmp.on("initialize",this.onInit,this,{delay:100,single:true});},onEditorDoubleClick:function(a){this.currentNode=a.getTarget();if(this.currentNode.nodeName!=="IMG"){return;}this.imageProperties();},imageProperties:function(c){if(!Ext.isDefined(this.currentNode)){this.currentNode=c;}if(this.currentNode.nodeName!=="IMG"){return;}var f={},g,b=["left","right","top","bottom"];f.src=this.currentNode.src;f.alt=this.currentNode.alt;f.width=this._getAttr("width")||this.currentNode.getAttribute("width")||this.currentNode.width;f.height=this._getAttr("height")||this.currentNode.getAttribute("height")||this.currentNode.height;f.align=this._getAttr("float")||this.currentNode.getAttribute("align");if(f.align!=="right"&&f.align!=="left"){f.align=null;}var a,l=true;Ext.each(b,function(m){a="border-"+m+"-width";f[a]=this._getAttr(a);},this);f.border=f[a];Ext.each(b,function(m){a="border-"+m+"-width";if(f.border!==f[a]){l=false;return false;}},this);if(!l||Ext.isEmpty(f.border)){f.border=this.currentNode.getAttribute("border");}f.border=f.border||null;var d;Ext.each(b,function(m){d="margin-"+m;f[d]=this._getAttr(d);},this);f.marginlr=f["margin-left"];if(f.marginlr!==f["margin-right"]||Ext.isEmpty(f.marginlr)){f.marginlr=this.currentNode.getAttribute("hspace");}f.marginlr=f.marginlr||null;f.margintb=f["margin-top"];if(f.margintb!==f["margin-bottom"]||Ext.isEmpty(f.margintb)){f.margintb=this.currentNode.getAttribute("vspace");}f.margintb=f.margintb||null;Ext.each(["border","marginlr","margintb","width","height"],function(m){if(typeof(f[m])==="string"&&f[m].match(/\d+/)){f[m]=f[m].match(/\d+/)[0];}});if(this.currentNode.parentNode.nodeName==="A"){var h=this.currentNode.parentNode;f.href=decodeURIComponent(h.getAttribute("href"));f.target=h.getAttribute("target");if(Ext.isIE){var k=window.location.protocol+"//"+window.location.host+window.window.location.pathname;k=k.split("/");k=k.splice(0,k.length-1);k=k.join("/")+"/";var j=new RegExp(k,"gi");f.href=f.href.replace(j,"");}}this.selectImage(f);},onInit:function(){Ext.EventManager.on(this.cmp.getDoc(),{dblclick:this.onEditorDoubleClick,buffer:100,scope:this});},onRender:function(){this.cmp.getToolbar().addSeparator();var a=this.cmp.getToolbar().addButton({iconCls:"x-edit-image",handler:this.selectImage,scope:this,tooltip:{title:this.langTitle,text:gt.gettext("Insert an image into the content.")},overflowText:this.langTitle});},selectImage:function(a){var b=this;this.ModalInsertImage=new ECM.Plugins.HtmlEditor.ModalInsertImage({imgAttributes:a,listeners:{insertimage:function(c){Ext.isDefined(a.src)?b._modifyImage(a,c):b._insertImage(c);}}});this.ModalInsertImage.show();},_insertImage:function(c){var f=Ext.isEmpty(c.style.border)?"":"border: {0}px solid black;",a=Ext.isEmpty(c.style.width)?"":"width: {0}px;",b=Ext.isEmpty(c.style.height)?"":"height: {0}px;",g=Ext.isEmpty(c.style.align)?"":"float: {0};",j=Ext.isEmpty(c.style.margintb||c.style.marginlr)?"":"margin: {0}px {1}px;";f=String.format(f,c.style.border);a=String.format(a,c.style.width);b=String.format(b,c.style.height);g=String.format(g,c.style.align);j=String.format(j,c.style.margintb||0,c.style.marginlr||0);var d='<img src="{0}" alt="{1}" style="{2} {3} {4} {5} {6}" />';d=String.format(d,c.src,c.alt,a,b,j,f,g);if(c.href){var h='<a href="{0}" target="{1}">';h=String.format(h,c.href,c.target);d=h+d+"</a>";}this.cmp.insertAtCursor(d);},_modifyImage:function(d,h){this.currentNode.setAttribute("src",h.src);this.currentNode.setAttribute("alt",h.alt);if(d.border!=h.style.border){this.currentNode.removeAttribute("border");if(Ext.isIE&&Ext.isEmpty(h.style.border)){this.currentNode.style.setAttribute("border","");}else{this._modifyAttrOnChange("border","border-width",h.style.border);}if(h.style.border){var b,f,g=["left","right","top","bottom"];Ext.each(g,function(j){b="border-"+j+"-color";f=this._getAttr(b);if(!f){this._modifyAttrOnChange(b,b,"black");}},this);Ext.each(g,function(j){b="border-"+j+"-style";f=this._getAttr(b);if(!f||f==="none"){this._modifyAttrOnChange(b,b,"solid");}},this);}}if(d.marginlr!=h.style.marginlr){this.currentNode.removeAttribute("hspace");Ext.each(["margin-left","margin-right"],function(j){this._modifyAttrOnChange(j,j,h.style.marginlr);},this);}if(d.margintb!=h.style.margintb){this.currentNode.removeAttribute("vspace");Ext.each(["margin-top","margin-bottom"],function(j){this._modifyAttrOnChange(j,j,h.style.margintb);},this);}if(d.align!=h.style.align){this.currentNode.removeAttribute("align");this._modifyAttrOnChange("float","float",h.style.align);}Ext.each(["width","height"],function(j){this.currentNode.removeAttribute(j);this._modifyAttrOnChange(j,j,h.style[j]);},this);h.href=Ext.isEmpty(h.href)?h.href:encodeURIComponent(h.href);var a=this.currentNode.parentNode;if(this.currentNode.parentNode.nodeName==="A"){if(h.href){a.setAttribute("href",h.href);a.setAttribute("target",h.target);}else{a.parentNode.replaceChild(this.currentNode,a);}}else{if(h.href){Ext.DomHelper.insertBefore(this.currentNode,{tag:"a",href:h.href,target:h.target});var c=this.currentNode.previousSibling;a.removeChild(this.currentNode);c.appendChild(this.currentNode);}}},_modifyAttrOnChange:function(a,c,b){if(Ext.isEmpty(b)){this._removeAttr(a);}else{this._setAttr(c,b);}},_setAttr:function(a,b){if(Ext.isIE){this.currentNode.style.setAttribute(this._toggleCase(this._getIEStyle(a)),b);}else{this.currentNode.style.setProperty(a,b,null);}},_removeAttr:function(a){if(Ext.isIE){this.currentNode.style.removeAttribute(this._toggleCase(this._getIEStyle(a)));}else{this.currentNode.style.removeProperty(a);}},_getAttr:function(a){var b;if(Ext.isIE){b=this.currentNode.style.getAttribute(this._toggleCase(this._getIEStyle(a)));}else{b=this.currentNode.style.getPropertyValue(a);}return b;},_toggleCase:function(a){if(a.match(/-/g)){return a.replace(/-([a-z])/g,function(c,b){return b.toUpperCase();});}else{return a;}},_getIEStyle:function(a){switch(a){case"float":return"styleFloat";default:return a;}}});ECM.provide("ECM.Plugins.HtmlEditor.Table");ECM.Plugins.HtmlEditor.Table=Ext.extend(Ext.util.Observable,{cmd:"table",closeAction:"close",dh:Ext.DomHelper,emptyHtml:Ext.isIE?"":'<br _ecm_dirty="">',init:function(a){this.langTitle=gt.gettext("Insert Table");this.cmp=a;this.cmp.on("render",this.onRender,this);this.nextCell=[];Ext.apply(a,{table:this});},onRender:function(){var a=this.cmp.getToolbar().addButton({iconCls:"x-edit-table",handler:function(){this.tableWindow=this._openTableDialog(true);this.tableWindow.show();},scope:this,tooltip:{title:this.langTitle,text:gt.gettext("Insert a table into the content.")},overflowText:this.langTitle});},_getTableBorderOptions:function(a){return[["",a?gt.gettext("Not Set"):gt.gettext("Not Available")],["1px solid #000",gt.gettext("Solid Thin")],["2px solid #000",gt.gettext("Solid Thick")],["1px dashed #000",gt.gettext("Dashed")],["1px dotted #000",gt.gettext("Dotted")]];},_getAlignmentOptions:function(){return[["",gt.gettext("Not Set")],["left",gt.gettext("Left")],["right",gt.gettext("Right")],["center",gt.gettext("Center")]];
},_getLanguageDirectionOptions:function(){return[["",gt.gettext("Not Set")],["ltr",gt.gettext("Left to Right")],["rtl",gt.gettext("Right to Left")]];},_getHeadersOptions:function(a){return[["",a?gt.gettext("Not Set"):gt.gettext("Not Available")],["firstrow",gt.gettext("First Row")],["firstcolumn",gt.gettext("First Column")],["both",gt.gettext("Both")]];},_getStyleOptions:function(){return[["px",gt.gettext("pixels")],["%",gt.gettext("percent")]];},_getVerticalAlignmentOptions:function(){return[["",gt.gettext("Not Set")],["top",gt.gettext("Top")],["middle",gt.gettext("Middle")],["bottom",gt.gettext("Bottom")],["baseline",gt.gettext("Baseline")]];},_getWordWrapOptions:function(){return[["",gt.gettext("Yes")],["nowrap",gt.gettext("No")]];},_getCellTypeOptions:function(){return[["TD",gt.gettext("Data")],["TH",gt.gettext("Header")]];},tableProperties:function(b){var a=this._getTableNode(b);this.tableNode=a;this.tableCaption=this._getTableCaption(a);this.tableId=this._getAttributeValue(a,"id");this.tableCellPadding=this._getAttributeValue(a,"cellPadding");this.tableCellSpacing=this._getAttributeValue(a,"cellSpacing");this.tableClass=this._getAttributeValue(a,"class");this.tableBorder=this._getAttributeValue(a,"border",true);this.tableAlign=this._getAttributeValue(a,"align");this.tableSummary=this._getAttributeValue(a,"summary");this.tableDir=this._getAttributeValue(a,"dir");this.tableStyle=this._getStyle(a);this.totalColumns=this._getTotalColumns(b);this.totalRows=this._getTotalRows(b);var c=this._getHeightWidthFromStyle(this.tableStyle);this.tableHeight=c[0];this.tableWidth=c[1];this.heightFormat=c[2];this.widthFormat=c[3];this.tableHeight=parseInt(this.tableHeight,10);this.tableWidth=parseInt(this.tableWidth,10);this.tableWindow=this._openTableDialog(false);this.tableWindow.show();},cellProperties:function(c){this.node=c;var b=this._getStyle(c);var a=this._getHeightWidthFromStyle(b);this.cellHeight=a[0];this.cellWidth=a[1];this.widthFormat=a[2];this.colspan=this._getColspan(c);this.rowspan=this._getRowspan(c);this.bordercolor=this._getOtherCellPropertiesFromStyle("border-color",b);if(Ext.isIE&&Ext.isEmpty(this.bordercolor)){this.bordercolor=this._getOtherCellPropertiesFromStyle("border-top-color",b);}this.backgroundcolor=this._getOtherCellPropertiesFromStyle("background-color",b);this.horizontalignment=this._getOtherCellPropertiesFromStyle("text-align",b);this.verticalalignment=this._getOtherCellPropertiesFromStyle("vertical-align",b);this.nowrap=this._getOtherCellPropertiesFromStyle("white-space",b);this.cellType=c.nodeName;this.cellWindow=this._openCellDialog();this.cellWindow.show();},_getHeightWidthFromStyle:function(a){var d=/height:\s*(\d+)(px|%)/i;var h=/width:\s*(\d+)(px|%)/i;var k="";var b="";var g;var f;if(d.test(a)){var j=d.exec(a);k=j[1];g=j[2];}if(h.test(a)){var c=h.exec(a);b=c[1];f=c[2];}if(!Ext.isDefined(g)){g=f;}if(!Ext.isDefined(f)){f=g;}if(!Ext.isDefined(f)){g="px";f="px";}return[k,b,g,f];},_getOtherCellPropertiesFromStyle:function(d,c){var b=new RegExp(d+"\\s*:\\s*([^;]*);?","i");var a=b.exec(c);if(!Ext.isEmpty(a)){return a[1];}return"";},_setHeightWidthToStyle:function(d,k,j,b){var c=/(height:\s*)(\d+)(px|%)/i;var g=/(width:\s*)(\d+)(px|%)/i;if(d==="format"){if(c.test(b)){var m=c.exec(b);var f=m[1];var a=m[2];var h=m[3];b=b.replace(f+a+h,"height: "+a+j);}if(g.test(b)){var m=g.exec(b);var f=m[1];var a=m[2];var h=m[3];b=b.replace(f+a+h,"width: "+a+j);}}else{var l=(d==="width")?g:c;if(l.test(b)){var m=l.exec(b);var f=m[1];var a=m[2];var h=m[3];if(Ext.isEmpty(k)){b=b.replace(f+a+h,"");b=b.replace(";;",";");b=b.replace(/^;/,"");}else{b=b.replace(f+a,d+": "+k);}}else{if(!Ext.isEmpty(k)){b=d+": "+k+j+";"+b;}}}return b;},_getAttributeValue:function(c,b,d){var a=c.attributes[b];return !Ext.isEmpty(a)?a.value:(d?0:"");},_setAttribute:function(b,c,a){if(!Ext.isDefined(c)){c="";}a.setAttribute(b,c);},_getTotalRows:function(a){return a.parentNode.getElementsByTagName("tr").length||a.parentNode.parentNode.getElementsByTagName("tr").length;},_getTotalColumns:function(c){var b=this;var d=0;if(c.parentNode.getElementsByTagName("tr").length){d=c.parentNode.getElementsByTagName("tr");}else{d=c.parentNode.parentNode.getElementsByTagName("tr");}if(d.length===0){return 0;}else{var a=0;Ext.each(d[0].children,function(f){a+=b._getColspan(f);});return a;}},_getTableCaption:function(b){var a=b.children;var c="";Ext.each(a,function(d){if(d.nodeName==="CAPTION"){c=d.innerHTML;return false;}});return this._trimValue(c);},_trimValue:function(a){a=a.replace(/\n/g,"");a=a.replace(/^\s*/,"");a=a.replace(/\s*$/,"");a=a.replace(/\s+/g," ");return a;},_openTableDialog:function(c){var b=this;var a=new ECM.Window({title:gt.gettext("Table Properties"),closeAction:"close",scrollable:true,cls:"html_table_properties",width:350,items:[{itemId:"insert-table",xtype:"form",border:false,plain:true,items:[{xtype:"numberfield",allowBlank:false,allowDecimals:false,allowNegative:false,minValue:1,blankText:gt.gettext("Number of rows must be a number greater than 0"),minText:gt.gettext("Number of rows must be a number greater than 0"),fieldLabel:gt.gettext("Rows"),value:c?3:this.totalRows,disabled:!c,name:"row",width:60},{xtype:"numberfield",allowBlank:false,allowDecimals:false,allowNegative:false,minValue:1,blankText:gt.gettext("Number of columns must be a number greater than 0"),minText:gt.gettext("Number of columns must be a number greater than 0"),fieldLabel:gt.gettext("Columns"),value:c?2:this.totalColumns,disabled:!c,name:"col",width:60},{xtype:"numberfield",allowDecimals:false,allowNegative:false,fieldLabel:gt.gettext("Cell spacing"),value:c?1:this.tableCellSpacing,name:"cellSpacing",width:60},{xtype:"numberfield",allowDecimals:false,allowNegative:false,fieldLabel:gt.gettext("Cell padding"),value:c?1:this.tableCellPadding,name:"cellPadding",width:60},{xtype:"container",layout:"column",autoWidth:true,fieldLabel:gt.gettext("Width"),items:[{xtype:"numberfield",allowDecimals:false,allowNegative:false,value:c?500:this.tableWidth,name:"width",id:"width",width:60,listeners:{blur:function(){var f=Ext.getCmp("style").getValue();var g=Ext.getCmp("width").getValue();var d=Ext.getCmp("widthoption").getValue();f=b._setHeightWidthToStyle("width",g,d,f);Ext.getCmp("style").setValue(f);}}},{xtype:"spacer",height:10,width:10},{xtype:"combo",name:"widthoption",id:"widthoption",forceSelection:true,mode:"local",editable:false,store:new Ext.data.ArrayStore({autoDestroy:true,fields:["spec","val"],data:this._getStyleOptions()}),listeners:{select:function(){var d=Ext.getCmp("widthoption").getValue();var f=Ext.getCmp("style").getValue();f=b._setHeightWidthToStyle("format",undefined,d,f);Ext.getCmp("style").setValue(f);Ext.get("heightFormat").dom.innerHTML=Ext.getCmp("widthoption").lastSelectionText;},afterrender:function(){setTimeout(function(){var d=Ext.getCmp("widthoption").getValue();if(!Ext.isEmpty&&d!==b.heightFormat){Ext.get("heightFormat").dom.innerHTML=b.heightFormat;}else{Ext.get("heightFormat").dom.innerHTML=Ext.getCmp("widthoption").lastSelectionText;}},250);}},width:90,triggerAction:"all",value:c?"px":this.widthFormat,displayField:"val",valueField:"spec"}]},{xtype:"container",layout:"column",autoWidth:true,fieldLabel:gt.gettext("Height"),items:[{xtype:"numberfield",allowDecimals:false,allowNegative:false,name:"height",id:"height",value:this.tableHeight,width:60,listeners:{blur:function(){var f=Ext.getCmp("style").getValue();var g=Ext.getCmp("height").getValue();var d=Ext.getCmp("widthoption").getValue();f=b._setHeightWidthToStyle("height",g,d,f);Ext.getCmp("style").setValue(f);}}},{xtype:"spacer",height:10,width:10},{html:"pixels",id:"heightFormat"}]},{xtype:"combo",fieldLabel:gt.gettext("Headers"),name:"headers",editable:false,forceSelection:true,mode:"local",disabled:!c,store:new Ext.data.ArrayStore({autoDestroy:true,fields:["spec","val"],data:this._getHeadersOptions(c)}),triggerAction:"all",value:"",displayField:"val",valueField:"spec",anchor:"-15"},{xtype:"combo",fieldLabel:gt.gettext("Alignment"),name:"align",editable:false,forceSelection:true,mode:"local",store:new Ext.data.ArrayStore({autoDestroy:true,fields:["spec","val"],data:this._getAlignmentOptions()}),triggerAction:"all",value:c?"":this.tableAlign,displayField:"val",valueField:"spec",anchor:"-15"},{xtype:"combo",fieldLabel:gt.gettext("Cell Border"),name:"cellborder",editable:false,forceSelection:true,mode:"local",store:new Ext.data.ArrayStore({autoDestroy:true,fields:["spec","val"],data:this._getTableBorderOptions(c)}),disabled:!c,triggerAction:"all",value:"",displayField:"val",valueField:"spec",anchor:"-15"},{xtype:"numberfield",allowDecimals:false,allowNegative:false,fieldLabel:gt.gettext("Border size"),value:c?1:parseInt(this.tableBorder,10),name:"border",width:60},{xtype:"textfield",fieldLabel:gt.gettext("Caption"),name:"caption",disabled:!c,width:200,value:c?"":this.tableCaption},{xtype:"textfield",fieldLabel:gt.gettext("Summary"),name:"summary",value:c?"":this.tableSummary,width:200},{html:"<br />"+gt.gettext("Advanced options")+"<br /><br />",cls:"cm_font_bold"},{xtype:"combo",fieldLabel:gt.gettext("Language Direction"),name:"dir",forceSelection:true,editable:false,mode:"local",store:new Ext.data.ArrayStore({autoDestroy:true,fields:["spec","val"],data:this._getLanguageDirectionOptions()}),triggerAction:"all",value:c?"":this.tableDir,displayField:"val",valueField:"spec",anchor:"-15"},{xtype:"textfield",fieldLabel:gt.gettext("Stylesheet classes"),name:"class",value:c?"":this.tableClass,width:200},{xtype:"textfield",fieldLabel:gt.gettext("Style"),name:"style",id:"style",value:c?"width: 500px;":this.tableStyle,width:200,vtype:"cssText",vtypeText:gt.gettext("You have entered invalid character(s) for Style"),listeners:{blur:function(){var f=Ext.getCmp("style").getValue();
var g=b._getHeightWidthFromStyle(f);var d=g[0];var h=g[1];var j=g[2];var k=g[3];Ext.getCmp("height").setValue(d);Ext.getCmp("width").setValue(h);Ext.getCmp("widthoption").setValue(k);Ext.get("heightFormat").dom.innerHTML=Ext.getCmp("widthoption").lastSelectionText;}}},{xtype:"textfield",fieldLabel:gt.gettext("Id"),name:"id",width:200,value:c?"":this.tableId,vtype:"alphanum"}]}],windowButtons:[{text:c?gt.gettext("Insert"):gt.gettext("Update"),handler:function(){if(c){this._addTable();}else{this._updateTable();}},scope:this},{text:gt.gettext("Cancel"),handler:function(){this.tableWindow.close();},scope:this}]});return a;},_openCellDialog:function(){var b=this;var a=new ECM.Window({title:gt.gettext("Cell Properties"),closeAction:"close",scrollable:true,width:390,items:[{itemId:"table-cell-properties",xtype:"form",border:false,plain:true,bodyStyle:"padding: 10px;",labelWidth:95,labelAlign:"right",items:[{xtype:"container",layout:"column",fieldLabel:gt.gettext("Width"),items:[{xtype:"numberfield",allowDecimals:false,allowNegative:false,value:this.cellWidth,name:"width",id:"width",width:60},{xtype:"spacer",height:10,width:10},{xtype:"combo",name:"widthoption",id:"widthoption",forceSelection:true,editable:false,mode:"local",store:new Ext.data.ArrayStore({autoDestroy:true,fields:["spec","val"],data:this._getStyleOptions()}),listeners:{select:function(){Ext.get("heightFormat").dom.innerHTML=Ext.getCmp("widthoption").lastSelectionText;},afterrender:function(){setTimeout(function(){var c=Ext.getCmp("widthoption").getValue();if(!Ext.isEmpty&&c!==b.heightFormat){Ext.get("heightFormat").dom.innerHTML=b.heightFormat;}else{Ext.get("heightFormat").dom.innerHTML=Ext.getCmp("widthoption").lastSelectionText;}},250);}},width:80,triggerAction:"all",value:this.widthFormat,displayField:"val",valueField:"spec"}]},{xtype:"container",layout:"column",fieldLabel:gt.gettext("Height"),items:[{xtype:"numberfield",allowDecimals:false,allowNegative:false,name:"height",id:"height",value:this.cellHeight,width:60},{xtype:"spacer",height:10,width:10},{html:"pixels",id:"heightFormat"}]},{xtype:"numberfield",fieldLabel:gt.gettext("Rows Span"),allowDecimals:false,allowNegative:false,name:"rowspan",value:this.rowspan,width:60},{xtype:"numberfield",fieldLabel:gt.gettext("Columns Span"),allowDecimals:false,allowNegative:false,name:"colspan",value:this.colspan,width:60},{xtype:"container",layout:"column",fieldLabel:gt.gettext("Border Color"),items:[{xtype:"textfield",name:"bordercolor",value:this.bordercolor,width:60},{xtype:"spacer",height:10,width:10},{xtype:"button",text:gt.gettext("Select"),handler:function(){b._showColorPicker("bordercolor");}}]},{xtype:"container",layout:"column",fieldLabel:gt.gettext("Background Color"),items:[{xtype:"textfield",name:"backgroundcolor",value:this.backgroundcolor,width:60},{xtype:"spacer",height:10,width:10},{xtype:"button",text:gt.gettext("Select"),handler:function(){b._showColorPicker("backgroundcolor");}}]},{xtype:"combo",fieldLabel:gt.gettext("Cell Type"),name:"celltype",forceSelection:true,editable:false,mode:"local",store:new Ext.data.ArrayStore({autoDestroy:true,fields:["spec","val"],data:this._getCellTypeOptions()}),triggerAction:"all",value:this.cellType,displayField:"val",valueField:"spec",anchor:"-15"},{xtype:"combo",fieldLabel:gt.gettext("Word Wrap"),name:"wordwrap",editable:false,forceSelection:true,mode:"local",store:new Ext.data.ArrayStore({autoDestroy:true,fields:["spec","val"],data:this._getWordWrapOptions()}),triggerAction:"all",value:this.nowrap,displayField:"val",valueField:"spec",anchor:"-15"},{xtype:"combo",fieldLabel:gt.gettext("Horizontal Alignment"),name:"horizontalignment",forceSelection:true,editable:false,mode:"local",store:new Ext.data.ArrayStore({autoDestroy:true,fields:["spec","val"],data:this._getAlignmentOptions()}),triggerAction:"all",value:this.horizontalignment,displayField:"val",valueField:"spec",anchor:"-15"},{xtype:"combo",fieldLabel:gt.gettext("Vertical Alignment"),name:"verticalalignment",forceSelection:true,editable:false,mode:"local",store:new Ext.data.ArrayStore({autoDestroy:true,fields:["spec","val"],data:this._getVerticalAlignmentOptions()}),triggerAction:"all",value:this.verticalalignment,displayField:"val",valueField:"spec",anchor:"-15"}]}],windowButtons:[{text:gt.gettext("Update"),handler:function(){this._updateCell();},scope:this},{text:gt.gettext("Cancel"),handler:function(){this.cellWindow.close();},scope:this}]});return a;},_updateTable:function(){var b=this.tableWindow.getComponent("insert-table").getForm();if(b.isValid()){this._checkAndSetAttribute(b,"summary",this.tableSummary,this.tableNode);this._checkAndSetAttribute(b,"cellSpacing",this.tableCellSpacing,this.tableNode);this._checkAndSetAttribute(b,"cellPadding",this.tableCellPadding,this.tableNode);this._checkAndSetAttribute(b,"align",this.tableAlign,this.tableNode);this._checkAndSetAttribute(b,"dir",this.tableDir,this.tableNode);this._checkAndSetAttribute(b,"class",this._trimValue(this.tableClass),this.tableNode);this._checkAndSetAttribute(b,"id",this._trimValue(this.tableId),this.tableNode);this._checkAndSetAttribute(b,"border",this.tableBorder,this.tableNode);var a=this._trimValue(b.findField("style").getValue());this.tableNode.style.cssText=this._trimValue(a);if(Ext.isEmpty(a)){this.tableNode.removeAttribute("style");}this.tableWindow.close();}},_updateCell:function(){var m=this.cellWindow.getComponent("table-cell-properties").getForm();if(m.isValid()){var b="";var c=m.findField("width").getValue();var p=m.findField("height").getValue();var n=m.findField("widthoption").getValue();b=this._setHeightWidthToStyle("width",c,n,b);b=this._setHeightWidthToStyle("height",p,n,b);var k=m.findField("bordercolor").getValue();var a=m.findField("backgroundcolor").getValue();var j=m.findField("horizontalignment").getValue();var h=m.findField("verticalalignment").getValue();var g=m.findField("wordwrap").getValue();b=this._changeStyleAttribute("border-color",k,b);b=this._changeStyleAttribute("background-color",a,b);b=this._changeStyleAttribute("text-align",j,b);b=this._changeStyleAttribute("vertical-align",h,b);b=this._changeStyleAttribute("white-space",g,b);b=this._trimValue(b);this.node.style.cssText=b;if(Ext.isEmpty(b)){this.node.removeAttribute("style");}var f=m.findField("rowspan").getValue();var d=m.findField("colspan").getValue();if(f!==this.rowspan){this._setRowspan(this.node,f);}if(d!==this.colspan){this._setColspan(this.node,d);}var l=m.findField("celltype").getValue();if(l!==this.node.nodeName){var o=this._cloneCell(this.node,l.toLowerCase());this._insertBefore(this.node,o);this.node.parentNode.removeChild(this.node);}this.cellWindow.close();}},_changeStyleAttribute:function(d,f,c){var b=new RegExp(d+"\\s*:\\s*[^;]*;?","i");var a=b.exec(c);if(Ext.isEmpty(a)&&!Ext.isEmpty(f)){c+=Ext.isEmpty(/;$/.exec(c))?";":"";c+=";"+d+": "+f+";";}else{if(!Ext.isEmpty(a)&&!Ext.isEmpty(f)){c=c.replace(a[0],d+": "+f+";");}else{if(!Ext.isEmpty(a)&&Ext.isEmpty(f)){c=c.replace(a[0],"");}}}return c;},_checkAndSetAttribute:function(f,c,d,b){var a=f.findField(c).getValue();if(a!==d){if(Ext.isEmpty(a)){b.removeAttribute(c);}else{this._setAttribute(c,a,b);}}},_addTable:function(){var B=this.tableWindow.getComponent("insert-table").getForm();if(B.isValid()){var l=[B.findField("row").getValue(),B.findField("col").getValue()];if(l.length==2&&l[0]>0&&l[1]>0){var D=B.findField("cellborder").getValue();var u=Ext.isEmpty(D)?"":' style="border: '+D+';"';var m=B.findField("summary").getValue();var g=Ext.isEmpty(m)?"":' summary="'+m+'"';var y=B.findField("cellSpacing").getValue();var b=Ext.isEmpty(y)?"":' cellSpacing="'+y+'"';var x=B.findField("cellPadding").getValue();var o=Ext.isEmpty(x)?"":' cellPadding="'+x+'"';var q=this._trimValue(B.findField("class").getValue());var k=Ext.isEmpty(q)?"":' class="'+q+'"';var z=this._trimValue(B.findField("id").getValue());var r=Ext.isEmpty(z)?"":' id="'+z+'"';var t=B.findField("align").getValue();var h=Ext.isEmpty(t)?"":' align="'+t+'"';var s=B.findField("border").getValue();
var d=Ext.isEmpty(s)?"":' border="'+s+'"';var A=B.findField("dir").getValue();var v=Ext.isEmpty(A)?"":' dir="'+A+'"';var n=this._trimValue(B.findField("style").getValue());var w=Ext.isEmpty(n)?"":' style="'+n+'"';var a=B.findField("headers").getValue();var j="\n<table"+g+h+d+w+k+r+b+o+v+">\n";var p=B.findField("caption").getValue();if(!Ext.isEmpty(p)){j+="<caption>"+p+"</caption>\n";}j+="<tbody>\n";for(var f=0;f<l[0];f++){j+="<tr>\n";for(var c=0;c<l[1];c++){if(c===0&&(a==="firstcolumn"||a==="both")){j+='<th scope="row"'+u+">"+this.emptyHtml+"</th>\n";}else{if(f===0&&(a==="firstrow"||a==="both")){j+='<th scope="col"'+u+">"+this.emptyHtml+"</th>\n";}else{j+="<td"+u+">"+this.emptyHtml+"</td>\n";}}}j+="</tr>\n";}j+="</tbody></table><br/>\n";this.cmp.insertAtCursor(j);}this.tableWindow.close();}else{if(!B.findField("row").isValid()){B.findField("row").getEl().frame();}else{if(!B.findField("col").isValid()){B.findField("col").getEl().frame();}}}},deleteTable:function(b){var a=this._getTableNode(b);if(Ext.isDefined(a)&&a.nodeName==="TABLE"){a.parentNode.removeChild(a);}},_getTableNode:function(a){while(Ext.isDefined(a)&&a.nodeName!=="TABLE"){a=a.parentNode;}return a;},deleteRow:function(d){var h=this;var k=d.parentNode;var c=d.parentNode.parentNode.children;var j=this._getTotalRows(d);if(j===1){this.deleteTable(d);return;}var g=this._getPosition(d,"row");for(var l=0;l<=g;l++){var b=c[l];var f=0;var a=b.children;Ext.each(a,function(r){var q=h._getRowspan(r);if(l===g&&q>1){var s=h._getColspan(r);var p=h._getStyle(r);var n={tag:"td",style:p,colspan:s,rowspan:q-1,html:r.innerHTML};var m=h._getAbsolutePositionCell(d,g,f);m=h._getPositionCellFromAbsolute(d,m[0]+1,m[1]);var o=c[g+1].children;if(m[1]>=o.length){h._insertAfter(o[o.length-1],n);}else{h._insertBefore(o[m[1]],n);}}else{if(q>1&&(l+q)>g){h._setRowspan(r,q-1);}}f++;});}k.parentNode.removeChild(k);},deleteColumn:function(d){var k=this;var l=this._getPosition(d,"column");var h=this._getPosition(d,"row");var j=k._getAbsolutePositionCell(d,h,l);var g=j[1];var c=d.parentNode.parentNode.children;var m=0;var b=[];var a=[];var f=0;if(this._getTotalColumns(d)==1){this.deleteTable(d);return;}Ext.each(c,function(o){if(f>0){f--;m++;return true;}j=k._getPositionCellFromAbsolute(d,m,l);if(j[0]===m){var n=o.children[j[1]];var p=k._getColspan(n);if(p===1){b.push(n);}else{a.push(n);}f=k._getRowspan(n)-1;}m++;});Ext.each(b,function(n){n.parentNode.removeChild(n);});Ext.each(a,function(n){var o=k._getColspan(n);k._setColspan(n,o-1);});},insertRow:function(g,l){var m=this;var k=[];var f=g.parentNode.parentNode.children;var a=0;Ext.each(f,function(p){if(p===g.parentNode){return false;}a++;});var b=f[0];var j=m._getRowspan(g);var d=l?a:a+j-1;for(var o=0;o<a;o++){b=f[o];var h=0;Ext.each(b.children,function(q){var r=m._getRowspan(q);if(o+r-1>(l?d-1:d)){m._setRowspan(q,r+1);}else{if(!l&&(o+r-1)===d){var p=m._getAbsolutePositionCell(q,o,h);k[p[1]]=m._cloneCell(q);}}h++;});}for(var o=a;o<=d;o++){b=f[o];var h=0;Ext.each(b.children,function(q){var r=m._getRowspan(q);if(!l&&(o+r-1)>d){m._setRowspan(q,r+1);}else{if(l||(o+r-1)===d){var p=m._getAbsolutePositionCell(q,o,h);k[p[1]]=m._cloneCell(q);}}h++;});}var c=[];Ext.each(k,function(p){if(Ext.isDefined(p)){c.push(p);}});var n={tag:"tr",children:c};if(l){this._insertBefore(b,n);}else{this._insertAfter(b,n);}},_cloneCell:function(f,c){var b=true;if(!Ext.isDefined(c)){c=f.tagName.toLowerCase();b=false;}var d=this._getStyle(f);var a={tag:c,html:this.emptyHtml};if(!Ext.isEmpty(d)){a.style=d;}if(b){a.html=f.innerHTML;var g=this._getRowspan(f);var h=this._getColspan(f);if(g>1){a.rowspan=g;}if(h>1){a.colspan=h;}}return a;},insertColumnCell:function(c,j,a,h){var l=this;var d=c.parentNode;var k=this._getPosition(c,"column");var m=this._getPosition(c,"row");var g=this._getAbsolutePositionCell(c,m,k);var b=g[1];var o=a?[d]:d.parentNode.children;var n=a?m-1:-1;var f=0;Ext.each(o,function(q){n++;if(f>0){f--;return true;}var p=l._getPositionCellFromAbsolute(c,n,b);var s=q.children[p[1]];if(!Ext.isDefined(s)){return true;}if(h){if(q.children.length===1){l.deleteRow(s);}else{q.removeChild(s);}return true;}var r=l._cloneCell(s,s.tagName.toLowerCase());r.html=l.emptyHtml;f=l._getRowspan(s)-1;if(j){l._insertBefore(s,r);}else{l._insertAfter(s,r);}});},_getColspan:function(a){var b=a.getAttribute("colSpan",2)||1;return parseInt(b,10);},_getRowspan:function(a){var b=a.getAttribute("rowSpan",2)||1;return parseInt(b,10);},_setColspan:function(a,b){a.setAttribute("colSpan",b||1);},_setRowspan:function(a,b){a.setAttribute("rowSpan",b||1);},_getStyle:function(a){var b=a.style;return(Ext.isEmpty(b)&&Ext.isEmpty(b.cssText))?"":b.cssText;},verifyMergeActionAllowed:function(d,h){var g=this._getPosition(d,"column");var b=this._getPosition(d,"row");if(g===0&&h==="left"){return false;}if(b===0&&h==="up"){return false;}var a=d.parentNode;var f=d.parentNode.parentNode;if(h==="down"&&(b+1)>=f.children.length){return false;}if(h==="right"&&(g+1)>=a.children.length){return false;}var c=this._getNextMergeCell(d,h,b,g);if(!Ext.isDefined(c)){return false;}if((h==="down"||h==="up")&&this._getColspan(d)!==this._getColspan(c)){return false;}if((h==="left"||h==="right")&&this._getRowspan(d)!==this._getRowspan(c)){return false;}return true;},_getAbsolutePositionCell:function(b,f,k){var h=0;for(var l=0;l<f;l++){var c=0;while(true){var j=this._getCell(b,l,c);if(!j){break;}var d=this._getRowspan(j);if(d>1&&(l+d)>f){var a=this._getAbsolutePositionCell(b,l,c);var g=a[1];if(g<=k){k+=this._getColspan(j);}}c++;}}return[f,k];},_getPositionCellFromAbsolute:function(f,b,h){var d=0;for(var j=0;j<=b;j++){var c=0;while(true){var a=this._getCell(f,j,c);if(!a){break;}var g=this._getRowspan(a);if(j===b||(g>1&&(j+g)>b)){if(c<h){if(j<b){h-=this._getColspan(a);}else{h-=this._getColspan(a)-1;}}}c++;}}return[b,h];},_getNextMergeCell:function(b,j,f,l){var h=l;var c=f;if(j==="left"){h=l-1;}else{if(j==="right"){h=l+1;}else{var g=this._getAbsolutePositionCell(b,f,l);if(!Ext.isDefined(g)){return;}var m=g[0];var d=g[1];var n=this._getRowspan(b);var a=m;if(j==="down"){a+=n;}else{a-=1;}var k=d;g=this._getPositionCellFromAbsolute(b,a,k);if(!Ext.isDefined(g)){return;}c=g[0];h=g[1];}}return this._getCell(b,c,h);},mergeCells:function(c,j){var l=this._getPosition(c,"column");var f=this._getPosition(c,"row");var a=this._getStyle(c);var g=c.innerHTML;if(!Ext.isIE){g=g.replace(/<br _ecm_dirty="">$/,"");}var m=this._getNextMergeCell(c,j,f,l);var h=j==="down"?"<br />\n":"";g+=Ext.isDefined(m)?h+m.innerHTML:"";if(!Ext.isIE){g=g.replace(/<br _ecm_dirty="">$/,"");}g=Ext.isEmpty(g)?this.emptyHtml:g;var b=1;var d=1;if(j==="down"||j==="up"){b=this._getColspan(c);d=this._getRowspan(c)+this._getRowspan(m);}else{b=this._getColspan(c)+this._getColspan(m);d=this._getRowspan(c);}var k={tag:"td",style:a,colspan:b,rowspan:d,html:g};if(j==="up"){this._insertBefore(m,k);}else{this._insertBefore(c,k);}m.parentNode.removeChild(m);c.parentNode.removeChild(c);},_setParentVerticalCells:function(b){var a=b.children;Ext.each(a,function(c){if(c.rowSpan>1){c.rowSpan++;}});},_setHorizontalCells:function(b,f,m){var a=0,k=1,n=b.parentNode.parentNode.children,l=this._getAbsolutePositionCell(b,f,m),d=this._getPositionCellFromAbsolute(b,l[a],l[k]),h=n[d[a]].cells[d[k]].colSpan,j=n[d[a]].cells[d[k]].rowSpan,g=j+f-1;Ext.each(n,function(o){var c=this._getPositionCellFromAbsolute(b,o.rowIndex,l[k]);if((f==o.rowIndex)&&(h>1)){o.cells[c[k]].colSpan--;}if((f!=o.rowIndex)&&(h==1)){if(o.rowIndex<f||g<o.rowIndex){o.cells[c[k]].colSpan++;}}},this);},_setVerticalCells:function(d,a,h){var b=0,k=1,g=d.parentNode.children,j=this._getPositionCellFromAbsolute(d,a,h),f=g[j[k]].rowSpan;Ext.each(g,function(c){var l=this._getPositionCellFromAbsolute(d,j[b],c.cellIndex);if((h==c.cellIndex)&&(f>1)){c.rowSpan--;}if((h!=c.cellIndex)&&(f==1)){c.rowSpan++;}},this);},splitCell:function(b,m){var o=this._getPosition(b,"column"),c=this._getPosition(b,"row"),l=b.style,a=Ext.isEmpty(l)?"":l.cssText,k=this._getRowspan(b),f=this.emptyHtml,h=this._getColspan(b);
var n;if(m==="horizontal"){n={tag:"td",rowspan:k,colspan:1,style:a,html:f};this._insertAfter(b,n);this._setHorizontalCells(b,c,o);}else{if(m==="vertical"){if(k>1){var g=this._getCell(b,c+1,o==0?0:o-1);n={tag:"td",rowspan:1,colspan:h,style:a,html:f};if(o==0){this._insertBefore(g,n);}else{this._insertAfter(g,n);}}else{n={tag:"tr",children:[{tag:"td",rowspan:1,colspan:h,style:a,html:f}]};this._insertAfter(b.parentNode,n);}var j=b.parentNode.parentNode.children;for(var d=b.parentNode.rowIndex-1;d>=0;d--){this._setParentVerticalCells(j[d]);}this._setVerticalCells(b,c,o);}}},_getCell:function(d,a,c){var f=d.parentNode.parentNode.children;if(a<f.length){var g=f[a];var b=g.children;if(c<b.length){return b[c];}}return;},_getPosition:function(g,b){var c=g.parentNode;var h=c.parentNode;var a=0;var f=b==="column"?c.children:h.children;var d=b==="column"?g:c;while(f[a]!==d&&a<f.length){a++;}return a;},_showColorPicker:function(a){var b=this.cellWindow.getComponent("table-cell-properties").getForm();this.colorPicker=Ext.isObject(this.colorPicker)?this.colorPicker:{};this.colorPicker[a]=new ECM.Plugins.HtmlEditor.ColorPicker.Window({id:"table-cell-color-picker-"+a,cls:"cms-color-picker"});this.colorPicker[a].show();this.colorPicker[a].on("colorselected",function(c){b.findField(a).setValue(c);},this);},_insertBefore:function(c,b){if(Ext.isIE){var a=this._createDomNode(b);c.parentNode.insertBefore(a,c);}else{this.dh.insertBefore(c,b);}},_insertAfter:function(c,b){if(Ext.isIE){var a=this._createDomNode(b);c.parentNode.insertBefore(a,c.nextSibling);}else{this.dh.insertAfter(c,b);}},_createDomNode:function(b){var d=this.cmp.getDoc();var f=d.createElement("div");var c=this.dh.createHtml(b);if(b.tag==="tr"){f.innerHTML="<table>"+c+"</table>";}else{if(b.tag==="td"||b.tag==="th"){f.innerHTML="<table><tr>"+c+"</tr></table>";}else{f.innerHTML=c;}}var a=f.getElementsByTagName(b.tag);if(a.length>0){return a[0];}else{return d.createElement(b.tag);}}});ECM.provide("ECM.Plugins.HtmlEditor.Link");ECM.Plugins.HtmlEditor.Link=Ext.extend(Ext.util.Observable,{init:function(a){this.cmp=a;this.textSelected=true;this.cmp.on("render",this.onRender,this);this.cmp.on("initialize",this.onInit,this,{delay:100,single:true});},onEditorDoubleClick:function(a){this.node=a.getTarget();if(this.node.nodeName==="A"){this.editLink();}},createLink:function(a){var b={};b.protocol="http://";b.href="";b.linktype="url";this.htmleditor=a;this.oldStyle="";this.textSelected=!Ext.isEmpty(Ext.isIE?a.getDoc().selection.createRange().text:a.getDoc().getSelection());this.editLinkWindow=this._openDialog(b,"create");this.editLinkWindow.show();if(!this.textSelected){this.editLinkWindow.notify.error(gt.gettext("To create a link you must first make a selection within the html content."));}},editLink:function(b){if(Ext.isDefined(b)){this.node=b;}var j={};var m=this.node.attributes.href.value;var c=location.href;var a=c.substring(0,c.lastIndexOf("/")+1);m=decodeURIComponent(m.replace(a,""));j.linktype="url";j.email="";j.subject="";j.body="";j.protocol="http://";j.href="";if(/^mailto/.test(m)){j.linktype="email";var k=m.indexOf("?");if(k>0){j.email=m.substring(7,k);var n=m.indexOf("subject=");var d=m.indexOf("body=");if(n>0){if(d>n){j.subject=m.substring(n+8,d-1);}else{j.subject=m.substring(n+8);}j.subject=j.subject.replace(/%20/g," ");}if(d>0){if(n>d){j.body=m.substring(d+5,n-1);}else{j.body=m.substring(d+5);}j.body=j.body.replace(/%20/g," ");j.body=j.body.replace(/%0A/g,"\n");}}}else{var g=/^\w+:\/\//;var f=m;if(g.test(m)){var l=m.indexOf("://")+3;j.protocol=m.substring(0,l);f=m.substring(l);}j.href=f;}j.style="";var h=this.node.style;if(!Ext.isEmpty(h)){j.style=h.cssText;}this.oldStyle=j.style;this.editLinkWindow=this._openDialog(j,"edit");this.editLinkWindow.show();},unLink:function(b,c){var a=c.parentNode;Ext.DomHelper.insertHtml("beforeBegin",c,c.innerHTML);a.removeChild(c);},onInit:function(){Ext.EventManager.on(this.cmp.getDoc(),{dblclick:this.onEditorDoubleClick,buffer:100,scope:this});},onRender:function(){},_getProtocolOptions:function(){return[["http://","http://"],["https://","https://"],["ftp://","ftp://"],["news://","news://"],["",gt.gettext("other")]];},_getLinkTypeOptions:function(){return[["url",gt.gettext("URL")],["email",gt.gettext("E-mail")]];},_openDialog:function(c,d){var b=this;var a;if(c.linktype==="email"){a=this._getEmailForm(c,d);}else{a=this._getUrlForm(c,d);}return new ECM.Window({title:d==="edit"?gt.gettext("Edit Link"):gt.gettext("Create Link"),closeAction:"close",width:650,scrollable:true,cls:"createLink",items:[{itemId:"edit-link",xtype:"form",border:false,plain:true,items:[{xtype:"combo",name:"linktype",fieldLabel:gt.gettext("Type"),forceSelection:true,mode:"local",store:new Ext.data.ArrayStore({autoDestroy:true,fields:["spec","val"],data:this._getLinkTypeOptions()}),cls:"createLinkCombo",triggerAction:"all",value:c.linktype,displayField:"val",valueField:"spec",listeners:{select:function(g,f){if(c.linktype!==f.data.spec){c.linktype=f.data.spec;b.editLinkWindow.hide();b.editLinkWindow=b._openDialog(c,d);b.editLinkWindow.show();}}}},a]}],windowButtons:[{text:d==="create"?gt.gettext("Create"):gt.gettext("Update"),disabled:d==="create"&&!this.textSelected,handler:function(){this._updateLink(c.linktype,d);},scope:this},{text:gt.gettext("Cancel"),handler:function(){this.editLinkWindow.hide();},scope:this}]});},_getUrlForm:function(a,b){return[{xtype:"container",layout:"column",autoWidth:true,fieldLabel:gt.gettext("URL"),items:[{xtype:"combo",name:"protocol",forceSelection:true,mode:"local",store:new Ext.data.ArrayStore({autoDestroy:true,fields:["spec","val"],data:this._getProtocolOptions()}),cls:"createLinkCombo",triggerAction:"all",value:a.protocol,displayField:"val",valueField:"spec"},{xtype:"textfield",allowBlank:false,value:a.href,name:"url",cls:"createLinkUrl"}]},{xtype:"textfield",fieldLabel:gt.gettext("Style"),value:a.style,name:"style",cls:"createLinkStyle",vtype:"cssText",vtypeText:gt.gettext("You have entered invalid character(s) for Style")}];},_getEmailForm:function(a,b){return[{xtype:"textfield",fieldLabel:gt.gettext("E-mail Address"),allowBlank:false,value:a.email,name:"email",width:500},{xtype:"textfield",fieldLabel:gt.gettext("Subject"),value:a.subject,name:"subject",width:500},{xtype:"textarea",fieldLabel:gt.gettext("Body"),value:a.body,name:"body",width:500},{xtype:"textfield",fieldLabel:gt.gettext("Style"),value:a.style,disabled:b==="create"?true:false,emptyText:b==="create"?gt.gettext("A style can only be added while editing the link"):"",name:"style",width:500,vtype:"cssText",vtypeText:gt.gettext("You have entered invalid character(s) for Style")}];},_updateLink:function(a,f){var k=this.editLinkWindow.getComponent("edit-link").getForm();if(k.isValid()){var d;if(a==="email"){var h=k.findField("email").getValue();var j=k.findField("subject").getValue();var g=k.findField("body").getValue();g=g.replace(/\n/g,"%0A");d="mailto:"+h+"?subject="+j+"&body="+g;}else{var l=k.findField("protocol").getValue();var c=k.findField("url").getValue();d=l+c;}d=d.replace(/\s/g,"%20");if(f==="edit"){this.node.attributes.href.value=encodeURIComponent(d);}else{if(Ext.isIE){this.htmleditor.currentRange.execCommand("createlink",false,d);this.htmleditor.deferFocus();}else{this.htmleditor.execCmd("createlink",d);}}var b=this._trimValue(k.findField("style").getValue());if(b!==this.oldStyle){if(f==="create"){this.node=Ext.isIE?this.htmleditor.currentRange.parentElement():this.htmleditor.getWin().getSelection().anchorNode.nextSibling;}this.node.style.cssText=b;}this.editLinkWindow.hide();}},_trimValue:function(a){a=a.replace(/^\s*/,"");a=a.replace(/\s*$/,"");a=a.replace(/\s+/g," ");return a;}});ECM.provide("ECM.Plugins.HtmlEditor.ContextMenu");ECM.Plugins.HtmlEditor.ContextMenu=Ext.extend(Ext.util.Observable,{init:function(a){this.cmp=a;this.cmp.on("initialize",this.onInit,this,{delay:100,single:true});},onEditorContextMenu:function(g){g.preventDefault();var f=g.getTarget();this.node=this._getNestedNode(f);
var b=Ext.get("page_iframe").getLeft();var h=Ext.get("page_iframe").getTop();var d=Ext.isIE?document.body.scrollTop:Ext.fly(this.cmp.getEditorBody()).getScroll().top||0;var a=g.getXY();a[0]+=b;a[1]+=h;a[1]-=d;if(Ext.isIE){this.selection=this.cmp.getDoc().selection.createRange().text;}else{this.selection=this.cmp.getDoc().getSelection();}this.commonItems=this._getCommonItems();if(this.node.nodeName==="A"){this.tagItems=this._getLinkItems();}else{if(this.node.nodeName==="TD"||this.node.nodeName==="TH"||this.node.nodeName==="CAPTION"){if(!Ext.isEmpty(this.cmp.table)){this.tagItems=this._getTableItems(this.node.nodeName);}}else{if(this.node.nodeName==="IMG"){this.tagItems=this._getImageItems();}else{this.tagItems=[];}}}var c=this;setTimeout(function(){var j=c._contextMenu();j.showAt(a);},100);return false;},_getNestedNode:function(a){while(a.nodeName!=="BODY"&&a.nodeName!=="TD"&&a.nodeName!=="TH"&&a.nodeName!=="IMG"&&a.nodeName!=="A"&&a.nodeName!=="CAPTION"){a=a.parentNode;}return a;},onInit:function(){Ext.EventManager.on(this.cmp.getDoc(),{contextmenu:this.onEditorContextMenu,scope:this});},_getCommonItems:function(){var a=this.cmp;var b=[];if(this.node.nodeName==="IMG"||!Ext.isEmpty(this.selection)){b.push({text:gt.gettext("Cut"),iconCls:"x-edit-cut",listeners:{click:a.cut.createDelegate(a)}});b.push({text:gt.gettext("Copy"),iconCls:"x-edit-copy",listeners:{click:a.copy.createDelegate(a)}});}b.push({text:gt.gettext("Paste"),iconCls:"x-edit-paste",listeners:{click:a.paste.createDelegate(a)}});return b;},_contextMenu:function(a){return new Ext.menu.Menu({margin:"0 0 10 0",floating:true,items:[this.commonItems,this.tagItems]});},_getLinkItems:function(){var a=this;return[{text:gt.gettext("Edit Link"),iconCls:"x-edit-link",listeners:{click:function(){var b=new ECM.Plugins.HtmlEditor.Link();b.editLink(a.node);}}},{text:gt.gettext("Unlink"),iconCls:"x-edit-link-break",listeners:{click:function(){var b=new ECM.Plugins.HtmlEditor.Link();b.unLink(a,a.node);}}}];},_getTableItems:function(j){var d=this;var a=this.cmp.table;var c=new Ext.menu.Menu({margin:"0 0 10 0",floating:true,items:[{text:gt.gettext("Insert Row Before"),listeners:{click:function(){a.insertRow(d.node,true);}}},{text:gt.gettext("Insert Row After"),listeners:{click:function(){a.insertRow(d.node,false);}}},{text:gt.gettext("Delete Row"),listeners:{click:function(){a.deleteRow(d.node);}}}]});var g=new Ext.menu.Menu({margin:"0 0 10 0",floating:true,items:[{text:gt.gettext("Insert Column Before"),listeners:{click:function(){a.insertColumnCell(d.node,true,false,false);}}},{text:gt.gettext("Insert Column After"),listeners:{click:function(){a.insertColumnCell(d.node,false,false,false);}}},{text:gt.gettext("Delete Column"),listeners:{click:function(){a.deleteColumn(d.node);}}}]});var h=new Ext.menu.Menu({margin:"0 0 10 0",floating:true,items:[{text:gt.gettext("Insert Cell Before"),listeners:{click:function(){a.insertColumnCell(d.node,true,true,false);}}},{text:gt.gettext("Insert Cell After"),listeners:{click:function(){a.insertColumnCell(d.node,false,true,false);}}},{text:gt.gettext("Delete Cell"),listeners:{click:function(){a.insertColumnCell(d.node,false,true,true);}}},{text:gt.gettext("Merge Left"),disabled:!a.verifyMergeActionAllowed(d.node,"left"),listeners:{click:function(){a.mergeCells(d.node,"left");}}},{text:gt.gettext("Merge Right"),disabled:!a.verifyMergeActionAllowed(d.node,"right"),listeners:{click:function(){a.mergeCells(d.node,"right");}}},{text:gt.gettext("Merge Down"),disabled:!a.verifyMergeActionAllowed(d.node,"down"),listeners:{click:function(){a.mergeCells(d.node,"down");}}},{text:gt.gettext("Split Cell Horizontally"),listeners:{click:function(){a.splitCell(d.node,"horizontal");}}},{text:gt.gettext("Split Cell Vertically"),listeners:{click:function(){a.splitCell(d.node,"vertical");}}},{text:gt.gettext("Cell Properties"),listeners:{click:function(){a.cellProperties(d.node);}}}]});var f=[{text:gt.gettext("Cells"),menu:h},{text:gt.gettext("Rows"),menu:c},{text:gt.gettext("Columns"),menu:g}];var b=[{text:gt.gettext("Delete Table"),iconCls:"x-edit-table-delete",listeners:{click:function(){a.deleteTable(d.node);}}},{text:gt.gettext("Table Properties"),iconCls:"x-edit-table",listeners:{click:function(){a.tableProperties(d.node);}}}];if(j==="TH"||j==="TD"){return[f,b];}else{return b;}},_getImageItems:function(){var a=this;return[{text:gt.gettext("Image properties"),iconCls:"x-edit-image-edit",listeners:{click:function(){var b=new ECM.Plugins.HtmlEditor.Image();b.imageProperties(a.node);}}}];}});ECM.provide("ECM.Plugins.HtmlEditor.ColorPicker");ECM.Plugins.HtmlEditor.ColorPicker=Ext.extend(Ext.util.Observable,{menuIds:["forecolor","backcolor"],colorPickerWindows:{},init:function(a){this.cmp=a;this.cmp.on("render",this.onRender,this);if(Ext.isIE){this.cmp.initEditor=this.cmp.initEditor.createSequence(function(){Ext.EventManager.on(this.cmp.getDoc(),{mouseup:this.cmp.onEditorEvent.createDelegate(this.cmp)},this);},this);}},onRender:function(){var a=this;Ext.each(this.menuIds,function(d){var c=this.cmp.getToolbar().getComponent(d).menu,b=new ECM.Plugins.HtmlEditor.ColorPicker.Widget({cls:"color-menu-widget",menu:c});b.add({xtype:"button",text:gt.gettext("Use"),cls:"color-menu-use-btn",handler:function(){var f=b.getColor();if(f){a.insertColor(f,d);}c.hide(true);}});c.addSeparator();c.addItem(b);c.addSeparator();c.addItem({xtype:"button",mode:d,cls:"color-picker-window",text:gt.gettext("More colors"),handler:function(f){a.showColorPicker(f.mode);c.hide(true);}});},this);},showColorPicker:function(b){var a=this;this.colorPickerWindows[b]=new ECM.Plugins.HtmlEditor.ColorPicker.Window({id:"cms-color-picker-"+b,cls:"cms-color-picker"});this.colorPickerWindows[b].show();this.colorPickerWindows[b].on("colorselected",function(c){a.insertColor(c,b);},this);},insertColor:function(a,b){if(b==="forecolor"){if(Ext.isIE){this.cmp.currentRange.execCommand("forecolor",false,a);this.cmp.deferFocus();}else{this.cmp.execCmd("forecolor",a);this.cmp.deferFocus();}}else{if(b==="backcolor"){if(Ext.isIE){this.cmp.currentRange.execCommand("backcolor",false,a);}else{if(Ext.isOpera){this.cmp.execCmd("hilitecolor",a);}else{this.cmp.execCmd("useCSS",false);this.cmp.execCmd("hilitecolor",a);this.cmp.execCmd("useCSS",true);}}this.cmp.deferFocus();}}}});ECM.Plugins.HtmlEditor.ColorPicker.Widget=Ext.extend(Ext.Panel,{layout:"column",width:150,cls:"color-picker-widget",widgetText:gt.gettext("Hex: "),hexRegex:new RegExp(/^#?[0-9a-f]{6}$/i),constructor:function(a){ECM.Plugins.HtmlEditor.ColorPicker.Widget.superclass.constructor.call(this,a);this.addEvents("colorset");},initComponent:function(){var a=this;this.cssBlock="display: block; height: 20px; width: 20px; margin: 0 3px; border: solid 1px #999;";this.items=[{xtype:"label",text:this.widgetText,cls:"color-picker-widget-label",style:{marginTop:"6px",marginRight:"5px"}},{xtype:"textfield",ref:"colorField",maxLength:7,enableKeyEvents:true,regex:this.hexRegex,regexText:gt.gettext("Invalid color hexadecimal value"),listeners:{scope:this,afterrender:function(){if(Ext.isDefined(this.menu)){this.menu.keyNav.disable();}},change:function(c,b){if(this.getColor()!==b){this.setColor(b);}},keydown:function(b){window.setTimeout(function(){a.setColor(b.getValue());},10);}}},{xtype:"spacer",html:"&nbsp;",ref:"colorDisplay",listeners:{scope:this,afterrender:function(){this.setColor("#000000");}}}];ECM.Plugins.HtmlEditor.ColorPicker.Widget.superclass.initComponent.call(this);},setDisplay:function(b){if(!this.hexRegex.test(b)){return;}var a='<div class="color-widget" style="background-color:'+b+';">&nbsp;</div>';this.colorDisplay.getEl().dom.innerHTML=a;},setColor:function(b){var c=new RegExp(/^#/),a=c.test(b)?b:"#"+b;if(!this.hexRegex.test(b)){this.colorValid=false;delete this.color;return;}else{if(this.color===a){return;}}this.color=a;this.colorValid=true;this.setDisplay(this.color);if(this.colorField.getValue()!==this.color){this.colorField.setValue(this.color);}this.fireEvent("colorset",this.color);
},getColor:function(){return this.color&&this.colorValid?this.color:false;}});ECM.Plugins.HtmlEditor.ColorPicker.Window=Ext.extend(ECM.Window,{scrollable:true,width:300,title:gt.gettext("Color Picker"),initComponent:function(){var a=this;this.initStore();this.rangeView=this.initDataView(this.rangeStore);this.namedView=this.initDataView(this.namedStore);this.items=[{xtype:"fieldset",title:gt.gettext("Web Safe Colors"),width:260,items:[this.rangeView]},{xtype:"fieldset",title:gt.gettext("Named Colors"),layout:"column",width:260,items:[this.namedView,{xtype:"label",text:gt.gettext("Color Name: "),style:{marginRight:"4px",marginTop:"4px",height:"16px"}},{xtype:"label",ref:"../colorName",text:gt.gettext("Hover over a color to see the name"),width:170,height:15,style:{marginTop:"4px",height:"16px"}}]},this.widget=new ECM.Plugins.HtmlEditor.ColorPicker.Widget({widgetText:gt.gettext("Selected Color: "),width:260})];this.windowButtons=[{text:gt.gettext("Close"),handler:a.close.createDelegate(this)},{text:gt.gettext("Apply"),handler:a.applyBtnHandler.createDelegate(this)}];ECM.Plugins.HtmlEditor.ColorPicker.Window.superclass.initComponent.call(this);this.addEvents("colorselected");this.namedView.on("mouseenter",function(b,c){var d=b.getStore().getAt(c).get("name");this.colorName.setText(gt.gettext(d));},this);},initStore:function(){var a=[];Ext.each(ECM.Plugins.HtmlEditor.ColorPicker.ColorRange,function(c){a.push([c]);});this.rangeStore=new Ext.data.ArrayStore({fields:["color"],data:a});var b=[];Ext.iterate(ECM.Plugins.HtmlEditor.ColorPicker.NamedColors,function(d,c){b.push([d,c]);});this.namedStore=new Ext.data.ArrayStore({fields:["color","name"],data:b});},initDataView:function(a,b){b=b||{};b=Ext.apply({colWidth:1,store:a,autoHeight:true,multiSelect:false,tpl:new Ext.XTemplate('<tpl for="."><div class="color-item" style="background-color:{color}">&nbsp;</div></tpl><div class="x-clear"></div>'),itemSelector:"div.color-item",overClass:"char-over",listeners:{dblclick:function(f,d){this.fireEvent("colorselected",f.getStore().getAt(d).get("color"));this.close();},click:function(f,d){this.widget.setColor(f.getStore().getAt(d).get("color"));},scope:this}},b);var c=new Ext.DataView(b);return c;},applyBtnHandler:function(b){var a=this.widget.getColor();if(a){this.fireEvent("colorselected",a);}this.close();}});ECM.Plugins.HtmlEditor.ColorPicker.ColorRange=["#000000","#000033","#000066","#000099","#0000cc","#0000ff","#330000","#330033","#330066","#330099","#3300cc","#3300ff","#660000","#660033","#660066","#660099","#6600cc","#6600ff","#990000","#990033","#990066","#990099","#9900cc","#9900ff","#cc0000","#cc0033","#cc0066","#cc0099","#cc00cc","#cc00ff","#ff0000","#ff0033","#ff0066","#ff0099","#ff00cc","#ff00ff","#003300","#003333","#003366","#003399","#0033cc","#0033ff","#333300","#333333","#333366","#333399","#3333cc","#3333ff","#663300","#663333","#663366","#663399","#6633cc","#6633ff","#993300","#993333","#993366","#993399","#9933cc","#9933ff","#cc3300","#cc3333","#cc3366","#cc3399","#cc33cc","#cc33ff","#ff3300","#ff3333","#ff3366","#ff3399","#ff33cc","#ff33ff","#006600","#006633","#006666","#006699","#0066cc","#0066ff","#336600","#336633","#336666","#336699","#3366cc","#3366ff","#666600","#666633","#666666","#666699","#6666cc","#6666ff","#996600","#996633","#996666","#996699","#9966cc","#9966ff","#cc6600","#cc6633","#cc6666","#cc6699","#cc66cc","#cc66ff","#ff6600","#ff6633","#ff6666","#ff6699","#ff66cc","#ff66ff","#009900","#009933","#009966","#009999","#0099cc","#0099ff","#339900","#339933","#339966","#339999","#3399cc","#3399ff","#669900","#669933","#669966","#669999","#6699cc","#6699ff","#999900","#999933","#999966","#999999","#9999cc","#9999ff","#cc9900","#cc9933","#cc9966","#cc9999","#cc99cc","#cc99ff","#ff9900","#ff9933","#ff9966","#ff9999","#ff99cc","#ff99ff","#00cc00","#00cc33","#00cc66","#00cc99","#00cccc","#00ccff","#33cc00","#33cc33","#33cc66","#33cc99","#33cccc","#33ccff","#66cc00","#66cc33","#66cc66","#66cc99","#66cccc","#66ccff","#99cc00","#99cc33","#99cc66","#99cc99","#99cccc","#99ccff","#cccc00","#cccc33","#cccc66","#cccc99","#cccccc","#ccccff","#ffcc00","#ffcc33","#ffcc66","#ffcc99","#ffcccc","#ffccff","#00ff00","#00ff33","#00ff66","#00ff99","#00ffcc","#00ffff","#33ff00","#33ff33","#33ff66","#33ff99","#33ffcc","#33ffff","#66ff00","#66ff33","#66ff66","#66ff99","#66ffcc","#66ffff","#99ff00","#99ff33","#99ff66","#99ff99","#99ffcc","#99ffff","#ccff00","#ccff33","#ccff66","#ccff99","#ccffcc","#ccffff","#ffff00","#ffff33","#ffff66","#ffff99","#ffffcc","#ffffff"];ECM.Plugins.HtmlEditor.ColorPicker.NamedColors={"#F0F8FF":"Alice Blue","#FAEBD7":"Antique White","#00FFFF":"Aqua","#7FFFD4":"Aquamarine","#F0FFFF":"Azure","#F5F5DC":"Beige","#FFE4C4":"Bisque","#000000":"Black","#FFEBCD":"Blanched Almond","#0000FF":"Blue","#8A2BE2":"Blue Violet","#A52A2A":"Brown","#DEB887":"Burly Wood","#5F9EA0":"Cadet Blue","#7FFF00":"Chartreuse","#D2691E":"Chocolate","#FF7F50":"Coral","#6495ED":"Cornflower Blue","#FFF8DC":"Cornsilk","#DC143C":"Crimson","#00FFFF":"Cyan","#00008B":"Dark Blue","#008B8B":"Dark Cyan","#B8860B":"Dark Golden Rod","#A9A9A9":"Dark Gray","#A9A9A9":"Dark Grey","#006400":"Dark Green","#BDB76B":"Dark Khaki","#8B008B":"Dark Magenta","#556B2F":"Dark Olive Green","#FF8C00":"Darkorange","#9932CC":"Dark Orchid","#8B0000":"Dark Red","#E9967A":"Dark Salmon","#8FBC8F":"Dark Sea Green","#483D8B":"Dark Slate Blue","#2F4F4F":"Dark Slate Gray","#2F4F4F":"Dark Slate Grey","#00CED1":"Dark Turquoise","#9400D3":"Dark Violet","#FF1493":"Deep Pink","#00BFFF":"Deep Sky Blue","#696969":"Dim Gray","#696969":"Dim Grey","#1E90FF":"Dodger Blue","#B22222":"Fire Brick","#FFFAF0":"Floral White","#228B22":"Forest Green","#FF00FF":"Fuchsia","#DCDCDC":"Gainsboro","#F8F8FF":"Ghost White","#FFD700":"Gold","#DAA520":"Golden Rod","#808080":"Gray","#808080":"Grey","#008000":"Green","#ADFF2F":"Green Yellow","#F0FFF0":"Honey Dew","#FF69B4":"Hot Pink","#CD5C5C":"Indian Red","#4B0082":"Indigo","#FFFFF0":"Ivory","#F0E68C":"Khaki","#E6E6FA":"Lavender","#FFF0F5":"Lavender Blush","#7CFC00":"Lawn Green","#FFFACD":"Lemon Chiffon","#ADD8E6":"Light Blue","#F08080":"Light Coral","#E0FFFF":"Light Cyan","#FAFAD2":"Light Golden Rod Yellow","#D3D3D3":"Light Gray","#D3D3D3":"Light Grey","#90EE90":"Light Green","#FFB6C1":"Light Pink","#FFA07A":"Light Salmon","#20B2AA":"Light Sea Green","#87CEFA":"Light Sky Blue","#778899":"Light Slate Gray","#778899":"Light Slate Grey","#B0C4DE":"Light Steel Blue","#FFFFE0":"Light Yellow","#00FF00":"Lime","#32CD32":"Lime Green","#FAF0E6":"Linen","#FF00FF":"Magenta","#800000":"Maroon","#66CDAA":"Medium Aqua Marine","#0000CD":"Medium Blue","#BA55D3":"Medium Orchid","#9370D8":"Medium Purple","#3CB371":"Medium Sea Green","#7B68EE":"Medium Slate Blue","#00FA9A":"Medium Spring Green","#48D1CC":"Medium Turquoise","#C71585":"Medium Violet Red","#191970":"Midnight Blue","#F5FFFA":"Mint Cream","#FFE4E1":"Misty Rose","#FFE4B5":"Moccasin","#FFDEAD":"Navajo White","#000080":"Navy","#FDF5E6":"Old Lace","#808000":"Olive","#6B8E23":"Olive Drab","#FFA500":"Orange","#FF4500":"Orange Red","#DA70D6":"Orchid","#EEE8AA":"Pale Golden Rod","#98FB98":"Pale Green","#AFEEEE":"Pale Turquoise","#D87093":"Pale Violet Red","#FFEFD5":"Papaya Whip","#FFDAB9":"Peach Puff","#CD853F":"Peru","#FFC0CB":"Pink","#DDA0DD":"Plum","#B0E0E6":"Powder Blue","#800080":"Purple","#FF0000":"Red","#BC8F8F":"Rosy Brown","#4169E1":"Royal Blue","#8B4513":"Saddle Brown","#FA8072":"Salmon","#F4A460":"Sandy Brown","#2E8B57":"Sea Green","#FFF5EE":"Sea Shell","#A0522D":"Sienna","#C0C0C0":"Silver","#87CEEB":"Sky Blue","#6A5ACD":"Slate Blue","#708090":"Slate Gray","#708090":"Slate Grey","#FFFAFA":"Snow","#00FF7F":"Spring Green","#4682B4":"Steel Blue","#D2B48C":"Tan","#008080":"Teal","#D8BFD8":"Thistle","#FF6347":"Tomato","#40E0D0":"Turquoise","#EE82EE":"Violet","#F5DEB3":"Wheat","#FFFFFF":"White","#F5F5F5":"White Smoke","#FFFF00":"Yellow","#9ACD32":"Yellow Green"};ECM.provide("ECM.Plugins.HtmlEditor.SpecialCharacters");ECM.Plugins.HtmlEditor.SpecialCharacters=Ext.extend(Ext.util.Observable,{langTitle:gt.gettext("Insert Special Character"),langInsert:gt.gettext("Insert"),langCancel:gt.gettext("Cancel"),init:function(a){this.cmp=a;
this.cmp.on("render",this.onRender,this);},onRender:function(){this.cmp.getToolbar().addSeparator();var a=this.cmp.getToolbar().addButton({iconCls:"x-edit-char",handler:this.showSpecialCharacters,scope:this,tooltip:{title:this.langTitle},overflowText:this.langTitle});},showSpecialCharacters:function(){var a=new Ext.data.ArrayStore({fields:["char","code","enabled","name"],data:ECM.Plugins.HtmlEditor.SpecialCharacters.CharacterList});this.charWindow=new ECM.Window({scrollable:true,id:"cms-charmap",title:this.langTitle,width:660,height:380,autoHeight:false,layout:"fit",items:[{xtype:"label",width:600,cls:"instructions",text:gt.gettext("Select special character. Hold the Ctrl (PC) / Command (Mac) button to select multiple characters.")},{xtype:"panel",layout:"column",ref:"windowContent",items:[{xtype:"dataview",store:a,width:485,ref:"charView",autoHeight:true,multiSelect:true,tpl:new Ext.XTemplate('<tpl for="."><div class="char-item">{char}</div></tpl><div class="x-clear"></div>'),overClass:"char-over",itemSelector:"div.char-item",listeners:{beforerender:function(b){b.getStore().filter("enabled",true);},dblclick:function(c,b){this.insertChar(c.getStore().getAt(b).get("char"));this.charWindow.close();},mouseenter:function(c,b){this.charViewer.showCharacter(c.getStore(),b);},scope:this}},{xtype:"panel",width:115,items:[this.charViewer=new ECM.Plugins.HtmlEditor.SpecialCharacters.CharacterViewer({id:"charViewer"})]}]}],windowButtons:[{text:this.langInsert,handler:function(){var b="";Ext.each(this.charWindow.windowContent.charView.getSelectedRecords(),function(c){b+=c.get("char");},this);this.insertChar(b);this.charWindow.close();},scope:this},{text:this.langCancel,handler:function(){this.charWindow.close();},scope:this}]});this.charWindow.show();},insertChar:function(a){if(a){this.cmp.insertAtCursor(a);}}});ECM.Plugins.HtmlEditor.SpecialCharacters.CharacterViewer=Ext.extend(Ext.Panel,{layout:"form",constructor:function(a){this.items=[{xtype:"panel",id:"charPreview",ref:"charPreview",cls:"char-preview-panel",items:[{xtype:"label",ref:"display",html:"&nbsp;",cls:"char-preview"},{xtype:"label",ref:"charName",value:"",height:35}]},{xtype:"spacer",height:22},{xtype:"panel",id:"htmlPreview",ref:"htmlPreview",cls:"char-code-panel",height:40,items:[{xtype:"label",text:gt.gettext("HTML Code")},{xtype:"label",cls:"char-code-preview",ref:"display",value:" "}]},{xtype:"panel",id:"numericPreview",ref:"numericPreview",cls:"char-code-panel",height:40,items:[{xtype:"label",text:gt.gettext("Numeric Code")},{xtype:"label",cls:"char-code-preview",ref:"display",value:" "}]}];ECM.Plugins.HtmlEditor.SpecialCharacters.CharacterViewer.superclass.constructor.call(this,a);},showCharacter:function(a,b){var d=a.getAt(b).get("char"),c=a.getAt(b).get("code"),f=a.getAt(b).get("name");if(d==="&nbsp;"){this.charPreview.display.el.dom.innerHTML="__";}else{this.charPreview.display.el.dom.innerHTML=d;}this.charPreview.charName.setText(f);this.htmlPreview.display.setText(d);this.numericPreview.display.setText(c);}});ECM.Plugins.HtmlEditor.SpecialCharacters.CharacterList=[["&nbsp;","&#160;",true,"no-break space"],["&amp;","&#38;",true,"ampersand"],["&quot;","&#34;",true,"quotation mark"],["&cent;","&#162;",true,"cent sign"],["&euro;","&#8364;",true,"euro sign"],["&pound;","&#163;",true,"pound sign"],["&yen;","&#165;",true,"yen sign"],["&copy;","&#169;",true,"copyright sign"],["&reg;","&#174;",true,"registered sign"],["&trade;","&#8482;",true,"trade mark sign"],["&permil;","&#8240;",true,"per mille sign"],["&micro;","&#181;",true,"micro sign"],["&middot;","&#183;",true,"middle dot"],["&bull;","&#8226;",true,"bullet"],["&hellip;","&#8230;",true,"three dot leader"],["&prime;","&#8242;",true,"minutes / feet"],["&Prime;","&#8243;",true,"seconds / inches"],["&sect;","&#167;",true,"section sign"],["&para;","&#182;",true,"paragraph sign"],["&szlig;","&#223;",true,"sharp s / ess-zed"],["&lsaquo;","&#8249;",true,"single left-pointing angle quotation mark"],["&rsaquo;","&#8250;",true,"single right-pointing angle quotation mark"],["&laquo;","&#171;",true,"left pointing guillemet"],["&raquo;","&#187;",true,"right pointing guillemet"],["&lsquo;","&#8216;",true,"left single quotation mark"],["&rsquo;","&#8217;",true,"right single quotation mark"],["&ldquo;","&#8220;",true,"left double quotation mark"],["&rdquo;","&#8221;",true,"right double quotation mark"],["&sbquo;","&#8218;",true,"single low-9 quotation mark"],["&bdquo;","&#8222;",true,"double low-9 quotation mark"],["&lt;","&#60;",true,"less-than sign"],["&gt;","&#62;",true,"greater-than sign"],["&le;","&#8804;",true,"less-than or equal to"],["&ge;","&#8805;",true,"greater-than or equal to"],["&ndash;","&#8211;",true,"en dash"],["&mdash;","&#8212;",true,"em dash"],["&macr;","&#175;",true,"macron"],["&oline;","&#8254;",true,"overline"],["&curren;","&#164;",true,"currency sign"],["&brvbar;","&#166;",true,"broken bar"],["&uml;","&#168;",true,"diaeresis"],["&iexcl;","&#161;",true,"inverted exclamation mark"],["&iquest;","&#191;",true,"turned question mark"],["&circ;","&#710;",true,"circumflex accent"],["&tilde;","&#732;",true,"small tilde"],["&deg;","&#176;",true,"degree sign"],["&minus;","&#8722;",true,"minus sign"],["&plusmn;","&#177;",true,"plus-minus sign"],["&divide;","&#247;",true,"division sign"],["&frasl;","&#8260;",true,"fraction slash"],["&times;","&#215;",true,"multiplication sign"],["&sup1;","&#185;",true,"superscript one"],["&sup2;","&#178;",true,"superscript two"],["&sup3;","&#179;",true,"superscript three"],["&frac14;","&#188;",true,"fraction one quarter"],["&frac12;","&#189;",true,"fraction one half"],["&frac34;","&#190;",true,"fraction three quarters"],["&fnof;","&#402;",true,"function / florin"],["&int;","&#8747;",true,"integral"],["&sum;","&#8721;",true,"n-ary sumation"],["&infin;","&#8734;",true,"infinity"],["&radic;","&#8730;",true,"square root"],["&sim;","&#8764;",false,"similar to"],["&cong;","&#8773;",false,"approximately equal to"],["&asymp;","&#8776;",true,"almost equal to"],["&ne;","&#8800;",true,"not equal to"],["&equiv;","&#8801;",true,"identical to"],["&isin;","&#8712;",false,"element of"],["&notin;","&#8713;",false,"not an element of"],["&ni;","&#8715;",false,"contains as member"],["&prod;","&#8719;",true,"n-ary product"],["&and;","&#8743;",false,"logical and"],["&or;","&#8744;",false,"logical or"],["&not;","&#172;",true,"not sign"],["&cap;","&#8745;",true,"intersection"],["&cup;","&#8746;",false,"union"],["&part;","&#8706;",true,"partial differential"],["&forall;","&#8704;",false,"for all"],["&exist;","&#8707;",false,"there exists"],["&empty;","&#8709;",false,"diameter"],["&nabla;","&#8711;",false,"backward difference"],["&lowast;","&#8727;",false,"asterisk operator"],["&prop;","&#8733;",false,"proportional to"],["&ang;","&#8736;",false,"angle"],["&acute;","&#180;",true,"acute accent"],["&cedil;","&#184;",true,"cedilla"],["&ordf;","&#170;",true,"feminine ordinal indicator"],["&ordm;","&#186;",true,"masculine ordinal indicator"],["&dagger;","&#8224;",true,"dagger"],["&Dagger;","&#8225;",true,"double dagger"],["&Agrave;","&#192;",true,"A - grave"],["&Aacute;","&#193;",true,"A - acute"],["&Acirc;","&#194;",true,"A - circumflex"],["&Atilde;","&#195;",true,"A - tilde"],["&Auml;","&#196;",true,"A - diaeresis"],["&Aring;","&#197;",true,"A - ring above"],["&AElig;","&#198;",true,"ligature AE"],["&Ccedil;","&#199;",true,"C - cedilla"],["&Egrave;","&#200;",true,"E - grave"],["&Eacute;","&#201;",true,"E - acute"],["&Ecirc;","&#202;",true,"E - circumflex"],["&Euml;","&#203;",true,"E - diaeresis"],["&Igrave;","&#204;",true,"I - grave"],["&Iacute;","&#205;",true,"I - acute"],["&Icirc;","&#206;",true,"I - circumflex"],["&Iuml;","&#207;",true,"I - diaeresis"],["&ETH;","&#208;",true,"ETH"],["&Ntilde;","&#209;",true,"N - tilde"],["&Ograve;","&#210;",true,"O - grave"],["&Oacute;","&#211;",true,"O - acute"],["&Ocirc;","&#212;",true,"O - circumflex"],["&Otilde;","&#213;",true,"O - tilde"],["&Ouml;","&#214;",true,"O - diaeresis"],["&Oslash;","&#216;",true,"O - slash"],["&OElig;","&#338;",true,"ligature OE"],["&Scaron;","&#352;",true,"S - caron"],["&Ugrave;","&#217;",true,"U - grave"],["&Uacute;","&#218;",true,"U - acute"],["&Ucirc;","&#219;",true,"U - circumflex"],["&Uuml;","&#220;",true,"U - diaeresis"],["&Yacute;","&#221;",true,"Y - acute"],["&Yuml;","&#376;",true,"Y - diaeresis"],["&THORN;","&#222;",true,"THORN"],["&agrave;","&#224;",true,"a - grave"],["&aacute;","&#225;",true,"a - acute"],["&acirc;","&#226;",true,"a - circumflex"],["&atilde;","&#227;",true,"a - tilde"],["&auml;","&#228;",true,"a - diaeresis"],["&aring;","&#229;",true,"a - ring above"],["&aelig;","&#230;",true,"ligature ae"],["&ccedil;","&#231;",true,"c - cedilla"],["&egrave;","&#232;",true,"e - grave"],["&eacute;","&#233;",true,"e - acute"],["&ecirc;","&#234;",true,"e - circumflex"],["&euml;","&#235;",true,"e - diaeresis"],["&igrave;","&#236;",true,"i - grave"],["&iacute;","&#237;",true,"i - acute"],["&icirc;","&#238;",true,"i - circumflex"],["&iuml;","&#239;",true,"i - diaeresis"],["&eth;","&#240;",true,"eth"],["&ntilde;","&#241;",true,"n - tilde"],["&ograve;","&#242;",true,"o - grave"],["&oacute;","&#243;",true,"o - acute"],["&ocirc;","&#244;",true,"o - circumflex"],["&otilde;","&#245;",true,"o - tilde"],["&ouml;","&#246;",true,"o - diaeresis"],["&oslash;","&#248;",true,"o slash"],["&oelig;","&#339;",true,"ligature oe"],["&scaron;","&#353;",true,"s - caron"],["&ugrave;","&#249;",true,"u - grave"],["&uacute;","&#250;",true,"u - acute"],["&ucirc;","&#251;",true,"u - circumflex"],["&uuml;","&#252;",true,"u - diaeresis"],["&yacute;","&#253;",true,"y - acute"],["&thorn;","&#254;",true,"thorn"],["&yuml;","&#255;",true,"y - diaeresis"],["&Alpha;","&#913;",true,"Alpha"],["&Beta;","&#914;",true,"Beta"],["&Gamma;","&#915;",true,"Gamma"],["&Delta;","&#916;",true,"Delta"],["&Epsilon;","&#917;",true,"Epsilon"],["&Zeta;","&#918;",true,"Zeta"],["&Eta;","&#919;",true,"Eta"],["&Theta;","&#920;",true,"Theta"],["&Iota;","&#921;",true,"Iota"],["&Kappa;","&#922;",true,"Kappa"],["&Lambda;","&#923;",true,"Lambda"],["&Mu;","&#924;",true,"Mu"],["&Nu;","&#925;",true,"Nu"],["&Xi;","&#926;",true,"Xi"],["&Omicron;","&#927;",true,"Omicron"],["&Pi;","&#928;",true,"Pi"],["&Rho;","&#929;",true,"Rho"],["&Sigma;","&#931;",true,"Sigma"],["&Tau;","&#932;",true,"Tau"],["&Upsilon;","&#933;",true,"Upsilon"],["&Phi;","&#934;",true,"Phi"],["&Chi;","&#935;",true,"Chi"],["&Psi;","&#936;",true,"Psi"],["&Omega;","&#937;",true,"Omega"],["&alpha;","&#945;",true,"alpha"],["&beta;","&#946;",true,"beta"],["&gamma;","&#947;",true,"gamma"],["&delta;","&#948;",true,"delta"],["&epsilon;","&#949;",true,"epsilon"],["&zeta;","&#950;",true,"zeta"],["&eta;","&#951;",true,"eta"],["&theta;","&#952;",true,"theta"],["&iota;","&#953;",true,"iota"],["&kappa;","&#954;",true,"kappa"],["&lambda;","&#955;",true,"lambda"],["&mu;","&#956;",true,"mu"],["&nu;","&#957;",true,"nu"],["&xi;","&#958;",true,"xi"],["&omicron;","&#959;",true,"omicron"],["&pi;","&#960;",true,"pi"],["&rho;","&#961;",true,"rho"],["&sigmaf;","&#962;",true,"final sigma"],["&sigma;","&#963;",true,"sigma"],["&tau;","&#964;",true,"tau"],["&upsilon;","&#965;",true,"upsilon"],["&phi;","&#966;",true,"phi"],["&chi;","&#967;",true,"chi"],["&psi;","&#968;",true,"psi"],["&omega;","&#969;",true,"omega"],["&alefsym;","&#8501;",false,"alef symbol"],["&piv;","&#982;",false,"pi symbol"],["&real;","&#8476;",false,"real part symbol"],["&thetasym;","&#977;",false,"theta symbol"],["&upsih;","&#978;",false,"upsilon - hook symbol"],["&weierp;","&#8472;",false,"Weierstrass p"],["&image;","&#8465;",false,"imaginary part"],["&larr;","&#8592;",true,"leftwards arrow"],["&uarr;","&#8593;",true,"upwards arrow"],["&rarr;","&#8594;",true,"rightwards arrow"],["&darr;","&#8595;",true,"downwards arrow"],["&harr;","&#8596;",true,"left right arrow"],["&crarr;","&#8629;",false,"carriage return"],["&lArr;","&#8656;",false,"leftwards double arrow"],["&uArr;","&#8657;",false,"upwards double arrow"],["&rArr;","&#8658;",false,"rightwards double arrow"],["&dArr;","&#8659;",false,"downwards double arrow"],["&hArr;","&#8660;",false,"left right double arrow"],["&there4;","&#8756;",false,"therefore"],["&sub;","&#8834;",false,"subset of"],["&sup;","&#8835;",false,"superset of"],["&nsub;","&#8836;",false,"not a subset of"],["&sube;","&#8838;",false,"subset of or equal to"],["&supe;","&#8839;",false,"superset of or equal to"],["&oplus;","&#8853;",false,"circled plus"],["&otimes;","&#8855;",false,"circled times"],["&perp;","&#8869;",false,"perpendicular"],["&sdot;","&#8901;",false,"dot operator"],["&lceil;","&#8968;",false,"left ceiling"],["&rceil;","&#8969;",false,"right ceiling"],["&lfloor;","&#8970;",false,"left floor"],["&rfloor;","&#8971;",false,"right floor"],["&lang;","&#9001;",false,"left-pointing angle bracket"],["&rang;","&#9002;",false,"right-pointing angle bracket"],["&loz;","&#9674;",true,"lozenge"],["&spades;","&#9824;",true,"black spade suit"],["&clubs;","&#9827;",true,"black club suit"],["&hearts;","&#9829;",true,"black heart suit"],["&diams;","&#9830;",true,"black diamond suit"],["&ensp;","&#8194;",false,"en space"],["&emsp;","&#8195;",false,"em space"],["&thinsp;","&#8201;",false,"thin space"],["&zwnj;","&#8204;",false,"zero width non-joiner"],["&zwj;","&#8205;",false,"zero width joiner"],["&lrm;","&#8206;",false,"left-to-right mark"],["&rlm;","&#8207;",false,"right-to-left mark"],["&shy;","&#173;",false,"soft hyphen"]];
ECM.provide("ECM.Form.HtmlEditor");ECM.Form.HtmlEditor=Ext.extend(Ext.form.HtmlEditor,{iframePad:(Ext.isIE9)?0:3,plugins:[new ECM.Plugins.HtmlEditor.Image(),new ECM.Plugins.HtmlEditor.Table(),new ECM.Plugins.HtmlEditor.Link(),new ECM.Plugins.HtmlEditor.ContextMenu(),new ECM.Plugins.HtmlEditor.ColorPicker(),new ECM.Plugins.HtmlEditor.SpecialCharacters()],constructor:function(a){obj=this;this.XWidth=a.x||350;this.YWidth=a.y||325;ECM.Form.HtmlEditor.superclass.constructor.apply(this,arguments);},defaultHtmlHeader:"<html><body>",defaultHtmlFooter:"</body></html>",fontFamilies:["Arial","Courier New","Tahoma","Times New Roman","Verdana"],fontFamiliesValue:["arial,helvetica,sans-serif","courier new,courier,monospace","tahoma,geneva,sans-serif","times new roman,times,serif","verdana,geneva,sans-serif"],defaultFont:"",ddMouseMove:function(b){if(!this.dragCurrent){return true;}var a=function(g){var c=Ext.get("page_iframe");if(Ext.isIE){var f=Ext.fly(document.body).getScroll().top;g.xy=[g.xy[0]-c.getLeft()+obj.XWidth+30,g.xy[1]+c.getTop()-f];}else{var d=(Ext.getDom("page_iframe").contentDocument||window.frames.page_iframe.document);var f=d.documentElement.scrollTop||d.body.scrollTop;var h=d.documentElement.scrollLeft||d.body.scrollLeft;g.xy=[g.xy[0]-c.getLeft()-h+obj.XWidth+30,g.xy[1]-f+obj.YWidth-20];}};a(b);this.handleMouseMove(b);},ddMouseUp:function(b){if(!this.dragCurrent){return true;}var a=function(g){var c=Ext.get("page_iframe");if(Ext.isIE){var f=Ext.fly(document.body).getScroll().top;g.xy=[g.xy[0]-c.getLeft()+obj.XWidth+30,g.xy[1]+c.getTop()-f];}else{var d=(Ext.getDom("page_iframe").contentDocument||window.frames.page_iframe.document);var f=d.documentElement.scrollTop||d.body.scrollTop;var h=d.documentElement.scrollLeft||d.body.scrollLeft;g.xy=[g.xy[0]-c.getLeft()-h+obj.XWidth+30,g.xy[1]-f+obj.YWidth-20];}};a(b);this.handleMouseUp(b);},onClick:function(a){this.lastTarget=undefined;if(Ext.isDefined(a.getTarget())&&a.getTarget().tagName=="IMG"){this.lastTarget=a.getTarget();}},pushValue:function(){if(Ext.isDefined(this.iframe)){var c=Ext.dd.DragDropMgr;c.getZIndex=function(f){var d=document.body,g,h=1;f=Ext.getDom(f);while(f&&f.parentNode&&f!==d){if(!isNaN(g=Number(Ext.fly(f).getStyle("zIndex")))){h=g;}f=f.parentNode;}return h;};this.iframe.id="page_iframe";if(Ext.isIE){Ext.EventManager.on(this.iframe.contentWindow.document,"mousemove",this.ddMouseMove,c,true);Ext.EventManager.on(this.iframe.contentWindow.document,"mouseup",this.ddMouseUp,c,true);Ext.EventManager.on(this.iframe.contentWindow.document,"click",this.onClick,this,true);}else{Ext.EventManager.on(this.iframe.contentDocument,"mousemove",this.ddMouseMove,c,true);Ext.EventManager.on(this.iframe.contentDocument,"mouseup",this.ddMouseUp,c,true);Ext.EventManager.on(this.iframe.contentDocument,"click",this.onClick,this,true);}}if(this.initialized&&!this.sourceEditMode){var a=this.el.dom.value;var b=a.match(/^([\s\S]*?<html[^>]*>[\s\S]*?<body[^>]*>)([\s\S]*?)(<\/body>[\s\S]*?<\/html>[\s\S]*)$/i);this.htmlHeader=this.defaultHtmlHeader;this.htmlFooter=this.defaultHtmlFooter;if(Ext.isArray(b)){this.htmlHeader=b[1];this.el.dom.value=b[2];this.htmlFooter=b[3];}}ECM.Form.HtmlEditor.superclass.pushValue.call(this,arguments);},createFontOptions:function(){var d=[],b=this.fontFamilies,c,g;var h=this.fontFamiliesValue;d.push('<option value="" disabled>&nbsp;</option>');for(var f=0,a=b.length;f<a;f++){c=b[f];g=c.toLowerCase();d.push('<option value="',h[f],'" style="font-family:',c,';"',(this.defaultFont==g?' selected="true">':">"),c,"</option>");}return d.join("");},updateToolbar:function(){if(this.readOnly){return;}if(!this.activated){this.onFirstFocus();return;}var c=this.tb.items.map,d=this.getDoc();if(this.enableFont&&!Ext.isSafari2){var a="",b="";if(Ext.isIE){b=Ext.isDefined(d.selection.createRange().parentElement)?d.selection.createRange().parentElement:false;if(b){a=(b.nodeName==="SPAN"||b.nodeName==="FONT")?(b.style.getAttribute("fontFamily")||b.face).toLowerCase():"";}}else{b=Ext.isDefined(this.getWin().getSelection().anchorNode.parentNode)?this.getWin().getSelection().anchorNode.parentNode:false;if(b){a=(b.nodeName==="SPAN"||b.nodeName==="FONT")?(d.queryCommandValue("FontName")||this.defaultFont).toLowerCase():"";a=a.replace(/,[\s]/g,",").replace(/[']/g,"");}}if(a!=this.fontSelect.dom.value){this.fontSelect.dom.value=a;}}if(this.enableFormat){c.bold.toggle(d.queryCommandState("bold"));c.italic.toggle(d.queryCommandState("italic"));c.underline.toggle(d.queryCommandState("underline"));}if(this.enableAlignments){c.justifyleft.toggle(d.queryCommandState("justifyleft"));c.justifycenter.toggle(d.queryCommandState("justifycenter"));c.justifyright.toggle(d.queryCommandState("justifyright"));}if(!Ext.isSafari2&&this.enableLists){c.insertorderedlist.toggle(d.queryCommandState("insertorderedlist"));c.insertunorderedlist.toggle(d.queryCommandState("insertunorderedlist"));}Ext.menu.MenuMgr.hideAll();this.syncValue();},cleanHtml:function(b){b=ECM.Form.HtmlEditor.superclass.cleanHtml.call(this,b);if(Ext.isIE){var a=window.location.protocol+"//"+window.location.host+window.window.location.pathname;a=a.split("/");a=a.splice(0,a.length-1);a=a.join("/")+"/";var c=new RegExp(a,"gi");b=b.replace(c,"");b=b.replace(/http:\/\/thisisfakeurlforie\//gi,"");}return this.htmlHeader+b+this.htmlFooter;},onEditorEvent:function(a){if(Ext.isIE){this.win.focus();if(Ext.isDefined(a.getTarget())&&a.getTarget().tagName=="IMG"){this.lastTarget=a.getTarget();}if(this.getDoc()&&this.getDoc().selection){this.currentRange=this.getDoc().selection.createRange();}}if(a.type==="keyup"){this.lastTarget=undefined;}this.updateToolbar();},adjustFont:function(d){var f=d.getItemId()==="increasefontsize"?1:-1,c=this.getDoc().queryCommandValue("FontSize")||"2",a=Ext.isString(c)&&c.indexOf("px")!==-1,b;c=parseInt(c,10);if(a){if(c<=10){c=1+f;}else{if(c<=13){c=2+f;}else{if(c<=16){c=3+f;}else{if(c<=18){c=4+f;}else{if(c<=24){c=5+f;}else{c=6+f;}}}}}c=c.constrain(1,6);}else{b=Ext.isSafari;if(b){f*=2;}c=Math.max(1,c+f)+(b?"px":0);}this.execCmd("FontSize",c);},insertAtCursor:function(b){if(Ext.isIE){this.win.focus();var a=this.currentRange||((this.getDoc()&&this.getDoc().selection)?this.getDoc().selection.createRange():undefined);if(a){if(Ext.isDefined(a.collapse)&&Ext.isDefined(a.pasteHTML)){a.collapse(true);a.pasteHTML(b);}else{if(Ext.isDefined(this.lastTarget)){this.lastTarget.outerHTML=b;}}this.syncValue();this.deferFocus();}}else{this.win.focus();this.execCmd("InsertHTML",b);this.deferFocus();}},createLink:function(){var a=new ECM.Plugins.HtmlEditor.Link();a.createLink(this);},beforeExeCmd:Ext.emptyFn,execCmd:function(c,b){var d=this.getDoc();var a=this.beforeExeCmd(c,b);if(a===false){return;}else{if(Ext.isArray(a)){c=a[0];b=a[1];}}d.execCommand(c,false,b===undefined?null:b);this.syncValue();},copy:function(){try{if(Ext.isSafari){throw 0;}this.execCmd("copy");}catch(a){Ext.Msg.alert("Permission denied",gt.gettext("Your browser security settings don't permit the editor to automatically execute copying operations. Please use the keyboard for that (Ctrl/Cmd+C)."));}},cut:function(){try{if(Ext.isSafari){throw 0;}this.execCmd("cut");}catch(a){Ext.Msg.alert("Permission denied",gt.gettext("Your browser security settings don't permit the editor to automatically execute cutting operations. Please use the keyboard for that (Ctrl/Cmd+X)."));}},paste:function(){try{if(Ext.isSafari){throw 0;}this.win.focus();this.execCmd("paste");this.deferFocus();}catch(a){Ext.Msg.alert("Permission denied",gt.gettext("Your browser security settings don't permit the editor to automatically execute pasting operations. Please use the keyboard for that (Ctrl/Cmd+V)."));}}});Ext.reg("ecm.htmleditor",ECM.Form.HtmlEditor);ECM.provide("ECM.CMS.Modal.FBLikeCustomUrl");ECM.CMS.Modal.FBLikeCustomUrl=Ext.extend(ECM.Window,{constructor:function(b){Ext.QuickTips.init();this.title=gt.gettext("Facebook Like: Custom URL");this.width=550;Ext.apply(this,b);var c=this;var a=new Ext.form.FormPanel({labelWidth:120,items:[{xtype:"textfield",fieldLabel:gt.gettext("Description of URL"),id:"fblikeurl_desc",name:"fblikeurl_desc",width:350,emptyText:gt.gettext("Enter Description of URL"),maxLength:50,maxLengthText:gt.gettext("Invalid text parameter - must contain no more than 50 characters")},{xtype:"textfield",fieldLabel:gt.gettext("URL to Like"),id:"fblikeurl_url",name:"fblikeurl_url",width:350,allowBlank:false,blankText:gt.gettext("Please enter a valid URL."),vtype:"url",vtypeText:gt.gettext("This is not a valid url. Please make sure you have entered a valid URL."),emptyText:gt.gettext("Enter URL to Like"),msgTarget:"side",listeners:{invalid:function(){c.insertButton.disable();
},valid:function(){c.insertButton.enable();}}}]});this.insertButton=new Ext.Button({text:gt.gettext("Insert"),disabled:true,handler:function(){var f=Ext.getCmp("fblikeurl_desc").getValue();var d=Ext.getCmp("fblikeurl_url").getValue();f=Ext.isEmpty(f)?d:f;var g='%%t_fblike_url("'+d+'","'+f+'")%%';if(Ext.isDefined(c.editorType&&c.replaceFrom&&c.replaceTo)){c.editorType.replaceRange(g,c.replaceFrom,c.replaceTo);}else{if(c.editorType==="extjseditor"){Ext.getCmp("extjseditor").insertAtCursor(g);}}c.close();}});this.items=[{html:gt.gettext("The description of the URL is not required. It will display before the URL if entered.")+"<br>"+gt.gettext("If you don't enter a description, the URL will be displayed twice.")+"<br/><br/>"},a];this.windowButtons=[this.insertButton];ECM.CMS.Modal.FBLikeCustomUrl.superclass.constructor.call(this,b);}});Ext.reg("ecm.modalfblikecustomurl",ECM.CMS.Modal.FBLikeCustomUrl);ECM.provide("ECM.util.HtmlEncode");ECM.util.HtmlEncode=Ext.extend(Object,{EncodeType:"entity",isEmpty:function(a){if(a){return((a===null)||a.length==0||/^\s+$/.test(a));}else{return true;}},arr1:new Array("&nbsp;","&iexcl;","&cent;","&pound;","&curren;","&yen;","&brvbar;","&sect;","&uml;","&copy;","&ordf;","&laquo;","&not;","&shy;","&reg;","&macr;","&deg;","&plusmn;","&sup2;","&sup3;","&acute;","&micro;","&para;","&middot;","&cedil;","&sup1;","&ordm;","&raquo;","&frac14;","&frac12;","&frac34;","&iquest;","&Agrave;","&Aacute;","&Acirc;","&Atilde;","&Auml;","&Aring;","&AElig;","&Ccedil;","&Egrave;","&Eacute;","&Ecirc;","&Euml;","&Igrave;","&Iacute;","&Icirc;","&Iuml;","&ETH;","&Ntilde;","&Ograve;","&Oacute;","&Ocirc;","&Otilde;","&Ouml;","&times;","&Oslash;","&Ugrave;","&Uacute;","&Ucirc;","&Uuml;","&Yacute;","&THORN;","&szlig;","&agrave;","&aacute;","&acirc;","&atilde;","&auml;","&aring;","&aelig;","&ccedil;","&egrave;","&eacute;","&ecirc;","&euml;","&igrave;","&iacute;","&icirc;","&iuml;","&eth;","&ntilde;","&ograve;","&oacute;","&ocirc;","&otilde;","&ouml;","&divide;","&oslash;","&ugrave;","&uacute;","&ucirc;","&uuml;","&yacute;","&thorn;","&yuml;","&quot;","&amp;","&lt;","&gt;","&OElig;","&oelig;","&Scaron;","&scaron;","&Yuml;","&circ;","&tilde;","&ensp;","&emsp;","&thinsp;","&zwnj;","&zwj;","&lrm;","&rlm;","&ndash;","&mdash;","&lsquo;","&rsquo;","&sbquo;","&ldquo;","&rdquo;","&bdquo;","&dagger;","&Dagger;","&permil;","&lsaquo;","&rsaquo;","&euro;","&fnof;","&Alpha;","&Beta;","&Gamma;","&Delta;","&Epsilon;","&Zeta;","&Eta;","&Theta;","&Iota;","&Kappa;","&Lambda;","&Mu;","&Nu;","&Xi;","&Omicron;","&Pi;","&Rho;","&Sigma;","&Tau;","&Upsilon;","&Phi;","&Chi;","&Psi;","&Omega;","&alpha;","&beta;","&gamma;","&delta;","&epsilon;","&zeta;","&eta;","&theta;","&iota;","&kappa;","&lambda;","&mu;","&nu;","&xi;","&omicron;","&pi;","&rho;","&sigmaf;","&sigma;","&tau;","&upsilon;","&phi;","&chi;","&psi;","&omega;","&thetasym;","&upsih;","&piv;","&bull;","&hellip;","&prime;","&Prime;","&oline;","&frasl;","&weierp;","&image;","&real;","&trade;","&alefsym;","&larr;","&uarr;","&rarr;","&darr;","&harr;","&crarr;","&lArr;","&uArr;","&rArr;","&dArr;","&hArr;","&forall;","&part;","&exist;","&empty;","&nabla;","&isin;","&notin;","&ni;","&prod;","&sum;","&minus;","&lowast;","&radic;","&prop;","&infin;","&ang;","&and;","&or;","&cap;","&cup;","&int;","&there4;","&sim;","&cong;","&asymp;","&ne;","&equiv;","&le;","&ge;","&sub;","&sup;","&nsub;","&sube;","&supe;","&oplus;","&otimes;","&perp;","&sdot;","&lceil;","&rceil;","&lfloor;","&rfloor;","&lang;","&rang;","&loz;","&spades;","&clubs;","&hearts;","&diams;"),arr2:new Array("&#160;","&#161;","&#162;","&#163;","&#164;","&#165;","&#166;","&#167;","&#168;","&#169;","&#170;","&#171;","&#172;","&#173;","&#174;","&#175;","&#176;","&#177;","&#178;","&#179;","&#180;","&#181;","&#182;","&#183;","&#184;","&#185;","&#186;","&#187;","&#188;","&#189;","&#190;","&#191;","&#192;","&#193;","&#194;","&#195;","&#196;","&#197;","&#198;","&#199;","&#200;","&#201;","&#202;","&#203;","&#204;","&#205;","&#206;","&#207;","&#208;","&#209;","&#210;","&#211;","&#212;","&#213;","&#214;","&#215;","&#216;","&#217;","&#218;","&#219;","&#220;","&#221;","&#222;","&#223;","&#224;","&#225;","&#226;","&#227;","&#228;","&#229;","&#230;","&#231;","&#232;","&#233;","&#234;","&#235;","&#236;","&#237;","&#238;","&#239;","&#240;","&#241;","&#242;","&#243;","&#244;","&#245;","&#246;","&#247;","&#248;","&#249;","&#250;","&#251;","&#252;","&#253;","&#254;","&#255;","&#34;","&#38;","&#60;","&#62;","&#338;","&#339;","&#352;","&#353;","&#376;","&#710;","&#732;","&#8194;","&#8195;","&#8201;","&#8204;","&#8205;","&#8206;","&#8207;","&#8211;","&#8212;","&#8216;","&#8217;","&#8218;","&#8220;","&#8221;","&#8222;","&#8224;","&#8225;","&#8240;","&#8249;","&#8250;","&#8364;","&#402;","&#913;","&#914;","&#915;","&#916;","&#917;","&#918;","&#919;","&#920;","&#921;","&#922;","&#923;","&#924;","&#925;","&#926;","&#927;","&#928;","&#929;","&#931;","&#932;","&#933;","&#934;","&#935;","&#936;","&#937;","&#945;","&#946;","&#947;","&#948;","&#949;","&#950;","&#951;","&#952;","&#953;","&#954;","&#955;","&#956;","&#957;","&#958;","&#959;","&#960;","&#961;","&#962;","&#963;","&#964;","&#965;","&#966;","&#967;","&#968;","&#969;","&#977;","&#978;","&#982;","&#8226;","&#8230;","&#8242;","&#8243;","&#8254;","&#8260;","&#8472;","&#8465;","&#8476;","&#8482;","&#8501;","&#8592;","&#8593;","&#8594;","&#8595;","&#8596;","&#8629;","&#8656;","&#8657;","&#8658;","&#8659;","&#8660;","&#8704;","&#8706;","&#8707;","&#8709;","&#8711;","&#8712;","&#8713;","&#8715;","&#8719;","&#8721;","&#8722;","&#8727;","&#8730;","&#8733;","&#8734;","&#8736;","&#8743;","&#8744;","&#8745;","&#8746;","&#8747;","&#8756;","&#8764;","&#8773;","&#8776;","&#8800;","&#8801;","&#8804;","&#8805;","&#8834;","&#8835;","&#8836;","&#8838;","&#8839;","&#8853;","&#8855;","&#8869;","&#8901;","&#8968;","&#8969;","&#8970;","&#8971;","&#9001;","&#9002;","&#9674;","&#9824;","&#9827;","&#9829;","&#9830;"),HTML2Numerical:function(a){return this.swapArrayVals(a,this.arr1,this.arr2);},NumericalToHTML:function(a){return this.swapArrayVals(a,this.arr2,this.arr1);},numEncode:function(c){if(this.isEmpty(c)){return"";}var b=c.split("");var a=b.length;while(a--){if(b[a]>"~"){b[a]="&#"+b[a].charCodeAt()+";";}}return b.join("");},htmlDecode:function(f){var h,b,g=f;if(this.isEmpty(g)){return"";}g=this.HTML2Numerical(g);arr=g.match(/&#[0-9]{1,5};/g);if(arr!=null){for(var a=0;a<arr.length;a++){b=arr[a];h=b.substring(2,b.length-1);if(h>=-32768&&h<=65535){g=g.replace(b,String.fromCharCode(h));}else{g=g.replace(b,"");}}}return g;},htmlEncode:function(a,b){if(this.isEmpty(a)){return"";}b=b||false;if(b){if(this.EncodeType=="numerical"){a=a.replace(/&/g,"&#38;");}else{a=a.replace(/&/g,"&amp;");}}if(this.EncodeType=="numerical"||!b){a=this.HTML2Numerical(a);}a=this.numEncode(a);if(!b){a=a.replace(/&#/g,"##AMPHASH##");if(this.EncodeType=="numerical"){a=a.replace(/&/g,"&#38;");}else{a=a.replace(/&/g,"&amp;");}a=a.replace(/##AMPHASH##/g,"&#");}a=a.replace(/&#\d*([^\d;]|$)/g,"$1");if(!b){a=this.correctEncoding(a);}if(this.EncodeType=="entity"){a=this.NumericalToHTML(a);}return a;},XSSEncode:function(b,a){if(!this.isEmpty(b)){a=a||true;if(a){b=b.replace(/\'/g,"&#39;");b=b.replace(/\"/g,"&quot;");b=b.replace(/</g,"&lt;");b=b.replace(/>/g,"&gt;");}else{b=b.replace(/\'/g,"&#39;");b=b.replace(/\"/g,"&#34;");b=b.replace(/</g,"&#60;");b=b.replace(/>/g,"&#62;");}return b;}else{return"";}},hasEncoded:function(a){if(/&#[0-9]{1,5};/g.test(a)){return true;}else{if(/&[A-Z]{2,6};/gi.test(a)){return true;}else{return false;}}},stripUnicode:function(a){return a.replace(/[^\x20-\x7E]/g,"");},correctEncoding:function(a){return a.replace(/(&amp;)(amp;)+/,"$1");},swapArrayVals:function(g,c,b){if(this.isEmpty(g)){return"";}var f;if(c&&b){if(c.length==b.length){for(var a=0,d=c.length;a<d;a++){f=new RegExp(c[a],"g");g=g.replace(f,b[a]);}}}return g;},inArray:function(d,b){for(var c=0,a=b.length;c<a;c++){if(b[c]===d){return c;}}return -1;}});ECM.provide("ECM.CMS.Panel.ContentEditor.Html");ECM.CMS.Panel.ContentEditor.Html=Ext.extend(Ext.TabPanel,{id:"html_tabpanel",initComponent:function(){var c=this;
var b=new ECM.util.HtmlEncode();var a=new Ext.Container({title:gt.gettext("Source"),id:"source",items:[{xtype:"textarea",id:"htmltextarea"}],listeners:{activate:function(d){if(c.justInit&&c.contentData.use_templates&&c.contentData.use_templates!=="editor"){c.justInit=false;return;}if(Ext.isDefined(Ext.getCmp("htmlwrap_panel"))){Ext.getCmp("htmlwrap_panel").show();}c.fireEvent("searchandreplacebutton","source");if(c.wysiwygEditor.modified||(c.wysiwygEditor.initialized&&c.origContent!=c.wysiwygEditor.getEditorBody().innerHTML)){var f=c.wysiwygEditor.getValue();f=b.htmlEncode(f);f=c.encodeDecode(f,false);c.fireEvent("extjseditorinput",f);}ECM.Flare.updateLink("FLARE_CONTENT_HTML");},afterRender:function(d){c.dropTarget=new Ext.dd.DropTarget(Ext.get("source"),{ddGroup:"DCZone",copy:false,overClass:"over",notifyOver:function(g,j,k){var h=Ext.getCmp("contentPanelId").htmlFrame,f=j.getPageX(),l=j.getPageY();h.setCursor(h.coordsChar({x:f,y:l}));},notifyDrop:function(h,f,o){var l=Ext.getCmp("contentPanelId").htmlFrame,r=l.getCursor(),n=l.getTokenAt(r);if(!Ext.isDefined(o.node.attributes.content)){return false;}if(o.node.attributes.type==="link"&&n.state.baseCur==="xml-attribute"&&n.state.base.tagName==="a"){c._dropTag(l,o,'"'+o.node.attributes.textContent+'"',{line:r.line,ch:n.state.baseStart},{line:r.line,ch:n.state.baseEnd});}else{if(o.node.attributes.type==="image"&&n.state.baseCur==="xml-attribute"&&n.state.base.tagName==="img"){c._dropTag(l,o,'"'+o.node.attributes.textContent+'"',{line:r.line,ch:n.state.baseStart},{line:r.line,ch:n.state.baseEnd});}else{var s=/(%%[a-zA-Z0-9_\[\]]+%%)|(%%[\w_]+\(.+\)+%%)/g;var j=n.string.match(s);var q=undefined;var p=0,g=0;var k=(j)?j.length:0;for(var m=0;m<k;m++){p=n.string.indexOf(j[m])+n.start;g=n.string.indexOf(j[m])+j[m].length+n.start;if(p<=r.ch&&r.ch<=g){q={start:p,end:g};break;}}if(Ext.isDefined(q)){n.start=q.start;n.end=q.end;Ext.Msg.show({title:gt.gettext("Info"),msg:gt.gettext("Replace current tag?"),cls:"blue_button",buttons:Ext.Msg.OKCANCEL,fn:function(t){if(t==="ok"){c._dropTag(l,o,o.node.attributes.content,{line:r.line,ch:n.start},{line:r.line,ch:n.end});}}});}else{c._dropTag(l,o,o.node.attributes.content,r,r);}}}return true;}});}}});this.wysiwygEditor=new ECM.Form.HtmlEditor({title:gt.gettext("HTML Editor"),id:"extjseditor",activated:true,autoCreate:{tag:"textarea",id:"extjstextarea"},enableSourceEdit:false,listeners:{beforesync:function(d){ECM.Flare.onFocus("FLARE_CONTENT_HTML");return d.modified||c.origContent!=d.getEditorBody().innerHTML;},sync:function(d){if(c.activeTab.id==="source"){return;}setTimeout(function(){var f=Ext.get("extjstextarea").getValue();c.fireEvent("extjseditorinput",f);d.modified=(d.modified||c.origContent!=d.getEditorBody().innerHTML);},10);},activate:function(){var d=Ext.getCmp("htmltextarea").getValue();d=d.replace(/(<svg)([^>]*)(>)/gi,"");if(Ext.isIE){d=d.replace(/(<\s*img\s.*?src\s*\=\s*(?:"|')(?!http\:\/\/|https\:\/\/))/gi,"$1http://thisisfakeurlforie/");}d=c.encodeDecode(d,true);this.setValue(d);if(this.initialized){c.origContent=this.getEditorBody().innerHTML;}if(Ext.isDefined(Ext.getCmp("htmlwrap_panel"))){Ext.getCmp("htmlwrap_panel").hide();}c.fireEvent("searchandreplacebutton","htmleditor");ECM.Flare.updateLink("FLARE_CONTENT_HTML");},afterrender:function(){if(Ext.isIE7){this.iframe.parentNode.style.height=472;}},initialize:function(){c.origContent=this.getEditorBody().innerHTML;this.originalValue=this.getValue();var f=this;var g=Ext.get("page_iframe");var d=new Ext.dd.DropZone(g.parent(),{ddGroup:"DCZone",getTargetFromEvent:function(h){return h.getTarget();},onNodeDrop:function(n,h,m,l){if(Ext.isEmpty(l.node.attributes.content)){return false;}if(l.node.attributes.dcTagSource==="library"){Ext.getCmp("leftnav_panel").checkLibraryTag({tag:l.node.attributes.content,editorType:"extjseditor"});}else{if(l.node.attributes.content.match(/%%t_fblike_url\(.*\)%%/)){var j=new ECM.CMS.Modal.FBLikeCustomUrl({editorType:"extjseditor"});j.show();}else{if(l.node.attributes.type==="image"&&(n.nodeName==="IMG"||Ext.isDefined(f.lastTarget))){if(Ext.isDefined(f.lastTarget)){n=f.lastTarget;}this.onNodeDropImg(n,h,m,l);}else{var k=c.encodeDecode(l.node.attributes.content,true);f.insertAtCursor(k);}}}return true;},onNodeDropImg:function(l,h,k,j){Ext.Msg.confirm(gt.gettext("Preserve Image Properties"),gt.gettext("Do you want to preserve existing image properties?"),function(m){var n=c.encodeDecode(j.node.attributes.textContent,true);if(m==="yes"){l.setAttribute("src",n);}else{if(Ext.isDefined(l.outerHTML)){l.outerHTML=c.encodeDecode(j.node.attributes.content,true);}else{Ext.DomHelper.insertBefore(l,{tag:"img",src:n,alt:""});l.parentNode.removeChild(l);}}if(Ext.isDefined(f.lastTarget)){f.lastTarget=undefined;}});}});}},beforeExeCmd:function(f,d){if(f==="createlink"&&d){return[f,encodeURIComponent(d)];}}});this.items=[a,this.wysiwygEditor];ECM.CMS.Panel.ContentEditor.Html.superclass.initComponent.apply(this,arguments);this.setActiveTab("source");this.addEvents("extjseditorinput","searchandreplacebutton");},encodeDecodeURL:function(c,b){if(!Ext.isDefined(c)){return c;}var a=c.match(/<a(.|\n)*?href(\s|\n)*?=(\s|\n)*?".*?\n?.*?"(>|\s)/ig);Ext.each(a,function(g){var h=g.match(/href(\s|\n)*?\=(\s|\n)*?"(.*?)"/);if(h===null){return false;}if(h.length<4){return false;}h=h[3];try{var d=b?encodeURIComponent(h):decodeURIComponent(h);c=c.replace('"'+h+'"','"'+d+'"');}catch(f){}});return c;},encodeDecode:function(c,b){c=this.encodeDecodeURL(c,b);if(Ext.isIE){return c;}var g,d,f,a;if(b){d=c.match(/<(td|th)[^>]*>\s*<\/(td|th)>/gi);d=Ext.unique(d);Ext.each(d,function(h){a=h.match(/<(td|th)/i).pop();f=h.replace(/<\/(td|th)>/i,"");h=h.replace(/[()]/g,"\\$&");g=new RegExp(h,"gi");c=c.replace(g,f+'<br _ecm_dirty=""></'+a+">");});}else{c=c.replace(/<br _ecm_dirty="">/gi,"");}return c;},_dropTag:function(a,f,d,b,g){if(f.node.attributes.dcTagSource==="library"){Ext.getCmp("leftnav_panel").checkLibraryTag({tag:d,editorType:a,replaceFrom:b,replaceTo:g});}else{if(d.match(/%%t_fblike_url\(.*\)%%/)){var c=new ECM.CMS.Modal.FBLikeCustomUrl({editorType:a,replaceFrom:b,replaceTo:g});c.show();}else{a.replaceRange(d,b,g);}}},afterRender:function(){ECM.CMS.Panel.ContentEditor.Html.superclass.afterRender.call(this);this._addLineWrap();if(!this.config.is_template){if(this.config.templateBasedEditorEnabled){this.templateBasedEditorURL=this.getTemplateBasedEditorURL();this._addTemplateBasedEditorLink();}}},_addLineWrap:function(){if(this.config.contentData.remote_content==1){return undefined;}var c=new Ext.Button({scope:this,text:gt.gettext("Wrap"),cls:"blue_button ",handler:function(){var h=new ECM.CMS.Util.TextWrapper();var f=Ext.getCmp("wraphtmlat").getValue();var g=Ext.getCmp("htmltextarea").getValue();var d=h.wrap(g,f,"html");Ext.getCmp("htmltextarea").setValue(d);this.fireEvent("htmlgenerated",d);}});var b=new Ext.Container({id:"htmlwrap_container",html:gt.gettext('Wrap html at <span id="htmlwrap_num_field"></span> characters'),listeners:{afterrender:function(){var d=new Ext.form.NumberField({xtype:"numberfield",id:"wraphtmlat",allowDecimals:false,value:72,width:30,renderTo:"htmlwrap_num_field"});}}});var a=new Ext.Panel({id:"htmlwrap_panel",border:false,frame:false,cls:(!this.config.is_template&&this.config.templateBasedEditorEnabled)?"htmlwrap_panel_wide":"htmlwrap_panel",renderTo:this.stripWrap,items:[b,c]});},_addTemplateBasedEditorLink:function(){Ext.DomHelper.append(this.stripWrap,{tag:"div",cls:"strip-wrap-right-extension",children:[{tag:"a",cls:"strip-wrap-link",target:"_TEMPLATE_",href:this.templateBasedEditorURL,html:gt.gettext("Template-Based Editor")}]});}});Ext.reg("ecm.htmlcontenteditor",ECM.CMS.Panel.ContentEditor.Html);ECM.provide("ECM.Button.AutoGenerateButton");ECM.Button.AutoGenerateButton=Ext.extend(Ext.SplitButton,{constructor:function(a){if(a.format==="text"){this.buttonText=gt.gettext("Generate from HTML");this.warningMessage=gt.gettext("This will over-write existing text content, do you want to continue?");
this.event="textgenerated";this.fromThisTextArea="htmltextarea";this.toThisTextArea="plaintextarea";this.formatChange="html_to_text";}else{if(a.format==="richText"){this.buttonText=gt.gettext("Generate from Text");this.warningMessage=gt.gettext("This will over-write existing Rich text content, do you want to continue?");this.event="richtextgenerated";this.fromThisTextArea="plaintextarea";this.toThisTextArea="richtextarea";this.formatChange="text_to_aol";}}ECM.Button.AutoGenerateButton.superclass.constructor.apply(this,arguments);},initComponent:function(){var a=this;this.htmlEncoder=new ECM.util.HtmlEncode();this.cls="blue_button";this.text=this.buttonText;this.handler=function(){var c=Ext.getCmp(this.toThisTextArea).getValue();if(c.match(/^\s*$/)){this._generateText();}else{var b=new ECM.Window({title:gt.gettext("Auto Generate Warning"),width:450,height:100,padding:10,modal:true,items:[{html:a.warningMessage}],windowButtons:[{scope:a,text:gt.gettext("Yes"),cls:"blue_button",handler:function(){b.hide();this._generateText();}},{text:gt.gettext("No"),cls:"blue_button",handler:function(){b.hide();}}]});b.show();}};this.menu={items:[{text:gt.gettext("Generate and Overwrite"),cls:"ecm-split-dropdown",scope:this,handler:function(){this._generateText();}}]};ECM.Button.AutoGenerateButton.superclass.initComponent.apply(this,arguments);this.addEvents(this.event);},_generateText:function(){var c=this;if(typeof this.publish=="function"){this.publish("/cms/alert/add",{message:""});}var a=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Generating...")});a.show();var b=Ext.getCmp(this.fromThisTextArea).getValue();var d=Ext.getCmp("htmleditor");if(this.fromThisTextArea==="htmltextarea"&&b&&d.wysiwygEditor.initialized&&d.origContent!=d.wysiwygEditor.getEditorBody().innerHTML){b=this.htmlEncoder.htmlEncode(b);}ECM.Ajax.request({scope:this,url:"/m/service/content",method:"POST",params:{rm:c.formatChange,from:b},success:function(f){var g=f.responseJSON;Ext.getCmp(c.toThisTextArea).setValue(g.data.to);c.fireEvent(c.event,g.data.to);a.hide();},failure:function(f){a.hide();if(f.responseText.match(/Session Timeout/)){this.publish("/cms/error/add",{message:gt.gettext("Session timeout. Please login again.")});}else{this.publish("/cms/error/add",{message:gt.gettext("Failed to generate content. Please try again.")});}}});}});Ext.reg("ecm.autogeneratebutton",ECM.Button.AutoGenerateButton);ECM.provide("ECM.CMS.Util.TextWrapper");ECM.CMS.Util.TextWrapper=Ext.extend(Object,{wrap:function(f,a,d){if(f.length<a){return f;}d=Ext.isDefined(d)?d:"text";var c="";var b=f.split("\n");Ext.each(b,function(g){this.text=g;this.wrap_at=a;this.last_wrap=0;while(this.next_wrap(d)){}c=c+this.text+"\n";},this);c=c.substr(0,c.length-1);return c;},_is_space_within_tags:function(f,d){if(d==="begin"){var c=this.text.substr(0,f);var a=c.match(/%%/g);if(!Ext.isEmpty(a)){return a.length;}}else{if(d==="after"){var g=this.text.substr(f);var b=g.match(/%%/g);if(!Ext.isEmpty(b)){return b.length;}}}},_get_tag_count:function(c){type="begin";var b=this._is_space_within_tags(c,type);type="after";var a=this._is_space_within_tags(c,type);if(b%2>0&&a>0){return false;}else{return true;}},_is_space_at:function(b,a){if(this.text.charAt(b).match(/\s/)){return this._get_tag_count(b);}},_replace_space_with_newline_at:function(f,d){var c;var b;if(d==="text"||this.text.charAt(f).match(/</)){c=this.text.substr(0,f);b=(d==="text")?f+1:f;}else{c=this.text.substr(0,f+1);b=f+1;}var a=this.text.substr(b,this.text.length);if(!Ext.isEmpty(a)&&a!=="\r"){this.text=c+"\n"+a;}},_if_space_wrap_at:function(b,a){if(this._is_space_at(b,a)){this._replace_space_with_newline_at(b,a);this.last_wrap=b+1;return true;}return false;},next_wrap:function(b){var a=(b==="text")?this.last_wrap:this.last_wrap+1;for(var c=this.wrap_at+a;c>=a;c--){if(c>=this.text.length){return false;}if(this._if_space_wrap_at(c,b)){return true;}}for(var c=this.wrap_at+this.last_wrap;c<this.text.length;c++){if(this._if_space_wrap_at(c,b)){return true;}}return false;}});Ext.reg("ecm.textwrapper",ECM.CMS.Util.TextWrapper);ECM.provide("ECM.Toolbar.TextEditorToolbar");ECM.Toolbar.TextEditorToolbar=Ext.extend(Ext.Toolbar,{initComponent:function(){var d=this;var a=new Ext.Container({id:"textwrap_container",html:gt.gettext('Wrap text at <span id="textwrap_num_field"></span> characters'),listeners:{afterrender:function(){var f=new Ext.form.NumberField({xtype:"numberfield",id:"wraptextat",allowDecimals:false,value:72,width:30,renderTo:"textwrap_num_field"});}}});var c=new Ext.Button({scope:this,text:gt.gettext("Wrap"),cls:"blue_button",style:"margin-right:3px",handler:function(){var j=new ECM.CMS.Util.TextWrapper();var g=Ext.getCmp("wraptextat").getValue();var h=Ext.getCmp("plaintextarea").getValue();var f=j.wrap(h,g);Ext.getCmp("plaintextarea").setValue(f);this.fireEvent("textgenerated",f);}});var b=new Ext.Container({id:"texteditor_template_link_container",style:"paddingRight: 10px",hidden:true});this.autoGenerateButton=new ECM.Button.AutoGenerateButton({format:"text",listeners:{textgenerated:function(f){d.fireEvent("textgenerated",f);}}});this.items=["->",a,c,b,this.autoGenerateButton];ECM.Toolbar.TextEditorToolbar.superclass.initComponent.apply(this,arguments);this.addEvents("textgenerated");},addTemplateBasedEditorLink:function(a){Ext.getCmp("texteditor_template_link_container").add(new Ext.Component({html:{tag:"a",cls:"strip-wrap-link",target:"_TEMPLATE_",href:a,html:gt.gettext("Template-Based Editor")}}));Ext.getCmp("texteditor_template_link_container").show();}});Ext.reg("ecm.texteditortoolbar",ECM.Toolbar.TextEditorToolbar);ECM.provide("ECM.CMS.Panel.ContentEditor.Text");ECM.CMS.Panel.ContentEditor.Text=Ext.extend(Ext.Panel,{initComponent:function(){var b=this;var d=new ECM.Panel.EditorRuler();var c=new Ext.form.TextArea({id:"plaintextarea",height:"100%",width:"96%"});var a=new Ext.Panel({id:"plaintextpanel",bodyBorder:false,header:false,height:"100%",items:[d,c]});this.tbar=new ECM.Toolbar.TextEditorToolbar({mid:this.config.mid,cls:"cms_topbar",listeners:{textgenerated:function(f){b.fireEvent("textgenerated",f);}}});this.items=[a];ECM.CMS.Panel.ContentEditor.Text.superclass.initComponent.apply(this,arguments);this.addEvents("textgenerated");},disableGenerateButton:function(){this.topToolbar.autoGenerateButton.disable();},enableGenerateButton:function(){this.topToolbar.autoGenerateButton.enable();},_dropTag:function(a,f,d,b,g){if(f.node.attributes.dcTagSource==="library"){Ext.getCmp("leftnav_panel").checkLibraryTag({tag:d,editorType:a,replaceFrom:b,replaceTo:g});}else{if(d.match(/%%t_fblike_url\(.*\)%%/)){var c=new ECM.CMS.Modal.FBLikeCustomUrl({editorType:a,replaceFrom:b,replaceTo:g});c.show();}else{a.replaceRange(d,b,g);}}},afterRender:function(){var b=this;this.dropTarget=new Ext.dd.DropTarget(Ext.get("texteditor"),{ddGroup:"DCZone",scope:this,copy:false,overClass:"over",notifyOver:function(d,g,h){var f=Ext.getCmp("contentPanelId").textFrame,c=g.getPageX(),j=g.getPageY();f.setCursor(f.coordsChar({x:c,y:j}));},notifyDrop:function(c,g,h){var d=Ext.getCmp("contentPanelId").textFrame,k=d.getCursor(),j=d.getTokenAt(k);var f=Ext.isDefined(h.node.attributes.textContent)?h.node.attributes.textContent:h.node.attributes.content;if(!Ext.isDefined(f)){return false;}if(h.node.attributes.type==="link"&&j.state.base.tagName==="a"&&j.state.baseCur==="ecmtext-attribute"&&j.state.base.attrName==="href"){b._dropTag(d,h,'"'+h.node.attributes.textContent+'"',{line:k.line,ch:j.state.baseStart},{line:k.line,ch:j.state.baseEnd});}else{if(/%%.*%%/.test(j.string)){Ext.Msg.show({title:gt.gettext("Info"),msg:gt.gettext("Replace current tag?"),cls:"blue_button",buttons:Ext.Msg.OKCANCEL,fn:function(l){if(l==="ok"){b._dropTag(d,h,f,{line:k.line,ch:j.start},{line:k.line,ch:j.end});}}});}else{b._dropTag(d,h,f,k,k);}}return true;}});ECM.CMS.Panel.ContentEditor.Text.superclass.afterRender.call(this);if(!this.config.is_template){if(this.config.templateBasedEditorEnabled){var a=this.getTemplateBasedEditorURL();
this.topToolbar.addTemplateBasedEditorLink(a);}}}});Ext.reg("ecm.textcontenteditor",ECM.CMS.Panel.ContentEditor.Text);ECM.provide("ECM.CMS.Panel.ContentEditor.Rtf");ECM.CMS.Panel.ContentEditor.Rtf=Ext.extend(Ext.Panel,{initComponent:function(){var c=this;var g=new ECM.Panel.EditorRuler();var f=new Ext.form.TextArea({id:"richtextarea",height:"100%",width:"96%"});var b=new Ext.Panel({id:"richtextpanel",bodyBorder:false,header:false,height:"100%",items:[f]});this.autoGenerateButton=new ECM.Button.AutoGenerateButton({format:"richText",listeners:{richtextgenerated:function(h){c.fireEvent("richtextgenerated",h,true);}}});var a=new Ext.Container({id:"rteditor_template_link_container",style:"paddingRight: 10px",hidden:true});var d=[{xtype:"tbfill"},this._getTextWrapPanel(),a,this.autoGenerateButton];this.tbar=new Ext.Toolbar({cls:"cms_topbar",items:d});this.items=[b];ECM.CMS.Panel.ContentEditor.Rtf.superclass.initComponent.apply(this,arguments);this.addEvents("richtextgenerated");},disableGenerateButton:function(){this.autoGenerateButton.disable();},enableGenerateButton:function(){this.autoGenerateButton.enable();},_dropTag:function(a,f,d,b,g){if(f.node.attributes.dcTagSource==="library"){Ext.getCmp("leftnav_panel").checkLibraryTag({tag:d,editorType:a,replaceFrom:b,replaceTo:g});}else{if(d.match(/%%t_fblike_url\(.*\)%%/)){var c=new ECM.CMS.Modal.FBLikeCustomUrl({editorType:a,replaceFrom:b,replaceTo:g});c.show();}else{a.replaceRange(d,b,g);}}},afterRender:function(a){var b=this;this.dropTarget=new Ext.dd.DropTarget(Ext.get("richtexteditor"),{ddGroup:"DCZone",copy:false,scope:this,overClass:"over",notifyOver:function(d,g,h){var f=Ext.getCmp("contentPanelId").richTextFrame,c=g.getPageX(),j=g.getPageY();f.setCursor(f.coordsChar({x:c,y:j}));},notifyDrop:function(c,f,g){var d=Ext.getCmp("contentPanelId").richTextFrame,j=d.getCursor(),h=d.getTokenAt(j);if(!Ext.isDefined(g.node.attributes.content)){return false;}if(g.node.attributes.type==="link"&&h.state.base.tagName==="a"&&h.state.baseCur==="ecmtext-attribute"&&h.state.base.attrName==="href"){b._dropTag(d,g,'"'+g.node.attributes.textContent+'"',{line:j.line,ch:h.state.baseStart},{line:j.line,ch:h.state.baseEnd});}else{if(g.node.attributes.type==="image"&&h.state.base.tagName==="img"&&h.state.baseCur==="ecmtext-attribute"&&h.state.base.attrName==="src"){b._dropTag(d,g,'"'+g.node.attributes.textContent+'"',{line:j.line,ch:h.state.baseStart},{line:j.line,ch:h.state.baseEnd});}else{if(/%%.*%%/.test(h.string)){Ext.Msg.show({title:gt.gettext("Info"),msg:gt.gettext("Replace current tag?"),cls:"blue_button",buttons:Ext.Msg.OKCANCEL,fn:function(k){if(k==="ok"){b._dropTag(d,g,g.node.attributes.content,{line:j.line,ch:h.start},{line:j.line,ch:h.end});}}});}else{b._dropTag(d,g,g.node.attributes.content,j,j);}}}return true;}});if(!this.config.is_template){if(this.config.templateBasedEditorEnabled){this.templateBasedEditorURL=this.getTemplateBasedEditorURL();this._addTemplateBasedEditorLink();}}ECM.CMS.Panel.ContentEditor.Rtf.superclass.afterRender.call(this);},_getTextWrapPanel:function(){var b=new Ext.Button({scope:this,text:gt.gettext("Wrap"),style:"margin-right:3px",cls:"blue_button",handler:function(){var g=new ECM.CMS.Util.TextWrapper();var d=Ext.getCmp("wraprtfat").getValue();var f=Ext.getCmp("richtextarea").getValue();var c=g.wrap(f,d,"rtf");Ext.getCmp("richtextarea").setValue(c);this.fireEvent("richtextgenerated",c,false);}});var a=new Ext.Container({id:"richtextwrap_container",html:gt.gettext('Wrap Rich Text at <span id="rtfwrap_num_field"></span> characters'),listeners:{afterrender:function(){var c=new Ext.form.NumberField({xtype:"numberfield",id:"wraprtfat",allowDecimals:false,value:72,width:30,renderTo:"rtfwrap_num_field"});}}});return[a,b];},_addTemplateBasedEditorLink:function(){Ext.getCmp("rteditor_template_link_container").add(new Ext.Component({html:{tag:"a",cls:"strip-wrap-link",target:"_TEMPLATE_",href:this.templateBasedEditorURL,html:gt.gettext("Template-Based Editor")}}));Ext.getCmp("rteditor_template_link_container").show();}});Ext.reg("ecm.rtfcontenteditor",ECM.CMS.Panel.ContentEditor.Rtf);ECM.provide("ECM.CMS.Panel.RemoteHost");ECM.CMS.Panel.RemoteHost=Ext.extend(Ext.Panel,{constructor:function(a){var d;var f;var b=a.format;if(b==="html"){d="HTML";f=a.urlh;}else{if(b==="text"){d="Text";f=a.urlt;}else{if(b==="richtext"){d="Rich Text";f=a.urla;}}}var c=new Ext.form.FormPanel({id:"remote_"+b,style:"padding: 15px",bodyBorder:false,monitorValid:true,monitorPoll:50,layout:"table",padding:0,layoutConfig:{columns:5},height:"100%",width:"100%",items:[{xtype:"container",width:150,html:gt.strargs(gt.gettext("URL for %1 content:"),[d])},{xtype:"textfield",value:f?f:"",layout:"column",id:"urlform_"+b,width:500,allowBlank:false,blankText:gt.gettext("Enter Remote Content URL"),vtype:"url",vtypeText:gt.gettext("The input field should be the URL location in the format of http://www.domain.com/email/content.txt")},{xtype:"spacer",width:10},{xtype:"container",html:gt.gettext("Preview"),style:"color: blue; cursor: pointer; text-decoration: underline;",listeners:{render:function(){this.el.on("click",function(){var g=Ext.getDom("urlform_"+b).value;if(g){window.open(g);}});}}}]});this.items=[c];ECM.CMS.Panel.RemoteHost.superclass.constructor.apply(this,arguments);}});Ext.reg("ecm.remotehost",ECM.CMS.Panel.RemoteHost);ECM.provide("ECM.CMS.Modal.PrependUrl");ECM.CMS.Modal.PrependUrl=Ext.extend(ECM.Window,{title:"Prepend Image URL",cls:"prepend_image_modal",closable:true,closeAction:"hide",width:600,constructor:function(a){if(Ext.isDefined(a.testAid)){this.testAid=a.testAid;delete a.testAid;}if(Ext.isDefined(a.testImgServer)){this.testImgServer=a.testImgServer;delete a.testImgServer;}ECM.CMS.Modal.PrependUrl.superclass.constructor.call(this,a);},initComponent:function(){var d=this;var c=this.getImgServer();var b=this.getRegExp();var a=new Ext.data.JsonStore({fields:["id","name"],data:[{id:"0",name:gt.gettext("to image tags")},{id:"1",name:gt.gettext("replacing this text")}]});this.items=[new Ext.form.FormPanel({labelWidth:220,items:[new Ext.form.TextField({fieldLabel:gt.gettext("In this mailing, prepend this base URL"),anchor:"-10px",width:300,labelStyle:"white-space: nowrap;",id:"prepend_url_value",value:c,allowBlank:false,blankText:"",listeners:{valid:function(){Ext.getCmp("apply_prepend_url").enable();},invalid:function(){Ext.getCmp("apply_prepend_url").disable();}}}),{xtype:"compositefield",hideLabel:true,items:[new Ext.form.ComboBox({hideLabel:true,id:"prepend_img_tags",mode:"local",triggerAction:"all",displayField:"name",valueField:"id",hiddenName:"id",store:a,allowBlank:false,editable:false,listeners:{afterrender:function(f){f.setValue(gt.gettext("to image tags"));},select:function(h){var g=h.getValue();var f=Ext.getCmp("replace_text_value");if(g==1&&f){f.el.dom.style.visibility="visible";}else{f.el.dom.style.visibility="hidden";}}}}),new Ext.form.Field({fieldLabel:"",hideLabel:true,width:200,id:"replace_text_value",allowBlank:false,editable:true,style:"visibility:hidden"})]}]})];this.windowButtons=[{text:gt.gettext("Apply"),id:"apply_prepend_url",handler:function(){var f=false;d.editor.operation(function(){f=d.applyPrependImgURL(d.editor,c,b);});if(f){d[d.closeAction]();}}},{text:gt.gettext("Cancel"),handler:function(){d[d.closeAction]();}}];ECM.CMS.Modal.PrependUrl.superclass.initComponent.apply(this,arguments);},setEditor:function(a){this.editor=a.editor;},show:function(){ECM.CMS.Modal.PrependUrl.superclass.show.apply(this,arguments);if(this.rendered){Ext.getCmp("prepend_url_value").setValue(this.getImgServer());Ext.getCmp("prepend_img_tags").setValue(gt.gettext("to image tags"));var a=Ext.getCmp("replace_text_value");a.el.dom.style.visibility="hidden";a.setValue();}},getImgServer:function(){var a=this.testImgServer||ECM.CMS.imgServer;var b=this.testAid||ECM.CMS.aid;var c=a+"/i/"+b%53+"/"+b;return c;},getRegExp:function(){return new RegExp("(src\\s*=\\s*['\"])([^/\"']+.(?:gif|png|jpe?g|bmp)['\"])","ig");},applyPrependImgURL:function(j,b,o){var g=Ext.getCmp("prepend_img_tags").getValue();
var f=false;if(g==1){f=Ext.getCmp("replace_text_value").getValue().trim();if(!f){this.notify.error(gt.gettext("Please provide a text value."));return false;}}var a=0;var k=Ext.getCmp("prepend_url_value").getValue().trim();var h=k?k:b;var d=f?f:o;var n=j.getSearchCursor(d);while(n.findNext()){j.setSelection(n.from(),n.to());var l=j.getRange(n.from(),n.to());var m=f?l.replace(d,h):l.replace(d,"$1"+h+"/$2");j.replaceRange(m,n.from(),n.to());a++;}if(a>=1){var c=a>1?gt.strargs(gt.gettext("%1 image links updated"),[a]):gt.gettext("1 image link updated");Ext.Msg.show({cls:"blue_button",msg:c,buttons:Ext.Msg.OK,icon:Ext.Msg.INFO});return true;}else{if(a===0){if(f){this.notify.error(gt.gettext("Text does not exist in content. Please re-enter text"));}else{this.notify.error(gt.gettext("No images to prepend found in mailing content"));}return false;}}}});ECM.provide("ECM.CMS.Panel.Content");ECM.CMS.Panel.Content=Ext.extend(ECM.CMS.MediatorInterface,{constructor:function(a){a.contentChanged=false;a.extjseditorChange=false;this._panel=new ECM.CMS.Panel.ContentPanel(a);Ext.apply(this,a);var c=this;if(Ext.isDefined(Ext.getCmp("leftnav_emo"))){Ext.getCmp("leftnav_emo").hide();}if(!a.skip_load){var b=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Loading content...")});b.show();ECM.Ajax.request({url:"/cm/mailing/content/get_content",method:"POST",params:{mid:a.mid,desired_aid:a.desired_aid,mfid:a.mfid,mtype:a.mtype,json:1},success:function(f){var d=f.responseJSON;if(d.authorization_errors.length<1&&d.authentication_error<1&&d.application_errors.length<1&&d.error.length<1){c.load(d.data);b.hide();}else{c.publish("/cms/error/add",{message:gt.gettext("Could not load data. Please try again.")});b.hide();}Ext.getCmp("cmsShell").resetMailingNavPanelWidth();},failure:function(d){c.publish("/cms/error/add",{message:gt.gettext("Could not load data. Please try again.")});b.hide();}});}ECM.CMS.Panel.Content.superclass.constructor.call(this,a);},load:function(a){this._panel.populate(a);ECM.FeatureHelp.showAllTooltips();},save:function(a){this._panel.save(a);},refresh:function(){this._panel.refresh();},getExtContainer:function(){return this._panel;},wasModified:function(){if(!this._panel.isRemoteContent){return(this._panel.contentChanged||(Ext.isDefined(Ext.getCmp("extjseditor"))&&(Ext.getCmp("extjseditor").originalValue!=Ext.getCmp("extjseditor").getValue())));}else{if((Ext.isDefined(Ext.getCmp("urlform_html"))&&Ext.getCmp("urlform_html").isDirty())||(Ext.isDefined(Ext.getCmp("urlform_text"))&&Ext.getCmp("urlform_text").isDirty())||(Ext.isDefined(Ext.getCmp("urlform_richtext"))&&Ext.getCmp("urlform_richtext").isDirty())){return true;}else{return false;}}}});ECM.CMS.Panel.ContentPanel=Ext.extend(Ext.TabPanel,{id:"contentPanelId",height:ECM.CMS.STANDARD_PANEL_HEIGHT||600,constructor:function(a){var b=this;this.canHideSearchAndReplace=true;Ext.apply(this,a);a=Ext.apply({save:function(c){if(this.isRemoteContent){this._saveRemoteContent(a,c);if(Ext.isDefined(Ext.getCmp("urlform_html"))){Ext.getCmp("urlform_html").originalValue=Ext.getCmp("urlform_html").getValue();}if(Ext.isDefined(Ext.getCmp("urlform_text"))){Ext.getCmp("urlform_text").originalValue=Ext.getCmp("urlform_text").getValue();}if(Ext.isDefined(Ext.getCmp("urlform_richtext"))){Ext.getCmp("urlform_richtext").originalValue=Ext.getCmp("urlform_richtext").getValue();}}else{this._saveMailingContent(a,c);}},showSearchAndReplace:function(){ECM.CMS.getActiveEditor(this);var c=this.getActiveTab();if(c.id!=="htmleditor"||c.getActiveTab().id!=="extjseditor"){ECM.CMS.showSearchAndReplaceModal();}},listeners:{render:function(){b.searchReplaceButton=new Ext.SplitButton({text:gt.gettext("Search and Replace"),id:"search_and_replace_button",cls:"blue_button tab_bar_element",handler:function(d,c){ECM.CMS.getActiveEditor(b);ECM.CMS.showSearchAndReplaceModal();},arrowHandler:function(c){this.menu.setWidth(c.getWidth());},menu:{items:[{text:gt.gettext("Prepend Image URL"),cls:"ecm-split-dropdown",handler:function(){var c={editor:b.htmlFrame};if(!ECM.ModalMgr.exists("prependModal")){var d=new ECM.CMS.Modal.PrependUrl(c);ECM.ModalMgr.registerModal("prependModal",d);}else{ECM.ModalMgr.getModal("prependModal").setEditor(c);}ECM.ModalMgr.showModal("prependModal");}}]}});b.saveContentButton=new Ext.Button({text:gt.gettext("Save Content"),cls:"blue_button tab_bar_element",handler:function(){b.save();}});b.buttonsPanel=new Ext.Panel({border:false,frame:false,style:"position:absolute; top:1px; right:0",bodyStyle:"background:transparent",items:[b.saveContentButton,b.searchReplaceButton]});b.buttonsPanel.render(this.stripWrap);Ext.getCmp("cmsShell").resizeContainerHeight(undefined,true);b.subscribe("/cms/leave_tab",function(){var c=ECM.Form.DCEditor.data("DC");var d=Ext.getCmp("leftnav_panel");Ext.iterate(d.libTags,function(f,g){delete c[0][f];});d.libTags={};d.dcLibOverwrite=[];b.removeSubscribers("/cms/leave_tab");});},tabchange:function(h,g){var c=(g.contentData&&g.contentData.use_templates&&g.contentData.use_templates.toLowerCase()==="no");if(!h.is_template&&(h.workflow_wizard||c)){var j;this.workflow=Ext.getCmp("cmsWizardWorkflow");this.workflow.turnOn();var f=(!this.isRemoteContent&&Ext.isDefined(g.contentData))?g.contentData.format_include:g.format_include;switch(g.id){case"htmleditor":j="html";break;case"texteditor":j="text";break;case"richtexteditor":j="richtext";break;}this.workflow.setCurrentPage({pageName:j,mailingConfig:f,showGenerateTemplate:c,hideWizard:(h.workflow_wizard===1)?false:true});}if(!this.isRemoteContent){if(g.id==="htmleditor"){Ext.getCmp("extjseditor").pushValue();if(g.layout.activeItem.id==="extjseditor"){Ext.getCmp("search_and_replace_button").disable();if(ECM.CMS.Modal.SearchAndReplaceModal){ECM.CMS.Modal.SearchAndReplaceModal.hide();}}Ext.fly("search_and_replace_button").removeClass("cm_remove_icon");}else{var d=Ext.get("search_and_replace_button");if(!d.hasClass("cm_remove_icon")){d.addClass("cm_remove_icon");}Ext.getCmp("search_and_replace_button").enable();}}else{Ext.getCmp("cmsShell").resizeContainerHeight(undefined,true);}}}},a);ECM.CMS.Panel.ContentPanel.superclass.constructor.call(this,a);this.addEvents("addededitorpanels");},populate:function(b){var a=this;this.contentData=b;this.editorHeight=[];a.templateBasedEditorEnabled=b.use_templates&&b.use_templates==="no";if(b.remote_content!=1&&(b.format_include===undefined||(b.format_include.html==0&&b.format_include.text==0&&b.format_include.rich_text==0))){this.publish("/cms/error/add",{message:gt.gettext("No formats were selected.")});return;}if(b.remote_content==1){this.searchReplaceButton.destroy();this._tabsRemoteContent(b);ECM.Flare.updateLink("FLARE_CONTENT_REMOTEHOST");}else{Ext.getCmp("contentPanelId").add(this._getTabsContentPage(b));this.generateTextDisabled=false;this.generateRichTextDisabled=false;this.dataDynamicContent=b.dynamic_content.in_mailing;this.dataPersonalization=b.pers_keys;this.activateTab=this.tab;var c=b.tmpl.html;this.parserConfigObj={p13n:this.dataPersonalization,dc:this.dataDynamicContent,mid:this.mid,mfid:this.mfid,desiredAid:this.desired_aid,mtype:this.mtype,processXML:false};this.availableTabs={richtext:{name:"richtexteditor",panelArea:"richtextarea",codemirror:"richTextFrame",enabled:(b.format_include.rich_text==1),content:b.tmpl.rich_text,generateFromDisabled:0,parseXML:false},text:{name:"texteditor",panelArea:"plaintextarea",codemirror:"textFrame",enabled:(b.format_include.text==1),content:b.tmpl.text,generateFromDisabled:(b.format_include.text==0&&b.format_include.rich_text==1),parseXML:false},html:{name:"htmleditor",panelArea:"htmltextarea",codemirror:"htmlFrame",enabled:(b.format_include.html==1),content:c,generateFromDisabled:(b.format_include.html==0&&b.format_include.text==1),parseXML:true}};a.removeSubscribers("cms/load/content/tab");a.subscribe("cms/load/content/tab",function(d){var f=a.availableTabs[d];Ext.getCmp(f.panelArea).setValue(f.content);Ext.getCmp(f.name).enable();a.setActiveTab(f.name);});
Ext.iterate(this.availableTabs,function(d,f){if(f.generateFromDisabled){if(d==="text"){Ext.getCmp("richtexteditor").disableGenerateButton();}else{if(d==="html"){Ext.getCmp("texteditor").disableGenerateButton();}}}if(f.enabled){a.publish("cms/load/content/tab",d);a._generateCodeMirrorFrame(f.codemirror,f.panelArea,a.parserConfigObj,f.parseXML);if(d==="html"&&b.use_templates&&b.use_templates==="editor"){Ext.getCmp(f.name).setActiveTab("extjseditor");}a.fireEvent("addededitorpanels",a,a.getComponent("texteditor")||"",a.getComponent("richtexteditor")||"",a.getComponent("htmleditor")||"");}});if(this.activateTab){setTimeout(function(){a.setActiveTab(a.availableTabs[a.activateTab].name);},300);}a._adjustEditorHeight();a.fireEvent("contentReady");if(Ext.getCmp("leftnav_panel").openUploadFlyout){setTimeout(function(){Ext.getCmp("leftnav_panel")._openUploadContent();},1000);}}},setHTMLContent:function(a){return this.setContent("html",a);},setTextContent:function(a){return this.setContent("text",a);},setRichTextContent:function(a){return this.setContent("rtf",a);},setContent:function(d,g){if(this.isRemoteContent){return false;}var f=Ext.getCmp("extjseditor"),c=this.htmlFrame,b=this.textFrame,a=this.richTextFrame;if(d==="html"){if(f&&c){f.setValue(g);c.setValue(g);return true;}}else{if(d==="text"){if(b){b.setValue(g);return true;}}else{if(d==="rtf"){if(a){a.setValue(g);return true;}}else{throw Error(gt.gettext("Invalid content type setting attempted"));}}}return false;},_toggleGenerateButton:function(d,c,b){d=Ext.getCmp(d);if(Ext.isDefined(d)){var a=d.getValue();if(Ext.isDefined(a)){if(a.match(/^(\s*|<html><body>((<BR>)*<P>(<BR>)*&nbsp;(<BR>)*<\/P>(<BR>)*|(<BR>)*)<\/body><\/html>)$/i)){Ext.getCmp(c).disableGenerateButton();this[b]=true;}else{if(this[b]){Ext.getCmp(c).enableGenerateButton();this[b]=false;}}}}},_generateCodeMirrorFrame:function(d,f,c,a){var b=this;c.processXML=a;this[d]=CodeMirror.fromTextArea(document.getElementById(f),{mode:{name:"dcP13n",htmlMode:true,dcP13n:c,mtype:b.mtype},lineNumbers:true,disable:this.role=="MAILING_PRODUCER"?{personalization:false,dynamicContent:true}:{personalization:false,dynamicContent:false},onChange:function(){if(Ext.isDefined(b[d])){var g=b[d].getValue();Ext.getCmp(f).setValue(g);if(!b.extjseditorChange){b.contentChanged=true;}else{b.extjseditorChange=false;}}},onFocus:function(){if(f==="htmltextarea"){ECM.Flare.updateLink("FLARE_CONTENT_HTML");}else{if(f==="richtextarea"){ECM.Flare.updateLink("FLARE_CONTENT_RICHTEXT");}else{if(f==="plaintextarea"){ECM.Flare.updateLink("FLARE_CONTENT_TEXT");}}}}});},_generateTemplateBasedEditorURL:function(b){var a=["/cgi-bin/mailers/mailings/content.cgi",[["aid",this.desired_aid].join("="),["mfid",this.mfid].join("="),["mid",this.mid].join("="),["appimght",this.appimght].join("="),["img_upload","true"].join("="),["mtype",this.mtype].join("="),["desired_aid",this.desired_aid].join("="),["eid",this.eid].join("="),["smtmpl_fmt",b].join("=")].join("&")].join("?");return a;},_getTabsContentPage:function(a){var f=this;var d={title:gt.gettext("HTML"),xtype:"ecm.htmlcontenteditor",config:this,contentData:a,name:"htmleditor",id:"htmleditor",disabled:true,closable:false,justInit:true,getTemplateBasedEditorURL:function(){return f._generateTemplateBasedEditorURL("html");},listeners:{activate:function(){var h=ECM.CMS.Modal.SearchAndReplaceModal;if(Ext.isDefined(h)&&!h.hidden){ECM.CMS.getActiveEditor(f);}setTimeout(function(){f.htmlFrame.refresh();if(Ext.isIE){var j=document.getElementById("htmltextarea");j.nextSibling.style.width=764;}},500);ECM.Flare.updateLink("FLARE_CONTENT_HTML");setTimeout(function(){var j=Ext.getCmp("contentPanelId");if(Ext.isDefined(j)){j.setHeight(ECM.CMS.STANDARD_PANEL_HEIGHT);}},500);f._setEditorHeight("source");},extjseditorinput:function(h){var j=f.htmlFrame;f.extjseditorChange=true;if(Ext.isDefined(j)){j.setValue(h);}},searchandreplacebutton:function(h){if(h==="source"&&Ext.isDefined(f.htmlFrame)){f.htmlFrame.refresh();}if(h==="htmleditor"){Ext.getCmp("search_and_replace_button").disable();if(ECM.CMS.Modal.SearchAndReplaceModal&&f.canHideSearchAndReplace){ECM.CMS.Modal.SearchAndReplaceModal.hide();}}else{Ext.getCmp("search_and_replace_button").enable();}},htmlgenerated:function(h){f.htmlFrame.setValue(h);}}};var g={title:gt.gettext("Text"),xtype:"ecm.textcontenteditor",config:this,contentData:a,name:"texteditor",id:"texteditor",disabled:true,closable:false,getTemplateBasedEditorURL:function(){return f._generateTemplateBasedEditorURL("text");},listeners:{textgenerated:function(h){f.textFrame.setValue(h);},activate:function(){var h=ECM.CMS.Modal.SearchAndReplaceModal;if(Ext.isDefined(h)&&!h.hidden){ECM.CMS.getActiveEditor(f);}f._toggleGenerateButton("htmltextarea","texteditor","generateTextDisabled");setTimeout(function(){f.textFrame.refresh();if(Ext.isIE){var j=document.getElementById("plaintextarea");j.nextSibling.style.width=764;}},500);ECM.Flare.updateLink("FLARE_CONTENT_TEXT");Ext.getCmp("contentPanelId").doLayout();f._setEditorHeight("plaintextpanel");}}};var c={title:gt.gettext("Rich Text"),xtype:"ecm.rtfcontenteditor",config:this,contentData:a,name:"richtexteditor",id:"richtexteditor",disabled:true,closable:false,getTemplateBasedEditorURL:function(){return f._generateTemplateBasedEditorURL("aol");},listeners:{richtextgenerated:function(h,k){var j=h;if(k){j="<html><body>\n"+j+"\n</body></html>";}f.richTextFrame.setValue(j);},activate:function(){var h=ECM.CMS.Modal.SearchAndReplaceModal;if(Ext.isDefined(h)&&!h.hidden){ECM.CMS.getActiveEditor(f);}f._toggleGenerateButton("plaintextarea","richtexteditor","generateRichTextDisabled");setTimeout(function(){f.richTextFrame.refresh();if(Ext.isIE){var j=document.getElementById("richtextarea");j.nextSibling.style.width=764;}},500);ECM.Flare.updateLink("FLARE_CONTENT_RICHTEXT");Ext.getCmp("contentPanelId").doLayout();f._setEditorHeight("richtextpanel");}}};var b=[];if(a.format_include.html==1){b.push(d);}if(a.format_include.text==1){b.push(g);}if(a.format_include.rich_text==1){b.push(c);}return b;},_tabsRemoteContent:function(f){var a=this;this.isRemoteContent=(f.remote_content==1);var d={title:gt.gettext("HTML"),xtype:"ecm.remotehost",name:"htmleditor",id:"htmleditor",closable:false,format:"html",format_include:f.format_include,workflow_wizard:a.workflow_wizard,urlh:f.urlh,listeners:{activate:function(){Ext.getCmp("contentPanelId").doLayout();}}};var g={title:gt.gettext("Text"),xtype:"ecm.remotehost",name:"texteditor",id:"texteditor",closable:false,format:"text",format_include:f.format_include,workflow_wizard:a.workflow_wizard,urlt:f.urlt,listeners:{activate:function(){Ext.getCmp("contentPanelId").doLayout();}}};var b={title:gt.gettext("Rich Text"),xtype:"ecm.remotehost",name:"richtexteditor",id:"richtexteditor",closable:false,format:"richtext",format_include:f.format_include,workflow_wizard:a.workflow_wizard,urla:f.urla,listeners:{activate:function(){Ext.getCmp("contentPanelId").doLayout();}}};var c=[];c.push(d);c.push(g);c.push(b);Ext.getCmp("contentPanelId").add(c);this.activateTab=this.tab;this.availableTabs={richtext:{name:"richtexteditor",enabled:true},text:{name:"texteditor",enabled:true},html:{name:"htmleditor",enabled:true}};a.removeSubscribers("cms/load/content/tab");a.subscribe("cms/load/content/tab",function(h){var j=a.availableTabs[h];Ext.getCmp(j.name).enable();setTimeout(function(){a.setActiveTab(j.name);},100);});Ext.iterate(this.availableTabs,function(h,j){if(j.enabled){a.publish("cms/load/content/tab",h);}});},_setEditorHeight:function(b){var c=this;var a=parseInt(Ext.get(b).dom.parentNode.style.height);if(b==="plaintextpanel"){a-=15;}c.editorHeight[b]=a;},_adjustEditorHeight:function(){var b=this;var a=["source","plaintextpanel","richtextpanel"];Ext.each(a,function(c){if(Ext.isDefined(Ext.getCmp(c))){Ext.getCmp("cmsShell").resizeContainerHeight();Ext.query(".CodeMirror",c)[0].style.height=b.editorHeight[c]+"px";Ext.query(".CodeMirror-gutter",c)[0].style.height=b.editorHeight[c]+"px";}});},_switchSourceHtmlEditor:function(b){if(b==1){this.canHideSearchAndReplace=false;
var c=Ext.getCmp("contentPanelId").getActiveTab().getId();var a=Ext.getCmp("htmleditor").getActiveTab().getId();Ext.getCmp("htmleditor").setActiveTab("extjseditor");Ext.getCmp("htmleditor").setActiveTab("source");Ext.getCmp("htmleditor").setActiveTab("extjseditor");if(c==="htmleditor"){Ext.getCmp("htmleditor").setActiveTab(a);}else{Ext.getCmp("htmleditor").setActiveTab(a);Ext.getCmp("contentPanelId").setActiveTab(c);Ext.getCmp("search_and_replace_button").enable();}}this.canHideSearchAndReplace=true;},_saveMailingContent:function(a,h){var d=this;var c=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Saving...")});c.show();var b=this.contentData.format_include;d._switchSourceHtmlEditor(b.html);var g={mid:a.mid,desired_aid:a.desired_aid};var f=Ext.getCmp("leftnav_panel");if(f.dcLibOverwrite.length){g.dclib_overwrite=ECM.Adapter.encode(f.dcLibOverwrite);}g.tmpl_html=(b.html==1)?this.htmlFrame.getValue():"";g.tmpl_text=(b.text==1)?this.textFrame.getValue():"";g.tmpl_aol=(b.rich_text==1)?this.richTextFrame.getValue():"";ECM.Ajax.request({method:"POST",url:"/cm/mailing/content/save_template",params:g,success:function(k){var j=k.responseJSON;if(j.data.save_success){var o=j.data.save_success;if(!Ext.isEmpty(j.data.warning)){o+='; <span class="ecm-error">'+j.data.warning+"</span>";}d.publish("/cms/alert/add",{message:o,area:"Content"});if(f.dcLibOverwrite.length){f.dcLibOverwrite=[];f.libTags={};f.resetCodeMirror(j.data.dynamic_content.in_mailing);d.dataDynamicContent=j.data.dynamic_content.in_mailing;if(j.data.dclib_overwrite==="true"){var m=Ext.getCmp("leftnav_dc");if(Ext.isDefined(m)){if(Ext.isDefined(m.tree)){m.resetCodeMirror=false;m.refreshTree();}else{if(!m.newDcTree.hidden){m.resetCodeMirror=false;m.loadTreeData();}else{m.loadTreeData(false);}}}}}if(j.data.unapproved_message!==undefined){d.publish("/cms/alert/add",{message:j.data.save_success+'. <span class="ecm-error">'+j.data.unapproved_message+"</span>"});ECM.publish("/cms/updateMailingTitle",{mailing_name:j.data.name,mailing_status:gt.gettext("(Not Approved)")});}var l=["html","rich_text","text"];Ext.each(l,function(q){var p=(q==="rich_text")?"richTextFrame":q+"Frame";if(j.data.format_include[q]==1){d[p].setValue(j.data.tmpl[q]);}});d._switchSourceHtmlEditor(b.html);d.contentChanged=false;var n=Ext.getCmp("extjseditor");if(Ext.isDefined(n)){n.originalValue=n.getValue();}}else{d.publish("/cms/error/add",{message:gt.gettext("Failed to save content. Please try again.")});}c.hide();if(h==="text"){d.publish("cms/load/content/tab","text");}else{if(h==="checklist"){d.publish("/cms/load/checklist");}}},failure:function(j){var k=j.responseJSON;c.hide();if(Ext.isDefined(k)&&k.application_errors.length>0){var l=k.application_errors;l.push(gt.gettext("Content Saved"));d.publish("/cms/error/add",{message:l});}else{d.publish("/cms/error/add",{message:gt.gettext("Failed to save content. Please try again.")});}}});},_saveRemoteContent:function(a,j){var f=this;var c=this.contentData.format_include;var h=Ext.getCmp("urlform_html").getValue();var g=Ext.getCmp("urlform_text").getValue();var b=Ext.getCmp("urlform_richtext").getValue();var d=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Saving...")});d.show();ECM.Ajax.request({method:"POST",url:"/cm/mailing/content/save_remotehost_content",params:{mid:a.mid,desired_aid:a.desired_aid,urlt:g,urla:b,urlh:h},success:function(l){var k=l.responseJSON;if(k.data.save_success){f.publish("/cms/alert/add",{message:k.data.save_success,area:"Content"});}else{f.publish("/cms/error/add",{message:gt.gettext("Failed to save content. Please try again.")});}d.hide();if(j==="text"){f.publish("cms/load/content/tab","text");}else{if(j==="checklist"){f.publish("/cms/load/checklist");}}},failure:function(k){d.hide();f.publish("/cms/error/add",{message:gt.gettext("Failed to save content. Please try again.")});}});},getCodeMirrorActiveEditor:function(){var a=this.getActiveTab().id;if(a==="htmleditor"){return this.htmlFrame;}else{if(a==="texteditor"){return this.textFrame;}else{if(a==="richtexteditor"){return this.richTextFrame;}else{return false;}}}},getActiveEditor:function(b){var a=this.getActiveTab().id;if(a==="htmleditor"){return"html";}else{if(a==="texteditor"){return"text";}else{if(a==="richtexteditor"){return(b)?"aol":"richtext";}else{return"html";}}}},resetCodeMirror:function(a){var b=this;this.parserConfigObj.dc=a;Ext.iterate(this.availableTabs,function(c,d){if(d.enabled){b.parserConfigObj.processXML=d.parseXML;b[d.codemirror].setOption("mode",{name:"dcP13n",htmlMode:true,dcP13n:b.parserConfigObj,mtype:b.mtype});b[d.codemirror].refresh();}});}});Ext.namespace("ECM.CMS.Panel.SocialMedia");ECM.provide("ECM.CMS.Panel.SocialMedia");function applyRevalidateEvent(a){a.addEvents("revalidate");a.on("revalidate",function(b){this.allowBlank=b.allowBlank;this.validateValue(this.getValue());this.setValue(this.getValue());},a);}ECM.CMS.Panel.SocialMedia.updateCharacters=function(){var a=this.contentEditor;var c=this.getValue();if(this.stripNewlines&&c.indexOf("\n")!=-1){c=c.replace(/[\n\r]+/,"");this.setValue(c);}if(a.maxPostCharacters-c.length<0){c=c.substring(0,a.maxPostCharacters);this.setValue(c);}var b=a.maxPostCharacters-c.length;a.charactersRemaining.setText(b.toString());};ECM.CMS.Panel.SocialMedia.Mediator=Ext.extend(ECM.CMS.MediatorInterface,{constructor:function(a){this.mid=a.mid;this._widget=new ECM.CMS.Panel.SocialMedia.Panel(this.mid,a.containerConfig);ECM.CMS.Panel.SocialMedia.Mediator.superclass.constructor.call(this);},load:function(){var b=this;if(Ext.isDefined(Ext.getCmp("leftnav_emo"))){Ext.getCmp("leftnav_emo").hide();}var a=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Loading...")});a.show();ECM.Ajax.request({url:"/cm/mailing/socialmedia/get_social_media",params:{mid:this.mid},success:function(d){var c=Ext.decode(d.responseText);b._widget.populate(c.data);a.hide();Ext.getCmp("cmsShell").resetMailingNavPanelWidth();ECM.FeatureHelp.showAllTooltips();}});},save:function(){var c=this;if(c._widget.saveButton.disabled){return;}ECM.CMS.Panel.SocialMedia.currentTab=c._widget.getActiveTab().id;if(c._widget.isValid()){var a=this._widget.serialize();var b=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Saving ...")});c._widget.saveButton.disable();b.show();ECM.Ajax.request({url:"/cm/mailing/socialmedia/save_social_media",params:{services:Ext.encode(a),mid:this.mid},success:function(g){var f=Ext.decode(g.responseText);b.hide();if(f.data.saved){var d=gt.strargs(gt.gettext("Social Media saved: %1"),f.data.datetime);if(f.data.unapproved_message){d+='&nbsp;&nbsp;<span class="ecm-error">'+f.data.unapproved_message+"</span>";ECM.publish("/cms/updateMailingTitle",{mailing_name:f.data.mailing_name,mailing_status:gt.gettext("(Not Approved)")});}c.publish("/cms/alert/add",{message:d});c._widget.clearDirty();c.publish("/cms/load/socialmedia");}},failure:function(f){var d=Ext.decode(f.responseText);b.hide();c._widget.saveButton.enable();if(d.application_errors.length){c.showErrorMsgBox(gt.gettext("Save Error"),d.application_errors);c.publish("/cms/changeSocialMediaTab",{service:d.data.service_for_first_error});}}});}},showErrorMsgBox:function(f,c){var d="";for(var a=0;a<c.length;a++){d+=c[a]+"</br>";}var b=new ECM.Window({id:"socialMediaErrorMsgBox",title:f,width:575,height:250,bodyStyle:{padding:"10px"},cls:"cm_text_align_left",items:[{xtype:"spacer",style:{padding:"5px"},width:560,html:d},{xtype:"container",style:{padding:"10px"},width:560,height:50,layout:"column",items:[{xtype:"spacer",width:440,height:10},{xtype:"button",text:gt.gettext("Close"),width:80,cls:"blue_button",handler:function(){var g=Ext.getCmp("socialMediaErrorMsgBox");Ext.destroy(g);}}]}]});b.show();},refresh:function(){this._widget.refresh();},getExtContainer:function(){var a=this._widget;return a;},wasModified:function(){return this._widget.contentChanged();}});ECM.CMS.Panel.SocialMedia.Panel=Ext.extend(Ext.TabPanel,{id:"socialMediaPanelId",autoHeight:true,height:900,constructor:function(d,c){this._twitter=new ECM.CMS.Panel.SocialMedia.Twitter({mid:d});
this._facebook=new ECM.CMS.Panel.SocialMedia.Facebook({mid:d});this._blogger=new ECM.CMS.Panel.SocialMedia.Blogger({mid:d});this._wordpress=new ECM.CMS.Panel.SocialMedia.Wordpress({mid:d});this.startTab=c.startTab;c=Ext.apply({activeTab:0,bodyStyle:Ext.isIE?"":"overflow:auto;overflow-x:hidden",defaults:{bodyStyle:"padding:10px;"},enableTabScroll:true,layoutOnTabChange:true,items:[this._twitter,this._facebook,this._blogger,this._wordpress],listeners:{tabchange:function(){Ext.getCmp("cmsShell").resizeContainerHeight();},render:function(){this.saveButton=new Ext.Button({text:gt.gettext("Save Social Media"),cls:"blue_button tab_bar_element",disabled:true,handler:function(g){this.publish("/cms/save");}});this.buttonsPanel=new Ext.Panel({border:false,frame:false,style:"position:absolute; top:1px; right:0",bodyStyle:"background:transparent",items:[this.saveButton]});this.buttonsPanel.render(this.stripWrap);}}},c);ECM.CMS.Panel.SocialMedia.Panel.superclass.constructor.call(this,c);var b=new ECM.Config.FeatureHelp.CMS();ECM.FeatureHelp.setFeatureHelp(b);this.subscribe("/cms/leave_tab",function(){ECM.FeatureHelp.hideAllTooltips();});var f=Ext.getCmp("cmsWizardWorkflow");if(Ext.isDefined(f)){f.turnOff();}var a=this;a.subscribe("/cms/changeSocialMediaTab",function(g){if(g&&g.service){a.setActiveTab("socialMedia-"+g.service);}});},setActiveTab:function(c){ECM.CMS.Panel.SocialMedia.Panel.superclass.setActiveTab.call(this,c);var b;if(Ext.isString(c)){b=c;}else{if(Ext.isObject(c)&&c.id){b=c.id;}}var a={"socialMedia-TW":"FLARE_SOCIAL_MEDIA_CONTENT","socialMedia-FB":"FLARE_SOCIAL_MEDIA_CONTENT","socialMedia-BL":"FLARE_SOCIAL_MEDIA_CONTENT","socialMedia-WP":"FLARE_SOCIAL_MEDIA_CONTENT"}[b];ECM.Flare.updateLink(a);},populate:function(a){this._twitter.populate(a.services.TW);this._facebook.populate(a.services.FB);this._blogger.populate(a.services.BL);this._wordpress.populate(a.services.WP);this.setActiveTab("socialMedia-FB");this.setActiveTab("socialMedia-BL");this.setActiveTab("socialMedia-WP");this.setActiveTab("socialMedia-TW");if(ECM.CMS.Panel.SocialMedia.currentTab){this.setActiveTab(ECM.CMS.Panel.SocialMedia.currentTab);}else{if(this.startTab in a.services){this.setActiveTab("socialMedia-"+this.startTab);}}this.saveButton.enable();},clearDirty:function(){this._twitter.clearDirty();this._facebook.clearDirty();this._blogger.clearDirty();this._wordpress.clearDirty();},isValid:function(){var f=this;var c=["TW","FB","BL","WP"];for(var b=0;b<c.length;b++){var a=c[b];var d=f.get("socialMedia-"+a);if(!d.getForm().isValid()){this.setActiveTab("socialMedia-"+a);f.publish("/cms/error/add",{message:gt.gettext("Cannot save Social Media. Correct errors indicated below")});return false;}}return true;},serialize:function(){var a={};a.TW=this._twitter.serialize();a.FB=this._facebook.serialize();a.BL=this._blogger.serialize();a.WP=this._wordpress.serialize();return a;},contentChanged:function(){var a=false;if(this._twitter.contentChanged()||this._facebook.contentChanged()||this._blogger.contentChanged()||this._wordpress.contentChanged()){a=true;}return a;}});ECM.CMS.Panel.SocialMedia.Facebook=Ext.extend(Ext.form.FormPanel,{constructor:function(a){this.mid=a.mid;this._accountConfig=new ECM.CMS.Panel.SocialMedia.AccountConfig();this._contentEditor=new ECM.CMS.Panel.SocialMedia.FacebookContentEditor();a=Ext.apply({title:gt.gettext("Facebook"),autoScroll:true,id:"socialMedia-FB",closable:false,xtype:"form",cls:"social_media_tab",items:[this._accountConfig,this._contentEditor]});ECM.CMS.Panel.SocialMedia.Facebook.superclass.constructor.call(this,a);},populate:function(a){this._accountConfig.populate(this.mid,a);this._contentEditor.populate(this.mid,a);},serialize:function(){var a=this.getForm().getValues();var b=this.getForm().getFieldValues();a.mailing_image_url=b.mailing_image_url;a.new_image_url=b.new_image_url;return a;},contentChanged:function(){return this.getForm().isDirty();},clearDirty:function(){this.getForm().trackRecordOnLoad=true;this.getForm().items.each(function(a){a.originalValue=a.getValue();});}});ECM.CMS.Panel.SocialMedia.Twitter=Ext.extend(Ext.form.FormPanel,{constructor:function(a){this.mid=a.mid;this._accountConfig=new ECM.CMS.Panel.SocialMedia.AccountConfig();this._twitterContentEditor=new ECM.CMS.Panel.SocialMedia.TwitterContentEditor({servicePrefix:"tw"});a=Ext.apply({title:gt.gettext("Twitter"),id:"socialMedia-TW",closable:false,cls:"social_media_tab",xtype:"form",items:[this._accountConfig,this._twitterContentEditor]});ECM.CMS.Panel.SocialMedia.Twitter.superclass.constructor.call(this,a);},populate:function(a){this._accountConfig.populate(this.mid,a);this._twitterContentEditor.populate(this.mid,a);},serialize:function(){return this.getForm().getValues();},contentChanged:function(){return this.getForm().isDirty();},clearDirty:function(){this.getForm().trackRecordOnLoad=true;this.getForm().items.each(function(a){a.originalValue=a.getValue();});}});ECM.CMS.Panel.SocialMedia.Blogger=Ext.extend(Ext.form.FormPanel,{constructor:function(a){this.mid=a.mid;this._accountConfig=new ECM.CMS.Panel.SocialMedia.AccountConfig();this._blogContentEditor=new ECM.CMS.Panel.SocialMedia.BlogContentEditor({servicePrefix:"bl"});a=Ext.apply({title:gt.gettext("Blogger"),id:"socialMedia-BL",closable:false,cls:"social_media_tab",xtype:"form",items:[this._accountConfig,this._blogContentEditor]});ECM.CMS.Panel.SocialMedia.Blogger.superclass.constructor.call(this,a);},populate:function(a){this._accountConfig.populate(this.mid,a);this._blogContentEditor.populate(this.mid,a);this.on("activate",function(){this._blogContentEditor.onActivate();});},serialize:function(){var a=this.getForm().getValues();if(a.type!="new"){a.include_link=0;}return a;},contentChanged:function(){return this.getForm().isDirty();},clearDirty:function(){this.getForm().trackRecordOnLoad=true;this.getForm().items.each(function(a){a.originalValue=a.getValue();});}});ECM.CMS.Panel.SocialMedia.Wordpress=Ext.extend(Ext.form.FormPanel,{constructor:function(a){this.mid=a.mid;this._accountConfig=new ECM.CMS.Panel.SocialMedia.AccountConfig();this._blogContentEditor=new ECM.CMS.Panel.SocialMedia.BlogContentEditor({servicePrefix:"wp"});a=Ext.apply({title:gt.gettext("Wordpress"),id:"socialMedia-WP",closable:false,cls:"social_media_tab",xtype:"form",items:[this._accountConfig,this._blogContentEditor]});ECM.CMS.Panel.SocialMedia.Wordpress.superclass.constructor.call(this,a);},populate:function(a){this._accountConfig.populate(this.mid,a);this._blogContentEditor.populate(this.mid,a);this.on("activate",function(){this._blogContentEditor.onActivate();});},serialize:function(){var a=this.getForm().getValues();if(a.type!="new"){a.include_link=0;}return a;},contentChanged:function(){return this.getForm().isDirty();},clearDirty:function(){this.getForm().trackRecordOnLoad=true;this.getForm().items.each(function(a){a.originalValue=a.getValue();});}});ECM.CMS.Panel.SocialMedia.BlogContentEditor=Ext.extend(Ext.Panel,{constructor:function(a){var b=this;this.servicePrefix=a.servicePrefix;this.maxPostCharacters=a.maxCharacters||4000;this.maxTitleCharacters=a.maxTitleCharacters||150;this.charactersRemaining=new Ext.form.Label({text:b.maxPostCharacters,width:150});a=Ext.apply({width:675,layout:"form",items:[]});ECM.CMS.Panel.SocialMedia.BlogContentEditor.superclass.constructor.call(this,a);},populate:function(b,c){var a=c;var d=this;this.postTextArea=new Ext.form.TextArea({width:550,height:300,autoScroll:true,enableKeyEvents:true,value:a.type=="new"?a.message||"":"",name:"message",allowBlank:a.type!="new",maxLength:this.maxPostCharacters,validator:function(f){if(f.search("<")!=-1){return gt.gettext("Please remove HTML from your post");}return true;},maxLengthText:gt.gettext("You have exceeded the maximum allowed size for this field")});applyRevalidateEvent(this.postTextArea);this.postTextArea.contentEditor=this;this.postTextArea.updateCharacters=ECM.CMS.Panel.SocialMedia.updateCharacters;Ext.each(["added","keydown","keyup","change"],function(f){this.postTextArea.on(f,this.postTextArea.updateCharacters);
},this);this.useSubject=a.use_subject;d.titleText=new Ext.form.TextField({value:a.title,name:"title",width:450,maxLength:this.maxTitleCharacters,enableKeyEvents:true,allowBlank:this.useSubject});applyRevalidateEvent(d.titleText);this.titleEditor=new Ext.Container({layout:"form",items:[{xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Title:"),width:75},{xtype:"radio",boxLabel:gt.gettext("New Title:"),name:"use_subject",value:0,inputValue:0,checked:a.use_subject==false,width:100},d.titleText]},{xtype:"container",layout:"column",items:[{xtype:"spacer",height:10,width:80},{xtype:"radio",boxLabel:gt.gettext("Use mailing subject line as title"),name:"use_subject",value:1,inputValue:1,checked:a.use_subject==true,width:300,listeners:{check:{fn:function(f,g){d.titleText.fireEvent("revalidate",{allowBlank:g});d.useSubject=g;}}}}]}],listeners:{hide:{fn:function(){d.titleText.fireEvent("revalidate",{allowBlank:true});}},show:{fn:function(){d.titleText.fireEvent("revalidate",{allowBlank:d.useSubject});}}}});this.postEditor=new Ext.Container({layout:"form",items:[{xtype:"spacer",height:10},{xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Body:"),width:75},this.postTextArea]},{xtype:"container",layout:"column",items:[{xtype:"spacer",height:10,width:75},{xtype:"label",text:gt.strargs(gt.gettext("%1 characters permitted. Characters available:"),d.maxPostCharacters)},this.charactersRemaining]},{xtype:"container",layout:"column",height:31,items:[{xtype:"spacer",height:10,width:75},{xtype:"label",text:gt.gettext("Include mailing web view link at the end of the post:")},{xtype:"spacer",height:10,width:5},{xtype:"combo",mode:"local",typeAhead:true,triggerAction:"all",width:50,hiddenName:"include_link",value:(a.include_link?1:0),store:[[0,gt.gettext("No")],[1,gt.gettext("Yes")]]}]}]});this.postTypeCombo=new Ext.form.ComboBox({triggerAction:"all",mode:"local",hiddenName:"type",editable:false,store:[["none",gt.gettext("Do not post")],["mailing",gt.gettext("Add the text version of the mailing as post")],["new",gt.gettext("New post (cannot contain HTML)")]],width:300,value:a.type});this.postTypeCombo.on("select",function(){var f=this.getValue();if(f=="new"){d.postEditor.show();d.postEditor.doLayout();d.postTextArea.fireEvent("revalidate",{allowBlank:false});}else{d.postEditor.hide();d.postTextArea.fireEvent("revalidate",{allowBlank:true});}if(f=="none"){d.titleEditor.hide();}else{d.titleEditor.show();d.titleEditor.doLayout();}Ext.getCmp("cmsShell").resizeContainerHeight();});this.add({xtype:"spacer",height:10},{xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Post Type:"),width:75},this.postTypeCombo]},{xtype:"spacer",height:10},this.titleEditor,this.postEditor);},onActivate:function(){if(this.postTypeCombo.getValue()!="new"){this.postEditor.hide();}if(this.postTypeCombo.getValue()=="none"){this.titleEditor.hide();}}});ECM.CMS.Panel.SocialMedia.AccountConfig=Ext.extend(Ext.Panel,{constructor:function(a){this._panel=new Ext.Panel();a=Ext.apply({items:[this._panel]});ECM.CMS.Panel.SocialMedia.AccountConfig.superclass.constructor.call(this,a);},populate:function(b,a){var d=a.service_id.toLowerCase();var f='<tpl for="."><div ext:qtip="{name:htmlEncode}" class="x-combo-list-item">{name:htmlEncode}</div></tpl>';var c=[];Ext.each(["account","test_account"],function(g){var h=g+"s";var j=gt.gettext(" No account created");if(a[h].list.length){j=gt.gettext(" Please select account");a[h].list.unshift({id:null,name:" Please select account"});}c[h]=new Ext.form.ComboBox({editable:false,triggerAction:"all",mode:"local",hiddenName:g+"_id",id:"socialMedia-"+d+"Select-"+g,store:new Ext.data.JsonStore({root:"list",autoLoad:true,fields:["id","name"],sortInfo:{field:"name",direction:"ASC"},data:a[h]}),emptyText:j,valueField:"id",displayField:"name",width:300,tpl:f,value:this.listContainsSelection(a[h].list,a[h].selected)?a[h].selected:null});},this);this.add({xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Account:"),width:100},c.accounts,{xtype:"spacer",width:25,height:10},{xtype:"label",html:String.format("<a href=/m/admin/sm_accounts?service={0}&mid={1}&from_mailing=1>{2}</a>",a.service_id,b,gt.gettext("Add Account")),width:150}]},{xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Test Account:"),width:100},c.test_accounts]},{cls:"cms-settings-header-line",autoEl:{tag:"div"}});this.doLayout();},listContainsSelection:function(c,b){var a=false;Ext.each(c,function(){if(this.id==b){a=true;return false;}});return a;}});ECM.CMS.Panel.SocialMedia.TwitterContentEditor=Ext.extend(Ext.Panel,{layout:"form",width:675,maxPostCharacters:140,initComponent:function(){this.charactersRemaining=new Ext.form.Label({text:this.maxPostCharacters,width:150});ECM.CMS.Panel.SocialMedia.TwitterContentEditor.superclass.initComponent.call(this,arguments);},populate:function(a,c){var d=c;var b=this;this.postTWTextArea=new Ext.form.TextArea({width:540,value:d.message||"",enableKeyEvents:true,name:"message",maxLength:b.maxPostCharacters,maxLengthText:gt.gettext("You have exceeded the maximum allowed size for this field"),autoCreate:{tag:"textarea",maxlength:b.maxPostCharacters,autocomplete:"off"}});this.postTWTextArea.contentEditor=this;this.postTWTextArea.stripNewlines=1;this.postTWTextArea.updateCharacters=ECM.CMS.Panel.SocialMedia.updateCharacters;Ext.each(["added","keydown","keyup","change"],function(f){this.postTWTextArea.on(f,this.postTWTextArea.updateCharacters);},this);this.useSubjectRadio=new Ext.form.Radio({boxLabel:gt.gettext("Message:"),name:"use_subject",value:0,inputValue:0,id:"use_subject",checked:d.use_subject==false,width:100});this.useMailingRadio=new Ext.form.Radio({boxLabel:gt.gettext("Use mailing subject line as Tweet"),name:"use_subject",value:1,inputValue:1,id:"use_mailing",checked:d.use_subject==true,width:300});this.useSubjectRadio.on("check",function(f,g){if(g==true){b.useMailingRadio.setValue(false);b.postTWTextArea.enable();}});this.useMailingRadio.on("check",function(f,g){if(g==true){b.useSubjectRadio.setValue(false);b.postTWTextArea.disable();}});this.useIncludeLink=new Ext.form.Checkbox({boxLabel:gt.gettext("Include mailing tag program link shortened by bit.ly"),name:"include_link",id:"include_link",value:true,checked:d.include_link==true,width:300});this.postEditor=new Ext.Container({layout:"form",items:[{xtype:"spacer",height:10,width:10},{xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Post:"),width:75}]},{xtype:"container",layout:"column",items:[{xtype:"spacer",height:10,width:5},this.useSubjectRadio,this.postTWTextArea]},{xtype:"container",layout:"column",items:[{xtype:"spacer",height:10,width:100},{xtype:"label",text:gt.strargs(gt.gettext("%1 characters permitted. Characters available:"),b.maxPostCharacters)},this.charactersRemaining]},{xtype:"container",layout:"column",items:[{xtype:"spacer",height:10,width:5},this.useMailingRadio]},{xtype:"container",layout:"column",items:[{xtype:"spacer",height:10,width:5},this.useIncludeLink]}]});this.add(this.postEditor);}});ECM.CMS.Panel.SocialMedia.FacebookContentEditor=Ext.extend(Ext.Panel,{layout:"form",width:675,maxPostCharacters:354,height:750,initComponent:function(){this.charactersRemaining=new Ext.form.Label({text:this.maxPostCharacters});ECM.CMS.Panel.SocialMedia.TwitterContentEditor.superclass.initComponent.call(this,arguments);},populate:function(n,k){var l=this;var g=[20,17,55];var c=[];var b=5;var m=5;var d=10;var o=10;var h=100;var f=500;var a=f-6;for(var j=0;j<g.length;j++){c[j]=(c[j-1]||0)+g[j];}this.useSubjectOff=new Ext.form.Radio({id:"use_subject_off",name:"use_subject",value:0,inputValue:0,checked:!k.use_subject,width:g[1]});this.useSubjectOn=new Ext.form.Radio({boxLabel:gt.gettext("Use mailing subject line as status"),id:"use_subject_on",name:"use_subject",value:1,inputValue:1,checked:k.use_subject,width:300});this.useSubjectOff.on("check",function(r,q){if(q){l.useSubjectOn.setValue(false);
l.statusMessage.enable();}});this.useSubjectOn.on("check",function(r,q){if(q){l.useSubjectOff.setValue(false);l.statusMessage.disable();}});this.statusMessage=new Ext.form.TextField({width:f,enableKeyEvents:true,value:k.status_message||"",name:"status_message",disabled:k.use_subject,maxLength:this.maxPostCharacters,maxLengthText:gt.gettext("You have exceeded the maximum allowed size for this field")});this.statusMessage.contentEditor=this;this.statusMessage.stripNewlines=1;this.statusMessage.updateCharacters=ECM.CMS.Panel.SocialMedia.updateCharacters;Ext.each(["added","keydown","keyup","change"],function(q){this.statusMessage.on(q,this.statusMessage.updateCharacters);},this);this.addMailing=new Ext.form.Checkbox({boxLabel:gt.gettext("Add mailing to wall (mailing tag program link will be included as the link)"),id:"add_mailing",name:"add_mailing",value:true,checked:k.add_mailing});this.mailingMessage=new Ext.form.TextArea({name:"mailing_message",autoScroll:true,value:k.mailing_message||"",disabled:!k.add_mailing,height:h,width:a});this.mailingLinkText=new Ext.form.TextField({name:"mailing_link_text",value:k.mailing_link_text,disabled:!k.add_mailing,width:f});var p=function(q){return q===""||q.match(/\.jpg|\.jpeg|\.gif|\.png$/i)?true:"Image URL must end with a supported image type: .jpg, .jpeg, .gif, .png.";};this.mailingImageUrl=new Ext.form.TextField({name:"mailing_image_url",emptyText:gt.gettext("Enter URL"),vtype:"url",value:k.mailing_image_url,disabled:!k.add_mailing,width:f,validator:p});this.addMailing.on("check",function(r,q){if(q){l.mailingMessage.enable();l.mailingLinkText.enable();l.mailingImageUrl.enable();}else{l.mailingMessage.disable();l.mailingLinkText.disable();l.mailingImageUrl.disable();}});this.addNew=new Ext.form.Checkbox({boxLabel:gt.gettext("Add new content to wall"),id:"add_new",name:"add_new",value:true,checked:k.add_new});this.newMessage=new Ext.form.TextArea({name:"new_message",autoScroll:true,value:k.new_message||"",disabled:!k.add_new,height:h,width:a});this.newLinkUrl=new Ext.form.TextField({name:"new_link_url",vtype:"url",value:k.new_link_url,disabled:!k.add_new,width:f});this.newLinkText=new Ext.form.TextField({name:"new_link_text",value:k.new_link_text,disabled:!k.add_new,width:f});this.newImageUrl=new Ext.form.TextField({name:"new_image_url",emptyText:gt.gettext("Enter URL"),vtype:"url",value:k.new_image_url,disabled:!k.add_new,width:f,validator:p});this.addNew.on("check",function(r,q){if(q){l.newMessage.enable();l.newLinkUrl.enable();l.newLinkText.enable();l.newImageUrl.enable();}else{l.newMessage.disable();l.newLinkUrl.disable();l.newLinkText.disable();l.newImageUrl.disable();}});this.postEditor=new Ext.Container({layout:"form",items:[{xtype:"spacer",height:d},{xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Status update:")}]},{xtype:"container",layout:"column",height:25,items:[{xtype:"spacer",height:o,width:c[0]},this.useSubjectOff,{xtype:"label",text:gt.gettext("Status:"),width:g[2]},this.statusMessage]},{xtype:"container",layout:"column",items:[{xtype:"spacer",height:o,width:c[2]},{xtype:"label",text:gt.strargs(gt.gettext("%1 characters permitted. Characters available:"),this.maxPostCharacters)},this.charactersRemaining]},{xtype:"container",layout:"column",items:[{xtype:"spacer",height:o,width:c[0]},this.useSubjectOn]},{xtype:"spacer",height:d},{xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Additional content:")}]},{xtype:"container",layout:"column",items:[{xtype:"spacer",height:o,width:c[0]},this.addMailing]},{xtype:"spacer",height:m},{xtype:"container",layout:"column",items:[{xtype:"spacer",height:o,width:c[1]},{xtype:"label",text:gt.gettext("Message:"),width:g[2]},this.mailingMessage]},{xtype:"spacer",height:m},{xtype:"container",layout:"column",items:[{xtype:"spacer",height:o,width:c[1]},{xtype:"label",text:gt.gettext("Link text:"),width:g[2]},this.mailingLinkText]},{xtype:"spacer",height:m},{xtype:"container",layout:"column",items:[{xtype:"spacer",height:o,width:c[1]},{xtype:"label",text:gt.gettext("Image:"),width:g[2]},this.mailingImageUrl]},{xtype:"spacer",height:d},{xtype:"container",layout:"column",items:[{xtype:"spacer",height:o,width:c[0]},this.addNew]},{xtype:"spacer",height:m},{xtype:"container",layout:"column",items:[{xtype:"spacer",height:o,width:c[1]},{xtype:"label",text:gt.gettext("Message:"),width:g[2]},this.newMessage]},{xtype:"spacer",height:m},{xtype:"container",layout:"column",items:[{xtype:"spacer",height:o,width:c[1]},{xtype:"label",text:gt.gettext("Link:"),width:g[2]},this.newLinkUrl]},{xtype:"spacer",height:m},{xtype:"container",layout:"column",items:[{xtype:"spacer",height:o,width:c[1]},{xtype:"label",text:gt.gettext("Link text:"),width:g[2]},this.newLinkText]},{xtype:"spacer",height:m},{xtype:"container",layout:"column",items:[{xtype:"spacer",height:o,width:c[1]},{xtype:"label",text:gt.gettext("Image:"),width:g[2]},this.newImageUrl]}]});this.add(this.postEditor);}});Ext.namespace("ECM.CMS");ECM.provide("ECM.CMS.Panel.SubjectLineTest");ECM.CMS.sltId=0;ECM.CMS.MAX_SUBJECT_LEN=200;ECM.CMS.Panel.SubjectLineTest=function(b){var g={is_new:b.data.mailing.test.id===null?true:false,save_url:b.save_url,mailing_name:b.data.mailing.name||"",mid:b.data.mid,cid:b.data.cid,test_id:b.data.mailing.test.id,segment_data:b.data.mailing.segment,candidate_data:b.data.mailing.test.candidates,criteria_data:b.data.mailing.test.winning_criteria,blank_name_text:gt.gettext("Test Name is required."),save_cb:b.save_cb,cancel_cb:b.cancel_cb,state:b.data.mailing.test.state,test_name:b.data.mailing.test.name,slt_must_have_criterion:b.data.mailing.slt_must_have_criterion,parserConfig:b.parserConfig};g.err_handler=ECM.CMS.Panel.SubjectLineTest.ErrorHandler();g.form_handler=ECM.CMS.Panel.SubjectLineTest.FormHandler({"mailing-id":g.mid,"test-id":g.test_id});g.segment=ECM.CMS.Panel.SubjectLineTest.Segment({segment:g.segment_data});g.request_handler=ECM.CMS.Panel.SubjectLineTest.RequestHandler(g);g.candidates=[].concat(g.candidate_data,(g.state.is_in_progress||g.state.is_remainder_sendable||g.state.is_winner_in_progress)?[]:[{}]).map(function(k,j){return ECM.CMS.Panel.SubjectLineTest.Candidate(k,g,j);});g.criteria_handler=a(g.criteria_data);g.message_handler=ECM.CMS.Panel.SubjectLineTest.MessageHandler(g);g.percent_remaining=g.is_new?100:(function(){var j=0;g.candidates.map(function(k){j+=k.details().percentage;});return 100-j;})();g.slt_create_message=gt.gettext("Please note: Subject Line Test will be created upon clicking on 'Create' or 'Create and Next'.<br>If your mailing was previous scheduled, it will be <span class=\"cm_error\">unscheduled</span>.<br>Please <span class=\"cm_error\">reschedule</span> your mailing once you have created your subject line test.");g.message_handler.subscribeDefaults();g.popupWindow=b.popupWindow||false;var d=g.form_handler;function a(l){var r={enabled:l.enabled?true:false,selected:l.chosen_by.selected,list:l.chosen_by.list,sendRemainingAfter:l.send_remaining_after,timeUnitSelected:l.time_unit.selected,timeUnitList:l.time_unit.list};var o=function(){return new Ext.data.ArrayStore({data:r.list.map(function(s){return[s.id,s.name];}),fields:["id","name"],idIndex:0});};var k=function(){return Object.extend(d.clsNameObj("chosen-by-selected",["criteria-control"]),{id:"criteriaComboBox",disabled:!r.enabled,editable:false,triggerAction:"all",store:o(),valueField:"id",displayField:"name",hiddenName:"chosen-by-selected",mode:"local",value:r.selected,xtype:"combo",listeners:{focus:function(){ECM.Flare.onFocus("FLARE_SETTINGS_SUBJECT_LINE_TEST");},blur:function(){ECM.Flare.onBlur("FLARE_SETTINGS_MAIN");}}});};var j=function(){return new Ext.data.ArrayStore({data:r.timeUnitList.map(function(s){return[s.id,s.name];}),fields:["id","name"],idIndex:0});};var p=function(){var s="time-unit-selected";return Object.extend(d.clsNameObj(s,["criteria-control"]),{id:"timeComboBox",disabled:!r.enabled,editable:false,triggerAction:"all",store:j(),hiddenName:s,valueField:"id",displayField:"name",mode:"local",value:r.timeUnitSelected,xtype:"combo",listeners:{focus:function(){ECM.Flare.onFocus("FLARE_SETTINGS_SUBJECT_LINE_TEST");
},blur:function(){ECM.Flare.onBlur("FLARE_SETTINGS_MAIN");}}});};var n=function(){return r.sendRemainingAfter;};var m=function(){return Object.extend(d.clsNameObj("send-remaining-after",["criteria-control"]),{xtype:"numberfield",id:"remainingNumber",disabled:!r.enabled,autoCreate:{tag:"input",size:2,maxLength:2},allowDecimals:false,allowNegative:false,value:n(),listeners:{focus:function(){ECM.Flare.onFocus("FLARE_SETTINGS_SUBJECT_LINE_TEST");},blur:function(){ECM.Flare.onBlur("FLARE_SETTINGS_MAIN");}}});};var q=function(){return r.enabled;};return{asArrayStore:o,criteriaComboBoxCfg:k,remainingNumberCfg:m,timeAsArrayStore:j,timeComboBoxCfg:p,enabled:q,sendRemainingAfter:n};}var c=function(l,k){var j=ECM.CMS.Panel.SubjectLineTest.Util();if(Ext.select(".candidate.blank").getCount()>=1){Ext.select(".candidate input.chosen:checked").each(function(){var o=Ext.getCmp(this.id);j.ctxtParent(o,".candidate").fireEvent("clear",o);});var n=Ext.select(".candidate .slt-subject").first();var m=Ext.getCmp(n.id);j.ctxtParent(m,".candidate").fireEvent("update",m);}};var h=[{text:gt.gettext("Delete Test"),handler:function(){ECM.FeatureHelp.hideAllTooltips();Ext.MessageBox.confirm(gt.gettext("Delete Subject Line Test"),gt.strargs(gt.gettext('You have chosen to delete subject line test "%1".<br />Would you like to continue? This will delete the subject line test, even if the mailing has been approved and scheduled.'),g.test_name),function(j){if(j==="yes"){g.request_handler.deleteSLT();}});}}];var f=function(){var j={xtype:"container",hidden:g.popupWindow?false:true,cls:"cm_text_align_right help_link",html:ECM.Flare.makeLink("FLARE_CREATE_SUBJECT_LINE_TEST_MODAL")};return(g.state.is_in_progress||g.state.is_remainder_sendable||g.state.is_winner_in_progress)?{xtype:"container",columnWidth:".98",layout:"table",defaults:{bodyStyle:"padding:5px"},layoutConfig:{columns:3},items:[{xtype:"container",layout:"column",cls:"errors",style:"text-align: left",colspan:3,items:[{xtype:"container",autoEl:"ul",cls:"ux-unordered-list",listeners:{render:function(k){g.err_handler.renderTo(k);}}}]},{html:gt.gettext("Test Name: ")+g.test_name,colspan:3,cls:"slt-disable-testname"},{columnWidth:0.2,html:"&nbsp;&nbsp"},{xtype:"container",layout:"column",width:650,items:[{xtype:"container",height:20,layout:"column",width:650,items:[{xtype:"spacer",width:0,height:10},{xtype:"spacer",html:gt.gettext("Subject Lines:"),width:200},{xtype:"spacer",width:110,height:10},{xtype:"spacer",html:gt.gettext("Segment %"),width:120}]},{cls:"cms-settings-header-line",autoEl:{tag:"div"}},{xtype:"container",height:5,layout:"column",width:650},{xtype:"container",layout:"form",cls:"candidates",items:g.candidates.map(function(k){return k.asXtypesRow();})},{xtype:"container",layout:"column",height:25,items:[{xtype:"spacer",width:272,height:20},{xtype:"spacer",width:50,height:20,html:gt.gettext("Total % ")},{xtype:"spacer",width:20,height:20,cls:"total-percent",html:(100-g.percent_remaining)+""}]},{cls:"cms-settings-header-line",autoEl:{tag:"div"}}].concat(g.criteria_handler.enabled()&&!g.state.is_deploying_soon?new ECM.CMS.WinningCriteria(g):[])},{columnWidth:0.05,html:"&nbsp;&nbsp"},j]}:{xtype:g.is_new?"form":"container",cls:"slt-form",columnWidth:g.is_new?".80":".98",buttons:g.is_new?[{text:gt.gettext("Create"),handler:g.request_handler.addDataViaForm,cls:"blue_button"},{text:gt.gettext("Create and Next"),cls:"shouldGoToOptionsPage blue_button",handler:g.request_handler.addDataViaForm},{text:gt.gettext("Cancel"),handler:g.request_handler.cancel,cls:"blue_button"}]:[],items:[{xtype:"container",layout:"column",cls:"errors",style:"text-align: left",items:[{xtype:"container",autoEl:"ul",cls:"ux-unordered-list",listeners:{render:function(k){g.err_handler.renderTo(k);}}}]},j,g.is_new?{xtype:"container",items:[{xtype:"container",height:55,layout:"column",items:[{xtype:"spacer",html:g.slt_create_message,width:600}]},{xtype:"container",height:30,layout:"form",items:[g.segment.comboBoxCfg(Object.extend(g.form_handler.clsNameObj("segment_id"),{xtype:"combo",fieldLabel:gt.gettext("Segment:"),labelStyle:"width:100px; font-weight:normal",width:300,tpl:'<tpl for="."><div ext:qtip="{name:htmlEncode}" class="x-combo-list-item"><b>{name:htmlEncode}</b><tpl if="count &gt; 0"><br/>'+gt.gettext("Count: ")+"{count}</tpl></div></tpl>",pageSize:15,listeners:{beforequery:function(k){k.combo.pageTb.changePage(1);},select:function(m,k,l){g.message_handler.bus.publish("/subjectlinetest/segment-select",{value:m.value});}}}))]}]}:{xtype:"spacer",height:0,width:0},{xtype:"container",height:30,layout:"form",cls:"slt_name_container",items:[Object.extend(g.form_handler.clsNameObj("test-name"),{xtype:"textfield",fieldLabel:gt.gettext("Test Name"),labelStyle:"width:100px; font-weight:normal",width:300,value:g.test_name,minLength:1,minLengthText:g.blank_name_text,autoCreate:{tag:"input",maxLength:200},listeners:{focus:function(){if(!g.popupWindow){ECM.Flare.onFocus("FLARE_SETTINGS_SUBJECT_LINE_TEST");}},blur:function(){if(!g.popupWindow){ECM.Flare.onBlur("FLARE_SETTINGS_MAIN");}}}})]},{cls:"cms-settings-header-line",autoEl:{tag:"div"}},{xtype:"container",height:30,layout:"column",cls:"cms_margin_left_5",columnWidth:".95",items:[{xtype:"spacer",width:g.is_new?0:20,height:10},{xtype:"spacer",html:gt.gettext("Subject Line"),width:g.is_new?295:228},{xtype:"spacer",width:18,height:10},{xtype:"spacer",html:gt.gettext("Segment %"),width:75},{xtype:"spacer",html:gt.gettext("Calculator"),width:70,cls:"calculator",listeners:{render:function(){this.el.on("click",function(k,l){window.open(String.format("/m/mailers/mailings/segment_percentage_calculator?mid={0}&lid={1}&cid={2}",g.mid,g.segment_data.selected,g.cid||""),"seg_calc","width=600,height=400,resizable=no,scrollbars=no,toolbar=no,location=no,directories=no,status=no,menubar=no");});}}},{xtype:"spacer",html:gt.gettext("Issue Name"),width:101}].concat(g.is_new?[]:[{xtype:"spacer",width:20,height:10},{xtype:"splitbutton",text:gt.gettext("Delete Subject Line"),cls:"blue_button",handler:c,menu:h}])},{xtype:"container",layout:"form",cls:"candidates",items:g.candidates.map(function(k){return k.asXtypesRow();})},{xtype:"container",layout:"column",cls:"cms_margin_left_5",height:25,items:[{xtype:"spacer",width:g.is_new?315:267,height:20,cls:"slt_total"},{xtype:"spacer",width:50,height:20,html:gt.gettext("Total % ")},{xtype:"spacer",width:20,height:20,cls:"total-percent",html:(100-g.percent_remaining)+""}]},{cls:"cms-settings-header-line",autoEl:{tag:"div"}},new ECM.CMS.WinningCriteria(g)]};};return{asXtypes:f};};ECM.CMS.WinningCriteria=Ext.extend(Ext.Container,{layout:"form",headerAsText:false,titleCollapse:true,cls:"winning-criteria",constructor:function(a){this.slt=a;ECM.CMS.WinningCriteria.superclass.constructor.call(this,a);this.on("afterrender",this.populate);},initComponent:function(){this.items=[{xtype:"spacer",html:gt.gettext("Create Winning Criterion")}];ECM.CMS.WinningCriteria.superclass.initComponent.call(this);},registeredControls:[],populate:function(){var c=this.slt;var b=new Ext.Container({layout:"form",items:[{xtype:"container",layout:"column",items:[{xtype:"spacer",width:25,height:10},Object.extend(c.form_handler.clsNameObj("winning-criteria-disabled"),{xtype:"radio",boxLabel:c.state.is_in_progress?"Remove Criterion":"No Criterion",id:"noCriteria",value:"",inputValue:"",disabled:!this.slt.percent_remaining,checked:!c.criteria_handler.enabled(),name:"winning-criteria-enabled"})]},{xtype:"container",layout:"column",items:[{xtype:"spacer",width:25,height:25},Object.extend(c.form_handler.clsNameObj("winning-criteria-enabled"),{xtype:"radio",boxLabel:gt.gettext("Use Criterion"),id:"useCriteria",value:1,inputValue:1,checked:c.criteria_handler.enabled(),disabled:!this.slt.percent_remaining,handler:function(j,k){var h=ECM.CMS.Panel.SubjectLineTest.Util();Ext.select(".criteria-control",undefined,h.ctxtParent(j,".slt-editor").el.dom).each(function(){Ext.getCmp(this.id).setDisabled(!k);});}})]}]});var g=new Ext.form.ComboBox(Object.extend({width:100},c.criteria_handler.timeComboBoxCfg()));
var a=new Ext.Container({layout:"column",items:[{xtype:"spacer",width:50,height:10},{xtype:"spacer",html:gt.gettext("Send remainder"),width:100,height:30},{xtype:"label",cls:"criteria-remaining-pct cms-label-no-left-padding",text:this.slt.percent_remaining===null?"":this.slt.percent_remaining,width:23},{xtype:"spacer",html:gt.gettext("% after"),width:50},Object.extend({width:50},c.criteria_handler.remainingNumberCfg()),{xtype:"spacer",width:5,height:30},Object.extend({width:100},c.criteria_handler.timeComboBoxCfg()),{xtype:"spacer",width:10,height:1},{xtype:"spacer",html:gt.gettext("after mailings complete sending")}]});var d=new Ext.Container({layout:"column",items:[{xtype:"spacer",width:50,height:30},{xtype:"spacer",html:gt.gettext("Based on"),width:60},Object.extend({width:200},c.criteria_handler.criteriaComboBoxCfg())]});var f=new Ext.Container({layout:"column",items:[{xtype:"spacer",width:50,height:10},{xtype:"spacer",html:gt.gettext("Please Note: In case of an exact tie a random winning version will be selected"),width:600,style:{marginBottom:"10px"}}]});this.add([b,a,d,f]);}});ECM.CMS.Panel.SubjectLineTest.ErrorHandler=function(){var f=ECM.CMS.Panel.SubjectLineTest.Errors();var a;var h=function(k){return k===undefined?a:a=k;};var g=function(){return f.toList().map(function(l){var k=Ext.getCmp(l.id);return{xtype:"box",autoEl:"li",style:"color: #ed1951",html:k?l.msg+'<a href="#">\u27A5</a>':l.msg,listeners:k?{render:function(){this.el.on("click",function(){k.focus(true);});}}:{}};});};var d=function(o,n){var l={};for(var m=0;m<n.length;m++){l[n[m]]=true;}for(var k=0;k<o.length;k++){if(!l.hasOwnProperty(o[k])){return false;}}return true;};var c=function(){var k=f.ids();for(var m in k){if(k.hasOwnProperty(m)){var l=Ext.getCmp(k[m]);if(l){l.el.frame("ff0000",1,{duration:0.5});}}}};var b=function(){if(!a){return;}a.removeAll();a.add(g());a.doLayout();c();return a;};var j=function(m){var l;var k=m.slice();for(l in k){if(k.hasOwnProperty(l)){f.addOrUpdate({id:k[l],msg:k[l]});}}b();for(l in k){if(k.hasOwnProperty(l)){f.remove(k[l]);}}};return{Errors:f,asXtypes:g,renderTo:h,Render:b,renderThenRemove:j,highlightErrors:c,onlyRecoverableErrors:d};};ECM.CMS.Panel.SubjectLineTest.Errors=function(){var g={};var f=function(h){g[h.id]={id:h.id,msg:h.msg};return g[h.id];};var d=function(h){return g.hasOwnProperty(h);};var a=function(h){return delete g[h];};var b=function(){var j=[];for(var h in g){if(g.hasOwnProperty(h)){j.push(h);}}return j;};var c=function(){var j=[];for(var h in g){if(g.hasOwnProperty(h)){j.push(g[h]);}}return j;};return{addOrUpdate:f,exists:d,remove:a,ids:b,toList:c};};ECM.CMS.Panel.SubjectLineTest.Segment=function(d){var g=d.segment;var b=ECM.CMS.Panel.SubjectLineTest.Util();var a=new Ext.ux.data.PagingJsonStore({root:"list",data:g,fields:["id","name","count"],idIndex:0});var c=function(j){return Object.extend(j===undefined?{}:j,{editable:true,anyMatch:true,selectOnFocus:true,triggerAction:"all",store:a,valueField:"id",displayField:"name",mode:"local",value:g.selected});};var h=function(l){var j=ECM.CMS.Panel.SubjectLineTest.Util();var k=a.find("id",l);return k===-1?null:a.getAt(k).data.count;};var f=function(j){return a.find("id",j)===-1?false:true;};return{arrayStore:a,comboBoxCfg:c,countAtId:h,idExists:f};};ECM.CMS.Panel.SubjectLineTest.Candidate=function(j,c,f){var b=c.form_handler;var h=c.err_handler;var g=ECM.CMS.Panel.SubjectLineTest.Util();var k={id:j.id||"",subject:j.subject_line||"",percentage:g.toNumber(j.seg_percent),issue:j.issue_name||"",index:Ext.id()};var d=function(){function q(s){return function(t){g.ctxtParent(t,".candidate").fireEvent(s,t);};}var p={change:function(){q("update")(this);},focus:function(){q("arrival")(this);},blur:function(){q("departure")(this);}};function o(){var s=c.segment.countAtId(c.segment_data.selected);return g.isNumber(s)&&g.isNumber(k.percentage)?""+Math.round(s*(k.percentage||0)/100):"\u2205";}var r=function(){var t=this;var s=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Sending...")});s.show();ECM.Ajax.request({url:"/cm/mailing/subjectlinetest",method:"POST",params:{action:"send_remainder",mid:c.mid,child_mid:k.id},success:function(v){s.hide();var u=ECM.getObject("responseJSON.data.mailing.test.send_remainder_subject",v);if(typeof u==="string"&&u.length>=1){if(Ext.getCmp("settingsSubject")){Ext.getCmp("settingsSubject").update(u);}t.publish("/cms/alert/add",{message:gt.strargs(gt.gettext("Subject line '%1' selected.  Please approve and schedule your remainder mailing."),u)});ECM.publish("/cms/updateMailingTitle",{mailing_name:Ext.get("header_mailing_name").dom.innerHTML,mailing_status:gt.gettext("(Not Approved)")});}},failure:function(x){s.hide();var v=x.responseJSON.application_errors;var w;if(v.length>0){for(var u=0;u<v.length;u++){w+=v(u)+"</br>";}}else{w=x.responseJSON.application_errors;}t.publish("/cms/error/add",{message:gt.gettext(w)});}});};var m=function(){return g.isEmptyString(k.subject)&&g.isNull(k.percentage)&&g.isEmptyString(k.issue);};var l=function(t,s){k[s]=t.getValue();};var n=function(){return"sltSubjectId"+ECM.CMS.sltId++;};return[{xtype:"container",autoHeight:true,layout:"column",style:{padding:c.is_new?"3px":"0"},cls:"candidate "+(m()?"blank":""),id:k.index,listeners:{clear:function(u){var t=g.ctxtParent(u,".candidate");if(k.id){Ext.getCmp(Ext.select(".delete",undefined,t.el.dom).first().id).setValue("1");t.hide().addClass("to-be-deleted");}else{g.ctxtParent(u,".candidates").remove(t.id);}ECM.publish("/subjectlinetest/recalculate-percent");for(var s=0;s<c.candidates.length;s++){if(c.candidates[s].details().index===k.index){c.candidates.splice(s,1);break;}}},arrival:function(u){var v=g.ctxtParent(u,".candidates");var s=g.ctxtParent(u,".candidate");if(v.el.select(".active").getCount()){var t=v.el.select(".active").first();t.removeClass("active");}s.el.addClass("active");ECM.Flare.onFocus("FLARE_SETTINGS_SUBJECT_LINE_TEST");},departure:function(t){var u=g.ctxtParent(t,".candidates");var s=g.ctxtParent(t,".candidate");if(!(Ext.select(".candidate:not(.to-be-deleted) .slt-subject").getCount()===2&&Ext.select(".candidate.blank:not(.to-be-deleted)").getCount()===2)){if(u.el.select(".candidate.blank:not(.to-be-deleted)").getCount()>1&&s.el.hasClass("blank")){s.fireEvent("clear",t);}}ECM.Flare.onFocus("FLARE_SETTINGS_MAIN");},update:function(y){var v=g.ctxtParent(y,".slt-editor");var u=g.ctxtParent(y,".candidates");var w=g.ctxtParent(y,".candidate");var t=Ext.getCmp(Ext.select(".total-percent",false,v.el.dom).first().id);var E=Ext.getCmp(w.el.select(".percentage").first().id);var z=Ext.getCmp(w.el.select(".candidate-count").first().id);var s=Ext.getCmp(v.el.select(".criteria-remaining-pct").first().id);var B=y.el.hasClass("slt-subject")?"subject":y.el.hasClass("percentage")?"percentage":y.el.hasClass("issue")?"issue":"unknown";switch(B){case"subject":l(y,"subject");break;case"percentage":l(y,"percentage");var x=0;var G="segment percent total";Ext.select(".percentage",false,u.el.dom).each(function(H){if(Ext.select(".delete",undefined,g.ctxtParent(Ext.getCmp(H.id),".candidate").el.dom).first().getValue()){return;}x+=this.getValue()===""?0:this.getValue("strings as numbers");});if(y.getErrors().length){h.Errors.addOrUpdate({id:y.el.id,msg:gt.gettext("Invalid percentage value.")});}else{h.Errors.remove(y.el.id);}c.percent_remaining=null;switch(isNaN(x)){case false:switch(x>100){case false:c.percent_remaining=100-x;if(h.Errors.exists(G)){h.Errors.remove(G);ECM.publish("/subjectlinetest/recalculate-percent");}k.percentage=g.toNumber(E.getValue());z.el.update(o());break;case true:h.Errors.addOrUpdate({id:G,msg:gt.strargs(gt.gettext("Combined percentage cannot exceed 100 (current total: %1)."),x)});break;default:break;}var A=Ext.getCmp("noCriteria");var D=Ext.getCmp("useCriteria");if(x===100){A.setValue(true);A.disable();D.setValue(false);D.disable();Ext.getCmp("criteriaComboBox").disable();Ext.getCmp("timeComboBox").disable();Ext.getCmp("remainingNumber").disable();
}else{A.enable();D.enable();}break;case true:h.Errors.addOrUpdate({id:G,msg:gt.gettext("Segment percentage must be a number from 1-99.")});break;default:break;}s.setText(c.percent_remaining===null||c.percent_remaining===undefined?"":c.percent_remaining);t.el.update(c.percent_remaining===null||c.percent_remaining===undefined?"":100-c.percent_remaining+"");h.Render();break;case"issue":l(y,"issue");if(y.getErrors().length){c.err_handler.Errors.addOrUpdate({id:y.el.id,msg:y.maxLengthText});}else{c.err_handler.Errors.remove(y.el.id);}c.err_handler.Render();break;case"unknown":break;}if(m()){w.addClass("blank");}else{w.removeClass("blank");}if(!u.el.select(".candidate.blank:not(.to-be-deleted)").getCount()){var F=ECM.CMS.Panel.SubjectLineTest.Candidate({},c);c.candidates.push(F);u.add(F.asXtypesRow());u.doLayout();Ext.getCmp("settingsFormPanel").generateCodeMirrorField(ECM.CMS.BULK_MAILING,c.parserConfig,"sltSubjectId"+(ECM.CMS.sltId-1),"292px","true",ECM.CMS.IS_SLT);}}},items:(c.state.is_in_progress||c.state.is_ready_to_send_remainder)?[{xtype:"container",layout:"column",width:650,cls:f%2?"blue_background":"",items:[{xtype:"spacer",width:300,autoHeight:true,html:k.subject},{xtype:"spacer",width:125,html:k.percentage+""},{xtype:"spacer",width:20,height:10}].concat(c.state.is_remainder_sendable&&!c.state.is_winner_in_progress?[{xtype:"button",cls:"blue_button send-remainder-btn",text:gt.gettext("Send Remainder"),width:100,listeners:{click:r}}]:[])}]:{xtype:"container",layout:"table",layoutConfig:{columns:11},items:[Object.extend(b.clsNameObj("delete"),{xtype:"hidden"}),Object.extend(b.clsNameObj("chosen"),{xtype:"checkbox",hidden:c.is_new}),Object.extend(b.clsNameObj("candidates-id"),{xtype:"hidden",value:k.id}),Object.extend(b.clsNameObj("slt-subject"),{xtype:"textfield",width:220,height:20,value:k.subject,id:n(),listeners:Object.extend({},p),autoCreate:{tag:"input",size:200,maxLength:200}}),{xtype:"spacer",width:10,height:10},Object.extend(b.clsNameObj("percentage"),{xtype:"numberfield",width:66,listeners:Object.extend({},p),autoCreate:{tag:"input",size:2,maxLength:2},allowDecimals:false,allowNegative:false,value:k.percentage}),{xtype:"spacer",width:15,height:10},{xtype:"container",autoEl:"div",cls:"candidate-count",width:64,html:o()},Object.extend(b.clsNameObj("issue"),{xtype:"textfield",listeners:Object.extend({},p),value:k.issue,maxLength:15,maxLengthText:gt.gettext("Issue name must not be longer than 15 characters."),autoCreate:{tag:"input",type:"text",maxlength:"15"},width:100}),{xtype:"spacer",width:20,height:10}].concat(k.id==""?[]:[{xtype:"button",cls:"blue_button",text:gt.gettext("Options"),handler:function(s,v){ECM.FeatureHelp.hideAllTooltips();var u=s.getEl().findParent(".candidate",null,true);if(u){var t=u.select(".slt-subject").first();if(t){Ext.apply(k,{subject_line:Ext.getCmp(t.id).getValue()});}}ECM.CMS.Panel.SubjectLineTest.OptionsWindow({candidates:c.candidate_data,currentSelection:[k]});}}])}}];};var a=function(){return Object.extend({},k);};return{asXtypesRow:d,details:a};};ECM.CMS.Panel.SubjectLineTest.Display=function(a){ECM.CMS.sltId=0;ECM.Ajax.request({url:a.load_url,params:a.load_args,method:"GET",success:function(d,h){var c=ECM.CMS.Panel.SubjectLineTest({save_cb:a.onSave,cancel_cb:a.onCancel,data:Ext.decode(d.responseText).data,save_url:a.save_url,popupWindow:a.popupWindow,parserConfig:a.parserConfig});a.destination.add(Ext.ComponentMgr.create(c.asXtypes()));a.onReady();var g=Ext.getCmp("settingsFormPanel");var b;for(var f=ECM.CMS.sltId;f>=0;f--){b="sltSubjectId"+f;g.generateCodeMirrorField(ECM.CMS.BULK_MAILING,a.parserConfig,b,"292px","true",ECM.CMS.IS_SLT);}},failure:function(b,c){Ext.MessageBox.alert(gt.gettext("Error"),gt.gettext("Error loading Subject Line Test."));}});};ECM.CMS.Panel.SubjectLineTest.Form=function(a){return Ext.getCmp(Ext.select(".slt-form",false,ECM.CMS.Panel.SubjectLineTest.Util().ctxtParent(a,".slt-editor").el.dom).first().id).getForm();};ECM.CMS.Panel.SubjectLineTest.OptionsWindow=function(c){if(!(c.candidates&&c.candidates.length)){return;}var g=Ext.decode(Ext.encode(c.candidates));var f=c.currentSelection?c.currentSelection[0]:g[0];var a=f.id;var d=Ext.decode(Ext.encode(c.fromCreate))||false;var b=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Loading...")});b.show();ECM.Ajax.request({url:"/cm/mailing/subjectlinetest/options",params:{mid:a},success:function(n){var m=Ext.decode(n.responseText);var j;if(m.data.tracking&&m.data.tracking.external_tracking_options){j=new ECM.CMS.Panel.ExternalTrackingPanel({mid:a});j.populate(m.data.tracking.external_tracking_options);}var k=function(q){var o=q.button.findParentByType(ECM.Window);if(q.shouldSave){var t=o.getComponent(1).getForm();var s=function(){Ext.destroy(o);if(q.otherCandidates){ECM.CMS.Panel.SubjectLineTest.OptionsWindow({candidates:q.otherCandidates,fromCreate:d});}};if(t.isDirty()){var r=Ext.getCmp("settingsFormPanel");var p=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Loading")});p.show();ECM.Ajax.request({url:"/cm/mailing/subjectlinetest/set_options",params:t.getValues(),success:function(u){s();p.hide();var v=gt.gettext("Subject Line Test Updated Successfully.");if(u.responseJSON.data.unapproved&&!d){r.publish("/cms/alert/add",{message:v+'<span class="ecm-error">'+gt.gettext("Mailing has been unapproved due to this change.")+"</span>"});ECM.publish("/cms/updateMailingTitle",{mailing_name:Ext.get("header_mailing_name").dom.innerHTML,mailing_status:gt.gettext("(Not Approved)")});}},failure:function(){p.hide();var u=d?gt.gettext("Subject Line Test Created. "):"";r.publish("/cms/error/add",{message:u+gt.gettext("Failed to save Options.")});Ext.destroy(o);}});}else{s();}}else{Ext.destroy(o);}};var l=[{text:gt.gettext("Done"),handler:function(p,o){k({button:p,shouldSave:true});}}];if(a!==g[g.length-1].id){l.push({text:gt.pgettext("next subject line test candidate","Next Subject Line"),handler:function(q){var o=-1;for(var p=0;p<g.length;p++){if(g[p].id===a){o=p;}}if(o!==-1){g.splice(0,o+1);}k({button:q,shouldSave:true,otherCandidates:g});}});}l.push({text:gt.gettext("Cancel"),handler:function(p,o){k({button:p,shouldSave:false});}});var h=new ECM.Window({title:gt.strargs(gt.pgettext("Subject Line Test options; %1 is the mailing subject line","Options - %1"),f.subject_line),cls:"slt_option_modal",content:{xtype:"form",layout:"form",defaultType:"textfield",items:[].concat((j?j:[]),[{xtype:"label",cls:"cms-settings-header-line",autoEl:{tag:"div"}},{xtype:"label",fieldLabel:gt.gettext("Link Editor")},{xtype:"container",layout:"column",items:[{xtype:"spacer",height:1,width:25},{xtype:"label",style:"margin-left: 25px; margin-right: 25px;",height:40,html:gt.gettext("Note: Please do not add personalization or dynamic content not found in your mailing. If no changes are made, the master mailing's settings will be used.")},{xtype:"spacer",height:10,width:25},{xtype:"label",text:gt.gettext("Append string to all links:")},{xtype:"spacer",height:1,width:5},{xtype:"textfield",name:"append_string",value:m.data.link_append_string,id:"sltAppendString"},{xtype:"hidden",name:"mid",value:a}]}])},windowButtons:l});h.doLayout();h.show();b.hide();},failure:function(){b.hide();Ext.getCmp("settingsFormPanel").publish("/cms/error/add",{message:gt.gettext("Failed to load Options.")});}});};ECM.CMS.Panel.SubjectLineTest.LaunchAllOptionsWindows=function(b){if(b.mid){var a=function(){b.panel.mediator.publish("/cms/error/add",{message:gt.gettext("Could not retrieve Subject Line Test")});};ECM.Ajax.request({url:"/cm/mailing/subjectlinetest",params:{mid:b.mid},success:function(d){var c=Ext.decode(d.responseText).data;if(c&&c.mailing&&c.mailing.test&&c.mailing.test.candidates){ECM.CMS.Panel.SubjectLineTest.OptionsWindow({candidates:c.mailing.test.candidates,fromCreate:true});}else{a();}},failure:a});}};ECM.CMS.Panel.SubjectLineTest.Util=function(){var c=function(q,r){return Ext.getCmp(q.el.findParent(r,undefined,true).id);};var h=function(q){return Ext.util.JSON.decode(Ext.util.JSON.encode(q));
};var o=function(q){return q&&typeof q==="object";};var g=function(q){return o(q)&&q.hasOwnProperty("length");};var b=function(q){return typeof q==="string";};var n=function(q){return !isNaN(q)&&typeof q==="number";};var a=function(q){return q===null;};var l=function(q){return q==="";};var j=function(q){return !b(q)?false:(/^\s+$/).test(q)?true:false;};var p=function(q){return a(q)?null:isNaN(q)?null:l(q)?null:n(q)?q:parseInt(q,10);};var d=function(q){return n(q)&&(q===1||q===0);};var k=function(q){return typeof q==="boolean";};var m=function(q){return q?1:0;};var f=function(q){return q===""?null:q;};return{ctxtParent:c,objCopy:h,isObject:o,isArray:g,isNumber:n,isString:b,isOneOrZero:d,isBool:k,isNull:a,boolToNum:m,toNumber:p,isEmptyString:l,isWhitespaceString:j,emptyAsNull:f};};ECM.CMS.Panel.SubjectLineTest.RequestHandler=function(d){var b=d.form_handler;var l=d.err_handler;var k=ECM.CMS.Panel.SubjectLineTest.Util();var a=function(r,o,t){for(var q in r){if(r.hasOwnProperty(q)){if(typeof r[q]==="object"){for(var p in r[q]){if(r[q].hasOwnProperty(p)){b.attr(q,r[q][p],p);}}}else{b.attr(q,r[q]);}}}var s=d.save_cb(o);if(b.validate(d)&&d.err_handler.Errors.ids().length===0){ECM.Ajax.request({method:"POST",loadMask:true,url:"/cm/mailing/subjectlinetest",params:{action:d.is_new||(function(){if(!(d.state.is_in_progress||d.state.is_ready_to_send_remainder)){var u=[];b.latest().mailing.test.candidates.map(function(v){if(v.id){u.push(v.id);}});if(u.length===0){return true;}else{return false;}}else{return false;}})()?"create":"edit",mid:d.mid,mailing:b.latestAsJSON()},success:function(w){Ext.select(".delete",undefined,Ext.getCmp(Ext.select(".slt-editor").first().id).el.dom).each(function(x){if(x.getValue()){x.remove();}});var v="";var u=Ext.getCmp("settingsFormPanel");s();if(d.candidates.length===1&&!d.candidates[0].details().id){u.removeInlineSLT();u.resetSLTInput(d.mid,d.cid,d.parserConfig);v=gt.gettext("Subject Line Test Deleted. ");}else{if(d.is_new){d.message_handler.unsubscribeDefaults();u.displaySubjectLineTest(d,d.parserConfig,r);u.setSegmentValue(b.latest().mailing.segment.selected);u.removeSLTInput();u.addSubjectLabel(b.latest().mailing.test.candidates[0].subject);u.doLayout();v=gt.gettext("Subject Line Test Created. ");}}if(w.responseJSON.data.unapproved){v=v+'<span class="ecm-error">'+gt.gettext("Mailing has been unapproved due to this change.")+"</span>";ECM.publish("/cms/updateMailingTitle",{mailing_name:Ext.get("header_mailing_name").dom.innerHTML,mailing_status:gt.gettext("(Not Approved)")});}u.publish("/cms/alert/add",{message:v});},failure:function(u){var v={recoverable:d.err_handler.onlyRecoverableErrors(u.responseJSON.application_errors,!k.isArray(ECM.getObject("responseJSON.data.recoverable_errors.SubjectLineTest",u))?[]:u.responseJSON.data.recoverable_errors.SubjectLineTest),list:[].concat(u.responseJSON.application_errors,u.responseJSON.error,u.responseJSON.authorization_errors)};if(v.recoverable){d.err_handler.renderThenRemove(v.list);}s(v);}});}else{if(typeof t==="function"){t();}s({recoverable:true});}};var m=function(p,o){if(d.state.is_parent_approved){Ext.Msg.show({title:gt.gettext("Mailing is approved"),msg:gt.gettext("Your selection will cause the mailing to be unnapproved. Do you want to continue?"),buttons:Ext.Msg.OKCANCEL,cls:"cm_text_align_left",fn:function(q){if(q==="ok"){p();}else{o();}}});}else{p();}};var f=function(p){var q={};for(var o in p.saveData){if(p.saveData.hasOwnProperty(o)){if(b.canDispatch(o)){q[o]=p.saveData[o];}}}d.save_cb=function(){return function(r){p.onSave(r);};};m(function(){a(q,false,p.onErrorBeforeSave);},p.onErrorBeforeSave);};var j=function(o,p){Ext.MessageBox.confirm("Winning Criterion Alert","The Winning Criterion for SLT has not been specified.<br>Do you want to continue?",function(q){if(q==="yes"){g(o,p);}});};var h=function(o,p){if((d.slt_must_have_criterion==1)&&(Ext.getCmp("noCriteria").getValue()===true)&&(!d.state.is_in_progress)){j(o,p);}else{g(o,p);}};var g=function(p,q){var o=ECM.CMS.Panel.SubjectLineTest.Form(p);if(Ext.select([o]).getCount()!==1){return;}if(o.isValid()){a(o.getFieldValues(),p.getEl().hasClass("shouldGoToOptionsPage"));}else{Ext.Msg.alert(gt.gettext("Save failed"),gt.gettext("Please correct errors indicated in red."));}};var n=function(o,p){d.message_handler.unsubscribeDefaults();d.cancel_cb();};var c=function(){var o=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Deleting Subject Line Test")});o.show();ECM.Ajax.request({method:"POST",url:"/cm/mailing/subjectlinetest",params:{action:"delete",mailing:b.latestAsJSON(),mid:d.mid},callback:function(){o.hide();},success:function(u){d.message_handler.unsubscribeDefaults();var s=Ext.getCmp("settingsFormPanel");s.removeInlineSLT();s.resetSLTInput(d.mid,d.cid,d.parserConfig);var t=gt.gettext("Subject Line Test Deleted.");if(u.responseJSON.data.unapproved){t=t+'<span class="ecm-error">'+gt.gettext("Mailing has been unapproved due to this change.")+"</span>";ECM.publish("/cms/updateMailingTitle",{mailing_name:Ext.get("header_mailing_name").dom.innerHTML,mailing_status:gt.gettext("(Not Approved)")});}s.publish("/cms/alert/add",{message:t});s.hasSLT=false;var q=Ext.getCmp("settingsSegmentSelect");var r=q.store.find("id",q.getValue());var p=q.store.getAt(r);if(p){q.onSelect(p,r);}},failure:function(p){settingsPanel.publish("/cms/error/add",{message:gt.gettext("Could not delete Subject Line Test")});}});};return{addOrUpdate:a,addDataViaForm:h,updateDataViaMsgBus:f,deleteSLT:c,cancel:n};};ECM.CMS.Panel.SubjectLineTest.MessageHandler=function(d){var c=[];var b=function(){for(var f in c){if(c.hasOwnProperty(f)){ECM.unsubscribe(c[f]);}}};var a=function(){c.push(ECM.subscribe("/subjectlinetest/inline-save",d.request_handler.updateDataViaMsgBus));c.push(ECM.subscribe("/subjectlinetest/segment-select",function(g){if(d.state.is_remainder_sendable){Ext.MessageBox.confirm(gt.gettext("Subject Line Test Warning"),gt.gettext("Changing the target segment will remove the ability to send to the remainder in your subject line test. Change originally selected target segment?"),function(h){if(h!="yes"){g.context.setValue(d.segment_data.selected);}});return;}var f=ECM.CMS.Panel.SubjectLineTest.Util();d.segment_data.selected=g.value;Ext.select(".candidate .percentage").each(function(j){var h=Ext.getCmp(j.id);f.ctxtParent(h,".candidate").fireEvent("update",h);});}));c.push(ECM.subscribe("/subjectlinetest/recalculate-percent",function(h){var g=ECM.CMS.Panel.SubjectLineTest.Util();var f=Ext.getCmp(Ext.select(".candidate .percentage").first().id);g.ctxtParent(f,".candidate").fireEvent("update",f);}));Ext.ux.Sprocket.PubSub.subscribe("/cms/leave_tab",function(){b();});};return{bus:ECM,subscribeDefaults:a,unsubscribeDefaults:b};};ECM.CMS.Panel.SubjectLineTest.FormHandler=function(s){var j=ECM.CMS.Panel.SubjectLineTest.Util();var q,o,l,h,b;var g={mailing:q={id:s["mailing-id"],name:null,test:o={id:s["test-id"],name:null,candidates:h=[],winning_criteria:b={enabled:null,chosen_by:{selected:null},send_remaining_after:null,time_unit:{selected:null}}},segment:l={selected:null}}};function c(){for(var t=0;t<h.length;t++){if((j.isNull(h[t].id)||j.isEmptyString(h[t].id))&&(h[t].subject===""||h[t].subject===null)){h.splice(t,1);}else{if(!(j.isNull(h[t].id)||j.isEmptyString(h[t].id))&&(h[t].subject===""||h[t].subject===null)){h[t]["delete"]=1;}}}return g;}var r=function(v){var w=[];if(v.state.is_in_progress||v.state.is_remainder_sendable){return true;}if(j.isNull(o.name)||j.isWhitespaceString(o.name)){w.push(gt.gettext("Test name cannot be blank."));}c();if(v.hasOwnProperty("candidates")&&v.candidates.length){(function(){for(var z=0;z<v.candidates.length;z++){var x=v.candidates[z];var y=Ext.getCmp(x.details().index);if(!j.isEmptyString(x.details().id)&&(j.isEmptyString(x.details().subject))){y.fireEvent("clear",y);}}})();}if(!l.selected||!v.segment.idExists(l.selected)){w.push("Please choose a valid segment.");}if(b.enabled){if(b.send_remaining_after===null){w.push("Missing time value for 'Send Remaining After...' field.");
}else{if(j.toNumber(b.send_remaining_after)===0){w.push("'Send Remaining After...' value must be between 1-99.");}}}if(h.length<=1){for(var u in h){if(h.hasOwnProperty(u)){if(j.isNull(h[u].subject)){w.push("At least one subject line must be present.");}}}}(function(){var x={};for(var z in h){if(h.hasOwnProperty(z)&&!h[z]["delete"]){var A=j.isEmptyString(h[z].percent)?0:h[z].percent;A=j.isNull(A)?0:A;if((!j.isEmptyString(j.isNull(h[z].subject)?"":h[z].subject))&&A<1){w.push("Segment % must be a number between 1 and 99, inclusive.");}var y=h[z].subject;if(!j.isNull(y)){y=y.replace(/^\s+/g,"");y=y.replace(/\s+$/g,"");}if(x[y]){w.push("Subject Line ["+y+"] can only be used once.");}else{x[y]=true;}}}})();if(w.length>0){var t=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Saving...")});t.hide();if(!v.is_new){Ext.getCmp("settingsFormPanel").publish("/cms/error/add",{message:gt.gettext("Selection will not be saved.  Correct errors indicated below")});}}v.err_handler.renderThenRemove(w);return w.length===0;};function f(){return j.objCopy(c(g));}function k(){return Ext.util.JSON.encode(c(g));}function a(t,u){return function(w,v){v=v===undefined?0:v;if(typeof h[v]!=="object"){h[v]={};}return(h[v][t]=u(w));};}function n(){return{"mailing-name":function(t){return(q.name=j.emptyAsNull(t));},segment_id:function(t){return(q.segment.selected=j.emptyAsNull(t));},"test-name":function(t){return(o.name=j.emptyAsNull(t));},"chosen-by-selected":function(t){return(b.chosen_by.selected=j.emptyAsNull(t));},"send-remaining-after":function(t){return(b.send_remaining_after=j.emptyAsNull(t));},"time-unit-selected":function(t){return(b.time_unit.selected=j.emptyAsNull(t));},"winning-criteria-enabled":function(t){return(b.enabled=j.boolToNum(t));},"candidates-id":a("id",j.emptyAsNull),"slt-subject":a("subject",j.emptyAsNull),percentage:a("percent",j.emptyAsNull),issue:a("issuename",j.emptyAsNull),"delete":a("delete",j.emptyAsNull),chosen:function(t){return true;}};}function p(t){return typeof n()[t]==="function";}function d(u,v){var t=ECM.CMS.Panel.SubjectLineTest.Util();return p(u)?{cls:[u].concat(t.isObject(v)?v:[]).join(" "),name:u}:{};}function m(v,u,t){if(p(v)){return n()[v](u,t);}}return{latest:f,latestAsJSON:k,canDispatch:p,attr:m,clsNameObj:d,validate:r};};Ext.namespace("ECM.CMS.Panel");ECM.provide("ECM.CMS.Panel.ExternalTracking");ECM.CMS.Panel.ExternalTrackingPanel=Ext.extend(Ext.Container,{width:500,layout:"form",headerAsText:false,titleCollapse:true,constructor:function(a){this.mid=a.mid;ECM.CMS.Panel.ExternalTrackingPanel.superclass.constructor.call(this,a);},initComponent:function(){this.items=[new Ext.form.Label({text:gt.gettext("External Tracking"),cls:"cms-settings-subheader"})];ECM.CMS.Panel.ExternalTrackingPanel.superclass.initComponent.call(this);},populate:function(b){var c=this;var a={focus:function(){ECM.Flare.onFocus("FLARE_SETTINGS_ADVANCED");},blur:function(){ECM.Flare.onBlur("FLARE_SETTINGS_MAIN");}};Ext.each(b,function(){c.add({xtype:"container",layout:"form",cls:"cm_margin_5_0_0 tracking_container",items:[new Ext.form.ComboBox({fieldLabel:"Enable "+this.label,labelStyle:"width:125px; font-weight:normal; white-space:normal;",width:60,listWidth:60,editable:false,id:"extTrackEnable-"+this.id+"-"+c.mid,triggerAction:"all",store:[[0,gt.gettext("No")],[1,gt.gettext("Yes")]],mode:"local",hiddenName:"ext_track_enable_"+this.id,value:this.enabled,listeners:a})]});if(this.hasOwnProperty("inputs")){currentTrackOption=this;Ext.each(this.inputs,function(){var d;if(this.type=="txt"){d=new Ext.form.TextField({value:(currentTrackOption.enabled?(this.value||""):""),id:"extTrackTextInput-"+this.name+"-"+c.mid,name:this.name,listeners:a});}else{if(this.type=="chk"){d=new Ext.form.CheckBox({checked:(currentTrackOption.enabled?(this.value?true:false):false),name:this.name,listeners:a});}}c.add({xtype:"container",layout:"column",items:[{xtype:"spacer",height:10,width:50},{xtype:"label",text:this.label,width:125},d]});});}});}});ECM.provide("ECM.ExtJS-urlDecode-bugfix");ECM.isExtURLDecodeBroken=function(){return typeof Ext.urlDecode("param=&param=1").param==="string"&&typeof Ext.urlDecode("param=1&param=").param==="object";};if(ECM.isExtURLDecodeBroken()){Ext.urlDecode=function(c,b){if(Ext.isEmpty(c)){return{};}var h={},g=c.split("&"),j=decodeURIComponent,a,f;Ext.each(g,function(d){d=d.split("=");a=j(d[0]);f=j(d[1]);h[a]=b||!h.hasOwnProperty(a)?f:[].concat(h[a]).concat(f);});return h;};}ECM.provide("ECM.CMS.Modal.ConfirmSocialMediaContentDeletion");ECM.CMS.Modal.ConfirmSocialMediaContentDeletion=Ext.extend(ECM.Window,{constructor:function(a){modal=this;modal.title=gt.gettext("Content Selection Warning");modal.content={xtype:"form",layout:"form",width:450,bodyStyle:(Ext.isSafari||Ext.isChrome)?"padding: 15px 15px 15px 0px;":"padding: 15px;",items:[{xtype:"container",layout:"column",items:[{xtype:"spacer",width:450,html:gt.gettext("There is content in the Social Media format, which you have just unselected. If you <br /> continue, that content will be lost. Would you like to continue?")}]},{xtype:"spacer",width:10,height:22}]};modal.windowButtons=[new Ext.Button({text:gt.gettext("Continue"),handler:function(b,c){a.mask.show();ECM.Ajax.request({url:"/cm/mailing/settings/clear_social_media_content",params:{mid:a.mailingId},success:function(f){var d=Ext.decode(f.responseText);if(!d.error||d.error.length){a.failureAlertCallback();}else{ECM.publish("/cms/alert/add",{message:gt.gettext("Social media content has been cleared")});}a.mask.hide();},failure:function(){a.mask.hide();}});modal.close();}}),new Ext.Button({text:gt.gettext("Cancel"),handler:function(){a.formControl.setValue(1);modal.close();}})];ECM.CMS.Modal.ConfirmSocialMediaContentDeletion.superclass.constructor.apply(this);},closable:false});ECM.provide("ECM.Config.FeatureHelp.Targeting");ECM.Config.FeatureHelp.Targeting=Ext.extend(ECM.Config.FeatureHelp,{bitBlock:1,tooltipConfigs:[{bitPosition:0,targetId:"settingsTab",message:gt.gettext("Add a note, change your segment name or add tags in the Settings section."),maxWidth:180,anchorOffset:18},{bitPosition:1,targetId:"ecm-tabletree",message:gt.gettext("Create conditions by dragging the field or value within the field you'd like to use into the workspace."),maxWidth:200,anchor:"left",xy:[160,325]},{bitPosition:2,targetId:"btnCreate",message:gt.strargs(gt.gettext("The grouping of activity conditions and nesting of these groups in your segment can define         the results in a much more granular level. For more information, please see our %1 documents."),[ECM.Flare.makeLink("FLARE_SEGMENT_TARGETING_CREATE_GROUP")]),maxWidth:240,silent:true}]});ECM.provide("ECM.FeatureHelp");ECM.FeatureHelp={features:[],tooltipObjects:{},isTargetPresent:function(a){return !Ext.isEmpty(Ext.getCmp(a)||Ext.get(a));},isEnabled:function(){return ECM.FeatureHelp.BitHelper.isHelpEnabled();},showTooltip:function(a,b){if(this.isEnabled()&&Ext.isDefined(this.tooltipObjects[a])){this.spawnTooltip(a,this.tooltipObjects[a],b);}},showAllTooltips:function(){if(this.isEnabled()){Ext.iterate(this.tooltipObjects,function(a,b){if(!b.silent){this.spawnTooltip(a,b);}},this);}},suppressTooltip:function(a){if(this.isEnabled()&&this.tooltipObjects[a]){return ECM.FeatureHelp.cookieManager("add",a);}return false;},unsuppressTooltip:function(a){return this.isEnabled()?ECM.FeatureHelp.cookieManager("rem",a):false;},cookieManager:function(c,f){var g="suppressed_tips";var d=Ext.util.Cookies.get(g);var b=false;var a=b?b:ECM.Stash.app_domain;f=f.toString();d=Ext.isEmpty(d)?d:d.split(";");switch(c){case"get":if(Ext.isEmpty(d)||d.indexOf(f)<0){return false;}return true;break;case"add":if(Ext.isArray(d)&&d.indexOf(f)<0){d.push(f);Ext.util.Cookies.set(g,d.join(";"),null,"/",a);return true;}else{if(Ext.isEmpty(d)){Ext.util.Cookies.set(g,f,null,"/",a);return true;}}break;case"rem":if(Ext.isArray(d)&&d.indexOf(f)>-1){d.splice(d.indexOf(f),1);Ext.util.Cookies.set(g,d.join(";"),null,"/",a);return true;}break;
}return false;},spawnTooltip:function(b,c,d){var a,f=Ext.getCmp(b)?Ext.getCmp(b).getEl():Ext.get(b);if(!this.isTargetPresent(b)||ECM.FeatureHelp.cookieManager("get",b)||!ECM.FeatureHelp.BitHelper.isBitAllowedInStash(c.bitPosition,c.featureReference.bitBlock)){return true;}window.setTimeout(function(){if(f.getWidth()===0&&f.getHeight()===0){return;}cmpPosition=Ext.isDefined(c.xy)?c.xy:f.getXY();c.showAt([-1000,-1000]);if(!c.xy){cmpPosition[1]=cmpPosition[1]-c.getHeight()-ECM.FeatureHelp.TOOLTIP_BTM_PADDING;cmpPosition[0]=cmpPosition[0]+ECM.FeatureHelp.TOOLTIP_LFT_PADDING;if(c.xyOffset){cmpPosition[0]+=c.xyOffset[0];cmpPosition[1]+=c.xyOffset[1];}}c.showAt(d||cmpPosition);c.syncAnchor();c.getEl().frame();},100);},hideAllTooltips:function(){if(this.isEnabled()){Ext.iterate(this.tooltipObjects,function(a,b){b.hide();});}},hideTooltip:function(a){if(this.isEnabled()&&Ext.isDefined(this.tooltipObjects[a])){this.tooltipObjects[a].hide();}},createTooltip:function(c,b){if(!this.isTargetPresent(c.targetId)||this.tooltipObjects[c.targetId]||ECM.FeatureHelp.cookieManager("get",c.targetId)){return true;}c.featureReference=b;var a=new ECM.FeatureHelp.Tooltip(c);this.tooltipObjects[c.targetId]=a;},setFeatureHelp:function(b){if(Ext.isEmpty(b)||!this.isEnabled()){return false;}Ext.each(b.tooltipConfigs,function(c){ECM.FeatureHelp.BitHelper.registerBitField(c.bitPosition,b.bitBlock);},this);var a;if(ECM.FeatureHelp.BitHelper.isStashTooltipEmpty()||!Ext.isDefined(ECM.FeatureHelp.BitHelper.getStashBitBlock(b.bitBlock))){a=b.getTooltipConfigs();}else{a=b.getTooltipConfigs(ECM.FeatureHelp.BitHelper.getAllowedBitPositions(b.bitBlock));}Ext.each(a,function(c){this.createTooltip(c,b);},this);this.features[b.bitBlock]=b;return b;},purgeTooltips:function(){if(!this.isEnabled()){return;}this.hideAllTooltips();if(this.tooltipObjects){Ext.iterate(this.tooltipObjects,function(b,a){a.destroy();delete this.tooltipObjects[b];},this);}ECM.FeatureHelp.BitHelper.flushRegisteredBitFields();},disableBit:function(f,b){var c=ECM.FeatureHelp.BitHelper;var a=c.getRegisteredBitsLength(f),d,g;g=c.isStashTooltipEmpty()?c.buildFullBitField():c.getStashTooltips();d=c.getBitBlock(f,g);d=c.buildBitField(b,true,a,d);g=c.replaceBitBlock(f,d,g);return g;},btnHandler:{updateStash:function(a){ECM.Stash.tooltips_enabled=a.responseJSON.data.tooltips_enabled;ECM.Stash.tooltips=a.responseJSON.data.tooltips;},hideForever:function(a){ECM.FeatureHelp.hideAllTooltips();ECM.Ajax.request({url:"/cm/tooltip/save",params:{disable_tooltips:true},success:ECM.FeatureHelp.btnHandler.updateStash});},hideOnce:function(b){var a=ECM.FeatureHelp.disableBit(b.featureReference.bitBlock,b.bitPosition);ECM.FeatureHelp.suppressTooltip(b.targetId);ECM.Ajax.request({url:"/cm/tooltip/save",method:"POST",params:{tooltips_value:a},success:ECM.FeatureHelp.btnHandler.updateStash});}}};ECM.FeatureHelp.ENABLED_BIT="0";ECM.FeatureHelp.DISABLED_BIT="1";ECM.FeatureHelp.TOOLTIPS_ENABLED_BIT="1";ECM.FeatureHelp.SEPARATOR="|";ECM.FeatureHelp.TOOLTIP_BTM_PADDING=7;ECM.FeatureHelp.TOOLTIP_LFT_PADDING=5;ECM.FeatureHelp.BitHelper={registeredBitBlocks:[],isHelpEnabled:function(){if(this.isStashInitialized()){return ECM.Stash.tooltips_enabled===ECM.FeatureHelp.TOOLTIPS_ENABLED_BIT;}return false;},isStashInitialized:function(){return(Ext.isDefined(ECM)&&Ext.isDefined(ECM.Stash)&&Ext.isDefined(ECM.Stash.tooltips_enabled)&&Ext.isString(ECM.Stash.tooltips));},isStashTooltipEmpty:function(){return !this.isStashInitialized()||this.getStashTooltips().length===0;},isBitAllowedInStash:function(a,b){if(!this.isStashInitialized()||!this.isHelpEnabled()){return false;}if(this.isStashTooltipEmpty()||Ext.isEmpty(this.getStashBitBlock(b))){return true;}return this.getBitFromPosition(a,this.getStashBitBlock(b))===ECM.FeatureHelp.ENABLED_BIT;},getAllowedBitPositions:function(c){var a=this.getRegisteredBitField(c),d=this.getStashBitBlock(c),b=[];Ext.each(this.registeredBitBlocks[c],function(j,g){var f=this.getBitFromPosition(g,d),h=this.getBitFromPosition(g,a);if(Ext.isDefined(f)&&f===h&&h!==ECM.FeatureHelp.DISABLED_BIT){b.push(g);}else{if(!Ext.isDefined(f)){b.push(g);}}},this);return b;},getRegisteredBitsLength:function(a){return this.registeredBitBlocks[a].length;},getRegisteredBitField:function(b){var a="";b=this.registeredBitBlocks[b];Ext.each(b,function(c){a=this.buildBitField(c,false,b.length,a);},this);return a;},getBitFromPosition:function(a,b){if(!Ext.isNumber(a)||!Ext.isString(b)){return false;}b=b.split("");return b[b.length-1-a];},getBitBlock:function(b,a){if(!a){return false;}return a.split(ECM.FeatureHelp.SEPARATOR).reverse()[b];},getStashBitBlock:function(a){if(!this.isStashInitialized()){return false;}return this.getBitBlock(a,this.getStashTooltips());},getStashTooltips:function(){return this.isStashInitialized()?ECM.Stash.tooltips:false;},replaceBitBlock:function(c,d,a){var b=a.split(ECM.FeatureHelp.SEPARATOR);if(!Ext.isDefined(b[c])){b.reverse();b[c]=d;b.reverse();}else{b[b.length-1-c]=d;}return b.join(ECM.FeatureHelp.SEPARATOR);},buildFullBitField:function(){var a=[];Ext.each(this.registeredBitBlocks,function(c,b){if(Ext.isDefined(c)){a[b]=this.buildBitField(0,false,c.length);}},this);return a.reverse().join(ECM.FeatureHelp.SEPARATOR);},buildBitField:function(d,b,f,g){var c,a="";if(Ext.isDefined(g)&&g.length!==0){a=g;if(g.length!==f){for(c=g.length;c<f;c++){a=ECM.FeatureHelp.ENABLED_BIT+a;}}}else{for(c=a.length;c<f;c++){a+=ECM.FeatureHelp.ENABLED_BIT;}}a=a.split("");a[a.length-1-d]=(b)?ECM.FeatureHelp.DISABLED_BIT:ECM.FeatureHelp.ENABLED_BIT;return a.join("");},flushRegisteredBitFields:function(){this.registeredBitBlocks=[];},registerBitField:function(a,b){if(!Ext.isArray(this.registeredBitBlocks[b])){this.registeredBitBlocks[b]=[];}if(this.registeredBitBlocks[b].indexOf(a)!==-1){return true;}this.registeredBitBlocks[b].push(a);this.registeredBitBlocks[b].sort(function(d,c){return d-c;});return a;}};ECM.FeatureHelp.Tooltip=Ext.extend(Ext.ToolTip,{closable:true,autoDestroy:false,dismissDelay:0,title:gt.gettext("Feature Help"),constructor:function(a){Ext.apply(this,a);this.id=a.targetId+"_tooltip";this.cls="featurehelp";this.html=this.message;this.anchor=this.anchor||"bottom";ECM.FeatureHelp.Tooltip.superclass.constructor.call(this,a);},initComponent:function(){var a=this;this.bbar=new Ext.Toolbar(["->",{xtype:"ecm.linkbutton",text:gt.gettext("Hide all tips"),handler:function(){ECM.FeatureHelp.btnHandler.hideForever(a);a.hide();}}]);ECM.FeatureHelp.Tooltip.superclass.initComponent.call(this);this.addEvents("tipclose");},afterRender:function(){ECM.FeatureHelp.Tooltip.superclass.afterRender.call(this);this.tools.close.on("click",function(){this.fireEvent("tipclose",this);ECM.FeatureHelp.btnHandler.hideOnce(this);},this);}});Ext.namespace("ECM.CMS.Modal");ECM.provide("ECM.CMS.Modal.CreateCampaign");ECM.CMS.Modal.CreateCampaign=Ext.extend(ECM.Window,{id:"campaignModal",title:gt.gettext("Add New Campaign Folder"),width:650,height:400,modal:true,constructor:function(a){Ext.apply(this,a);ECM.CMS.Modal.SelectTemplate.superclass.constructor.call(this);},listeners:{show:function(){Ext.getCmp("newCampaignName").reset();Ext.getCmp("campaignAddButton").disable();}},initComponent:function(){var a=this;this.items=[{xtype:"form",ref:"newCampaignForm",items:[{xtype:"label",id:"campaignErrorField",cls:"ecm-error",html:"&nbsp;",height:30},{xtype:"textfield",enableKeyEvents:true,id:"newCampaignName",name:this._name,blankText:gt.gettext("Enter campaign name"),allowBlank:false,vtype:"mailingNameFormat",vtypeText:gt.gettext("Invalid campaign name"),invalidText:gt.gettext("Invalid campaign name"),maxLength:50,maxLengthText:gt.gettext("Name cannot exceed 50 characters."),listeners:{scope:this,invalid:function(){Ext.getCmp("campaignAddButton").disable();},valid:function(){Ext.getCmp("campaignAddButton").enable();},render:function(){var b=this.getEl();b.focus.defer(200,b);}},fieldLabel:gt.gettext("Name"),labelStyle:"white-space: nowrap;",width:450}]}];this.windowButtons=[{text:gt.gettext("Add"),cls:"blue_button",id:"campaignAddButton",disabled:true,handler:function(){var b=this;
var c=new Ext.LoadMask(Ext.getDom("campaignModal")||Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Saving...")});ECM.Ajax.eventsSuspended=true;c.show();ECM.Ajax.request({url:"/cm/campaign/new_campaign",params:{name:Ext.getCmp("newCampaignName").getValue()},success:function(f){var d=Ext.decode(f.responseText);if(d.data.campaign){ECM.publish("/cms/addCampaign",{campaign:d.data.campaign});}c.hide();b.close();ECM.Ajax.eventsSuspended=false;},failure:function(f){var d=f.responseJSON;c.hide();if(d.application_errors.length>0){Ext.getCmp("campaignErrorField").setText(d.application_errors[0]);}ECM.Ajax.eventsSuspended=false;}});}.createDelegate(this)},{text:gt.gettext("Cancel"),cls:"blue_button",handler:function(){this.close();}.createDelegate(this)}];ECM.CMS.Modal.CreateCampaign.superclass.initComponent.call(this);},closeAction:"close"});ECM.provide("ECM.Client.Admin.BCCAddressEditorGrid");ECM.Client.Admin.BCCAddressEditorGrid=Ext.extend(Ext.grid.EditorGridPanel,{title:"",name:"",autoHeight:true,clicksToEdit:1,maxRows:undefined,reachedMax:undefined,viewConfig:{forceFit:true,scrollOffset:2},style:{paddingRight:"1px"},bccAddressStore:{},bccAddressRec:Ext.data.Record.create([{name:"address",type:"string"}]),constructor:function(a){Ext.apply(this,a);this.bccAddressStore=a.bccAddressStore;this.store=this.bccAddressStore;this.addEmptyNewBCCAddress();ECM.Client.Admin.BCCAddressEditorGrid.superclass.constructor.apply(this,arguments);},initComponent:function(){this.sm=new Ext.grid.RowSelectionModel();this.addressText=new Ext.form.TextField({vtype:"bccAddress"});this.cm=new Ext.grid.ColumnModel({defaults:{sortable:false,menuDisabled:true},columns:[{header:gt.gettext("Address &lt;local@domainname&gt;"),dataIndex:"address",width:570,editor:this.addressText},{header:"",dataIndex:"address",width:25,fixed:false,editable:false,renderer:function(a){if(a){return'<img src="/images/del.gif" class="deleteRow" style="cursor:pointer" width="10" height="10">';}else{return"";}}}]});this.bccAddressStore.addListener("clear",function(){this.addEmptyNewBCCAddress();},this);this.bccAddressStore.addListener("load",function(){this.addEmptyNewBCCAddress();},this);ECM.Client.Admin.BCCAddressEditorGrid.superclass.initComponent.apply(this,arguments);},listeners:{afteredit:function(a){var b=false;a.grid.store.each(function(d){var c=d.get("address");if(Ext.isEmpty(c)){if(b===true){a.grid.store.remove(a.grid.emptyRow);}b=true;a.grid.emptyRow=d;}});if(!b){this.addEmptyNewBCCAddress();}if(Ext.getCmp("cmsShell")){Ext.getCmp("cmsShell").resizeContainerHeight();}},afterRender:function(){ECM.Client.Admin.BCCAddressEditorGrid.superclass.afterRender.apply(this,arguments);},cellclick:function(b,g,c,f){var d=Ext.emptyFn;if(b.reachedMax){d=b.addEmptyNewBCCAddress;}if(c==1){if(f.getTarget(".deleteRow",1)){var a=b.getStore().getAt(g);b.getStore().remove(a);d.call(b);}}if(Ext.getCmp("cmsShell")){Ext.getCmp("cmsShell").resizeContainerHeight();}}},addEmptyNewBCCAddress:function(){var a=function(){this.getStore().add(new this.bccAddressRec({address:""}));};if(this.maxRows){this.reachedMax=false;var b=this.bccAddressStore.getCount();if(b>=0&&b<this.maxRows){a.call(this);}else{this.reachedMax=true;return;}}else{a.call(this);}if(Ext.getCmp("cmsShell")){Ext.getCmp("cmsShell").resizeContainerHeight();}},getBCCAddressStr:function(a){return a.data.address+",";},getValue:function(){var c="";var b=this.getStore();var a;b.each(function(g,d){var f=g.data.address;if(Ext.isEmpty(f)){b.remove(g);}});b.each(function(d){a=d.get("address");if(!Ext.isEmpty(a)&&Ext.form.VTypes.bccAddress(a)){c+=this.getBCCAddressStr(d);}},this);this.addEmptyNewBCCAddress();return c;}});Ext.reg("ecm.client.admin.bccaddresseditorgrid",ECM.Client.Admin.BCCAddressEditorGrid);Ext.namespace("ECM.CMS.Panel");ECM.provide("ECM.CMS.Panel.Settings");ECM.CMS.BULK_MAILING=1;ECM.CMS.EVENT_MAILING=2;ECM.CMS.PRODUCT_IS_MAILING=0;ECM.CMS.PRODUCT_IS_TEMPLATE=1;ECM.CMS.NOT_SLT=0;ECM.CMS.IS_SLT=1;ECM.CMS.MAX_SUBJECT_LEN=200;ECM.CMS.Panel.Settings=Ext.extend(ECM.CMS.MediatorInterface,{constructor:function(a){Ext.apply(this,a);var b=a.containerConfig.mediator=this;this._panel=new ECM.CMS.Panel.SettingsPanel(a.containerConfig);ECM.CMS.Panel.Settings.superclass.constructor.call(this);},select_template:function(){var b=this;if(b.show_template&&b.is_template!=ECM.CMS.PRODUCT_IS_TEMPLATE){var a=new ECM.CMS.Modal.SelectTemplate({mid:b.mid,mtype:b.mtype,page:"settings",listeners:{loadsettings:function(){b.load();}}});}else{b.load();}},load:function(b){var c=this;if(Ext.isDefined(Ext.getCmp("leftnav_emo"))){Ext.getCmp("leftnav_emo").show();}if(!b){c.publish("/cms/error/add",{message:"",area:"Settings"});}var a=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Loading...")});a.show();ECM.Ajax.request({url:"/cm/mailing/settings/get_settings_data",params:{mid:c.mid},success:function(h){var g=Ext.decode(h.responseText);if(g.data.warning_only){var f=g.data.warning_only;c.publish("/cms/error/add",{message:f,area:"Settings"});}c._panel.populate(g.data);var d=g.data.bcc_addr?g.data.bcc_addr.split(","):[];var j=[];Ext.each(d,function(k){var l={email:k};j.push(l);});if(Ext.isDefined(g.data.bcc_addr)&&(j.length>0)&&Ext.getCmp("bcc_from_affiliate_client_list").getValue()=="list"){c._panel.bccAddressStore.loadData(j);}c._panel.onActivate(g.data);if(!c._panel.mailingHasSLT(g.data)){a.hide();}Ext.getCmp("cmsShell").resetMailingNavPanelWidth();},failure:function(h){var f=h.responseJSON;a.hide();if(!Ext.isDefined(f)){c.publish("/cms/error/add",{message:gt.gettext("An unknown network problem occurred. Please retry later."),area:"Settings"});}else{if(f.error.length>0){c.publish("/cms/error/add",{message:gt.gettext("An unknown server error has occurred."),area:"Settings"});}else{if(f.application_errors.length>0){var g="";for(var d=0;d<f.application_errors.length;d++){g+=f.application_errors[d];}c.publish("/cms/error/add",{message:g,area:"Settings"});}}}}});},save:function(j){var c=this;if(Ext.getCmp("bcc_enabled").checked){if(!Ext.getCmp("bcc_from_affiliate_client_list").getValue()){c.publish("/cms/error/add",{message:gt.gettext("Please choose a BCC option.")});return false;}if(Ext.getCmp("bcc_from_affiliate_client_list").getValue()=="list"){var h=Ext.getCmp("grid_enter_bcc_address").getValue();var a=h.substring(0,h.length-1);if(!a){c.publish("/cms/error/add",{message:gt.gettext("Please enter at least one (1) email address in the BCC field.")});return false;}var m=a.split(",");if(m.length>3){c.publish("/cms/error/add",{message:gt.gettext("There is a maximum of three (3) email addresses allotted for BCC deployments.")});return false;}}}if(!c._panel.isValid()){c.publish("/cms/error/add",{message:gt.gettext("Selection will not be saved. Correct errors indicated below.")});return;}var f=c._panel.serialize();var b=Ext.getCmp("leftnav_panel");if(b.dcLibOverwrite.length){f.dclib_overwrite=ECM.Adapter.encode(b.dcLibOverwrite);}if(f.split_name===gt.gettext("Not Sampled")){delete f.split_name;}ECM.FeatureHelp.hideAllTooltips();f.bcc_enabled=Ext.getCmp("bcc_enabled").getValue()?"1":"0";var l=Ext.getCmp("bcc_from_affiliate_client_list").getValue();f.bcc_from=l;if(l=="list"){var g=Ext.getCmp("grid_enter_bcc_address").getValue();var a=g.substring(0,g.length-1);f.bcc_addr=a;}var d=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Saving...")});d.show();var k=function(n){if(!n){ECM.Ajax.request({url:"/cm/mailing/settings/save_settings",method:"POST",params:f,success:function(s){var p=s.responseJSON;var r="";if(p.data.saved_message){r=p.data.saved_message;}if(p.data.saved_warning){r=r+' <span class="ecm-error">'+p.data.saved_warning+"</span>";}if(r){c.publish("/cms/alert/add",{message:r,area:"Settings"});}ECM.publish("/cms/updateMailingTitle",{mailing_name:p.data.name,mailing_status:p.data.approved});if(b.dcLibOverwrite.length){b.dcLibOverwrite=[];b.libTags={};if(p.data.dclib_overwrite==="true"){var q=Ext.getCmp("leftnav_dc");if(Ext.isDefined(q)){if(Ext.isDefined(q.tree)){q.resetCodeMirror=false;
q.refreshTree();}else{if(!q.newDcTree.hidden){q.resetCodeMirror=false;q.loadTreeData();}else{q.loadTreeData(false);}}}}}c._panel.clearDirty();d.hide();switch(j){case"html":case"text":c.publish("/cms/load/content");break;case"checklist":c.publish("/cms/load/checklist");break;default:c.publish("/cms/load/settings",p.data.saved_message);break;}},failure:function(s){var q=s.responseJSON;var r="";d.hide();if(q.application_errors.length>0){for(var p=0;p<q.application_errors.length;p++){r+=q.application_errors[p];}}if(q.error&&q.error.length){r+=gt.gettext("An error has occurred, please try again.");c._panel.clearTagCombo();c._panel.getTags(f.addedTags);}if(r.length>0){c.publish("/cms/error/add",{message:r,area:"Settings"});}}});}else{d.hide();if(n&&!n.recoverable){var o=new ECM.Window({title:gt.gettext("Subject Line Test Alert"),cls:"slt-save-error",buttons:[{text:gt.gettext("OK"),cls:"blue_button",handler:function(q,p){ECM.CMS.Panel.SubjectLineTest.Util().ctxtParent(q,".slt-save-error").close();}}],items:[{xtype:"box",html:gt.gettext("The following errors occurred when attempting to save the Subject Line Test")},{xtype:"container",autoEl:"ul",cls:"ux-unordered-list",items:n.list.map(function(p){return{xtype:"box",autoEl:"li",style:"color: #ed1951",html:p+""};})}],autoscroll:true,draggable:false,layout:"column"});o.show();}}};if(Ext.select(".slt-editor").getCount()){ECM.publish("/subjectlinetest/inline-save",{saveData:f,onSave:k,onErrorBeforeSave:function(){d.hide();}});}else{k(false);}},refresh:function(){this._panel.refresh();},getExtContainer:function(){var a=this._panel;return a;},wasModified:function(){return this._panel.contentChanged();}});ECM.CMS.Panel.SettingsPanel=Ext.extend(Ext.form.FormPanel,{constructor:function(a){this.mediator=a.mediator;this.is_template=this.mediator.is_template;this.mid=a.mid;ECM.CMS.Panel.SettingsPanel.superclass.constructor.call(this,a);},id:"settingsFormPanel",autoHeight:true,height:1600,bodyStyle:"overflow-x:hidden",headerAsText:false,titleCollapse:true,serialize:function(){var b=this.getForm().getValues();var a=this.advancedSettingsSection.tagselection.getValue();Ext.isEmpty(a)?true:b.addedTags=a;return b;},isValid:function(){return this.getForm().isValid();},clearDirty:function(){this.getForm().trackRecordOnLoad=true;this.getForm().items.each(function(a){a.originalValue=a.getValue();});},contentChanged:function(){return this.getForm().isDirty();},initComponent:function(){var a=this;this.items=[];this.codeMirrorObjects=[];var b={collapse:function(){Ext.getCmp("cmsShell").resizeContainerHeight();},expand:function(){Ext.getCmp("cmsShell").resizeContainerHeight();},afterlayout:function(){Ext.getCmp("cmsShell").resizeContainerHeight();},afterrender:function(){this.dropTarget=new Ext.dd.DropTarget(Ext.get("settingsFormPanel"),{ddGroup:"DCZone",scope:this,notifyOver:function(d,c,g){var f=c.getTarget(),n=Ext.get(f).id,o=document.getElementById(n).parentNode.id;if(!o.match(/^cm_settings/)){var k=Ext.get(n).up("div.CodeMirror_textfield");if(!k){return false;}o=k.child("pre.CodeMirror-cursor").next().id;}if(g.ddel.id){var h=document.getElementById(g.ddel.id);if(h.getElementsByTagName("a")[0]){h.getElementsByTagName("a")[0].removeAttribute("href");}}var j=a[o],m=c.getPageX(),l=c.getPageY();j.setCursor(j.coordsChar({x:m,y:l}));return false;},notifyDrop:function(d,c,h){var g=c.getTarget(),m=Ext.get(g).id,n=document.getElementById(m).parentNode.id,f=d.dragData.node.id;if(!n.match(/^cm_settings/)){var k=Ext.get(m).up("div.CodeMirror_textfield");if(!k){a.mediator.publish("/cms/error/add",{message:gt.gettext("This action is not available for the selected field.")});return false;}n=k.child("pre.CodeMirror-cursor").next().id;}if(f.match(/^emo_/)){if((!n.match(/Subject/))&&(!n.match(/FromName/))&&(!n.match(/ReplyTo/))){a.mediator.publish("/cms/error/add",{message:gt.gettext("This action is not available for the selected field.")});return false;}}var j=a[n],l=j.getCursor();if(h.node.attributes.dcTagSource==="library"){Ext.getCmp("leftnav_panel").checkLibraryTag({tag:h.node.attributes.content,editorType:j,replaceFrom:l,replaceTo:l});}else{j.replaceRange(h.node.attributes.content,l,l);}return false;}});}};this.addEvents("tagadd","tagremove");this.saveButton=new Ext.Button({text:gt.gettext("Save Settings"),cls:"blue_button",handler:function(c){this.publish("/cms/save");}});this.saveButtonPanel=new Ext.Container({layout:"column",layoutConfig:{padding:"4"},items:[{xtype:"spacer",flex:1,columnWidth:Ext.isIE?0.7:0.93,height:10},this.saveButton]});this.items.push(this.saveButtonPanel);this.tbar=["->",this.saveButton];this.workflow=Ext.getCmp("cmsWizardWorkflow");this.innerPanel=new Ext.Panel({autoHeight:true,layout:"form",width:"100%",items:[]});this.envelopeSection=new Ext.form.FieldSet({title:gt.gettext("ENVELOPE"),id:"envelopeSection",collapsible:true,baseCls:"grey-x-panel x-panel",items:[],listeners:b});this.innerPanel.add(this.envelopeSection);if(this.is_template==ECM.CMS.PRODUCT_IS_MAILING){this.dataSection=new Ext.form.FieldSet({title:gt.gettext("DATA"),id:"dataSection",collapsible:true,baseCls:"grey-x-panel x-panel",items:[],listeners:b});this.innerPanel.add(this.dataSection);}this.advancedSettingsSection=new Ext.form.FieldSet({title:gt.gettext("ADVANCED SETTINGS"),collapsible:true,baseCls:"grey-x-panel x-panel",items:[],listeners:b});this.innerPanel.add(this.advancedSettingsSection);this.items.push(this.innerPanel);this.bccAddressStore=this.createBCCAddressStore();ECM.CMS.Panel.SettingsPanel.superclass.initComponent.call(this);},preprocessSegmentList:function(b){var c=[];var a=function(f){var d=document.createElement("textarea");d.innerHTML=f.toString().entitizeBrackets();return d.value.replace(/"/g,"&#34;");};Ext.each(b,function(d){c.push({id:d[0],name:a(d[1]||gt.gettext("NO NAME")),count:"",ds_name:""});});return c;},createSegmentStore:function(c,b){var a=new Ext.ux.data.PagingJsonStore({root:"list",id:"segmentStoreId",fields:["id","name","count","ds_name"],data:{selected:b,list:c}});return a;},updateSegmentListWithCountInfo:function(a,c){Ext.each(this.segmentList,function b(d){var f=d.id;if(a[f]){d.count=a[f];d.ds_name=c;}else{d.count="";d.ds_name="";}});},validSegmentId:function(c){if(!Ext.isPrimitive(c)||(new RegExp("\\D")).test(String(c))){return false;}var b=false;Ext.each(this.segmentList,function a(d){if(d.id==c){b=true;return false;}});return b;},getBCCOptions:function(){var a=[["affiliate",gt.gettext("Use affiliate level")],["client",gt.gettext("Use client level")],["list",gt.gettext("Use list of addresses")],];return new Ext.data.SimpleStore({fields:["id","option"],data:a});},populate:function(J){var v=this;var k=J.mailing_type==ECM.CMS.BULK_MAILING?1:2;var l={focus:function(){ECM.Flare.onFocus("FLARE_SETTINGS_ADVANCED");},blur:function(){ECM.Flare.onBlur("FLARE_SETTINGS_MAIN");}};var V=this.parserConfig={p13n:J.frequently_used_fields,dc:J.dynamic_content.in_mailing,mid:v.mid,processXML:false,mtype:k};this.envelopeSection.add({xtype:"hidden",name:"mid",value:J.mid});var b=[{xtype:"label",text:"*"+gt.pgettext("from e-mail address","From:")+"  ",width:100,cls:"cms-label-no-left-padding"}];var z=J.headers.from_restrict;var L={xtype:"textfield",name:"from_name",id:"settingsFromName",allowBlank:false,value:J.headers.from_name};var ag={xtype:"textfield",value:J.headers.from_address,allowBlank:false,id:"settingsFromAddress",name:"from_address"};if(J.headers.enter_from_address==="text"){b.push(L,ag);}else{if(z.list.length==1){if(z.list[0].name.length>0){b.push({xtype:"label",id:"settingsFromLabel",width:290,text:v.formatFromName(z.list[0].name),cls:"cms-label-no-left-padding"});b.push({xtype:"hidden",value:z.list[0].name,id:"settingsFromNameHidden",name:"from_name"});}else{b.push(L);}if(z.list[0].address.length>0){b.push({xtype:"label",id:"settingsFromEmailLabel",text:v.formatFromEmail(z.list[0].address),cls:"cms-label-no-left-padding"});b.push({xtype:"hidden",value:z.list[0].address,id:"settingsFromAddressHidden",name:"from_address"});
}else{b.push(ag);}}else{var t=[];Ext.each(z.list,function(){t.push([this.id,v.formatFromAddress(this.name,this.address)]);});b.push(new Ext.form.ComboBox({editable:false,triggerAction:"all",mode:"local",hiddenName:"from_val",id:"settingsFromSelect",store:new Ext.data.ArrayStore({fields:["id","name"],data:t}),tpl:'<tpl for="."><div ext:qtip="{name:htmlEncode}" class="x-combo-list-item">{name:htmlEncode}</div></tpl>',width:Ext.isIE?500:650,valueField:"id",displayField:"name",value:J.headers.from_restrict.selected}));}}this.envelopeSection.add({xtype:"container",layout:"column",items:b});var M=[{xtype:"label",text:"*"+gt.pgettext("Reply-To e-mail address","Reply-To:"),width:100,cls:"cms-label-no-left-padding"}];if((J.headers.enter_from_address==="text")||(z.list.length===0)){M.push({xtype:"textfield",id:"settingsReplyTo",name:"replyto_name",value:J.headers.replyto_name});}else{M.push({xtype:"label",width:290,text:gt.pgettext("from e-mail address","( Same as From )"),cls:"cms-label-no-left-padding"},{xtype:"hidden",id:"settingsReplyToHidden",name:"replyto_name",value:J.headers.replyto_name});}M.push({xtype:"label",text:"<"+J.headers.replyto_address+">",cls:"cms-label-no-left-padding"});this.envelopeSection.add({xtype:"container",layout:"column",items:M});var U=[{xtype:"label",text:"*"+gt.pgettext("e-mail subject","Subject:"),width:100,cls:"cms-label-no-left-padding"}];if(J.mailing_type==ECM.CMS.EVENT_MAILING){U.push({xtype:"textfield",width:450,name:"subject",id:"settingsSubject",value:J.headers.subject});}this.envelopeSection.add({xtype:"container",layout:"column",witdh:800,id:"subjectItemsContainer",items:U});if(J.mailing_type==ECM.CMS.BULK_MAILING){if(!v.mailingHasSLT(J)){v.addSubjectTextField(J.headers.subject);if((!J.hasOwnProperty("sample")||J.sample==="")&&v.is_template==ECM.CMS.PRODUCT_IS_MAILING){v.addNewSubjectLineTestLink(J.mid,J.cid,V);}}else{v.addSubjectLabel(J.headers.subject);}}var f;var E;if(J.mailing_type==ECM.CMS.EVENT_MAILING){f="Need dynamic content?";E='You can add the dynamic content elements you need by clicking on the "Dynamic Content" slider found on the left, then dragging in the element you need. Dynamic Content tags in the Library must first be added to your mailing content.';}else{f="Need dynamic content or personalization?";E='You can add the personalization or dynamic content elements you need by clicking on the "Personalization and Dynamic Content" slider found on the left, then dragging in the element you need. Dynamic Content tags in the Library must first be added to your mailing content.';}var af=[{xtype:"label",id:"dcP13nLink",name:"dcP13nLink",cls:"cms-label-no-left-padding label_link",text:gt.gettext(f),listeners:{render:function(){this.el.on("click",function(ak,al){Ext.getCmp("dcP13nLink").hide();Ext.getCmp("dcP13nTextContainer").show();});}}}];var r=[{xtype:"label",name:"dcP13nText",html:gt.gettext(E)+"&nbsp;&nbsp;"}];var X=[{xtype:"label",name:"dcP13nCancelText",cls:"label_link",text:gt.gettext("Cancel"),listeners:{render:function(){this.el.on("click",function(ak,al){Ext.getCmp("dcP13nLink").show();Ext.getCmp("dcP13nTextContainer").hide();});}}}];this.envelopeSection.add({xtype:"container",id:"dcP13nLinkTextContainer",width:730,items:[af,{xtype:"container",layout:"auto",id:"dcP13nTextContainer",hidden:true,items:[r,X]}]});if(J.mailing_type==ECM.CMS.BULK_MAILING&&v.is_template==ECM.CMS.PRODUCT_IS_MAILING){if(v.mailingHasSLT(J)){J.segment.list.shift();}v.segmentList=v.preprocessSegmentList(J.segment.list);if(Ext.isObject(J.count_info)){var ad="";var R=J.data_source.selected||"";Ext.each(J.data_source.list,function(ak){if(R==ak[0]){ad=ak[1];return false;}});v.updateSegmentListWithCountInfo(J.count_info,R!==""?ad:null);}var d=v.createSegmentStore(v.segmentList,J.segment.selected);if(J.feature_permissions.PA_EXT_DB){var Q=new Ext.data.ArrayStore({root:"list",fields:["id","name","on","note",{convert:function(ak,al){return al[1]+(al[3]?" "+al[3]:"")+(al[2]?" ("+al[2]+")":"");},name:"display"}],autoLoad:true,data:J.data_source});var Z=[{xtype:"label",text:gt.gettext("Data Source:"),width:100,cls:"cms-label-no-left-padding"}];if(J.data_source.list.length){var A=new ECM.Form.ComboBox({width:Ext.isIE?500:650,listWidth:650,anyMatch:true,allowBlank:true,triggerAction:"all",mode:"local",hiddenName:"data_source",id:"settingsDataSourceSelect",store:Q,valueField:"id",displayField:"display",value:J.data_source.selected||"",selectOnFocus:true,tpl:['<tpl for=".">',"<div ",'ext:qtip="',"{name:htmlEncode}","{[values.on ? ' (' + values.on + ')' : '']}","{[values.note ? '<br />' + Ext.util.Format.htmlEncode(values.note) : '']}",'" ','class="x-combo-list-item"',">","<b>","{name:htmlEncode}",'<tpl if="values.note">'," {values.note}","</tpl>",'<tpl if="on">'," ({on})","</tpl>","</b>","</div>","</tpl>"].join(""),listeners:{focus:function(){ECM.Flare.onFocus("FLARE_SETTINGS_DATA");},blur:function(){ECM.Flare.onBlur("FLARE_SETTINGS_MAIN");},beforeselect:function(am,ak,al){this.collapse();return ak.data.id!=this.getValue();},select:function(aq,an,ap){var al=an.get(aq.valueField);var ar=an.get(aq.displayField);var ak=(al!="")?"xdb":"db";var am=Ext.getCmp("settingsSegmentSelect");if(!am){return;}var ao=am.getValue();ECM.Ajax.request({url:"/cm/mailing/settings/get_segment_count_compat",method:"GET",params:(function(){var at={mid:J.mid,ds_id:an.data.id||""};if(ak==="xdb"&&v.validSegmentId(ao)){at.segment_id=ao;}return at;})(),success:function(aw){var au=Ext.decode(aw.responseText);if(!au.error||au.error.length){sendFailureAlert();}else{if(au.data){var av=au.data;v.updateSegmentListWithCountInfo(av.count_info,ak==="xdb"?ar:null);var at=v.createSegmentStore(v.segmentList,ao);am.bindStore(at);if(ak==="db"){am.xdbCompatible=true;}else{if(ak==="xdb"){am.xdbCompatible=av.compatible;}}am.validate();}}},failure:function(){sendFailureAlert();}});}}});Z.push(A);}if(J.data_source.list.length>0){this.dataSection.add({xtype:"container",layout:"column",items:Z});}}var D=new ECM.Form.ComboBox({width:Ext.isIE?500:650,listWidth:650,anyMatch:true,triggerAction:"all",mode:"local",cls:"segment-selected",hiddenName:"segment_id",id:"settingsSegmentSelect",valueNotFoundText:"",allowBlank:false,selectOnFocus:true,store:d,pageSize:15,valueField:"id",displayField:"name",lastQuery:"",value:J.segment.selected,xdbCompatible:true,tpl:['<tpl for=".">','<div ext:qtip="{name}" class="x-combo-list-item">',"<b>{name}</b>","<tpl if=\"count != null && count != ''\">","<br/>",gt.strargs(gt.gettext("Count: %1"),["{count}"]),"<tpl if=\"ds_name != null && ds_name != ''\">"," ",gt.strargs(gt.gettext("(XDB file: %1)"),["{ds_name}"]),"</tpl>","</tpl>","</div>","</tpl>"].join(""),checkXdbSegmentCompatibility:function(){var am=this;var al=Ext.getCmp("settingsDataSourceSelect");if(!al){return;}var ak=al.getValue()===""?"db":"xdb";if(ak==="db"||!am.getValue()||!(new RegExp("^XDB_\\d+_\\d+$")).test(String(al.getValue()))){am.xdbCompatible=true;am.validate();}else{if(ak==="xdb"){ECM.Ajax.request({url:"/cm/mailing/settings/check_xdb_segment_compatibility",method:"GET",params:{mid:J.mid,segment_id:am.getValue(),ds_id:al.getValue()},success:function(ao){var an=Ext.decode(ao.responseText);am.xdbCompatible=an.data.compatible;am.validate();}});}}},validator:function(al){var ak=Ext.getCmp("settingsDataSourceSelect");if(!Ext.isDefined(ak)){return true;}return this.xdbCompatible?true:gt.gettext("Your segment includes fields which this XDB file does not contain.");},listeners:{beforequery:function(ak){(function(){ak.combo.pageTb.changePage(1);}).defer(100);},render:function(ak){ak.checkXdbSegmentCompatibility();},select:function(am,ap,ar){ECM.publish("/subjectlinetest/segment-select",{value:am.value,context:am});var ak=Ext.getCmp("settingsSampleSelect"),aq=Ext.getCmp("settingSamplePercent"),an=Ext.getCmp("samplesContainer"),au=Ext.getCmp("settingsDataSourceSelect"),at=v.mailingHasSLT(J),ao=au&&au.getValue()!==""&&au.getValue()!==null;if(!at&&!ao&&J.data_source.segment_splits&&J.data_source.segment_splits.data){var al=[["",gt.gettext("Not Sampled"),"","0",gt.gettext("Not Sampled")]];
Ext.each(J.data_source.segment_splits.data,function(av){if(av[0]===ap.get("id")){if(av.length<5){av.push(av[1]+", "+av[2]+"%");}al.push(av);}});if(al.length>1){ak.getStore().loadData(al);aq.setValue("");an.show();ak.cacheSizes=false;ak.updateBox(ak);}else{ak.setValue(gt.gettext("Not Sampled"));aq.setValue("");an.hide();}}am.checkXdbSegmentCompatibility();},focus:function(){ECM.Flare.onFocus("FLARE_SETTINGS_DATA");},blur:function(){ECM.Flare.onBlur("FLARE_SETTINGS_MAIN");}}});var S=new Ext.data.ArrayStore({fields:["segment_id","name","percent","mailing_id","display_name"],data:[["",gt.gettext("Not Sampled"),"","",gt.gettext("Not Sampled")]]});var aa=true,o=[["",gt.gettext("Not Sampled"),"","0",gt.gettext("Not Sampled")]],W,m=v.mailingHasSLT(J),F=ECM.getObject("list",J.data_source),B=(F&&F.length!==1&&J.data_source.selected!==""&&J.data_source.selected!==null);if(!m&&!B&&J.segment.selected&&J.segment.selected!=0&&J.data_source.segment_splits&&J.data_source.segment_splits.data){Ext.each(J.data_source.segment_splits.data,function(ak){if(ak.length<5){ak.push(ak[1]+", "+ak[2]+"%");}if(ak[0]===J.segment.selected){o.push(ak);}if(ak[3]!=="0"){W=o.length-1;}});if(o.length>1){S.loadData(o);aa=false;}}var n=new ECM.Form.ComboBox({width:Ext.isIE?500:650,listWidth:650,anyMatch:true,triggerAction:"all",mode:"local",value:gt.gettext("Not Sampled"),hiddenName:"split_name",id:"settingsSampleSelect",valueNotFoundText:"",allowBlank:false,selectOnFocus:true,store:S,valueField:"name",displayField:"display_name",lastQuery:"",listeners:{select:function(al,ak){if(ak.get("percent")){Ext.getCmp("createSLT").hide();}else{Ext.getCmp("createSLT").show();}Ext.getCmp("settingSamplePercent").setValue(ak.get("percent"));}}});var N={id:"settingSamplePercent",xtype:"hidden",name:"split_percent"};if(Ext.isDefined(W)){var P=S.getAt(W);n.setValue(P.get("name"));N.value=P.get("percent");Ext.getCmp("createSLT").hide();}this.dataSection.add({xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Segment:"),width:100,cls:"cms-label-no-left-padding"},D]},{xtype:"container",layout:"column",id:"samplesContainer",hidden:aa,items:[{id:"sampleSelectLabel",xtype:"label",width:100,cls:"cms-label-no-left-padding",text:gt.gettext("Select Sample:")},n,N]});}if(J.feature_permissions.PA_EVENT_FEED&&v.is_template==ECM.CMS.PRODUCT_IS_MAILING){this.dataSection.add({xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Issue Name:"),width:100,cls:"cms-label-no-left-padding"},{xtype:"textfield",width:350,name:"issue_name",id:"settingsIssueName",value:J.issue_name,maxLength:15,listeners:{focus:function(){ECM.Flare.onFocus("FLARE_SETTINGS_DATA");},blur:function(){ECM.Flare.onBlur("FLARE_SETTINGS_MAIN");}}}]});}this.advancedSettingsFieldWidth=493;var aj;if(J.mailing_type==ECM.CMS.BULK_MAILING){aj=new Ext.form.ComboBox({typeAhead:true,valueNotFoundText:"",allowBlank:false,triggerAction:"all",mode:"local",hiddenName:"folder_id",id:"settingsFolderSelect",width:this.advancedSettingsFieldWidth,store:new Ext.data.JsonStore({root:"list",autoLoad:true,fields:["id","name"],data:J.folder}),valueField:"id",displayField:"name",value:J.folder.selected,listeners:l});}this.advancedSettingsLabelWidth=140;this.advancedSettingsSection.add({xtype:"label",text:gt.gettext("General"),cls:"cms-settings-header cms-settings-header-first"},{xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("*Mailing name:"),width:this.advancedSettingsLabelWidth},{xtype:"textfield",style:"width: "+this.advancedSettingsFieldWidth+"px;",name:"name",value:J.name,allowBlank:false,maxLength:100,maxLengthText:gt.gettext("The mailing name must be a maximum of 100 characters long."),listeners:l}]});if(J.mailing_type==ECM.CMS.BULK_MAILING){this.advancedSettingsSection.add({xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Folder:"),width:this.advancedSettingsLabelWidth},aj]});var g=[["",gt.gettext("None")]];Ext.each(J.mailing_tags.list,function(){if(!this.ARCHIVED){g.push([this.TAG_ID,this.TAG_NAME_SAFE]);}});if(g.length>1){var p=new Ext.form.ComboBox({typeAhead:true,valueNotFoundText:"",allowBlank:false,triggerAction:"all",mode:"local",hiddenName:"tag_id",id:"settingsMailingTagSelect",width:this.advancedSettingsFieldWidth,store:new Ext.data.ArrayStore({fields:["id","name"],data:g}),valueField:"id",displayField:"name",value:J.mailing_tags.selected||"",listeners:l});this.advancedSettingsSection.add({xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Mailing reporting tag:"),width:this.advancedSettingsLabelWidth},p]});}}if(J.mailing_type==ECM.CMS.BULK_MAILING&&J.feature_permissions.PA_CAMPAIGN){Ext.each(J.campaign.list,function(ak){ak.name_lc=ak.name.toLowerCase();});if(J.campaign.list.length>0){var ac=new Ext.data.JsonStore({root:"list",fields:["id","name","name_lc"],sortInfo:{field:"name_lc",direction:"ASC"},autoLoad:true,data:J.campaign});var I=new Ext.form.ComboBox({typeAhead:true,valueNotFoundText:"",allowBlank:false,triggerAction:"all",mode:"local",hiddenName:"campaign_id",id:"settingsCampaignSelect",width:this.advancedSettingsFieldWidth,store:ac,valueField:"id",displayField:"name",value:J.campaign.selected,listeners:l});ECM.subscribe("/cms/addCampaign",function(al){al.campaign.name_lc=al.campaign.name.toLowerCase();var ak=ac.recordType;ac.add(new ak(al.campaign));I.setValue(al.campaign.id);ac.sort("name_lc","ASC");});this.advancedSettingsSection.add({xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Campaign:"),width:this.advancedSettingsLabelWidth},I,{xtype:"spacer",width:5,height:10},new Ext.Button({text:gt.gettext("Add New Campaign"),cls:"blue_button",handler:function(ak){var al=new ECM.CMS.Modal.CreateCampaign({});al.show();al.center();}})]});}}var y=this;this.advancedSettingsSection.add({xtype:"container",layout:"column",cls:"column_container",items:[{xtype:"label",text:gt.gettext("Tags:"),width:this.advancedSettingsLabelWidth-46},{xtype:"ecm.tagselection",submitValue:false,ref:"../tagselection",hideLabel:true,width:this.advancedSettingsFieldWidth,listeners:{tagadd:function(){v.fireEvent("tagadd");Ext.getCmp("cmsShell").resizeContainerHeight();},tagremove:function(){v.fireEvent("tagremove");Ext.getCmp("cmsShell").resizeContainerHeight();}}}]});this.advancedSettingsSection.add({xtype:"container",layout:"column",cls:"column_container",items:[{xtype:"label",text:gt.gettext("BCC address:"),width:this.advancedSettingsLabelWidth},{xtype:"checkbox",id:"bcc_enabled",name:"bcc_enabled",boxLabel:gt.gettext("Enable BCC"),checked:J.bcc_enabled=="1",listeners:{check:function(){var al=Ext.getCmp("grid_enter_bcc_address");var ak=Ext.getCmp("bcc_from_affiliate_client_list");if(this.checked){al.enable();ak.enable();}else{al.disable();ak.disable();}}}}],listeners:{afterrender:function(){if(ECM.Stash.bcc_enabled){this.show();}else{this.hide();}}}});this.advancedSettingsSection.add({xtype:"container",layout:"column",items:[{xtype:"label",text:"",width:this.advancedSettingsLabelWidth,},{xtype:"combo",id:"bcc_from_affiliate_client_list",name:"bcc_from_affiliate_client_list",fieldLabel:gt.gettext(""),store:this.getBCCOptions(),mode:"local",editable:false,forceSelection:true,triggerAction:"all",displayField:"option",valueField:"id",value:J.bcc_from||"",listeners:{afterrender:function(){if(Ext.getCmp("bcc_enabled").checked){this.enable();}else{this.disable();}},select:function(){if(this.value=="list"){Ext.getCmp("grid_enter_bcc_address").enable();Ext.getCmp("grid_enter_bcc_address").show();}else{Ext.getCmp("grid_enter_bcc_address").disable();Ext.getCmp("grid_enter_bcc_address").hide();}Ext.getCmp("cmsShell").resizeContainerHeight();}}}],listeners:{afterrender:function(){if(ECM.Stash.bcc_enabled){this.show();}else{this.hide();}}}});this.advancedSettingsSection.add({xtype:"container",layout:"column",items:[{xtype:"label",text:"",width:this.advancedSettingsLabelWidth,},{xtype:"ecm.client.admin.bccaddresseditorgrid",id:"grid_enter_bcc_address",name:"grid_enter_bcc_address",bccAddressStore:y.bccAddressStore,fieldLabel:" ",labelSeparator:" ",width:600,style:{marginBottom:"10px"},listeners:{afterrender:function(){if(Ext.getCmp("bcc_enabled").checked){this.enable();
}else{this.disable();}if(Ext.getCmp("bcc_from_affiliate_client_list").getValue()=="list"){this.show();}else{this.hide();}}}}],listeners:{afterrender:function(){if(ECM.Stash.bcc_enabled){this.show();}else{this.hide();}}}});if(J.mailing_type==ECM.CMS.BULK_MAILING){var G=this.advancedSettingsFieldWidth-46;if(J.tester.tester_lists&&J.tester.tester_lists.length>0){var O=new Ext.form.ComboBox({typeAhead:true,valueNotFoundText:"",triggerAction:"all",mode:"local",hiddenName:"tester_list_id",id:"settingsTesterListSelect",width:G,store:new Ext.data.JsonStore({root:"tester_lists",autoLoad:true,fields:["id","name"],data:J.tester}),valueField:"id",displayField:"name",value:J.tester.list_id||"",listeners:l,validator:function(al){var ak=Ext.getCmp("settingsTesterRadio");if(!al&&ak&&ak.getValue()){return gt.gettext("You need to select a tester from the list.");}return true;}});this.advancedSettingsSection.add({xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Tester Group:"),width:this.advancedSettingsLabelWidth},{xtype:"radio",boxLabel:"  ",name:"use_tester_list",id:"settingsTesterRadio",checked:(J.tester.use_tester_list?true:false),value:"Y",inputValue:"Y",listeners:{check:function(){O.validate();},focus:function(){ECM.Flare.onFocus("FLARE_SETTINGS_ADVANCED");},blur:function(){ECM.Flare.onBlur("FLARE_SETTINGS_MAIN");}}},{xtype:"spacer",height:10,width:25},O]});}this.advancedSettingsSection.add({xtype:"container",layout:"column",height:100,items:[{xtype:"label",text:gt.gettext("Testers2:"),width:this.advancedSettingsLabelWidth},{xtype:"radio",boxLabel:"  ",name:"use_tester_list",id:"settingsTesterListRadio",checked:(J.tester.use_tester_list?false:true),value:"N",inputValue:"N",listeners:l},{xtype:"spacer",height:10,width:25},{xtype:"textarea",width:G,height:95,name:"testers",id:"settingsTesters",value:J.tester.testers,overFlow:"auto",autoScroll:true,listeners:l}]});}this.advancedSettingsSection.add({xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Notes:"),width:this.advancedSettingsLabelWidth},{xtype:"textarea",width:this.advancedSettingsFieldWidth,height:120,name:"description",id:"settingsDescription",value:J.description,overFlow:"auto",autoScroll:true,listeners:l}]});if(J.feature_permissions.PA_PRIV){var K=J.billing;if(J.mailing_type==ECM.CMS.BULK_MAILING&&K){this.advancedSettingsSection.add({xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Billing contact:"),width:110},{xtype:"textfield",width:329,name:"billing_contact",id:"settingsBillingContact",value:K.contact,listeners:l},{xtype:"spacer",height:10,width:25},{xtype:"label",text:gt.gettext("Charge event fee:"),width:120},{xtype:"spacer",height:1,width:5},{xtype:"combo",editable:false,triggerAction:"all",mode:"local",hiddenName:"charge_fees",id:"settingsChargeFee",store:[[0,gt.gettext("No")],[1,gt.gettext("Yes")]],valueField:"id",displayField:"name",cls:"yesno_combo",value:K.charge_fees||0,listeners:l}]});}}this.advancedSettingsSection.add({cls:"cms-settings-header-line",autoEl:{tag:"div"}});this.advancedSettingsSection.add({xtype:"label",text:gt.pgettext("noun","Content"),cls:"cms-settings-header"});this.contentSectionLabelWidth=150;this.advancedSettingsSection.add({xtype:"container",layout:"column",height:30,items:[{xtype:"label",text:gt.gettext("Formats:"),width:this.contentSectionLabelWidth},{xtype:"checkbox",boxLabel:gt.gettext("HTML"),width:55,checked:(J.remote_content||J.format_include.html?true:false),disabled:(J.remote_content?true:false),name:"format_include",id:"settingsFormatHtml",value:"html",inputValue:"html",listeners:l},{xtype:"checkbox",boxLabel:gt.pgettext("e-mail format","Text")+"  ",width:55,checked:(J.remote_content||J.format_include.text?true:false),disabled:(J.remote_content?true:false),name:"format_include",id:"settingsFormatText",value:"text",inputValue:"text",listeners:l},{xtype:"checkbox",boxLabel:gt.gettext("Rich Text"),width:85,checked:(J.remote_content||J.format_include.rich_text?true:false),disabled:(J.remote_content?true:false),value:"rich_text",name:"format_include",id:"settingsFormatRichText",inputValue:"rich_text",listeners:l}]});if(this.mediator.show_social_media){this.advancedSettingsSection.add({xtype:"container",layout:"column",height:30,items:[{xtype:"label",text:gt.gettext("Include social media?"),width:this.contentSectionLabelWidth},{xtype:"combo",store:new Ext.data.ArrayStore({fields:["id","display_string"],data:(function(){var ak=[[0,gt.gettext("No")]];if(J.has_social_media){ak.push([1,gt.gettext("Yes")]);}return ak;})()}),valueField:"id",displayField:"display_string",mode:"local",hiddenName:"has_social_media",triggerAction:"all",forceSelection:true,editable:false,value:J.has_social_media||0,listeners:{focus:function(){ECM.Flare.onFocus("FLARE_SETTINGS_ADVANCED");},blur:function(){ECM.Flare.onBlur("FLARE_SETTINGS_MAIN");},change:function(an,am){if(!am){var al=function(){ECM.publish("/cms/error/add",{message:gt.gettext("Could not clear social media content")});an.setValue(1);};var ak=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Clearing social media content ...")});ak.show();ECM.Ajax.request({url:"/cm/mailing/settings/get_mailing_has_social_media",params:{mid:J.mid},success:function(aq){var ao=Ext.decode(aq.responseText);if(!ao.error||ao.error.length){al();}else{if(ao.data){if(ao.data.has_social_media){var ap=new ECM.CMS.Modal.ConfirmSocialMediaContentDeletion({formControl:an,mask:ak,failureAlertCallback:al,mailingId:J.mid}).show();}}else{al();}}ak.hide();},failure:function(){ak.hide();}});}}}}]});}var x=new Ext.data.JsonStore({root:"list",fields:["id","name"],autoLoad:true,data:J.charset});x.sort("name");var c=new Ext.form.ComboBox({typeAhead:true,valueNotFoundText:"",allowBlank:false,triggerAction:"all",mode:"local",hiddenName:"character_set",id:"settingsCharacterSetSelect",store:x,valueField:"id",displayField:"name",width:220,listeners:l,value:J.charset.selected});var w=new Ext.form.ComboBox({typeAhead:true,valueNotFoundText:"",allowBlank:false,triggerAction:"all",mode:"local",hiddenName:"encode_rfc2047",id:"settingsEncodeHeaders",store:[[0,gt.gettext("No")],[1,gt.gettext("Yes")]],valueField:"id",displayField:"name",cls:"yesno_combo",listeners:l,value:J.headers.encode_rfc2047||0});this.advancedSettingsSection.add({xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Character Set:"),width:this.contentSectionLabelWidth},c,{xtype:"spacer",height:10,width:10},{xtype:"label",text:gt.gettext("Encode Headers:"),width:125},w]});if(J.mailing_type==ECM.CMS.BULK_MAILING){var ai=[{xtype:"label",text:gt.gettext("Send only if new content found:"),style:{marginLeft:"155px"}},{xtype:"radio",boxLabel:gt.gettext("Yes"),name:"newonly",id:"newonlyTrue",inputValue:1,style:{marginLeft:"3px"},checked:J.remote_content_newonly==1?true:false},{xtype:"radio",boxLabel:gt.gettext("No"),name:"newonly",id:"newonlyFalse",inputValue:0,style:{marginLeft:"3px"},checked:J.remote_content_newonly==1?false:true}];this.advancedSettingsSection.add({xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Content Location:"),width:this.contentSectionLabelWidth},{xtype:"combo",valueNotFoundText:"",allowBlank:false,hiddenName:"remote_content",triggerAction:"all",mode:"local",id:"settingsRemoteContentSelect",store:[[0,gt.gettext("CheetahMail")],[1,gt.gettext("Remote Host")]],width:220,value:J.remote_content||0,listeners:{scope:this,focus:function(){ECM.Flare.onFocus("FLARE_SETTINGS_ADVANCED");},blur:function(){ECM.Flare.onBlur("FLARE_SETTINGS_MAIN");},afterrender:function(al){var ak=Ext.getCmp("newContentOnlyPanel");if(al.getValue()===1){ak.removeAll();ak.add(ai);ak.doLayout();ak.expand();}},select:function(am,ak){var al=Ext.getCmp("newContentOnlyPanel");Ext.iterate(ak.data,function(ap,ar){var ao=Ext.getCmp("settingsFormatHtml");var aq=Ext.getCmp("settingsFormatText");var an=Ext.getCmp("settingsFormatRichText");if(ar===0){al.collapse();al.removeAll();al.doLayout();ao.setValue(J.format_include.html?true:false);
ao.setDisabled(false);aq.setValue(J.format_include.text?true:false);aq.setDisabled(false);an.setValue(J.format_include.rich_text?true:false);an.setDisabled(false);}else{if(ar===1){al.removeAll();al.add(ai);al.doLayout();al.expand();ao.setValue(true);ao.setDisabled(true);aq.setValue(true);aq.setDisabled(true);an.setValue(true);an.setDisabled(true);}}},this);}}}]},{xtype:"panel",id:"newContentOnlyPanel",layout:"column",animCollapse:true,collapsed:true,listeners:{collapse:function(){Ext.getCmp("cmsShell").resizeContainerHeight();},expand:function(){Ext.getCmp("cmsShell").resizeContainerHeight();},afterlayout:function(){Ext.getCmp("cmsShell").resizeContainerHeight();}}});}var T=false;var h=function(){if(T){return;}v.advancedSettingsSection.add([{cls:"cms-settings-header-line",autoEl:{tag:"div"}},{xtype:"label",text:gt.gettext("Delivery Options"),cls:"cms-settings-header"}]);T=true;};if(J.mailing_type==ECM.CMS.BULK_MAILING&&J.flowrate&&J.retry){h();var ae=new Ext.form.ComboBox({typeAhead:true,valueNotFoundText:"",allowBlank:false,triggerAction:"all",mode:"local",hiddenName:"flowrate",id:"settingsFlowrateSelect",store:new Ext.data.JsonStore({root:"list",autoLoad:true,fields:["id","label","rate"],data:J.flowrate}),valueField:"id",displayField:"label",value:J.flowrate.selected,listeners:l});this.advancedSettingsSection.add({xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Flowrate:"),width:100},ae]});var ah=new Ext.form.ComboBox({typeAhead:true,valueNotFoundText:"",allowBlank:false,triggerAction:"all",mode:"local",hiddenName:"retry",id:"settingsRetrySelect",store:new Ext.data.JsonStore({root:"list",fields:["id","label"],autoLoad:true,data:J.retry}),valueField:"id",displayField:"label",value:J.retry.selected,listeners:l});this.advancedSettingsSection.add({xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Retry Limit:"),width:100},ah]});}if(Number(ECM.Stash.tls_enabled)){h();var j=new Ext.form.ComboBox({typeAhead:true,valueNotFoundText:"",allowBlank:false,triggerAction:"all",mode:"local",hiddenName:"tls_encrypt",id:"settingsTlsEncryptSelect",store:new Ext.data.JsonStore({fields:["id","label"],data:[{id:0,label:gt.gettext("Off")},{id:1,label:gt.gettext("On (opportunistic)")}]}),valueField:"id",displayField:"label",value:Ext.isEmpty(J.tls_encrypt)?1:J.tls_encrypt,listeners:l});this.advancedSettingsSection.add({xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("TLS Encryption:"),width:100},j]});}if(J.feature_permissions.PA_PRIV&&J.ip_warming&&J.ip_warming.available){var Y=[];if(J.ip_warming.have_established_mtas){Y.push([0,gt.strargs(gt.gettext("Established IPs (%1)"),J.ip_warming.established_mta_count)]);}else{Y.push([0,gt.gettext("Shared Network")]);}Y.push([1,gt.strargs(gt.gettext("Warming IPs (%1)"),J.ip_warming.mta_count)]);var H=new Ext.form.ComboBox({typeAhead:true,valueNotFoundText:"",allowBlank:false,triggerAction:"all",mode:"local",hiddenName:"ip_warming",id:"settingsIPWarming",store:Y,value:J.ip_warming.enabled});this.advancedSettingsSection.add({xtype:"container",layout:"column",items:[{xtype:"label",text:gt.gettext("Send Via:"),width:100},H]});}if(J.is_pk_client){this.advancedSettingsSection.add({xtype:"container",layout:"column",height:30,items:[{xtype:"label",text:gt.gettext("One Message Per:"),width:125},{xtype:"radio",boxLabel:gt.gettext("subscriber"),inputValue:0,id:"settingsUniqueBySubscriber",name:"uniq_by_email",checked:(J.uniq_by_email?false:true),width:100},{xtype:"radio",boxLabel:gt.pgettext("e-mail address","email"),inputValue:1,id:"settingsUniqueByEmail",name:"uniq_by_email",checked:(J.uniq_by_email?true:false),width:65}]});}this.advancedSettingsSection.add([{cls:"cms-settings-header-line",autoEl:{tag:"div"}},{xtype:"label",text:gt.gettext("Reporting Options"),cls:"cms-settings-header"},{cls:"cms-settings-subheader-line",autoEl:{tag:"div"}},{xtype:"label",text:"Tracking",cls:"cms-settings-subheader"}]);if(J.mailing_type==ECM.CMS.BULK_MAILING){this.advancedSettingsSection.add({xtype:"container",layout:"form",cls:"tracking_container",items:[{xtype:"combo",fieldLabel:gt.gettext("By Source:"),labelStyle:"width:125px",valueNotFoundText:"",allowBlank:false,width:250,hiddenName:"track_source",id:"settingsTrackSourceSelect",triggerAction:"all",mode:"local",store:[[0,gt.gettext("None")],[1,gt.pgettext("subscriber list","by List")],[2,gt.gettext("by Affiliate")]],value:J.tracking.track_source||0,listeners:l}]});if(J.feature_permissions.PA_SRCEXT){var a=[];a.push([J.tracking.no_demographic_field,gt.gettext("NONE")]);Ext.each(J.tracking.demotrack_list,function(){a.push([this,this]);});var ab=new Ext.data.ArrayStore({fields:["id","name"],data:a});this.advancedSettingsSection.add({xtype:"container",layout:"form",cls:"tracking_container",items:[{xtype:"combo",fieldLabel:gt.gettext("By Demographics:"),labelStyle:"width:125px;",typeAhead:true,allowBlank:false,valueNotFoundText:"",triggerAction:"all",width:250,hiddenName:"track_demo",hiddenValue:J.tracking.track_demo,id:"settingsTrackDemoSelect",mode:"local",store:ab,valueField:"id",displayField:"name",value:J.tracking.track_demo||"",listeners:l},{xtype:"hidden",name:"demotrack_default",id:"settingsDemotrackDefault",value:J.tracking.demotrack_default||""}]});}}this.advancedSettingsSection.add({xtype:"container",layout:"column",height:30,items:[{xtype:"spacer",height:10,width:25},{xtype:"label",text:gt.pgettext("noun: number of times an e-mail message is opened","Opens:"),width:125},{xtype:"radio",boxLabel:gt.gettext("Yes"),inputValue:1,id:"settingsTrackOpenRadioYes",name:"track_open",checked:(J.tracking.track_open?true:false),width:65,listeners:l},{xtype:"radio",boxLabel:gt.gettext("No"),inputValue:0,id:"settingsTrackOpenRadioNo",checked:(J.tracking.track_open?false:true),name:"track_open",listeners:l}]});if(J.mailing_type==ECM.CMS.BULK_MAILING&&J.feature_permissions.PA_TRACKSEND){this.advancedSettingsSection.add([{xtype:"container",layout:"form",cls:"tracking_container",items:[{xtype:"textfield",fieldLabel:gt.pgettext("thing, not verb","Link Prefix:"),labelStyle:"width:125px;",width:250,name:"link_prefix",id:"settingsLinkPrefix",value:J.tracking.link_prefix,listeners:l}]},{cls:"cms-settings-subheader-line",autoEl:{tag:"div"}}]);}if(J.tracking.external_tracking_options){var q=new ECM.CMS.Panel.ExternalTrackingPanel({mid:J.mid||0});q.populate(J.tracking.external_tracking_options);this.advancedSettingsSection.add(q);}if(J.mailing_type==ECM.CMS.BULK_MAILING&&v.is_template==ECM.CMS.PRODUCT_IS_MAILING&&v.mailingHasSLT(J)){this.displaySubjectLineTest(J,V,"");}if(v.is_template==ECM.CMS.PRODUCT_IS_MAILING&&v.mediator.workflow_wizard){this.workflow.turnOn();this.workflow.setCurrentPage({pageName:"settings",mailingConfig:J.format_include});}this.innerPanel.doLayout();this.doLayout();if(!v.mailingHasSLT(J)){v.generateCodeMirrorField(k,V,"settingsSubject","450px","true",ECM.CMS.NOT_SLT);}v.generateCodeMirrorField(k,V,"settingsReplyTo","270px","false",ECM.CMS.NOT_SLT);v.generateCodeMirrorField(k,V,"settingsFromAddress","250px","false",ECM.CMS.NOT_SLT);v.generateCodeMirrorField(k,V,"settingsFromName","270px","false",ECM.CMS.NOT_SLT);var u=new ECM.Config.FeatureHelp.CMS();ECM.FeatureHelp.setFeatureHelp(u);this.mediator.subscribe("/cms/leave_tab",function(){ECM.FeatureHelp.hideAllTooltips();});if(!v.mailingHasSLT(J)){ECM.FeatureHelp.showAllTooltips();}if(Ext.isIE||Ext.isWebKit){Ext.select(".north_cm_box_hd").setStyle({overflow:"hidden"});if(Ext.isIE7||Ext.isIE6){var s=Ext.get("cmsCenterRegionId");if(s){s.setStyle({"overflow-x":"hidden"});}}}this.loadTagsCombo(J.availableTags.data);this.loadSelectedTags(J.availableTags.data,J.addedTags);this.clearDirty();Ext.getCmp("cmsShell").resizeContainerHeight();this.mediator.subscribe("/cms/leave_tab",function(){var ak=ECM.Form.DCEditor.data("DC");var al=Ext.getCmp("leftnav_panel");Ext.iterate(al.libTags,function(am,an){delete ak[0][am];});al.libTags={};al.dcLibOverwrite=[];v.mediator.removeSubscribers("/cms/leave_tab");
});},displaySubjectLineTest:function(h,f,g){var d=this;var b=0;if(h.subject_line_test!==undefined){b=h.subject_line_test.can_send_remainder;}var a=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Loading Subject Line Test...")});a.show();var c=new Ext.form.FieldSet({title:(b?"":gt.gettext("EDIT "))+gt.gettext("SUBJECT LINE TEST"),collapsible:true,cls:"slt-editor",id:"cms-settings-slt",baseCls:"grey-x-panel x-panel",listeners:{collapse:function(){Ext.getCmp("cmsShell").resizeContainerHeight();},expand:function(){Ext.getCmp("cmsShell").resizeContainerHeight();},afterlayout:function(){Ext.getCmp("cmsShell").resizeContainerHeight();}}});this.envelopeSection.add(c);ECM.CMS.Panel.SubjectLineTest.Display({load_args:{mid:h.mid,cid:h.cid},destination:c,data:g,load_url:"/cm/mailing/subjectlinetest",save_url:"m/mailers/mailings/slt",parserConfig:f,onReady:function(){d.doLayout(false,true);a.hide();ECM.FeatureHelp.showAllTooltips();}});},mailingHasSLT:function(a){return this.hasOwnProperty("hasSLT")?this.hasSLT:(a.subject_line_test&&a.subject_line_test.hasOwnProperty("children")&&a.subject_line_test.children.length>0);},formatFromName:function(a){return"'"+a+"'";},formatFromEmail:function(a){return"< "+a+" >";},formatFromAddress:function(b,a){return this.formatFromName(b)+" "+this.formatFromEmail(a);},getCodeMirrorActiveComponent:function(){if(this.activeDropObj){return this.activeDropObj;}else{return false;}},removeCodeMirrorSubjectLine:function(){var a=document.getElementById("settingsSubject");if(Ext.isDefined(a.parentNode.childNodes[2])){a.parentNode.removeChild(a.parentNode.childNodes[2]);}},setSegmentValue:function(b){var a=Ext.getCmp("settingsSegmentSelect");a.setValue(b);a.originalValue=a.getValue();},addSubjectTextField:function(a){Ext.getCmp("subjectItemsContainer").add({xtype:"textfield",name:"subject",id:"settingsSubject",width:250,value:a});},addNewSubjectLineTestLink:function(b,d,c){var a=this;Ext.getCmp("subjectItemsContainer").add({xtype:"label",id:"createSLT",html:gt.gettext("Test Subject Line"),cls:"cms-label-no-left-padding label_link",width:100,listeners:{render:function(){this.el.on("click",function(h,j){ECM.FeatureHelp.hideAllTooltips();var k=function(l){var n=ECM.CMS.Panel.SubjectLineTest.Form(l);var m=function(){l.addClass("okToClose");l.close();};if(n&&n.isDirty()){Ext.MessageBox.buttonText.ok=gt.gettext("Yes");Ext.Msg.show({title:gt.gettext("Cancel Subject Line Test"),msg:gt.gettext("Your selection will not be saved. Do you want to continue?"),buttons:Ext.Msg.OKCANCEL,cls:"cm_text_align_left blue_button",fn:function(o){if(o==="ok"){m();}}});}else{m();}};var g=new ECM.Window({title:gt.gettext("Create Subject Line Test"),items:[],listeners:{beforeclose:function(l){if(!l.getEl().hasClass("okToClose")){k(l);return false;}}},cls:"slt-editor",bodyStyle:"position:relative; overflow-x: hidden; overflow-y:auto;",width:680,height:520,autoHeight:false,draggable:false,layout:"form"});var f=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Loading...")});f.show();ECM.CMS.Panel.SubjectLineTest.Display({popupWindow:true,destination:g,onReady:function(){g.show();f.hide();},onSave:function(m){var l=new Ext.LoadMask(g.getEl(),{msg:gt.gettext("Saving Subject Line Test...")});l.show();return function(n){l.hide();if(n&&!n.recoverable){var o=new ECM.Window({title:gt.gettext("Subject Line Test Alert"),cls:"slt-save-error",buttons:[{text:gt.gettext("OK"),cls:"blue_button",handler:function(q,p){ECM.CMS.Panel.SubjectLineTest.Util().ctxtParent(q,".slt-save-error").close();}}],items:[{xtype:"box",html:gt.gettext("The following errors occurred when attempting to save the Subject Line Test")},{xtype:"container",autoEl:"ul",cls:"ux-unordered-list slt_exist_alert_popup",layout:"column",items:n.list.map(function(p){return{xtype:"box",autoEl:"li",style:"color: #ed1951",html:p+""};})}],autoscroll:true,draggable:false,layout:"column"});g.addClass("okToClose").close();o.show();}else{if(!n){a.hasSLT=true;Ext.getCmp("samplesContainer").hide();Ext.getCmp("settingsSampleSelect").setValue("Not Sampled");Ext.getCmp("settingSamplePercent").setValue("");g.addClass("okToClose").close();if(m){ECM.CMS.Panel.SubjectLineTest.LaunchAllOptionsWindows({mid:b,panel:a});}}}};},onCancel:function(){if(k(g)){g.close();}},load_args:{mid:b,cid:d},load_url:"/cm/mailing/subjectlinetest",save_url:"m/mailers/mailings/slt",parserConfig:c});});}}});},resetSLTInput:function(a,c,b){this.addSubjectTextField("");this.addNewSubjectLineTestLink(a,c,b);this.doLayout();this.generateCodeMirrorField(ECM.CMS.BULK_MAILING,b,"settingsSubject","450px","true",ECM.CMS.NOT_SLT);},removeSLTInput:function(){this.removeCodeMirrorSubjectLine();Ext.getCmp("subjectItemsContainer").remove("createSLT");Ext.getCmp("subjectItemsContainer").remove("settingsSubject");},removeInlineSLT:function(){Ext.getCmp("envelopeSection").remove("cms-settings-slt");Ext.getCmp("subjectItemsContainer").remove("settingsSubject");Ext.getCmp("subjectItemsContainer").remove("settingsSubjectHidden");},addSubjectLabel:function(a){Ext.getCmp("subjectItemsContainer").add({xtype:"label",width:450,id:"settingsSubject",cls:"cms-label-no-left-padding",text:a},{xtype:"label",name:"subject",id:"settingsSubjectHidden",cls:"cms-label-no-left-padding",value:a});},generateCodeMirrorField:function(f,h,c,d,g,l){var a=this;var k="cm_"+c;var b=0;if(l){var j=ECM.CMS.Panel.SubjectLineTest.Util();}if(document.getElementById(c)){a[k]=CodeMirror.fromTextArea(document.getElementById(c),{mode:{name:"dcP13n",htmlMode:true,dcP13n:h,mtype:f},tabMode:"default",lineNumbers:false,disable:a.mediator.role=="MAILING_PRODUCER"?{personalization:false,dynamicContent:true}:{personalization:false,dynamicContent:false},type:"textfield",width:d,id:k,onFocus:function(){a.activeDropObj=a[k];if(l){var m=Ext.getCmp(c);j.ctxtParent(m,".candidate").fireEvent("arrival",m);}else{ECM.Flare.onFocus("FLARE_SETTINGS_ENVELOPE");}},onBlur:function(){if(l){var m=Ext.getCmp(c);j.ctxtParent(m,".candidate").fireEvent("update",m);j.ctxtParent(m,".candidate").fireEvent("departure",m);}else{ECM.Flare.onBlur("FLARE_SETTINGS_MAIN");}},onChange:function(){if(Ext.isDefined(a[k])){var m=a[k].getValue();if(c=="settingsSubject"||l){if(b){b=0;return;}if(m.length>=ECM.CMS.MAX_SUBJECT_LEN){m=m.substring(0,ECM.CMS.MAX_SUBJECT_LEN);b=1;a[k].setValue(m);a[k].setCursor(0,ECM.CMS.MAX_SUBJECT_LEN);}}Ext.getCmp(c).setValue(m);if(g=="false"){if(m){a[k].setValid();}else{a[k].setInvalid();}}}}});a.codeMirrorObjects.push(a[k]);if(g=="false"){a.attachCodeMirrorValidateEvent(c,a[k]);}}},resetCodeMirror:function(a){var b=this;this.parserConfig.dc=a;Ext.each(this.codeMirrorObjects,function(c){c.setOption("mode",{name:"dcP13n",htmlMode:true,dcP13n:b.parserConfig,mtype:b.parserConfig.mtype});c.refresh();});},onActivate:function(a){if(Ext.isDefined(a.tester)&&!a.tester.list_id){var c=Ext.getCmp("settingsTesterListSelect");if(Ext.isDefined(c)){var b=c.store.data.items[0].id;c.setValue(b);}this.clearDirty();}},attachCodeMirrorValidateEvent:function(b,a){Ext.getCmp(b).validate=Ext.getCmp(b).validate.createSequence(function(){if(this.getActiveError()){a.setInvalid();}else{a.setValid();}});},getTags:function(c){var b=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Loading Tags...")});b.show();var a=this;ECM.Ajax.request({url:"/cm/r/tag/tags",method:"GET",params:{sort:"value"},success:function(d){b.hide();var f=d.responseJSON.data.data;a.loadTagsCombo(f);a.loadSelectedTags(f,c);Ext.getCmp("cmsShell").resizeContainerHeight();},failure:function(d){b.hide();a.publish("/cms/error/add",{message:gt.gettext("Could not load mailing tag.")});}});},clearTagCombo:function(){this.advancedSettingsSection.tagselection.clear();},loadTagsCombo:function(a){var b=new Ext.data.ArrayStore({autoDestroy:true,fields:["tag_id","value","count"],data:a});this.advancedSettingsSection.tagselection.setStore(b);},loadSelectedTags:function(a,b){b=this.advancedSettingsSection.tagselection.sortTagsByAlphabet(a,b);
this.advancedSettingsSection.tagselection.setValue(b||[]);},createBCCAddressStore:function(){var a=[];if(this.data&&Ext.isDefined(this.data.bcc_addr)){a=this.data.bcc_addr.split(",");}return new Ext.data.JsonStore({autoDestroy:true,data:(this.data&&Ext.isDefined(this.data.bcc_addr))?a:{},idProperty:"address",fields:this.bccAddressListRec});},bccAddressListRec:Ext.data.Record.create([{name:"address",mapping:"email",type:"string"}])});ECM.provide("ECM.CMS.Panel.Checklist.Abstract");ECM.CMS.Panel.Checklist.Abstract=Ext.extend(Ext.Panel,{collapsible:true,border:false,baseCls:"grey-x-panel x-panel",labelTitle:"",lastModifiedDate:"",pubEvent:"",startPanel:"checklist",baseURL:document.location.protocol+"//"+document.domain+document.location.pathname,listeners:{collapse:function(){Ext.getCmp("cmsShell").resizeContainerHeight();},expand:function(){Ext.getCmp("cmsShell").resizeContainerHeight();}},headerCfg:{tag:"div",cls:"x-panel-header",children:[{tag:"div",cls:"x-panel-header-title"},{tag:"div",cls:"checklist-section-header-extra"}]},initComponent:function(){var a={};this.buildConfig(a);Ext.apply(this,Ext.apply(this.initialConfig,a));ECM.CMS.Panel.Checklist.Abstract.superclass.initComponent.call(this);},buildConfig:function(a){this.buildItems(a);},buildItems:function(a){a.items=undefined;},createInnerPanel:function(a){return undefined;},redraw:function(b){this.removeAll(true);var a=this.createInnerPanel(b);if(a){this.add(a);this.doLayout();return true;}else{this.add({html:gt.gettext("No data found")});this.doLayout();return false;}},renderLabel:function(a){return{html:ECM.Adapter.isEffective(a.label_href)?'<a href="'+a.label_href+'">'+a.label+"</a>: ":a.label+": ",style:"font-weight: bold;padding: 4px;"+(a.error_severity==="error"?"color:#ed1951":"")};},renderRow:function(c){var b={html:""};if(c.is_list===1){var a=c.value.map(this.renderListItem);if((a.length>=1&&a[0].length>20)||(c.is_slt===1)){b.html+=a.join("<br />");}else{b.html+=a.join(", ");}if(Ext.isDefined(c.error_severity)&&!Ext.isEmpty(c.error_severity)){b.style="color: #ed1951";if(ECM.Adapter.isEffective(c.error)){b.html=c.error;}}}else{if(Ext.isDefined(c.error_severity)&&!Ext.isEmpty(c.error_severity)){b={html:(c.error_severity==="error"?"! ":"")+(Ext.isDefined(c.error)&&c.error.length>=1?c.error:c.value),style:"color: #ed1951"};}else{if(Ext.isDefined(c.href)&&!Ext.isEmpty(c.href)){b.html+='<a href="'+c.href+'">'+c.href_text+"</a>";b.html+=(ECM.Adapter.isEffective(c.value)?c.value:"");}else{if(Ext.isDefined(c.value)){b.html+=(ECM.Adapter.isEffective(c.value)?Ext.util.Format.htmlEncode(c.value):"");}}}}return b;},renderListItem:function(a){if(Ext.isString(a)){return a;}else{if(ECM.Adapter.isEffective(a.value)){return a.value;}else{if(ECM.Adapter.isEffective(a.message)){return a.tag+" [ "+a.message+" ]";}else{return a.tag;}}}},renderToPanel:function(a,b){if(b.is_list===1){if(ECM.Adapter.isArray(b.value)){if(b.value.length>0||b.error){a.add([this.renderLabel(b),this.renderRow(b)]);}}}else{a.add([this.renderLabel(b),this.renderRow(b)]);}},renderEditRow:function(){var c=Ext.urlDecode(document.location.search.substr(1));var a=this.baseURL+"?"+Ext.urlEncode(c)+(this.startPanel?"#"+this.startPanel:"");var b=[{html:this.lastModifiedDate?gt.gettext("Last modified : ")+this.lastModifiedDate:"",cls:"cm_float_left cm_font_bold cm_padding_5"},{html:"<a onclick=\"return function() { var ob = new Ext.util.Observable();ob.publish('"+this.pubEvent+'\'); return false; } ();" href="'+a+'">Edit</a>',cls:"cm_float_right cm_padding_5"}];return{html:b};},renderGroupHeader:function(a){if(ECM.Adapter.isEffective(a.error)){return[{html:a.label,style:"font-weight: bold;padding-left: 2px"},{html:(a.error_severity==="error"?"! ":"")+a.error,style:"color: #ed1951"}];}else{if(ECM.Adapter.isEffective(a.value)){return[{html:a.label,style:"font-weight: bold;padding-left: 2px"},{html:a.value}];}else{return{colspan:2,html:a.label,style:"font-weight: bold;padding-left: 2px"};}}},onRender:function(b,a){ECM.CMS.Panel.Checklist.Abstract.superclass.onRender.call(this,b,a);this.setPanelTitle();},setLabelTitle:function(a){this.labelTitle=a;this.setPanelTitle();},setPanelTitle:function(){this.header.child(".x-panel-header-title").update(this.labelTitle);},setNumOfFatalErrors:function(a){if(a<=0){return;}var b=gt.strargs(gt.ngettext("1 Error","%1 Errors",a),a);this.header.child(".checklist-section-header-extra").update('<img src="/images/warning_icon.gif"> '+b);}});ECM.provide("ECM.CMS.Panel.Checklist.Settings");(function(){var a=ECM.CMS.Panel.Checklist;a.Settings=Ext.extend(ECM.CMS.Panel.Checklist.Abstract,{labelTitle:gt.gettext("SETTINGS"),startPanel:"settings",collapsed:false,rowsData:{envelope:0,data:1,advanced_settings:2,reporting_options:3},renderRow:function(c){var b=a.Settings.superclass.renderRow.call(this,c);if(Ext.isDefined(c.href)&&!Ext.isEmpty(c.href)){b.html='<a href="'+c.href+'">'+c.href_text+"</a>";b.html+=(ECM.Adapter.isEffective(c.value)?c.value:"");}if(c.count_info){b.html+="<br />"+c.count_info;}return b;},createInnerPanel:function(f){if(!f.settings){return undefined;}var d=this;d.lastModifiedDate=f.settings.last_modified||"";var c=f.settings.error_count||0;d.setNumOfFatalErrors(c);d.pubEvent="/cms/load/settings";var b=new Ext.Panel({layout:"table",layoutConfig:{columns:2,tableAttrs:{style:{width:"100%"}}},cls:"ecm-checklist-settings",collapsible:false,items:[{rowspan:2,width:"100%",items:[d.createTablePanel(f.settings.rows[d.rowsData.envelope],false),d.createTablePanel(f.settings.rows[d.rowsData.data],false)]},{rowspan:2,width:"100%",items:[d.createTablePanel(f.settings.rows[d.rowsData.advanced_settings],false),d.createTablePanel(f.settings.rows[d.rowsData.reporting_options],true)]}]});return new Ext.Panel({items:[d.renderEditRow(),b]});},createTablePanel:function(f,d){var b=new Ext.Panel({layout:"table",baseCls:"grey-x-panel x-panel",cls:"ecm-checklist-table",layoutConfig:{columns:2},border:false,header:true,collapsible:d,collapsed:d,listeners:{expand:function(g){Ext.getCmp("cmsShell").resizeContainerHeight();},collapse:function(){Ext.getCmp("cmsShell").resizeContainerHeight();}}});var c=[];b.setTitle(f.label);c.push(this.renderSectionContent(f.rows));b.add(c);return b;},renderSectionContent:function(c){var b=[];Ext.each(c,function(f){if(Ext.isDefined(f.is_group)&&f.is_group){b.push(this.renderSubHeader(f.label));b.push(this.renderSectionContent(f.rows));}else{b.push(this.renderLabel(f));var d=this.renderRow(f);d.cellCls="ecm-checklist-settings-word-wrap";d.cls="ecm-checklist-settings-word-wrap";b.push(d);}},this);return b;},renderSubHeader:function(b){return{colspan:2,html:b,style:"font-weight: bold;"};}});})();ECM.provide("ECM.CMS.Panel.Checklist.Content");(function(){var a=ECM.CMS.Panel.Checklist;a.Content=Ext.extend(ECM.CMS.Panel.Checklist.Abstract,{labelTitle:gt.gettext("CONTENT"),startPanel:"content",collapsed:true,createInnerPanel:function(h){var j=0;var g=this;g.pubEvent="/cms/load/content";if(!h.content){return undefined;}g.lastModifiedDate=h.content.last_modified||"";var b=new Ext.Panel({header:true,collapsible:false});b.add(this.renderEditRow());var f=h.content.rows;var d=undefined;var c=function(){return new Ext.Panel({layout:"table",border:false,baseCls:"grey-x-panel x-panel",cls:"ecm-checklist-table",layoutConfig:{columns:2},header:true,collapsible:false});};Ext.each(f,function(k){if(k.error_severity==="error"){j++;}if(k.is_header===1){if(Ext.isDefined(d)){b.add(d);}d=c();d.setTitle(k.label);}else{if(Ext.isDefined(k.is_group)&&(k.is_group===1)){d.add(this.renderGroupHeader(k));Ext.each(k.rows,function(l){this.renderToPanel(d,l);},this);}else{this.renderToPanel(d,k);}}},this);this.setNumOfFatalErrors(j);if(Ext.isDefined(d)){b.add(d);}return b;}});})();ECM.provide("ECM.CMS.Panel.Checklist.Personalization");(function(){var a=ECM.CMS.Panel.Checklist;a.Personalization=Ext.extend(ECM.CMS.Panel.Checklist.Abstract,{labelTitle:gt.gettext("PERSONALIZATION AND DYNAMIC CONTENT"),startPanel:"content",collapsed:true,pubEvent:"/cms/click/p13n_dyn",renderP13nRow:function(f,b){if(Ext.isDefined(f.error_severity)&&!Ext.isEmpty(f.error_severity)){var c=Ext.isArray(f.error)?f.error.join("<br />"):f.error;
return[{html:f.tag,cls:"cm_error"},{html:""+f["default"],cls:"cm_error"},{html:Ext.isString(f.format)?f.format:f.format.join(","),cls:"cm_error"},{html:c,colspan:2,cls:"cm_error"}];}else{var d=[{html:f.tag},{html:""+f["default"]},{html:Ext.isString(f.format)?f.format:f.format.join(",")}];if(b){d.push({});}return d;}},renderDynContentRow:function(d,b){if(Ext.isDefined(d.error)&&!Ext.isEmpty(d.error)){return[{html:(d.error_severity==="error"?"! ":"")+d.tag,cls:"cm_error"},{html:Ext.isString(d.format)?d.format:d.format.join(","),cls:"cm_error"},{html:d.error,cls:"cm_error"}];}else{var c=[{html:d.tag},{html:Ext.isString(d.format)?d.format:d.format.join(",")}];if(b){c.push({});}return c;}},createInnerPanel:function(f){var h=this;var j=[h.renderEditRow()];this.setLabelTitle(gt.gettext((f.personalization?"PERSONALIZATION AND ":"")+"DYNAMIC CONTENT"));if(!f.dynamic_content){return undefined;}var n={html:""};var m=0;if(f.personalization){if(f.personalization.remote_content){n=new Ext.Panel({title:gt.gettext("Personalization"),padding:10,border:false,items:new Ext.form.Label({html:gt.gettext("Skipped for Remote Content")})});}else{var l=f.personalization;var d=f.personalization.is_error;n=new Ext.Panel({layout:"table",border:false,layoutConfig:{columns:(d)?4:3,extraCls:"cm_padding_5 cm_text_align_center word_break",tableAttrs:{cls:"cm_indent"}},items:[{html:"Tag"},{html:"Default"},{html:"Formats"}],header:true,collapsible:false,cls:"cm_border_table"});if(d){n.add({html:gt.gettext("Remark")});}Ext.each(l.rows,function(o){if(o.error_severity==="error"){m++;}if(o.is_header==1){n.setTitle(o.label);}else{if(o.is_list==1){Ext.each(o.value,function(p){n.add(h.renderP13nRow(p,d));});}}});}j.push(n);}var c;if(f.dynamic_content.remote_content){c=new Ext.Panel({title:gt.gettext("Dynamic Content"),padding:10,border:false,items:new Ext.form.Label({html:gt.gettext("Skipped for Remote Content")})});}else{var k=f.dynamic_content;var g=k.is_error;c=new Ext.Panel({layout:"table",border:false,layoutConfig:{columns:(g)?3:2,extraCls:"cm_padding_5 cm_text_align_center",tableAttrs:{cls:"cm_indent"}},items:[{html:"Tag"},{html:"Formats"}],header:true,collapsible:false,cls:"cm_border_table"});if(g){c.add({html:gt.gettext("Remark")});}Ext.each(k.rows,function(o){if(o.is_header==1){c.setTitle(o.label);}else{if(o.is_list==1){Ext.each(o.value,function(p){if(Ext.isDefined(p.error)&&!Ext.isEmpty(p.error)&&(p.error_severity==="error")){m++;}c.add(h.renderDynContentRow(p,g));});}}});}j.push(c);var b=new Ext.Panel({items:j});this.setNumOfFatalErrors(m);return b;}});})();ECM.provide("ECM.CMS.Panel.Checklist.Approval");(function(){var a=ECM.CMS.Panel.Checklist;a.Approval=Ext.extend(ECM.CMS.Panel.Checklist.Abstract,{title:"APPROVAL",collapsible:false,createInnerPanel:function(f){var g=f.approval;var n=f.pa_perms;var c=""+n.PA_SEGMENT_APPROVER+n.PA_MAILING_SENDER+n.PA_MAILING_APPROVER;var d={SEGMENT_APPROVER:"100",MAILING_CLIENT:"111",MAILING_CLIENT_SENDER:"010",MAILING_CLIENT_APPROVER:"001"};var k=this;var o={messageRow:{},column1:{},column2:{},column3:{},column4:{},column5:{}};var l={};Ext.each(g.rows,function(p){if(p.error){o.messageRow={html:(function(q){return q.charAt(0).toUpperCase()+q.slice(1);})(p.error_severity)+": "+p.error,cls:"cm_error"};}else{l[p.label]={html:p.value};}});Ext.each(["approved","unapprove"],function(p){if(Ext.isDefined(l[p])){k.publish("/cms/alert/clear");k.publish("/cms/alert/add",{message:l[p].html});}});if(Ext.isDefined(g.selects)){var j=g.selects;o.column1=(c==d.MAILING_CLIENT_APPROVER)?[{html:gt.gettext("Mailing Approval: "),colspan:4},{html:gt.gettext("Approval Type: ")}]:{html:gt.gettext("Approval Type: ")};Ext.each(j,function(p){var t=[];var q="";Ext.each(p.choices,function(u){var v=[u.value,u.label];if(u.checked){q=u.value;}t.push(v);});var s=new Ext.form.ComboBox({width:200,id:"ecm-checklist-combobox",allowBlank:false,editable:false,typeAhead:false,triggerAction:"all",store:t,listeners:{focus:function(){ECM.Flare.onFocus("FLARE_CHECKLIST_APPROVAL_TYPE");},blur:function(){ECM.Flare.onBlur("FLARE_CHECKLIST_MAIN");}}});s.setValue(q);o.column2=s;var r=new Ext.Button({text:gt.gettext("Approve"),id:"ecm-checklist-approve",cls:"cm_margin_0_0_0_3 blue_button cm_padding_5",disabled:(p.state=="enabled"?false:true),handler:function(){var v=s.getValue();Ext.fly("cm_wrapper").setHeight(ECM.CMS.STANDARD_LOADING_HEIGHT);var u=new Ext.LoadMask(Ext.get("cm_wrapper"),{msg:gt.gettext("Waiting...")});u.show();ECM.Ajax.request({url:p.action,params:p.params+v+"&aid="+f.aid+"&mid="+f.mid,success:function(w,x){u.hide();k.redraw(w.responseJSON.data);ECM.publish("/cms/updateMailingTitle",{mailing_status:"("+w.responseJSON.data.approved_stat+")"});Ext.getCmp("cmsShell").resizeContainerHeight();ECM.FeatureHelp.showAllTooltips();},failure:function(w,x){u.hide();if(!Ext.isEmpty(w.responseJSON.error)){Ext.Msg.alert(gt.gettext("FATAL"),gt.gettext("Something bad happened: Please contact your administrator"));}else{k.redraw(w.responseJSON.data);}Ext.getCmp("cmsShell").resizeContainerHeight();ECM.FeatureHelp.showAllTooltips();}});}});o.column3=r;});}else{if(Ext.isDefined(g.buttons)){var h={};Ext.each(g.buttons,function(p){h[p.label]=new Ext.Button({text:p.value,cls:"cm_margin_0_0_0_3 blue_button cm_padding_5",id:"ecm-checklist-"+p.label,disabled:(p.state=="enabled"?false:true),requestcallback:function(){},request:function(){Ext.fly("cm_wrapper").setHeight(ECM.CMS.STANDARD_LOADING_HEIGHT);var q=new Ext.LoadMask(Ext.get("cm_wrapper"),{msg:gt.gettext("Waiting...")});q.show();ECM.Ajax.request({url:p.action,params:p.params+"&aid="+f.aid+"&mid="+f.mid,success:function(r,s){q.hide();if(r.responseJSON.data.approval){k.redraw(r.responseJSON.data);ECM.publish("/cms/updateMailingTitle",{mailing_status:"("+r.responseJSON.data.approved_stat+")"});}else{k.publish("/cms/checklist/refresh");}Ext.getCmp("cmsShell").resizeContainerHeight();ECM.FeatureHelp.showAllTooltips();},failure:function(r,s){q.hide();if(!Ext.isEmpty(r.responseJSON.error)){Ext.Msg.alert(gt.gettext("FATAL"),gt.gettext("Something bad happened: Please contact your administrator"));}else{k.redraw(r.responseJSON.data);}Ext.getCmp("cmsShell").resizeContainerHeight();ECM.FeatureHelp.showAllTooltips();}});},handler:function(){this.request();}});});if(Ext.isDefined(h.send_now)){h.send_now.handler=function(){var q=this;var r="";if(Ext.isDefined(f.subject_line_test)&&f.subject_line_test===1&&Ext.isEmpty(f.got_winning_mail)){r="All mailings within this subject line test will go out at the same time, with the exception of the test winner if one is assigned<br>Subject lines included are: <br><br><ul>";Ext.each(f.subject_line_test_subjects,function(s){r+="<li>"+s+"</li>";});r+="</ul><br>";}r+="Are you sure you want to send now? This will send the mailing immediately.";var p=new ECM.Window({title:gt.gettext("Send Now")+": "+(f.name?f.name:""),content:{xtype:"panel",cls:"cm_text_align_left",html:gt.gettext(r)},listeners:{show:function(){ECM.FeatureHelp.hideAllTooltips();}},windowButtons:[{text:gt.gettext("Send Now"),handler:function(t,s){k.publish("/cms/alert/clear");q.request();p.close();}},{text:gt.gettext("Cancel"),handler:function(t,s){p.close();ECM.FeatureHelp.showAllTooltips();}}]});p.show();p.notify.destroy();};}var m=new Ext.Panel({layout:"table",layoutConfig:{columns:2}});Ext.iterate(h,function(p,q){m.add(q);});if(c==d.MAILING_CLIENT){o.column1=(f.approved===0)?{}:{html:gt.gettext("Approval Type: ")};o.column2=l.approval_type||{};o.column2.width=200;o.column3=m||{};}else{if(c==d.SEGMENT_APPROVER){o.column1=l.mailing_approval;o.column1.colspan=4;o.column2=l.mailing_approver||{};o.column2.colspan=4;o.column3=l.segment_approval;o.column3.width=270;o.column4=m;o.column4.colspan=3;o.column5=l.segment_approval_notification||{};o.column5.width=270;}else{if(c==d.MAILING_CLIENT_SENDER){if(Ext.isDefined(l.no_mailing_approvers)){o.column1=l.no_mailing_approvers;o.column1.colspan=4;o.column2=m;}else{if(f.approved!=0){o.column1=l.mailing_approval||{};o.column1.colspan=4;
o.column2=l.mailing_approver||{};o.column2.colspan=4;o.column3=l.segment_approval||{};o.column3.colspan=4;o.column4=l.segment_approver||{};o.column4.colspan=4;o.column5=m||{};}else{o.column1=[{html:gt.gettext("Mailing Approval: ")},h.send_mailing_approval_request,{},{}];o.column2=l.mailing_approval_request_notification||{};o.column2.colspan=4;if(h.send_segment_approval_request){o.column3=[{html:gt.gettext("Segment Approval: ")},h.send_segment_approval_request,{},{}];o.column4=l.segment_approval_request_notification||{};o.column4.colspan=4;}}}}else{if(c==d.MAILING_CLIENT_APPROVER){o.column1=l.mailing_approval;o.column1.width=270;o.column2=m;o.column2.colspan=3;o.column3=l.mailing_approval_notification||{};o.column3.width=270;}else{o.column1=m;}}}}}else{Ext.each(g.rows,function(p){o.messageRow=k.renderRow(p);});}}o.messageRow.colspan=4;var b=new Ext.Panel({id:"ecm-checklist-approval-panel",layout:"table",defaults:{bodyStyle:"padding:5px"},layoutConfig:{columns:4},items:[o.messageRow,o.column1,o.column2,o.column3,o.column4,o.column5]});return b;},buildConfig:function(b){}});})();ECM.provide("ECM.CMS.Panel.Checklist.Schedule");(function(){var a=ECM.CMS.Panel.Checklist;a.Schedule=Ext.extend(ECM.CMS.Panel.Checklist.Abstract,{labelTitle:gt.gettext("SCHEDULE"),pubEvent:"/cms/click/schedule",createInnerPanel:function(g){var d=this;var f=g.schedule.rows;d.lastModifiedDate=g.schedule.last_modified||"";var c=new Ext.Panel({layout:"table",layoutConfig:{columns:2}});var h=0;Ext.each(f,function(j){if(j.error_severity==="error"){h++;}if(j.is_header!=1){c.add([d.renderLabel(j),d.renderRow(j)]);}});var b=new Ext.Panel({items:[d.renderEditRow(),c]});this.setNumOfFatalErrors(h);return b;}});})();ECM.provide("ECM.CMS.Panel.Checklist.Main");(function(){var a=Ext.extend(Ext.Panel,{collapsible:true,collapsed:true,initComponent:function(){var c={expandos:[]};Ext.apply(this,Ext.apply(c,this.initialConfig));a.superclass.initComponent.call(this);},afterRender:function(){if(this.title){this.setTitle(this.title);}this.el.addClass(this.collapsedCls);this[this.collapseEl].hide(this.hideMode);this.initEvents();},expand:function(d){var f=this.expandos;if(!this.collapsed||this.el.hasFxBlock()||this.fireEvent("beforeexpand",this,d)===false){return;}Ext.each(f,function(g){if(g&&g.el&&g!==this&&Ext.isFunction(g.expand)){g.expand(d);}},this);var c=d===true||(d!==false&&this.animCollapse);this.el.removeClass(this.collapsedCls);this.afterExpand(false);return this;},collapse:function(d){var f=this.expandos;if(this.collapsed||this.el.hasFxBlock()||this.fireEvent("beforecollapse",this,d)===false){return;}var c=d===true||(d!==false&&this.animCollapse);this.beforeEffect(c);this.afterCollapse(false);Ext.each(f,function(g){if(g&&g.el&&g!==this&&Ext.isFunction(g.collapse)&&!(g instanceof ECM.CMS.Panel.Checklist.Approval)){g.collapse(d);}},this);return this;}});var b=ECM.CMS.Panel.Checklist;ECM.CMS.Panel.Checklist.Main=Ext.extend(Ext.Panel,{id:"checklist_mainPanel",autoScroll:true,initComponent:function(){this.publish("/cms/alert/clear");this.mtype=this.initialConfig.mtype||1;var c={};this.buildItems(c);this.subToEvent();Ext.apply(this,Ext.apply(this.initialConfig,c));b.Main.superclass.initComponent.call(this);},buildItems:function(c){this.lastSent=new Ext.Panel({collapsible:false,redraw:function(f){this.removeAll(true);if(Ext.isDefined(f.last_sent)){this.add({html:f.last_sent.label+": <a style='text-decoration:underline' href='"+f.last_sent.report_url+"'>"+f.last_sent.date+" ("+f.last_sent.count+")</a>",cls:"cm_padding_2"});}else{this.hide();}this.doLayout();}});c.settingsSection=new b.Settings();c.contentSection=new b.Content();c.personalizationSection=new b.Personalization();c.approvalSection=new b.Approval();if(this.mtype===1){c.scheduleSection=new b.Schedule();}var d=new a({expandos:[c.settingsSection,c.scheduleSection,c.contentSection,c.personalizationSection,c.approvalSection],title:gt.gettext("All"),listeners:{expand:function(f){Ext.getCmp("cmsShell").resizeContainerHeight();},collapse:function(){Ext.getCmp("cmsShell").resizeContainerHeight();}}});c.workflowIndicatorSection=Ext.getCmp("cmsWizardWorkflow");c.items=(this.mtype===1)?[this.lastSent,d,c.settingsSection,c.scheduleSection,c.contentSection,c.personalizationSection,c.approvalSection]:[this.lastSent,d,c.settingsSection,c.contentSection,c.personalizationSection,c.approvalSection];},load:function(){var d=this;if(Ext.isDefined(Ext.getCmp("leftnav_emo"))){Ext.getCmp("leftnav_emo").hide();}var c=new Ext.LoadMask(Ext.get("cm_wrapper"),{msg:gt.gettext("Loading...")});c.show();ECM.Ajax.request({url:"/cm/mailing/checklist",params:{mid:d.mid},success:function(g,h){c.hide();var j=g.responseJSON.data;d.items.each(function(k){if(ECM.Adapter.isFunction(k.redraw)){k.redraw(j);}});Ext.getCmp("cmsShell").resetMailingNavPanelWidth();if(d.workflowIndicatorSection&&!d.is_template&&d.workflow_wizard&&Ext.isDefined(j.format_include)){d.workflowIndicatorSection.turnOn();d.workflowIndicatorSection.setCurrentPage({pageName:"checklist",mailingConfig:j.format_include});}ECM.publish("/cms/updateMailingTitle",{mailing_status:"("+g.responseJSON.data.approved_stat+")"});Ext.getCmp("cmsShell").resizeContainerHeight();var f=new ECM.Config.FeatureHelp.CMS();ECM.FeatureHelp.setFeatureHelp(f);ECM.FeatureHelp.showAllTooltips();d.subscribe("/cms/leave_tab",function(){ECM.FeatureHelp.hideAllTooltips();});},failure:function(f,g){c.hide();d.publish("/cms/error/add",{message:gt.gettext("Failed to correctly render this page. Please try to reload this page again shortly.")});Ext.getCmp("cmsShell").resizeContainerHeight();}});},save:function(){},refresh:function(){this.load();},wasModified:function(){return false;},subToEvent:function(){var c=Ext.getCmp("leftnav_panel");this.subscribe("/cms/click/schedule",function(){c.get(0).expand(true);c._highlightTask("schedule_mailing");c._hideFlyouts();if(Ext.isDefined(c.scheduleFlyout)){c.scheduleFlyout.show();}return false;});this.subscribe("/cms/click/p13n_dyn",function(){this.publish("/cms/load/content");c.get(1).expand(true);return false;});this.subscribe("/cms/schedule/update",function(){this.publish("/cms/load/checklist");return false;});}});})();Ext.ns("ECM.CMS.Panel.Checklist");ECM.provide("ECM.CMS.Panel.Checklist.Mediator");ECM.CMS.Panel.Checklist.Mediator=Ext.extend(ECM.CMS.MediatorInterface,{constructor:function(b){var a=this;this.subscribe("/cms/save",function(){this.save();},this);this.subscribe("/cms/checklist/refresh",function(){this.refresh();},this);this._widget=new ECM.CMS.Panel.Checklist.Main(b);this.load();ECM.CMS.Panel.Checklist.Mediator.superclass.constructor.call(this);},load:function(){this._widget.load();this._widget.doLayout();},save:function(a){this._widget.save();if(a==="checklist"){this.publish("/cms/load/checklist");}},refresh:function(){this._widget.refresh();this._widget.doLayout();},getExtContainer:function(){return this._widget;},wasModified:function(){return false;}});ECM.provide("ECM.CMS.Store.Link");ECM.CMS.Store.Link=Ext.extend(Ext.data.JsonStore,{autoDestroy:true,autoSave:false,afterloadPrompt:[],createSortFunction:function(c,b){b=b||"ASC";var a=b.toUpperCase()=="DESC"?-1:1;var d=this.fields.get(c).sortType;return function(g,f){var m=d(g.data[c]);var l=d(f.data[c]);if(c=="redirect_visual"){var j=/^(\D+)(\d+)$/;var k=j.exec(m);var h=j.exec(l);if(k&&h&&Ext.isDefined(k[1])&&Ext.isDefined(h[1])&&Ext.isDefined(k[2])&&Ext.isDefined(h[2])&&k[1]==h[1]){var o=parseInt(k[2]);var n=parseInt(h[2]);return a*(o>n?1:(o<n?-1:0));}}return a*(m>l?1:(m<l?-1:0));};},onUpdateRecords:function(d,a,b){if(d===true&&(!Ext.isDefined(this.dontCommit)||this.dontCommit===false)){try{this.reader.update(a,b);}catch(c){this.handleException(c);if(Ext.isArray(a)){this.onUpdateRecords(d,a,b);}}}},changedRecordCollection:new Ext.util.MixedCollection(false,function(a){return a.id;}),listeners:{save:function(a){a.reload();},beforewrite:function(j,d,f,k){var b=true,a=Ext.getCmp("ecm-panel-link-editor"),c=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Saving...")}),g=function(l){if(l.data.redirect_visual!==""){l.data.redirect=l.data.redirect_visual;
}};c.show();var h=[];j.each(function(l){g(l);if(j.mode==="aggregate"){var o=l.get("redirect"),n=l.get("format"),m=o;if(!h[m]){h[m]=0;}h[m]++;}});k.params.append=a.append.items.itemAt(0).getValue();return b;},write:function(j,f,k,g){var b=(j.container instanceof ECM.CMS.Panel.Link?j.container.grid:j.container),c=b.ownerCt;if(Ext.isFunction(j.saveCallback)){var a=g.raw.data.date_saved;var h=g.raw.data.unapproved_msg;j.saveCallback(a,h);}b.selModel.clearSelections();var d=new Ext.LoadMask(Ext.getDom("cm_wrapper")||Ext.getBody(),{msg:gt.gettext("Saving...")});d.hide();return true;},exception:function(h,j,b,g,c){var d=[];if(Ext.isDefined(c)&&Ext.isDefined(c.raw)){d=c.raw.application_errors;}if(d.length>15){publishMsg=[gt.gettext("Action resulted in errors")];if((b==="update")&&(d.length<this.data.items.length)){publishMsg.push('<span class="ecm-alert">'+gt.gettext("Link data saved.")+"</span>");}this.publish("/cms/error/add",{message:publishMsg});var k='<span class="ecm-error">';Ext.each(d,function(l){k+=l+"</br></br>";});k+="</span>";var a=new Ext.Container({height:300,autoScroll:true,overflow:"auto",items:[{html:k}]});var f=new ECM.Window({id:"linkEditorErrorMsgBox",title:gt.gettext("Links Save Errors"),width:900,height:400,items:[a],windowButtons:[{text:gt.gettext("Close"),handler:function(){Ext.getCmp("linkEditorErrorMsgBox").close();}}]});this.afterloadPrompt.push(function(){f.show();});}else{if(d.length>0){if((b==="update")&&(d.length<this.data.items.length)){d.push('<span class="ecm-alert">'+gt.gettext("Link data saved.")+"</span>");}d.unshift(gt.gettext("Action resulted in errors")+": ");this.publish("/cms/error/add",{message:d});}}Ext.get("cm_wrapper").unmask();}},proxy:new Ext.data.HttpProxy({method:"GET",timeout:900000,api:{read:"/cm/mailings/linkeditor/get",update:{url:"/cm/mailings/linkeditor/save",method:"POST"}},listeners:{beforeload:function(){}}}),writer:new Ext.data.JsonWriter({encode:true,writeAllFields:true}),isUniqueRedirect:function(a){if(!a){return true;}this.each(function(b){if(b.get("redirect_visual")==a){return false;}});return true;},constructor:function(a){a=a||{};a.records=a.records||[];a.readonly=a.readonly||false;var b=Ext.apply(a,{idProperty:"index",autoLoad:a.records.length?false:true,sortInfo:{field:"url",direction:"ASC"},root:"data.links",successProperty:"success",baseParams:{sort:"url",limit:20,mode:a.mode,mid:a.mid,wostart:a.wostart,appendString:"",tracking_option:2},setTrackOption:function(c){this.baseParams.tracking_option=c;},dynFieldsAdded:{},addField:function(c){c=new Ext.data.Field(c);if(!this.dynFieldsAdded[c.name]){this.recordType.prototype.fields.replace(c);this.reader.ef.push(this.reader.createAccessor(c.name));this.dynFieldsAdded[c.name]=true;}},fields:[{name:"format",type:"string"},{name:"index",type:"number"},{name:"ordinal",type:"number"},{name:"location",type:"string"},{name:"redirect",type:"string"},{name:"redirect_old",type:"string"},{name:"redirect_visual",type:"string"},{name:"status",type:"string"},{name:"status_old",type:"string"},{name:"status_visual",type:"string"},{name:"url",type:"string"},{name:"url_old",type:"string"}]});ECM.CMS.Store.Link.superclass.constructor.call(this,b);if(this.records&&this.records.data&&this.records.data.links){this.loadData(this.records);this.numReportingNames=1;if(this.records.data.reporting){this.reportingLookup=this.records.data.reporting;}}}});ECM.provide("ECM.CMS.Grid.ColumnModel.Link");ECM.CMS.Grid.ColumnModel.Link=Ext.extend(Ext.grid.ColumnModel,{constructor:function(b){b=b||{};var a=b.store||{};this.selModel=this.generateSelectionModel();this.mode=a.mode;this.link_prefix=a.link_prefix;this.numReportingNames=a.numReportingNames||1;this.defaults={sortable:true,menuDisabled:true};b.columns=this.generateCols(a);ECM.CMS.Grid.ColumnModel.Link.superclass.constructor.call(this,b);},generateSelectionModel:function(){if(!ECM.CMS.Grid.CheckboxSelectionModel){ECM.CMS.Grid.CheckboxSelectionModel={};}ECM.CMS.Grid.CheckboxSelectionModel.Link=Ext.extend(Ext.grid.CheckboxSelectionModel,{selectAll:function(){if(this.isLocked()){return;}this.selections.clear();for(var d=0,c=this.grid.store.getCount();d<c;d++){if(this.grid.store.data.itemAt(d).get("status")!=="suppressed"){this.selectRow(d,true);}}},selectAllEvenSuppressed:function(){if(this.isLocked()){return;}this.selections.clear();for(var d=0,c=this.grid.store.getCount();d<c;d++){this.selectRow(d,true);}},checkOnly:true});var a=this,b=new ECM.CMS.Grid.CheckboxSelectionModel.Link();b.on("selectionchange",function(c){this.publish("/links/selection/change",{selections:c,linkPanel:a.store.container});});return b;},insertReportingNames:function(f,a,d){for(var c=0;c<d.length;c++){var b=d[c];var g=a.reporting[b];a.addField({name:b,type:"string"});f.push({header:g,tooltip:g,dataIndex:b,editor:{xtype:"textfield",listeners:{focus:function(){ECM.Flare.onFocus("FLARE_LINKS_REPORTING_NAMES");},blur:function(){ECM.Flare.onBlur("FLARE_LINKS_MAIN");}}}});}},generateCols:function(c){var h=this,j=[],b=c.readonly||false,a=gt.gettext("Click to reorder");if(!b){j.push(h.selModel);j.push({id:"status",header:gt.gettext("Status"),width:78,fixed:true,tooltip:a,dataIndex:"status_visual",editable:false,renderer:function(k){return k?gt.gettext(k):"";}});}if(h.mode==="all"){j.push({header:gt.gettext("Location"),tooltip:a,dataIndex:"location",editable:false});j.push({header:gt.gettext("Format"),tooltip:a,dataIndex:"format",width:55,fixed:true,editable:false});}j.push({header:gt.gettext("Redirect")+'&nbsp <button class="cm_button x-btn-text ecm-btn-hdr-redirect" '+(b?'style="display:none;" ':'style="line-height:13px;"')+' type="button" title="'+gt.gettext("Click to apply prefix")+'"><div>'+gt.gettext("Prefix")+"</div></button>",width:115,fixed:true,dataIndex:"redirect_visual",editable:b?false:true,editor:{xtype:"textfield",minLength:2,maskRe:/^[0-9a-zA-Z]*$/,listeners:{focus:function(){ECM.Flare.onFocus("FLARE_LINKS_REDIRECTFIELD");},blur:function(){ECM.Flare.onBlur("FLARE_LINKS_MAIN");},afterrender:function(){this.el.dom.maxLength=10;}},validator:function(k){if(Ext.isEmpty(k)||!k.match(/^[0-9a-zA-Z]{2,10}$/)){return false;}}},renderer:function(k){var l=window.parseInt(k);return(l===1||l===0?"":k);}});this.reportingArray=new Array();for(var d in c.reporting){this.reportingArray.push(d);}this.reportingArray=this.reportingArray.sort();var g={id:"url",header:gt.gettext("URL")+'&nbsp<button class="cm_button x-btn-text ecm-btn-hdr-url" type="button" title="'+gt.gettext("Click to Expand")+'"><div>&laquo; &raquo;</div></button>',dataIndex:"url",searchable:true,editor:{xtype:"textfield",listeners:{focus:function(){ECM.Flare.onFocus("FLARE_LINKS_URL_FIELD");},blur:function(){ECM.Flare.onBlur("FLARE_LINKS_MAIN");}}},renderer:function(k){return Ext.util.Format.htmlEncode(k);},width:700};var f={id:"preview",fixed:true,header:"&#160;",dataIndex:"url",tooltip:gt.gettext("Click to preview this link"),editable:false,renderer:function(l,n,m){var k=l.replace(/(%%x%%|%%s%%)/ig,"");return"<a class=\"clickable\" onclick=\"Ext.getCmp('ecm-panel-link-editor').grid.previewLink('"+k+"');\">"+gt.gettext("Preview")+"</a>";}};if(this.reportingArray.length===1){this.insertReportingNames(j,c,this.reportingArray);}j.push(g);if(this.reportingArray.length>1){this.insertReportingNames(j,c,this.reportingArray);}j.push(f);return j;}});ECM.provide("ECM.CMS.Modal.LinkPrefix");ECM.CMS.Modal.LinkPrefix=Ext.extend(ECM.Window,{closeAction:"hide",constructor:function(a){this._desc=a.desc?a.desc:gt.gettext("This base redirect name must contain 1-4 letters. It will be applied to all links. Each link can be edited after the redirect name is applied.");this._func=a.fn||function(){};this.prefix=a.prefix||"";this.id=a.id?a.id:"link_prefix";this.title=a.title?a.title:gt.gettext("Link Prefix");ECM.CMS.Modal.LinkPrefix.superclass.constructor.apply(this,arguments);},initComponent:function(){var a="linkprefix_field";var d=this;var c=function(){var f=Ext.getCmp(a).getValue();if(d._func){d._func(f);}d.hide();};
var b=function(){d.hide();};this.listeners={beforehide:function(){Ext.getCmp(a).setValue(Ext.getCmp("link_prefix").prefix);}};this.applyButton=new Ext.Button({text:gt.gettext("Apply")+" &amp; "+gt.gettext("Save"),disabled:false,listeners:{afterrender:function(){if(Ext.isDefined(Ext.getCmp(a))){Ext.getCmp(a).validate();}}},handler:c});this.cancelButton=new Ext.Button({text:gt.gettext("Cancel"),disabled:false,listeners:{render:function(){this.enable();}},handler:b});this.content=[{xtype:"form",layout:"form",items:[{xtype:"label",text:gt.gettext(this._desc)},{xtype:"spacer",height:10},{id:a,xtype:"textfield",autoCreate:{tag:"input",type:"text",maxlength:4},blankText:gt.gettext("1-4 letters [a-z] for link prefix"),allowBlank:false,fieldLabel:this.title,labelStyle:"white-space: nowrap;",width:"30%",value:this.prefix,vtype:"linkPrefixFormat",vtypeText:gt.gettext("Invalid link prefix"),invalidText:gt.gettext("Invalid link prefix"),listeners:{scope:this,invalid:function(){this.applyButton.disable();},valid:function(){this.applyButton.enable();},afterrender:function(){Ext.getCmp(a).validate();}}}]}];this.windowButtons=[this.applyButton,this.cancelButton];ECM.CMS.Modal.LinkPrefix.superclass.initComponent.apply(this,arguments);}});Ext.reg("ecm.linkprefixmodal",ECM.CMS.Modal.LinkPrefix);ECM.provide("ECM.CMS.Modal.LinkUpload");ECM.CMS.Modal.LinkUpload=Ext.extend(ECM.Window,{modal:true,resizable:false,width:600,cls:"upload_links_modal blue_button",closeAction:"hide",constructor:function(d){d=d||{};var g=this;var j=['<div style="text-align: right;">',ECM.Flare.makeLink("FLARE_LINKS_UPLOAD_MODAL"),"</div>"].join("");var c="Files must be comma delimited, in the following format:redirect name,reporting name(s),URL<br>Example: sale,Sale Sale Link,promolink_1,http://www.cheetahmail.com/sale";var h="if a conflict exists between the file and this mailing(i.e. a redirect name exists in the file with a different<br>URL in the mailing):";c=gt.gettext(d.uploadIns?d.uploadIns:c);h=gt.gettext(d.conflictIns?d.conflictIns:h);var p=d.id?d.id:"uploadForm";var m=function(s,q){var r=new ECM.Window({title:gt.gettext("Upload Links"),modal:true,message:"",content:{items:[{html:s,cls:(q=="error")?"cm_error":"cm_font_bold"}]},windowButtons:[{text:gt.gettext("OK"),handler:function(){r.hide();}}]});return r;};var f=function(t,u){var q=Ext.util.JSON.decode(u.response.responseText);if(q){if(q.data.upload_status==1){m(q.data.message,"info").show();if(d.linkPanel){d.linkPanel.getStore().reload();}g.hide();}else{if(q.data.upload_status>1){var s="The following URL(s) appear multiple times inthe mailing, with different redirect names. Allinstances of each link will be updated";s+="<br><br>";for(var r=0;r<q.data.matching_urls.length;r++){s+=q.data.matching_urls[r]+"<br>";}s+="<br>Do you want to update all links?";Ext.MessageBox.buttonText.yes=gt.gettext("Yes");Ext.MessageBox.buttonText.no=gt.gettext("no");Ext.MessageBox.show({title:gt.gettext("Update Links?"),msg:gt.gettext(s),cls:"blue_button",buttons:Ext.MessageBox.YESNO,icon:Ext.MessageBox.QUESTION,fn:o});}else{m(q.application_errors[0],"error").show();g.hide();}}}else{m(gt.gettext(u.failureType),"error").show();g.hide();}};var k=function(q){Ext.getCmp(p).getForm().submit({waitTitle:gt.gettext("Please Wait..."),waitMsg:gt.gettext("Uploading file..."),url:d.url?d.url:"/cm/mailings/links/linksuploadservice/upload",params:{mid:d.mid,debug:d.debug,process_conflicts:q},success:f,failure:f});};var o=function(q){if(q=="yes"){k(1);}else{}};var l=function(){g.hide();};var n=new Ext.Button({text:gt.gettext("Upload"),name:"upload",inputValue:"upload",handler:k,disabled:true});var a=new Ext.ux.form.FileUploadField({width:460,name:"upload_file",hideLabel:true,buttonText:gt.gettext("Browse"),listeners:{fileselected:function(){n.enable();}}});var b=new Ext.form.FormPanel({id:p,fileUpload:true,method:d.method?d.method:"POST",border:false,items:[{xtype:"container",html:j},{xtype:"label",html:c},a,{xtype:"label",html:h},{xtype:"radiogroup",items:[{boxLabel:gt.gettext("File wins"),name:"conflictWinner",inputValue:"1",checked:true},{boxLabel:gt.gettext("Mailing wins"),name:"conflictWinner",inputValue:"2"}],columns:1,colspan:2}]});this.content.items=b;this.listeners={hide:function(){a.reset();n.disable();}};this.windowButtons=[n,{text:gt.gettext("Cancel"),name:"cancel",inputValue:"cancel",handler:l}];ECM.CMS.Modal.LinkUpload.superclass.constructor.apply(this,arguments);},initComponent:function(a){this.title=gt.gettext("Upload Links");ECM.CMS.Modal.LinkUpload.superclass.initComponent.apply(this,arguments);}});Ext.reg("linksuploadmodal",ECM.CMS.Modal.LinkUpload);ECM.provide("ECM.Download");ECM.Download=Ext.extend(Ext.Component,{autoEl:{tag:"iframe",cls:"x-hidden",src:Ext.SSL_SECURE_URL},load:function(a){this.getEl().dom.src=a.url+(a.params?"?"+Ext.urlEncode(a.params):"");}});Ext.reg("ecm.download",ECM.Download);ECM.provide("ECM.CMS.Panel.Link");ECM.CMS.Panel.Link=Ext.extend(Ext.Panel,{trackOption:{TRACK_ALL:0,TRACK_SELECTED:1,IGNORE_TRACK_AND_SAVE_CHANGES:2,UNTRACK_SELECTED:-2,SUPPRESS_SELECTED:-1},autoHeight:true,autoScroll:false,displayFloatingTips:true,constructor:function(b){var d=this;b=b||{};b.mode=b.mode||"aggregate";b.records=b.records||[];b.readonly=b.readonly||false;if(!b.mid){throw new Ext.Error(gt.gettext("Mailing ID missing, cannot build Link Editor"));}d.loopback=b.loopback||"javascript:history.back(-1);";d.mid=b.mid;d.saveCallback=b.saveCallback;d.workflow_wizard=b.workflow_wizard;d.id="ecm-panel-link-editor";d.cls="cm_link_grid gridPanelTableLayout";d.layout="fit";(b.readonly)&&(d.bodyCssClass="ecm-link-editor-reporting");d.store=new ECM.CMS.Store.Link({mid:b.mid,mode:b.mode,container:d,records:b.records,saveCallback:b.saveCallback,wostart:b.wostart,readonly:b.readonly,dontCommit:true});if(Ext.isDefined(Ext.getCmp("leftnav_emo"))){Ext.getCmp("leftnav_emo").hide();}var c=new Ext.LoadMask(Ext.get("cm_wrapper"),{msg:gt.gettext("Loading data&hellip;")});d.store.on("beforeload",function(){c.show();});d.store.on("load",function(h,g,j){c.hide();if(Ext.isDefined(Ext.getCmp("cmsShell"))){Ext.getCmp("cmsShell").resetMailingNavPanelWidth();}while(d.store.afterloadPrompt.length>0){d.store.afterloadPrompt.shift()();}if(h.getTotalCount()>0){d.top.leftPanel.viewBtn.setDisabled(false);h.each(function(k){if(Ext.isDefined(h.reader.jsonData.data.reporting)){for(var l in h.reader.jsonData.data.reporting){k.data[l]=h.reader.jsonData.data.links[k.id][l];}}if(k.data.status==="untracked"){k.data.status_visual="";}else{k.data.status_visual=k.data.status;}k.data.redirect_visual=k.data.redirect;});}if(h.reader.jsonData.data.link_prefix){h.link_prefix=h.reader.jsonData.data.link_prefix;h.setBaseParam("linkPrefix",h.link_prefix);}if(h.reader.jsonData.data.reporting){h.reporting=h.reader.jsonData.data.reporting;}if(h.reader.jsonData.data.append_string){d.append.appendField.setValue(h.reader.jsonData.data.append_string);d.append.appendField.originalValue=d.append.appendField.getValue();}if(h.reader.jsonData.data.is_remote){d.publish("/cms/error/add",{message:gt.gettext("Cannot edit links in Remote Content")});if(Ext.isDefined(d.grid)){d.grid.hide();}}else{if(Ext.isEmpty(d.grid)){d.columnModel=new ECM.CMS.Grid.ColumnModel.Link({store:h});d.add(d.buildGrid());d.doLayout();}d.grid.updateGrid();}if(Ext.isDefined(Ext.getCmp("cmsShell"))){Ext.getCmp("cmsShell").resizeContainerHeight();}if(Ext.isDefined(ECM.FeatureHelp)){ECM.FeatureHelp.showAllTooltips();}if(Ext.util.Cookies.get((d.readonly)?"linkReport_urlColumn":"linkEditor_urlColumn")==="expanded"&&d.grid.urlColumnExpanded===false){d.grid.toggleUrlColumnWidth(d.grid.colModel,d.grid.store);}});ECM.CMS.Panel.Link.superclass.constructor.call(d,b);if(Ext.isDefined(ECM.Config)){var a=new ECM.Config.FeatureHelp.CMS();ECM.FeatureHelp.setFeatureHelp(a);this.subscribe("/cms/leave_tab",function(){ECM.FeatureHelp.hideAllTooltips();});}var f=Ext.getCmp("cmsWizardWorkflow");if(Ext.isDefined(f)){f.turnOff();}},initComponent:function(){var a=this;a.items=[];
a.items.push(a.buildTopLevelControls());a.items.push(a.buildAppendStringForm());ECM.CMS.Panel.Link.superclass.initComponent.call(a);if(a.readonly){a.saveButton=a.buildSaveButton();}},buildSaveButton:function(){var b=this,a=Ext.getDom("app_wrapper");Ext.DomHelper.insertHtml("afterBegin",a,['<div id="subheader_holder" style="padding-bottom:0;">','<table class="subheader_table">',"<tbody>","<tr>",'<td id="saveButtonCt">','<button class="cm_button blue_button_spacing" value="'+gt.gettext("Save")+'" onclick="linkEditor.save();">',"<div>"+gt.gettext("Save")+"</div>","</button>","</td>",'<td align="right">','<span class="back_to_report">','<a href="'+b.loopback+'">'+gt.gettext("Back to Mailing Report")+"</a>","</span>","</td>","</tr>",'<tr class="table_header">',"<td>",'<span class="bold">'+gt.gettext("Mailing Sent")+"</span>",' - <span class="title_highlight">'+b.date_sent+"</span>","</td>","<td></td>","</tr>","</tbody>","</table>","</div>"].join("\n"));},refresh:function(){this.grid.store.rejectChanges();this.grid.updateGrid();},save:function(){var f=this;var c=f.append.appendField;var b=c.getValue();var g=f.store.getModifiedRecords();var a=f.store.reader.jsonData.data.append_string;f.store.setTrackOption(f.trackOption.IGNORE_TRACK_AND_SAVE_CHANGES);f.publish("/cms/alert/clear");c.originalValue=b;if(!g.length&&!(Ext.isEmpty(b)&&Ext.isEmpty(a))&&a!==b){var d=new Ext.LoadMask(Ext.getCmp("ecm-panel-link-editor").el,{msg:gt.gettext("Loading...")});ECM.Ajax.request({url:"/cm/mailings/linkeditor/save_append",params:{mid:f.mid,append:b},listeners:{beforerequest:function(){d.show();},requestcomplete:function(){d.hide();}},callback:function(j,m,h){var k=h.responseJSON.data.date_saved;var l=h.responseJSON.data.unapproved_msg;f.saveCallback(k,l);f.store.load();}});}else{if(g.length===0){f.publish("/cms/alert/add",{message:gt.gettext("No changes to be saved"),area:"Links"});}else{f.store.save();}}},getStore:function(){return this.store;},getColumnModel:function(){return this.columnModel;},getTopLevelControls:function(){return this.top;},setMode:function(d){var c=this;if(!(d in {all:1,aggregate:1})){throw new Ext.Error(gt.gettext("Attempted to set invalid mode"));}var b=(d=="all")?[{field:"format",direction:"DESC"}]:"url";c.store.mode=d;c.store.baseParams.mode=d;c.store.sort(b);c.store.load();var a=new ECM.CMS.Grid.ColumnModel.Link({store:c.store});var f=c.store;f.columns=a.columns;c.grid.reconfigure(f,a);},getMode:function(){return this.store.mode||"aggregate";},buildTopLevelControls:function(){var b=this,c=b.createActionButtons();var a={layout:"table",layoutConfig:{tableAttrs:{style:{width:"100%"}},columns:2},autoHeight:true,ref:"top",items:[{ref:"leftPanel",hidden:b.readonly,layout:"table",layoutConfig:{columns:2},style:"margin-right:8px",items:[{xtype:"label",text:gt.gettext("View")+":",style:Ext.isIE?"padding-right:55px":"padding-right:54px"},{xtype:"combo",minListWidth:150,listWidth:150,width:150,triggerAction:"all",forceSelection:true,disabled:true,editable:false,mode:"local",ref:"viewBtn",itemId:"viewBtn",store:[["aggregate",gt.gettext("Aggregate")],["all",gt.gettext("All links")]],listeners:{select:function(){b.setMode(this.getValue());},focus:function(){ECM.Flare.onFocus("FLARE_LINKS_VIEW");},blur:function(){ECM.Flare.onBlur("FLARE_LINKS_MAIN");}},value:b.store.baseParams.mode||"aggregate"}]},{ref:"rightPanel",hidden:b.readonly,layout:"table",layoutConfig:{tableAttrs:{style:"float:right"},columns:4},items:[{ref:"trackBtn",xtype:"splitbutton",cls:"blue_button",text:gt.gettext("Track Links")+" &amp; "+gt.gettext("Save"),handler:function(){var d=Ext.getCmp("ecm-panel-link-editor");d.grid.getSelectionModel().selectAllEvenSuppressed();d.updateSelected("tracked",true);},menu:[{text:gt.gettext("Track Selected")+" &amp; "+gt.gettext("Save"),handler:function(){Ext.getCmp("ecm-panel-link-editor").updateSelected("tracked",true);}},{text:gt.gettext("Untrack Selected")+" &amp; "+gt.gettext("Save"),handler:function(){Ext.getCmp("ecm-panel-link-editor").updateSelected("untracked",true);}},{text:gt.gettext("Suppress Selected")+" &amp; "+gt.gettext("Save"),handler:function(){Ext.getCmp("ecm-panel-link-editor").updateSelected("suppressed",true);}}]},{xtype:"button",cls:"blue_button",style:"margin-left:5px",ref:"uploadBtn",itemId:"uploadBtn",text:gt.gettext("Upload Links"),handler:function(){var d=ECM.ModalMgr;if(!d.exists("uploadLinks")){var f=new ECM.CMS.Modal.LinkUpload({mid:b.initialConfig.mid,linkPanel:b});d.registerModal("uploadLinks",f);}d.showModal("uploadLinks");}},{xtype:"button",cls:"blue_button",style:"margin-left:5px",text:gt.gettext("Download Links"),ref:"downloadBtn",itemId:"downloadBtn",handler:function(){var d=new ECM.Download({renderTo:Ext.getBody()});d.load({url:"/cm/mailings/links/download",params:{mid:b.store.baseParams.mid,mode:b.store.baseParams.mode}});}},{xtype:"button",cls:"blue_button",ref:"saveBtn",itemId:"saveBtn",style:"margin-left:5px",text:gt.gettext("Save Links"),handler:function(){b.save();}}]}]};return a;},determineHighestIncrement:function(a){var b=0;this.store.each(function(c){var f=c.get("redirect_visual")||"";if(f.indexOf(a)>-1){var d=f.replace(a,"")*1;if(Ext.isNumber(d)&&d>b){b=d;}}});return b;},updateSelected:function(o,a){var d="";if(o==="tracked"){d="Tracking links..";if(this.grid.getSelectionModel().getSelections().length===this.grid.store.getTotalCount()){this.grid.store.setTrackOption(this.trackOption.TRACK_ALL);}else{this.grid.store.setTrackOption(this.trackOption.TRACK_SELECTED);}}else{if(o==="untracked"){d="Untracking links..";this.grid.store.setTrackOption(this.trackOption.UNTRACK_SELECTED);}else{if(o==="suppressed"){d="Suppressing links..";this.grid.store.setTrackOption(this.trackOption.SUPPRESS_SELECTED);}else{d="Updating..";}}}var c=new Ext.LoadMask(Ext.get("cm_wrapper"),{msg:gt.gettext(d)});c.show();var k=this;var n=function(s,r){var t=k.grid.store,q=t.getSortState(),u=q.direction.toUpperCase()=="DESC"?-1:1,v=t.fields.get(q.field).sortType,p=v(s.data[q.field]),w=v(r.data[q.field]);return u*(p>w?1:(p<w?-1:(s.id>r.id?1:0)));},f=k.grid.getSelectionModel(),g=k.grid.store.getSortState()?f.getSelections().sort(n):f.getSelections(),b=k.grid.store.link_prefix,m=k.determineHighestIncrement(b);g.aLoop=function(r,p){var q=3000,s=new Date();while(this.length>0&&s.getElapsed()<=q){r(this.shift());}if(this.length>0){var t=this;setTimeout(function(){t.aLoop(r,p);},300);}else{p();}};var j=(function(p,q){var r=null;this.grid.store.each(function(s){var t=s.get("url"),u=s.get("redirect")||"";if(u.indexOf(p)>=0&&t===q){r=s.get("redirect");return false;}});return r;}).createDelegate(k);var h=0;var l=k.grid.store.changedRecordCollection.clone();k.grid.store.changedRecordCollection.clear();g.aLoop(function(p,s){var q=p.get("redirect_visual"),u=function(){return b+(++m);},r=p.get("url"),t;switch(o){case"tracked":if(q){h++;}t=q||j(b,r)||u()||"";p.beginEdit();p.set("status_visual",o);p.set("status",o);p.set("redirect",t);p.set("redirect_visual",t);break;case"untracked":p.beginEdit();p.set("status","untracked");p.set("status_visual","");p.set("redirect_visual","");break;case"suppressed":p.beginEdit();p.set("status",o);p.set("status_visual",o);p.set("redirect_visual","");break;}if(p.editing===true){p.endEdit();}},function(){c.hide();if(a){k.grid.store.save();}k.grid.updateGrid();});if(Ext.isEmpty(b)&&(o==="tracked")&&(h<f.getCount())){k.grid.store.changedRecordCollection=l;k.publish("/cms/error/add",{message:(f.getCount()-h)+" "+gt.gettext("links could not be tracked; no prefix or name was specified. Please enter a prefix or name for these links, or change the Tracking Options selection and save changes."),area:"Links"});return false;}l.each(function(){this.reject();});},createActionButtons:function(){var a=this,b=new ECM.Toolbar.ActionButtons({type:ECM.Rules.Constants.TOOLBAR.TYPE.LINK_EDITOR});b.on("render",function(){a.grid.getSelectionModel().on("selectionchange",function(f){var d=["trackLinksButton","untrackLinksButton","suppressLinksButton"];for(var c=0;
c<d.length;c++){if(Ext.isDefined(this[d[c]])){this[d[c]].setDisabled(!f.hasSelection());}}}.createDelegate(this));});b.on("actionbuttonclick",function(c){switch(c){case ECM.Rules.Constants.TOOLBAR.BUTTON.TRACK_LINKS:a.updateSelected("tracked",true);break;case ECM.Rules.Constants.TOOLBAR.BUTTON.UNTRACK_LINKS:a.updateSelected("untracked",true);break;case ECM.Rules.Constants.TOOLBAR.BUTTON.SUPPRESS_LINKS:a.updateSelected("suppressed",true);break;}});return b;},getAppendStringForm:function(){return this.append;},buildAppendStringForm:function(){var b=this;var a={layout:"form",ref:"append",width:754,bodyStyle:"padding-bottom:10px;margin-top:6px",autoHeight:true,hidden:this.readonly?true:false,items:[{xtype:"textfield",ref:"appendField",id:"append_string_field",fieldLabel:gt.gettext("Append String"),labelWidth:82,itemCls:"append_link_label",style:"width:80px",ctCls:"append_link",width:400,listeners:{focus:function(){ECM.Flare.onFocus("FLARE_LINKS_APPEND_STRING");},blur:function(){ECM.Flare.onBlur("FLARE_LINKS_MAIN");}}}]};return a;},getGrid:function(){return this.grid;},buildGrid:function(){var b=this;var a={xtype:"editorgrid",autoEncode:false,autoWidth:true,autoScroll:true,autoHeight:true,border:true,view:new Ext.ux.grid.BufferView({borderHeight:0,scrollDelay:false,forceFit:true,emptyText:gt.gettext("No links available"),deferEmptyText:false}),enableColumnHide:false,enableColumnMove:false,columnLines:this.readonly,bodyBorder:false,clicksToEdit:1,ref:"grid",stripeRows:true,plugins:[(function(){var c=new ECM.Plugins.Grid.SearchColumn({});c.onHeaderSubmitSearch=function(){Ext.iterate(this.columnIdToInputBox,function(d,h){var g=this.eventDataFromId(d);var f=g.value||"";this.grid.store.filter(g.field,f,true,false,false);},this);}.createDelegate(c);return c;})()],cm:b.columnModel,sm:b.columnModel.selModel,store:b.store,initialWidth:0,initialUrlColumnWidth:0,urlColumnExpanded:false,toggleUrlColumnWidth:function(n,m){var g=n.getIndexById("url"),d=gt.gettext("URL")+'&nbsp<button title="'+gt.gettext("Click to Collapse")+'" type="button" class="cm_button ecm-btn-hdr-url"><div>&raquo; &laquo;</div></button>',h=gt.gettext("URL")+'&nbsp<button title="'+gt.gettext("Click to Expand")+'" type="button" class="cm_button ecm-btn-hdr-url"><div>&laquo; &raquo;</div></button>';Ext.select("button.ecm-btn-hdr-redirect").un("click",b.grid.prefixBtnHandler);if(!Ext.isEmpty(b.grid.getView().getRows())){var j=Ext.decode(b.grid.plugins[0].getValue());b.grid.urlExpanded=Ext.isDefined(b.grid.urlExpanded)?!b.grid.urlExpanded:true;if(b.grid.urlExpanded){n.setColumnHeader(g,d);}else{n.setColumnHeader(g,h);}b.grid.plugins[0].setValue(j.columnIdToValue);Ext.each(m.data.items,function(p,q){var o=n.getCellEditor(g,q);if(o.isVisible()){o.hide();}});var c=b.grid.view.getCell(0,3);var k=Ext.util.TextMetrics.createInstance(b.getEl());var l=k.getWidth("G")*2038;if(b.grid.initialWidth===0){b.grid.initialWidth=b.grid.getWidth();}if(b.grid.initialUrlColumnWidth===0){b.grid.initialUrlColumnWidth=b.grid.colModel.getColumnWidth(g);}if(!b.grid.urlColumnExpanded){var f=20;b.grid.autoWidth=false;b.grid.colModel.setColumnWidth(g,l+f);b.grid.setWidth(b.grid.initialWidth+(l-this.initialUrlColumnWidth));b.grid.getEl().dom.style.paddingRight="10px";b.body.dom.style.overflowX="auto";b.grid.urlColumnExpanded=true;if(b.body.isScrollable()){b.body.scroll("r",b.body.dom.scrollWidth-b.body.dom.clientWidth);b.grid.view.focusCell(0,g);}Ext.util.Cookies.set((b.readonly)?"linkReport_urlColumn":"linkEditor_urlColumn","expanded");}else{b.grid.colModel.setColumnWidth(g,this.initialUrlColumnWidth);b.grid.getEl().dom.style.paddingRight="0px";b.grid.setWidth(b.grid.initialWidth);b.grid.autoWidth=true;b.grid.syncSize();b.body.dom.style.overflowX="hidden";b.grid.urlColumnExpanded=false;if(Ext.isIE){b.grid.show();}Ext.util.Cookies.set((b.readonly)?"linkReport_urlColumn":"linkEditor_urlColumn",null);}b.grid.view.fitColumns();if(Ext.isDefined(Ext.getCmp("cmsShell"))){Ext.getCmp("cmsShell").resizeContainerHeight();}}Ext.select("button.ecm-btn-hdr-url").on("click",b.grid.expandBtnHandler);Ext.select("button.ecm-btn-hdr-redirect").on("click",b.grid.prefixBtnHandler);},linkPrefix:"",linkPrefixModal:undefined,applyPrefix:function(f){var d=Ext.getCmp("ecm-panel-link-editor"),c=d.determineHighestIncrement(f),g=d.grid.getSelectionModel();d.grid.store.link_prefix=f;if(!g.getSelections().length){g.selectAll();}d.updateSelected("tracked",true);if(b.displayFloatingTips){}},updateGrid:function(){var c=b.grid.colModel,d=b.grid.getStore(),f=Ext.query("button.ecm-btn-hdr-url")[0],k=Ext.query("button.ecm-btn-hdr-redirect")[0],l=b.top.rightPanel.downloadBtn,g=b.top.rightPanel.uploadBtn,j=b.top.rightPanel.trackBtn,h=Ext.decode(b.grid.plugins[0].getValue());if(f&&k){if(d.getCount()===0){f.disabled=true;k.disabled=true;l.setDisabled(true);g.setDisabled(true);j.setDisabled(true);}else{f.disabled=false;k.disabled=false;l.setDisabled(false);g.setDisabled(false);j.setDisabled(false);}}Ext.select("button.ecm-btn-hdr-url").un("click",b.grid.expandBtnHandler);b.grid.view.refresh(true);b.grid.plugins[0].setValue(h.columnIdToValue);Ext.select("button.ecm-btn-hdr-url").on("click",b.grid.expandBtnHandler);Ext.select("button.ecm-btn-hdr-redirect").on("click",b.grid.prefixBtnHandler);},expandBtnHandler:function(f,d){f.stopEvent();var g=Ext.select("button.ecm-btn-hdr-url");var c=g.elements[0];Ext.EventManager.purgeElement(c,false,"click");g.un("click",b.grid.expandBtnHandler);b.grid.toggleUrlColumnWidth(b.grid.colModel,b.grid.store);},prefixBtnHandler:function(f,c){f.stopEvent();if(!ECM.ModalMgr.exists("linkPrefix")){var d=new ECM.CMS.Modal.LinkPrefix({fn:b.grid.applyPrefix,prefix:b.store.link_prefix});ECM.ModalMgr.registerModal("linkPrefix",d);}var g=ECM.ModalMgr.getModal("linkPrefix");if(Ext.isDefined(g)&&Ext.isDefined(b.store.link_prefix)){g.prefix=b.store.link_prefix;Ext.getCmp("linkprefix_field").setValue(b.store.link_prefix);}ECM.ModalMgr.showModal("linkPrefix");Ext.select("button.ecm-btn-hdr-redirect").un("click",b.grid.prefixBtnHandler);},previewLink:function(d){if(d.match(/^(http|https):\/\//i)){window.open(d,"urlWindow","toolbar=0,scrollbars=1,location=1,statusbar=1,menubar=1,resizable=1");}else{var c=Ext.isEmpty(d)?"No URL to preview":d+" is not a valid URL";b.publish("/cms/error/add",{message:gt.gettext(c)});}},listeners:{afterrender:function(){Ext.EventManager.purgeElement(b.grid.getGridEl(),false,"mousewheel");if(b.readonly){Ext.EventManager.onWindowResize(function(){var d=Ext.get("app_wrapper"),c=d.getWidth()-10;b.setWidth(c);b.doLayout();});}b.grid.on("reconfigure",b.grid.updateGrid);b.grid.on("reconfigure",function(){if(b.grid.urlColumnExpanded===true){b.grid.toggleUrlColumnWidth(b.grid.colModel,b.grid.store);b.grid.toggleUrlColumnWidth(b.grid.colModel,b.grid.store);}});b.on("resize",function(){b.grid.updateGrid();});}}};return a;}});ECM.provide("ECM.CMS.Panel.LinkInterface");ECM.CMS.Panel.LinkInterface=Ext.extend(ECM.CMS.MediatorInterface,{constructor:function(b){var a=this;b.saveCallback=function(c,d){var f;if(Ext.isEmpty(d)){f=gt.gettext("Link data saved: ")+c;}else{f=[gt.gettext("Link data saved: ")+c,'<span class="cm_error">'+d+"</span>"];ECM.publish("/cms/updateMailingTitle",{mailing_status:"("+gt.gettext("Not Approved")+")"});}a.publish("/cms/alert/add",{message:f});};a.panel=new ECM.CMS.Panel.Link(b);ECM.CMS.Panel.LinkInterface.superclass.constructor.call(a);},save:function(){this.panel.save.call(this.panel);},load:function(){this.panel.store.load();},refresh:function(){this.panel.refresh();},getExtContainer:function(){return this.panel;},wasModified:function(){var c=Ext.getCmp("append_string_field");if(c&&c.isDirty()){return true;}var a=this.panel.store.getModifiedRecords();var b=false;Ext.each(a,function(d){if(d.dirty){b=true;return;}});return b;}});Ext.namespace("ECM.CMS");ECM.provide("ECM.CMS");ECM.CMS.STANDARD_PANEL_HEIGHT=600;ECM.CMS.SETTINGS_PANEL_HEIGHT=1600;ECM.CMS.SOCIAL_MEDIA_PANEL_HEIGHT=1000;ECM.CMS.STANDARD_LOADING_HEIGHT=1000;
ECM.CMS.Mediator=Ext.extend(Ext.util.Observable,{constructor:function(a){this._shell=null;this._activeComponent=null;Ext.apply(this,a);ECM.CMS.Mediator.superclass.constructor.call(this,a);ECM.Ajax.suspendEvents();this._createHandlers();this.panelTabs=[{name:"settings",label:gt.gettext("Settings")},{name:"content",label:gt.gettext("Content")},{name:"links",label:gt.gettext("Links")}];if(!this.is_template){if(this.show_social_media){this.panelTabs.push({name:"socialmedia",label:gt.gettext("Social Media")});}this.panelTabs.push({name:"checklist",label:gt.gettext("Checklist")});}this.panelNames={};for(var b=0;b<this.panelTabs.length;b++){this.panelNames[this.panelTabs[b].name]=true;}ECM.subscribe("/flare/setDefaultTabAnchorName",this.setTabHelpLink,this);this.errorHandler=new ECM.Error();},_createHandlers:function(){this.lastLoadHandler="";this.nextLoadHandler="";this._createSaveHandler();this._createLoadContentHandler();this._createLoadLinksHandler();this._createLoadSettingsHandler();if(!this.is_template){if(this.show_social_media){this._createLoadSocialMediaHandler();}this._createLoadChecklistHandler();}this.findKeyMap=new Ext.KeyMap(document,{key:"f",ctrl:true,fn:function(b,c){if(this._activeComponent&&this._activeComponent._panel&&this._activeComponent._panel.showSearchAndReplace){c.stopEvent();if(Ext.isIE){c.browserEvent.keyCode=0;}this._activeComponent._panel.showSearchAndReplace();}},scope:this});this.findKeyMap.disable();this.subscribe("/cms/reload",function(){var b=this.nextLoadHandler;if(Ext.isDefined(b)&&b.length>0){this.publish("/cms/load/"+b);}},this);var a=this;window.onbeforeunload=function(b){if(a._activeComponent.wasModified()){var c=gt.gettext("You have made changes, but have not saved them. If you leave this section without saving, your changes will be lost.");(b||window.event).returnValue=c;return c;}else{if(Ext.isGecko){return null;}else{return undefined;}}};},_createSaveHandler:function(){this.subscribe("/cms/save",function(a){if(this._activeComponent){this._activeComponent.save(a);}},this);},_createLoadContentHandler:function(){this.subscribe("/cms/load/content",function(a){this._notifyPageChangedWithoutSave(function(){this._shell.navPanel.highlight("/cms/load/content");this.nextLoadHandler="content";var b=new ECM.CMS.Panel.Content({mid:this.mid,mtype:this.mtype,mfid:this.mfid,desired_aid:this.desired_aid,is_template:this.is_template,workflow_wizard:this.workflow_wizard,appimght:this.appimght,tab:a,containerConfig:{height:350},role:this.role});this.setActiveComponent(b);}.createDelegate(this));},this);},_createLoadLinksHandler:function(){this.subscribe("/cms/load/links",function(){this._notifyPageChangedWithoutSave(function(){this._shell.navPanel.highlight("/cms/load/links");this.nextLoadHandler="links";var a=new ECM.CMS.Panel.LinkInterface({mid:this.mid,workflow_wizard:this.workflow_wizard,is_remote:this.is_remote});this.setActiveComponent(a);}.createDelegate(this));},this);},_createLoadSocialMediaHandler:function(){this.subscribe("/cms/load/socialmedia",function(){this._notifyPageChangedWithoutSave(function(){this._shell.navPanel.highlight("/cms/load/socialmedia");this.nextLoadHandler="socialmedia";var a=new ECM.CMS.Panel.SocialMedia.Mediator({mid:this.mid,containerConfig:{height:350,startTab:this.tab||""}});a.load();this.setActiveComponent(a,ECM.CMS.SOCIAL_MEDIA_PANEL_HEIGHT);}.createDelegate(this));},this);},_createLoadSettingsHandler:function(){this.subscribe("/cms/load/settings",function(a){this._notifyPageChangedWithoutSave(function(){this._shell.navPanel.highlight("/cms/load/settings");this.nextLoadHandler="settings";var b=new ECM.CMS.Panel.Settings({mid:this.mid,mtype:this.mtype,mfid:this.mfid,desired_aid:this.desired_aid,containerConfig:{height:450},is_template:this.is_template,workflow_wizard:this.workflow_wizard,show_template:this.show_template,show_social_media:this.show_social_media,role:this.role});if(this.show_template){this.show_template=0;b.select_template();}else{b.load(a);}this.setActiveComponent(b);}.createDelegate(this));},this);},_createLoadChecklistHandler:function(){this.subscribe("/cms/load/checklist",function(){this._notifyPageChangedWithoutSave(function(){this._shell.navPanel.highlight("/cms/load/checklist");this.nextLoadHandler="checklist";var a=new ECM.CMS.Panel.Checklist.Mediator({mid:this.mid,mtype:this.mtype,is_template:this.is_template,workflow_wizard:this.workflow_wizard});this.setActiveComponent(a);}.createDelegate(this));},this);},_notifyPageChangedWithoutSave:function(c){var b=this;if((this.nextLoadHandler!="")&&this._activeComponent.wasModified()){var a=Ext.MessageBox.buttonText.ok;Ext.MessageBox.buttonText.ok=gt.gettext("Continue without Saving");Ext.Msg.show({title:gt.gettext("Unsaved Changes"),msg:gt.gettext("You have made changes, but have not saved them. If you leave this section without saving, your changes will be lost."),buttons:Ext.Msg.OKCANCEL,cls:"cm_text_align_left blue_button",fn:function(d){if(d==="ok"){b.publish("/cms/leave_tab");c();}}});Ext.MessageBox.buttonText.ok=a;}else{this.publish("/cms/leave_tab");c();}},setActiveComponent:function(a,b){this._activeComponent=a;if(this._shell){if(this.nextLoadHandler=="content"){this.findKeyMap.enable();}else{this.findKeyMap.disable();}b=b||ECM.CMS.STANDARD_PANEL_HEIGHT;if(this.nextLoadHandler!=this.lastLoadHandler){this.publish("/cms/alert/clear");if(ECM.util.ExtHistory.loadFlag){ECM.util.ExtHistory.add(this.nextLoadHandler);}}this.setTabHelpLink();this.lastLoadHandler=this.nextLoadHandler;this._shell.replaceActivePanel(a);}},setTabHelpLink:function(){var a=this.getHelpLinkTabAnchor(this.nextLoadHandler);ECM.Flare.updateLink(a);},getHelpLinkTabAnchor:function(a){var b={settings:"FLARE_SETTINGS_MAIN",content:"FLARE_CONTENT_MAIN",links:"FLARE_LINKS_MAIN",socialmedia:"FLARE_SOCIAL_MEDIA_MAIN",checklist:"FLARE_CHECKLIST_MAIN"};return b[a];},getExtContainer:function(b){var a=new ECM.CMS.Shell(b,this);this._shell=a;return a;},loadPanel:function(a){if(this.panelNames[a]){this.publish("/cms/load/"+a);}}});ECM.CMS.Shell=Ext.extend(Ext.Panel,{id:"cmsShell",constructor:function(c,d){this._mediator=d;this.initialiseHistory();this._activePanel=null;this._leftNavPanel=null;this._topNavPanel=null;this._centerPanel=new Ext.Panel({region:"center",id:"cmsCenterRegionId",activeTab:0,border:false,layout:"form",collapsible:false,header:false,bbar:new ECM.CMS.Panel.WizardWorkflowToolbar({id:"cmsWizardWorkflow"}),replaceActivePanel:function(f){this.removeAll();this.add(f);this.doLayout();}});this._topNavPanel=new Ext.Panel({autoHeight:true,border:false,header:false});this.navPanel=new ECM.CMS.Panel.Nav({mid:d.mid,panelTabs:d.panelTabs,isTemplate:d.is_template,eid:d.eid,desired_aid:d.desired_aid,mtype:d.mtype,mailingName:decodeURIComponent(d.mailingName),approved:d.approved,templateSelected:d.templateSelected,templatesEnabled:d.templatesEnabled==1});var b=Ext.isIE?219:215;this._leftNavPanel=new ECM.CMS.Panel.LeftNav({appimght:d.appimght,mid:d.mid,mtype:d.mtype,eid:d.eid,aid:d.desired_aid,mfid:d.mfid,flyout:d.flyout,is_template:d.is_template,role:d.role,region:"west",height:600,minWidth:0,width:b,maxWidth:b,hideCollapseTool:true,collapseMode:"mini"});this._topNavPanel.add(this.navPanel);this._topNavPanel.render(Ext.get("topNavigationPanel").insertBefore("app_wrapper"));Ext.get("outerDiv").insertBefore("app_wrapper");Ext.get("afterOuterDiv").insertBefore("app_wrapper");var a={header:false,x:0,y:0,layout:"border",border:false,bodyCssClass:"north_cm_box_hd",defaults:{collapsible:true,split:true},items:[this._leftNavPanel,this._centerPanel]};c=Ext.apply(a,c);ECM.CMS.Shell.superclass.constructor.call(this,c);},replaceActivePanel:function(a){this._activePanel=a.getExtContainer();this._centerPanel.replaceActivePanel(this._activePanel);this._centerPanel.doLayout();},resizeContainerHeight:function(a,b){if(this.lastSetHeight){window.clearTimeout(this.lastSetHeight);}if(Ext.getCmp("cmsShell")){this.lastSetHeight=(function(){var g=0,d=Ext.getCmp("cmsShell");if(d._activePanel){g=d._activePanel.getHeight();
}a=!Ext.isEmpty(a)?a:Math.max(ECM.CMS.STANDARD_PANEL_HEIGHT,g);var f=Ext.getCmp("cmsWizardWorkflow");var c=0;if(!b&&Ext.isDefined(f)){if(f.isVisible()){c=f.getHeight();}}a=a+c;d.setHeight(a);Ext.getCmp("cmsCenterRegionId").setHeight(a);if(Ext.getCmp("contentPanelId")){d._activePanel.setHeight(a-c);}}).defer(100,this);}},resetMailingNavPanelWidth:function(){Ext.getCmp("mailing_nav_panel").doLayout();if(Ext.isIE8){Ext.get("outerDiv").setWidth(Ext.getCmp("mailing_nav_panel").getWidth());}},listeners:{afterrender:function(){Ext.EventManager.onWindowResize(function(){var a=Ext.getCmp("mailing_nav_panel");if(Ext.isIE7||Ext.isIE8){(function(){a.doLayout();if(Ext.isIE8){Ext.get("outerDiv").setWidth(a.getWidth());}Ext.getCmp("cmsShell").doLayout();}.defer(Ext.isIE7?500:200,this));}else{a.doLayout();this.doLayout();}},this);this._addContextMenuToTopLinks();}},_addContextMenuToTopLinks:function(){var b=this;var a=Ext.query("#navPanelTmplId li");Ext.each(a,function(c){var f=c.id;if(Ext.isDefined(f)&&f.search("navLink_")>=0){var d=f.match(/navLink_(\w+)/)[1];var g=b._contextMenu(d);if(Ext.isDefined(d)){Ext.get("navLink_"+d).on("contextmenu",function(h){h.stopEvent();g.showAt(h.getXY());});}}});},_contextMenu:function(a){return new Ext.menu.Menu({margin:"0 0 10 0",floating:true,items:[{text:gt.gettext("Open in new tab"),listeners:{click:function(){var b=document.location.href;b=b.replace(/#.*/,"");var c="&start_panel="+a;if(b.search(/&start_panel=\w+/)>-1){b=b.replace(/&start_panel=\w+/,c);}else{b+=c;}window.open(b,"_cms"+a);}}}]});},initialiseHistory:function(){this.historyForm=Ext.getBody().createChild({tag:"form",action:"#",cls:"x-hidden",id:"history-form",children:[{tag:"div",children:[{tag:"input",id:ECM.util.ExtHistory.fieldId,type:"hidden"},{tag:"iframe",id:ECM.util.ExtHistory.iframeId}]}]});ECM.util.ExtHistory.init(function(){});ECM.util.ExtHistory.loadFlag=true;ECM.util.ExtHistory.on("change",this.handleHistoryChange,this);},handleHistoryChange:function(a){if(a===ECM.util.ExtHistory.dummyTab){if(ECM.util.ExtHistory.initialized){ECM.util.ExtHistory.back();}else{ECM.util.ExtHistory.add(window.location.hash.split("#")[1]);ECM.util.ExtHistory.initialized=true;}}else{if(a!=this._mediator.lastLoadHandler){ECM.util.ExtHistory.loadFlag=false;this._mediator.loadPanel(a);ECM.util.ExtHistory.loadFlag=true;}}}});if(!ECM.Adapter.namespace("ECM.Targeting.Store.XDB")._bogus){ECM.provide("ECM.Targeting.Store.XDB");(function(){function b(){ECM.Adapter.namespace("ECM.Stash.affiliates.hash");ECM.Adapter.each(ECM.Stash.affiliates,function(c){ECM.Stash.affiliates.hash[c.id]=c.name;});}function a(){if(!ECM.Adapter.namespace("ECM.Stash.affiliates").hash){b();}ECM.Adapter.namespace("ECM.Stash.xdbs.hash");var g=ECM.Stash.segmentData.data[1]||[];var c=g[0]||{};var d=c["E.FILENAME"]||[];var k=d[3]||[];for(var h=0,f=k.length;h<f;h+=2){if(!ECM.Stash.xdbs.hash[k[h]]){ECM.Stash.xdbs.hash[k[h]]=[];}ECM.Stash.xdbs.hash[k[h]].push({id:k[h],name:ECM.Adapter.namespace("ECM.Stash.affiliates.hash")[k[h]]||"",xdbName:k[h+1]||""});}ECM.Adapter.each(ECM.Stash.xdbs,function(j){if(!ECM.Stash.xdbs.hash[j[0]]){ECM.Stash.xdbs.hash[j[0]]=[];ECM.Stash.xdbs.hash[j[0]].push({id:j[1],name:ECM.Adapter.namespace("ECM.Stash.affiliates.hash")[j[1]]||"",xdbName:j[2]||""});}});}ECM.Targeting.Store.XDB={getAffiliate:function(d){if(!ECM.Adapter.namespace("ECM.Stash.xdbs").hash){a();}var c=gt.gettext("Unknown Affiliate");if(ECM.Adapter.namespace("ECM.Stash.xdbs.hash."+d)){c=ECM.Adapter.pluck(ECM.Adapter.namespace("ECM.Stash.xdbs.hash."+d),"name").join(",");}return c;},getName:function(d){if(!ECM.Adapter.namespace("ECM.Stash.xdbs").hash){a();}var c="";if(ECM.Adapter.namespace("ECM.Stash.xdbs.hash."+d)){c=ECM.Adapter.pluck(ECM.Adapter.namespace("ECM.Stash.xdbs.hash."+d),"xdbName").join(",");}return c;},_bogus:true};ECM.Adapter.onUnload(function(){ECM.Adapter.namespace("ECM.Stash.affiliates").hash=null;ECM.Adapter.namespace("ECM.Stash.xdbs").hash=null;});})();}ECM.provide("ECM.CMS.Util.Transformation");ECM.CMS.Util.Transformation=function(f){var h=f.editor;var a=f.outValue;var g=f.inValue;var w=f.currentPosition;var u=f.outParamFormat;var t=f.outParamType;var x=f.outParamMaxAge;var l=f.outParamUserName;var m=f.outParamEmail;var k=f.outSelected;k=(k==="")?undefined:k;var p=f.inSelected;p=(p==="")?undefined:p;var z=f.tag;var d=z.replace(/\%/g,"");var b=d.split(/[(,)]/);var c=/^(\w+)\((\w+)\,(\w+)\s?.*?\)$/i;var o=/^(\w+)\((\w+)\((\w+)\,(\w+)\)\,(\w+)\s?.*?\)$/i;if(c.test(d)){d=b[1];}if(o.test(d)){d=b[2];}var y=ECM.CMS.Util.Transformation.getPriorityTransformationList();var n;var v;var q;if(Ext.isDefined(p)){if(Ext.isDefined(k)){if(p!==k){Ext.each(y,function(B,A){if(p===B){n=A;}if(k===B){v=A;}});if(Ext.isDefined(n)){if(Ext.isDefined(v)){if(n<v){p=f.outSelected;g=f.outValue;k=f.inSelected;a=f.inValue;}}else{k=f.inSelected;a=f.inValue;p=f.outSelected;g=f.outValue;}}}q=k+"("+p+"("+d+","+g+"),"+a+")";}else{k=f.inSelected;a=f.inValue;p="";g="";q=k+"("+d+","+a+")";}}else{if(Ext.isDefined(k)){q=k+"("+d+","+a+")";if(k==="encoding"){q=k+"("+a+","+u+","+t+")";}if(k==="bv"){q=k+"("+a+","+x+","+l+","+m+")";}}}var s=Ext.isDefined(q)?q:z;var r=h.getSearchCursor("%%",w);r.findPrevious();var j=h.getSearchCursor(z,r.from());j.findNext();h.replaceRange(s,j.from(),j.to());return true;};ECM.CMS.Util.Transformation.getPriorityTransformationList=function(){return["encoding","trim","fixcase","numberformat","dateformat"];};ECM.CMS.Util.Transformation.getTransformationList=function(){return[["Add","add","Value"],["Subtract","subtract","Value"],["Number Format","numberformat","Decimal"],["Add Days","add_days","Days"],["Subtract Days","subtract_days","Days"],["Date Format","dateformat","Format"],["Fix Case","fixcase","Casing"],["Trim","trim","Max Length"]];};ECM.CMS.Util.Transformation.getOuterOnlyTransformationList=function(){return[["Encoding","encoding","Field Name"],["Bazaarvoice","bv","User ID"]];};ECM.CMS.Util.Transformation.validationErrorMessage=function(b){var a;var c={outer:b.outerSelected||"",inner:b.innerSelected||""};Ext.iterate(c,function(d,f){switch(f){case"trim":a=gt.gettext("Max length must be an integer.");break;case"add_days":a=gt.gettext("Days must be a numeric value.");break;case"subtract_days":a=gt.gettext("Days must be a numeric value.");break;case"add":a=gt.gettext("Only number fields, decimal 2 fields, or numerical values may be used.");break;case"subtract":a=gt.gettext("Only number fields, decimal 2 fields, or numerical values may be used.");break;case"numberformat":a=gt.gettext("Only numerical values may be used.");break;case"fixcase":a=gt.gettext("Only string fields (lower, caps, proper, allproper) may be used.");break;case"encoding":a=gt.gettext("Only string fields may be used.");break;case"bv":a=gt.gettext("Only string fields userid may be used.");break;case"dateformat":a=gt.gettext("Only dateformat fields (Mon DD YYYY, Mon DD, M/DD/YYYY, M/DD/YY, M/DD, DD Mon YYYY, DD Mon, DD/M/YYYY, DD/M/YY, DD/M) may be used.");break;}});return a;};ECM.CMS.Util.Transformation.validateInputField=function(h){var d=h.outerSelected||"";var l=h.innerSelected||"";var k=h.outerValue||"";var b=h.innerValue||"";var n=/^\d+$/;var f=/^\w+$/;var g=/^\s*-?[1-9]\d*(\.\d{1,2})?\s*$/;var c=/trim|add_days|subtract_days|numberformat/i;var m=/add|subtract/i;var j=/lower|caps|proper|allproper/i;var a=/^(Mon\sDD\sYYYY|Mon\sDD|M\/DD\/YYYY|M\/DD\/YY|M\/DD|DD\sMon\sYYYY|DD\sMon|DD\/M\/YYYY|DD\/M\/YY|DD\/M)$/;if(d.match(c)){return n.test(k);}if(l.match(c)){return n.test(b);}if(d.match(m)){return(n.test(k)||g.test(k));}if(l.match(m)){return(n.test(b)||g.test(b));}if(d==="fixcase"){return k.match(j);}if(l==="fixcase"){return b.match(j);}if(d.match(/encoding|bv/i)){return f.test(k);}if(d==="dateformat"){return k.match(a);}if(l==="dateformat"){return b.match(a);}return true;};ECM.provide("ECM.CMS.Util.PersonalizationDefault");ECM.CMS.Util.insertPersonalizationDefault=function(a,d){var b=Ext.urlDecode(location.search.substring(1));var f={"save.x":1,json:1,mid:b.mid,mtype:Ext.isDefined(b.mtype)?b.mtype:1,tag_only:a};
f["PD_"+a]=d;var c=new Ext.LoadMask(Ext.getDom("ecm-window")||Ext.getBody(),{msg:gt.gettext("Updating default value..."),removeMask:true});c.show();ECM.Ajax.request({method:"POST",url:"/cm/mailing/personalization",params:f,success:function(g,h){Ext.Msg.show({cls:"blue_button",title:gt.gettext("SUCCESS"),msg:gt.gettext(g.responseJSON.data.message),buttons:Ext.Msg.OK,animEl:"elId",icon:Ext.MessageBox.INFO});c.hide();},failure:function(g,j){var h=g.responseJSON.application_errors.toString().replace(",","<br/>")||gt.gettext("Error in updating the default value.");Ext.Msg.show({cls:"blue_button",title:gt.gettext("ERROR"),msg:h,buttons:Ext.Msg.CANCEL,animEl:"elId",icon:Ext.MessageBox.ERROR});c.hide();}});return true;};var loadMask;ECM.CMS.Util.getPersonalizationDefault=function(a,c){var b=Ext.urlDecode(location.search.substring(1));loadMask=new Ext.LoadMask(Ext.getDom("ecm-window")||Ext.getBody(),{msg:gt.gettext("Retrieving default value..."),removeMask:true});loadMask.show();ECM.Ajax.request({url:"/cm/mailing/personalization",params:{json:1,mid:b.mid,mtype:b.mtype||c,tag_only:a},success:function(d,g){var f=d.responseJSON;Ext.getCmp("defaultValue").setValue(f.data.pers_fields[2]);loadMask.hide();},failure:function(d,g){var f=d.responseJSON.application_errors.toString().replace(",","<br/>")||gt.gettext("Error in retrieving the default value.");loadMask.hide();Ext.Msg.show({cls:"blue_button",title:gt.gettext("ERROR"),msg:f,buttons:Ext.Msg.CANCEL,animEl:"elId",icon:Ext.MessageBox.ERROR});}});};ECM.CMS.Util.getPersonalizationDefault.getLoadMask=function(){return loadMask;};ECM.provide("ECM.CMS.Modal.InsertPersonalization");ECM.CMS.Modal.InsertPersonalization=Ext.extend(ECM.Window,{testMode:false,modal:true,closable:true,closeAction:"close",cls:"common_form_styles personalization_modal",constructor:function(t){t=t||{};if(Ext.isDefined(t.testMode)){this.testMode=t.testMode;delete t.testMode;}var p=this;var u=t.tag,l=t.currentPosition,v=t.hideTransformation;var h=Ext.isDefined(t.mtype)?t.mtype:1;var w=/^(\w+)\((\w+)\,(.*?)\,?(.*?)\,?(.*?)\)$/i;var a=/^(\w+)\((\w+)\((\w+)\,(.*?)\)\,(.*?)\)$/i;var b=u.replace(/\(|\)/g,",").split(","),s=b[0];var o,k,g,n,r,m,j,q,f,d;if(w.test(u)){s=b[1];k=b[0];n=b[2];if(k==="bv"){s="bazaarvoice";n=b[1];q=b[2];f=b[3];d=b[4];}if(k==="encoding"){n=b[1];m=b[2];j=b[3];}}if(a.test(u)){s=b[2];k=b[0];g=b[1];n=b[5];r=b[3];}s=Ext.util.Format.uppercase(s);if(!s.match(/BAZAARVOICE|TODAY/)){o=ECM.CMS.Util.getPersonalizationDefault(s,h);}var c="";if(Ext.isDefined(Ext.getCmp("contentPanelId"))){c=!this.testMode?Ext.getCmp("contentPanelId").getCodeMirrorActiveEditor():"";}else{if(Ext.isDefined(Ext.getCmp("settingsFormPanel"))){c=Ext.getCmp("settingsFormPanel").getCodeMirrorActiveComponent();}}this.title=gt.gettext("Insert Personalization");this.personalizationLabel=new Ext.form.Label({fieldLabel:gt.gettext(s),labelStyle:"font-weight:bold;",labelSeparator:""});this.defaultField=new Ext.form.TextField({id:"defaultValue",fieldLabel:gt.gettext("Default value"),anchor:"95%",value:o||""});this.transformationField={id:"transformPanel",xtype:"fieldset",title:gt.gettext("Add field transformation"),autoHeight:true,layout:"form",collapsed:true,collapsible:true,listeners:{expand:function(){var x;var y=Ext.getCmp("outSelected").getValue();if(y==="bv"){x=gt.gettext("User ID:");}else{if(y==="encoding"){x=gt.gettext("Field Name:");}}if(x){var z=(Ext.isEmpty(z)||Ext.isEmpty(z.get("format")))?"":z.get("format")+":";Ext.getCmp("outValue").label.update(z||x||gt.gettext("Details:"));}p.configFieldSet(s);if(Ext.getCmp("outSelected").getValue()==="encoding"){p.setEncodingContainerVisible({visible:true,outParamFormat:m,outParamType:j});}else{p.setEncodingContainerVisible({visible:false});}if(Ext.getCmp("outSelected").getValue()==="bv"){p.setBvContainerVisible({visible:true,outParamMaxAge:q,outParamUserName:f,outParamEmail:d});}else{p.setBvContainerVisible({visible:false});}}},items:[{xtype:"label",fieldLabel:gt.gettext("Transformation"),labelStyle:"font-weight:bold;"},{xtype:"component",autoEl:{tag:"a",html:gt.gettext("Cancel transformation")},style:{position:"relative",top:"-22px",left:"350px"},listeners:{render:function(x){x.getEl().on({click:function(){if(Ext.getCmp("outSelected").getValue()==="encoding"){Ext.getCmp("outParamFormat").setValue();Ext.getCmp("outParamType").setValue();}if(Ext.getCmp("outSelected").getValue()==="bv"){Ext.getCmp("outParamMaxAge").setValue();Ext.getCmp("outParamUserName").setValue();Ext.getCmp("outParamEmail").setValue();}Ext.getCmp("outSelected").setValue();Ext.getCmp("outValue").setValue();Ext.getCmp("outValue").label.update(gt.gettext("Details:"));Ext.getCmp("inSelected").setValue();Ext.getCmp("inValue").setValue();Ext.getCmp("transformPanel").collapse();}});}}},{xtype:"combo",id:"outSelected",fieldLabel:gt.gettext("Select"),labelStyle:"width:120px;",editable:false,store:new Ext.data.ArrayStore({fields:["transformation","list","format"],data:ECM.CMS.Util.Transformation.getTransformationList().concat(ECM.CMS.Util.Transformation.getOuterOnlyTransformationList())}),valueField:"list",displayField:"transformation",typeAhead:true,mode:"local",triggerAction:"all",value:k||"",emptyText:gt.gettext("Select a transformation"),selectOnFocus:true,anchor:"95%",listeners:{select:function(x,y){if(Ext.getCmp("outSelected").getValue()!==""){var y=Ext.isEmpty(y.get("format"))?"":y.get("format")+":";Ext.getCmp("outValue").label.update(y||gt.gettext("Details:"));}Ext.getCmp("outValue").setValue();p.configFieldSet(s);if(Ext.getCmp("outSelected").getValue()==="encoding"){p.setEncodingContainerVisible({visible:true});}else{p.setEncodingContainerVisible({visible:false});}if(Ext.getCmp("outSelected").getValue()==="bv"){p.setBvContainerVisible({visible:true});Ext.getCmp("outParamMaxAge").setValue();Ext.getCmp("outParamUserName").setValue();Ext.getCmp("outParamEmail").setValue();}else{p.setBvContainerVisible({visible:false});}},afterrender:function(){p.configFieldSet(s);if(Ext.getCmp("outSelected").getValue()==="encoding"){p.setEncodingContainerVisible({visible:true,outParamFormat:m,outParamType:j});}else{p.setEncodingContainerVisible({visible:false});}if(Ext.getCmp("outSelected").getValue()==="bv"){p.setBvContainerVisible({visible:true,outParamMaxAge:q,outParamUserName:f,outParamEmail:d});}else{p.setBvContainerVisible({visible:false});}}}},{xtype:"textfield",id:"outValue",fieldLabel:gt.gettext("Details"),labelStyle:"width:120px;",value:n||"",anchor:"95%",validator:function(y){var z=Ext.getCmp("outSelected").getValue();if(!ECM.CMS.Util.Transformation.validateInputField({outerValue:y,outerSelected:z})){var x=ECM.CMS.Util.Transformation.validationErrorMessage({outerSelected:z});return gt.gettext(x);}return true;}},{xtype:"container",id:"outerAddBvFields",hidden:true},{xtype:"container",id:"outerAddEncodingFields",hidden:true},{xtype:"fieldset",title:gt.gettext("Add a transformation"),autoHeight:true,layout:"form",collapsed:true,collapsible:true,items:[{xtype:"combo",id:"inSelected",fieldLabel:gt.gettext("Select"),labelStyle:"width:120px;",editable:false,store:new Ext.data.ArrayStore({fields:["transformation","list","format"],data:ECM.CMS.Util.Transformation.getTransformationList()}),valueField:"list",displayField:"transformation",typeAhead:true,mode:"local",triggerAction:"all",value:g||"",emptyText:gt.gettext("Select a transformation"),selectOnFocus:true,anchor:"95%",listeners:{select:function(x,y){var y=Ext.isEmpty(y.get("format"))?"":y.get("format")+":";Ext.getCmp("inValue").label.update(y||gt.gettext("Details:"));}}},{xtype:"textfield",id:"inValue",fieldLabel:gt.gettext("Details"),labelStyle:"width:120px;",value:r||"",anchor:"95%",validator:function(z){var y=Ext.getCmp("inSelected").getValue();if(!ECM.CMS.Util.Transformation.validateInputField({innerValue:z,innerSelected:y})){var x=ECM.CMS.Util.Transformation.validationErrorMessage({innerSelected:y});return gt.gettext(x);}return true;}}]}]};this.items=[new Ext.form.FormPanel({items:[this.personalizationLabel,this.defaultField]})];
if(!t.hideTransformation){this.items.push(this.transformationField);}this.windowButtons=[{text:gt.gettext("Done"),handler:function(){var y=false;var z=false;if(!t.hideTransformation){if(Ext.type(c)==="object"){c.operation(function(){var K=Ext.getDom("defaultValue").value;var H,M;var L,E,G,J,B,D,A;H=p.trimInputValue(Ext.getCmp("outSelected").getValue());M=p.trimInputValue(Ext.getCmp("inSelected").getValue());L=p.trimInputValue(Ext.getCmp("outValue").getValue());E=p.trimInputValue(Ext.getCmp("inValue").getValue());G=(H==="encoding")?p.trimInputValue(Ext.getCmp("outParamFormat").getValue()):undefined;J=(H==="encoding")?p.trimInputValue(Ext.getCmp("outParamType").getValue()):undefined;B=(H==="bv")?p.trimInputValue(Ext.getCmp("outParamMaxAge").getValue()):undefined;D=(H==="bv")?p.trimInputValue(Ext.getCmp("outParamUserName").getValue()):undefined;A=(H==="bv")?p.trimInputValue(Ext.getCmp("outParamEmail").getValue().inputValue):undefined;if(H.match(/bv/)&&(Ext.isEmpty(L)||Ext.isEmpty(B))){var I=[];if(Ext.isEmpty(L)){I.push("User ID");}if(Ext.isEmpty(B)){I.push("Max Age");}if(I.length>1){I=I.join(gt.gettext(" and "));p.notify.error(gt.strargs("%1 is required.",[I]));z=true;}else{p.notify.error(gt.strargs("%1 is required.",[I]));z=true;}}else{if(H.match(/encoding/)&&(Ext.isEmpty(L)||Ext.isEmpty(G)||Ext.isEmpty(J))){var N=[];if(Ext.isEmpty(L)){N.push("Field Name");}if(Ext.isEmpty(G)){N.push("Format");}if(Ext.isEmpty(J)){N.push("Type");}if(N.length>=3){p.notify.error(gt.gettext("Field Name, Format and Type are required."));z=true;}else{if(N.length>1){N=N.join(gt.gettext(" and "));p.notify.error(gt.strargs("%1 is required.",[N]));z=true;}else{p.notify.error(gt.strargs("%1 is required.",[N]));z=true;}}}else{if((H&&Ext.isEmpty(L))||(M&&Ext.isEmpty(E))){var F=[];if((H.match(/^dateformat$/)&&Ext.isEmpty(L))||(M.match(/^dateformat$/)&&Ext.isEmpty(E))){F.push("Format");z=true;}if((H.match(/^add$|^subtract$/)&&Ext.isEmpty(L))||(M.match(/^add$|^subtract$/)&&Ext.isEmpty(E))){F.push("Value");z=true;}if((H.match(/^numberformat$/)&&Ext.isEmpty(L))||(M.match(/^numberformat$/)&&Ext.isEmpty(E))){F.push("Decimal");z=true;}if((H.match(/^add_days$|^subtract_days$/)&&Ext.isEmpty(L))||(M.match(/^add_days$|^subtract_days$/)&&Ext.isEmpty(E))){F.push("Days");z=true;}if((H.match(/^fixcase$/)&&Ext.isEmpty(L))||(M.match(/^fixcase$/)&&Ext.isEmpty(E))){F.push("Casing");z=true;}if((H.match(/^trim$/)&&Ext.isEmpty(L))||(M.match(/^trim$/)&&Ext.isEmpty(E))){F.push("Max Length");z=true;}if(F.length>1){F=F.join(gt.gettext(" and "));}p.notify.error(gt.strargs("%1 is required.",[F]));z=true;}else{y=ECM.CMS.Util.Transformation({tag:u,editor:c,outSelected:H,inSelected:M,outValue:L,outParamFormat:G,outParamType:J,outParamMaxAge:B,outParamUserName:D,outParamEmail:A,inValue:E,currentPosition:l});z=false;}}}});}}var x=Ext.getDom("defaultValue").value;if(!z&&!s.match(/BAZAARVOICE|TODAY/)){y=ECM.CMS.Util.insertPersonalizationDefault(s,x);}if(y){p.close();}}},{text:gt.gettext("Cancel"),handler:function(){p.close();}}];ECM.CMS.Modal.InsertPersonalization.superclass.constructor.apply(this,arguments);},afterRender:function(){ECM.CMS.Modal.InsertPersonalization.superclass.afterRender.call(this);this.on("close",function(){var a=ECM.CMS.Util.getPersonalizationDefault.getLoadMask();if(Ext.isDefined(a)){a.hide();}});},configFieldSet:function(a){if(Ext.getCmp("outSelected").getValue().match(/bv/)){Ext.getCmp("inSelected").setValue();Ext.getCmp("inValue").setValue();Ext.getCmp("inSelected").disable();Ext.getCmp("inValue").disable();Ext.getCmp("defaultValue").disable();}else{if(Ext.getCmp("outSelected").getValue().match(/encoding/)){Ext.getCmp("inSelected").setValue();Ext.getCmp("inValue").setValue();Ext.getCmp("inSelected").disable();Ext.getCmp("inValue").disable();}else{Ext.getCmp("inSelected").enable();Ext.getCmp("inValue").enable();Ext.getCmp("defaultValue").enable();}}if(a==="TODAY"){Ext.getCmp("defaultValue").disable();}},setEncodingContainerVisible:function(a){if(this.rendered){if(a.visible){this.showEncodingContainer(a);}else{this.hideEncodingContainer();}}return this;},setBvContainerVisible:function(a){if(this.rendered){if(a.visible){this.showBvContainer(a);}else{this.hideBvContainer();}}return this;},showEncodingContainer:function(a){Ext.getCmp("outerAddBvFields").initItems();var b=Ext.getCmp("outerAddEncodingFields");b.initItems();if(b.items.length===0){b.add(this.getEncodingContainer(a));}b.show();this.doLayout();},showBvContainer:function(a){Ext.getCmp("outerAddEncodingFields").initItems();var b=Ext.getCmp("outerAddBvFields");b.initItems();if(b.items.length===0){b.add(this.getBvContainer(a));}b.show();this.doLayout();},hideEncodingContainer:function(){Ext.getCmp("outerAddEncodingFields").hide();this.doLayout();},hideBvContainer:function(){Ext.getCmp("outerAddBvFields").hide();this.doLayout();},getEncodingContainer:function(a){this.encodingTypeField=new Ext.Container({autoEl:"div",defaults:{xtype:"container",autoEl:"div",layout:"form"},items:[{items:{xtype:"textfield",id:"outParamFormat",fieldLabel:gt.gettext("Format"),labelStyle:"width:120px;",value:a.outParamFormat||"",anchor:"95%",validator:function(c){var b=/^(url|html)$/i;if(!b.test(c)){return gt.gettext("Only string fields (url/html) may be used.");}return true;}}},{items:{xtype:"textfield",id:"outParamType",fieldLabel:gt.gettext("Type"),labelStyle:"width:120px;",value:a.outParamType||"",anchor:"95%",validator:function(c){var b=/^(e|d)$/i;if(!b.test(c)){return gt.gettext("Only string fields (e/d) may be used.");}return true;}}}]});return this.encodingTypeField;},getBvContainer:function(a){this.BvField=new Ext.Container({autoEl:"div",defaults:{xtype:"container",autoEl:"div",layout:"form"},items:[{items:{xtype:"numberfield",id:"outParamMaxAge",fieldLabel:gt.gettext("Max Age"),labelStyle:"width:120px;",value:a.outParamMaxAge||"",anchor:"95%",nanText:gt.gettext("Only integer fields containing numbers may be used.")}},{items:{xtype:"textfield",id:"outParamUserName",fieldLabel:gt.gettext("User Name"),labelStyle:"width:120px;",value:a.outParamUserName||"",anchor:"95%",vtype:"alphanum",vtypeText:gt.gettext("Only string fields containing letters may be used.")}},{items:{xtype:"radiogroup",id:"outParamEmail",fieldLabel:gt.gettext("Email"),labelStyle:"width:120px;",anchor:"95%",items:[{boxLabel:"Yes",name:"outParamEmailSet",checked:(a.outParamEmail?true:false),inputValue:"email"},{boxLabel:"No",checked:(a.outParamEmail?false:true),name:"outParamEmailSet",inputValue:""}]}}]});return this.BvField;},trimInputValue:function(a){return a.toString().replace(/^\s+|\s+$/g,"");}});ECM.provide("ECM.CodeMirror2.DCMirror");ECM.CodeMirror2.DCMirror.onMouseOver=function(f,h,b){f=f.replace(/ /g,"");var a;switch(f){case ("dc-good"):case ("dc-bad"):if(b.dynamicContent){break;}case ("p13n-good"):if(f==="p13n-good"&&b.personalization){break;}if(!this.tip||!this.tip.isVisible()){this.tip=new Ext.ToolTip({title:gt.gettext("Double-click to edit"),dismissDelay:1800});}break;case ("invalid-text-field"):if(!this.tip||!this.tip.isVisible()){this.tip=new Ext.ToolTip({html:gt.gettext("This field is required"),header:false,dismissDelay:1800,cls:"x-tip"});}break;case ("invalid-email"):if(!this.tip||!this.tip.isVisible()){this.tip=new Ext.ToolTip({html:gt.gettext("Invalid Email Address"),header:false,dismissDelay:1800,cls:"x-tip x-form-invalid-tip"});}break;default:this.tip=undefined;}if(this.tip&&!this.tip.isVisible()){var d;var c;if("pageX" in h.e){d=h.e.pageX;c=h.e.pageY;}else{d=h.e.clientX+document.documentElement.scrollLeft;c=h.e.clientY+document.documentElement.scrollTop;}var g=this;setTimeout(function(){if(Ext.isDefined(g.tip)){g.tip.showAt([d+5,c+5]);}},900);}};ECM.CodeMirror2.DCMirror.onDoubleClick=function(l,o,m,d,p){l=l.replace(/ /g,"");var g=p.mode.dcP13n,h=p.disable;switch(l){case ("dc-good"):case ("dc-bad"):if(h.dynamicContent){break;}var a=Ext.getCmp("leftnav_panel");var f=Ext.getCmp("leftnav_dc");if(Ext.isGecko3&&Ext.isDefined(f)){f.fixFireFox3Glitch("fixed","hidden");}if(g.mtype===2){var b=o.match(/^(d_)([^[\]]+)?(?:\[(.*)\])?/i);
if(!b[3]){b[3]="KEY";}if(!b[2]){b[2]="";}}var j=(g.mtype===2)?b[1]+b[2]:o;var k={desiredAid:g.desiredAid,dcid:-1,mfid:g.mfid,mid:g.mid,mailingType:g.mtype,id:(g.mtype===2)?b[2]:o.replace(/^d_/i,""),key:(g.mtype===2)?b[3]:undefined,onClose:function(){if(Ext.isGecko3&&Ext.isDefined(f)){f.fixFireFox3Glitch("absolute","");}ECM.Form.DCEditor.onDCModalClose.apply(this,arguments);if(Ext.isEmpty(arguments[0])){return;}var s=arguments[0].identity;var q=arguments[0].deleted;if(k.useLibrary){var t=a.dcLibOverwrite.indexOf(j.toLowerCase());if(t!==-1){a.dcLibOverwrite.splice(t,1);delete a.libTags[j.toUpperCase()];}}if(!q&&s!==j){var u=m.getSearchCursor("%%",d);u.findPrevious();var v=m.getSearchCursor(j,u.from());v.findNext();m.replaceRange(s,v.from(),v.to());}if(s!==j.toLowerCase()||k.isAmbivalent){var r=ECM.Form.DCEditor.data("DC");delete r[0][j.toUpperCase()];if(!q){r[0][s.toUpperCase()]=[s,arguments[0].description,arguments[0].tagType];}Ext.getCmp("leftnav_panel").resetCodeMirror(r[0]);f.resetCodeMirror=false;}if(Ext.isDefined(f.tree)){f.refreshTree();}else{if(!f.newDcTree.hidden){f.loadTreeData();}}}};o=(g.mtype===2)?o.replace(/\[.*\]/,""):o;o=o.toLowerCase();if(a.dcLibOverwrite.indexOf(o)!==-1){k.useLibrary=true;}else{if(l==="dc-bad"&&g.mtype===1){k.isAmbivalent=true;}else{if(l==="dc-bad"&&g.mtype===2){var c=[];if(Ext.isArray(g.dc)){Ext.each(g.dc,function(q){if(q.tag){c.push(q.tag);}});}else{if(Ext.isObject(g.dc)){Ext.iterate(g.dc,function(q,r){c.push(q.toLowerCase());});}}if(c.indexOf(o)===-1){k.isAmbivalent=true;}}}}ECM.Rules.DynamicContent.modify(k);break;case ("p13n-good"):if(h.personalization){break;}var n=new ECM.CMS.Modal.InsertPersonalization({tag:o,currentPosition:d});n.show();break;}};ECM.provide("ECM.CodeMirror2.codemirror");var CodeMirror=(function(){function z(R,aY){var a9={},aT=z.defaults;for(var bo in aT){if(aT.hasOwnProperty(bo)){a9[bo]=(aY&&aY.hasOwnProperty(bo)?aY:aT)[bo];}}var bE=a9.document;var bm=bE.createElement("div");if(aY.type=="textfield"){bm.className="x-form-text CodeMirror_textfield";bm.style.width=aY.width;bm.style.height="18px";if(window.ActiveXObject&&/MSIE [1-7]\b/.test(navigator.userAgent)){bm.style.position="relative";}bm.innerHTML='<div style="position: relative; margin-top: -2.5px; margin-left: -3px;"><div style="position: absolute; height: 0; width: 0; overflow: hidden;"></div><div style="position: relative"><div class="CodeMirror-gutter"><div class="CodeMirror-gutter-text"></div></div><div style="overflow: hidden; position: absolute; width: 1px; height: 0; left: 0"><textarea class="CodeMirror-TextArea" style="position: absolute; width: 100000px;" wrap="off"></textarea></div><div class="CodeMirror-lines"; style="padding: .1em; font-family: arial,tahoma,helvetica,sans-serif;"><div style="position: relative"><pre class="CodeMirror-cursor">&#160;</pre><div id='+aY.id+"></div></div></div></div></div>";}else{bm.className="CodeMirror";if(window.ActiveXObject&&/MSIE [1-7]\b/.test(navigator.userAgent)){bm.style.position="relative";}bm.innerHTML='<div style="position: relative"><div style="position: absolute; height: 0; width: 0; overflow: hidden;"></div><div style="position: relative"><div class="CodeMirror-gutter"><div class="CodeMirror-gutter-text"></div></div><div style="overflow: hidden; position: absolute; width: 1px; height: 0; left: 0"><textarea class="CodeMirror-TextArea" style="position: absolute; width: 100000px;" wrap="off"></textarea></div><div class="CodeMirror-lines"><div style="position: relative"><pre class="CodeMirror-cursor">&#160;</pre><div></div></div></div></div></div>';}if(R.appendChild){R.appendChild(bm);}else{R(bm);}var aC=bm.firstChild,av=aC.firstChild,bi=av.nextSibling,aM=bi.firstChild,bP=aM.firstChild,bU=aM.nextSibling,bR=bU.firstChild,aF=bU.nextSibling.firstChild,aa=aF.firstChild,ae=aa.nextSibling;if(a9.tabindex!=null){bR.tabindex=a9.tabindex;}if(!a9.gutter&&!a9.lineNumbers){aM.style.display="none";}var aE=new m(),ao=new m(),ad;var bb,bL=[new A("")],a2,aZ=new c(),K;bk();var aO={from:{line:0,ch:0},to:{line:0,ch:0},inverted:false};var a1,bu,ac;var bg,bJ,aH,aj,bH;var bd=0,bs=0,bz=0,aL=null;var S,by;var aG="";var bC=false;var a8=false;bM(function(){ag(a9.value||"");bg=false;})();setTimeout(aA,20);f(bm,"mousedown",bM(ap));if(!p){f(bm,"contextmenu",bM(al));}f(aC,"dblclick",bM(bc));f(aC,"mouseover",bM(an));f(bm,"scroll",function(){ab([]);if(a9.onScroll){a9.onScroll(bI);}});f(window,"resize",function(){ab(true);});f(bR,"keyup",bM(bh));f(bR,"keydown",bM(at));f(bR,"keypress",bM(a6));f(bR,"focus",aB);f(bR,"blur",az);f(bm,"dragenter",function(bW){bW.stop();});f(bm,"dragover",function(bW){bW.stop();});f(bm,"drop",bM(ai));f(bm,"paste",function(){am();bG();});f(bR,"paste",function(){bG();});f(bR,"cut",function(){bG();});if(bE.activeElement==bR){aB();}else{az();}function L(bW){return bW>=0&&bW<bL.length;}var bI={getValue:ba,setValue:bM(ag),getSelection:bB,replaceSelection:bM(ah),focus:function(){am();aB();bG();},setOption:function(bW,bX){a9[bW]=bX;if(bW=="lineNumbers"||bW=="gutter"){N();}else{if(bW=="mode"||bW=="indentUnit"){bk();}else{if(bW=="readOnly"&&bX=="nocursor"){bR.blur();}}}},getOption:function(bW){return a9[bW];},undo:bM(bw),redo:bM(bV),indentLine:bM(function(bW){if(L(bW)){ar(bW,"smart");}}),historySize:function(){return{undo:aZ.done.length,redo:aZ.undone.length};},matchBrackets:bM(function(){aq(true);}),getTokenAt:function(bW){bW=af(bW);return bL[bW.line].getTokenAt(bb,aD(bW.line),bW.ch);},cursorCoords:function(bW){if(bW==null){bW=aO.inverted;}return bq(bW?aO.from:aO.to);},charCoords:function(bW){return bq(af(bW));},coordsChar:function(bX){var bY=B(aF);var bW=aV(Math.min(bL.length-1,bd+Math.floor((bX.y-bY.top)/bK())));return af({line:bW,ch:a7(aV(bW),bX.x-bY.left)});},getSearchCursor:function(bX,bY,bW){return new aw(bX,bY,bW);},markText:bM(function(bX,bW,bY){return bM(Q(bX,bW,bY));}),setMarker:ak,clearMarker:Z,setLineClass:bM(aK),lineInfo:W,addWidget:function(bY,bX,bW){var bY=br(af(bY),true);bX.style.top=(bd*bK()+bY.yBot+a3())+"px";bX.style.left=(bY.x+bj())+"px";aC.appendChild(bX);if(bW){bT(bY.x,bY.yBot,bY.x+bX.offsetWidth,bY.yBot+bX.offsetHeight);}},lineCount:function(){return bL.length;},getCursor:function(bW){if(bW==null){bW=aO.inverted;}return r(bW?aO.from:aO.to);},somethingSelected:function(){return !o(aO.from,aO.to);},setCursor:bM(function(bW,bX){if(bX==null&&typeof bW.line=="number"){aR(bW.line,bW.ch);}else{aR(bW,bX);}}),setSelection:bM(function(bX,bW){bt(af(bX),af(bW||bX));}),getLine:function(bW){if(L(bW)){return bL[bW].text;}},setLine:bM(function(bW,bX){if(L(bW)){bl(bX,{line:bW,ch:0},{line:bW,ch:bL[bW].text.length});}}),removeLine:bM(function(bW){if(L(bW)){bl("",{line:bW,ch:0},af({line:bW+1,ch:0}));}}),replaceRange:bM(bl),getRange:function(bX,bW){return a4(af(bX),af(bW));},operation:function(bW){return bM(bW)();},refresh:function(){ab(true);},getInputField:function(){return bR;},getWrapperElement:function(){return bm;},setInvalid:bp,setValid:X};function ag(bW){aZ=null;var bX={line:0,ch:0};bf(bX,{line:bL.length-1,ch:bL[bL.length-1].text.length},w(bW),bX,bX);aZ=new c();}function ba(bY){var bZ=[];for(var bX=0,bW=bL.length;bX<bW;++bX){bZ.push(bL[bX].text);}return bZ.join("\n");}function bp(bW){if(bm.className.search("x-form-invalid")==-1){bm.className+=" x-form-invalid";}a8=true;bC=bW?true:false;}function X(bW){bm.className=bm.className.replace(" x-form-invalid","");a8=false;bC=false;}function ap(b3){var b5=Ext.isIE?2000:150;var bW=ac;ac=null;for(var bZ=b3.target();bZ!=bm;bZ=bZ.parentNode){if(bZ.parentNode==bP){if(a9.onGutterClick){a9.onGutterClick(bI,d(bP.childNodes,bZ)+bd);}return b3.stop();}}if(p&&b3.button()==3){al(b3);}if(b3.button()!=1){return;}var bX=Y(b3),b6=bX,bY;if(!bX){if(b3.target()==bm){b3.stop();}return;}if(!K){aB();}b3.stop();if(bW&&+new Date-bW<400){return aJ(bX.line);}aR(bX.line,bX.ch,true);function b1(){am();bg=true;b0();b2();}function b4(b7){var b9=Y(b7,true);if(b9&&!o(b9,b6)){if(!K){aB();}b6=b9;aN(bX,b9);bg=false;var b8=bN();if(b9.line>=b8.to||b9.line<b8.from){bY=setTimeout(bM(function(){b4(b7);
}),b5);}}}var b0=f(bE,"mousemove",bM(function(b7){clearTimeout(bY);b7.stop();b4(b7);}),true);var b2=f(bE,"mouseup",bM(function(b7){clearTimeout(bY);var b8=Y(b7);if(b8){aN(bX,b8);}b7.stop();b1();}),true);}var a5=navigator.userAgent.indexOf("MSIE")>=0?function(bW){if(!bW){bW=window.event;}if(bW){return bW.srcElement;}}:function(bW){return bW.target;};function bc(bY){var b0=bI.getCursor();var bW=bI.getTokenAt(b0);var bX=bW.className;if(bX!==null){bX=bX.replace(/\s/g,"");}switch(bX){case ("dc-good"):case ("dc-bad"):case ("p13n-good"):var bZ=bW.string.match(/%%(.*?)%%/);ECM.CodeMirror2.DCMirror.onDoubleClick(bX,bZ[1],bI,b0,a9);break;default:var b0=Y(bY);if(!b0){return;}be(b0);}bY.stop();ac=+new Date;}function an(bX){var bW=a5(bX.e);ECM.CodeMirror2.DCMirror.onMouseOver(bW.className,bX,a9.disable);if(a8){if(bC){ECM.CodeMirror2.DCMirror.onMouseOver("invalid-email",bX);}else{ECM.CodeMirror2.DCMirror.onMouseOver("invalid-text-field",bX);}}bX.stop();}function ai(b0){var b3=Y(b0,true),bX=b0.e.dataTransfer.files;if(!b3||a9.readOnly){return;}if(bX&&bX.length&&window.FileReader&&window.File){var b2=bX.length,b1=Array(b2),bY=0;for(var bW=0;bW<b2;++bW){bZ(bX[bW],bW);}function bZ(b6,b5){var b4=new FileReader;b4.onload=function(){b1[b5]=b4.result;if(++bY==b2){bl(b1.join(""),af(b3),af(b3));}};b4.readAsText(b6);}}else{try{var b1=b0.e.dataTransfer.getData("Text");if(b1){bl(b1,b3,b3);}}catch(b0){}}}function at(b0){if(!K){aB();}var bZ=b0.e.keyCode;var bY=(k?b0.e.metaKey:b0.e.ctrlKey)&&!b0.e.altKey,bX=b0.e.ctrlKey||b0.e.altKey||b0.e.metaKey;if(bZ==16||b0.e.shiftKey){a1=a1||(aO.inverted?aO.to:aO.from);}else{a1=null;}if(a9.onKeyEvent&&a9.onKeyEvent(bI,t(b0.e))){return;}if(bZ==33||bZ==34){bD(bZ==34);return b0.stop();}if(bY&&((bZ==36||bZ==35)||k&&(bZ==38||bZ==40))){bO(bZ==36||bZ==38);return b0.stop();}if(bY&&bZ==65){bn();return b0.stop();}if(!a9.readOnly){if(!bX&&bZ==13){return;}if(!bX&&bZ==9&&ax(b0.e.shiftKey)){return b0.stop();}if(bY&&bZ==90){bw();return b0.stop();}if(bY&&((b0.e.shiftKey&&bZ==90)||bZ==89)){bV();return b0.stop();}}aL=(bY?"c":"")+bZ;if(aO.inverted&&u.hasOwnProperty(aL)){var bW=I(bR);if(bW){bu={anchor:bW.start};g(bR,bW.start,bW.start);}}bG(aL);}function bh(bW){if(a9.onKeyEvent&&a9.onKeyEvent(bI,t(bW.e))){return;}if(bu){bu=null;bg=true;}if(bW.e.keyCode==16){a1=null;}}function a6(bY){if(a9.onKeyEvent&&a9.onKeyEvent(bI,t(bY.e))){return;}if(a9.electricChars&&bb.electricChars){var bW=String.fromCharCode(bY.e.charCode==null?bY.e.keyCode:bY.e.charCode);if(bb.electricChars.indexOf(bW)>-1){setTimeout(bM(function(){ar(aO.to.line,"smart");}),50);}}var bX=bY.e.keyCode;if(bX==13){if(!a9.readOnly){ay();}bY.stop();}else{if(!bY.e.ctrlKey&&!bY.e.altKey&&!bY.e.metaKey&&bX==9&&a9.tabMode!="default"){bY.stop();}else{bG(aL);}}}function aB(){if(a9.readOnly=="nocursor"){return;}if(!K&&a9.onFocus){a9.onFocus(bI);}K=true;bv();if(bm.className.search(/\bCodeMirror-focused\b/)==-1){bm.className+=" CodeMirror-focused";}M();}function az(){if(K&&a9.onBlur){a9.onBlur(bI);}clearInterval(ad);a1=null;K=false;bm.className=bm.className.replace(" CodeMirror-focused","");}function bf(b3,b2,b0,bX,bW){if(aZ){var bY=[];for(var bZ=b3.line,b1=b2.line+1;bZ<b1;++bZ){bY.push(bL[bZ].text);}aZ.addChange(b3.line,b0.length,bY);while(aZ.done.length>a9.undoDepth){aZ.done.shift();}}O(b3,b2,b0,bX,bW);}function aQ(b2,b1){var b0=b2.pop();if(b0){var bY=[],bW=b0.start+b0.added;for(var bX=b0.start;bX<bW;++bX){bY.push(bL[bX].text);}b1.push({start:b0.start,added:b0.old.length,old:bY});var bZ=af({line:b0.start+b0.old.length-1,ch:l(bY[bY.length-1],b0.old[b0.old.length-1])});O({line:b0.start,ch:0},{line:bW-1,ch:bL[bW-1].text.length},b0.old,bZ,bZ);}}function bw(){aQ(aZ.done,aZ.undone);}function bV(){aQ(aZ.undone,aZ.done);}function O(b7,b0,cc,bW,cd){var cb=false,bZ=aG.length;for(var b8=b7.line;b8<b0.line;++b8){if(bL[b8].text.length==bZ){cb=true;break;}}var b3=b0.line-b7.line,b2=bL[b7.line],bX=bL[b0.line];if(b2==bX){if(cc.length==1){b2.replace(b7.ch,b0.ch,cc[0]);}else{bX=b2.split(b0.ch,cc[cc.length-1]);var b4=[b7.line+1,b3];b2.replace(b7.ch,b2.text.length,cc[0]);for(var b8=1,ca=cc.length-1;b8<ca;++b8){b4.push(new A(cc[b8]));}b4.push(bX);bL.splice.apply(bL,b4);}}else{if(cc.length==1){b2.replace(b7.ch,b2.text.length,cc[0]+bX.text.slice(b0.ch));bL.splice(b7.line+1,b3);}else{var b4=[b7.line+1,b3-1];b2.replace(b7.ch,b2.text.length,cc[0]);bX.replace(0,b0.ch,cc[cc.length-1]);for(var b8=1,ca=cc.length-1;b8<ca;++b8){b4.push(new A(cc[b8]));}bL.splice.apply(bL,b4);}}for(var b8=b7.line,ca=b8+cc.length;b8<ca;++b8){var b6=bL[b8].text;if(b6.length>bZ){aG=b6;bZ=b6.length;cb=false;}}if(cb){bZ=0;for(var b8=0,ca=bL.length;b8<ca;++b8){var b6=bL[b8].text;if(b6.length>bZ){bZ=b6.length;aG=b6;}}}var bY=[],b1=cc.length-b3-1;for(var b8=0,b6=a2.length;b8<b6;++b8){var b9=a2[b8];if(b9<b7.line){bY.push(b9);}else{if(b9>b0.line){bY.push(b9+b1);}}}if(cc.length){bY.push(b7.line);}a2=bY;bQ(100);bJ.push({from:b7.line,to:b0.line+1,diff:b1});aH={from:b7,to:b0,text:cc};function b5(ce){return ce<=Math.min(b0.line,b0.line+b1)?ce:ce+b1;}bt(bW,cd,b5(aO.from.line),b5(aO.to.line));aC.style.height=(bL.length*bK()+2*a3())+"px";}function bl(bX,b0,bZ){b0=af(b0);if(!bZ){bZ=b0;}else{bZ=af(bZ);}bX=w(bX);function bY(b3){if(n(b3,b0)){return b3;}if(!n(bZ,b3)){return bW;}var b1=b3.line+bX.length-(bZ.line-b0.line)-1;var b2=b3.ch;if(b3.line==bZ.line){b2+=bX[bX.length-1].length-(bZ.ch-(bZ.line==b0.line?b0.ch:0));}return{line:b1,ch:b2};}var bW;bx(bX,b0,bZ,function(b1){bW=b1;return{from:bY(aO.from),to:bY(aO.to)};});return bW;}function ah(bW,bX){bx(w(bW),aO.from,aO.to,function(bY){if(bX=="end"){return{from:bY,to:bY};}else{if(bX=="start"){return{from:aO.from,to:aO.from};}else{return{from:aO.from,to:bY};}}});}function bx(bZ,b1,b0,bW){var bY=bZ.length==1?bZ[0].length+b1.ch:bZ[bZ.length-1].length;var bX=bW({line:b1.line+bZ.length-1,ch:bY});bf(b1,b0,bZ,bX.from,bX.to);}function a4(b1,b0){var bX=b1.line,bW=b0.line;if(bX==bW){return bL[bX].text.slice(b1.ch,b0.ch);}var bZ=[bL[bX].text.slice(b1.ch)];for(var bY=bX+1;bY<bW;++bY){bZ.push(bL[bY].text);}bZ.push(bL[bW].text.slice(0,b0.ch));return bZ.join("\n");}function bB(){return a4(aO.from,aO.to);}var aU=false;function bv(){if(aU){return;}aE.set(2000,function(){U();bF();if(K){bv();}aI();});}function bG(bY){var bW=false;aU=true;function bX(){U();var bZ=bF();if(bZ=="moved"&&bY){u[bY]=true;}if(!bZ&&!bW){bW=true;aE.set(80,bX);}else{aU=false;bv();}aI();}aE.set(20,bX);}function bF(){if(bH){return;}var b3=false,cb=bR.value,ce=I(bR);if(!ce){return false;}var b3=S.text!=cb,b6=bu;var b4=b3||ce.start!=S.start||ce.end!=(b6?S.start:S.end);if(!b4&&!b6){return false;}if(b3){var cm=4000;if(bR.value.length>cm){var b5=false;var bZ=bR.value.split("\n");for(var ci=0,cf=bZ.length;ci<cf;ci++){if(bZ[ci].length>cm){if(!cg){var cg=new ECM.CMS.Util.TextWrapper();}var cc=cg.wrap(bZ[ci],cm,"html");bZ[ci]=cc;b5=true;}}if(b5){bR.value=bZ.join("\n");}cb=bR.value;}a1=bu=null;if(a9.readOnly){bg=true;return"changed";}}function b1(cp,cn){var co=0;for(;;){var ch=cb.indexOf("\n",co);if(ch==-1||(cb.charAt(ch-1)=="\r"?ch-1:ch)>=cp){return{line:cn,ch:cp-co};}++cn;co=ch+1;}}var cd=b1(ce.start,S.from),bX=b1(ce.end,S.from);if(b6){cd=ce.start==b6.anchor?bX:cd;bX=a1?aO.to:ce.start==b6.anchor?cd:bX;if(!n(cd,bX)){bu=null;aO.inverted=false;var cl=cd;cd=bX;bX=cl;}}if(cd.line==bX.line&&cd.line==aO.from.line&&cd.line==aO.to.line&&!a1){bg=false;}if(b3){var b2=0,b0=cb.length,cj=Math.min(b0,S.text.length);var ck,b8=S.from,bY=-1;while(b2<cj&&(ck=cb.charAt(b2))==S.text.charAt(b2)){++b2;if(ck=="\n"){b8++;bY=b2;}}var b9=bY>-1?b2-bY:b2,bW=S.to-1,b7=S.text.length;for(;;){ck=S.text.charAt(b7);if(cb.charAt(b0)!=ck){++b0;++b7;break;}if(ck=="\n"){bW--;}if(b7<=b2||b0<=b2){break;}--b0;--b7;}var bY=S.text.lastIndexOf("\n",b7-1),ca=bY==-1?b7:b7-bY-1;bf({line:b8,ch:b9},{line:bW,ch:ca},w(cb.slice(b2,b0)),cd,bX);if(b8!=bW||cd.line!=b8){bg=true;}}else{bt(cd,bX);}S.text=cb;S.start=ce.start;S.end=ce.end;return b3?"changed":b4?"moved":false;}function aA(){var bZ=[];var b1=Math.max(0,aO.from.line-1),b0=Math.min(bL.length,aO.to.line+2);
for(var bY=b1;bY<b0;++bY){bZ.push(bL[bY].text);}bZ=bR.value=bZ.join(j);var bX=aO.from.ch,bW=aO.to.ch;for(var bY=b1;bY<aO.from.line;++bY){bX+=j.length+bL[bY].text.length;}for(var bY=b1;bY<aO.to.line;++bY){bW+=j.length+bL[bY].text.length;}S={text:bZ,from:b1,to:b0,start:bX,end:bW};g(bR,bX,bu?bX:bW);}function am(){if(a9.readOnly!="nocursor"){bR.focus();}}function aS(){var bW=br(aO.inverted?aO.from:aO.to);return bT(bW.x,bW.y,bW.x,bW.yBot);}function bT(bY,b2,bW,b1){var b0=bj(),b8=a3(),b4=bK();b2+=b8;b1+=b8;bY+=b0;bW+=b0;var b5=bm.clientHeight,bZ=bm.scrollTop,bX=false,b7=true;if(b2<bZ){bm.scrollTop=Math.max(0,b2-2*b4);bX=true;}else{if(b1>bZ+b5){bm.scrollTop=b1+b4-b5;bX=true;}}var b3=bm.clientWidth,b6=bm.scrollLeft;if(bY<b6){bm.scrollLeft=Math.max(0,bY-50);bX=true;}else{if(bW>b3+b6){bm.scrollLeft=bW+10-b3;bX=true;if(bW>aC.clientWidth){b7=false;}}}if(bX&&a9.onScroll){a9.onScroll(bI);}return b7;}function bN(){var bW=bK(),bX=bm.scrollTop-a3();return{from:Math.min(bL.length,Math.max(0,Math.floor(bX/bW))),to:Math.min(bL.length,Math.ceil((bX+bm.clientHeight)/bW))};}function ab(cf){if(!bm.clientWidth){bd=bs=0;return;}var ce=cf===true?[]:[{from:bd,to:bs,domStart:0}];for(var cd=0,b9=cf.length||0;cd<b9;++cd){var b3=cf[cd],b1=[],b4=b3.diff||0;for(var cc=0,ca=ce.length;cc<ca;++cc){var b6=ce[cc];if(b3.to<=b6.from){b1.push({from:b6.from+b4,to:b6.to+b4,domStart:b6.domStart});}else{if(b6.to<=b3.from){b1.push(b6);}else{if(b3.from>b6.from){b1.push({from:b6.from,to:b3.from,domStart:b6.domStart});}if(b3.to<b6.to){b1.push({from:b3.to+b4,to:b6.to+b4,domStart:b6.domStart+(b3.to-b6.from)});}}}}ce=b1;}var bY=bN();var cb=Math.min(bd,Math.max(bY.from-3,0)),bW=Math.min(bL.length,Math.max(bs,bY.to+3)),b2=[],b5=0,b0=bs-bd,bZ=cb,b8=0;for(var cd=0,b9=ce.length;cd<b9;++cd){var b6=ce[cd];if(b6.to<=cb){continue;}if(b6.from>=bW){break;}if(b6.domStart>b5||b6.from>bZ){b2.push({from:bZ,to:b6.from,domSize:b6.domStart-b5,domStart:b5});b8+=b6.from-bZ;}bZ=b6.to;b5=b6.domStart+(b6.to-b6.from);}if(b5!=b0||bZ!=bW){b8+=Math.abs(bW-bZ);b2.push({from:bZ,to:bW,domSize:b0-b5,domStart:b5});}if(!b2.length){return;}ae.style.display="none";if(b8>(bY.to-bY.from)*0.3){aW(cb=Math.max(bY.from-10,0),bW=Math.min(bY.to+7,bL.length));}else{V(b2);}ae.style.display="";var b7=cb!=bd||bW!=bs||bz!=bm.clientHeight;bd=cb;bs=bW;bi.style.top=(cb*bK())+"px";if(b7){bz=bm.clientHeight;aC.style.height=(bL.length*bK()+2*a3())+"px";T();}var bX=aP(aG);aF.style.width=bX>bm.clientWidth?bX+"px":"";if(ae.childNodes.length!=bs-bd){throw new Error("BAD PATCH! "+JSON.stringify(b2)+" size="+(bs-bd)+" nodes="+ae.childNodes.length);}bA();}function aW(b3,b2){var bZ=[],b1={line:b3,ch:0},b0=n(aO.from,b1)&&!n(aO.to,b1);for(var bY=b3;bY<b2;++bY){var bX=null,bW=null;if(b0){bX=0;if(aO.to.line==bY){b0=false;bW=aO.to.ch;}}else{if(aO.from.line==bY){if(aO.to.line==bY){bX=aO.from.ch;bW=aO.to.ch;}else{b0=true;bX=aO.from.ch;}}}bZ.push(bL[bY].getHTML(bX,bW,true));}ae.innerHTML=bZ.join("");}function V(b8){var b9=aO.from.line,ca=aO.to.line,bY=0,b6=H&&bE.createElement("div");for(var b4=0,b5=b8.length;b4<b5;++b4){var b1=b8[b4];var b0=(b1.to-b1.from)-b1.domSize;var b7=ae.childNodes[b1.domStart+b1.domSize+bY]||null;if(H){for(var b3=Math.max(-b0,b1.domSize);b3>0;--b3){ae.removeChild(b7?b7.previousSibling:ae.lastChild);}}else{if(b0){for(var b3=Math.max(0,b0);b3>0;--b3){ae.insertBefore(bE.createElement("pre"),b7);}for(var b3=Math.max(0,-b0);b3>0;--b3){ae.removeChild(b7?b7.previousSibling:ae.lastChild);}}}var bZ=ae.childNodes[b1.domStart+bY],b2=b9<b1.from&&ca>=b1.from;for(var b3=b1.from;b3<b1.to;++b3){var bX=null,bW=null;if(b2){bX=0;if(ca==b3){b2=false;bW=aO.to.ch;}}else{if(b9==b3){if(ca==b3){bX=aO.from.ch;bW=aO.to.ch;}else{b2=true;bX=aO.from.ch;}}}if(H){b6.innerHTML=bL[b3].getHTML(bX,bW,true);ae.insertBefore(b6.firstChild,b7);}else{bZ.innerHTML=bL[b3].getHTML(bX,bW,false);bZ.className=bL[b3].className||"";bZ=bZ.nextSibling;}}bY+=b0;}}function T(){if(!a9.gutter&&!a9.lineNumbers){return;}var bZ=bi.offsetHeight,b6=bm.clientHeight;aM.style.height=(bZ-b6<2?b6:bZ)+"px";var b4=[];for(var b2=bd;b2<bs;++b2){var b3=bL[b2].gutterMarker;var b5=a9.lineNumbers?b2+a9.firstLineNumber:null;if(b3&&b3.text){b5=b3.text.replace("%N%",b5!=null?b5:"");}else{if(b5==null){b5="\u00a0";}}b4.push((b3&&b3.style?'<pre class="'+b3.style+'">':"<pre>"),b5,"</pre>");}aM.style.display="none";bP.innerHTML=b4.join("");var b1=String(bL.length).length,bX=bP.firstChild,bY=a(bX),b0="";while(bY.length+b0.length<b1){b0+="\u00a0";}if(b0){bX.insertBefore(bE.createTextNode(b0),bX.firstChild);}aM.style.display="";aF.style.marginLeft=aM.offsetWidth+"px";var bW=bm.parentNode.firstChild;if(bW.nodeName==="DIV"&&bW.firstChild.firstChild.innerHTML.match(/1-------10/)){bW.firstChild.firstChild.style.marginLeft=aM.offsetWidth+"px";}}function bA(){var bX=aO.inverted?aO.from:aO.to;var bW=P(bX.line,bX.ch)+"px",bY=(bX.line-bd)*bK()+"px";bU.style.top=bY;if(o(aO.from,aO.to)){aa.style.top=bY;aa.style.left=bW;aa.style.display="";}else{aa.style.display="none";}}function aN(bY,bX){var bW=a1&&af(a1);if(bW){if(n(bW,bY)){bY=bW;}else{if(n(bX,bW)){bX=bW;}}}bt(bY,bX);}function bt(b2,b1,bX,bZ){if(o(aO.from,b2)&&o(aO.to,b1)){return;}if(n(b1,b2)){var bY=b1;b1=b2;b2=bY;}var bW=o(aO.to,b1),b0=o(aO.from,b2);if(o(b2,b1)){aO.inverted=false;}else{if(bW&&!b0){aO.inverted=true;}else{if(b0&&!bW){aO.inverted=false;}}}if(bX==null){bX=aO.from.line;bZ=aO.to.line;}if(o(b2,b1)){if(!o(aO.from,aO.to)){bJ.push({from:bX,to:bZ+1});}}else{if(o(aO.from,aO.to)){bJ.push({from:b2.line,to:b1.line+1});}else{if(!o(b2,aO.from)){if(b2.line<bX){bJ.push({from:b2.line,to:Math.min(b1.line,bX)+1});}else{bJ.push({from:bX,to:Math.min(bZ,b2.line)+1});}}if(!o(b1,aO.to)){if(b1.line<bZ){bJ.push({from:Math.max(bX,b2.line),to:bZ+1});}else{bJ.push({from:Math.max(b2.line,bZ),to:b1.line+1});}}}}aO.from=b2;aO.to=b1;aj=true;}function aR(bW,bY,bX){var bZ=af({line:bW,ch:bY||0});(bX?aN:bt)(bZ,bZ);}function aV(bW){return Math.max(0,Math.min(bW,bL.length-1));}function af(bY){if(bY.line<0){return{line:0,ch:bY.ch};}if(bY.line>=bL.length){return{line:bL.length-1,ch:bL[bL.length-1].text.length};}var bW=bY.ch,bX=bL[bY.line].text.length;if(bW==null||bW>bX){return{line:bY.line,ch:bX};}else{if(bW<0){return{line:bY.line,ch:0};}else{return bY;}}}function bD(bY){var bW=Math.floor(bm.clientHeight/bK()),bX=aO.inverted?aO.from:aO.to;aR(bX.line+(Math.max(bW-1,1)*(bY?1:-1)),bX.ch,true);}function bO(bW){aR(bW?0:bL.length-1,true);}function bn(){var bW=bL.length-1;bt({line:0,ch:0},{line:bW,ch:bL[bW].text.length});}function be(bZ){var bX=bL[bZ.line].text;var bY=bZ.ch,bW=bZ.ch;while(bY>0&&/\w/.test(bX.charAt(bY-1))){--bY;}while(bW<bX.length&&/\w/.test(bX.charAt(bW))){++bW;}aN({line:bZ.line,ch:bY},{line:bZ.line,ch:bW});}function aJ(bW){aN({line:bW,ch:0},{line:bW,ch:bL[bW].text.length});}function ay(){if(aY.type=="textfield"){return false;}else{ah("\n","end");if(a9.enterMode!="flat"){ar(aO.from.line,a9.enterMode=="keep"?"prev":"smart");}}}function ax(bW){a1=null;switch(a9.tabMode){case"default":return false;case"indent":for(var bX=aO.from.line,bY=aO.to.line;bX<=bY;++bX){ar(bX,"smart");}break;case"classic":if(o(aO.from,aO.to)){if(bW){ar(aO.from.line,"smart");}else{ah("\t","end");}break;}case"shift":for(var bX=aO.from.line,bY=aO.to.line;bX<=bY;++bX){ar(bX,bW?"subtract":"add");}break;}return true;}function ar(bY,b5){if(b5=="smart"){if(!bb.indent){b5="prev";}else{var bW=aD(bY);}}var b6=bL[bY],b0=b6.indentation(),bX=b6.text.match(/^\s*/)[0],b2;if(b5=="prev"){if(bY){b2=bL[bY-1].indentation();}else{b2=0;}}else{if(b5=="smart"){b2=bb.indent(bW,b6.text.slice(bX.length));}else{if(b5=="add"){b2=b0+a9.indentUnit;}else{if(b5=="subtract"){b2=b0-a9.indentUnit;}}}}b2=Math.max(0,b2);var b4=b2-b0;if(!b4){if(aO.from.line!=bY&&aO.to.line!=bY){return;}var b3=bX;}else{var b3="",b1=0;if(a9.indentWithTabs){for(var bZ=Math.floor(b2/v);bZ;--bZ){b1+=v;b3+="\t";}}while(b1<b2){++b1;b3+=" ";}}bl(b3,{line:bY,ch:0},{line:bY,ch:bX.length});}function bk(){bb=z.getMode(a9,a9.mode);for(var bX=0,bW=bL.length;bX<bW;++bX){bL[bX].stateAfter=null;}a2=[0];bQ();
}function N(){var bW=a9.gutter||a9.lineNumbers;aM.style.display=bW?"":"none";if(bW){T();}else{ae.parentNode.style.marginLeft=0;}}function Q(b2,b1,bY){b2=af(b2);b1=af(b1);var bW=[];function b0(b3,b7,b6,b4){var b3=bL[b3],b5=b3.addMark(b7,b6,b4);b5.line=b3;bW.push(b5);}if(b2.line==b1.line){b0(b2.line,b2.ch,b1.ch,bY);}else{b0(b2.line,b2.ch,null,bY);for(var bX=b2.line+1,bZ=b1.line;bX<bZ;++bX){b0(bX,0,null,bY);}b0(b1.line,0,b1.ch,bY);}bJ.push({from:b2.line,to:b1.line+1});return function(){var b7,b3;for(var b4=0;b4<bW.length;++b4){var b6=bW[b4],b5=d(bL,b6.line);b6.line.removeMark(b6);if(b5>-1){if(b7==null){b7=b5;}b3=b5;}}if(b7!=null){bJ.push({from:b7,to:b3+1});}};}function ak(bW,bY,bX){if(typeof bW=="number"){bW=bL[aV(bW)];}bW.gutterMarker={text:bY,style:bX};T();return bW;}function Z(bW){if(typeof bW=="number"){bW=bL[aV(bW)];}bW.gutterMarker=null;T();}function aK(bW,bX){if(typeof bW=="number"){var bY=bW;bW=bL[aV(bW)];}else{var bY=d(bL,bW);if(bY==-1){return null;}}if(bW.className!=bX){bW.className=bX;bJ.push({from:bY,to:bY+1});}return bW;}function W(bX){if(typeof bX=="number"){var bY=bX;bX=bL[bX];if(!bX){return null;}}else{var bY=d(bL,bX);if(bY==-1){return null;}}var bW=bX.gutterMarker;return{line:bY,text:bX.text,markerText:bW&&bW.text,markerClass:bW&&bW.style};}function aP(bW){av.innerHTML="<pre><span>x</span></pre>";av.firstChild.firstChild.firstChild.nodeValue=bW;return av.firstChild.firstChild.offsetWidth||10;}function P(bW,bX){if(bX==0){return 0;}av.innerHTML="<pre><span>"+bL[bW].getHTML(null,null,false,bX)+"</span></pre>";return av.firstChild.firstChild.offsetWidth;}function a7(b8,b2){if(b2<=0){return 0;}var bZ=bL[b8],b5=bZ.text;function b6(b9){av.innerHTML="<pre><span>"+bZ.getHTML(null,null,false,b9)+"</span></pre>";return av.firstChild.firstChild.offsetWidth;}var b3=0,b1=0,b4=b5.length,b0;var bX=Math.min(b4,Math.ceil(b2/aP("x")));for(;;){var bY=b6(bX);if(bY<=b2&&bX<b4){bX=Math.min(b4,Math.ceil(bX*1.2));}else{b0=bY;b4=bX;break;}}if(b2>b0){return b4;}bX=Math.floor(b4*0.8);bY=b6(bX);if(bY<b2){b3=bX;b1=bY;}for(;;){if(b4-b3<=1){return(b0-b2>b2-b1)?b3:b4;}var b7=Math.ceil((b3+b4)/2),bW=b6(b7);if(bW>b2){b4=b7;b0=bW;}else{b3=b7;b1=bW;}}}function br(bZ,bY){var bX=bK(),bW=bZ.line-(bY?bd:0);return{x:P(bZ.line,bZ.ch),y:bW*bX,yBot:(bW+1)*bX};}function bq(bY){var bW=br(bY,true),bX=B(aF);return{x:bX.left+bW.x,y:bX.top+bW.y,yBot:bX.top+bW.yBot};}function bK(){var bW=ae.childNodes.length;if(bW){return(ae.offsetHeight/bW)||1;}av.innerHTML="<pre>x</pre>";return av.firstChild.offsetHeight||1;}function a3(){return aF.offsetTop;}function bj(){return aF.offsetLeft;}function Y(b1,b0){var bZ=B(bm,true),bW=b1.e.clientX,b2=b1.e.clientY;if(!b0&&(bW-bZ.left>bm.clientWidth||b2-bZ.top>bm.clientHeight)){return null;}var bY=B(aF,true);var bX=bd+Math.floor((b2-bY.top)/bK());return af({line:bX,ch:a7(aV(bX),bW-bY.left)});}function al(bX){var b1=Y(bX);if(!b1||window.opera){return;}if(o(aO.from,aO.to)||n(b1,aO.from)||!n(b1,aO.to)){aR(b1.line,b1.ch);}var b0=bR.style.cssText;bR.style.cssText="position: fixed; width: 30px; height: 30px; top: "+(bX.pageY()-1)+"px; left: "+(bX.pageX()-1)+"px; z-index: 1000; background: white; border-width: 0; outline: none; overflow: hidden;";var bZ=bR.value=bB();am();g(bR,0,bR.value.length);bH=true;function bW(){var b2=w(bR.value).join("\n");if(b2!=bZ){bM(ah)(b2,"end");}bR.style.cssText=b0;bH=false;aA();bv();}if(p){bX.stop();var bY=f(window,"mouseup",function(){bY();setTimeout(bW,20);},true);}else{setTimeout(bW,50);}}function M(){clearInterval(ad);var bW=true;aa.style.visibility="";ad=setInterval(function(){aa.style.visibility=(bW=!bW)?"":"hidden";},650);}var bS={"(":")>",")":"(<","[":"]>","]":"[<","{":"}>","}":"{<"};function aq(b2){var bW=aO.inverted?aO.from:aO.to,b4=bL[bW.line],bX=bW.ch-1;var b1=(bX>=0&&bS[b4.text.charAt(bX)])||bS[b4.text.charAt(++bX)];if(!b1){return;}var b5=b1.charAt(0),b3=b1.charAt(1)==">",cf=b3?1:-1,ca=b4.styles;for(var cg=bX+1,cc=0,ce=ca.length;cc<ce;cc+=2){if((cg-=ca[cc].length)<=0){var cd=ca[cc+1];break;}}var bZ=[b4.text.charAt(bX)],b9=/[(){}[\]]/;function b7(cs,cn,co){if(!cs.text){return;}var cr=cs.styles,cm=b3?0:cs.text.length-1,cp;for(var cj=b3?0:cr.length-2,cl=b3?cr.length:-2;cj!=cl;cj+=2*cf){var cq=cr[cj];if(cr[cj+1]!=null&&cr[cj+1]!=cd){cm+=cf*cq.length;continue;}for(var ci=b3?0:cq.length-1,ch=b3?cq.length:-1;ci!=ch;ci+=cf,cm+=cf){if(cm>=cn&&cm<co&&b9.test(cp=cq.charAt(ci))){var ck=bS[cp];if(ck.charAt(1)==">"==b3){bZ.push(cp);}else{if(bZ.pop()!=ck.charAt(0)){return{pos:cm,match:false};}else{if(!bZ.length){return{pos:cm,match:true};}}}}}}}for(var cc=bW.line,ce=b3?Math.min(cc+50,bL.length):Math.max(-1,cc-50);cc!=ce;cc+=cf){var b4=bL[cc],b0=cc==bW.line;var b6=b7(b4,b0&&b3?bX+1:0,b0&&!b3?bX:b4.text.length);if(b6){var cd=b6.match?"CodeMirror-matchingbracket":"CodeMirror-nonmatchingbracket";var cb=Q({line:bW.line,ch:bX},{line:bW.line,ch:bX+1},cd),bY=Q({line:cc,ch:b6.pos},{line:cc,ch:b6.pos+1},cd);var b8=bM(function(){cb();bY();});if(b2){setTimeout(b8,800);}else{by=b8;}break;}}}function aX(b2){var b1,bY;for(var bX=b2,bZ=b2-40;bX>bZ;--bX){if(bX==0){return 0;}var bW=bL[bX-1];if(bW.stateAfter){return bX;}var b0=bW.indentation();if(bY==null||b1>b0){bY=bX;b1=b0;}}return bY;}function aD(b0){var bZ=aX(b0),bY=bZ&&bL[bZ-1].stateAfter;if(!bY){bY=h(bb);}else{bY=y(bb,bY);}for(var bX=bZ;bX<b0;++bX){var bW=bL[bX];bW.highlight(bb,bY);bW.stateAfter=y(bb,bY);}if(!bL[b0].stateAfter){a2.push(b0);}return bY;}function a0(){var b1=+new Date+a9.workTime;var bW=false;while(a2.length){if(!bL[bd].stateAfter){var bZ=bd;}else{var bZ=a2.pop();}if(bZ>=bL.length){continue;}bW=true;var bY=aX(bZ),bX=bY&&bL[bY-1].stateAfter;if(bX){bX=y(bb,bX);}else{bX=h(bb);}for(var b4=bY,b0=bL.length;b4<b0;++b4){var b5=bL[b4],b2=b5.stateAfter;if(+new Date>b1){a2.push(b4);bQ(a9.workDelay);bJ.push({from:bZ,to:b4});return;}var b3=b5.highlight(bb,bX);b5.stateAfter=y(bb,bX);if(b2&&!b3&&b5.text){break;}}bJ.push({from:bZ,to:b4});}if(bW&&a9.onHighlightComplete){a9.onHighlightComplete(bI);}}function bQ(bW){if(!a2.length){return;}ao.set(bW,bM(a0));}function U(){bg=null;bJ=[];aH=aj=false;}function aI(){var bX=false;if(aj){bX=!aS();}if(bJ.length){ab(bJ);}else{if(aj){bA();}}if(bX){aS();}if(aj){M();}if(!bH&&(bg===true||(bg!==false&&aj))){aA();}if(aj&&a9.matchBrackets){setTimeout(bM(function(){if(by){by();by=null;}aq(false);}),20);}var bW=aH;if(aj&&a9.onCursorActivity){a9.onCursorActivity(bI);}if(bW&&a9.onChange&&bI){a9.onChange(bI,bW);}}var au=0;function bM(bW){return function(){if(!au++){U();}try{var bX=bW.apply(this,arguments);}finally{if(!--au){aI();}}return bX;};}function aw(bY,b0,bX){this.atOccurrence=false;if(bX==null){bX=typeof bY=="string"&&bY==bY.toLowerCase();}if(b0&&typeof b0=="object"){b0=af(b0);}else{b0={line:0,ch:0};}this.pos={from:b0,to:b0};if(typeof bY!="string"){this.matches=function(b3,b7){if(b3){var b1=bL[b7.line].text.slice(0,b7.ch),b2=b1.match(bY),b6=0;while(b2){var b4=b1.indexOf(b2[0]);b6+=b4;b1=b1.slice(b4+1);var b5=b1.match(bY);if(b5){b2=b5;}else{break;}}}else{var b1=bL[b7.line].text.slice(b7.ch),b2=b1.match(bY),b6=b2&&b7.ch+b1.indexOf(b2[0]);}if(b2){return{from:{line:b7.line,ch:b6},to:{line:b7.line,ch:b6+b2[0].length},match:b2};}};}else{if(bX){bY=bY.toLowerCase();}var bW=bX?function(b1){return b1.toLowerCase();}:function(b1){return b1;};var bZ=bY.split("\n");if(bZ.length==1){this.matches=function(b4,b5){var b2=bW(bL[b5.line].text),b1=bY.length,b3;if(b4?(b5.ch>=b1&&(b3=b2.lastIndexOf(bY,b5.ch-b1))!=-1):(b3=b2.indexOf(bY,b5.ch))!=-1){return{from:{line:b5.line,ch:b3},to:{line:b5.line,ch:b3+b1}};}};}else{this.matches=function(b6,b8){var b7=b8.line,b9=(b6?bZ.length-1:0),b4=bZ[b9],ca=bW(bL[b7].text);var b5=(b6?ca.indexOf(b4)+b4.length:ca.lastIndexOf(b4));if(b6?b5>=b8.ch||b5!=b4.length:b5<=b8.ch||b5!=ca.length-b4.length){return;}for(;;){if(b6?!b7:b7==bL.length-1){return;}ca=bW(bL[b7+=b6?-1:1].text);b4=bZ[b6?--b9:++b9];if(b9>0&&b9<bZ.length-1){if(ca!=b4){return;}else{continue;}}var b3=(b6?ca.lastIndexOf(b4):ca.indexOf(b4)+b4.length);if(b6?b3!=ca.length-b4.length:b3!=b4.length){return;
}var b1={line:b8.line,ch:b5},b2={line:b7,ch:b3};return{from:b6?b2:b1,to:b6?b1:b2};}};}}}aw.prototype={findNext:function(){return this.find(false);},findPrevious:function(){return this.find(true);},find:function(bX){var bW=this,bZ=af(bX?this.pos.from:this.pos.to);function bY(b0){var b1={line:b0,ch:0};bW.pos={from:b1,to:b1};bW.atOccurrence=false;return false;}for(;;){if(this.pos=this.matches(bX,bZ)){this.atOccurrence=true;return this.pos.match||true;}if(bX){if(!bZ.line){return bY(0);}bZ={line:bZ.line-1,ch:bL[bZ.line-1].text.length};}else{if(bZ.line==bL.length-1){return bY(bL.length);}bZ={line:bZ.line+1,ch:0};}}},from:function(){if(this.atOccurrence){return r(this.pos.from);}},to:function(){if(this.atOccurrence){return r(this.pos.to);}}};return bI;}z.defaults={value:"",mode:null,indentUnit:2,indentWithTabs:false,tabMode:"classic",enterMode:"indent",electricChars:true,onKeyEvent:null,lineNumbers:false,gutter:false,firstLineNumber:1,readOnly:false,onChange:null,onCursorActivity:null,onGutterClick:null,onHighlightComplete:null,onFocus:null,onBlur:null,onScroll:null,matchBrackets:false,workTime:100,workDelay:200,undoDepth:40,tabindex:null,document:window.document,disable:{personalization:false,dynamicContent:false}};var b={},s={};z.defineMode=function(K,L){if(!z.defaults.mode&&K!="null"){z.defaults.mode=K;}b[K]=L;};z.defineMIME=function(L,K){s[L]=K;};z.getMode=function(M,K){if(typeof K=="string"&&s.hasOwnProperty(K)){K=s[K];}if(typeof K=="string"){var O=K,L={};}else{if(K!=null){var O=K.name,L=K;}}var N=b[O];if(!N){if(window.console){console.warn("No mode "+O+" found, falling back to plain text.");}return z.getMode(M,"text/plain");}return N(M,L||{});};z.listModes=function(){var L=[];for(var K in b){if(b.propertyIsEnumerable(K)){L.push(K);}}return L;};z.listMIMEs=function(){var L=[];for(var K in s){if(s.propertyIsEnumerable(K)){L.push(K);}}return L;};z.fromTextArea=function(L,N){if(!N){N={};}N.value=L.value;if(!N.tabindex&&L.tabindex){N.tabindex=L.tabindex;}function P(){L.value=K.getValue();}if(L.form){var O=f(L.form,"submit",P,true);if(typeof L.form.submit=="function"){var M=L.form.submit;function Q(){P();L.form.submit=M;L.form.submit();L.form.submit=Q;}L.form.submit=Q;}}L.style.display="none";var K=z(function(R){L.parentNode.insertBefore(R,L.nextSibling);},N);K.save=P;K.toTextArea=function(){P();L.parentNode.removeChild(K.getWrapperElement());L.style.display="";if(L.form){O();if(typeof L.form.submit=="function"){L.form.submit=M;}}};return K;};function y(N,K){if(K===true){return K;}if(N.copyState){return N.copyState(K);}var M={};for(var O in K){var L=K[O];if(L instanceof Array){L=L.concat([]);}M[O]=L;}return M;}z.startState=h;function h(M,L,K){return M.startState?M.startState(L,K):true;}z.copyState=y;function x(K){this.pos=this.start=0;this.string=K;}x.prototype={eol:function(){return this.pos>=this.string.length;},sol:function(){return this.pos==0;},peek:function(){return this.string.charAt(this.pos);},next:function(){if(this.pos<this.string.length){return this.string.charAt(this.pos++);}},eat:function(K){var M=this.string.charAt(this.pos);if(typeof K=="string"){var L=M==K;}else{var L=M&&(K.test?K.test(M):K(M));}if(L){++this.pos;return M;}},eatWhile:function(K){var L=this.start;while(this.eat(K)){}return this.pos>L;},eatSpace:function(){var K=this.pos;while(/[\s\u00a0]/.test(this.string.charAt(this.pos))){++this.pos;}return this.pos>K;},skipToEnd:function(){this.pos=this.string.length;},skipTo:function(K){var L=this.string.indexOf(K,this.pos);if(L>-1){this.pos=L;return true;}},backUp:function(K){this.pos-=K;},column:function(){return E(this.string,this.start);},indentation:function(){return E(this.string);},match:function(N,L,K){if(typeof N=="string"){function O(P){return K?P.toLowerCase():P;}if(O(this.string).indexOf(O(N),this.pos)==this.pos){if(L!==false){this.pos+=N.length;}return true;}}else{var M=this.string.slice(this.pos).match(N);if(M&&L!==false){this.pos+=M[0].length;}return M;}},current:function(){return this.string.slice(this.start,this.pos);}};function A(L,K){this.styles=K||[L,null];this.stateAfter=null;this.text=L;this.marked=this.gutterMarker=this.className=null;}A.prototype={replace:function(P,Q,T){var U=[],N=this.marked;G(0,P,this.styles,U);if(T){U.push(T,null);}G(Q,this.text.length,this.styles,U);this.styles=U;this.text=this.text.slice(0,P)+T+this.text.slice(Q);this.stateAfter=null;if(N){var R=T.length-(Q-P),L=this.text.length;function O(V){return V<=Math.min(Q,Q+R)?V:V+R;}for(var M=0;M<N.length;++M){var K=N[M],S=false;if(K.from>=L){S=true;}else{K.from=O(K.from);if(K.to!=null){K.to=O(K.to);}}if(S||K.from>=K.to){N.splice(M,1);M--;}}}},split:function(M,L){var K=[L,null];G(M,this.text.length,this.styles,K);return new A(L+this.text.slice(M),K);},addMark:function(O,N,L){var K=this.marked,M={from:O,to:N,style:L};if(this.marked==null){this.marked=[];}this.marked.push(M);this.marked.sort(function(Q,P){return Q.from-P.from;});return M;},removeMark:function(M){var K=this.marked;if(!K){return;}for(var L=0;L<K.length;++L){if(K[L]==M){K.splice(L,1);break;}}},highlight:function(P,L){var R=new x(this.text),T=this.styles,Q=0;var O=false,M=T[0],S;if(this.text==""&&P.blankLine){P.blankLine(L);}while(!R.eol()){var K=P.token(R,L);var N=this.text.slice(R.start,R.pos);R.start=R.pos;if(Q&&T[Q-1]==K){T[Q-2]+=N;}else{if(N){if(!O&&(T[Q+1]!=K||(Q&&T[Q-2]!=S))){O=true;}T[Q++]=N;T[Q++]=K;S=M;M=T[Q];}}if(R.pos>5000){T[Q++]=this.text.slice(R.pos);T[Q++]=null;break;}}if(T.length!=Q){T.length=Q;O=true;}if(Q&&T[Q-2]!=S){O=true;}return O;},getTokenAt:function(P,N,M){var K=this.text,O=new x(K);while(O.pos<M&&!O.eol()){O.start=O.pos;var L=P.token(O,N);}return{start:O.start,end:O.pos,string:O.current(),className:L||null,state:N};},indentation:function(){return E(this.text);},getHTML:function(W,aa,N,Y){var Q=[];if(N){Q.push(this.className?'<pre class="'+this.className+'">':"<pre>");}function ab(ak,aj){if(!ak){return;}if(aj){Q.push('<span class="',aj,'">',q(ak),"</span>");}else{Q.push(q(ak));}}var V=this.styles,O=this.text,U=this.marked;if(W==aa){W=null;}var ad=O.length;if(Y!=null){ad=Math.min(Y,ad);}if(!O&&Y==null){ab(" ",W!=null&&aa==null?"CodeMirror-selected":null);}else{if(!U&&W==null){for(var ac=0,R=0;R<ad;ac+=2){var X=V[ac],Z=X.length;if(R+Z>ad){X=X.slice(0,ad-R);}R+=Z;ab(X,V[ac+1]);}}else{var M=0,ac=0,T="",ae,ah=0;var af=-1,P=null;function ag(){if(U){af+=1;P=(af<U.length)?U[af]:null;}}ag();while(M<ad){var S=ad;var ai="";if(W!=null){if(W>M){S=W;}else{if(aa==null||aa>M){ai=" CodeMirror-selected";if(aa!=null){S=Math.min(S,aa);}}}}while(P&&P.to!=null&&P.to<=M){ag();}if(P){if(P.from>M){S=Math.min(S,P.from);}else{ai+=" "+P.style;if(P.to!=null){S=Math.min(S,P.to);}}}for(;;){var L=M+T.length;var K=ae;if(ai){K=ae?ae+ai:ai;}ab(L>S?T.slice(0,S-M):T,K);if(L>=S){T=T.slice(S-M);M=S;break;}M=L;T=V[ac++];ae=V[ac++];}}if(W!=null&&aa==null){ab(" ","CodeMirror-selected");}}}if(N){Q.push("</pre>");}return Q.join("");}};function G(Q,R,K,S){for(var O=0,P=0,L=0;P<R;O+=2){var M=K[O],N=P+M.length;if(L==0){if(N>Q){S.push(M.slice(Q-P,Math.min(M.length,R-P)),K[O+1]);}if(N>=Q){L=1;}}else{if(L==1){if(N>R){S.push(M.slice(0,R-P),K[O+1]);}else{S.push(M,K[O+1]);}}}P=N;}}function c(){this.time=0;this.done=[];this.undone=[];}c.prototype={addChange:function(R,M,K){this.undone.length=0;var Q=+new Date,O=this.done[this.done.length-1];if(Q-this.time>400||!O||O.start>R+M||O.start+O.added<R-O.added+O.old.length){this.done.push({start:R,added:M,old:K});}else{var N=0;if(R<O.start){for(var L=O.start-R-1;L>=0;--L){O.old.unshift(K[L]);}O.added+=O.start-R;O.start=R;}else{if(O.start<R){N=R-O.start;M+=N;}}for(var L=O.added-N,P=K.length;L<P;++L){O.old.push(K[L]);}if(O.added<M){O.added=M;}}this.time=Q;}};function F(){if(this.preventDefault){this.preventDefault();this.stopPropagation();}else{this.returnValue=false;this.cancelBubble=true;}}function t(K){if(!K.stop){K.stop=F;}return K;}function J(K){this.e=K;}J.prototype={stop:function(){F.call(this.e);},target:function(){return this.e.target||this.e.srcElement;},button:function(){if(this.e.which){return this.e.which;
}else{if(this.e.button&1){return 1;}else{if(this.e.button&2){return 3;}else{if(this.e.button&4){return 2;}}}}},pageX:function(){if(this.e.pageX!=null){return this.e.pageX;}var K=this.target().ownerDocument;return this.e.clientX+K.body.scrollLeft+K.documentElement.scrollLeft;},pageY:function(){if(this.e.pageY!=null){return this.e.pageY;}var K=this.target().ownerDocument;return this.e.clientY+K.body.scrollTop+K.documentElement.scrollTop;}};function f(N,M,L,K){function O(P){L(new J(P||window.event));}if(typeof N.addEventListener=="function"){N.addEventListener(M,O,false);if(K){return function(){N.removeEventListener(M,O,false);};}}else{N.attachEvent("on"+M,O);if(K){return function(){N.detachEvent("on"+M,O);};}}}function m(){this.id=null;}m.prototype={set:function(K,L){clearTimeout(this.id);this.id=setTimeout(L,K);}};var H=(function(){var K=document.createElement("pre");K.innerHTML=" ";return !K.innerHTML;})();var p=/gecko\/\d{7}/i.test(navigator.userAgent);var j="\n";(function(){var K=document.createElement("textarea");K.value="foo\nbar";if(K.value.indexOf("\r")>-1){j="\r\n";}}());var v=8;var k=/Mac/.test(navigator.platform);var u={};for(var D=35;D<=40;++D){u[D]=u["c"+D]=true;}function E(L,K){if(K==null){K=L.search(/[^\s\u00a0]/);if(K==-1){K=L.length;}}for(var M=0,N=0;M<K;++M){if(L.charAt(M)=="\t"){N+=v-(N%v);}else{++N;}}return N;}function B(M,L){var P=M.ownerDocument.body;var K=0,R=0,O=false;for(var Q=M;Q;Q=Q.offsetParent){K+=Q.offsetLeft;R+=Q.offsetTop;if(Q==P){O=true;}}var N=L&&O?null:P;for(var Q=M.parentNode;Q!=N;Q=Q.parentNode){if(Q.scrollLeft!=null){K-=Q.scrollLeft;R-=Q.scrollTop;}}return{left:K,top:R};}function a(K){return K.textContent||K.innerText||K.nodeValue||"";}function o(L,K){return L.line==K.line&&L.ch==K.ch;}function n(L,K){return L.line<K.line||(L.line==K.line&&L.ch<K.ch);}function r(K){return{line:K.line,ch:K.ch};}function q(K){return K.replace(/[<>&]/g,function(L){return L=="&"?"&amp;":L=="<"?"&lt;":"&gt;";});}function l(N,M){if(!M){return N?N.length:0;}if(!N){return M.length;}for(var L=N.length,K=M.length;L>=0&&K>=0;--L,--K){if(N.charAt(L)!=M.charAt(K)){break;}}return K+1;}function d(N,K){if(N.indexOf){return N.indexOf(K);}for(var L=0,M=N.length;L<M;++L){if(N[L]==K){return L;}}return -1;}if("\n\nb".split(/\n/).length!=3){var w=function(M){var N=0,L,K=[];while((L=M.indexOf("\n",N))>-1){K.push(M.slice(N,M.charAt(L-1)=="\r"?L-1:L));N=L+1;}K.push(M.slice(N));return K;};}else{var w=function(K){return K.split(/\r?\n/);};}if(window.getSelection){var I=function(L){try{return{start:L.selectionStart,end:L.selectionEnd};}catch(K){return null;}};var g=function(M,N,K){try{M.setSelectionRange(N,K);}catch(L){}};}else{var I=function(M){try{var Q=M.ownerDocument.selection.createRange();}catch(S){return null;}if(!Q||Q.parentElement()!=M){return null;}var L=M.value,R=L.length,T=M.createTextRange();T.moveToBookmark(Q.getBookmark());var O=M.createTextRange();O.collapse(false);if(T.compareEndPoints("StartToEnd",O)>-1){return{start:R,end:R};}var K=-T.moveStart("character",-R);for(var P=L.indexOf("\r");P>-1&&P<K;P=L.indexOf("\r",P+1),K++){}if(T.compareEndPoints("EndToEnd",O)>-1){return{start:K,end:R};}var N=-T.moveEnd("character",-R);for(var P=L.indexOf("\r");P>-1&&P<N;P=L.indexOf("\r",P+1),N++){}return{start:K,end:N};};var g=function(P,R,M){var N=P.createTextRange();N.collapse(true);var L=N.duplicate();var O=0,K=P.value;for(var Q=K.indexOf("\n");Q>-1&&Q<R;Q=K.indexOf("\n",Q+1)){++O;}N.move("character",R-O);for(;Q>-1&&Q<M;Q=K.indexOf("\n",Q+1)){++O;}L.move("character",M-O);N.setEndPoint("EndToEnd",L);N.select();};}z.defineMode("null",function(){return{token:function(K){K.skipToEnd();}};});z.defineMIME("text/plain","null");return z;})();ECM.provide("ECM.CodeMirror2.xml");CodeMirror.defineMode("xml",function(x,m){var r=x.indentUnit;var w=m.htmlMode?{autoSelfClosers:{br:true,img:true,hr:true,link:true,input:true,meta:true,col:true,frame:true,base:true,area:true},doNotIndent:{pre:true,"!cdata":true},allowUnquoted:true}:{autoSelfClosers:{},doNotIndent:{"!cdata":true},allowUnquoted:false};var a=m.alignCDATA;var g,h;function q(B,A){function y(E){A.tokenize=E;return E(B,A);}var z=B.next();if(z=="<"){if(B.eat("!")){if(B.eat("[")){if(B.match("CDATA[")){return y(v("xml-cdata","]]>"));}else{return null;}}else{if(B.match("--")){return y(v("xml-comment","-->"));}else{if(B.match("DOCTYPE")){B.eatWhile(/[\w\._\-]/);return y(v("xml-doctype",">"));}else{return null;}}}}else{if(B.eat("?")){B.eatWhile(/[\w\._\-]/);A.tokenize=v("xml-processing","?>");return"xml-processing";}else{h=B.eat("/")?"closeTag":"openTag";B.eatSpace();g="";var D;while((D=B.eat(/[^\s\u00a0=<>\"\'\/?]/))){g+=D;}A.tokenize=p;return"xml-tag";}}}else{if(z=="&"){B.eatWhile(/[^;]/);B.eat(";");return"xml-entity";}else{B.eatWhile(/[^&<]/);return null;}}}function p(A,z){var y=A.next();if(y==">"||(y=="/"&&A.eat(">"))){z.tokenize=q;h=y==">"?"endTag":"selfcloseTag";return"xml-tag";}else{if(y=="="){h="equals";return null;}else{if(/[\'\"]/.test(y)){z.tokenize=l(y);return z.tokenize(A,z);}else{A.eatWhile(/[^\s\u00a0=<>\"\'\/?]/);return"xml-word";}}}}function l(y){return function(A,z){while(!A.eol()){if(A.next()==y){z.tokenize=p;break;}}return"xml-attribute";};}function v(z,y){return function(B,A){while(!B.eol()){if(B.match(y)){A.tokenize=q;break;}B.next();}return z;};}var n,j;function b(){for(var y=arguments.length-1;y>=0;y--){n.cc.push(arguments[y]);}}function f(){b.apply(null,arguments);return true;}function k(y,A){var z=w.doNotIndent.hasOwnProperty(y)||(n.context&&n.context.noIndent);n.context={prev:n.context,tagName:y,indent:n.indented,startOfLine:A,noIndent:z};}function t(){if(n.context){n.context=n.context.prev;}}function d(y){if(y=="openTag"){n.tagName=g;return f(o,c(n.startOfLine));}else{if(y=="closeTag"){var z=false;if(n.context){z=n.context.tagName!=g;t();}else{z=true;}if(z){j="error";}return f(s(z));}else{if(y=="xml-cdata"){if(!n.context||n.context.name!="!cdata"){k("!cdata");}if(n.tokenize==q){t();}return f();}else{return f();}}}}function c(y){return function(z){if(z=="selfcloseTag"||(z=="endTag"&&w.autoSelfClosers.hasOwnProperty(n.tagName.toLowerCase()))){return f();}if(z=="endTag"){k(n.tagName,y);return f();}return f();};}function s(y){return function(z){if(y){j="error";}if(z=="endTag"){return f();}return b();};}function o(y){if(y=="xml-word"){j="xml-attname";return f(o);}if(y=="equals"){return f(u,o);}return b();}function u(y){if(y=="xml-word"&&w.allowUnquoted){j="xml-attribute";return f();}if(y=="xml-attribute"){return f();}return b();}return{startState:function(){return{tokenize:q,cc:[],indented:0,startOfLine:true,tagName:null,context:null};},token:function(B,A){if(B.sol()){A.startOfLine=true;A.indented=B.indentation();}if(B.eatSpace()){return null;}j=h=g=null;var z=A.tokenize(B,A);if((z||h)&&z!="xml-comment"){n=A;while(true){var y=A.cc.pop()||d;if(y(h||z)){break;}}}A.startOfLine=false;return j||z;},indent:function(A,y){var z=A.context;if(z&&z.noIndent){return 0;}if(a&&/<!\[CDATA\[/.test(y)){return 0;}if(z&&/^<\//.test(y)){z=z.prev;}while(z&&!z.startOfLine){z=z.prev;}if(z){return z.indent+r;}else{return 0;}},compareStates:function(B,z){if(B.indented!=z.indented||B.tagName!=z.tagName){return false;}for(var A=B.context,y=z.context;;A=A.prev,y=y.prev){if(!A||!y){return A==y;}if(A.tagName!=y.tagName){return false;}}},electricChars:"/"};});CodeMirror.defineMIME("application/xml","xml");CodeMirror.defineMIME("text/html",{name:"xml",htmlMode:true});ECM.provide("ECM.CodeMirror2.dcP13n");CodeMirror.defineMode("dcP13n",function(D,j){var E="(?:bv\\([^)]*\\)|dateformat\\(today,[^)]*\\)+)";var h=new RegExp("^"+E+"%%","i");var l="";if(j.dcP13n.p13n){l="(?:"+(j.dcP13n.p13n).join("|")+")";}var n=new RegExp(".*"+l+".*%%","i");var a=new RegExp("^"+l+"%%","i");var B=new RegExp('^([\\s\\w",]+\\()+[\\s"]*'+l+'([\\s\\w",\\.\\:\\/]*\\))+%%',"i");var G="";if(j.dcP13n.dc){G="(?:"+k(j.dcP13n.dc).join("|")+")";}var z=new RegExp((j.mtype===2)?"^"+G+"\\[[^[\\]]+?\\]%%":"^"+G+"%%","i");var m=j.dcP13n.processXML;var p=(l!==""||G!=="")?true:false;
function k(I){var J=new Array();if(Ext.isArray(I)){Ext.each(I,function(K){if(K.tag){J.push(K.tag);}});}else{if(Ext.isObject(I)){Ext.iterate(I,function(K,L){J.push(K.toLowerCase());});}}return J;}var f="p13n-good";var c="p13n-good ";var H="p13n-bad";var F="p13n-bad ";var q="dc-good";var o="dc-good ";var g="dc-bad";var d="dc-bad ";var A=f;var w=q;var r=H;var b=g;function y(){w=(w===o)?q:o;return w;}function x(){b=(b===d)?g:d;return b;}function v(){A=(A===c)?f:c;return A;}function t(){r=(r===F)?H:F;return r;}function s(K,J){var I="dc";if(!K.match("d_",false,true)){I="p13n";if(j.mtype!==2){if(K.match(h,true,true)){return v();}if(K.match(a,true,true)){return v();}else{if(K.match(B,true,true)){return v();}}}}else{if(K.match(z,true,true)){return y();}}K.eatWhile(/[^\n%]/);if(K.match("%%",true,true)){if(I==="dc"){return x();}else{return t();}}return null;}var u={token:function(J,I){if(J.match("%%")){return s(J,I);}while(J.next()!=null&&!J.match("%%",false)){}return null;}};if(m){return CodeMirror.overlayParser(CodeMirror.getMode(D,"text/html"),u);}else{return CodeMirror.overlayParser(CodeMirror.getMode(D,"text/ecmtext"),u);}});CodeMirror.defineMIME("application/dcP13n","dcP13n");CodeMirror.defineMIME("text/dcP13n",{name:"dcP13n"});ECM.provide("ECM.CodeMirror2.ecmtext");CodeMirror.defineMode("ecmtext",function(u,l){var f,g,r;function p(y,x){function v(A){x.tokenize=A;return A(y,x);}var w=y.next();if(w=="<"){g=y.eat("/")?"closeTag":"openTag";y.eatSpace();f="";var z;while((z=y.eat(/[^\s\u00a0=<>\"\'\/?]/))){f+=z;}x.tokenize=o;return"ecmtext-tag";}else{y.eatWhile(/[^<]/);return null;}}function o(x,w){var v=x.next();if(v==">"||(v=="/"&&x.eat(">"))){w.tokenize=p;g=v==">"?"endTag":"selfcloseTag";return"ecmtext-tag";}else{if(/[\'\"]/.test(v)){w.tokenize=k(v);return w.tokenize(x,w);}else{if(v==="="){return"ecmtext-word";}r=v;var y;while((y=x.eat(/[^\s\u00a0=<>\"\'\/?]/))){r+=y;}return"ecmtext-word";}}}function k(v){return function(x,w){while(!x.eol()){if(x.next()==v){w.tokenize=o;break;}}return"ecmtext-attribute";};}var m,h;function a(){for(var v=arguments.length-1;v>=0;v--){m.cc.push(arguments[v]);}}function d(){a.apply(null,arguments);return true;}function j(v,w){m.context={prev:m.context,tagName:v,indent:m.indented,startOfLine:w};}function s(){if(m.context){m.context=m.context.prev;}}function b(v){if(v=="openTag"){m.tagName=f;return d(n,c(m.startOfLine));}else{if(v=="closeTag"){var w=false;if(m.context){w=m.context.tagName!=f;s();}else{w=true;}if(w){h="ecmtext-error";}return d(q(w));}else{return d();}}}function c(v){return function(w){if(w=="selfcloseTag"||(w=="endTag")){return d();}if(w=="endTag"){j(m.tagName,v);return d();}return d();};}function q(v){return function(w){if(v){h="cmtext-error";}if(w=="endTag"){return d();}return a();};}function n(v){if(v=="ecmtext-word"){h="ecmtext-attname";return d(n);}return a();}function t(v){if(v=="ecmtext-word"){h="ecmtext-attribute";return d();}if(v=="ecmtext-attribute"){return d();}return a();}return{startState:function(){return{tokenize:p,cc:[],indented:0,startOfLine:true,tagName:null,context:null,attrName:null};},token:function(y,x){if(y.sol()){x.startOfLine=true;x.indented=y.indentation();}if(y.eatSpace()){return null;}h=g=f=null;var w=x.tokenize(y,x);if(w||g){m=x;while(true){var v=x.cc.pop()||b;if(v(g||w)){break;}}}if(w=="ecmtext-attribute"){x.attrName=r;r=null;}x.startOfLine=false;return h||w;},indent:function(){return 0;},compareStates:function(y,w){if(y.indented!=w.indented||y.tagName!=w.tagName){return false;}for(var x=y.context,v=w.context;;x=x.prev,v=v.prev){if(!x||!v){return x==v;}if(x.tagName!=v.tagName){return false;}}},electricChars:"/"};});CodeMirror.defineMIME("application/ecmtext","ecmtext");CodeMirror.defineMIME("text/ecmtext","ecmtext");ECM.provide("ECM.CodeMirror2.overlay");CodeMirror.overlayParser=function(b,a,c){return{startState:function(){return{base:CodeMirror.startState(b),overlay:CodeMirror.startState(a),basePos:0,baseCur:null,overlayPos:0,overlayCur:null};},copyState:function(d){return{base:CodeMirror.copyState(b,d.base),overlay:CodeMirror.copyState(a,d.overlay),basePos:d.basePos,baseCur:null,overlayPos:d.overlayPos,overlayCur:null};},token:function(f,d){if(f.start==d.basePos){d.baseCur=b.token(f,d.base);d.baseStart=f.start;d.baseEnd=f.pos;d.basePos=f.pos;}if(f.start==d.overlayPos){f.pos=f.start;d.overlayCur=a.token(f,d.overlay);d.overlayPos=f.pos;}f.pos=Math.min(d.basePos,d.overlayPos);if(f.eol()){d.basePos=d.overlayPos=0;}if(d.overlayCur==null){return d.baseCur;}if(d.baseCur!=null&&c){return d.baseCur+" "+d.overlayCur;}else{return d.overlayCur;}},indent:function(f,d){if(typeof(f.base)==="object"){return b.indent(f.base,d);}},electricChars:b.electricChars};};Ext.ns("Ext.ux.data");Ext.ux.data.PagingStore=Ext.extend(Ext.data.Store,{add:function(b){b=[].concat(b);if(b.length<1){return;}for(var d=0,a=b.length;d<a;d++){b[d].join(this);}var c=this.data.length;this.data.addAll(b);if(this.allData){this.allData.addAll(b);}if(this.snapshot){this.snapshot.addAll(b);}this.totalLength+=b.length;this.fireEvent("add",this,b,c);},remove:function(a){if(Ext.isArray(a)){Ext.each(a,function(c){this.remove(c);},this);return;}if(this!=a.store){return;}a.join(null);var b=this.data.indexOf(a);if(b>-1){this.data.removeAt(b);}if(this.pruneModifiedRecords){this.modified.remove(a);}if(this.allData){this.allData.remove(a);}if(this.snapshot){this.snapshot.remove(a);}this.totalLength--;if(b>-1){this.fireEvent("remove",this,a,b);}},removeAll:function(b){var a=[].concat((this.snapshot||this.allData||this.data).items);this.clearData();if(this.pruneModifiedRecords){this.modified=[];}this.totalLength=0;if(b!==true){this.fireEvent("clear",this,a);}},insert:function(c,b){b=[].concat(b);for(var d=0,a=b.length;d<a;d++){this.data.insert(c,b[d]);b[d].join(this);}if(this.allData){this.allData.addAll(b);}if(this.snapshot){this.snapshot.addAll(b);}this.totalLength+=b.length;this.fireEvent("add",this,b,c);},getById:function(a){return(this.snapshot||this.allData||this.data).key(a);},clearData:function(){if(this.allData){this.data=this.allData;delete this.allData;}if(this.snapshot){this.data=this.snapshot;delete this.snapshot;}this.data.each(function(a){a.join(null);});this.data.clear();},execute:function(f,a,c,b){if(!Ext.data.Api.isAction(f)){throw new Ext.data.Api.Error("execute",f);}c=Ext.applyIf(c||{},{params:{}});if(b!==undefined){this.addToBatch(b);}var d=true;if(f==="read"){d=this.fireEvent("beforeload",this,c);Ext.applyIf(c.params,this.baseParams);}else{if(this.writer.listful===true&&this.restful!==true){a=(Ext.isArray(a))?a:[a];}else{if(Ext.isArray(a)&&a.length==1){a=a.shift();}}if((d=this.fireEvent("beforewrite",this,f,a,c))!==false){this.writer.apply(c.params,this.baseParams,f,a);}}if(d!==false){if(this.writer&&this.proxy.url&&!this.proxy.restful&&!Ext.data.Api.hasUniqueUrl(this.proxy,f)){c.params.xaction=f;}if(f==="read"&&this.isPaging(Ext.apply({},c.params))){(function(){if(this.allData){this.data=this.allData;delete this.allData;}this.applyPaging();this.fireEvent("datachanged",this);var g=[].concat(this.data.items);this.fireEvent("load",this,g,c);if(c.callback){c.callback.call(c.scope||this,g,c,true);}}).defer(1,this);return true;}this.proxy.request(Ext.data.Api.actions[f],a,c.params,this.reader,this.createCallback(f,a,b),this,c);}return d;},loadRecords:function(h,b,g){if(this.isDestroyed===true){return;}if(!h||g===false){if(g!==false){this.fireEvent("load",this,[],b);}if(b.callback){b.callback.call(b.scope||this,[],b,false,h);}return;}var f=h.records,d=h.totalRecords||f.length;if(!b||b.add!==true){if(this.pruneModifiedRecords){this.modified=[];}for(var c=0,a=f.length;c<a;c++){f[c].join(this);}this.clearData();this.data.addAll(f);this.totalLength=d;this.applySort();if(!this.allData){this.applyPaging();}if(f.length>this.getCount()){f=[].concat(this.data.items);}this.fireEvent("datachanged",this);}else{this.totalLength=Math.max(d,this.data.length+f.length);this.add(f);}this.fireEvent("load",this,f,b);if(b.callback){b.callback.call(b.scope||this,f,b,true);
}},loadData:function(c,a){this.isPaging(Ext.apply({},this.lastOptions?this.lastOptions.params:null,this.baseParams));var b=this.reader.readRecords(c);this.loadRecords(b,{add:a},true);},getTotalCount:function(){if(this.allData){return this.allData.getCount();}return this.totalLength||0;},sortData:function(){var a=this.hasMultiSort?this.multiSortInfo:this.sortInfo,k=a.direction||"ASC",h=a.sorters,c=[];if(!this.hasMultiSort){h=[{direction:k,field:a.field}];}for(var d=0,b=h.length;d<b;d++){c.push(this.createSortFunction(h[d].field,h[d].direction));}if(!c.length){return;}var g=k.toUpperCase()=="DESC"?-1:1;var f=function(n,m){var l=c[0].call(this,n,m);if(c.length>1){for(var p=1,o=c.length;p<o;p++){l=l||c[p].call(this,n,m);}}return g*l;};if(this.allData){this.data=this.allData;delete this.allData;}this.data.sort(k,f);if(this.snapshot&&this.snapshot!=this.data){this.snapshot.sort(k,f);}this.applyPaging();},filterBy:function(b,a){this.snapshot=this.snapshot||this.allData||this.data;this.data=this.queryBy(b,a||this);this.applyPaging();this.fireEvent("datachanged",this);},clearFilter:function(a){if(this.isFiltered()){this.data=this.snapshot;delete this.snapshot;delete this.allData;this.applyPaging();if(a!==true){this.fireEvent("datachanged",this);}}},isFiltered:function(){return !!this.snapshot&&this.snapshot!=(this.allData||this.data);},queryBy:function(b,a){var c=this.snapshot||this.allData||this.data;return c.filterBy(b,a||this);},collect:function(j,k,b){var h=(b===true?this.snapshot||this.allData||this.data:this.data).items;var m,n,a=[],c={};for(var f=0,g=h.length;f<g;f++){m=h[f].data[j];n=String(m);if((k||!Ext.isEmpty(m))&&!c[n]){c[n]=true;a[a.length]=m;}}return a;},findInsertIndex:function(a){this.suspendEvents();var c=this.data.clone();this.data.add(a);this.applySort();var b=this.data.indexOf(a);this.data=c;this.totalLength--;this.resumeEvents();return b;},isPaging:function(f){var b=this.paramNames,g=f[b.start],a=f[b.limit];if((typeof g!="number")||(typeof a!="number")){delete this.start;delete this.limit;this.lastParams=f;return false;}this.start=g;this.limit=a;delete f[b.start];delete f[b.limit];var c=this.lastParams;this.lastParams=f;if(!this.proxy){return true;}if(!c){return false;}for(var d in f){if(f.hasOwnProperty(d)&&(f[d]!==c[d])){return false;}}for(d in c){if(c.hasOwnProperty(d)&&(f[d]!==c[d])){return false;}}return true;},applyPaging:function(){var j=this.start,b=this.limit;if((typeof j=="number")&&(typeof b=="number")){var f=this.data,g=new Ext.util.MixedCollection(f.allowFunctions,f.getKey);g.items=f.items.slice(j,j+b);g.keys=f.keys.slice(j,j+b);var a=g.length=g.items.length;var h={};for(var c=0;c<a;c++){var d=g.items[c];h[g.getKey(d)]=d;}g.map=h;this.allData=f;this.data=g;}}});Ext.ux.data.PagingDirectStore=Ext.extend(Ext.ux.data.PagingStore,{constructor:Ext.data.DirectStore.prototype.constructor});Ext.reg("pagingdirectstore",Ext.ux.data.PagingDirectStore);Ext.ux.data.PagingJsonStore=Ext.extend(Ext.ux.data.PagingStore,{constructor:function(){Ext.data.JsonStore.prototype.constructor.apply(this,arguments);}});Ext.reg("pagingjsonstore",Ext.ux.data.PagingJsonStore);Ext.ux.data.PagingXmlStore=Ext.extend(Ext.ux.data.PagingStore,{constructor:Ext.data.XmlStore.prototype.constructor});Ext.reg("pagingxmlstore",Ext.ux.data.PagingXmlStore);Ext.ux.data.PagingArrayStore=Ext.extend(Ext.ux.data.PagingStore,{constructor:function(){Ext.data.ArrayStore.prototype.constructor.apply(this,arguments);},loadData:function(f,b){if(this.expandData===true){var d=[];for(var c=0,a=f.length;c<a;c++){d[d.length]=[f[c]];}f=d;}Ext.ux.data.PagingArrayStore.superclass.loadData.call(this,f,b);}});Ext.reg("pagingarraystore",Ext.ux.data.PagingArrayStore);Ext.ux.data.PagingSimpleStore=Ext.ux.data.PagingArrayStore;Ext.reg("pagingsimplestore",Ext.ux.data.PagingSimpleStore);Ext.ux.data.PagingGroupingStore=Ext.extend(Ext.ux.data.PagingStore,Ext.copyTo({},Ext.data.GroupingStore.prototype,["constructor","remoteGroup","groupOnSort","groupDir","clearGrouping","groupBy","sort","applyGroupField","applyGrouping","getGroupState"]));Ext.reg("paginggroupingstore",Ext.ux.data.PagingGroupingStore);Ext.ux.PagingToolbar=Ext.extend(Ext.PagingToolbar,{onLoad:function(a,b,d){if(!this.rendered){this.dsLoaded=[a,b,d];return;}var c=this.getParams();this.cursor=(d.params&&d.params[c.start])?d.params[c.start]:0;this.onChange();},onChange:function(){var b=this.store.getTotalCount(),c=this.pageSize;if(this.cursor>=b){this.cursor=Math.ceil((b+1)/c)*c;}var g=this.getPageData(),a=g.activePage,f=g.pages;this.afterTextItem.setText(String.format(this.afterPageText,g.pages));this.inputItem.setValue(a);this.first.setDisabled(a==1);this.prev.setDisabled(a==1);this.next.setDisabled(a==f);this.last.setDisabled(a==f);this.refresh.enable();this.updateInfo();this.fireEvent("change",this,g);},onClear:function(){this.cursor=0;this.onChange();},doRefresh:function(){delete this.store.lastParams;this.doLoad(this.cursor);},bindStore:function(b,c){var a;if(!c&&this.store){if(b!==this.store&&this.store.autoDestroy){this.store.destroy();}else{this.store.un("beforeload",this.beforeLoad,this);this.store.un("load",this.onLoad,this);this.store.un("exception",this.onLoadError,this);this.store.un("datachanged",this.onChange,this);this.store.un("add",this.onChange,this);this.store.un("remove",this.onChange,this);this.store.un("clear",this.onClear,this);}if(!b){this.store=null;}}if(b){b=Ext.StoreMgr.lookup(b);b.on({scope:this,beforeload:this.beforeLoad,load:this.onLoad,exception:this.onLoadError,datachanged:this.onChange,add:this.onChange,remove:this.onChange,clear:this.onClear});a=true;}this.store=b;if(a){this.onLoad(b,null,{});}}});Ext.reg("ux.paging",Ext.ux.PagingToolbar);Ext.ns("Ext.ux.grid");Ext.ux.grid.BufferView=Ext.extend(Ext.grid.GridView,{rowHeight:19,borderHeight:2,scrollDelay:100,cacheSize:20,cleanDelay:500,initTemplates:function(){Ext.ux.grid.BufferView.superclass.initTemplates.call(this);var a=this.templates;a.rowHolder=new Ext.Template('<div class="x-grid3-row {alt}" style="{tstyle}"></div>');a.rowHolder.disableFormats=true;a.rowHolder.compile();a.rowBody=new Ext.Template('<table class="x-grid3-row-table" border="0" cellspacing="0" cellpadding="0" style="{tstyle}">',"<tbody><tr>{cells}</tr>",(this.enableRowBody?'<tr class="x-grid3-row-body-tr" style="{bodyStyle}"><td colspan="{cols}" class="x-grid3-body-cell" tabIndex="0" hidefocus="on"><div class="x-grid3-row-body">{body}</div></td></tr>':""),"</tbody></table>");a.rowBody.disableFormats=true;a.rowBody.compile();},getStyleRowHeight:function(){return Ext.isBorderBox?(this.rowHeight+this.borderHeight):this.rowHeight;},getCalculatedRowHeight:function(){return this.rowHeight+this.borderHeight;},getVisibleRowCount:function(){var b=this.getCalculatedRowHeight(),a=this.scroller.dom.clientHeight;return(a<1)?0:Math.ceil(a/b);},getVisibleRows:function(){var a=this.getVisibleRowCount(),b=this.scroller.dom.scrollTop,c=(b===0?0:Math.floor(b/this.getCalculatedRowHeight())-1);return{first:Math.max(c,0),last:Math.min(c+a+2,this.ds.getCount()-1)};},doRender:function(h,l,v,a,t,B,m){var b=this.templates,g=b.cell,k=b.row,y=b.rowBody,o=t-1,u=this.getStyleRowHeight(),A=this.getVisibleRows(),d="width:"+this.getTotalWidth()+";height:"+u+"px;",F=[],x,G,w={},n={tstyle:d},s;for(var z=0,E=l.length;z<E;z++){s=l[z];x=[];var q=(z+a),f=q>=A.first&&q<=A.last;if(f){for(var D=0;D<t;D++){G=h[D];w.id=G.id;w.css=D===0?"x-grid3-cell-first ":(D==o?"x-grid3-cell-last ":"");w.attr=w.cellAttr="";w.value=G.renderer(s.data[G.name],w,s,q,D,v);w.style=G.style;if(w.value===undefined||w.value===""){w.value="&#160;";}if(s.dirty&&typeof s.modified[G.name]!=="undefined"){w.css+=" x-grid3-dirty-cell";}x[x.length]=g.apply(w);}}var H=[];if(B&&((q+1)%2===0)){H[0]="x-grid3-row-alt";}if(s.dirty){H[1]=" x-grid3-dirty-row";}n.cols=t;if(this.getRowClass){H[2]=this.getRowClass(s,q,n,v);}n.alt=H.join(" ");n.cells=x.join("");F[F.length]=!f?b.rowHolder.apply(n):(m?y.apply(n):k.apply(n));}return F.join("");},isRowRendered:function(a){var b=this.getRow(a);
return b&&b.childNodes.length>0;},syncScroll:function(){Ext.ux.grid.BufferView.superclass.syncScroll.apply(this,arguments);this.update();},update:function(){if(this.scrollDelay){if(!this.renderTask){this.renderTask=new Ext.util.DelayedTask(this.doUpdate,this);}this.renderTask.delay(this.scrollDelay);}else{this.doUpdate();}},onRemove:function(d,a,b,c){Ext.ux.grid.BufferView.superclass.onRemove.apply(this,arguments);if(c!==true){this.update();}},doUpdate:function(){if(this.getVisibleRowCount()>0){var h=this.grid,b=h.colModel,j=h.store,f=this.getColumnData(),a=this.getVisibleRows(),k;for(var d=a.first;d<=a.last;d++){if(!this.isRowRendered(d)&&(k=this.getRow(d))){var c=this.doRender(f,[j.getAt(d)],j,d,b.getColumnCount(),h.stripeRows,true);k.innerHTML=c;}}this.clean();}},clean:function(){if(!this.cleanTask){this.cleanTask=new Ext.util.DelayedTask(this.doClean,this);}this.cleanTask.delay(this.cleanDelay);},doClean:function(){if(this.getVisibleRowCount()>0){var b=this.getVisibleRows();b.first-=this.cacheSize;b.last+=this.cacheSize;var c=0,d=this.getRows();if(b.first<=0){c=b.last+1;}for(var a=this.ds.getCount();c<a;c++){if((c<b.first||c>b.last)&&d[c].innerHTML){d[c].innerHTML="";}}}},removeTask:function(b){var a=this[b];if(a&&a.cancel){a.cancel();this[b]=null;}},destroy:function(){this.removeTask("cleanTask");this.removeTask("renderTask");Ext.ux.grid.BufferView.superclass.destroy.call(this);},layout:function(){Ext.ux.grid.BufferView.superclass.layout.call(this);this.update();}});Ext.namespace("Ext.ux.Sprocket");Ext.override(Ext.util.Observable,{subscribe:function(a,c,b,d){Ext.ux.Sprocket.PubSub.addEvents(a);Ext.ux.Sprocket.PubSub.on(a,c,b,d);},publish:function(c,g){if(Ext.ux.Sprocket.PubSub.eventsSuspended===true){return true;}if(!Ext.ux.Sprocket.PubSub.events){return false;}var j=Ext.ux.Sprocket.PubSub.events["*"];if(j){if(j.fire.call(j,g,c)===false){return true;}}if(c.substr(0,1)=="/"&&c.length>1){var h=c.substr(1).split("/");var b=false;for(var d=0,a=h.length;d<=a;d++){var f=Ext.ux.Sprocket.PubSub.events["/"+h.slice(0,d).join("/").toLowerCase()];if(f){b=true;if(f.fire.call(f,g,c)===false){return true;}}}return b;}else{var f=Ext.ux.Sprocket.PubSub.events[c.toLowerCase()];if(f){f.fire.call(f,g,c);return true;}}return false;},removeSubscribers:function(b){for(var a in Ext.ux.Sprocket.PubSub.events){if((a==b)||(!b)){var c=Ext.ux.Sprocket.PubSub.events[a];if(c){if(typeof(c)==="object"){c.clearListeners();}else{delete Ext.ux.Sprocket.PubSub.events[a];}}}}}});Ext.ux.Sprocket.PubSub=new Ext.util.Observable();